var mstrLocalStorage=(function(){if(!window.Promise){var head=document.getElementsByTagName("head")[0];var js=document.createElement("script");js.type="text/javascript";js.src="../javascript/libraries/polyfill.min.js";head.appendChild(js);}return{addRecentObjectInfo:function addRecentObjectInfo(recentObjectInfo){var localStorage=this.getLocalStorage();if(!localStorage||!window.JSON||!recentObjectInfo){return ;}var obj=JSON.parse(recentObjectInfo);obj.timestamp=new Date().getTime();var objectId=obj.did;var recentObjectsKey="recentObjects"+mstrConfig.lastMsgKey,recentObjects=localStorage.getItem(recentObjectsKey)||[];if(recentObjects.length===0){recentObjectInfo=JSON.stringify(obj);recentObjects.push(recentObjectInfo);this.setItem(recentObjectsKey,JSON.stringify(recentObjects));}else{var updatedRecentObjects=[];var updateRecentObjects=JSON.parse(recentObjects);for(var i=0;i<updateRecentObjects.length;i++){var ro=JSON.parse(updateRecentObjects[i]);if(ro.did===objectId){if(ro.imgData!==undefined){obj.imgData=ro.imgData;}}else{updatedRecentObjects.push(JSON.stringify(ro));}}recentObjectInfo=JSON.stringify(obj);updatedRecentObjects.unshift(recentObjectInfo);var newLength=updatedRecentObjects.length;if(newLength>10){updatedRecentObjects.splice(-1,(newLength-10));}this.setItem(recentObjectsKey,JSON.stringify(updatedRecentObjects));}},addScreenshot:function(objectInfo,root){if(!mstrConfig.showPreviews||!objectInfo||window.bIsSafari){return ;}var recentObjectsKey="recentObjects"+mstrConfig.lastMsgKey;var objectId=JSON.parse(objectInfo).did;var targetNode={};if(typeof root==="string"){targetNode=document.getElementById(root)||document.body;}else{targetNode=root||document.body;}var body=document.body,html=document.documentElement;var height=Math.max(body.scrollHeight,body.offsetHeight,html.clientHeight,html.scrollHeight,html.offsetHeight),width=Math.max(body.scrollWidth,body.offsetWidth,html.clientWidth,html.scrollHeight,html.offsetWidth);if(height>10000||width>10000||document.getElementsByTagName("body")[0].innerHTML.length>800000){return ;}var me=this;setTimeout(function(){html2canvas(targetNode,{background:"#e6e6e6",logging:false}).then(function(canvas){var updatedRecentObjects=[];var dataURL=canvas.toDataURL("image/png");var recentObjects=JSON.parse(window.localStorage.getItem(recentObjectsKey));for(var i=0;i<recentObjects.length;i++){var ro=JSON.parse(recentObjects[i]);if(ro.did===objectId){ro.imgData=dataURL.replace(/^data:image\/(png|jpg);base64,/,"");}updatedRecentObjects.push(JSON.stringify(ro));}me.setItem(recentObjectsKey,JSON.stringify(updatedRecentObjects));});},2000);},setItem:function(key,data){var localStorage=this.getLocalStorage();var storageFull=false;if(localStorage){try{localStorage.setItem(key,data);}catch(e){if(e&&e.code){switch(e.code){case 22:storageFull=true;break;case 1014:if(e.name==="NS_ERROR_COM_QUOTA_REACHED"){storageFull=true;}break;}if(storageFull){console.log(key+" cannot be added to the local storage because you have met the maximum quota.");console.log("To ensure the message recovery and recents list work properly, please clear your local storage for this site.");}}}}},getLocalStorage:function(){var localStorage;try{localStorage=window.localStorage;}catch(e){}return localStorage;}};}());