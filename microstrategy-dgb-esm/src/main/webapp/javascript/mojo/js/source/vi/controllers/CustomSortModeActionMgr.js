(function(){mstrmojo.requiresClsP("mstrmojo","dom","hash","array","css","func","desc");var $DOM=mstrmojo.dom,$CSS=mstrmojo.css,$HASH=mstrmojo.hash,$ARR=mstrmojo.array,$FUNC=mstrmojo.func,$DESC=mstrmojo.desc;var twinkleTimer,twinkleCells=[],twinkleClassString="moving";mstrmojo.requiresDescs(15934,15935,15936,15937,15938,15939,15940,1006);function ensureMinStringLen(s,min){var len=s&&s.length||0;min=min===undefined?30:min;return s+Array(Math.max(min-len,0)+1).join(" ");}function twinkleHighlight(cells){if(twinkleTimer){window.clearTimeout(twinkleTimer);twinkleTimer=null;}clearTwinkleCells();$ARR.forEach(cells,function(cell){$CSS.toggleClass(cell,twinkleClassString,true);});twinkleCells=[].concat(cells);twinkleTimer=window.setTimeout(clearTwinkleCells,1000);}function clearTwinkleCells(){$ARR.forEach(twinkleCells,function(cell){$CSS.toggleClass(cell,twinkleClassString,false);});twinkleCells=[];}function moveRow(table,srcIndex,tgtIndex,disableHighlight){var rows=table.rows,n=rows.length,ret;if(srcIndex<0||srcIndex>=n||tgtIndex<0||tgtIndex>n){ret=false;}else{if(tgtIndex===srcIndex||tgtIndex===srcIndex+1){ret=true;}else{var mvRow=rows[srcIndex],blankRow=table.insertRow(tgtIndex);$DOM.replace(blankRow,mvRow);if(mstrmojo.debugBundles&&console){console.log("move "+ensureMinStringLen('"'+mvRow.cells[0].textContent.trim()+'"')+' after "'+table.rows[mvRow.rowIndex-1].textContent.trim()+'"');}if(!disableHighlight){twinkleHighlight(Array.apply(null,mvRow.cells));}if(srcIndex===1||tgtIndex===1){var xtab=this.getViz();xtab.offsetCellNode=getTable.call(this).rows[1].cells[0];}ret=true;}}return ret;}function getSrcIndexForMoveRow(movedNode){var mvRow=$DOM.findAncestorByName(movedNode,"tr");return mvRow&&mvRow.rowIndex;}function getTgtIndexForMoveRow(relNode,isPostNode){var tgtIndex;if(relNode){var relRow=$DOM.findAncestorByName(relNode,"tr"),relRowIndex=relRow&&relRow.rowIndex;tgtIndex=relRowIndex+(isPostNode?0:1);}else{if(isPostNode){tgtIndex=getTable.call(this).rows.length;}else{tgtIndex=1;}}return tgtIndex;}function getTgtOrdinal(tgtOrdinalInfo,isPostNode){var ordinal;if(tgtOrdinalInfo){ordinal=tgtOrdinalInfo.ordinal;}else{if(isPostNode){ordinal=getTotalRowCount.call(this)-1;}else{ordinal=0;}}return ordinal;}function getTotalRowCount(){var xtab=this.getViz();dataBlocks=xtab.dataBlocks,tc=0;$ARR.filterOne(dataBlocks,function(db){tc=db&&db.rw.row.tc;return tc!==undefined;});return tc;}function getPages(ordinal,needToShowStatus){var zone=getXtabZone.call(this),rpp=zone.rowsPerPage,pIdx=Math.ceil((ordinal+2)/rpp)-1,stat=zone.pageStatus[pIdx],pages=[],i;for(i=zone.numPagesRendered;i<pIdx;i++){pages.push({idx:i,fill:false});}var showStatus,numRowsToDownload;if(!stat||!stat.filled){if(stat&&stat.isOnDemand()){if(!stat.isDownloading&&!zone.isDownloading){var startIndex=pIdx*rpp-1,endIndex=(pIdx+1)*rpp-2;stat.isDownloading=true;zone.isDownloading=true;zone.cp.download(startIndex,endIndex);showStatus=true;numRowsToDownload=endIndex-startIndex+1;if(mstrmojo.debugBundles&&console){console.log("load data from orddinal "+startIndex+" to "+endIndex+" for page index "+pIdx+" and ordinal "+ordinal);}}pages.push({idx:pIdx,fill:false});}else{pages.push({idx:pIdx,fill:true});}}if(showStatus&&needToShowStatus){zone.parent.showDownloadStatus(numRowsToDownload);}else{zone.parent.closeDownloadStatus();}return pages;}function getTable(){var zone=getXtabZone.call(this);return zone.tableNode;}function getXtabZone(){var xtab=this.getViz();return xtab.zone;}function scrollViz(pos){var curXtab=this.getViz(),x=curXtab.scrollboxLeft,y=curXtab.scrollboxTop;if(x!==pos.x||y!==pos.y){curXtab.scrollTo(pos);}}mstrmojo.vi.controllers.CustomSortModeActionMgr=mstrmojo.declare(null,null,{scriptClass:"mstrmojo.vi.controllers.CustomSortModeActionMgr",actions:null,pos:-1,historicalUnsilentActions:null,csDisplayPanel:null,init:function init(props){$HASH.copy(props,this);this.actions=[];this.historicalUnsilentActions=[];},appendHistUnsilentActions:function appendHistUnsilentActions(mgrActs){this.historicalUnsilentActions=this.historicalUnsilentActions.concat(mgrActs);},getViz:function getViz(){return this.csDisplayPanel.getVizBox().boxContent;},wrapCustomSortAction:function wrapCustomSortAction(submitAction,srcNode,tgtNode){var thisActMgr=this,xtab=this.getViz();return{silent:true,submitAction:submitAction,srcEle:this.getOrdinalInfo(srcNode),tgtEle:this.getOrdinalInfo(tgtNode),srcRefOrdinal:this.getRefOrdinal(srcNode),perform:function(manualSort,callback,disableHighlight){var thisAct=this,srcEle=thisAct.srcEle,tgtEle=thisAct.tgtEle,isPostNode=thisAct.submitAction.before,dppCallback=function(){var srcNode=thisActMgr.getNodeForOrdinal(srcEle.ordinal),xtab=thisActMgr.getViz(),srcCell=xtab.getCellForNode(srcNode),tgtNode=tgtEle&&thisActMgr.getNodeForOrdinal(tgtEle.ordinal),tgtCell=tgtNode&&xtab.getCellForNode(tgtNode);if(thisActMgr.hasFailedSorts()||srcCell._e.id!==srcEle.id||tgtCell&&tgtCell._e.id!==tgtEle.id){thisActMgr.addFailedSorts(srcEle.n,tgtEle&&tgtEle.n,isPostNode);}else{moveRow.call(thisActMgr,getTable.call(thisActMgr),getSrcIndexForMoveRow(srcNode),getTgtIndexForMoveRow.call(thisActMgr,tgtNode,isPostNode),disableHighlight);if(!manualSort){scrollViz.call(thisActMgr,{x:xtab.scrollboxLeft||0,y:thisActMgr.getScrollYForGoldenSectionPoint(srcNode)});}}if(callback){callback();}};if(manualSort){thisActMgr.resetFailedSorts();dppCallback();}else{var so=thisAct.srcEle.ordinal,to=getTgtOrdinal.call(thisActMgr,thisAct.tgtEle,isPostNode);if(thisActMgr.hasFailedSorts()){thisActMgr.addFailedSorts(srcEle.n,tgtEle&&tgtEle.n,isPostNode);if(callback){callback();}}else{thisActMgr.prepareDataAndPages([so,to],dppCallback);}}},undo:function(){var srcNode=thisActMgr.getNodeForOrdinal(this.srcEle.ordinal),srcIndex=getSrcIndexForMoveRow(srcNode),tgtNode=thisActMgr.getNodeForOrdinal(this.srcRefOrdinal),tgtIndex=getTgtIndexForMoveRow.call(thisActMgr,tgtNode,false),table=getTable.call(thisActMgr);moveRow.call(thisActMgr,table,srcIndex,tgtIndex);scrollViz.call(thisActMgr,{x:thisActMgr.getViz().scrollboxLeft||0,y:thisActMgr.getScrollYForGoldenSectionPoint(srcNode)});}};},prepareDataAndPages:function prepareDataAndPages(ordinals,callback){var i=0,len=ordinals.length,zone=getXtabZone.call(this),me=this,renderPause=0;var prepareDP=function(){self.setTimeout(function(){try{var pages=getPages.call(me,ordinals[i]);if(pages.length>0){mstrApp.showWait();zone.preRenderPages();zone.renderPages(pages);zone.postRenderPages();zone._postPagesClearup=true;}else{if(zone._postPagesClearup){zone.postRenderPagesCleanup();zone.configureActions();zone._postPagesClearup=false;}if(zone.isRenderingComplete()){zone.postRenderingCleanup();}i++;}if(pages.length>0||i<len){renderPause=zone.renderPause;prepareDP();}else{me.dpPreparingCleanUp();if(callback){callback();}}}catch(ex){me.dpPreparingCleanUp();mstrApp.hideWait(true);throw ex;}},renderPause);};zone.renderingRows=true;prepareDP();},dpPreparingCleanUp:function dpPreparingCleanUp(){getXtabZone.call(this).renderingRows=false;},getRefOrdinal:function getRefOrdinal(node){var xtab=this.getViz(),trs=xtab.zone.tableNode.getElementsByTagName("tr"),cellIndex=node.cellIndex,rowIndex=node.parentElement.rowIndex,previousTDNode=trs[rowIndex-1].cells[cellIndex];return xtab.getCellForNode(previousTDNode).o;},getOrdinalInfo:function getOrdinalInfo(node){var cell=this.getViz().getCellForNode(node);if(cell&&cell._e){return{id:cell._e.id,n:cell._e.n,ordinal:cell.o};}},getNodeForOrdinal:function getNodeForOrdinal(ordinal){var rows=getTable.call(this).rows;if(ordinal>=0){var r=ordinal+1,tgtRow;tgtRow=$ARR.filterOne(rows,function(row){return parseInt(row.firstElementChild.getAttribute("r"),10)===r;});return tgtRow.firstElementChild;}else{return rows[0].firstElementChild;}},getScrollYForGoldenSectionPoint:function getScrollYForGoldenSectionPoint(node){var GOLDEN_SECTION_RATIO=0.618,xtab=this.getViz(),containerRect=xtab.tableContainerNode.getBoundingClientRect(),tgtPosY=containerRect.top+containerRect.height*(1-GOLDEN_SECTION_RATIO),nodeRect=node.getBoundingClientRect(),currentPosY=nodeRect.top+nodeRect.width/2;return(xtab.scrollboxTop||0)+currentPosY-tgtPosY;},wrapUnsilentAction:function wrapUnsilentAction(submitActions,postXtabCallback,extras,config){var me=this;return{silent:false,needDataReady:!!(config&&config.needDataReady),submitActions:$ARR.ensureArray(submitActions),undoCallback:postXtabCallback,perform:function(priorUpdateTemplateActions,finalCallback){var updateTemplateActions=[],priorUpdateTemplateActions=$ARR.ensureArray(priorUpdateTemplateActions),xtab=me.getViz(),dataService=xtab.model.getDataService(),updateTemplateCallback;if(priorUpdateTemplateActions.length>0){updateTemplateActions=updateTemplateActions.concat(priorUpdateTemplateActions);}updateTemplateActions=updateTemplateActions.concat(this.submitActions);updateTemplateCallback=xtab.controller._getXtabCallback(xtab,$HASH.copy(postXtabCallback));if(finalCallback){updateTemplateCallback=$FUNC.wrapMethods(updateTemplateCallback,finalCallback);}extras=$HASH.copy(extras||{});extras.hideCancel=true;extras.noUpdate=true;extras.preserveStid=true;extras.noDeltaXML=true;dataService.submitUpdates(dataService.getUpdateTemplateAction(xtab.k,updateTemplateActions),updateTemplateCallback,extras);}};},addAction:function addAction(action){var actions=this.actions,pos=this.pos;actions.splice(pos+1);actions.push(action);this.pos=actions.length-1;this.csDisplayPanel.updateStatus();},execute:function execute(action){this.addAction(action);if(action.silent){action.perform(true);}else{var customSortActAhead=this.getCustomSortActAhead();action.perform($ARR.ensureArray(customSortActAhead));}},undo:function undo(){var action=this.actions[this.pos];if(!action){return ;}this.pos--;this.csDisplayPanel.updateStatus();if(action.silent){action.undo();}else{var actionParts4Undo=this.getActionParts4Undo();this.csDisplayPanel.recreateCSVizForUndo(actionParts4Undo.splitUTActions,actionParts4Undo.silentActions,action.undoCallback);}},getActionParts4Undo:function getActionParts4Undo(){var updateTemplateActions=[],splitUTActions=[updateTemplateActions],silentActions=[],actions=this.actions,i=this.pos,action,customSortAct;while(i>=0){action=actions[i];if(action&&action.silent){silentActions=[action].concat(silentActions);}else{break;}i--;}while(i>=0){action=actions[i];if(action){if(action.silent){customSortAct=this.getCustomSortActAhead(i+1);updateTemplateActions.unshift(customSortAct);i=i-(customSortAct.actions.length-1);}else{updateTemplateActions.unshift.apply(updateTemplateActions,action.submitActions);if(action.needDataReady){updateTemplateActions=[];splitUTActions.unshift(updateTemplateActions);}}}i--;}var historicalUnsilentActions=this.historicalUnsilentActions,histAct;i=historicalUnsilentActions.length-1;while(i>=0){histAct=historicalUnsilentActions[i];updateTemplateActions.unshift.apply(updateTemplateActions,histAct.submitActions);if(histAct.needDataReady){updateTemplateActions=[];splitUTActions.unshift(updateTemplateActions);}i--;}return{splitUTActions:splitUTActions,silentActions:silentActions};},redo:function redo(){var action=this.actions[this.pos+1];if(!action){return ;}this.pos++;this.csDisplayPanel.updateStatus();if(action.silent){this.resetFailedSorts();var me=this;action.perform(false,function(){mstrApp.hideWait(true);if(me.hasFailedSorts()){me.actions.splice(me.pos);me.pos--;me.csDisplayPanel.updateStatus();me.showFailedSortsAndReset();}});}else{action.perform(this.getCustomSortActAhead());}},getContSlientActionsBehind:function getContSlientActionsBehind(){var len=this.actions.length,i,silentActions=[],action;for(i=this.pos+1;i<len;i++){action=this.actions[i];if(action&&action.silent){silentActions.push(action);}else{break;}}return silentActions;},getContSlientActionsBefore:function getContSlientActionsBefore(){var actions=this.actions,i,silentActions=[],action;for(i=this.pos;i>=0;i--){action=actions[i];if(action&&action.silent){silentActions=[action].concat(silentActions);}else{break;}}return silentActions;},getSlientActionsBefore:function getSlientActionsBefore(){var actions=this.actions.slice(0,this.pos+1);return $ARR.filter(actions,function(action){return action&&action.silent;});},getUnslientActionsBefore:function getUnslientActionsBefore(){var actions=this.actions.slice(0,this.pos+1);return $ARR.filter(actions,function(action){return action&&!action.silent;});},getCustomSortActAhead:function getCustomSortActAhead(pos){var submitActions=[],i=(pos===undefined?this.pos:pos)-1,actions=this.actions;while(i>=0){var action=actions[i];if(action.silent){submitActions=[action.submitAction].concat(submitActions);}else{break;}i--;}if(submitActions.length>0){return this.csDisplayPanel.wrapCustomSortAction(submitActions,true);}},isCurrentActionSilent:function isCurrentActionSilent(){return this.actions[this.pos]&&this.actions[this.pos].silent;},reset:function reset(){this.actions=[];this.pos=-1;this.csDisplayPanel.updateStatus();},getActionsCount:function getActionsCount(){return(this.actions||[]).length;},getFailedSortsCount:function getFailedSortsCount(){return(this.failedSorts||[]).length;},resetFailedSorts:function resetFailedSorts(){this.failedSorts=[];},hasFailedSorts:function hasFailedSorts(){return(this.failedSorts||[]).length>0;},addFailedSorts:function addFailedSorts(srcName,tgtName,isPost){this.failedSorts=this.failedSorts||[];this.failedSorts.push({srcName:srcName,tgtName:tgtName,isPost:isPost});},showFailedSortsAndReset:function showFailedSortsAndReset(){if(this.hasFailedSorts()){var len=this.failedSorts.length,sort,sn,tn,isPost,msg=$DESC(15934,"Below sorting manipulations fail due to change in source data:")+" ";for(var i=0;i<len;i++){sort=this.failedSorts[i];sn=sort.srcName;tn=sort.tgtName;isPost=sort.isPost;if(tn){msg+=isPost?$DESC(15935,'move "#" before "##"').replace("#",sn).replace("##",tn):$DESC(15936,'move "#" after "##"').replace("#",sn).replace("##",tn);}else{msg+=isPost?$DESC(15937,'move "#" to the end').replace("#",sn):$DESC(15938,'move "#" to the top').replace("#",sn);}if(i===len-1){msg+=$DESC(1006,".")+" ";}else{msg+=$DESC(15939,",")+" ";}}msg+=$DESC(15940,"Please manually do these sortings if necessary.");mstrmojo.err({message:msg});this.resetFailedSorts();}}});}());