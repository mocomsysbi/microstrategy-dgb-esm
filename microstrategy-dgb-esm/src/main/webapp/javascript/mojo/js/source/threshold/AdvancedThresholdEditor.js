(function(){mstrmojo.requiresCls("mstrmojo.Editor","mstrmojo.Button","mstrmojo.Widget","mstrmojo.Label","mstrmojo.Box","mstrmojo.desc","mstrmojo.css","mstrmojo.hash","mstrmojo.dom","mstrmojo.array","mstrmojo.expr","mstrmojo.models.FormatModel","mstrmojo.ui._HasScroller","mstrmojo._HasPopup","mstrmojo.vi.ui.ConditionEditor","mstrmojo.threshold.ThresholdRow","mstrmojo.threshold.ConditionWalk","mstrmojo.threshold.PropertyPanel","mstrmojo.threshold.PropertyModel","mstrmojo.threshold.ThresholdRowPanel","mstrmojo.mstr.EnumNodeProperties","mstrmojo.mstr.EnumDSSXMLObjectTypes","mstrmojo.mstr.EnumDSSXMLObjectSubTypes");var $CSS=mstrmojo.css,$HASH=mstrmojo.hash,$DOM=mstrmojo.dom,$NODE=mstrmojo.mstr.EnumNodeProperties,$TP=mstrmojo.mstr.EnumDSSXMLObjectTypes,$STP=mstrmojo.mstr.EnumDSSXMLObjectSubTypes,_E=mstrmojo.expr,_ET=_E.ET,_BF=_E.BRANCH_FNS,$NWB=mstrmojo.Button.newWebButton,$GET_FORMAT_OBJ=mstrmojo.models.FormatModel.getFormatUpdate,$COND_EDITOR_WIDTH=600,$EID="";var ENUM_NUMBER_FORMAT_KEYS_OBJ=mstrmojo.models.FormatModel.ENUM_NUMBER_FORMAT_KEYS_OBJ,NUMBER_FORMAT_KEYS=[ENUM_NUMBER_FORMAT_KEYS_OBJ.CATEGORY,ENUM_NUMBER_FORMAT_KEYS_OBJ.CURRENCY_POSITION,ENUM_NUMBER_FORMAT_KEYS_OBJ.CURRENCY_SYMBOL,ENUM_NUMBER_FORMAT_KEYS_OBJ.DECIMAL_PLACES,ENUM_NUMBER_FORMAT_KEYS_OBJ.FORMAT,ENUM_NUMBER_FORMAT_KEYS_OBJ.NEGATIVE_NUMBERS,ENUM_NUMBER_FORMAT_KEYS_OBJ.THOUSAND_SEPARATOR],ENUM_PROPERTY_NAMES=mstrmojo.models.FormatModel.ENUM_PROPERTY_NAMES,BORDER_STYLES=[ENUM_PROPERTY_NAMES.BORDER_TOP_STYLE,ENUM_PROPERTY_NAMES.BORDER_RIGHT_STYLE,ENUM_PROPERTY_NAMES.BORDER_BOTTOM_STYLE,ENUM_PROPERTY_NAMES.BORDER_LEFT_STYLE],BORDER_STYLE_ITEMS={0:"none",1:"1pt solid",3:"1pt dashed",4:"1pt dotted",5:"1.5pt solid"};function buildThresholdsArr(model,thresholds){var newThresholdArr=[];if(thresholds){thresholds.forEach(function(threshold){var format=threshold.fmt,formatObj={FormattingAppearance:{Visible:-1}};if(!!format){format.nth=format.nth?-1:0;if(!!format.bc&&!!format.bc.c1){delete format.gdc;delete format.gda;}}$HASH.forEach(format,function(formatValue,property){var hasSavedStyle=false;if(NUMBER_FORMAT_KEYS.indexOf(property)>-1){$GET_FORMAT_OBJ(property,formatValue,formatObj);}else{if(BORDER_STYLES.indexOf(property)===-1){$GET_FORMAT_OBJ(property,formatValue,formatObj);}else{if(!format.borderStyle&&!hasSavedStyle){$GET_FORMAT_OBJ(ENUM_PROPERTY_NAMES.BORDER_STYLE,BORDER_STYLE_ITEMS[formatValue],formatObj);}}}});model.setAttIdToNDE(threshold.expr);newThresholdArr.push({n:threshold.n,scope:threshold.scope,rtp:threshold.rtp,rtxt:threshold.rtxt,expr:mstrmojo.fe.FilterUtils.getExprXml(threshold.expr),fmt:formatObj});});}return newThresholdArr;}function onSubmit(isApply){var controller=this.controller,model=this.model,newAllThresholds=model.thresholds,metricId=this.metricId,thresholds=newAllThresholds&&newAllThresholds[metricId],oldAllThresholds=model.orgThresholds,templateThresholds=oldAllThresholds&&oldAllThresholds[metricId];controller.onSubmitActions(buildThresholdsArr(model,thresholds),templateThresholds,metricId,undefined,-1,isApply,this.objectType);}function removeBreakBy(nodes){(nodes||[]).forEach(function(node){delete node.dmy;var nextNodes=node.nds;if(nextNodes){removeBreakBy(nextNodes);}});}function updateContent(){var content=this.content,model=this.model,allThresholds=model.thresholds,editor=this,rows=[],rowPanel=content.rowPanel,thresholds=allThresholds&&allThresholds[model.metricId],i=0;if(thresholds){thresholds.forEach(function(threshold){removeBreakBy(threshold.expr.nds);rows.push({scriptClass:"mstrmojo.threshold.ThresholdRow",threshold:threshold,editor:editor,model:model,idx:i++});});}rowPanel.destroyChildren(false);rowPanel.addChildren(rows);this.updateScrollbars();}function addThresholdRow(){var rowPanel=this.content.rowPanel,children=rowPanel.children,idx=(children&&children.length)||0,model=this.model,allThresholds=model.thresholds,thresholds=allThresholds&&allThresholds[model.metricId],threshold={expr:{et:14,fn:19}},condition={et:_ET.AE};if(!allThresholds){allThresholds=model.thresholds={};}if(!thresholds){thresholds=allThresholds[model.metricId]=[];}thresholds.push(threshold);rowPanel.addChildren([{scriptClass:"mstrmojo.threshold.ThresholdRow",threshold:threshold,editor:this,model:model,idx:idx}]);if(this.disableElementsBrowsing&&this.disableElementsBrowsing()){condition.et=_ET.AQ;}rowPanel.children[idx].exprTree.newCondition(condition);this.updateScrollbars();}function toggleSelectAllThresholds(selected){var model=this.model,allThresholds=model.thresholds,thresholds=allThresholds&&allThresholds[model.metricId];if(thresholds){thresholds.forEach(function(threshold){model.toggleThresholdSelected(threshold,selected);});}}function thresholdsSaveAs(params,callback){var controller=this.controller,model=this.model,metricId=this.metricId,thresholds=model.selectedThresholds;if(thresholds.length>0){controller.onSaveThresholds(buildThresholdsArr(model,thresholds),metricId,-1,params,callback);}}function showThresholdSaveasEditor(thresholdEditor){var id="mstrIVE_THRESHOLD_SAVER",docModel=thresholdEditor.controller.dataService.model,editor=mstrmojo.all[id];if(!editor){editor=new mstrmojo.SaveAsEditor({id:id,zIndex:thresholdEditor.zIndex+1,folderLinksContextId:32,rootFolderID:docModel.isnew?null:docModel.pfid,showCompletePath:false,saveParams:{},typeDesc:mstrmojo.desc(3647,"Thresholds"),saveAs:function(overwrite){var panel=this.contPanel;this.name=panel.name.value;this.desc=panel.desc.value;if(!this.name){mstrmojo.alert(mstrmojo.desc(3380,"Please enter valid name"));return ;}var params=this.saveParams||{};params.folderId=this.ob.currentFolder.did;params.name=this.name||"New Thresholds";params.saveAsOverwrite=!!overwrite;var saveAsCB=this.saveAsCallback();saveAsCB.failure=function(res){var ec=res.code,p=this.parent;if(ec==="-2147217373"||ec==="-2147216857"){mstrmojo.warn(mstrmojo.desc(7986,"The ## '###' already exists. Do you want to replace the existing one?").replace("##",p.typeDesc||"Object").replace("###",p.name),{confirmBtn:{fn:function(){p.saveAs(true);}}},{title:mstrmojo.desc(3179,"Confirm Overwrite"),zIndex:p&&p.zIndex+10});}else{mstrmojo.alert(mstrmojo.desc(7985,"Error while saving: ")+res.message);}};saveAsCB.parent=this;thresholdsSaveAs.call(thresholdEditor,params,saveAsCB);}});editor.render();}editor.open();}function showThresholdLoadEditor(thresholdEditor){var id="mstrIVE_THRESHOLD_LOADER",editor=mstrmojo.all[id],docModel=thresholdEditor.controller.dataService.model,supportedTypes=[72];if(!editor){editor=new mstrmojo.vi.ui.editors.ObjectPicker({id:id,supportedTypes:mstrmojo.array.hash(supportedTypes),zIndex:thresholdEditor.zIndex+1,rootFolderID:docModel.isnew?null:docModel.pfid,onOpen:function onOpen(){this.browse();},postBuildRendering:function postBuildRendering(){mstrmojo.Editor.prototype.postBuildRendering.apply(this);},OKFn:function(item){if(item){thresholdEditor.controller.onLoadThresholds(thresholdEditor.metricId,item.did);}}});var ob=editor.ob;ob.set("folderLinksContextId",32);ob.set("multiSelect",false);ob.set("searchVisible",true);ob.set("upButtonVisible",true);ob.set("browsableTypes","8,"+supportedTypes.join(","));editor.render();}editor.open();}function isRecursive(unit){if(!unit){return ;}if(unit.t===$TP.Consolidation&&unit.st===$STP.ConsolidationManaged){var docModel=mstrApp&&mstrApp.rootCtrl&&mstrApp.rootCtrl.docCtrl&&mstrApp.rootCtrl.docCtrl.model;if(docModel&&docModel.findUnitInDataSet){unit=docModel.findUnitInDataSet(unit.did);if(unit&&unit.attId){unit=docModel.findUnitInDataSet(unit.attId);}}}return unit.t===$TP.Attribute&&unit.st===$STP.AttributeRecursive;}function getConditionModel(data){var d=$HASH.clone(data);if(!(d.node&$NODE.CONDITION)&&isRecursive(d.a)){d={et:_ET.ANDOR,fn:mstrmojo.expr.FN.AND,node:$NODE.CONDITION,nds:[d]};}if(d&&d.et===_ET.ANDOR&&(d.node&$NODE.CONDITION)){var tgt=$HASH.valarray(_E.findTargets(d,"did"))[0],ret={et:_ET.ANDOR,data:d};switch(tgt&&tgt.t){case $TP.Attribute:case $TP.Consolidation:ret.a=tgt;break;case $TP.Metric:ret.m=tgt;break;}return ret;}return d;}mstrmojo.threshold.AdvancedThresholdEditor=mstrmojo.declare(mstrmojo.Editor,[mstrmojo.ui._HasScroller,mstrmojo._HasPopup],{scriptClass:"mstrmojo.threshold.AdvancedThresholdEditor",cssClass:"adv-threshold",title:"Advanced Threshold Editor",help:"Advanced_Thresholds_Editor.htm",model:undefined,targets:undefined,content:undefined,buttonBar:undefined,init:function init(props){this._super(props);$EID=this.id;},postBuildRendering:function postBuildRendering(){this._super();var content=this.content;updateContent.call(this);content.conditionWalk.set("editor",this);content.property.set("editor",this);},onOpen:function onOpen(){updateContent.call(this);this.setRowPanelVisibility(true);var content=this.content;content.conditionWalk.set("visible",false);content.property.set("visible",false);content.set("editorNode",this.editorNode);var quickLink=this.buttonBar&&this.buttonBar.quickLink;if(!!quickLink){quickLink.set("visible",this.objectType!==12);}},setupScrollNodes:function setupScrollNodes(){this.scrollNode=this.content.containerNode;},onClose:function onClose(){this.model.cleanUp();},onmodelChange:function onmodelChange(){var model=this.model;if(model){model.attachEventListener("modelEdit",this.id,"onmodelEdit");model.attachEventListener("selectedThresholdsChange",this.id,"onselectedThresholdsChange");updateContent.call(this);}},onselectedThresholdsChange:function onselectedThresholdsChange(){},openConditionWalk:function openConditionWalk(data,widget){var editor=this,content=editor.content,thresholdRow=widget.tree.parent,threshold=$HASH.clone(thresholdRow.threshold),titleCoord=$DOM.position(editor.titleNode);threshold.expr=data;var row=new mstrmojo.threshold.ThresholdRow({alias:"thresholdRow",slot:"conditionNode",idx:thresholdRow.idx,model:this.model,threshold:threshold,onclick:mstrmojo.emptyFn});row.render();$CSS.toggleClass(editor.content.domNode,"no-overflow",true);editor.openPopup("conditionEditorPopupRef",{editor:editor,objectBrowsingEnabled:editor.objectBrowsingEnabled,showLimits:true,targets:editor.targets,targetsLastMod:new Date(),ets:widget.tree.validExprTypes,condition:widget,hasPrompt:false,model:getConditionModel(data),left:parseInt(titleCoord.x+(titleCoord.w-$COND_EDITOR_WIDTH)/2,10)+"px",top:parseInt(titleCoord.y+titleCoord.h,10)+"px",zIndex:editor.zIndex+1,title:widget.isEmpty()?mstrmojo.desc(5893,"New Condition"):mstrmojo.desc(14916,"Edit Condition"),disableHierarchyLevel:true});},onmodelEdit:function onmodelEdit(){updateContent.call(this);},openPropertyPanel:function openPropertyPanel(thresholdRow){this.setRowPanelVisibility(false);var propertyPanel=this.content.property,model=propertyPanel.model=new mstrmojo.threshold.PropertyModel({thresholdRow:thresholdRow,threshold:$HASH.clone(thresholdRow.threshold),gridValueFormat:$HASH.clone(this.model.getGridValueFormat())});this.disposables.push(model);model.attachEventListener("propertyModelChange",thresholdRow.id,"onpropertyModelChange");propertyPanel.set("visible",true);this.toggleButtonStatus(false);this.updateScrollbars();},getDatasets:function getDatasets(){if(this.model){return this.model.controller.datasets;}return null;},getIfDataSource:function getIfDataSource(){if(this.model){return this.model.controller.dataService;}return null;},onUpdateBrowseElementsParams:mstrmojo.emptyFn,onConditionEdit:function onConditionEdit(cond,newData){var editor=this;editor.model.setConditionData(cond,newData);editor.setRowPanelVisibility(true);editor.toggleButtonStatus(true);editor.updateScrollbars();},conditionEditorPopupRef:{scriptClass:"mstrmojo.vi.ui.ConditionEditor",isHostedWithin:false,getIfDataSource:function getIfDataSource(){return this.editor.getIfDataSource();},getDatasets:function getDatasets(){return this.editor.getDatasets();},onUpdateBrowseElementsParams:function onUpdateBrowseElementsParams(params){this.editor.onUpdateBrowseElementsParams(params);}},openAndORPopup:function openAndORPopup(condition,targetNode){var menuCfg=new mstrmojo.ui.menus.MenuConfig();menuCfg.hostId=this.id;menuCfg.hostElement=targetNode;menuCfg.isHostedWithin=false;menuCfg.menuCssClass="andor-PopupList";var update=function update(itemContext){var w=condition,did=itemContext.ctxt.did,not=did>21?true:null,fn=did-(not?21:0);var bq=w&&w.parent;if(bq&&bq.data&&bq.data.et===_ET.ANDOR){bq.edit(w,fn,not);}else{var d=w&&w.data;if(d&&(d.not!==not)){d.not=not;w.paint();}}};menuCfg.addMenuItem(_BF[19],"",update,{did:19});menuCfg.addMenuItem(_BF[20],"",update,{did:20});menuCfg.addMenuItem(_BF["19_21"],"",update,{did:19+21});menuCfg.addMenuItem(_BF["20_21"],"",update,{did:20+21});this.openPopup(menuCfg.newInstance());},toggleButtonStatus:function toggleButtonStatus(status){this.buttonBar.children.forEach(function(button){button.set("enabled",status);});},setRowPanelVisibility:function toggleRowPanelVisibility(visible){var content=this.content;content.rowPanel.set("visible",visible);content.newCondition.set("visible",visible);this.updateScrollbars();},children:[{scriptClass:"mstrmojo.Widget",alias:"rulesTitles",markupString:"<div class='rulesTitles'><div class='container'></div><div class='order'>"+mstrmojo.desc(3095,"Order")+"</div><div class='condition'>"+mstrmojo.desc(11890,"Threshold Conditions")+"</div><div class='format'>"+mstrmojo.desc(11891,"Format Preview")+"</div></div>"},{scriptClass:"mstrmojo.Box",cssClass:"content",alias:"content",editorNode:undefined,markupString:'<div id="{@id}" class="mstrmojo-Box {@cssClass}" style="{@cssText}"><div class="scroll-container"></div></div>',markupSlots:{containerNode:function(){return this.domNode.firstChild;}},rowPanel:undefined,newCondition:undefined,conditionWalk:undefined,property:undefined,children:[{scriptClass:"mstrmojo.threshold.ThresholdRowPanel",alias:"rowPanel",children:[]},{scriptClass:"mstrmojo.Label",alias:"newCondition",cssClass:"link",text:mstrmojo.desc(4585,"New Threshold"),onclick:function onclick(){addThresholdRow.call(mstrmojo.all[$EID]);}},{scriptClass:"mstrmojo.threshold.ConditionWalk",alias:"conditionWalk",height:"300px",width:"750px",visible:false},{scriptClass:"mstrmojo.threshold.PropertyPanel",alias:"property",visible:false}]},{alias:"buttonBar",scriptClass:"mstrmojo.Box",slot:"buttonNode",children:[$NWB(mstrmojo.desc(221,"Cancel"),function(){mstrmojo.all[$EID].close();},false,{enabled:true,alias:"cancelBtn"}),$NWB(mstrmojo.desc(1442,"OK"),function(){onSubmit.call(mstrmojo.all[$EID],false);mstrmojo.all[$EID].close();},true),$NWB(mstrmojo.desc(2031,"Apply"),function(){onSubmit.call(mstrmojo.all[$EID],true);},true),{scriptClass:"mstrmojo.Label",cssClass:"link",alias:"quickLink",text:mstrmojo.desc(14004,"Quick Thresholds Editor..."),onclick:function onclick(){var editor=mstrmojo.all[$EID],model=editor.model,controller=editor.controller,isAdvanced=model.isAdvanced(model.metricId),fnPreOpenSimpleEditor=function(){editor.close();model.editorMode=mstrmojo.threshold.ThresholdModel.EDITOR_TYPES.SIMPLE_EDITOR;},buttons=[$NWB(isAdvanced?mstrmojo.desc(1442,"OK"):mstrmojo.desc(2827,"Clear"),function(){fnPreOpenSimpleEditor();controller.openEditor();},isAdvanced,isAdvanced?undefined:{cssClass:"nosave"})];if(!isAdvanced){buttons.push($NWB(mstrmojo.desc(2031,"Apply"),function(){fnPreOpenSimpleEditor();onSubmit.call(editor,true);},true));}buttons.push($NWB(mstrmojo.desc(2223,"Cancel")));mstrmojo.warn(isAdvanced?mstrmojo.desc(13998,"This action will clear the thresholds definition. Do you want to proceed?"):mstrmojo.desc(13999,"Do you want to apply your thresholds before using the Quick Thresholds Editor?"),undefined,{cssClass:isAdvanced?undefined:"save-threshold-warning",buttons:buttons});}}]}]});}());