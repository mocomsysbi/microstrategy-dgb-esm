(function(){var $FULLCONNECTION="FULLCONNECTION",MSTR_CUSTOM_SETTING="MSTR_CUSTOM";function cleanIndex(nameToCheck,currentIndex){var $S=mstrmojo.string;nameToCheck=$S.trim(nameToCheck);var pattern=/\(\d+\)$/,match=pattern.exec(nameToCheck);if(match){currentIndex.v=parseInt(nameToCheck.substring(match.index+1,nameToCheck.length-1),10);return $S.trim(nameToCheck.substring(0,match.index));}return nameToCheck;}function getObjectCount(list){if(Object.keys){return Object.keys(list).length;}var key,listKeys=[];for(key in list){if(list.hasOwnProperty(key)){listKeys.push(key);}}return listKeys.length;}function kerberosStringDetect(str){var KrbRealmStr="KrbRealm",KrbHostStr="KrbHostFQDN",KrbServiceNameStr="KrbServiceName";return str.indexOf(KrbRealmStr)>=0&&str.indexOf(KrbHostStr)>=0&&str.indexOf(KrbServiceNameStr)>=0;}mstrmojo.warehouse.dbroles.DBRoleHelper=mstrmojo.provide("mstrmojo.warehouse.dbroles.DBRoleHelper",{isNumeric:function isNumeric(n){return !isNaN(parseFloat(n))&&isFinite(n);},getUniqueName:function getUniqueName(nameToCheck){nameToCheck=cleanIndex(nameToCheck,{});var dbroles=mstrApp.rootController.getDBRoles(),isCloud=mstrApp.rootController.isCloud(),allDBRoleNames=mstrApp.rootController.getAllDBRoleNames(),loopName,count=0,currentIndex={},maxIndex=0,tempName=nameToCheck,checker=function(dbrole){tempName=nameToCheck;if(isCloud){loopName=cleanIndex(dbrole.des,currentIndex);}else{loopName=cleanIndex(dbrole.n,currentIndex);}maxIndex=Math.max(maxIndex,currentIndex.v)||0;if(loopName.toString().toUpperCase()===tempName.toString().toUpperCase()){count=maxIndex+1;}};do{if(!isCloud){mstrmojo.hash.forEach(allDBRoleNames,checker);if(count===0){mstrmojo.array.forEach(dbroles,checker);}}else{mstrmojo.array.forEach(dbroles,checker);}if(count>0){tempName=nameToCheck+" ("+count+")";}}while(mstrApp.rootController.findinArray(dbroles,"n",tempName)>=0);return tempName;},cleanDSNConnection:function cleanDSNConnection(connstr){connstr=mstrmojo.string.trim(connstr).replace(/\\/g,"\\\\");connstr=this.cleanDSNConnectionPlaceHolders(connstr);connstr=connstr.replace(/\\/g,"^^^789^^^");connstr=connstr.replace(/:/g,"!!!789!!!");connstr=connstr.replace(/,/g,"%%%789%%%");connstr=connstr.replace("\\","###789###");connstr=connstr.replace(/{/g,"+++789+++");connstr=connstr.replace(/}/g,"@@@789@@@");connstr=connstr.replace("FULLCONNECTION=","");return connstr;},cleanDSNConnectionPlaceHolders:function cleanDSNConnection(connstr){connstr=connstr.replace(/!#AT#!/g,"@");connstr=connstr.replace(/!#QUESTION#!/g,"?");connstr=connstr.replace(/!#AND#!/g,"&");connstr=connstr.replace("!#DRIVERSUFFIX#!","");return connstr;},cleanLoadedDSNConnection:function cleanLoadedDSNConnection(connstr,dbID){var tokens;connstr=mstrmojo.string.trim(connstr);if(dbID===19||dbID===0){tokens=connstr.split(";");mstrmojo.array.forEach(tokens,function(token,i){if(token.search(/^\s*DBQ=/)===-1){tokens[i]=token.replace(/\\\\/g,"\\");}});connstr=tokens.join(";");}else{connstr=connstr.replace(/\\\\/g,"\\");}connstr=connstr.replace(/\?/g,"!#QUESTION#!");connstr=connstr.replace(/&/g,"!#AND#!");return connstr;},driverAvailable:function driverAvailable(dbc){if((dbc.str.indexOf($FULLCONNECTION)===0)&&(dbc.driver===""||dbc.driver==="XQUERY")){return true;}return(mstrmojo.array.find(this.drivers,"nU",dbc.driver.toUpperCase())>=0);},driverExists:function driverExists(connections){var $this=this,exists=false,driver="",index=0,$DBHLP=mstrmojo.warehouse.dbroles.DBRoleHelper;mstrmojo.array.forEach(connections,function(dbc,idx){if($DBHLP.driverAvailable.call($this,dbc)){exists=true;driver=dbc.driver;index=idx;}return !exists;});return{exists:exists,driver:driver,idx:index};},cleanDriver:function cleanDriver(connectionString){var strDriver="DRIVER=",driverIdx=connectionString.toUpperCase().indexOf(strDriver),driver="";if(driverIdx>=0){driverIdx+=strDriver.length;driver=connectionString.substring(driverIdx,driverIdx+connectionString.substring(driverIdx).indexOf(";"));driver=driver.replace(/([\{\}])+/g,"");}return driver;},isCustomConnection:function isCustomConnection(connectionString){return(connectionString.indexOf(MSTR_CUSTOM_SETTING)>=0);},showHelp:function showHelp(helpLink){if(mstrApp.showHelpTopic){mstrApp.showHelpTopic(helpLink);}else{window.open(mstrmojo.helpPath()+(helpLink||""),"_blank");return false;}},extractParams:function(templates,str){var $A=mstrmojo.array,$S=mstrmojo.string,$DBHLP=this,xq="XQUERY",startToken="@",templatestr,idx,lfToken="",token="",tokens=[],key="",values={},separators=/[,:]/g,index=0,pattern=/[\x28\x29\x3B\x7D]|(!#)/g,endoftokenIdx,endoftokenChar="",endoftokenPattern=/[\x29\x3B\x7D\/!]/g,driver=$DBHLP.cleanDriver(str),templateDriver,bestMatch={},bestIndex=0,bestCount=0,matchCount=[],tokenCount=[],colonPattern=/@[^\x29\x3B\x7D\/!]+:@[^\x29\x3B\x7D\/!]+[\x29\x3B\x7D\/!]/g,templatesCount=templates.length,mismatchDriverCount=0;$A.forEach(templates,function(template){templatestr=template.str;tokens=[];values={};templateDriver=$DBHLP.cleanDriver(templatestr);index++;templatestr=templatestr.replace(colonPattern,function(token){return token.replace(/:@/,":");});if(templatestr.indexOf($FULLCONNECTION)===0){if(template.driver===xq){token=templatestr.replace($FULLCONNECTION+"="+xq+";"+startToken,"");var indexMac=str.indexOf(";;");if(indexMac>=0){str=str.substring(0,indexMac+1);}values[token]=str.replace(xq+";","");bestMatch=values;bestCount=getObjectCount(values);return false;}templatestr=templatestr.replace($FULLCONNECTION+"=",";");}if(!$S.startsWith(driver.toUpperCase(),templateDriver.toUpperCase())&&!$S.startsWith(templateDriver.toUpperCase(),driver.toUpperCase())){mismatchDriverCount++;if(mismatchDriverCount===templatesCount){bestMatch.noDriverMatched=true;}return true;}do{idx=templatestr.indexOf(startToken);lfToken=templatestr.substring(0,idx);pattern.lastIndex=0;while(pattern.test(lfToken)){idx=pattern.lastIndex;}token=$S.trim(lfToken.substring(idx));templatestr=templatestr.replace(lfToken,"").replace(startToken,"");endoftokenPattern.test(templatestr);endoftokenIdx=endoftokenPattern.lastIndex-1;endoftokenChar=templatestr[endoftokenIdx];endoftokenPattern.lastIndex=1;key=templatestr.substring(0,endoftokenIdx).replace("@","");tokens.push({key:key,token:token,endoftokenChar:endoftokenChar});}while(templatestr.indexOf(startToken,endoftokenIdx)>0);tokenCount[index]=tokens.length;matchCount[index]=0;var tkn;$A.forEach(tokens,function(token,idx){tkn=token.token;idx=str.toUpperCase().indexOf(tkn.toUpperCase());if(idx>-1){idx+=tkn.length;pattern.lastIndex=0;var strsub=str.substring(idx);var match=pattern.exec(strsub);if(tkn==="DBQ="&&str.indexOf("Microsoft Access Driver")>-1){match=/[\x3B\x7D]|(!#)/g.exec(strsub);}if(match){var val=strsub.substring(0,match.index);if(strsub[match.index]!==token.endoftokenChar&&val.length){if(val[val.length-1]===token.endoftokenChar){val=val.substring(0,val.length-1);}}separators.test(val);var sep=val.substring(separators.lastIndex-1,separators.lastIndex)||",",tkns=token.key.split(sep),vals=val.split(sep);if(tkns.length===vals.length){$A.forEach(tkns,function(tk,i){values[tk]=vals[i];matchCount[index]++;});}else{values[token.key]=val;}}}});if(getObjectCount(values)>bestCount||((getObjectCount(values)===bestCount)&&(tokenCount[index]===matchCount[index]))){bestMatch=values;bestCount=getObjectCount(values);bestIndex=index;}return true;});if(kerberosStringDetect(str)){bestIndex=1;}bestMatch["RB"+bestIndex]=true;bestMatch.matchIndex=bestIndex-1;return bestMatch;},getSelectedDBPSection:function(DBPS,params){if(!DBPS||!DBPS.length){return null;}if(!params){return DBPS[0];}var selectedIndex=0,matchCount=0,DBPLength=Number.MAX_VALUE;mstrmojo.array.forEach(DBPS,function(section,idx){var count=0;mstrmojo.array.forEach(section.DBP,function(e){if(e.field in params){count++;}});if(count>matchCount||(count===matchCount&&section.DBP.length<DBPLength)){matchCount=count;selectedIndex=idx;DBPLength=section.DBP.length;}});return DBPS[selectedIndex];},getFallbackDB:function(dbID,dbIDs){var $HASH=mstrmojo.hash,JDBC="JDBC",regExp=new RegExp(JDBC+"$"),dbKey,fbDBKey,fbDBVal,isJDBC;dbID=Number(dbID);$HASH.forEach(dbIDs,function(val,key){if(val===dbID){dbKey=key;return false;}});if(!dbKey){return false;}if(regExp.test(dbKey)){isJDBC=true;fbDBKey=dbKey.replace(regExp,"");}else{isJDBC=false;fbDBKey=dbKey+JDBC;}fbDBVal=dbIDs[fbDBKey];return fbDBVal===undefined?false:{jdbc:!isJDBC,dbID:fbDBVal};}});}());