(function(){mstrmojo.requiresCls("mstrmojo.vi._MonitorsAppState","mstrmojo.vi._MonitorsLayoutMode","mstrmojo.vi.controllers.EnumLayoutManipulationType","mstrmojo.vi.controllers.EnumPanelManipulationType","mstrmojo.vi.controllers.EnumEvents","mstrmojo.vi.ui.PanelPortlet","mstrmojo.vi.ui.TableOfContentsUnitList","mstrmojo._HasOwnAvatar","mstrmojo.vi.ui._IsDropTarget","mstrmojo.css","mstrmojo.vi.models.EnumDragSources","mstrmojo.array","mstrmojo.string");mstrmojo.requiresDescs(221,629,1388,3397,14918,14919,14921,15022);var LAYOUT_MANIPULATION_TYPE=mstrmojo.vi.controllers.EnumLayoutManipulationType,PANEL_MANIPULATION_TYPE=mstrmojo.vi.controllers.EnumPanelManipulationType,EVENTS=mstrmojo.vi.controllers.EnumEvents,CSS=mstrmojo.css,ENUM_DRAG_SOURCES=mstrmojo.vi.models.EnumDragSources,ARR=mstrmojo.array,STR=mstrmojo.string;function isDescendant(parent,child,maxLevel){var node=child.parentNode;var cnt=0;maxLevel=maxLevel||100;while(node!=null&&cnt<maxLevel){if(node==parent){return true;}node=node.parentNode;cnt++;}return false;}function selectCurrentChapter(preservePage){var model=mstrmojo.all[this.panelId].model,chapter=this.chapter,chapterKey=chapter.k,currentLayoutKey=model.getCurrentLayoutKey(),isTargeting=mstrApp.isAppStateSelection(),grandparent=this.parent.parent;if(currentLayoutKey!==chapterKey){preservePage=false;}if(!preservePage){model.raiseEvent({name:isTargeting?"targetLayoutSelected":"layoutSelected",layoutKey:chapterKey,panelKey:chapter&&chapter.panels&&chapter.panels[0].k});}if(!isTargeting){grandparent.clearPageSelect();grandparent.clearChapterSelect();this.selectTitleBar();}}function allowManipulation(){return !(mstrApp.isAppStatePresentation()||mstrApp.isAppStateSelection())&&mstrApp.allowWebDashboardDesign();}mstrmojo.vi.ui.TableOfContentsChapterPortlet=mstrmojo.declare(mstrmojo.vi.ui.PanelPortlet,[mstrmojo._HasOwnAvatar,mstrmojo.vi._MonitorsAppState,mstrmojo.vi._MonitorsLayoutMode,mstrmojo.vi.ui._IsDropTarget],{scriptClass:"mstrmojo.vi.ui.TableOfContentsChapterPortlet",markupString:'<div id="{@id}" class="mstrmojo-VIPanel {@cssClass}" style="{@cssText}" mstrAttach:mouseover,mouseout,click><div class="mstrmojo-VIPanel-titlebar"></div><div class="mstrmojo-VIPanel-content"><div class="page-dnd-indicator"><div class="line"></div></div></div><div class="mstrmojo-VIDND-mask"></div><div class="reorder-dropzone"></div><div class="mstrmojo-VIPanel-handle splitter v"></div></div>',markupSlots:{titlebarNode:function(){return this.domNode.firstChild;},containerNode:function(){return this.domNode.childNodes[1];},maskNode:function(){return this.domNode.childNodes[2];},reorderDropNode:function(){return this.domNode.childNodes[3];},handleNode:function(){return this.domNode.lastChild;},pageDnDIndicatorNode:function(){return this.domNode.childNodes[1].firstChild;}},title:null,level:0,panelId:null,alias:null,chapterKey:null,panelStackKey:null,chapter:null,showTitleBarContextMenu:true,index:null,chapterCnt:null,layoutConfig:{h:{titlebarNode:"26px",containerNode:"100%"},w:{titlebarNode:"100%",containerNode:"100%"},xt:true},paddingCfg:{paddingLeft:3},lastDragOverInfo:null,avatarCssClass:"mstrmojo-VIUnitList tableOfContentUnitList",preOpenContextMenu:function preOpenContextMenu(){selectCurrentChapter.call(this,true);},init:function init(props){this._super(props);this.paddingCfg.paddingLeft=3;this.titleBar.set("hasContextMenuButton",allowManipulation());},onAppStateChange:function onAppStateChange(evt){this._super(evt);this.titleBar.set("hasContextMenuButton",!(mstrApp.isAppStateSelection()||mstrApp.isAppStatePresentation())&&mstrApp.allowWebDashboardDesign());this.generateToolbar();},customizeTitleBarCfg:function customizeTitleBarCfg(cfg){var model=mstrmojo.all[this.panelId].model,chapterKey=this.chapterKey,me=this;cfg.editTitleOnTwoClicks=allowManipulation();cfg.getMenuConfig=function(){return allowManipulation()?this.constructor.prototype.getMenuConfig.call(this):null;};cfg.onclick=function(){selectCurrentChapter.call(me);};cfg.titleEdited=function titleEdited(newText,changed,oldText){if(changed){model.raiseEvent({name:EVENTS.MANIPULATE_LAYOUT,type:LAYOUT_MANIPULATION_TYPE.RENAME,layoutKey:chapterKey,oldText:oldText,newText:newText});}};return cfg;},getLayoutOffsets:function(){return{h:0,w:0};},getSelectedItems:function(){var list=this.ulist;return list.getSelectedItems();},clearSelect:function(){this.ulist.clearSelect();},removeSelect:function(idxs){this.ulist.removeSelect(idxs);},clearTitleSelect:function(){CSS.toggleClass(this.titleBar&&this.titleBar.domNode,"selected",false);},selectTitleBar:function(){CSS.toggleClass(this.titleBar&&this.titleBar.domNode,"selected",true);},isDragValid:function isDragValid(context){var chapterNameEditLabel=this.titleBar.lblTitle;return allowManipulation()&&!chapterNameEditLabel.isEditing;},createAvatar:function createAvatar(){var avatar=document.createElement("div");avatar.innerHTML='<div class="'+this.avatarCssClass+" "+mstrApp.getThemeClassName()+'"><div class="item unit isAvatar"><span class="txt" unselectable="on">'+STR.encodeHtmlString(this.titleBar.title)+"</span></div></div>";return avatar.removeChild(avatar.firstChild);},getDropAvatarIcon:function getDropAvatarIcon(context){return"move";},allowDrop:function allowDrop(context){var srcWidget=context&&context.src&&context.src.widget,dragData=context.getCtxtDragData&&context.getCtxtDragData(),dragSource=dragData&&dragData.src;if(!srcWidget){return false;}return(dragSource===ENUM_DRAG_SOURCES.TOC_CHAPTER&&srcWidget.id!==this.id)||((dragSource===ENUM_DRAG_SOURCES.TOC_PAGES_LIST)&&(srcWidget.id===this.ulist.id||dragData.items.length===1));},ondrop:function ondrop(context){var srcWidget=context&&context.src&&context.src.widget,dragData=context.getCtxtDragData&&context.getCtxtDragData(),dragSource=dragData&&dragData.src,fromIdx=dragData&&dragData.idx,tocPanel=mstrmojo.all[this.panelId],model=tocPanel.model,index=this.index,dndIndicator=tocPanel.chapterDnDIndicatorNode,lastDragOverInfo=this.lastDragOverInfo;var raiseChapterReorderEvent=function(){if(lastDragOverInfo&&lastDragOverInfo.onTop){if(fromIdx>index){model.raiseEvent({name:EVENTS.MANIPULATE_LAYOUT,type:LAYOUT_MANIPULATION_TYPE.MOVE,fromIdx:fromIdx,toIdx:index});}else{model.raiseEvent({name:EVENTS.MANIPULATE_LAYOUT,type:LAYOUT_MANIPULATION_TYPE.MOVE,fromIdx:fromIdx,toIdx:index-1});}}else{if(lastDragOverInfo&&!lastDragOverInfo.onTop){if(fromIdx>index){model.raiseEvent({name:EVENTS.MANIPULATE_LAYOUT,type:LAYOUT_MANIPULATION_TYPE.MOVE,fromIdx:fromIdx,toIdx:index+1});}else{model.raiseEvent({name:EVENTS.MANIPULATE_LAYOUT,type:LAYOUT_MANIPULATION_TYPE.MOVE,fromIdx:fromIdx,toIdx:index});}}}};if(dragSource===ENUM_DRAG_SOURCES.TOC_PAGES_LIST){var chapterKey=dragData.chapterKey;if(dndIndicator.style.display==="block"){var panelKeys=ARR.map(dragData.items,function(it){return it.k;});if(!dragData.isAllPageSelected){model.raiseEvent({name:EVENTS.MANIPULATE_PANEL,type:PANEL_MANIPULATION_TYPE.MOVE_TO_NEW_CHAPTER,newChapterIdx:lastDragOverInfo&&lastDragOverInfo.onTop?index:index+1,srcChapterKey:chapterKey,panelKeys:panelKeys});}else{var toc=mstrmojo.all[this.panelId];var srcChapter=toc.getChapterPanel(chapterKey);fromIdx=srcChapter&&srcChapter.index;raiseChapterReorderEvent();}}else{this.ulist.ondrop(context);}}else{raiseChapterReorderEvent();}dndIndicator.style.display="none";},ondragover:function ondragover(context){var dragData=context&&context.getCtxtDragData&&context.getCtxtDragData();if(dragData&&dragData.src===ENUM_DRAG_SOURCES.TOC_PAGES_LIST&&((dragData.items||[]).length>1||(dragData.chapterKey===this.chapterKey&&this.ulist.items.length===1))){return ;}var tocPanel=mstrmojo.all[this.panelId],dndIndicator=tocPanel.chapterDnDIndicatorNode,tgtNode=context.tgt.node;var containerRect=tocPanel.containerNode.getBoundingClientRect(),offset=-15-containerRect.top+tocPanel.containerNode.scrollTop;var onTop=isDescendant(this.titlebarNode,tgtNode,5),onBottom=tgtNode===this.reorderDropNode;if(onTop){dndIndicator.style.display="block";var top=this.titlebarNode.getBoundingClientRect().top;dndIndicator.style.top=(top+offset)+"px";}else{if(onBottom){dndIndicator.style.display="block";var bottom=this.reorderDropNode.getBoundingClientRect().bottom;dndIndicator.style.top=(bottom+offset)+"px";}else{dndIndicator.style.display="none";}}if(onTop||onBottom){tocPanel.lastDragOverInfo={chapterKey:this.chapter.k};this.lastDragOverInfo={onTop:onTop};}else{this.lastDragOverInfo=null;}},ondragleave:function ondragleave(context){var dragData=context&&context.getCtxtDragData&&context.getCtxtDragData(),dragSource=dragData&&dragData.src;if(dragSource===ENUM_DRAG_SOURCES.TOC_PAGES_LIST){this.pageDnDIndicatorNode.style.display="none";}var tocPanel=mstrmojo.all[this.panelId],dndIndicator=tocPanel.chapterDnDIndicatorNode;if(!(context&&context.tgt&&context.tgt.widget&&context.tgt.widget.id===this.panelId)){dndIndicator.style.display="none";}if(this._super){this._super(context);}},getDragData:function getDragData(){var id=this.id,idx=this.index;return{setAvatarClass:function setAvatarClass(cls){var list=mstrmojo.all[id],avatar=list.avatar;if(avatar){var classes=[list.avatarCssClass,"hasOwnAvatar",cls];avatar.className=classes.join(" ");}},fromIdx:idx,idx:idx,src:ENUM_DRAG_SOURCES.TOC_CHAPTER};},addMenuItems:function addMenuItems(cfg){var model=mstrmojo.all[this.panelId].model,chapterKey=this.chapterKey,panelStackKey=this.panelStackKey,index=this.index,chapterCnt=this.chapterCnt;cfg.hostId=this.id;cfg.isHostedWithin=false;cfg.addMenuItem(mstrmojo.desc(14919,"Insert Page"),"",function(){model.raiseEvent({name:EVENTS.MANIPULATE_PANEL,type:PANEL_MANIPULATION_TYPE.NEW,layoutKey:chapterKey,panelStackKey:panelStackKey});});cfg.addMenuItem(mstrmojo.desc(14918,"Insert Chapter"),"",function(){model.raiseEvent({name:EVENTS.MANIPULATE_LAYOUT,type:LAYOUT_MANIPULATION_TYPE.NEW});});cfg.addMenuItem(mstrmojo.desc(15022,"Duplicate Chapter"),"",function(){model.raiseEvent({name:EVENTS.MANIPULATE_LAYOUT,type:LAYOUT_MANIPULATION_TYPE.DUPLICATE,layoutKey:chapterKey});});cfg.addMenuItem(mstrmojo.desc(1388,"Rename"),"rnm",function(){this.ctxt.titleBar.editTitle();},this);if(chapterCnt>1){cfg.addMenuItem(mstrmojo.desc(629,"Delete"),"",function(){mstrmojo.warn(mstrmojo.desc(14921,"Deleting a chapter will delete all the pages in this chapter. Do you want to continue?"),{confirmBtn:{t:mstrmojo.desc(629,"Delete"),fn:function(){model.raiseEvent({name:EVENTS.MANIPULATE_LAYOUT,type:LAYOUT_MANIPULATION_TYPE.DELETE,layoutKey:chapterKey});},hot:false},cancelBtn:{t:mstrmojo.desc(221,"Cancel")}});});}return cfg;},positionAvatar:function positionAvatar(pos,context){context.dragOffsets={x:15,y:20};if(this._super){this._super(pos,context);}}});}());