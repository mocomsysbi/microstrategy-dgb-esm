(function(){mstrmojo.requiresCls("mstrmojo.Editor","mstrmojo.css","mstrmojo.DI.DIConstants");mstrmojo.requiresDescs(221,1825,8708,12771,12949,13052,14896);var constants=mstrmojo.DI.DIConstants,$CSS=mstrmojo.css,$DOM=mstrmojo.dom,$A=mstrmojo.array,MAX_FILE_SIZE=4*1024*1024;function doUpload(){var editor=this,controller=mstrApp.getRootController(),items=editor.list.items,cnt=items&&items.length,idx=0;var callback={success:function(){editor.sources[idx].invalidPreview();editor.sources[idx].fileUploader=null;idx++;if(idx<cnt){upload(idx);}else{finishUpload();}},failure:function(res){var source=items[idx];var fileName=source&&source.dbTableName;var detailedErr=controller.getImportController().handleImportError(res,fileName);mstrApp.getRootController().displayError(mstrmojo.desc(12771,"Error in importing the file. Please check the file being imported"),false,detailedErr);}};function finishUpload(){var flags=constants.requestFlag.mapping|constants.requestFlag.sourceInfo|constants.requestFlag.relationship;controller.getImportedDataEMMA(constants.actions.none,flags,undefined,undefined,undefined,undefined,{success:function(){closeEditor();}});}function closeEditor(){editor.close();editor.onOK();mstrApp.hideProgress();}function upload(idx){var source=items[idx],tableID=source.tableID,operationMode=controller.getModel().operationMode;if(source.type===constants.sourceType.file&&source.subtype===constants.sourceSubtype.localFile){controller.getImportController().refreshDataLocalFile(tableID,{uploader:source.fileUploader},operationMode,callback);}else{if(source.type===constants.sourceType.file&&source.subtype===constants.sourceSubtype.clipboard){controller.getImportController().refreshDataClipboard(tableID,{uploader:source.fileUploader},operationMode,callback);}}}mstrApp.showProgress();upload(0);}mstrmojo.DI.ui.dialogs.DIBinaryUploadDialog=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.DI.ui.dialogs.DIBinaryUploadDialog",cssClass:"mstrmojo-di-ui-dialogs-DIBinaryUploadDialog",title:mstrmojo.desc(14896,"Upload your data"),sources:null,onOK:mstrmojo.emptyFn,onOpen:function(){this.list.set("items",this.sources);},checkOKButtonEnabled:function(){var hasUpload=true;$A.forEach(this.sources,function(item){if(!item.hasSelectFile){hasUpload=false;return false;}});this.btnHbox.okButton.set("enabled",hasUpload);},children:[{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-di-ui-dialogs-DIBinaryUploadDialog-header",text:mstrmojo.desc(12949,"Data Source")},{scriptClass:"mstrmojo.WidgetList",cssClass:"mstrmojo-di-ui-dialogs-DIBinaryUploadDialog-widgetList",alias:"list",itemFunction:function(item,index,list){var editor=list.parent,iw,n="",isClipboard=false;if(item&&item.sourceInfo){n=item.sourceInfo.dbTableName||item.sourceInfo.name;}isClipboard=item.type===constants.sourceType.file&&item.subtype===constants.sourceSubtype.clipboard;iw=new mstrmojo.Box({parent:list,data:item,index:index,cssClass:"mstrmojo-di-ui-dialogs-DIBinaryUploadDialog-widgetBox cf",children:[{alias:"label",scriptClass:"mstrmojo.Label",text:n,title:item.getDataSourceDescription(),tooltipOpenDelay:0,useRichTooltip:true,updateTooltipConfig:function(){var pos;if(this.title){pos=$DOM.position(this.domNode);this.set("richTooltip",{keepArrowXPos:true,cssClass:"vi-regular vi-tooltip-A",top:Math.max(pos.y+pos.h+2,0),left:Math.max(pos.x+2,0),posType:mstrmojo.tooltip.POS_TOPLEFT,content:this.title});}}}]});if(isClipboard){iw.addChildren([{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton",text:mstrmojo.desc(13052,"Upload"),onclick:function(){var controller=mstrApp.getRootController(),source=this.parent.data,label=this.parent.label,slot=controller.navigationController.getPageSlot(),footerConfig={next:{visible:true,text:mstrmojo.desc(13052,"Upload")},back:{visible:false},cancel:{visible:true},finish:{visible:false},cubeQuota:{visible:false},dda:{visible:false},save:{visible:false},managedCheckbox:{visible:false}};slot.setConfig({footerConfig:footerConfig,properties:{operationMode:constants.operationMode.refresh,tableID:source.tableID,currentSource:source,donotFetchData:true,onNextButtonClick:function(){controller.showPage(constants.pageType.emmaPreview);source.hasSelectFile=true;source.fileUploader=this;$CSS.toggleClass(label.domNode,"hasSelectFile",true);editor.checkOKButtonEnabled();}}});this.pageSlot=slot;controller.showDialog(constants.dialogType.diPageDialog,{pageType:constants.pageType.clipboard,sourceInfo:0,slot:slot});}}]);}else{iw.addChildren([{scriptClass:"mstrmojo.FileUploadBox",browseLabel:mstrmojo.desc(1825,"Browse"),accept:".xls,.xlsx,.csv,.txt,.tsv,.prn,.json,.sas7bdat",uploadTaskId:"importFile",action:mstrConfig.taskURL,fileFieldName:"myFile",initValue:false,onvalueChange:function(){var hasFile=(this.value!==""),data=this.parent.data;data.hasSelectFile=true;data.fileUploader=this;if(hasFile){this.parent.label.set("text",this.getFileName());}$CSS.toggleClass(this.parent.label.domNode,"hasSelectFile",hasFile);editor.checkOKButtonEnabled();},getFileName:function(){var ret;if(mstrmojo.dom.supports(mstrmojo.dom.htmlFeatures.FILE_READER)&&this.fileNode.files){ret=this.fileNode.files.length>0&&this.fileNode.files[0].name;}else{ret=this.value;}return ret;},getFileSize:function(){var ret=0;if(mstrmojo.dom.supports(mstrmojo.dom.htmlFeatures.FILE_READER)&&this.fileNode.files){ret=this.fileNode.files.length>0&&this.fileNode.files[0].size;}else{try{var oas=new ActiveXObject("Scripting.FileSystemObject");var file=oas.getFile(this.fileNode.value);if(file){ret=file.Size;}}catch(e){}}return ret;},submit:function(ps,callbacks,config){function handleFileLoadError(retRes){var res={code:0,message:mstrmojo.desc(12814,"Cannot read file content")};if(callbacks.failure){callbacks.failure(retRes||res);}if(callbacks.complete){callbacks.complete();}}function uploadChunk(){var end,blob;ps.fileName=filename;ps.index++;end=Math.min(file.size,start+MAX_FILE_SIZE);blob=file.slice(start,end);if(ps.index===ps.numberOfChunks){mstrApp.upload(callbacks,ps,blob,config);}else{mstrApp.upload({success:function(){start=start+MAX_FILE_SIZE;uploadChunk();},failure:function(res){handleFileLoadError(res);}},ps,blob,config);}}var r=true;var file,filename,numOfChunks,start;if(this.onsubmit){r=this.onsubmit();}if(r){ps=ps||{};ps.fileFieldName=this.fileFieldName;ps.taskId=this.uploadTaskId;ps.jsonp=this.jsonp.replace("{@id}",this.id);if(mstrmojo.dom.supports(mstrmojo.dom.htmlFeatures.FILE_READER)){config=mstrmojo.hash.copy(config,{async:true});file=this.fileNode.files[0];filename=file.name;if(this.params){ps=this.params;}if(file.size>MAX_FILE_SIZE){numOfChunks=Math.ceil(file.size/MAX_FILE_SIZE);start=0;ps.index=0;ps.numberOfChunks=numOfChunks;ps.chunkSize=MAX_FILE_SIZE;ps.fileName=this.fileNode.files[0].name;ps.fileSize=file.size;ps.fileType="application/octet-stream";mstrApp.showProgress(config);mstrApp.upload({success:function(){uploadChunk();},failure:function(res){handleFileLoadError(res);}},ps,null,config);}else{ps.fileName=this.fileNode.files[0].name;mstrApp.upload(callbacks,ps,file.slice(0,file.size),config);}}else{ps.taskEnv="jsonp2";ps.fileName=this.value;var h=[],p;for(p in ps){h.push('<input type="hidden" name="'+p+'" value="'+mstrmojo.string.encodeHtmlString(ps[p])+'"/>');}if(this.params){ps=this.params;for(p in ps){h.push('<input type="hidden" name="'+p+'" value="'+mstrmojo.string.encodeHtmlString(ps[p])+'"/>');}}this.paramsNode.innerHTML=h.join("");if(callbacks){this.onSuccess=callbacks.success;this.onFailed=callbacks.failure;}this.formNode.submit();}this.set("status","loading");}}}]);}return iw;}}],buttons:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton hot",text:mstrmojo.desc(8708,"OK"),alias:"okButton",enabled:false,onclick:function(){var editor=this.parent.parent;doUpload.call(editor);}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton",text:mstrmojo.desc(221,"Cancel"),alias:"cancelButton",onclick:function(){var editor=this.parent.parent;editor.close();}}]});}());