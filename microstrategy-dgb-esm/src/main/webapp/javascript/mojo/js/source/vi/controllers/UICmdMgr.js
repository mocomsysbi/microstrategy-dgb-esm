(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.array","mstrmojo.DocDataService","mstrmojo.vi.controllers.UICmd");var $COPY=mstrmojo.hash.copy,$AFE=mstrmojo.array.forEach,$CMD=mstrmojo.vi.controllers.UICmd;var STATE_BUSY=2,STATE_IDLE=1,CMD_ACT_UNDO=$CMD.CMD_ACT_TYPE.UNDO,CMD_ACT_EXEC=$CMD.CMD_ACT_TYPE.EXEC,CMD_ACT_REDO=$CMD.CMD_ACT_TYPE.REDO;var CMD_PHASE=$CMD.CMD_PHASE;var CMD_STATE=$CMD.CMD_STATE;function clearDelayRemovedCmds(){$AFE(this._delayRemovedCmds,function(cmd){cmd.discard();});this._delayRemovedCmds=null;}function restoreDelayRemovedCmds(){this.cmds=this.cmds.concat(this._delayRemovedCmds);this._delayRemovedCmds=null;}function addCmd(cmd){var commands=this.cmds,pos=this.pos;this._delayRemovedCmds=commands.splice(pos+1);if(pos>=this.size-1){commands.shift().discard();}commands.push(cmd);this.pos=commands.length-1;}mstrmojo.vi.controllers.UICmdMgr=mstrmojo.declare(null,null,{scriptClass:"mstrmojo.vi.controllers.UICmdMgr",cmds:null,pos:-1,size:20,_delayRemovedCmds:null,controller:null,dataService:null,model:null,state:STATE_IDLE,CMD_PHASE:CMD_PHASE,init:function init(props){$COPY(props,this);this.cmds=[];},execute:function execute(params){if(this.state===STATE_BUSY){this.handleError();}try{params=$COPY(params,{mgr:this,undoUIState:this.model.getUIState(),action:CMD_ACT_EXEC});var cmd=this.curCmd=new $CMD(params);addCmd.call(this,cmd);this.state=STATE_BUSY;cmd.execute();}catch(e){this.reset();throw e;}},getInterimCmd:function getInterimCmd(){if(this.state===STATE_BUSY){var cmd=this.cmds[this.pos];if(cmd&&cmd.state===CMD_STATE.INTERIM){return cmd;}}return null;},undo:function undo(killJob){if(this.canUndo()){this.state=STATE_BUSY;try{var cmd=this.curCmd=this.cmds[this.pos--];cmd.action=CMD_ACT_UNDO;cmd.redoUIState=this.model.getUIState();cmd.undoRedo(killJob);}catch(e){this.reset();throw e;}}},redo:function redo(){if(this.canRedo()){this.state=STATE_BUSY;try{var cmd=this.curCmd=this.cmds[++this.pos];cmd.action=CMD_ACT_REDO;cmd.undoUIState=this.model.getUIState();cmd.undoRedo();}catch(e){this.reset();throw e;}}},onSuccess:function onSuccess(cmd){if(this.state===STATE_IDLE){this.handleError();}if(cmd!==this.curCmd){this.handleError("Wrong command");}this.state=STATE_IDLE;clearDelayRemovedCmds.call(this);this.controller.onCmdMgrChanged();},onFailure:function onFailure(){clearDelayRemovedCmds.call(this);this.reset();},onCancel:function onCancel(cmd,killJob){this.state=STATE_IDLE;var submittedRequest=!!cmd.submitCount;if(submittedRequest){this.undo(killJob);}else{this.pos--;}this.cmds.pop();cmd.discard();if(submittedRequest){clearDelayRemovedCmds.call(this);}else{restoreDelayRemovedCmds.call(this);}this.controller.onCmdMgrChanged();},untrackLastCmd:function reset(){var cmd=this.cmds.pop();cmd.discard();this.pos--;this.controller.onCmdMgrChanged();},reset:function reset(){$AFE(this.cmds,function(cmd){cmd.discard();});this.cmds.length=0;this.pos=-1;this.state=STATE_IDLE;this.controller.onCmdMgrChanged();},resetState:function resetState(){this.state=STATE_IDLE;},canUndo:function canUndo(){return this.state===STATE_IDLE&&this.pos>=0;},canRedo:function canRedo(){return this.state===STATE_IDLE&&this.pos<this.cmds.length-1;},onSubmitUpdates:function onSubmitUpdates(){if(this.state===STATE_IDLE){this.cmds.splice(this.pos+1);this.controller.onCmdMgrChanged();}},isUndoRedo:function isUndoRedo(){var currentCommand=this.curCmd||{};return(this.state===STATE_BUSY&&(currentCommand.action===CMD_ACT_UNDO||currentCommand.action===CMD_ACT_REDO));},handleError:function handleError(message){this.reset();throw new Error(message||"Invalid state.");}});mstrmojo.vi.controllers.UICmdMgr.STATES={BUSY:STATE_BUSY,IDLE:STATE_IDLE};}());