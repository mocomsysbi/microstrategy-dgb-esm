(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.array","mstrmojo.string","mstrmojo.vi.enums.EnumDerivedElementType","mstrmojo.mstr.EnumFunction","mstrmojo.func","mstrmojo.DocDataService","mstrmojo.warehouse.EnumDatabaseType");var $FOREACHARRAY=mstrmojo.array.forEach,$FOREACHHASH=mstrmojo.hash.forEach,$COPY=mstrmojo.hash.copy,$DET=mstrmojo.vi.enums.EnumDerivedElementType,$FUNC=mstrmojo.mstr.EnumFunction,$STR=mstrmojo.string,$WRAP=mstrmojo.func.wrapMethods,$DDS=mstrmojo.DocDataService,$DISPLAY_FUNC={};function createPreview(de){var f=function(es){var elems_n=[];$FOREACHARRAY(es,function(elem){elems_n.push($STR.encodeHtmlString(elem.n)||mstrmojo.desc(14561,"(null)"));});return elems_n.join(", ");};switch(de.t){case $DET.RESIDUE:return"";case $DET.LIST:return f(de.es);case $DET.CALCULATION:var expression;if(de.func===$FUNC.FunctionApplySimple){expression=de.es[0].v;}else{expression=f(de.es);}return $DISPLAY_FUNC[de.func]+'("'+expression+'")';default:return"";}}function removeDEAction(view,item){return{act:"remove",eId:item.id};}function updateDEAction(view,item,idx){return{act:"update",position:idx+1,item:item};}function addDEAction(view,item,idx){return{act:"add",position:idx+1,item:item};}$DISPLAY_FUNC[$FUNC.FunctionAbs]="ABS";$DISPLAY_FUNC[$FUNC.FunctionAdd]="ADD";$DISPLAY_FUNC[$FUNC.FunctionAverage]="AVG";$DISPLAY_FUNC[$FUNC.FunctionLeast]="MIN";$DISPLAY_FUNC[$FUNC.FunctionGreatest]="MAX";$DISPLAY_FUNC[$FUNC.FunctionMinus]="SUB";$DISPLAY_FUNC[$FUNC.FunctionDivide]="DIV";$DISPLAY_FUNC[$FUNC.FunctionApplySimple]="ApplySimple";mstrmojo.vi.models.DEConsolidation=mstrmojo.declare(mstrmojo.Obj,null,{scriptClass:"mstrmojo.vi.models.DEConsolidation",items:null,isNameChanged:false,deleted:null,xtab:null,controller:null,othersDE:null,init:function init(props){this._super(props);this.items=[];this.deleted=[];this.isNameChanged=this.isNew=!(props.deObj);this.otherDE=null;this.populate();},populate:function populate(){var deObj=this.deObj,me=this,item;if(!deObj){return ;}me.n=deObj.n;me.t=deObj.t;me.dsId=deObj.dsId;me.attId=deObj.attId;me.deId=deObj.did;$FOREACHARRAY(deObj.des,function(de,idx){if(de.ido){return false;}item=new mstrmojo.vi.models.DEConsolidationElem();item.populate(de,idx);me.items.push(item);if(item.t===$DET.RESIDUE){me.othersDE=item;}});},addDE:function addDE(name,es){var item=new mstrmojo.vi.models.DEConsolidationElem();item.isNew=true;item.es=es;item.n=name;item.t=$DET.LIST;item.prev=createPreview(item);this.items.splice(0,0,item);if(this.items.length===1){item=new mstrmojo.vi.models.DEConsolidationElem();item.isNew=true;item.t=$DET.RESIDUE;item.n=mstrmojo.desc(13655,"All Other Elements");if(this.othersConfig){$FOREACHHASH(this.othersConfig,function(v,n){item[n]=v;});delete this.othersConfig;}else{item.showChildren=true;}this.othersDE=item;this.items.splice(1,0,item);}return item;},updateDE:function updateDE(idx,name,es,pe,mptf){var item=this.items[idx];item.isDirty=true;item.n=name;item.es=es;item.prev=createPreview(item);if(this.isRaCalculation(item)){if(pe){item.pe=pe;}if(mptf){mptf.isDirty=true;item.mptf=mptf;}}return item;},editOthers:function editOthers(config){var others=this.othersDE;if(others){$FOREACHHASH(config,function(v,n){if(others[n]!==v){others[n]=v;others.isDirty=true;}});}else{this.othersConfig=config;}},isDirty:function isDirty(){var items=this.items,dels=this.deleted||[],des=this.deObj&&this.deObj.des||[];return(this.isNameChanged||dels.length>0||items.length!==des.length||mstrmojo.array.filter(items,function(item){return item.isNew||item.isDirty;}).length>0||mstrmojo.array.filter(items,function(item){return item.n===(des[item._renderIdx]&&des[item._renderIdx].n);}).length!==items.length);},isRaCalculation:function isRaCalculation(de){return de.t===$DET.CALCULATION&&this.isRA;},isEssbaseSource:function isEssbaseSource(){var dsId=this.dsId,attId=this.attId,datasets=this.docModel&&this.docModel.datasets,ds,tables;if(!dsId&&attId){mstrmojo.hash.forEach(datasets,function(dataset,datasetKey){mstrmojo.array.some(dataset.att,function(att,idx){if(att.did===attId){dsId=att.datasetId;return true;}});if(dsId){return false;}});}ds=datasets&&datasets[dsId];tables=ds&&ds.tables;return tables&&tables.length>=0&&tables[0].dbt===mstrmojo.warehouse.EnumDatabaseType.EssBase;},save:function save(){if(!this.isDirty()){return ;}var me=this,actions=[],removeDE=function(item){item.prev=$STR.decodeHtmlString(item.prev);if(!item.isNew){actions.push(removeDEAction(me,item));$FOREACHARRAY(me.items,function(e){if(!e.isNew&&e.origPos>item.origPos){e.origPos--;}});}},getPRkeys=function(xtab,docModel,deObject){var keys=docModel.getSourceFilterKeys(xtab.zonesModel.getHost().k);mstrmojo.array.forEach(xtab.parent.parent.children,function(vizItem){var gi=vizItem.boxContent.gridInfo;if(gi){var hasNDE=(gi.rows.concat(gi.cols)).some(function(item){return item.did===deObject.did;}),hasInclude=keys.some(function(key){return key===vizItem.k;});if(hasNDE&&!hasInclude){keys.push(vizItem.k);}}});return keys;},processDE=function(item,idx){item.prev=$STR.decodeHtmlString(item.prev);if(item.isNew){actions.push(addDEAction(me,item,idx));$FOREACHARRAY(me.items,function(e){if(!e.isNew&&e.origPos>=idx){e.origPos++;}});}else{if(item.isDirty||item.origPos>idx){actions.push(updateDEAction(me,item,idx));}if(item.origPos>idx){$FOREACHARRAY(me.items,function(e){if(!e.isNew&&e.origPos>=idx&&e.origPos<item.origPos){e.origPos++;}});}}};$FOREACHARRAY(this.deleted,removeDE);$FOREACHARRAY(this.items,processDE);var controller=this.controller,xtab=this.xtab,docModel=this.docModel,callback=xtab?controller._getXtabCallback(xtab):(this.fromDS?controller.getPartialUpdateCallback():mstrmojo.emptyFn),act={act:"applyDEChanges",deId:this.deId,attId:this.attId,attName:this.attName,dsId:this.dsId,k:xtab&&xtab.k,actions:actions};if(this.isNew){act.n=this.n;}if(this.fromDS){act.actions.push({act:"updateDeObject",name:this.n});}docModel.addUpdateObjects(act,{id:(act.deId&&act.deId.substr(0,5)!=="$GUID")?act.deId:act.attId,type:47,flag:mstrmojo.DocDataService.PARTIAL_UPDATE_FLAGS.DATA_CHANGE});callback=$WRAP(docModel.getDatasetsUpdateCallback(),callback,docModel.getHighLightNDECallback(),docModel.getUpdateHiddenLayoutsCallback());var acts=(act.actions&&act.actions.length>0)?[act]:[];if(this.getExtraSaveActions){acts=acts.concat(this.getExtraSaveActions());}if(docModel.hasSelectionOnVisFilter()){acts=docModel.wrapUnsetVisualizationFilterAction(acts);docModel.clearSelectionOnVisFilter(true);if(acts&&acts.length){acts[0].partialRetrieval={nodes:getPRkeys(me.xtab,docModel,me)};}}$FOREACHARRAY(this.items,function(item){if((item.mptf||{}).isDirty){acts.push(me.docModel.dataService.getSetMDXPassThroughOptionsForCMAction({mptf:item.mptf,cid:me.deId,ceid:item.id}));}});if(!this.isNew&&!this.fromDS&&this.isNameChanged){acts=acts.concat({act:"updateTemplate",keyContext:xtab&&xtab.k,actions:[{act:"renameUnit",id:this.deId,type:47,name:this.dispName}],partialRetrieval:{nodes:[xtab&&xtab.k]}});}controller.submitUndoRedoUpdates(acts,{},callback,$DDS.REQUEST_DEFN_DATA);}});mstrmojo.vi.models.DEConsolidationElem=mstrmojo.declare(null,null,{scriptClass:"mstrmojo.vi.models.DEConsolidationElem",origPos:null,isDirty:false,isNew:false,prev:null,populate:function populate(item,idx){$COPY(item,this);this.origPos=idx;this.prev=createPreview(this);this.isDirty=false;this.isNew=false;},isPassThroughCalculation:function isPassThroughCalculation(){return this.t===$DET.CALCULATION&&this.func===$FUNC.FunctionApplySimple;},getPassThroughExpression:function getPassThroughExpression(){if(this.isPassThroughCalculation()){return this.es&&this.es[0]&&this.es[0].v;}},getParentElement:function getParentElement(){return this.pe;}});}());