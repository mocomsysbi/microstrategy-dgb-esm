(function(){mstrmojo.requiresCls("mstrmojo.css","mstrmojo.dom","mstrmojo.func","mstrmojo.hash","mstrmojo.array","mstrmojo.ToolSeparator","mstrmojo.CheckBox","mstrmojo.Label","mstrmojo.Dialog","mstrmojo.Button","mstrmojo.fe._HasFilterEditor","mstrmojo.fe.FilterUtils","mstrmojo.vi.ui.editors.SQLCSIViewer","mstrmojo.ui.menus.MenuConfig","mstrmojo.vi.models.VIComponentMap","mstrmojo.vi.ui.VizBoxTitleBar","mstrmojo.vi.ui.ViewDataDialog","mstrmojo.vi.ui.VisAsFilterInlineDialog","mstrmojo.vi.ui.rw.UnitContainer","mstrmojo.vi.ui.editors.VisAsFilterDialog","mstrmojo.vi.ui.editors.FilterEditor","mstrmojo.vi.ui.VizGalleryList","mstrmojo.EnumRWUnitType","mstrmojo.vi.viz.KnownVisualizations","mstrmojo.vi.viz.EnumWidgetTypes","mstrmojo.vi.models.EnumDragSources","mstrmojo.vi.enums.EnumFilterClearActionType");mstrmojo.requiresDescs(2827,5282,6985,9126,11671,11672,13402,13528,14389,14810,15076,15123,15621);var $CSS=mstrmojo.css,$DOM=mstrmojo.dom,$FUNC=mstrmojo.func,$HASH=mstrmojo.hash,$ARR=mstrmojo.array,$RW_UNIT_TYPES=mstrmojo.EnumRWUnitType,$KNOWN_VIZ=mstrmojo.vi.viz.KnownVisualizations,$IS_EXPR_EMPTY=mstrmojo.fe.FilterUtils.isExprEmpty,$GET_EXPR_TEXT=mstrmojo.fe.FilterUtils.getExprText,ENUM_SOURCE=mstrmojo.vi.models.EnumDragSources,PX="px",STATE_RESTORE=0,STATE_MAXIMIZE=2,$VI_COMPONENT_TYPES=mstrmojo.vi.models.VIComponentMap.TYPES,FILTER_CLEAR_TYPE=mstrmojo.vi.enums.EnumFilterClearActionType;var $MOJO=mstrmojo;var $CLASS_HIDDEN="invalid",$HAS_VF_CSS_CLS="hasViewFilter",$HAS_SELECTOR_CSS_CLS="hasSelector",CSS_BTN_VISIBLE="visible",CSS_MOUSE_LEFT="mouse-left";var EXP_PDF=3,EXP_EXCEL=4;var EXP_PDF_PRIV="web-export-to-pdf-privilege",EXP_EXCEL_PRIV="web-export-to-excel-privilege",EXP_CSV_PRIV="web-export-to-csv-privilege";var TYPE_METRIC=4;function requestFailed(err){mstrApp.onerror(err);}function addCopyMoveMenuItems(cfg){var docModel=this.model,me=this,isWSStyling=mstrApp.isWSStyling,groups=[{n:mstrmojo.desc(11670,"Copy to"),toLayoutTitle:mstrmojo.desc(13933,"Copy to #"),toNewLayoutTitle:mstrmojo.desc(13934,"Copy to a New Sheet"),crossLayoutMessage:mstrmojo.desc(12137,"Copying will clear all filters from the new visualization. Do you want to continue?"),cls:"",fn:function fn(viz,vizPanelStack,dstPanelKey,dstLayoutKey){docModel.copyVisualization(viz,vizPanelStack,dstPanelKey,dstLayoutKey);}},{n:mstrmojo.desc(10461,"Move to"),toLayoutTitle:mstrmojo.desc(13935,"Move to #"),toNewLayoutTitle:mstrmojo.desc(13936,"Move to a New Sheet"),crossLayoutMessage:mstrmojo.desc(13937,"Moving will clear all filters from the new visualization. Do you want to continue?"),cls:"",fn:function fn(viz,vizPanelStack,dstPanelKey,dstLayoutKey){var vizContentPanel=docModel.getVizContentPanel();vizContentPanel.restoreAnyMaxedVizBox();docModel.moveVisualization(viz,vizPanelStack,dstPanelKey,dstLayoutKey);}}],fnCrossLayout=function fnCrossLayout(title,msg,fnOK){return function(){mstrmojo.warn(msg,{confirmBtn:{fn:fnOK}},{title:title});};};groups.forEach(function(group){cfg.addPopupMenuItem(group.n,null,function(){var groupFn=group.fn,subMenu=new mstrmojo.ui.menus.MenuConfig(),panelStack=me.boxContent.builder.getLayoutVIMap(docModel.getCurrentLayoutKey()).getComponent($VI_COMPONENT_TYPES.VIZ_CONTENT),curLayoutKey=docModel.getCurrentLayoutKey(),otherPanels=panelStack.panels.filter(function(panel){return panel.k!==panelStack.selectedKey;}),otherLayouts=docModel.defn.layouts.filter(function(layoutDefn){return layoutDefn.k!==curLayoutKey;});otherPanels.forEach(function(panel){var panelKey=panel.k;subMenu.addMenuItem(panel.titleText,"",function(){groupFn(me,panelStack,panelKey,curLayoutKey);});});subMenu.addMenuItem(isWSStyling?mstrmojo.desc(6985,"New Page"):mstrmojo.desc(11671,"New Panel"),"",function(){groupFn(me,panelStack,null,curLayoutKey);});subMenu.addSeparator();otherLayouts.forEach(function(layout){subMenu.addMenuItem(layout.title,"",fnCrossLayout(group.toLayoutTitle.replace("#",layout.title),group.crossLayoutMessage,function(){groupFn(me,panelStack,null,layout.k);}));});subMenu.addMenuItem(isWSStyling?mstrmojo.desc(14810,"New Chapter"):mstrmojo.desc(11672,"New Sheet"),"",fnCrossLayout(group.toNewLayoutTitle,group.crossLayoutMessage,function(){groupFn(me,panelStack,null,null);}));return subMenu;},group.cls);});}function toggleMenuButtonTitleCSS(){$CSS.toggleClass(this.domNode,$HAS_SELECTOR_CSS_CLS,!!(this.selectorMenuCfg));$CSS.toggleClass(this.domNode,$HAS_VF_CSS_CLS,!!(this.filterMenuCfg));$CSS.toggleClass(this.filterBtnNode,$CLASS_HIDDEN,!(this.filterMenuCfg));$CSS.toggleClass(this.selectorBtnNode,$CLASS_HIDDEN,!(this.selectorMenuCfg));var parent=this.parent,shouldShowMaximise=!!(parent&&parent.hasMultipleChildren&&parent.hasMultipleChildren()&&!mstrApp.isAppStateSelection());$CSS.toggleClass(this.maxRestoreBtnNode,$CLASS_HIDDEN,!shouldShowMaximise);$CSS.toggleClass(this.maxRestoreBtnNode,"restore",this.isMaxed);}function toggleFloatingButtonCSS(mouseIn){$CSS.toggleClass(this.filterBtnNode,CSS_BTN_VISIBLE,mouseIn);$CSS.toggleClass(this.filterBtnNode,CSS_MOUSE_LEFT,!mouseIn);$CSS.toggleClass(this.selectorBtnNode,CSS_BTN_VISIBLE,mouseIn);$CSS.toggleClass(this.selectorBtnNode,CSS_MOUSE_LEFT,!mouseIn);$CSS.toggleClass(this.maxRestoreBtnNode,CSS_BTN_VISIBLE,mouseIn);$CSS.toggleClass(this.maxRestoreBtnNode,CSS_MOUSE_LEFT,!mouseIn);}function getInlineDialogConfig(vis){return{scriptClass:"mstrmojo.vi.ui.VisAsFilterInlineDialog",vis:vis,tocPanel:mstrApp.rootCtrl.view.tocPanel,shouldNavigate:true};}function createSelectorButtonMenuCfg(){this.selectorMenuCfg=null;if(mstrApp.isAppStateSelection()){return ;}var me=this,model=me.model,visualization=this.boxContent,visModel=visualization.model,menuConfig,visFn=function(fn,obj){return visualization[fn]&&visualization[fn](obj);},sc=visualization.selectorControl||visFn("findSelectorControl"),hasTargets=visFn("isLinkedFilter"),editTargets=function(){mstrApp.rootCtrl.view.openInlineDialog(getInlineDialogConfig(me));},clearTargets=function(){var targetKeys={},an=visFn("getAssociatedNodes")||[],ft=visualization.getFilterType(),isVisMap=visualization.isVisMap,allLayerKeys=visFn("getAllLayerKeys",true),singleCGB=visModel.getSelectorControlMapInfo&&visModel.getSelectorControlMapInfo();$ARR.forEach(an,function(cv){if(isVisMap){$ARR.forEach(allLayerKeys,function(key){targetKeys[key]={c:true,v:false,ft:ft,cgbs:singleCGB,k:key};});}else{targetKeys[cv.k]={c:true,v:false,ft:ft,cgbs:singleCGB,k:cv.k};}});model.setVisAsFilter(me,{sc:sc,targetKeys:targetKeys});};if(hasTargets&&!mstrApp.isAppStatePresentation()){menuConfig=this.addDisposable(new mstrmojo.ui.menus.MenuConfig({menuCssClass:"mstrmojo-viz-fe-menu",isHostedWithin:false,useTooltip:true}));menuConfig.addMenuItem(mstrmojo.desc(15069,"Edit Targets..."),"",editTargets);menuConfig.addMenuItem(mstrmojo.desc(11473,"Clear All Targets"),"",clearTargets);}this.selectorMenuCfg=menuConfig;}function createFilterButtonMenuCfg(){this.filterMenuCfg=null;if(mstrApp.isInVFInteractMode||mstrApp.isAppStateSelection()){return ;}var clearStr=mstrmojo.desc(2827,"Clear"),visualization=this.boxContent,visModel=visualization.model,visKey=this.k,me=this,controller=visualization.controller,node=visualization.node,data=node.data||null,visFn=function(fn,obj1,obj2){var vis=me.boxContent;return vis&&vis[fn]&&vis[fn](obj1,obj2);},orStr=mstrmojo.desc(5283,"OR"),andStr=mstrmojo.desc(5282,"AND"),boldOr=visFn("makeBold",orStr),boldAnd=visFn("makeBold",andStr);if(!data){this.filterMenuCfg=null;return ;}var vfexpr=data.vfexpr,viewFilterExpression,limitExpression=data.vlexpr,selectorObjects=visFn("getSelectorObjectsFromTemplateLimit"),filterMenuCfg,hasKeepOnly=visFn("hasKeepOnly",selectorObjects),docModel=this.model,hasViewFilter,hasDrilling;viewFilterExpression=docModel.getVfNdFromExpr(vfexpr);hasViewFilter=!$IS_EXPR_EMPTY(viewFilterExpression);hasDrilling=viewFilterExpression!==vfexpr;var model=this.model,curLayoutKey=model.getCurrentLayoutKey(),layout=(model.defn.layouts).filter(function(layout){return layout.k===curLayoutKey;})[0],cgb=layout.cgbMap||{},filterSource=$HASH.keyarray(cgb).filter(function(key){return cgb[key]===me.k;}),uc,xfil,activeKey,xsel,xMenuPairs=[],hasXPageFilter,menuString;function buildMenuStr(isTooltipString){var or=" "+(isTooltipString?boldOr:orStr)+" ",and=" "+(isTooltipString?boldAnd:andStr)+" ",joinStr=xfil.fn===20?or:xfil.fn===19?and:"",arr=[clearStr+' "'];xsel=visModel.getSelectorDataFromViewFilter(xfil);$ARR.forEach(xsel,function(selector){menuString=visFn("getLinkingSelectorExpr",selector,isTooltipString);if(arr.length>1){menuString=joinStr+menuString;}arr.push(menuString);});arr.push('"');return arr.join("");}if(filterSource.length){$ARR.forEach(filterSource,function(ucKey){uc=model.getLayoutUnitDefn(ucKey);xfil=uc&&uc.t&&uc.t===$RW_UNIT_TYPES.UNITCONTAINER&&uc.exp;if(xfil){activeKey=uc.latestctlkey;if(($ARR.filterOne(layout.units[ucKey].scs,function(scs){return scs.ckey===activeKey;})||{}).isNavigation){xMenuPairs.push({menuString:buildMenuStr(),menuTtpString:buildMenuStr(true),ucKey:ucKey,ckey:activeKey});}}});}hasXPageFilter=xMenuPairs.length;if(hasKeepOnly||limitExpression||hasViewFilter||hasXPageFilter||hasDrilling){var submitFn=function submitFn(item){var callback=$FUNC.wrapMethods(controller._getXtabCallback(visualization),{success:function success(){var vis=me.boxContent;if(vis){vis.raiseEvent({name:"regenerateToolbar"});}}});if(hasXPageFilter){callback=$FUNC.wrapMethods({success:function success(res){var vis=me.boxContent,puKeys=filterSource;if(vis.getSdpKeyArr){puKeys=filterSource.concat(vis.getSdpKeyArr());}model.partialUpdate(res.data,model.getUnitDefinitions(puKeys),res.defn,filterSource,res.puFilters);}},callback);}if(visualization.filterMenuHandler){visualization.filterMenuHandler(item.ctxt,callback);}};filterMenuCfg=this.addDisposable(new mstrmojo.ui.menus.MenuConfig({menuCssClass:"mstrmojo-viz-fe-menu",isHostedWithin:false,useTooltip:true}));if(!mstrApp.isDossier&&(hasKeepOnly||hasXPageFilter||hasDrilling)){filterMenuCfg.addMenuItem(mstrmojo.desc(1763,"Clear All"),"",submitFn,{type:FILTER_CLEAR_TYPE.CLEAR_ALL});}if(hasKeepOnly){if(filterMenuCfg.hasMenuItems()){filterMenuCfg.addSeparator();}var menuPairs=visFn("getFilterMenuPairs",selectorObjects)||[];$ARR.forEach(menuPairs,function(menuPair){filterMenuCfg.addMenuItem({n:menuPair.menuString,ttp:menuPair.menuTtpString},"",submitFn,{type:FILTER_CLEAR_TYPE.CLEAR_KEEP_ONLY,idx:menuPair.ctxt});});}if(hasDrilling){if(filterMenuCfg.hasMenuItems()){filterMenuCfg.addSeparator();}filterMenuCfg.addMenuItem({n:mstrmojo.desc(15076,"Clear drill conditions"),ttp:$GET_EXPR_TEXT(docModel.getVfexprWithUpdatedVf(visKey,null),true)},"",submitFn,{type:FILTER_CLEAR_TYPE.CLEAR_DRILLING});}if(hasViewFilter||limitExpression){if(filterMenuCfg.hasMenuItems()){filterMenuCfg.addSeparator();}var advFilterItem;var tooltip=[];var viewFilterTooltip=$GET_EXPR_TEXT(viewFilterExpression,true),limitTooltip=$GET_EXPR_TEXT(limitExpression,true);if(viewFilterTooltip){tooltip.push(viewFilterTooltip);}if(limitTooltip){tooltip.push(limitTooltip);}tooltip=tooltip.join(" "+boldAnd+" ");if(mstrApp.isWSStyling&&mstrApp.isAppStateDefault()){advFilterItem={n:mstrmojo.desc(14016,"Advanced Qualification")};filterMenuCfg.addMenuItem(advFilterItem,"",function(){me.onShowFilterEditor(me);});}else{if(!(mstrApp.isDossier||(mstrApp.isAppStatePresentation&&mstrApp.isAppStatePresentation()))){advFilterItem={n:mstrApp.isWSStyling?mstrmojo.desc(15123,"Clear advanced qualification"):mstrmojo.desc(13528,"Clear existing filter"),ttp:tooltip||data.vftext};filterMenuCfg.addMenuItem(advFilterItem,"",submitFn,{type:FILTER_CLEAR_TYPE.CLEAR_ADV_QUALIFICATION});}}}if(hasXPageFilter){filterMenuCfg.addSeparator();$ARR.forEach(xMenuPairs,function(menuPair){filterMenuCfg.addMenuItem({n:menuPair.menuString,ttp:menuPair.menuTtpString},"",submitFn,{type:FILTER_CLEAR_TYPE.CLEAR_LINKING,nodeKey:menuPair.ucKey,ckey:menuPair.ckey});});}}this.filterMenuCfg=filterMenuCfg&&(filterMenuCfg.hasMenuItems()?filterMenuCfg:null);}function canDisplayExcel(visId){var isLiveMode=mstrApp.isWorkstation&&mstrApp.supportFeature(mstrmojo.vi.enums.EnumFeatures.SUPPORT_LIVEMODE)&&mstrApp.getWSLiveMode();return(visId===$KNOWN_VIZ.GRID&&!isLiveMode&&(!!mstrApp.features[EXP_EXCEL_PRIV]||!!mstrApp.isSingleTier));}function canDisplayPDF(visId){return([$KNOWN_VIZ.UNKNOWN].indexOf(visId)===-1&&(!!mstrApp.features[EXP_PDF_PRIV]||!!mstrApp.isSingleTier));}function canDisplayCSV(){return !!mstrApp.features[EXP_CSV_PRIV]||!!mstrApp.isSingleTier;}function canDisplayExportMenu(){var visId=$KNOWN_VIZ.getDefinition(this.boxContent.model.data.visName||"Grid").id;return !(mstrApp&&mstrApp.isVisBuilder)&&(canDisplayExcel(visId)||canDisplayPDF(visId)||canDisplayCSV());}function addExportMenu(cfg){var controllerID=this.model.controller.id,visualization=this.boxContent,gridKey=visualization.k;var empty=!$HASH.walk("gridInfo.cols.length",visualization)&&!$HASH.walk("gridInfo.rows.length",visualization),menuTxt=mstrmojo.desc(246,"Export");if(empty){cfg.addNonInteractiveMenuItem(menuTxt,null,true);}else{cfg.addPopupMenuItem(menuTxt,this.id,function(){var exportCfg=new mstrmojo.ui.menus.MenuConfig(),visId=$KNOWN_VIZ.getDefinition(this.boxContent.model.data.visName||"Grid").id;if(canDisplayExcel(visId)){exportCfg.addMenuItem(mstrmojo.desc(3958,"Excel"),"exportToExcel",function(){mstrmojo.all[controllerID].exportVisualization(visualization,EXP_EXCEL);});}if(canDisplayPDF(visId)){exportCfg.addMenuItem(mstrmojo.desc(1877,"PDF"),"exportToPDF",function(){if(visualization.isClientExport&&visualization.exportVisualization){visualization.exportVisualization(EXP_PDF);}else{mstrmojo.all[controllerID].exportVisualization(visualization,EXP_PDF);}});}if(canDisplayCSV()){exportCfg.addMenuItem(mstrmojo.desc(11807,"Data"),"exportToCSV",function(){mstrmojo.all[controllerID].exportCSV(gridKey);});}return exportCfg;},"export");}}function addChangeVisItem(cfg){var content=this.boxContent,docModel=(content.getDocModel&&content.getDocModel())||content.model.docModel;cfg.addPopupMenuItem(mstrmojo.desc(13165,"Change Visualization"),this.id,function(){var shapeCfg=new $MOJO.ui.menus.MenuConfig({supportsScroll:true,maxHeight:$DOM.windowDim().h-50}),selected=docModel.getVizOfSelectedViUnit(),vizGallery=content.controller.galleryPanel,builtInVisList=vizGallery.vizList,hasBuildInVisList=builtInVisList.items.length>0,customVisList=vizGallery.customVizList;function addVizItem(item,vizList){if(item.id!=="VisGrid"&&$MOJO.ExpressVisList.getVis(item.s)===null){return ;}shapeCfg.addMenuItem(item.n,item.id===(selected&&selected.id)?"on":"",function(){var idx=$ARR.find(vizList.items,"id",item.id);vizList.select([idx]);});}shapeCfg.hasToggleItem=true;if(hasBuildInVisList){shapeCfg.addMenuTitle(mstrmojo.desc(14119,"Built-in"));builtInVisList.items.forEach(function(item){addVizItem(item,builtInVisList);});}if(customVisList.items.length>0){if(hasBuildInVisList){shapeCfg.addSeparator();}shapeCfg.addMenuTitle(mstrmojo.desc(2056,"Custom"));customVisList.items.forEach(function(item){addVizItem(item,customVisList);});}return shapeCfg;},"");}function dropFromDataSource(context,updateDatasetsPanel){var dragData=context.getCtxtDragData();this.getZonesModel().addUnitsFromDataSource(dragData.items,dragData.dsid,context.actions,updateDatasetsPanel?context.callback:null);}function supportUseAsFilter(){var parent=this.parent,viz=this.boxContent,isSupported=false;if(viz.handlesMultiSelection){if(mstrApp.isWSStyling){if(this.getDocModel().getVisibleUnitKeysByType([$RW_UNIT_TYPES.GRID,$RW_UNIT_TYPES.GRAPH,$RW_UNIT_TYPES.MOJOVISUALIZATION]).length>1){isSupported=true;}}else{if(parent&&parent.getTargetKeysByType([$RW_UNIT_TYPES.GRID,$RW_UNIT_TYPES.GRAPH,$RW_UNIT_TYPES.MOJOVISUALIZATION]).length>1){isSupported=true;}}}return isSupported;}function createButton(btnNode,cls,menuCfg){var id=this.id;btnNode=document.createElement("div");btnNode.className=cls;var fnEventHandler=function(){var vizBox=mstrmojo.all[id],cfg=vizBox[menuCfg];cfg.hostId=id;cfg.hostElement=btnNode;if(cfg.hasMenuItems()){var menu=new mstrmojo.ui.menus.Menu({popupConfig:cfg,getTooltipText:function getTooltipText(item){return(item&&item.ttp)||"";}});menu.tooltipCss={enableHover:true,leftCssClass:"menuTooltip mstrmojo-VIBox",rightCssClass:"menuTooltip mstrmojo-VIBox",updatePosition:function updatePosition(){mstrmojo.Tooltip.prototype.updatePosition.call(this);var ttp=this.domNode,arrow=this.arrowNode,ttpRect=ttp.getBoundingClientRect(),ttpTop=ttpRect.top,viewHeight=Math.max(document.documentElement.clientHeight,window.innerHeight||0),item=menu._getItemNode(menu._lastHoverIx),itemRect=(item&&item.getBoundingClientRect())||{},bottom=ttpRect.top+this.containerNode.offsetHeight,overflow=bottom+10-viewHeight;if(overflow>0){ttp.style.top=(ttpTop=ttpRect.top-overflow)+"px";}if(itemRect&&itemRect.top){arrow.style.top=itemRect.top-ttpTop+6+"px";}}};vizBox.openPopup(menu);}};$DOM.attachEvent(btnNode,"click",fnEventHandler);this.domNode.appendChild(btnNode);this.installedEvtListeners.push({e:btnNode,evt:"click",fn:fnEventHandler});return btnNode;}function createMaxRestoreButton(btnNode){var id=this.id;btnNode=document.createElement("div");btnNode.className="hover-max-restore-btn";var fnEventHandler=function(){var vizBox=mstrmojo.all[id],isMaxed=vizBox.isMaxed;vizBox.parent.setPortalState(vizBox,isMaxed?STATE_RESTORE:STATE_MAXIMIZE);if(isMaxed){delete vizBox.isMaxed;}else{vizBox.isMaxed=true;}$CSS.toggleClass(btnNode,"restore",vizBox.isMaxed);};$DOM.attachEvent(btnNode,"click",fnEventHandler);this.domNode.appendChild(btnNode);this.installedEvtListeners.push({e:btnNode,evt:"click",fn:fnEventHandler});return btnNode;}mstrmojo.vi.ui.rw.VizBox=mstrmojo.declare(mstrmojo.vi.ui.rw.UnitContainer,[mstrmojo.vi.ui._CanDropFromSchema,mstrmojo.fe._HasFilterEditor],{scriptClass:"mstrmojo.vi.ui.rw.VizBox",filterEditorScriptClass:"mstrmojo.vi.ui.editors.FilterEditor",showTitleBar:true,titleBar:null,selectorMenuCfg:null,selectorBtnNode:null,filterMenuCfg:null,filterBtnNode:null,maxRestoreBtnNode:null,generateToolbarSub:null,init:function init(props){this._super(props);$CSS.addWidgetCssClass(this,"mstrmojo-VIBox");this.isMaxed=(this.defn.ds===STATE_MAXIMIZE);this.installedEvtListeners=[];},unrender:function(ignoreDOM){$ARR.forEach(this.installedEvtListeners,function(h){$DOM.detachEvent(h.e,h.evt,h.fn);});this.installedEvtListeners=[];delete this.filterBtnNode;delete this.selectorBtnNode;delete this.maxRestoreBtnNode;this._super(ignoreDOM);},getPanelForAddAction:function getPanelForAddAction(){return"editPanel";},getExcludedPanels:function getExcludedPanels(){return[];},getDocModel:function getDocModel(){var model=this.model;return model.docModel||model;},editingTitleCallback:function editingTitleCallback(isEditing){this._super(isEditing);$CSS.toggleClass(this.filterBtnNode,"editing-title",isEditing);$CSS.toggleClass(this.selectorBtnNode,"editing-title",isEditing);$CSS.toggleClass(this.maxRestoreBtnNode,"editing-title",isEditing);},getTitleBarCfg:function getTitleBarCfg(){var cfg=this._super();cfg.scriptClass="mstrmojo.vi.ui.VizBoxTitleBar";cfg.close=function close(){var vizBox=this.parent,vizBoxParent=vizBox.parent;vizBoxParent.deleteBoxAndSubmit(vizBox);vizBoxParent.removeChildren(vizBox);vizBox.destroy();};cfg.beganEditingTitlebar=function beganEditingTitlebar(){var box=this.parent;box.draggable=false;box.editingTitleCallback(true);};cfg.titleEdited=function titleEdited(titleText,textChanged,oldText){var box=this.parent;box.draggable=true;if(textChanged){var model=box.getDocModel();model.renameRWUnitTitle(titleText,this.title,box.k,{success:function success(appliedTitle){box.defn.ttl=appliedTitle;box.set("title",appliedTitle);},failure:function failure(err){requestFailed(err);box.titleBar.set("title",oldText);}});}box.editingTitleCallback(false);};return cfg;},getTitleVisibilityFmts:function getTitleVisibilityFmts(value){var fmts=this._super(value);fmts.FormattingView.ShowWidgetTitleBar=value;return fmts;},onclick:function onclick(){this.model.setVizBoxActive(this.id);this.titleBar.onclick();},switchPropertyOnClick:function switchPropertyOnClick(evt){var boxContent=this.boxContent;if(!boxContent||!boxContent.supportsEditorClickSwitching||evt.e.justSwitched){return false;}return this._super();},postBuildRendering:function postBuildRendering(){try{this._super();this.selectorBtnNode=createButton.call(this,this.selectorBtnNode,"hover-selector-btn","selectorMenuCfg");this.filterBtnNode=createButton.call(this,this.filterBtnNode,"hover-filter-btn","filterMenuCfg");if(this.defn.ds===STATE_MAXIMIZE){this.parent.setPortalState(this,STATE_MAXIMIZE,true);}this.maxRestoreBtnNode=createMaxRestoreButton.call(this,this.maxRestoreBtnNode);toggleMenuButtonTitleCSS.call(this);if(this.menuBtnInfo&&this.menuBtnInfo.btn){$DOM.attachEvent(this.menuBtnInfo.btn,"mousedown",function(){this.generateToolbar();}.bind(this));}var me=this;this.getDocModel().attachEventListener("vizBoxActive",me.id,function(evt){toggleFloatingButtonCSS.call(me,me.id===evt.id);var menuBtnInfo=me.menuBtnInfo;if(menuBtnInfo&&menuBtnInfo.menuCfg){$CSS.toggleClass(menuBtnInfo.btn,CSS_BTN_VISIBLE,me.id===evt.id);$CSS.toggleClass(menuBtnInfo.btn,CSS_MOUSE_LEFT,me.id!==evt.id);}if(me.id===evt.id){me.selectVIUnit();}});this.getDocModel().attachEventListener("visActive",me.id,function(evt){if(me.boxContent&&me.boxContent.id===evt.id){this.model.setVizBoxActive(me.id);}});}catch(e){var div=this.domNode.appendChild(document.createElement("div"));div.className="errorNode";div.innerText=mstrmojo.desc(11461,"There was an error rendering your visualization");this.getZonesModel=function getZonesModel(){return null;};}},doLayout:function doLayout(){var boxContent=this.boxContent;if(boxContent){boxContent.skipReRender=true;}this._super();if(boxContent){delete boxContent.skipReRender;}},applyBoxSize:function applyBoxSize(height,width,top,left){this._super(height,width,top,left);var boxContent=this.boxContent,childFormats=boxContent&&boxContent.getFormats();if(childFormats){var titleOffset=this.titleBar.visible?$DOM.position(this.titlebarNode).h:0;childFormats.height=(parseInt(height,10)-titleOffset)+PX;childFormats.width=width;}},updateDisplayName:function updateDisplayName(displayText,oldDisplayText){this._super(displayText,oldDisplayText,true);},createDeleteUpdate:function createDeleteUpdate(){var model=this.model,update=model.getDataService().newUpdate(),unitKey=this.boxContent.node.k,tgtSelections=this.parent._tgtSelections,sources=model.getSourceFilterKeys(unitKey,true),pRKeys=sources.concat(model.getTargetFilterKeys(this)),sourceViz=[],viz;this.parent.children.forEach(function(childWidget){var unitDefn=childWidget.defn,targetKeys=unitDefn.tks;if(targetKeys){if((targetKeys||"").split("\u001E").indexOf(unitKey)>-1){update.addActions(model.getDataService().getRemoveCtrlTargetAction(unitDefn.ck,unitKey,undefined,true));if(childWidget.defn&&childWidget.defn.srct&&childWidget.defn.srct===TYPE_METRIC){update.setTreesToRender(3);}}}});if(tgtSelections){tgtSelections.remove(unitKey);}if(pRKeys){update.setTreesToRender(3);}update.addUpdate(model.getRemoveUnitUpdate({unit:this,partialRetrievalKeys:pRKeys,clearTargets:true}));$ARR.forEach(sources,function(srcKey){viz=model.getVisualizationByKey(srcKey);if(viz){sourceViz.push(viz);}});update.addUpdate(model.associatedNodesUpdate(sourceViz.concat(this.parent.children)));return update;},generateToolbar:function generateToolbar(){var docPanel=this.parent,visStack=docPanel&&docPanel.parent;if(visStack){var controller=this.model.controller,layoutKey=this.model.getLayoutKeyByUnitKey(visStack.k),layoutViewer=controller.view.getLayoutByKey(layoutKey),currLayoutViewer=controller.view.layoutViewer;if(layoutViewer){if(layoutViewer.k===currLayoutViewer.k){if(this.generateToolbarSub){layoutViewer.detachEventListener(this.generateToolbarSub);delete this.generateToolbarSub;}}else{if(!this.generateToolbarSub){this.generateToolbarSub=layoutViewer.attachEventListener("generateVizBoxToolbar",this.id,"generateToolbar");}return ;}}}createSelectorButtonMenuCfg.call(this);createFilterButtonMenuCfg.call(this);if(this.hasRendered){toggleMenuButtonTitleCSS.call(this);}this._super();},updateToolbar:function updateToolbar(cfg){var me=this,visualization=this.boxContent,showDesignItems=this.canShowDesignMenuItems(),isPauseMode=visualization&&visualization.excludeData,addShowDataMenu=function(){if(!mstrApp.isDossier&&!mstrApp.isInVFConfigMode&&!isPauseMode){cfg.addMenuItem(mstrmojo.desc(11476,"Show Data"),"shwd",function(){mstrmojo.vi.ui.ViewDataDialog.open(mstrmojo.all[me.id]);});}},isAppStatePresentation=mstrApp.isAppStatePresentation(),isLayoutModePreview=mstrApp.isLayoutModePreview(),isWorkstationStyling=mstrApp.isWSStyling,visFilterText=isWorkstationStyling?mstrmojo.desc(15087,"Select Targets..."):mstrmojo.desc(11958,"Use as Filter...");cfg.supportsScroll=true;cfg.isHostedWithin=false;cfg.maxHeight=$DOM.getMaxScrollHeight();if(!isAppStatePresentation&&mstrApp.allowWebDashboardDesign()){var hasRecursiveAttribute=this.model.hasMDXRADataset();addChangeVisItem.call(this,cfg);if(visualization.getContainerMenuItems){visualization.getContainerMenuItems(cfg);}cfg.addSeparator();var dropZonesModel=visualization.zonesModel;if(dropZonesModel&&dropZonesModel.canSwapAxis()){cfg.addMenuItem(mstrmojo.desc(11658,"Swap"),"",function(){dropZonesModel.swapAxis();});cfg.addSeparator();}if(dropZonesModel&&dropZonesModel.canDefineSubtotals()){cfg.addToggleMenuItem(mstrmojo.desc(6193,"Show Totals"),"",function(){dropZonesModel.showQuickSubtotals();},function(){dropZonesModel.hideDefinedSubtotals();},null,dropZonesModel.hasVisibleSubtotals());cfg.addSeparator();}if(mstrApp.supportAdvFilter&&!mstrApp.isInVFInteractMode&&!hasRecursiveAttribute){cfg.addMenuItem(mstrmojo.desc(13402,"Edit Filter..."),"",function(){me.onShowFilterEditor(me);});}if(!mstrApp.isInVFConfigMode&&!mstrApp.isInVFInteractMode){if(supportUseAsFilter.call(this)){cfg.addMenuItem(visFilterText,"uaf",function(){var vis=mstrmojo.all[me.id],vizContentPanel=me.model&&me.model.getVizContentPanel();if(vizContentPanel){vizContentPanel.restoreAnyMaxedVizBox();}mstrApp.rootCtrl.view.openInlineDialog(getInlineDialogConfig(vis));});cfg.addSeparator();}}if(!isPauseMode){cfg.addMenuItem(mstrmojo.desc(15621,"Query Details..."),"",function(){var sqlViewer=mstrmojo.all.sqlViewer,docModelData=me.boxContent&&me.boxContent.model&&me.boxContent.model.data,csiText=docModelData&&docModelData.csi;if(!sqlViewer){sqlViewer=mstrmojo.insert({id:"sqlViewer",title:mstrmojo.desc(15619,"Query Details"),scriptClass:"mstrmojo.vi.ui.editors.SQLCSIViewer"});}sqlViewer.set("csiText",csiText||"");sqlViewer.open();});}addShowDataMenu();if(!mstrApp.isInVFConfigMode&&!mstrApp.isInVFInteractMode){cfg.addMenuItem(mstrmojo.desc(14389,"Remove Data"),"",function(){me.vizRemoveDataHandler(visualization);});}cfg.addPopupMenuItem(mstrmojo.desc(12949,"Data Source"),this.id,function(){var setPrimDSCfg=new mstrmojo.ui.menus.MenuConfig(),model=me.model,datasets=model.datasets,gridSource=me.boxContent.model.data.datasetId||"",datasetOptions=[];$HASH.forEach(datasets,function(dataset,id){datasetOptions.push({name:dataset.name,id:id});});if(!hasRecursiveAttribute){datasetOptions.push({name:mstrmojo.desc(5949,"None"),id:""});}datasetOptions.forEach(function(opt){var id=opt.id;setPrimDSCfg.addMenuItem(opt.name,gridSource===id?"on":"",function(){var nodeKey=me.k,datasetId=id;if(gridSource===id){return ;}visualization.zonesModel.submitActionForDatasetUpdate({act:"editNode",nodeKey:nodeKey,treeType:me.defn.tt,datasetId:datasetId||"00000000000000000000000000000000",partialRetrieval:{nodes:[nodeKey]}});});});setPrimDSCfg.hasToggleItem=true;return setPrimDSCfg;});cfg.addSeparator();if(canDisplayExportMenu.call(this)&&!mstrApp.isInVFConfigMode&&!mstrApp.isInVFInteractMode&&!isPauseMode){addExportMenu.call(this,cfg);}if(!isLayoutModePreview&&showDesignItems&&!mstrApp.isInVFConfigMode&&!mstrApp.isInVFInteractMode&&!mstrApp.isVisBuilder){cfg.addMenuItem(mstrmojo.desc(3397,"Duplicate"),"dup",function(){var vizContentPanel=me.model&&me.model.getVizContentPanel();if(vizContentPanel){vizContentPanel.restoreAnyMaxedVizBox();}me.model.duplicateVisualization(me);});addCopyMoveMenuItems.call(this,cfg);}cfg.addSeparator();if(!mstrApp.isInVFConfigMode){this.addToggleTitleMenuItem(cfg);if(visualization.addToggleToolbarMenuItem){visualization.addToggleToolbarMenuItem(cfg);}}}else{addShowDataMenu();if(canDisplayExportMenu.call(this)&&!mstrApp.isInVFConfigMode&&!mstrApp.isInVFInteractMode){addExportMenu.call(this,cfg);}}this._super(cfg);if(!isAppStatePresentation&&mstrApp.allowWebDashboardDesign()&&!mstrApp.isInVFConfigMode&&!mstrApp.isInVFInteractMode){cfg.addSeparator();cfg.addMenuItem(mstrmojo.desc(9126,"More Options...")+"...","",function(){var editorModel=me.getEditorModel(),hostModel=editorModel.getHost().model,hostModelData=hostModel&&hostModel.data,prop=(hostModelData&&hostModelData.gsi&&hostModelData.gsi.prop)||{};if(visualization instanceof mstrmojo.vi.ui.rw.Xtab){editorModel.openMoreOptionsEditor(prop,true,hostModelData.lhv);}else{editorModel.openMoreOptionsEditor(prop);}});}return cfg;},vizRemoveDataHandler:function vizRemoveDataHandler(viz){if(viz.scriptClass==="mstrmojo.VisMapBase"){viz.reset();}else{var dropZonesModel=viz&&viz.zonesModel;if(dropZonesModel&&dropZonesModel.docModel){dropZonesModel.clearAllDropZones(dropZonesModel.docModel.clearVisAsFilterAction(this));}}},addFormatMenuItem:function addFormatMenuItem(menuCfg,formatData,fnCustom){var editModel=this.getEditorModel(),fnCustomOfModel=editModel.getFormatToTargetFn&&editModel.getFormatToTargetFn();if(fnCustomOfModel){fnCustom=fnCustom?$FUNC.composite([fnCustom,fnCustomOfModel]):fnCustomOfModel;}return this._super(menuCfg,formatData,fnCustom);},getFormatMenuItemTarget:function getFormatMenuItemTarget(formatData){var boxContent=this.boxContent;if(boxContent.getFormatMenuItemTarget){var target=boxContent.getFormatMenuItemTarget(formatData);if(target!==undefined){return target;}}return this._super(formatData);},getZonesModel:function getZonesModel(){return this.boxContent.zonesModel;},allowDropFromDataset:function allowDropFromDataset(context){var boxContent=this.boxContent;if(boxContent&&boxContent.allowBoxDropFromDataset){return boxContent.allowBoxDropFromDataset(context);}return true;},dropFromDataset:function dropFromDataset(context){dropFromDataSource.call(this,context,false);},dropFromAllObjects:function dropFromAllObjects(context){this.augmentDropContextForSchema(context,this.getZonesModel().docModel);dropFromDataSource.call(this,context,true);},isDragValid:function isDragValid(context){var boxContent=this.boxContent;if(boxContent.canOnlyDragOnTitleBar){if(!$DOM.contains(this.titleBar.getLabelNode(),context.src.node,true,this.domNode)){return false;}}return this._super(context)&&!this.isMaxed;},menuDisplayCallback:function menuDisplayCallback(visible){this._super(visible);toggleFloatingButtonCSS.call(this,visible);},getAvatarCls:function getAvatarCls(){return this._super().concat(["viz-avi"]);},ondragenter:function ondragenter(context){var boxContent=this.boxContent,dragSource=context.getCtxtDragData().src;if(boxContent.handleDndForParentNode&&boxContent.ondragenter){if(dragSource===ENUM_SOURCE.DATASETS||dragSource===ENUM_SOURCE.VIZ_EDITOR||dragSource===ENUM_SOURCE.VIZ||dragSource===ENUM_SOURCE.ALL_OBJECT_LIST){boxContent.ondragenter(context);return ;}}this._super(context);},ondragleave:function ondragleave(context){var boxContent=this.boxContent,dragSource=context.getCtxtDragData().src;if(boxContent.handleDndForParentNode&&boxContent.ondragleave){if(dragSource===ENUM_SOURCE.DATASETS||dragSource===ENUM_SOURCE.VIZ_EDITOR||dragSource===ENUM_SOURCE.VIZ||dragSource===ENUM_SOURCE.ALL_OBJECT_LIST){boxContent.ondragleave(context);return ;}}this._super(context);},setTitleBarVisibility:function setTitleBarVisibility(isVisible){this._super(isVisible);this.titleBar.onclick();},onmouseenter:function onmouseenter(evt){this._super(evt);toggleFloatingButtonCSS.call(this,true);},onmouseleave:function onmouseleave(evt){this._super(evt);toggleFloatingButtonCSS.call(this,false);},validateTarget:function validateTarget(){return true;},getNodeKeys:function getNodeKeys(){var boxContent=this.boxContent,hasMultiNodes=boxContent&&boxContent.isVisMap;return(hasMultiNodes&&boxContent.getNodeKeys)?boxContent.getNodeKeys():[this.k];}});mstrmojo.vi.ui.rw.VizBox.ENUM_PORTAL_STATE={RESTORE:STATE_RESTORE,MAXIMIZE:STATE_MAXIMIZE};}());