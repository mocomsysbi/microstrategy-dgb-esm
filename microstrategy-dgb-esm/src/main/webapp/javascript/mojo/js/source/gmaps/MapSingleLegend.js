(function(){mstrmojo.requiresCls("mstrmojo.Vis","mstrmojo.css","mstrmojo.dom","mstrmojo.VisEnum","mstrmojo.gmaps.MapSingleLegendContent","mstrmojo.gmaps.MapEnums","mstrmojo.gmaps.MapLegendEnums","mstrmojo.gmaps.MapUtils");var $MOJO=mstrmojo,$CSS=$MOJO.css,$DOM=$MOJO.dom,$GMAPS=$MOJO.gmaps,$MUTIL=$GMAPS.MapUtils,SHAPE_TYPE=$GMAPS.ShapeType,GRAPHIC_TYPE=$GMAPS.EnumGraphicType,MARKER_TYPE=$GMAPS.EnumMarkerType,LGD_CONTENT=$GMAPS.MapSingleLegendContent,$VIS_ENUM=$MOJO.VisEnum,ENUM_SINGLE_LEGEND_MODE=$VIS_ENUM.EnumSingleLegendMode,CLGD=$GMAPS.EnumPropertyType.collapseLegend;function removeNode(node,parentNode){if(node.parentNode===parentNode){parentNode.removeChild(node);return true;}return false;}function displayColorByNormal(colorByData,shapeType,isColorByAttr,widgetId){var colorBySlot,sizeBySlot,domLgd=this.domLgd;sizeBySlot=this.sizeBySlot;colorBySlot=this.colorBySlot=new LGD_CONTENT();colorBySlot.render();colorBySlot.handleColorBy(colorByData,shapeType,isColorByAttr,widgetId);if(sizeBySlot&&sizeBySlot.domLgdContent&&sizeBySlot.domLgdContent.parentNode===domLgd){domLgd.insertBefore(colorBySlot.domLgdContent,sizeBySlot.domLgdContent);}else{domLgd.appendChild(colorBySlot.domLgdContent);}}function displaySizeByNormal(sizeByData){var sizeBySlot;sizeBySlot=this.sizeBySlot=new LGD_CONTENT();sizeBySlot.render();sizeBySlot.handleSizeBy(sizeByData);this.domLgd.appendChild(sizeBySlot.domLgdContent);}function displayLegendNormal(lgdData,shapeType,isColorByAttr,widgetId){var triButton=this.triButton,colorByData=lgdData.colorByData,sizeByData=lgdData.sizeByData;$MUTIL.setNodeAttributes(triButton,{title:mstrmojo.desc(8973,"Collapse")});if(!lgdData){return ;}if(colorByData&&colorByData.item&&colorByData.elements){if(!this.colorBySlot){displayColorByNormal.call(this,colorByData,shapeType,isColorByAttr,widgetId);}}if(sizeByData&&sizeByData.item&&sizeByData.elements){if(!this.sizeBySlot){displaySizeByNormal.call(this,sizeByData);}}}function handleMarkerShapeType(layer){var markerType=layer.getMarkerType();switch(markerType){case MARKER_TYPE.Pin:return SHAPE_TYPE.PIN;case MARKER_TYPE.Square:return SHAPE_TYPE.RECT;case MARKER_TYPE.Diamond:return SHAPE_TYPE.DIAMOND;case MARKER_TYPE.Circle:return SHAPE_TYPE.CIRCLE;case MARKER_TYPE.Image:return SHAPE_TYPE.RECT;default:return SHAPE_TYPE.CIRCLE;}}function handleShapeType(layer){var graphicType=layer.graphicType;switch(graphicType){case GRAPHIC_TYPE.Bubble:return SHAPE_TYPE.CIRCLE;case GRAPHIC_TYPE.Area:return SHAPE_TYPE.POLYGON;case GRAPHIC_TYPE.Marker:return handleMarkerShapeType(layer);default:return SHAPE_TYPE.RECT;}}mstrmojo.gmaps.MapSingleLegend=mstrmojo.declare(mstrmojo.Vis,[],{scriptClass:"mstrmojo.gmaps.MapSingleLegend",colorBySlot:null,sizeBySlot:null,displayStatus:false,collapse:false,widgetId:null,layerKey:null,markupString:'<div class="map-legend" mstrAttach:click><div class="map-legend-title-bar"><div class="map-legend-tri-button"></div><div class="map-legend-layer-icon"></div><div class="map-legend-title-text"></div></div></div>',markupSlots:{domLgd:function(){return this.domNode;}},postBuildRendering:function postBuildRendering(){this._super();var legend=this.domLgd,titleBar=legend.firstChild,triButton=titleBar.firstChild,titleText=titleBar.lastChild;this.addSlots({titleBar:titleBar,triButton:triButton,titleText:titleText});},initializeLegend:function initializeLegend(lgdId,lgdTitle,lgdData,layer,widgetId,display){this.domLgd.id=lgdId;this.displayStatus=display;this.updateLegendTitle(lgdTitle);var shapeType=handleShapeType(layer),isColorByAttr=layer.isColorByAttr,collapseStatus=parseInt(layer.getLayerProp(CLGD));displayLegendNormal.call(this,lgdData,shapeType,isColorByAttr,widgetId);this.widgetId=widgetId;this.layerKey=layer.key;if(collapseStatus===ENUM_SINGLE_LEGEND_MODE.COLLAPSE){this.collapseContent();}},updateLegendTitle:function updateLegendTitle(lgdTitle){var titleText=this.titleText;titleText.innerHTML=lgdTitle;$MUTIL.setNodeAttributes(titleText,{title:lgdTitle});},resetColorByData:function resetColorByData(cbData,layer,widgetId){if(cbData&&cbData.item&&cbData.elements){var colorBySlot=this.colorBySlot,shapeType=handleShapeType(layer),isColorByAttr=layer.isColorByAttr,domLgd=this.domLgd;if(colorBySlot){removeNode(colorBySlot.domNode,domLgd);delete this.colorBySlot;}displayColorByNormal.call(this,cbData,shapeType,isColorByAttr,widgetId);colorBySlot=this.colorBySlot;if(this.collapse&&colorBySlot){removeNode(colorBySlot.domLgdContent,domLgd);}}},resetSizeByData:function resetSizeByData(sbData){if(sbData&&sbData.item&&sbData.elements){var sizeBySlot=this.sizeBySlot;if(sizeBySlot){removeNode(sizeBySlot.domNode,this.domLgd);delete this.sizeBySlot;}displaySizeByNormal.call(this,sbData);}},showLegend:function showLegend(){this.displayStatus=true;},hideLegend:function hideLegend(){this.displayStatus=false;},isShown:function isShown(){return this.displayStatus;},collapseContent:function collapseContent(){var triButton=this.triButton,sizeBySlot=this.sizeBySlot,colorBySlot=this.colorBySlot,domLgd=this.domLgd;this.collapse=true;$MUTIL.setNodeAttributes(triButton,{title:mstrmojo.desc(8972,"Expand")});$CSS.addClass(triButton,"collapsed");if(colorBySlot){removeNode(colorBySlot.domLgdContent,domLgd);}if(sizeBySlot){removeNode(sizeBySlot.domLgdContent,domLgd);}},restoreContent:function restoreContent(){var triButton=this.triButton,sizeBySlot=this.sizeBySlot,colorBySlot=this.colorBySlot,domLgd=this.domLgd;this.collapse=false;$MUTIL.setNodeAttributes(triButton,{title:mstrmojo.desc(8973,"Collapse")});$CSS.removeClass(triButton,"collapsed");if(colorBySlot){domLgd.appendChild(colorBySlot.domLgdContent);}if(sizeBySlot){domLgd.appendChild(sizeBySlot.domLgdContent);}},onclick:function(evt){var target=evt.getTarget(),widget;if(target===this.triButton){widget=$MOJO.all[this.widgetId];if(this.collapse){this.restoreContent();widget.legendCon.checkLastCollapse();widget.handleLegendCollapse(this.layerKey,ENUM_SINGLE_LEGEND_MODE.RESTORE);}else{widget.legendCon.checkFirstCollapse();this.collapseContent();widget.handleLegendCollapse(this.layerKey,ENUM_SINGLE_LEGEND_MODE.COLLAPSE);}}$DOM.stopPropogation(null,evt.e);},isCollapse:function isCollapse(){return this.collapse;},handleLegendCollapsePropChange:function handleLegendCollapsePropChange(collapse){if(collapse===ENUM_SINGLE_LEGEND_MODE.COLLAPSE){this.collapseContent();}else{if(collapse===ENUM_SINGLE_LEGEND_MODE.RESTORE){this.restoreContent();}}}});}());