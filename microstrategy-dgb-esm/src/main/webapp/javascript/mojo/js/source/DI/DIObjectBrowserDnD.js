(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo._HasLayout","mstrmojo.List","mstrmojo.DI.DITreeDnD","mstrmojo.DI.DITreeNodeDnD");mstrmojo.requiresDescs(12714,14899);var $ARR=mstrmojo.array;function compare(a,b){var str1=a.n.toLowerCase(),str2=b.n.toLowerCase();if((a.isFolder&&b.isFolder)||(!a.isFolder&&!b.isFolder)){if(str1<str2){return -1;}if(str1>str2){return 1;}return 0;}if(a.isFolder&&!b.isFolder){return -1;}if(!a.isFolder&&b.isFolder){return 1;}}mstrmojo.DI.DIObjectBrowserDnD=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasLayout],{scriptClass:"mstrmojo.DI.DIObjectBrowserDnD",markupString:'<div id="{@id}" class="{@cssClass}" style="{@cssText}"><div></div><div></div></div>',markupSlots:{containerNode:function(){return this.domNode;},listHeaderNode:function(){return this.domNode.children[0];},listNode:function(){return this.domNode.children[1];}},markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";}},canRefresh:false,sizeTooltip:false,folderSizeTooltip:false,showBrowseText:false,children:[{scriptClass:"mstrmojo.List",slot:"listHeaderNode",itemMarkupFunction:function(item,idx,w){var refreshButtonHTML=w.parent.canRefresh?'<div class="di-refresh-reports-dnd icon-clickable di-object-browser-header-right" mstrAttach:click></div>':"";return'<div><table cellpadding="0" cellspacing="0" style="width: 100%;"><tr><td class="mstrmojo-di-so-list-header-dnd cf" style="width: 30%;"><div class="di-object-browser-header-left">'+item.n+"</div>"+refreshButtonHTML+"</td></tr></table></div>";},items:null,onmousedown:function(evt){if(evt.e.target.className==="di-refresh-reports-dnd icon-clickable di-object-browser-header-right"){this.parent.clickedNode=this.parent.fileTree;this.parent.refreshFunction();}}},{slot:"listNode",scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-di-browse-text",alias:"browseText",text:mstrmojo.desc(14899,"Input the URL for remote folder and you can view folder list here"),bindings:{visible:"this.parent.showBrowseText"}},{scriptClass:"mstrmojo.DI.DITreeDnD",alias:"fileTree",slot:"listNode",cssClass:"mstrmojo-di-ga-table",bindings:{supportFolderDrag:"this.parent.supportFolderDrag",sizeTooltip:"this.parent.sizeTooltip",folderSizeTooltip:"this.parent.folderSizeTooltip"}}],browseFunction:mstrmojo.emptyFn(),editFunction:mstrmojo.emptyFn(),refreshFunction:mstrmojo.emptyFn(),filterType:[],clickedNode:null,fileList:null,sortRoot:true,supportFolderDrag:true,dblClickNodeFunction:mstrmojo.emptyFn,setFileListForNode:function(fileList,node){var i,items=[],tn;var list=fileList;var self=this;for(i=0;i<list.length;i++){var item=list[i];if((this.filterType.length>0)&&mstrmojo.array.indexOf(this.filterType,item.type)===-1){continue;}item.clickHandler=self.onTreeNodeClick;item.dblClickHandler=self.onTreeNodeDblClick;item.list=self.fileTree;item.browser=self;if(node.data){var parentFolder=node.data.folderPath||"";item.folderPath=parentFolder+"/"+node.data.n;node.data.fetched=true;}if(!item.isFolder){item.editHandler=self.onEditButtonClick;item.iconEntity="mstrmojo-di-tree-node-icon text-doc";}tn=new mstrmojo.DI.DITreeNodeDnD(item);items.push(tn);}if(this.sortRoot){items.sort(compare);}node.set("sizeTooltip",this.sizeTooltip);node.set("folderSizeTooltip",this.folderSizeTooltip);node.data.fetched=true;node.set("items",items);node.selectedItem=null;node.selectedNode=null;this.buildNodeRelation(node);},onfileListChange:function(){var i,j,items=[],cItems,tn,tcn;var list=this.fileList;var self=this;var nodesToBuildRelation=[];if(this.showBrowseText&&list&&list.length){this.set("showBrowseText",false);}for(i=0;i<list.length;i++){var item=list[i];if((this.filterType.length>0)&&mstrmojo.array.indexOf(this.filterType,item.type)===-1){continue;}item.clickHandler=self.onTreeNodeClick;item.dblClickHandler=self.onTreeNodeDblClick;item.list=self.fileTree;item.browser=self;if(this.clickedNode.data){var parentFolder=this.clickedNode.data.folderPath||"";item.folderPath=parentFolder+"/"+this.clickedNode.data.n;this.clickedNode.data.fetched=true;}if(!item.isFolder){item.editHandler=self.onEditButtonClick;item.iconEntity="mstrmojo-di-tree-node-icon text-doc";}tn=new mstrmojo.DI.DITreeNodeDnD(item);if(item.cItem){cItems=[];for(j=0;j<item.cItem.length;j++){var cItem=item.cItem[j];cItem.clickHandler=self.onTreeNodeClick;cItem.dblClickHandler=self.onTreeNodeDblClick;cItem.list=self.fileTree;cItem.browser=self;cItem.iconEntity="mstrmojo-di-tree-node-icon salesforce";tcn=new mstrmojo.DI.DITreeNodeDnD(cItem);cItems.push(tcn);}cItems.sort(compare);tn.set("items",cItems);tn.fetched=true;nodesToBuildRelation.push(tn);}items.push(tn);}if(this.sortRoot){items.sort(compare);}this.clickedNode.set("sizeTooltip",this.sizeTooltip);this.clickedNode.set("folderSizeTooltip",this.folderSizeTooltip);this.clickedNode.set("items",items);this.clickedNode.selectedItem=null;this.clickedNode.selectedNode=null;this.buildNodeRelation(this.clickedNode);$ARR.forEach(nodesToBuildRelation,function(node){self.buildNodeRelation(node.node);});},buildNodeRelation:function buildUpNodeRelation(rootNode){var ancestorList=[],preOrderNode=null,currentNode=null,rootNextOrderNode=null;if(!!rootNode.ancestorList){ancestorList=rootNode.ancestorList;preOrderNode=rootNode;rootNextOrderNode=rootNode.nextOrderNode;}mstrmojo.array.forEach(rootNode.items,function(itemNode){currentNode=itemNode.node;if(!currentNode){return ;}if(!currentNode.ancestorList){currentNode.ancestorList=[];}mstrmojo.hash.copy(ancestorList,currentNode.ancestorList);currentNode.ancestorList.push(currentNode.index);if(preOrderNode){preOrderNode.nextOrderNode=currentNode;}preOrderNode=currentNode;});if(currentNode){currentNode.nextOrderNode=rootNextOrderNode;}},onEditButtonClick:function onEditButtonClick(node){node.data.browser.editFunction(node);},onTreeNodeClick:function onTreeNodeClick(node){if(node.data.isFolder){node.data.browser.clickedNode=node;node.data.browser.browseFunction(node);}else{this.data.list.selectedItem=node.data;}},onTreeNodeDblClick:function(node){if(!node.data.isFolder){this.data.list.selectedItem=node.data;}node.data.browser.dblClickNodeFunction(node);},postBuildRendering:function postBuildRendering(){if(this._super){this._super();}this.clickedNode=this.fileTree;},setDimensions:function setDimensions(h,w){var height=parseInt(h,10);var width=parseInt(w,10);if(isNaN(height)||isNaN(width)){return ;}if(!this.layoutConfig){this.layoutConfig={h:{},w:{}};}this.layoutConfig.h.listHeaderNode="44px";this.layoutConfig.w.listHeaderNode=width+"px";this.layoutConfig.h.listNode=Math.max((height-44),0)+"px";this.layoutConfig.w.listNode=Math.max(width,0)+"px";if(this._super){this._super(height+"px",w);}}});}());