(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.string","mstrmojo.gmaps.MapEnums","mstrmojo.gmaps.MapUtils","mstrmojo.gmaps._AreaMapHelper");var $ARR=mstrmojo.array,$GMAPS=mstrmojo.gmaps,$MUTIL=$GMAPS.MapUtils,$AMHelper=$GMAPS._AreaMapHelper,$EnumGeographicRole=$GMAPS.EnumGeographicRole,ATTRIBUTE_DELIMITER=",";mstrmojo.gmaps.layer._SecondaryGeoRoleHelper=mstrmojo.provide("mstrmojo.gmaps.layer._SecondaryGeoRoleHelper",{_mixinName:"mstrmojo.gmaps.layer._SecondaryGeoRoleHelper",initWebMapConfig:function initWebMapConfig(initSecondaryRole){var globalCfg=this.map.getMapConfig().common,shapes=globalCfg.shapes,layers=globalCfg.layers,layerProps=this.layerProps,webmapConfig={},mapViewer=this.parent,geoSecondaryRolePosition,shape,layer,lid,geoRole,i,il,baseMapType;if(!shapes||!shapes.length||!layerProps){return ;}lid=layerProps.lid;if(!!lid){shape=$AMHelper.getMatchingShape(shapes,lid,null);}else{geoRole=$AMHelper.getShapeAttributeGeoRole(this.data,this.dropZones.geoAttribute);if(!geoRole){$MUTIL.log("Geo role not found in the GeoAttribute. Can not render area.");}baseMapType=mapViewer.getBaseMapType();shapes=$AMHelper.getAvailableShapes(shapes,layers,geoRole,baseMapType);shape=$AMHelper.getMatchingShape(shapes,null,geoRole);}if(!!shape){layerProps.lid=shape.id;webmapConfig.qf=this._extractShapeQf(shape.qf);webmapConfig.ea=shape.ea||shape.shapeKey;webmapConfig.ml=null;webmapConfig.sf=shape.sf;webmapConfig.sfr=parseInt(shape.sfr);for(i=0,il=layers.length;i<il;i++){layer=layers[i];if(shape.layerId===layer.id){webmapConfig.ml=$MUTIL._verifyProtocol(layer.ml);break;}}}if(initSecondaryRole){geoSecondaryRolePosition=this.geoSecondaryRolePosition=this.getSecondaryFieldRoleAttributeIndex(webmapConfig);if($MUTIL.isVI()&&mapViewer&&!!shape&&shape.roleId==$EnumGeographicRole.EnumGeographicRoleCounty){if(geoSecondaryRolePosition===-1){mapViewer.showToast(mstrmojo.desc(13835,"County names are not necessarily unique. Please add State as an attribute in the tooltip drop zone."));}else{mapViewer.destroyToast();}}}return webmapConfig;},_extractShapeQf:function _extractShapeQf(qf){if(qf&&!$ARR.isArray(qf)){var arr=qf.substring(1,qf.length-1).split(/\s*,\s*/),len=arr.length,str,i;for(i=0;i<len;i++){str=arr[i];arr[i]=str.substring(1,str.length-1);}return arr;}else{return qf;}},getSecondaryFieldRoleAttributeIndex:function getSecondaryFieldRoleAttributeIndex(webmapConfig){var rows=this.getDataRows(),result=-1,forms,geoRole,rowItem,i,il,j,jl;if(!webmapConfig||!rows){return ;}for(i=0,il=rows.length;i<il;i++){rowItem=rows[i];if(rowItem.otp!==12){continue;}forms=rowItem.fs;for(j=0,jl=forms.length;j<jl;j++){geoRole=forms[j].fgr;if(isNaN(geoRole)||parseInt(geoRole,10)<0||parseInt(geoRole,10)>parseInt($EnumGeographicRole.EnumGeographicRoleLastOne,10)){continue;}if(parseInt(geoRole)===webmapConfig.sfr){result=i;break;}}}return result;},getIdStringForRow:function getIdStringForRow(rowIndex,geoPosition,secondGeoPosition){var idString=this.getElementValue(rowIndex,geoPosition);if($MUTIL.checkDefined(secondGeoPosition)&&secondGeoPosition!==-1){idString+=ATTRIBUTE_DELIMITER+this.getElementValue(rowIndex,secondGeoPosition);}return idString;},createLookup:function createLookup(){return this._shapeToRowIndexMap;},getNameConversionMap:function getNameConversionMap(){var baseMapType=this.parent&&this.parent.getBaseMapType(),nameConversions=this.map.getMapConfig().common.nameConversions,len=(nameConversions&&nameConversions.length)||0,conversionMap={},conversion,i,name;for(i=0;i<len;i++){conversion=nameConversions[i];if(conversion.scope===baseMapType){name=conversion.n;name=(name&&name.toLowerCase)?name.toLowerCase():name;if(!conversionMap[name]){conversionMap[name]=[];}conversionMap[name].push(conversion);}}return conversionMap;},convertName:function convertName(geoName,geoRole){var nameConversionMap=this.nameConversionMap,convertedName=geoName,name=(geoName&&geoName.toLowerCase)?geoName.toLowerCase():geoName,conversions,conversion,value,role,len,i;if(nameConversionMap&&nameConversionMap[name]){conversions=nameConversionMap[name];len=conversions.length;for(i=0;i<len;i++){conversion=conversions[i];role=conversion.role;if(!role||geoRole===role){value=$MUTIL.trimString(conversion.value);convertedName=value;this._convertedNameMap[value]=geoName;break;}}}return $MUTIL.trimString(convertedName);}});}());