(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.dom","mstrmojo.array","mstrmojo.gmaps.MapUtils","mstrmojo.gmaps.MapEnums","mstrmojo.vi.controllers.UICmdMgr");var $MOJO=mstrmojo,$DOM=$MOJO.dom,$HASH=$MOJO.hash,$ARR=$MOJO.array,$GMAPS=$MOJO.gmaps,$SelectionHashType=$GMAPS.SelectionHashType,$MUTIL=$GMAPS.MapUtils,COMMAND_STATE=mstrmojo.vi.controllers.UICmdMgr.STATES;mstrmojo.gmaps._MapInteractivity=mstrmojo.provide("mstrmojo.gmaps._MapInteractivity",{_mixinName:"mstrmojo.gmaps._MapInteractivity",graphicMenuOnCloseFlag:false,handleMouseClickEvt:function handleMouseClickEvt(e,graphics){var map=this.parent,selectionBeforeClick;if(map){map.selectionHashType=$SelectionHashType.TEMPLATE_SELECTION;selectionBeforeClick=$HASH.clone(map.getSelectionHash());this.handleClickEvt(e,graphics);if(!$HASH.equals(selectionBeforeClick,map.getSelectionHash())){map.endSelections();}else{map.raiseGraphicsSelectedEvent();}map.handleTemplateUnitSelections();}},handleClickEvt:function handleClickEvt(e,graphics){if(this.enablePopup!==true||!e||!$MUTIL.checkVal(e.clientX)||!$MUTIL.checkVal(e.clientY)){return ;}var clickHandlingGraphicLayer,map=this.parent;this._preClickHandler();map.clearCxtMnuSelection();e.graphics=graphics;if(graphics&&graphics.length>0){clickHandlingGraphicLayer=this.getGraphicLayerFromGraphic(e,graphics);clickHandlingGraphicLayer.handleGraphicsClick(graphics,e);}else{if(this.graphicMenuOnCloseFlag===false){map.clearSelections(true);}}this.graphicMenuOnCloseFlag=false;},handleContextMenuEvt:function handleContextMenuEvt(evt,graphics){var me=this,map=this.parent;if(!evt){return false;}this.hideTooltip();this.handleContextMenuClickEvt(evt,graphics||this.getGraphicsFromPoint(evt));map.handleTemplateUnitSelections();var cmdMgr=map.controller.cmdMgr,STATE_BUSY=COMMAND_STATE.BUSY,graphics=evt&&evt.graphics;if(cmdMgr.state!==STATE_BUSY){map.handleContextMenuEvt(evt);if(map.contextMenu&&graphics&&graphics.length>0){map.contextMenu.onCloseMenuCallBack=function(){var mapViewer=map.mapViewer;map.clearContextMenuSelectionHighLights();me.graphicMenuOnCloseFlag=true;if(mapViewer){mapViewer.highlightAllLayers();}};}}else{var targetConfig=map.getTargetConfig(graphics),menuConfig=map.getMenuConfig(targetConfig);if(menuConfig.hasMenuItems()){$DOM.stopPropogation(window,evt);$DOM.preventDefault(window,evt);}this.handleContextMenuInterval=window.setInterval(function(){if(cmdMgr.state!==STATE_BUSY){window.clearInterval(me.handleContextMenuInterval);if(!me.destroyed){me.handleContextMenuInterval=undefined;map.handleContextMenuEvt(evt);}}},10);}return false;},handleContextMenuClickEvt:function handleContextMenuClickEvt(evt,graphics){if(this.enablePopup!==true||!evt||!$MUTIL.checkVal(evt.clientX)||!$MUTIL.checkVal(evt.clientY)){return ;}var clickHandlingGraphicLayer,map=this.parent,firstGraphic,isGraphicSelected;this._preContextMenuClickHandler();map.clearCxtMnuSelection();evt.graphics=graphics;if(graphics&&graphics.length>0){firstGraphic=graphics[0];isGraphicSelected=firstGraphic&&firstGraphic.isSelected();if(!isGraphicSelected){clickHandlingGraphicLayer=firstGraphic&&firstGraphic.getGraphicLayer();clickHandlingGraphicLayer.handleGraphicsContextMenuClick(graphics,evt);}else{this.forEachGraphicLayer(function(graphicLayer){if($MUTIL.checkHasFunction(graphicLayer,"cloneSelectionToContextMenuSelection")){graphicLayer.cloneSelectionToContextMenuSelection();}},true);}}this.highlightAllLayers();this.graphicMenuOnCloseFlag=false;},getGraphicLayerFromGraphic:function getGraphicLayerFromGraphic(e,graphics){var firstGraphic=graphics&&graphics[0];if(firstGraphic){return firstGraphic.getGraphicLayer();}},_preClickHandler:function _preClickHandler(){this.forEachGraphicLayer(function(graphicLayer){if($MUTIL.checkHasFunction(graphicLayer,"handleClickEvt")){graphicLayer.handleClickEvt();}},true);},_preContextMenuClickHandler:function _preContextMenuClickHandler(){this.forEachGraphicLayer(function(graphicLayer){if($MUTIL.checkHasFunction(graphicLayer,"handleContextMenuClickEvt")){graphicLayer.handleContextMenuClickEvt();}},true);}});}());