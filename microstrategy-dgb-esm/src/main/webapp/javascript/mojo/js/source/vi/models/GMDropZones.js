(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.hash","mstrmojo.func","mstrmojo.gm.GMEnums","mstrmojo.gm.GMUtility","mstrmojo.vi.viz.EnumDSSDropZones","mstrmojo.vi.util.ThresholdUtils","mstrmojo.vi.viz.EnumVisualizationTemplates");mstrmojo.requiresClsP("mstrmojo.vi.ui","SubtotalsWidget","DatasetUnitMenuUtils");mstrmojo.requiresClsP("mstrmojo.vi.models","DropZonesModel","EnumDragSources","_DropZoneCommon");mstrmojo.requiresDescs(101,122,144,190,1018,2453,2968,3582,7974,7975,7976,7978,7979,11099,11699,12143,12144,12145,12146,12147);var $MOJO=mstrmojo,$ARR=$MOJO.array,$HASH=$MOJO.hash,$FUNC=$MOJO.func,$GM=mstrmojo.gm,GMUTIL=$GM.GMUtility,DIRC=$GM.EnumABLDirection,ENUM_TARGET=mstrmojo.vi.models.DropZonesModel.ENUM_TARGET_POSITION,ENUM_DRAG_SOURCE=mstrmojo.vi.models.EnumDragSources,ENUM_DZID=mstrmojo.vi.viz.EnumDSSDropZones,$THRESHOLD_UTILS=mstrmojo.vi.util.ThresholdUtils,$DATASET_MENU_UTILS=mstrmojo.vi.ui.DatasetUnitMenuUtils,TARGET_MIDDLE=3,ENUM_XML_TAG=$GM.WidgetPropertyTag,$FEATURES=mstrmojo.vi.enums.EnumFeatures,$VIZ=$MOJO.vi.viz,$VIZ_STYLES=$VIZ.EnumVizStyles,NEW_GRAPH_MATRIX_STYLE=$VIZ_STYLES.NEW_GRAPH_MATRIX,MK_SHAPE=$GM.EnumShape,ROWS=ENUM_DZID.Rows,COLUMNS=ENUM_DZID.Columns,XAXIS=ENUM_DZID.XAxis,YAXIS=ENUM_DZID.YAxis,BREAKBY=ENUM_DZID.BreakBy,SLICEBY=ENUM_DZID.SliceBy,COLORBY=ENUM_DZID.ColorBy,SIZEBY=ENUM_DZID.SizeBy,TOOLTIP=ENUM_DZID.AdditionalMetrics,ANGLEBY=ENUM_DZID.Angle,METRIC_NAMES_VISIBLE_THRESH=1,$SAB=$GM.DualAxisSubAxisBit,METRIC_NAMES_ID="00000000000000000000000000000000",METRIC_NAMES_UNIT_TYPE=0,METRIC_NAMES_ITEM={n:"Metric Names",did:METRIC_NAMES_ID,t:METRIC_NAMES_UNIT_TYPE},DATASET_TYPE=3,INVALID_METRIC_IDX=-20;function isPrimaryZone(id){return(id===ROWS||id===COLUMNS||id===YAXIS||id===XAXIS||id===BREAKBY||id===SLICEBY);}function isAxisZone(zoneId){return zoneId===YAXIS||zoneId===XAXIS;}function deleteFromGroupInfo(groupInfo,metricDid){var copy=[];function isEmptyRow(pair){return !!(pair[0]===INVALID_METRIC_IDX&&pair[1]===INVALID_METRIC_IDX);}$ARR.forEach(groupInfo,function(pair){if(pair[0]===metricDid){pair[0]=INVALID_METRIC_IDX;}if(pair[1]===metricDid){pair[1]=INVALID_METRIC_IDX;}if(!isEmptyRow(pair)){copy.push(pair);}});return copy;}function simplyInsertMetricToGroupInfo(groupInfo,metricDid,isPrimary){var insertionDone=false,newPair=[INVALID_METRIC_IDX,INVALID_METRIC_IDX],idx=isPrimary?0:1;$ARR.forEach(groupInfo,function(pair){if(!insertionDone&&pair[idx]===INVALID_METRIC_IDX){insertionDone=true;pair[idx]=metricDid;}});if(insertionDone){return groupInfo;}newPair[idx]=metricDid;groupInfo.push(newPair);return groupInfo;}function insertMetricToGroupInfoWhenDnd(context,groupInfo,metricDid,isPrimary){var tgtData=context.tgtData,edge=tgtData.edge,tgtInfo=tgtData&&tgtData.tgtInfo,axisIndex=tgtInfo&&(parseInt(tgtInfo.axisIndex,10)+(edge===ENUM_TARGET.BELOW?1:0)),axis=isPrimary?0:1,willNewGroupRow=edge===ENUM_TARGET.ABOVE||edge===ENUM_TARGET.BELOW,firstPart,secondPart,newGroup,pair,i,j;for(i=0;i<groupInfo.length;i++){pair=groupInfo[i];for(j=0;j<pair.length;j++){if(pair[j]===metricDid){if(pair[1-j]===INVALID_METRIC_IDX&&(axisIndex!==i||willNewGroupRow)){groupInfo.splice(i,1);if(i<axisIndex){axisIndex--;}}else{pair[j]=INVALID_METRIC_IDX;}}}}if(axisIndex>groupInfo.length){axisIndex=groupInfo.length;}if(edge===TARGET_MIDDLE&&axisIndex<groupInfo.length&&groupInfo[axisIndex][axis]===INVALID_METRIC_IDX){groupInfo[axisIndex][axis]=metricDid;}else{if(edge===ENUM_TARGET.ON){groupInfo[axisIndex][axis]=metricDid;}else{firstPart=groupInfo.slice(0,axisIndex);secondPart=groupInfo.slice(axisIndex);newGroup=[INVALID_METRIC_IDX,INVALID_METRIC_IDX];newGroup[axis]=metricDid;groupInfo=firstPart.concat([newGroup],secondPart);}}return groupInfo;}mstrmojo.vi.models.XtabDropZonesMenuContextType=null;function getHost(){return mstrmojo.all[this.hostId];}function getHostStructure(){var visGM=getHost.call(this);return visGM.getHostStructure();}function _getXtabCallback(gm){return $FUNC.wrapMethods(gm.controller._getXtabCallback(gm),{success:function(){gm.resetXMLDirtyFlag();}});}function swapRowsAndCols(){var xtab=getHost.call(this),zoneRows=this.getZoneModelByZoneId(ROWS),zoneCols=this.getZoneModelByZoneId(COLUMNS),zoneY=this.getZoneModelByZoneId(YAXIS),zoneX=this.getZoneModelByZoneId(XAXIS),actions=[],chtInfo=xtab.GMController.getChartInfo(),updateTrendLineAction=[],updateRefLineActions=[],isNGM=xtab.getChartStyle()==="NewGraphMatrixVisualizationStyle";if(chtInfo.isBubbleOrScatter){updateTrendLineAction=xtab.copyTrendLineInfoForSwap(zoneY,zoneX);}if(chtInfo.isABL){updateRefLineActions=xtab.copyRefLineInfoForSwap();}actions=actions.concat(this.getSwapDZUnitActions(zoneRows,zoneCols,isNGM));actions=actions.concat(this.getSwapDZUnitActions(zoneY,zoneX,isNGM));var dataService=this.docModel.getDataService(),nodeKey=xtab.k,callbacks=_getXtabCallback(xtab),executeActions=[dataService.getUpdateTemplateAction(nodeKey,actions)].concat(updateTrendLineAction).concat(updateRefLineActions);if(xtab.isXMLDirty()){executeActions.push(xtab.getPersistAction());}xtab.controller.submitUndoRedoUpdates(executeActions,null,callbacks);}function clearAttributesInDropZone(zoneId,isDisableOnly){var zone,me=this,removeActions=[],removedItems=[];zone=this.getZoneModelByZoneId(zoneId);$ARR.forEach(zone.items,function(item){if(item.t===12){removedItems.push(item);Array.prototype.push.apply(removeActions,me.getRemoveDropZoneUnitActions(zone,item,isDisableOnly));}});return{actions:removeActions,removedItems:removedItems};}function appendItemsToDropZone(zoneId,unitItems){var addActions=[],me=this,zone=this.getZoneModelByZoneId(zoneId),availableIndex=this.getItemCountInZone(zoneId);$ARR.forEach(unitItems,function(item){addActions.push(me.getAddDropZoneUnitAction(zone,item,availableIndex++));});return{actions:addActions};}function keepColorByItems(zoneId,delItems){var addActions=[],me=this,zone=this.getZoneModelByZoneId(zoneId),items=zone.items;$ARR.forEach(delItems,function(item){var idx=$ARR.find(items,"did",item.did);if(idx!==-1&&isPrimaryZone(item.zone)){addActions.push(me.getAddDropZoneUnitAction(zone,item,idx));}});return{actions:addActions};}function shouldShowCondensedMenu(zone,item){var zId=zone.id;if((zId===XAXIS||zId===YAXIS)&&this.isMetric(item)){return true;}return false;}function getCondenseLableHandler(zone,itemContext,condenseOn){var condense="0",item=itemContext.item,zoneIndex=itemContext.idx;if(condenseOn){condense="1";}return function(){var action=this.getAddDropZoneUnitAction(zone,item,zoneIndex,{isPrimary:item.ax===0});action.condense=condense;var widget=getHost.call(this),hostId=widget.id,dataService=widget.getDocModel().getDataService(),nodeKey=widget.k,executeActions=dataService.getUpdateTemplateAction(nodeKey,action);var updateCdsLabel=function(value){var host=$MOJO.all[hostId],data=host.model.data,dz=data.dz,zones=[dz.AngleBy,dz.Rows,dz.YAxis,dz.Columns,dz.XAxis,dz.ColorBy,dz.SizeBy,dz.AdditionalMetrics],callback=host.parent.getZonesModel&&host.parent.getZonesModel().getUpdateCallback();$ARR.forEach(zones,function(zone){if(zone&&zone.TemplateMetric){$ARR.forEach(zone.TemplateMetric,function(metric){if(metric.id===item.id){metric.cds=value;return false;}});}});host.clientRerenderGraphMatrix();if(callback&&callback.success){callback.success();}};var undoRedoCallback={undo:function(){updateCdsLabel(!condenseOn);},redo:function(){updateCdsLabel(condenseOn);}};updateCdsLabel(condenseOn);widget.submitUpdatesAndPersistXML([executeActions],undefined,undoRedoCallback,true);};}mstrmojo.vi.models.GMDropZones=mstrmojo.declare(mstrmojo.vi.models.DropZonesModel,[mstrmojo.vi.models._DropZoneCommon],{scriptClass:"mstrmojo.vi.models.GMDropZones",dropZones:[],getHostStructure:function getHostStructure(){var visGM=getHost.call(this);return visGM.getHostStructure();},isZonesEmptyAfterDelItem:function isZonesEmptyAfterDelItem(item){var unitCount={},struct=this.getHostStructure(),zoneId=item.zone;unitCount[ROWS]=struct.Rows.length;unitCount[COLUMNS]=struct.Columns.length;unitCount[XAXIS]=struct.XAxis.length;unitCount[YAXIS]=struct.YAxis.length;unitCount[SIZEBY]=struct.SizeBy.length;unitCount[BREAKBY]=struct.BreakBy.length;unitCount[ANGLEBY]=struct.AngleBy.length;unitCount[TOOLTIP]=this.getItemCountInZone(TOOLTIP);unitCount[zoneId]--;if(unitCount[ROWS]>0||unitCount[COLUMNS]>0||unitCount[XAXIS]>0||unitCount[YAXIS]>0||unitCount[SIZEBY]>0||unitCount[ANGLEBY]>0||unitCount[TOOLTIP]>0){return false;}return true;},getAutoSubtypeControl:function(disabled){var twoColCtr,checkBox,label,col1Width,col2Width;var SB_TYPE=mstrmojo.gm.EnumSubtype,subTypePropName=mstrmojo.gm.WidgetPropertyTag.SUB_TYPE,visGM=getHost.call(this),resultantSubtype=visGM.GMController.chartSubType,currentSubType=visGM.readGlobalProperty(subTypePropName);checkBox={scriptClass:"mstrmojo.ui.Checkbox",enabled:!disabled,alias:"AutoSubType",checked:currentSubType===SB_TYPE.AUTO,oncheckedChange:function(evt){if(evt.value){visGM.writeGlobalProperty(subTypePropName,SB_TYPE.AUTO);}else{visGM.writeGlobalProperty(subTypePropName,resultantSubtype);}}};label={scriptClass:"mstrmojo.Label",text:mstrmojo.desc(12135,"Automatic subtype"),setDimensions:function(h,w){var domNode=this.domNode;if(domNode){domNode.style.width=w;}}};checkBox.slot="col1Node";label.slot="col2Node";twoColCtr={scriptClass:"mstrmojo.ui.editors.controls.TwoColumnContainer",col1Width:col1Width||"20%",col2Width:col2Width||"80%",children:[checkBox,label]};return twoColCtr;},getSubtypeButtonBar:function getSubtypeButtonBar(n,src,disabled){var RVS_MAP_SUBTYPE=[null,{id:12143,desc:"Automatic",css:"automatic"},{id:12144,desc:"Absolute",css:"clustered"},{id:12145,desc:"Stacked",css:"stacked"},{id:12146,desc:"Clustered",css:"clustered"},{id:12147,desc:"Percent",css:"percent"}],SB_TYPE=mstrmojo.gm.EnumSubtype,subTypePropName=mstrmojo.gm.WidgetPropertyTag.SUB_TYPE,visGM=getHost.call(this),currentSubType=visGM.GMController.chartSubType,chtInfo=visGM.getChartInfo();function getItemsForShape(info){var items=[],sbTypes;if(info.shape===MK_SHAPE.BAR){sbTypes=[SB_TYPE.CLUSTERED,SB_TYPE.STACKED,SB_TYPE.PERCENT];}else{sbTypes=[SB_TYPE.ABSOLUTE,SB_TYPE.STACKED,SB_TYPE.PERCENT];}if(!info.isCombo){sbTypes.forEach(function(sbTp){var sbTpInfo=RVS_MAP_SUBTYPE[sbTp];items.push({n:sbTpInfo?mstrmojo.desc(sbTpInfo.id,sbTpInfo.desc):null,id:sbTp,css:sbTpInfo?sbTpInfo.css:null});});}else{sbTypes.forEach(function(sbTp){var sbTpInfo=RVS_MAP_SUBTYPE[sbTp],sbtTpAbsInfo=RVS_MAP_SUBTYPE[SB_TYPE.ABSOLUTE];items.push({n:(sbTp===SB_TYPE.CLUSTERED)?mstrmojo.desc(sbtTpAbsInfo.id,sbtTpAbsInfo.desc):(sbTpInfo?mstrmojo.desc(sbTpInfo.id,sbTpInfo.desc):null),id:sbTp,css:sbTpInfo?sbTpInfo.css:null});});}return items;}function getSelectedIndex(items){var selectedIndex=-1,idx=0;items.forEach(function(it){if(it.id===currentSubType){selectedIndex=idx;}idx++;});return selectedIndex;}function fnChange(subType,fromSubType){if(fromSubType!==subType&&(fromSubType===SB_TYPE.PERCENT||subType===SB_TYPE.PERCENT)){visGM.abandonCustomAxisScale();visGM.resetAxisOrigin();}visGM.writeGlobalProperty(subTypePropName,subType);}var conf={scriptClass:"mstrmojo.ui.ButtonBar",cssClass:"mstrmojo-chart-brkby-subtype",n:"Subtype",selectedIndex:-1,enabled:!disabled,showIcon:true,alias:"SubtypeBB",useRichTooltip:true,updateTooltipConfig:function updateTooltipConfig(evt){var $DOM=mstrmojo.dom,target=evt.target||$DOM.eventTarget(evt.hWin,evt.e),item=this.getItemFromTarget(target),itemNode=this.getItemNodeFromTarget(target),position=$DOM.position(itemNode),arrowH=8;if(item){this.richTooltip={posType:mstrmojo.tooltip.POS_TOPCENTER,content:item.n,top:position.y+position.h+arrowH,left:position.x+position.w/2,cssClass:"vi-regular vi-tooltip-A A-center"};}},postselectionChange:function(evt){fnChange(evt.src.items[evt.added[0]].id,evt.src.items[evt.removed[0]].id);}};conf.items=getItemsForShape(chtInfo);conf.selectedIndex=getSelectedIndex(conf.items,currentSubType);return conf;},getDropZones:function(){var xtabStructure=getHostStructure.call(this),visGM=getHost.call(this),gmCtr=visGM.GMController,isPie=gmCtr.isPie,isHistogram=gmCtr.isHistogram,isBoxPlot=gmCtr.isBoxPlot,isWaterfall=gmCtr.isWaterfall,dropZones=[this.getZone(mstrmojo.desc(14294,"Angle"),ANGLEBY,xtabStructure.AngleBy),this.getZone(mstrmojo.desc(6188,"Slice"),SLICEBY,xtabStructure.SliceBy),this.getZone(mstrmojo.desc(2968,"Rows"),ROWS,xtabStructure.Rows),this.getZone(mstrmojo.desc(122,"Columns"),COLUMNS,xtabStructure.Columns),this.getZone(mstrmojo.desc(12086,"XAxis"),XAXIS,xtabStructure.XAxis),this.getZone(mstrmojo.desc(12088,"YAxis"),YAXIS,xtabStructure.YAxis),this.getZone(mstrmojo.desc(11662,"Color By"),COLORBY,xtabStructure.ColorBy)];var breakByZone=this.getZone(mstrmojo.desc(12173,"Break By"),BREAKBY,xtabStructure.BreakBy);if(visGM.getChartInfo().isABL&&breakByZone.items.length>0&&!(visGM.getChartStyle()===NEW_GRAPH_MATRIX_STYLE)){breakByZone.siblings=[this.getSubtypeButtonBar("Subtype",[],false)];}dropZones.push(breakByZone);dropZones.push(this.getZone(mstrmojo.desc(12090,"Size By"),SIZEBY,xtabStructure.SizeBy));dropZones.push(this.getZone(mstrmojo.desc(2962,"Tooltip"),TOOLTIP,xtabStructure.AdditionalMetrics));if(!isPie){dropZones=dropZones.slice(2);}else{dropZones.splice(1,0,dropZones.splice(6,1)[0]);}if(isHistogram){dropZones=[this.getZone(mstrmojo.desc(517,"Metric"),YAXIS,xtabStructure.YAxis),this.getZone(mstrmojo.desc(11806,"Aggregate By"),XAXIS,xtabStructure.XAxis),this.getZone(mstrmojo.desc(2962,"Tooltip"),TOOLTIP,xtabStructure.AdditionalMetrics)];}else{if(isBoxPlot){dropZones=[this.getZone(mstrmojo.desc(2968,"Rows"),ROWS,xtabStructure.Rows),this.getZone(mstrmojo.desc(122,"Columns"),COLUMNS,xtabStructure.Columns),this.getZone(mstrmojo.desc(12086,"XAxis"),XAXIS,xtabStructure.XAxis),this.getZone(mstrmojo.desc(12088,"YAxis"),YAXIS,xtabStructure.YAxis),breakByZone,this.getZone(mstrmojo.desc(11662,"Color By"),COLORBY,xtabStructure.ColorBy),this.getZone(mstrmojo.desc(2962,"Tooltip"),TOOLTIP,xtabStructure.AdditionalMetrics)];}else{if(isWaterfall){dropZones=[this.getZone(mstrmojo.desc(2968,"Rows"),ROWS,xtabStructure.Rows),this.getZone(mstrmojo.desc(122,"Columns"),COLUMNS,xtabStructure.Columns),this.getZone(mstrmojo.desc(12086,"XAxis"),XAXIS,xtabStructure.XAxis),this.getZone(mstrmojo.desc(12088,"YAxis"),YAXIS,xtabStructure.YAxis),breakByZone,this.getZone(mstrmojo.desc(2962,"Tooltip"),TOOLTIP,xtabStructure.AdditionalMetrics)];}}}this.dropZones=dropZones;return{n:getHost.call(this).defn.ttl,zones:dropZones};},updateMetricNameUnit:function(){var i,index,zone,xtab=getHost.call(this),fakedItem=$HASH.clone(METRIC_NAMES_ITEM),show=this.shouldShowMetricNames(),occurences=this.hGetItemOccurrence(fakedItem),nFound=occurences.length,actions=[];if(show&&nFound===0){zone=this.getZoneModelByZoneId(ROWS);fakedItem.zone=ROWS;actions.push(this.getAddDropZoneUnitAction(zone,fakedItem,zone.items.length));zone.items.push(fakedItem);}if(!show&&nFound>0){for(i=0;i<nFound;i++){zone=this.getZoneModelByZoneId(occurences[i].zoneId);index=occurences[i].itemIndex;actions=actions.concat(this.getRemoveDropZoneUnitActions(zone,zone.items[index]));zone.items.splice(index,1);}}if(actions.length>0){this.submitUpdatesAndPersistWidgetXMLIfNecessary(xtab,actions,mstrmojo.emptyFn);}},shouldShowMetricNames:function(){var me=this;if(me.getMetricCntInZone(XAXIS)>METRIC_NAMES_VISIBLE_THRESH){return true;}if(me.getMetricCntInZone(YAXIS)>METRIC_NAMES_VISIBLE_THRESH){return true;}var angByEnabled=me.getZoneModelByZoneId(ANGLEBY)!==undefined;if(angByEnabled&&me.getMetricCntInZone(ANGLEBY)>METRIC_NAMES_VISIBLE_THRESH){return true;}return false;},hHasMetricInZone:function(zoneId){var i,flag=false,items=this.getZoneModelByZoneId(zoneId).items,n=items.length;for(i=0;i<n;i++){if(items[i].t===4){flag=true;break;}}return flag;},hHasAttributeInZone:function(zoneId){var i,flag=false,items=this.getZoneModelByZoneId(zoneId).items,n=items.length;for(i=0;i<n;i++){if(items[i].t===12){flag=true;break;}}return flag;},getAttributesZone:function(){var zoneId=XAXIS;if(this.hHasMetricInZone(XAXIS)){zoneId=YAXIS;}return zoneId;},canSwapAxis:function canSwapAxis(){return true;},swapAxis:function swapAxis(){var host=getHost.call(this);host.clearChartScale();host.clearContainerFit();swapRowsAndCols.call(this);},shouldShowCondensedMenu:function(zone,item){return shouldShowCondensedMenu.call(this,zone,item);},getCondenseLableHandler:function(zone,itemContext,condenseOn){return getCondenseLableHandler(zone,itemContext,condenseOn);},getUnitMenuItems:function getUnitMenuItems(cfg,zone,item,el){if(!item){throw new Error(this.scriptClass+"::getUnitMenuItems: Item must be provided.");}var me=this,id=mstrmojo.all[this.hostId].zonesModel.id,xtabHost=getHost.call(this),visGM=xtabHost,gmCtr=xtabHost.GMController,chtInfo=gmCtr.getChartInfo(),items=zone.items,cnt=items.length,axis=zone.id,itemContext={zone:zone,axis:axis,idx:$ARR.find(items,"id",item.id),cnt:cnt,item:item,metricsAxis:getHostStructure.call(this).tma,useDropzone:true},selInfo;function addAdvancedSortOption(cfg,itemContext){if(itemContext.axis===ROWS||itemContext.axis===COLUMNS){}}if(this.isMetricName(item)){if(zone.id===COLORBY){cfg.addMenuItem(mstrmojo.desc(190,"Remove"),"xt",function(){mstrmojo.all[id].deleteItem(zone,itemContext.idx);});return ;}return ;}var attributeCPPool=gmCtr.attributeSelectionInfo;if(this.isNewDerivedElement(item)){if(!mstrApp.isInVFConfigMode){cfg.addMenuItem(mstrmojo.desc(13296,"Edit Groups..."),"eg",this.getCreateOrEditElementGroupFunc(itemContext));}if((axis===ROWS||axis===COLUMNS||axis===XAXIS||axis===YAXIS)&&visGM.getChartStyle()!=="NewGraphMatrixVisualizationStyle"){cfg.addSeparator();selInfo=attributeCPPool&&attributeCPPool[item.id];cfg.addMenuItem(mstrmojo.desc(7974,"Sort Ascending"),"xt",xtabHost.getMenuHandler("sortAttributeTitle"),{isAsc:true,selInfo:selInfo});cfg.addMenuItem(mstrmojo.desc(7975,"Sort Descending"),"xt",xtabHost.getMenuHandler("sortAttributeTitle"),{isAsc:false,selInfo:selInfo});if(gmCtr.firstRes.gsi.sorts[0].length!==0||gmCtr.firstRes.gsi.sorts[1].length!==0){cfg.addMenuItem(mstrmojo.desc(11699,"Clear Sort"),"xt",xtabHost.getMenuHandler("clearSort"));}cfg.addSeparator();}}else{if(this.isConsolidation(item)){if(axis===ROWS||axis===COLUMNS||axis===XAXIS||axis===YAXIS){cfg.addSeparator();selInfo=attributeCPPool&&attributeCPPool[item.id];cfg.addMenuItem(mstrmojo.desc(7974,"Sort Ascending"),"xt",xtabHost.getMenuHandler("sortAttributeTitle"),{isAsc:true,selInfo:selInfo});cfg.addMenuItem(mstrmojo.desc(7975,"Sort Descending"),"xt",xtabHost.getMenuHandler("sortAttributeTitle"),{isAsc:false,selInfo:selInfo});if(gmCtr.firstRes.gsi.sorts[0].length!==0||gmCtr.firstRes.gsi.sorts[1].length!==0){cfg.addMenuItem(mstrmojo.desc(11699,"Clear Sort"),"xt",xtabHost.getMenuHandler("clearSort"));}cfg.addSeparator();}}else{if(this.isMetric(item)){if(item.um&&!mstrApp.isInVFConfigMode){cfg.addMenuItem(mstrmojo.desc(3224,"Edit..."),"",function(){me.editDerivedMetric(itemContext,"edit");},itemContext);cfg.addSeparator();}if(gmCtr.supportSort()&&chtInfo.isABL&&(axis===YAXIS||axis===XAXIS)&&visGM.getChartStyle()!=="NewGraphMatrixVisualizationStyle"&&!visGM.excludeData){var metricCHPool=gmCtr.metricSelectionInfo;selInfo=metricCHPool&&metricCHPool[item.id];cfg.addMenuItem(mstrmojo.desc(7974,"Sort Ascending"),"xt",xtabHost.getMenuHandler("sortMetricTitle"),{isAsc:true,selInfo:selInfo});cfg.addMenuItem(mstrmojo.desc(7975,"Sort Descending"),"xt",xtabHost.getMenuHandler("sortMetricTitle"),{isAsc:false,selInfo:selInfo});addAdvancedSortOption(cfg,itemContext);if(gmCtr.firstRes.gsi.sorts[1].length!==0||gmCtr.firstRes.gsi.sorts[0].length!==0){cfg.addMenuItem(mstrmojo.desc(11699,"Clear Sort"),"xt",xtabHost.getMenuHandler("clearSort"));}}cfg.addSeparator();if(!mstrApp.isInVFConfigMode&&mstrmojo.resolveFeature($FEATURES.INSERT_NEW_METRIC)){if(this.docModel.findDatasetIdFromUnit(item.did)&&!this.docModel.isFromSolrCube(item.did)&&!this.docModel.isFromMDXCube(item.did)){cfg.addSubMenuItem(mstrmojo.desc(11806,"Aggregate By"),"",id,me.getAggregateByMetricSubMenu,itemContext);cfg.addSeparator();}cfg.addEditorMenuItem(mstrmojo.desc(5188,"Calculation"),id,me.getCalculationEditorCfg,itemContext);if(gmCtr.getChartInfo().isABL){cfg.addSubMenuItem(mstrmojo.desc(12287,"Shortcut Metric"),"",id,me.getShortcutMetricSubMenu,itemContext);}cfg.addMenuItem(mstrmojo.desc(13624,"Create Metric..."),"",function(){me.newDerivedMetric(itemContext);},itemContext);cfg.addSeparator();}if(shouldShowCondensedMenu.call(this,zone,item)&&visGM.getChartStyle()!=="NewGraphMatrixVisualizationStyle"){var isOn=item.cds;var fnOn=getCondenseLableHandler.call(this,zone,itemContext,true),fnOff=getCondenseLableHandler.call(this,zone,itemContext,false);cfg.addToggleMenuItem(mstrmojo.desc(14324,"Condense Axis Labels"),"",fnOn,fnOff,this.id,isOn);}if(mstrApp&&mstrApp.supportFeature&&mstrApp.supportFeature($FEATURES.NUMBER_FORMATTING)){cfg.addEditorMenuItem(mstrmojo.desc(13237,"Number Format"),id,this.getNumberFormatEditorCfg,itemContext);}if(zone.id===COLORBY){this.buildThresholdMenuOptions(cfg,itemContext,true);}cfg.addSeparator();if(chtInfo.isABL&&(zone.id===XAXIS||zone.id===YAXIS)&&!chtInfo.isPie&&visGM.getChartStyle()!=="NewGraphMatrixVisualizationStyle"){GMUTIL.getSubMenu(visGM,cfg,item.id,item.idx);}cfg.addSeparator();if((axis===XAXIS||axis===YAXIS)&&visGM.getChartStyle()!=="NewGraphMatrixVisualizationStyle"){if((chtInfo.isBubbleOrScatter&&axis===YAXIS)||chtInfo.isABL){if(GMUTIL.isTrendLineAvailableForMetric(xtabHost,item.idx)){cfg.addToggleMenuItem(mstrmojo.desc(12155,"Enable trendline for ##").replace("##",item.n),"xt",GMUTIL.getTrendLineToggleHandler(xtabHost,item.id,true),GMUTIL.getTrendLineToggleHandler(xtabHost,item.id,false),id,GMUTIL.getTrendLineToggleState(xtabHost,item.id));if(GMUTIL.getTrendLineToggleState(xtabHost,item.id)){cfg.addMenuItem(mstrmojo.desc(12163,"Edit trendline..."),"xt",GMUTIL.getEditTrendLineHandler(xtabHost,item.id));}}}}var metricIdxOnAxis=gmCtr.getMetricsOnXAxis().concat(gmCtr.getMetricsOnYAxis()),metricIdsOnAxis=gmCtr.model&&gmCtr.model.getMetricIDsFromIndex(metricIdxOnAxis),isAxisMetric=false;if(item.id){if(metricIdsOnAxis&&metricIdsOnAxis.indexOf(item.id)>=0){isAxisMetric=true;}}var skipRef=false;if(gmCtr.isStacked&&!gmCtr.splitPlottingMetrics){skipRef=true;}else{if(!isAxisMetric){skipRef=true;}}skipRef=skipRef||GMUTIL.isIgnoredMetric(visGM,item.idx);if(!skipRef){GMUTIL.getReferenceLineSubMenu(visGM,cfg,chtInfo.isABL,item.id);}cfg.addSeparator();}else{if(this.isAttrCategory(item)){var attrId=item.did||"",dataset=attrId?$DATASET_MENU_UTILS.getDatasetFromAttributeId(this.docModel.datasets,attrId):null,notMDXDataset=!dataset||!this.docModel.isMDXDataset(dataset);if(item.da&&notMDXDataset&&!mstrApp.isInVFConfigMode){cfg.addMenuItem(mstrmojo.desc(3224,"Edit..."),"",function(){me.editDerivedAttribute(itemContext);},itemContext);cfg.addSeparator();}if((axis===ROWS||axis===COLUMNS||axis===XAXIS||axis===YAXIS)&&visGM.getChartStyle()!=="NewGraphMatrixVisualizationStyle"){selInfo=attributeCPPool&&attributeCPPool[item.id];cfg.addMenuItem(mstrmojo.desc(7974,"Sort Ascending"),"xt",xtabHost.getMenuHandler("sortAttributeTitle"),{isAsc:true,selInfo:selInfo});cfg.addMenuItem(mstrmojo.desc(7975,"Sort Descending"),"xt",xtabHost.getMenuHandler("sortAttributeTitle"),{isAsc:false,selInfo:selInfo});addAdvancedSortOption(cfg,itemContext);if(gmCtr.firstRes.gsi.sorts[0].length!==0||gmCtr.firstRes.gsi.sorts[1].length!==0){cfg.addMenuItem(mstrmojo.desc(11699,"Clear Sort"),"xt",xtabHost.getMenuHandler("clearSort"));}cfg.addSeparator();}if(!mstrApp.isInVFConfigMode&&!this.isDynamicLink(item)){if(this.allowInsertNewAttribute(zone)&&((!dataset)||!$DATASET_MENU_UTILS.isCGorCon(item,dataset))&&notMDXDataset&&mstrmojo.resolveFeature($FEATURES.INSERT_NEW_METRIC)){cfg.addMenuItem(mstrmojo.desc(13625,"Create Attribute..."),"",function(){me.newDerivedAttribute(itemContext);},itemContext);}if(!$DATASET_MENU_UTILS.hasOldDEOverDatasets(item.did,this.docModel.datasets)&&!this.isRecursiveAttribute(item)&&!this.isCustomGroup(item)){cfg.addMenuItem(mstrmojo.desc(13295,"Create Groups..."),"eg",this.getCreateOrEditElementGroupFunc(itemContext));}cfg.addSeparator();}if(this.showNumberFormat(item)&&!(gmCtr.isHistogram||gmCtr.isBoxPlot||gmCtr.isWaterfall)){cfg.addEditorMenuItem(mstrmojo.desc(13237,"Number Format"),id,this.getNumberFormatEditorCfg,itemContext);}if(this.shouldShowDisplayFormsMenu(item)&&!gmCtr.isHistogram){cfg.addEditorMenuItem(mstrmojo.desc(11908,"Display Attribute Forms"),id,function(){return me.getDisplayFormsMenu(item);});}}}}}cfg.addSeparator();if(me.hasReplaceCandidates(itemContext)&&(!(mstrApp.isAppStatePresentation&&mstrApp.isAppStatePresentation())||!!mstrmojo.resolveFeature($FEATURES.WEB_DRILL_AND_LINK))){cfg.addSubMenuItem(mstrmojo.desc(14003,"Replace with"),"",id,me.getReplaceSubMenu,itemContext);}cfg.addMenuItem(mstrmojo.desc(1388,"Rename"),"xt",function(){me.renameItem(el,item);});cfg.addMenuItem(mstrmojo.desc(190,"Remove"),"xt",function(){me.deleteItem(zone,itemContext.idx);});},isGraphDroppingAllowed:function isGraphDroppingAllowed(zone,src,item){var zoneId=zone.id,flag=true,GMC=getHost.call(this).GMController,isBubbleOrScatter=GMC.isBubbleOrScatter();var isDnDMetric=this.isMetric(item),isDnDMetricName=this.isMetricName(item);switch(zoneId){case ROWS:case COLUMNS:if(isDnDMetric){flag=false;}break;case XAXIS:case YAXIS:if(!isBubbleOrScatter&&isDnDMetricName&&this.hHasMetricInZone(zoneId)){flag=false;}break;default:break;}return flag;},allowDropOnTarget:function allowDrop(targetId,info){var result=true;if(targetId===ENUM_DRAG_SOURCE.DATASETS&&this.isMetricName(info.item)){result&=(info.srcZoneId===COLORBY);}return result;},allowMoveMetricName:function allowMoveMetricName(zoneId,dropZoneId){if(this.isDualAxis(YAXIS)&&zoneId===COLUMNS&&dropZoneId===XAXIS){return false;}else{if(this.isDualAxis(XAXIS)&&zoneId===ROWS&&dropZoneId===YAXIS){return false;}}return true;},isItemDropAllowed:function isItemDropAllowed(zone,dropItem,idx,context,edge){var src;if(context&&context.src){src=context.src.data.src;}var targetItem,zoneId=zone.id,nItems=this.getItemCountInZone(zoneId),isNGM=getHost.call(this).scriptClass==="mstrmojo.ngm.VisNewGraphMatrix",GMC=getHost.call(this).GMController,isABL=GMC.getChartInfo().isABL,isHistogram=GMC.isHistogram,isBoxPlot=GMC.isBoxPlot,isWaterfall=GMC.isWaterfall,isBubbleOrScatter=GMC.isBubbleOrScatter(),isGrid=GMC.isGrid()&&!GMC.isEmptyVis(),isDnDMetric=this.isMetric(dropItem),isDnDAttribute=this.isAttrCategory(dropItem),isDnDMetricName=this.isMetricName(dropItem);if(edge===ENUM_TARGET.BELOW||edge===TARGET_MIDDLE){edge=ENUM_TARGET.ABOVE;idx++;}if(edge===ENUM_TARGET.ON){targetItem=zone.items[idx];if(this.isMetricName(targetItem)&&zone.id!==COLORBY){return false;}}if(dropItem===zone.items[idx]){return false;}switch(zoneId){case ROWS:case COLUMNS:if(isDnDMetric){return false;}if(isDnDMetricName&&(idx<nItems||!this.allowMoveMetricName(zone.id,dropItem.zone))){return false;}break;case XAXIS:case YAXIS:if(isHistogram){if((this.isAttrCategory(dropItem)&&zoneId===XAXIS)||(zoneId===YAXIS&&this.isMetric(dropItem)&&(nItems===0||edge===ENUM_TARGET.ON))){return true;}return false;}else{if(isWaterfall||isBoxPlot){var zoneCheck=zoneId===XAXIS?YAXIS:XAXIS;if(this.isMetric(dropItem)&&this.hHasMetricInZone(zoneCheck)&&(this.getUnitIndexInZone(this.getZoneModelByZoneId(zoneCheck),dropItem)===-1||this.getZoneModelByZoneId(zoneCheck).items.length>1)){return false;}if(this.isAttribute(dropItem)&&this.hHasAttributeInZone(zoneCheck)&&(this.getUnitIndexInZone(this.getZoneModelByZoneId(zoneCheck),dropItem)===-1||this.getZoneModelByZoneId(zoneCheck).items.length>1)){return false;}}else{if(!isDnDMetricName&&isABL&&edge!==ENUM_TARGET.ON){return true;}}}if(isDnDMetricName){if(isBubbleOrScatter||isABL){return false;}else{if(this.hHasMetricInZone(zoneId)||edge===ENUM_TARGET.ON){return false;}}}break;case SIZEBY:if(isDnDAttribute||isDnDMetricName){return false;}if(isDnDMetric){if(nItems>0&&!isBubbleOrScatter&&edge!==ENUM_TARGET.ON){if(this.getUnitIndexInZone(zone,dropItem)===-1){return false;}}}break;case BREAKBY:if(isGrid||isDnDMetric){return false;}break;case COLORBY:if(isBoxPlot){if(this.isMetric(dropItem)){return false;}var occurrences=this.hGetItemOccurrence(dropItem,[BREAKBY]);if(occurrences.length){return false;}}if(isDnDMetric){if(nItems>0&&edge!==ENUM_TARGET.ON){return false;}}else{if(isDnDAttribute){if(nItems>0&&this.isMetric(zone.items[0])&&edge!==ENUM_TARGET.ON){return false;}}}break;case SLICEBY:if(isDnDMetric){return false;}break;case ANGLEBY:if(isDnDMetric){return true;}else{return false;}break;case TOOLTIP:var numMetrics=this.getMetricCntInZone(zoneId),numAttributes=nItems-numMetrics;if(isDnDMetricName){return false;}if(isDnDAttribute){if(!isNGM){return false;}occurrences=this.hGetItemOccurrence(dropItem);if(occurrences.length<=0){return false;}if(numMetrics>0){if(numAttributes===0){if(idx!==0||edge!==0){return false;}}else{if(idx===numAttributes&&edge!==0||idx>numAttributes-1&&idx!==numAttributes){return false;}}}}if(isDnDMetric){if(numAttributes>0&&idx<numAttributes){return false;}}break;default:break;}return true;},changeToDualAxis:function changeTODualAxis(zone){var primaryCnt=0,secondaryCnt=0;$ARR.forEach(zone.items,function(item){if(item.ax===0){primaryCnt++;}else{if(item.ax===1){secondaryCnt++;}}});return primaryCnt>0&&secondaryCnt>0;},getActionsOnUnitDropped:function(item,zone,context,idx,edge,isPrimary,splitMetric,pivotMetricNameToRowColumn){var me=this,i,n,occurrences,showMetricName=false,breakByZone=me.getZoneModelByZoneId(BREAKBY),tooltipZone=me.getZoneModelByZoneId(TOOLTIP),xtab=getHost.call(me),gmCtr=xtab.GMController,isNGM=xtab.getChartStyle()==="NewGraphMatrixVisualizationStyle",chtInfo=gmCtr.getChartInfo(),itemIdx=me.getUnitIndexInZone(zone,item),itemIdxInTooltip=me.getUnitIndexInZone(tooltipZone,item),zoneId=zone.id,zoneItems=zone.items,actions=[],flags={},unitCount={},angByEnabled,itemIsAttribute=me.isAttrCategory(item),itemIsMetricName=me.isMetricName(item),occurredZone,replacedItem,replacingSameItem,zoneIsColorBy,dragSrc=context.src.data.src,oldDualAxis=me.isDualAxis(zone.id),isDroppedMetricZone=me.isMetricZone(zoneId),fnHandleColorBySpecialRules=function(){if(zoneId===COLORBY){occurrences=me.hGetItemOccurrence(item,[ROWS,COLUMNS,XAXIS,YAXIS,BREAKBY,SLICEBY]);if(occurrences.length===0&&!me.isMetric(item)){var getTargetProperPosition=function(zone){var cz=me.getZoneModelByZoneId(COLORBY),fi,i;if(zone.id===SLICEBY||zone.id===BREAKBY){for(i=idx-1;i>=0;i--){fi=$ARR.find(zone.items,"did",cz.items[i].did);if(fi!==-1){return fi+1;}}}return 0;};var targetZoneId,targetZone,targetPos;if(gmCtr.isBoxPlot){targetZoneId=me.getAttributesZone();targetZone=me.getZoneModelByZoneId(targetZoneId);targetPos=targetZone.items.length;var moveZone=targetZoneId;moveZone=me.getZoneModelByZoneId(moveZone);$ARR.forEach(targetZone.items,function(item,i){actions.push(me.getAddDropZoneUnitAction(moveZone,item,targetPos-i));});}else{targetZoneId=chtInfo.isPie?SLICEBY:(gmCtr.isGrid()?XAXIS:BREAKBY);targetZone=me.getZoneModelByZoneId(targetZoneId);targetPos=getTargetProperPosition(targetZone);}actions.push(me.getAddDropZoneUnitAction(targetZone,item,targetPos));}}else{if((item.zone===COLORBY)&&isPrimaryZone(zoneId)){actions=actions.concat(me.getRemoveDropZoneUnitActions(me.getZoneModelByZoneId(COLORBY),item,1));}else{if(zoneId===BREAKBY&&chtInfo.tp===2&&gmCtr.view.chartInfo&&gmCtr.view.chartInfo.subtype===1){var cbZone=me.getZoneModelByZoneId(COLORBY),targetZone;if(!(cbZone.items.length&&cbZone.items[0].t===4)){targetZone=me.getZoneModelByZoneId(COLORBY);actions.push(me.getAddDropZoneUnitAction(targetZone,item));}}}}};isPrimary=(isPrimary===undefined?true:isPrimary);flags[XAXIS]=me.isMetricZone(XAXIS);flags[YAXIS]=me.isMetricZone(YAXIS);unitCount[XAXIS]=me.getMetricCntInZone(XAXIS);unitCount[YAXIS]=me.getMetricCntInZone(YAXIS);angByEnabled=me.getZoneModelByZoneId(ANGLEBY)!==undefined;if(angByEnabled){flags[ANGLEBY]=me.isMetricZone(ANGLEBY);unitCount[ANGLEBY]=me.getMetricCntInZone(ANGLEBY);}else{flags[ANGLEBY]=false;unitCount[ANGLEBY]=0;}if(zoneItems.length){if(zoneId===COLORBY&&edge!==ENUM_TARGET.ON&&(me.isMetric(item)||((me.isAttrCategory(item)||me.isMetricName(item))&&me.isOnlyMetricZone(zoneId)))){edge=ENUM_TARGET.ON;}if(isAxisZone(zoneId)&&this.differInType(item,zoneItems[0])){if(itemIsAttribute){flags[zoneId]=false;}if(this.isMetric(item)){flags[zoneId]=true;}unitCount[zoneId]=1;actions=actions.concat(this.getClearDZUnitActions(zone));if(isNGM){for(var i=0;i<zoneItems.length;i++){actions=actions.concat(me.removeFromTooltipDropZone(zoneItems[i],zoneId));}}idx=0;}else{if(edge===ENUM_TARGET.ON){replacedItem=zone.items.filter(function(item){return item.dzidx!==undefined?item.dzidx===idx:item.idx!==undefined?item.idx===idx:true;})[0];replacingSameItem=(item.did===replacedItem.did);zoneIsColorBy=(zoneId===COLORBY);if(me.getUnitIndexInZone(zone,item)!==-1&&replacedItem.did!==item.did){unitCount[zoneId]--;}if(me.isMetric(item)&&me.isMetric(replacedItem)){isPrimary=replacedItem.ax===0;}if(zoneIsColorBy&&((me.isAttrCategoryZone(COLORBY)&&me.isMetric(item))||(me.isMetricZone(COLORBY)&&itemIsAttribute))){if(isNGM){for(var i=0;i<zoneItems.length;i++){actions=actions.concat(me.removeFromTooltipDropZone(zoneItems[i],zoneId));}}actions=actions.concat(me.getClearDZUnitActions(zone,false));idx=0;}else{if(!replacingSameItem){actions=actions.concat(me.getRemoveDropZoneUnitActions(zone,replacedItem));if(isNGM){actions=actions.concat(me.removeFromTooltipDropZone(replacedItem,zoneId));}if(itemIdx<idx&&itemIdx>=0){idx--;}}}if(zoneIsColorBy&&me.isAttrCategory(replacedItem)&&!replacingSameItem){this.removeColorByItemFromBreakByIfExists(replacedItem,actions);}else{fnHandleColorBySpecialRules();}}else{if(edge===ENUM_TARGET.ABOVE&&me.getUnitIndexInZone(zone,item)===-1){unitCount[zoneId]+=1;if(unitCount[zoneId]===1&&item.t===4){flags[zoneId]=true;}}else{if((edge===ENUM_TARGET.BELOW||edge===TARGET_MIDDLE)&&me.getUnitIndexInZone(zone,item)===-1){unitCount[zoneId]+=1;if(unitCount[zoneId]===1&&item.t===4){flags[zoneId]=true;}if((idx<zoneItems.length)&&(itemIdx===-1)){idx++;}}}}}}else{unitCount[zoneId]+=1;if(unitCount[zoneId]===1&&me.isMetric(item)){flags[zoneId]=true;}idx=0;}if(isAxisZone(zoneId)&&item.zone===zoneId&&chtInfo.isBubbleOrScatter&&zoneItems.length>1){var curPrimary=(item.ax===0);if(curPrimary!==isPrimary){$ARR.forEach(zoneItems,function(item1){if(item1.did!==item.did){actions.push(me.getAddDropZoneUnitAction(zone,item1,idx,{isPrimary:isPrimary}));}});}}if(zoneId===BREAKBY&&gmCtr.isBoxPlot){occurrences=me.hGetItemOccurrence(item);for(i=0,n=occurrences.length;i<n;i++){if(occurrences[i].zoneId===COLORBY){occurredZone=me.getZoneModelByZoneId(occurrences[i].zoneId);actions=actions.concat(me.getRemoveDropZoneUnitActions(occurredZone,occurredZone.items[occurrences[i].itemIndex],1));if(unitCount[occurredZone.id]){unitCount[occurredZone.id]--;}}}}if(!isNGM){if(zoneId!==TOOLTIP&&itemIdxInTooltip!==-1){actions=actions.concat(me.getRemoveDropZoneUnitActions(tooltipZone,tooltipZone.items[itemIdxInTooltip],1));}if(zoneId===TOOLTIP){occurrences=me.hGetItemOccurrence(item);for(i=0,n=occurrences.length;i<n;i++){if(occurrences[i].zoneId!==TOOLTIP){occurredZone=me.getZoneModelByZoneId(occurrences[i].zoneId);actions=actions.concat(me.getRemoveDropZoneUnitActions(occurredZone,occurredZone.items[occurrences[i].itemIndex],1));if(unitCount[occurredZone.id]){unitCount[occurredZone.id]--;}}}}}else{if(!itemIsMetricName&&zoneId!==TOOLTIP){var tooltipIdx=me.getTooltipDropzoneIdx(item);actions.push(me.getAddDropZoneUnitAction(tooltipZone,item,tooltipIdx,{isPrimary:isPrimary}));}}if(!flags[XAXIS]&&!flags[YAXIS]&&zone.id!==BREAKBY&&breakByZone!==undefined){if(isNGM){var breakByZoneItems=breakByZone.items;for(var i=0;i<breakByZoneItems.length;i++){actions=actions.concat(me.removeFromTooltipDropZone(breakByZoneItems[i],BREAKBY));}}actions=actions.concat(me.getClearDZUnitActions(breakByZone));var metricNameInBreakby=me.hGetItemOccurrence(METRIC_NAMES_ITEM,[BREAKBY]);if(metricNameInBreakby){actions=actions.concat(me.getClearDZUnitActions(breakByZone,false));}}if(itemIsAttribute||itemIsMetricName){if(itemIdx!==-1){if(zoneId===BREAKBY||zoneId===SLICEBY){if(zoneItems[itemIdx].hidden){actions=actions.concat(me.getRemoveDropZoneUnitActions(me.getZoneModelByZoneId(COLORBY),item));}}else{if(zoneId===COLORBY){fnHandleColorBySpecialRules();}}}else{fnHandleColorBySpecialRules();}}else{if(this.isMetric(item)){var itemOccur=this.hGetItemOccurrence(item,[XAXIS,YAXIS,ANGLEBY]),zonesToCheck=([XAXIS,YAXIS,ANGLEBY,COLORBY,SIZEBY,TOOLTIP]).filter(function(zone){return zone!==item.zone;}),alreadyInZone=me.hGetItemOccurrence(item,zonesToCheck),isDisableOnly=alreadyInZone.length>0?1:0;if((dragSrc===ENUM_DRAG_SOURCE.VIZ_EDITOR||dragSrc===ENUM_DRAG_SOURCE.VIZ)&&item.zone&&(item.zone!==zoneId&&(!isNGM||zoneId!==TOOLTIP))){actions=actions.concat(me.getRemoveDropZoneUnitActions(me.getZoneModelByZoneId(item.zone),item,1));if(itemOccur.length&&unitCount[itemOccur[0].zoneId]&&itemOccur[0].zoneId!==zoneId){unitCount[itemOccur[0].zoneId]--;}}else{if(dragSrc===ENUM_DRAG_SOURCE.DATASETS&&itemOccur.length!==0&&zoneId!==COLORBY&&zoneId!==SIZEBY&&zoneId!==ANGLEBY&&itemOccur[0].zoneId!==zoneId&&itemOccur[0].zoneId!==ANGLEBY){if(!isNGM){actions=actions.concat(me.getRemoveDropZoneUnitActions(me.getZoneModelByZoneId(itemOccur[0].zoneId),item,isDisableOnly));unitCount[itemOccur[0].zoneId]--;}}}}}actions.push(me.getAddDropZoneUnitAction(zone,item,idx,{isPrimary:isPrimary}));if(!context.metricNamesHandled){if(!this.isMetricName(item)){var fakedItem=$HASH.clone(METRIC_NAMES_ITEM,[ROWS,COLUMNS,XAXIS,YAXIS]),occurences=me.hGetItemOccurrence(fakedItem),isMetricNameShown=occurences.length>0,rowMetricNameCnt=me.hGetItemOccurrence(METRIC_NAMES_ITEM,[ROWS]),colMetricNameCnt=me.hGetItemOccurrence(METRIC_NAMES_ITEM,[COLUMNS]),xMetricNameCnt=me.hGetItemOccurrence(METRIC_NAMES_ITEM,[XAXIS]),yMetricNameCnt=me.hGetItemOccurrence(METRIC_NAMES_ITEM,[YAXIS]),primaryMetricNameCnt=me.hGetItemOccurrence(METRIC_NAMES_ITEM,[ROWS,COLUMNS,XAXIS,YAXIS,BREAKBY]);if((flags[XAXIS]&&unitCount[XAXIS]>METRIC_NAMES_VISIBLE_THRESH)||(flags[YAXIS]&&unitCount[YAXIS]>METRIC_NAMES_VISIBLE_THRESH)||(flags[ANGLEBY]&&unitCount[ANGLEBY]>METRIC_NAMES_VISIBLE_THRESH)){showMetricName=true;}var zoneIDToAddMetricName=primaryMetricNameCnt.length?primaryMetricNameCnt[0].zoneId:ROWS,dualAxis=me.changeToDualAxis(zone);if(!isMetricNameShown&&zoneId===XAXIS){zoneIDToAddMetricName=COLUMNS;}if(!isMetricNameShown&&context.dndGM&&me.isMetric(item)&&edge!==ENUM_TARGET.ON){if(splitMetric){if(zoneId===XAXIS){zoneIDToAddMetricName=COLUMNS;}else{zoneIDToAddMetricName=ROWS;}}else{if(zoneId===XAXIS){zoneIDToAddMetricName=YAXIS;}else{zoneIDToAddMetricName=XAXIS;}}}var notRemove=false;if(me.isAttrCategory(item)&&zoneId!==ROWS&&zoneId!==COLUMNS&&zoneId!==COLORBY&&zoneId!==BREAKBY&&zoneId!==SLICEBY){$ARR.forEach(occurences,function(occr){if(occr.zoneId===zoneId){notRemove=true;}});if(!isDroppedMetricZone&&(zoneId===XAXIS||zoneId===YAXIS)){notRemove=true;}if(showMetricName&&isMetricNameShown&&!notRemove){if(xMetricNameCnt.length){zoneIDToAddMetricName=COLUMNS;}else{if(yMetricNameCnt.length){zoneIDToAddMetricName=ROWS;}}zone=me.getZoneModelByZoneId(zoneIDToAddMetricName);fakedItem.zone=zoneIDToAddMetricName;actions.push(me.getAddDropZoneUnitAction(zone,fakedItem,zone.items.length));}}if(!oldDualAxis&&dualAxis&&(item.zone===XAXIS||zoneId===XAXIS)&&rowMetricNameCnt.length>0){zoneIDToAddMetricName=YAXIS;}else{if(!oldDualAxis&&dualAxis&&(item.zone===YAXIS||zoneId===YAXIS)&&colMetricNameCnt.length>0){zoneIDToAddMetricName=XAXIS;}}if(showMetricName!==isMetricNameShown||dragSrc===ENUM_DRAG_SOURCE.VIZ||(isMetricNameShown&&splitMetric!==[COLUMNS,ROWS].indexOf(occurences[0].zoneId)>=0)){actions=actions.concat(me.getUpdateMetricNameUnitActions(showMetricName,zoneIDToAddMetricName));}}}if(item.t===4){var groupInfo;if(gmCtr.shallWeUseGroupInfo){if(me.isMetricName(item)&&(zoneId===XAXIS||zoneId===YAXIS)){gmCtr.shallWeUseGroupInfo=false;gmCtr.removeGroupInfo();}else{groupInfo=gmCtr.getGroupInfo();if((chtInfo.dirc===DIRC.VERTICAL&&zoneId===YAXIS)||(chtInfo.dirc===DIRC.HORIZONTAL&&zoneId===XAXIS)){if(edge===ENUM_TARGET.ON&&replacedItem!==undefined&&me.isMetric(replacedItem)){groupInfo=me.replaceItemInGroupInfo(groupInfo,item.did,isPrimary,replacedItem.did);}else{groupInfo=me.fillGroupInfo(context,groupInfo,item.did,isPrimary);}}gmCtr.setGroupInfo(groupInfo);}}else{if((isPrimary===false&&gmCtr.getSplitPlottingMetrics())){gmCtr.shallWeUseGroupInfo=true;if(chtInfo.isBubbleOrScatter&&unitCount[YAXIS]===0){gmCtr.horizontalMode=true;}groupInfo=gmCtr.getDummyGroupInfo();groupInfo=me.fillGroupInfo(context,groupInfo,item.did,isPrimary);}else{if(me.isMetricName(item)&&(zoneId===ROWS||zoneId===COLUMNS)&&gmCtr.getSecondaryMetrics().length>0){gmCtr.shallWeUseGroupInfo=true;groupInfo=gmCtr.getDummyGroupInfo();}else{if(pivotMetricNameToRowColumn){gmCtr.shallWeUseGroupInfo=true;groupInfo=gmCtr.getDummyGroupInfo(item.did,isPrimary,edge===ENUM_TARGET.ABOVE);}}}}if(gmCtr.shallWeUseGroupInfo){xtab.setWidgetPropertyValue(ENUM_XML_TAG.GROUP_INFO,JSON.stringify(groupInfo));}}me.checkAndAddThresholdAction(zoneId,item,actions);var updateActionsForAttribute=function(actions){if(!itemIsAttribute){return actions;}var cz=me.getZoneModelByZoneId(COLORBY),sz=me.getZoneModelByZoneId(SLICEBY),bz=me.getZoneModelByZoneId(BREAKBY),fi,newAction,newActions=[],getProperPosition=function(){for(i=$ARR.find(cz.items,"did",item.did)-1;i>=0;i--){fi=$ARR.find(zone.items,"did",cz.items[i].did);if(fi!==-1){return fi+1;}}return 0;},updateZone=function(zone,idx,item){zone.items=zone.items.filter(function(itm){return itm.did!==item.did;});zone.items.splice(idx,0,item);},findAction=function(zone,item){return actions.some(function(action){return(action.zoneId===zone.id&&action.unitId===item.did);});};actions.forEach(function(action){if(action.act==="addDropZoneUnit"){zone=me.getZoneModelByZoneId(action.zoneId);item={t:action.unitType,did:action.unitId};idx=action.unitPos-1;idx=idx>=0?idx:0;if(zone.id===BREAKBY||zone.id===SLICEBY){if($ARR.find(cz.items,"did",item.did)!==-1){idx=getProperPosition();action.unitPos=idx+1;}updateZone(zone,idx,item);}else{if(zone.id===COLORBY){updateZone(zone,idx,item);if(sz&&$ARR.find(sz.items,"did",item.did)!==-1){fi=getProperPosition();updateZone(sz,fi,item);if(!findAction(sz,item)){newAction=$HASH.clone(action);newAction.zoneId=sz.id;newAction.unitPos=fi+1;newActions.push(newAction);}}if(bz&&$ARR.find(bz.items,"did",item.did)!==-1){fi=getProperPosition();updateZone(bz,fi,item);if(!findAction(bz,item)){newAction=$HASH.clone(action);newAction.zoneId=bz.id;newAction.unitPos=fi+1;newActions.push(newAction);}}}}}});return actions.concat(newActions);};return actions;},checkAndAddThresholdAction:function checkAndAddThresholdAction(zoneID,item,actions){var host=this.getHost(),templateID=host.getVisType().vt,thresholdData=$THRESHOLD_UTILS.getDefaultGMThreshold(templateID);if(this.isMetric(item)&&zoneID===COLORBY){$THRESHOLD_UTILS.addThresholds(host.model,host,host.node,item,actions,thresholdData.colors,thresholdData.ranges,false);return true;}return false;},isDualAxis:function isDualAxis(zoneId){var me=this,axis=me.getZoneModelByZoneId(zoneId),primaryCnt=0,secondaryCnt=0;var cntMrc=function(tag){if(tag===true||tag===1){primaryCnt++;}else{if(tag===false||tag===0){secondaryCnt++;}}};$ARR.forEach(axis.items,function(itm){if(me.isMetric(itm)){cntMrc(itm.ax);}});return primaryCnt>0&&secondaryCnt>0;},getUnitDroppedActions:function(item,zone,context,idx,edge,isPrimary,splitMetric,pivotMetricNameTo){var actions=[],pivotMetricNameToRowColumn=(pivotMetricNameTo===ROWS||pivotMetricNameTo===COLUMNS);actions=actions.concat(this.getActionsOnUnitDropped(item,zone,context,idx,edge,isPrimary,splitMetric,pivotMetricNameToRowColumn));if(pivotMetricNameTo){var fakedItem=$HASH.clone(METRIC_NAMES_ITEM,[ROWS,COLUMNS,XAXIS,YAXIS]),occurences=this.hGetItemOccurrence(fakedItem),tgtZone=this.getZoneModelByZoneId(pivotMetricNameTo),tgtIdx=tgtZone.items.length,metricNameItem;if(occurences.length>0){var zoneOccured=this.getZoneModelByZoneId(occurences[0].zoneId);metricNameItem=zoneOccured.items[occurences[0].itemIndex];}else{metricNameItem=fakedItem;metricNameItem.zone=pivotMetricNameTo;}actions=actions.concat(this.getActionsOnUnitDropped(metricNameItem,tgtZone,context,tgtIdx,ENUM_TARGET.BELOW,true));}return actions;},getUpdateMetricNameUnitActions:function(show,targetZoneId){var i,index,zone,fakedItem=$HASH.clone(METRIC_NAMES_ITEM),occurences=this.hGetItemOccurrence(fakedItem),nFound=occurences.length,actions=[];if(show&&nFound===0){zone=this.getZoneModelByZoneId(targetZoneId);fakedItem.zone=targetZoneId;actions.push(this.getAddDropZoneUnitAction(zone,fakedItem,zone.items.length));}if(!show&&nFound>0){for(i=0;i<nFound;i++){zone=this.getZoneModelByZoneId(occurences[i].zoneId);index=occurences[i].itemIndex;actions=actions.concat(this.getRemoveDropZoneUnitActions(zone,zone.items[index]));}}if(actions.length===0&&targetZoneId!==ROWS){if(nFound>0){var isThere=false;var zoneId;for(i=0;i<nFound;i++){zoneId=occurences[i].zoneId;if(zoneId===targetZoneId){isThere=true;break;}}if(isThere===false){zone=this.getZoneModelByZoneId(targetZoneId);fakedItem.zone=targetZoneId;actions.push(this.getAddDropZoneUnitAction(zone,fakedItem,zone.items.length));}}}return actions;},getClearDZUnitActions:function(zone,skipMetricName){var i,item,zoneItems=zone.items,n=zoneItems.length,actions=[];if(skipMetricName===undefined){skipMetricName=true;}for(i=n-1;i>=0;i--){item=zoneItems[i];if(this.isMetricName(item)&&skipMetricName){continue;}actions=actions.concat(this.getRemoveDropZoneUnitActions(zone,item));}return actions;},getClearDZMetricActions:function(zone,isDisableOnly,exchangeMetricIds){var i,item,zoneItems=zone.items,n=zoneItems.length,toolTipZone=this.getZoneModelByZoneId(TOOLTIP),ttItemLength=toolTipZone.items.length,ttItemsIds=toolTipZone.items.map(function(d){return d.did;}),actions=[];for(i=n-1;i>=0;i--){item=zoneItems[i];if(!this.isMetric(item)){continue;}if(ttItemsIds.indexOf(item.did)===-1){exchangeMetricIds.push(item.did);}actions.push(this.getAddDropZoneUnitAction(toolTipZone,item,ttItemLength++,{isPrimary:item.ax===0}));actions=actions.concat(this.getRemoveDropZoneUnitActions(zone,item,isDisableOnly));}return actions;},removeMetricFromTooltips:function(exchangeMetricIds){var i,item,toolTipZone=this.getZoneModelByZoneId(TOOLTIP),zoneItems=toolTipZone.items,n=zoneItems.length,actions=[];for(i=n-1;i>=0;i--){item=zoneItems[i];if(this.isMetric(item)&&exchangeMetricIds.indexOf(item.did)>=0){actions=actions.concat(this.getRemoveDropZoneUnitActions(toolTipZone,item,1));}}return actions;},getSwapDZUnitActions:function(zoneA,zoneB,isNGM){var i,item,zoneAItems=zoneA.items.slice(0),zoneBItems=zoneB.items.slice(0),nA=zoneAItems.length,nB=zoneBItems.length,actions=[],actions1=[],actions2=[],exchangeMetricIds=[],extra,zoneAAtt=this.isAttrCategoryZone(zoneA.id);actions=actions.concat(this.getClearDZMetricActions(zoneA,1,exchangeMetricIds));actions=actions.concat(this.getClearDZMetricActions(zoneB,1,exchangeMetricIds));for(i=0;i<nA;i++){item=zoneAItems[i];if(this.isMetric(item)){extra={isPrimary:item.ax===0};}else{extra={};}actions1.push(this.getAddDropZoneUnitAction(zoneB,item,i,extra));}for(i=0;i<nB;i++){item=zoneBItems[i];if(this.isMetric(item)){extra={isPrimary:item.ax===0};}else{extra={};}actions2.push(this.getAddDropZoneUnitAction(zoneA,item,i,extra));}if(zoneAAtt){actions=actions.concat(actions1);actions=actions.concat(actions2);}else{actions=actions.concat(actions2);actions=actions.concat(actions1);}actions=actions.concat(this.removeMetricFromTooltips(exchangeMetricIds));return actions;},getAddDropZoneUnitAction:function getAddDropZoneUnitAction(zone,item,idx,extras){var xtab=getHost.call(this),model=xtab.model,modelData=model.data,datasetId=xtab.itemId2DsIdMap[item.did]||modelData.datasetId,ax,action;extras=extras||{};extras.datasetId=datasetId;extras.datasetType=datasetId===METRIC_NAMES_ID?METRIC_NAMES_UNIT_TYPE:DATASET_TYPE;if(this.isMetricName(item)){idx=zone.items.length;}action=this._super(zone,item,idx,extras);if(extras.isPrimary===undefined||extras.isPrimary===true){ax=$SAB.PRIMARY;}else{ax=$SAB.SECONDARY;}if(zone.id===XAXIS||zone.id===YAXIS){item.ax=ax;action.ax=ax;if(item.zone===XAXIS||item.zone===YAXIS){item.zone=zone.id;}}if(zone.items===undefined){return action;}if(idx<=zone.items.length){if(zone.id===BREAKBY){$ARR.forEach(zone.items,function(itm){if(itm.did===item.did&&itm.hidden){item.hidden=true;}});}zone.items=zone.items.filter(function(itm){return itm.did!==item.did;});zone.items.splice(idx,0,item);}return action;},getRemoveDropZoneUnitActions:function getRemoveDropZoneUnitActions(zone,item,isDisableOnly){var actions=this._super(zone,item,isDisableOnly);if(zone.items===undefined){return actions;}zone.items=zone.items.filter(function(itm){return itm.did!==item.did;});return actions;},moveAttributesToZone:function(sourceZoneId,targetZoneId){var clearRes,appendRes,keepRes;var xtab=getHost.call(this),isNGM=xtab.getChartStyle()==="NewGraphMatrixVisualizationStyle";clearRes=clearAttributesInDropZone.call(this,sourceZoneId,1);appendRes=appendItemsToDropZone.call(this,targetZoneId,clearRes.removedItems);appendTooltip=isNGM?appendItemsToDropZone.call(this,9,clearRes.removedItems):{actions:[]};if(this.getZoneModelByZoneId(COLORBY)){keepRes=keepColorByItems.call(this,COLORBY,clearRes.removedItems);return clearRes.actions.concat(appendRes.actions).concat(keepRes.actions).concat(appendTooltip.actions);}return clearRes.actions.concat(appendRes.actions).concat(appendTooltip.actions);},deleteItem:function(zone,idx,maxNamesVisible,isWithTransform){this.deleteItems([zone.items[idx]],maxNamesVisible,isWithTransform);},deleteItems:function(items,maxNamesVisible,isWithTransform){var xtab=getHost.call(this),zoneId,gmCtr=xtab.GMController,chtInfo=gmCtr.getChartInfo(),actions=[],groupInfo,fakedItem=$HASH.clone(METRIC_NAMES_ITEM),zoneContainsMetricsFlag={},unitCount={},occurrences,i,angByEnabled,index,tpZone,nFound,isNGM=xtab.getChartStyle()==="NewGraphMatrixVisualizationStyle",me=this;var getActionOnItemRemove=function(item,isWithTransform){zoneId=item.zone;if(isPrimaryZone(zoneId)&&me.isMetricName(item)){var xAxisItems=gmCtr.dz.XAxis.TemplateMetric||[],yAxisItems=gmCtr.dz.YAxis.TemplateMetric||[];if(item.cs&&(xAxisItems.length>1||yAxisItems.length>1)){actions=actions.concat(me.getUpdateMetricNameUnitActions(true,BREAKBY));}return ;}var zone=me.getZoneModelByZoneId(zoneId),colorByZone=me.getZoneModelByZoneId(COLORBY),breakByZone=me.getZoneModelByZoneId(BREAKBY),tooltipZone=me.getZoneModelByZoneId(TOOLTIP),occur=me.hGetItemOccurrence(item,[COLORBY]),sizebyItemOccur=me.hGetItemOccurrence(item,[XAXIS,YAXIS,COLORBY,BREAKBY]);if(item.cs&&item.zone===SLICEBY&&occur.length){actions=actions.concat(me.getRemoveDropZoneUnitActions(zone,item));if(isWithTransform){actions=actions.concat(me.getAddDropZoneUnitAction(colorByZone,item,colorByZone.items.length));actions=actions.concat(me.getAddDropZoneUnitAction(breakByZone,item,breakByZone.items.length));}return ;}if(item.cs&&item.zone===SIZEBY&&!sizebyItemOccur.length){actions=actions.concat(me.getRemoveDropZoneUnitActions(zone,item));actions=actions.concat(me.getAddDropZoneUnitAction(tooltipZone,item,tooltipZone.items.length));return ;}maxNamesVisible=maxNamesVisible||METRIC_NAMES_VISIBLE_THRESH;angByEnabled=me.getZoneModelByZoneId(ANGLEBY)!==undefined;zoneContainsMetricsFlag[XAXIS]=me.isMetricZone(XAXIS);zoneContainsMetricsFlag[YAXIS]=me.isMetricZone(YAXIS);unitCount[XAXIS]=me.getMetricCntInZone(XAXIS);unitCount[YAXIS]=me.getMetricCntInZone(YAXIS);if(angByEnabled){zoneContainsMetricsFlag[ANGLEBY]=me.isMetricZone(ANGLEBY);unitCount[ANGLEBY]=me.getMetricCntInZone(ANGLEBY);}else{zoneContainsMetricsFlag[ANGLEBY]=false;unitCount[ANGLEBY]=0;}if(item.t===4&&(zoneId===XAXIS||zoneId===YAXIS||zoneId===ANGLEBY)){unitCount[zoneId]-=1;if(unitCount[zoneId]===0){zoneContainsMetricsFlag[zoneId]=false;}}if(!((zoneContainsMetricsFlag[XAXIS]&&unitCount[XAXIS]>maxNamesVisible)||(zoneContainsMetricsFlag[YAXIS]&&unitCount[YAXIS]>maxNamesVisible)||(zoneContainsMetricsFlag[ANGLEBY]&&unitCount[ANGLEBY]>maxNamesVisible))){occurrences=me.hGetItemOccurrence(fakedItem);nFound=occurrences.length;for(i=0;i<nFound;i++){tpZone=me.getZoneModelByZoneId(occurrences[i].zoneId);index=occurrences[i].itemIndex;actions=actions.concat(me.getRemoveDropZoneUnitActions(tpZone,tpZone.items[index]));}}if(!(zoneContainsMetricsFlag[XAXIS]&&unitCount[XAXIS])&&!(zoneContainsMetricsFlag[YAXIS]&&unitCount[YAXIS])){if(!me.isZonesEmptyAfterDelItem(item)){var BREAKBYZONE=me.getZoneModelByZoneId(BREAKBY);if(BREAKBYZONE!==undefined){$ARR.forEach(BREAKBYZONE.items,function(item){if(me.isMetricName(item)){var zonesToAdd=me.getZoneModelByZoneId(ROWS);actions.push(me.getAddDropZoneUnitAction(zonesToAdd,fakedItem,zonesToAdd.items.length));}actions=actions.concat(me.getRemoveDropZoneUnitActions(BREAKBYZONE,item));});}}}if(me.isMetricName(item)&&item.zone===COLORBY){var metricnameOccur=me.hGetItemOccurrence(METRIC_NAMES_ITEM,[ROWS,COLUMNS,XAXIS,YAXIS,BREAKBY,SLICEBY]);if(metricnameOccur.length===0){if(chtInfo.isPie){actions=actions.concat(me.getUpdateMetricNameUnitActions(true,SLICEBY));}else{actions=actions.concat(me.getUpdateMetricNameUnitActions(true,BREAKBY));}}}if(isNGM&&zoneId!==TOOLTIP){actions=actions.concat(me.removeFromTooltipDropZone(item,zoneId));}actions=actions.concat(me.getRemoveDropZoneUnitActions(zone,item));if(me.isAttrCategory(item)&&zoneId===COLORBY){me.removeColorByItemFromBreakByIfExists(item,actions);}if(chtInfo.isABL&&item.t===4){xtab.updateMetricShape(item);var existingGroupInfo=gmCtr.hasGroupInfoStored();if(existingGroupInfo.existing){groupInfo=existingGroupInfo.gi;if((chtInfo.dirc===DIRC.VERTICAL&&zoneId===YAXIS)||(chtInfo.dirc===DIRC.HORIZONTAL&&zoneId===XAXIS)){groupInfo=deleteFromGroupInfo(groupInfo,item.did);}gmCtr.setGroupInfo(groupInfo);}}};var preByCnt=me.getZoneModelByZoneId(BREAKBY);preByCnt=preByCnt&&preByCnt.items.length||0;$ARR.forEach(items,function(item){getActionOnItemRemove(item,isWithTransform);});if(me.getZoneModelByZoneId(BREAKBY)!==undefined){var postByCnt=me.getZoneModelByZoneId(BREAKBY).items.length;if(postByCnt===0&&preByCnt>0){xtab.updateSubtype();}}if(actions.length===0&&!xtab.isXMLDirty()){return ;}var model=this.docModel,dataService=model.getDataService(),nodeKey=xtab.k,callbacks=_getXtabCallback(xtab),updAct=dataService.getUpdateTemplateAction(nodeKey,actions),prNodes=updAct.partialRetrieval.nodes,executeActions=[updAct],selectUnit=model.getSelectedViUnit(),viz=selectUnit&&selectUnit.boxContent,needUpdateFilterPanel=!(viz&&viz.isInFilterPanel());updAct.partialRetrieval.nodes=prNodes.concat(needUpdateFilterPanel?this.docModel.getSourceFilterKeys(nodeKey):[]);if(xtab.isXMLDirty()){executeActions.push(xtab.getPersistAction());}return model&&model.checkAndNotifyVFChangeOnDZUnitsUpdate({actions:executeActions,zm:me,cmb:true},function(){executeActions=model.wrapUnsetVisualizationFilterAction(executeActions);xtab.controller.submitUndoRedoUpdates(executeActions,null,callbacks);},function(){xtab.controller.submitUndoRedoUpdates(executeActions,null,callbacks);});},getHostModel:function(){return this.getHost().model.data;},replaceItemInGroupInfo:function(groupInfo,metricDid,isPrimary,replacedMetricDid){var len=groupInfo.length,pair,j,i,emptyGroup;j=isPrimary?0:1;for(i=0;i<len;i++){pair=groupInfo[i];emptyGroup=false;if(pair[j]===metricDid){pair[j]=INVALID_METRIC_IDX;if(pair[1-j]===INVALID_METRIC_IDX){emptyGroup=true;}}else{if(pair[1-j]===metricDid){pair[1-j]=INVALID_METRIC_IDX;if(pair[j]===INVALID_METRIC_IDX){emptyGroup=true;}}}if(emptyGroup){groupInfo.splice(i,1);len=groupInfo.length;i-=1;}}for(i=0;i<len;i++){pair=groupInfo[i];if(pair[j]===replacedMetricDid){pair[j]=metricDid;break;}}return groupInfo;},fillGroupInfo:function fillGroupInfo(context,groupInfo,metricDid,isPrimary){var i,pair,pIdx,idxPri=-1,idxSec=-1,len=groupInfo.length;if(!context.dndGM){for(i=0;i<len;i++){pair=groupInfo[i];if(pair[0]===metricDid){idxPri=i;}if(pair[1]===metricDid){idxSec=i;}}if((isPrimary&&idxPri!==-1)||(!isPrimary&&idxSec!==-1)){return groupInfo;}if(isPrimary&&idxSec!==-1){pIdx=idxSec;pair=groupInfo[pIdx];pair[1]=INVALID_METRIC_IDX;if(pair[0]===INVALID_METRIC_IDX){pair[0]=metricDid;return groupInfo;}}if(!isPrimary&&idxPri!==-1){pIdx=idxPri;pair=groupInfo[pIdx];pair[0]=INVALID_METRIC_IDX;if(pair[1]===INVALID_METRIC_IDX){pair[1]=metricDid;return groupInfo;}}groupInfo=simplyInsertMetricToGroupInfo(groupInfo,metricDid,isPrimary);}else{groupInfo=insertMetricToGroupInfoWhenDnd(context,groupInfo,metricDid,isPrimary);}return groupInfo;},removeFromTooltipDropZone:function removeFromTooltipDropZone(item,zoneId){var me=this,occurrences=me.hGetItemOccurrence(item),actions=[],toolTipZone=me.getZoneModelByZoneId(TOOLTIP);if(isPrimaryZone(zoneId)){for(var i=0;i<occurrences.length;i++){var tpZone=me.getZoneModelByZoneId(occurrences[i].zoneId);actions=actions.concat(me.getRemoveDropZoneUnitActions(tpZone,item));}}else{if(occurrences.length===2){for(var i=0;i<occurrences.length;i++){if(occurrences[i].zoneId===TOOLTIP){actions=actions.concat(me.getRemoveDropZoneUnitActions(toolTipZone,item));}}}}return actions;},getTooltipDropzoneIdx:function getTooltipDropzoneIdx(item){var me=this,tooltipZone=me.getZoneModelByZoneId(TOOLTIP),isAttribute=this.isAttribute(item),occurrences=me.hGetItemOccurrence(item);for(var i=0;i<occurrences.length;i++){if(occurrences[i].zoneId===TOOLTIP){return occurrences[i].itemIndex;}}if(isAttribute){return tooltipZone.items.filter(function(item){return me.isAttribute(item);}).length;}else{return tooltipZone.items.length;}return index;},getHighlightTargets:function getHighlightTargets(zonesSource,topZoneSize,dropInfo){if(!zonesSource.items.length){return null;}var needAllHighlighted=true;dropInfo.allowedItems.forEach(function(item){if(item.t===zonesSource.items[dropInfo.idx].t){needAllHighlighted=false;}});if(needAllHighlighted){var res=[],idx;zonesSource.items.forEach(function(item,ix){idx=ix+(topZoneSize||0);res.push({idx:idx,edge:dropInfo.edge});},this);return res;}return null;},getUpdateGroupInfoActionForNewMetric:function(zoneId,index,isPrimary){if(index<=0){return null;}var xtab=getHost.call(this),gmCtr=xtab.GMController,chtInfo,groupInfo,fakeMetricId;if(gmCtr.shallWeUseGroupInfo){groupInfo=gmCtr.getGroupInfo();chtInfo=gmCtr.getChartInfo();if(chtInfo.isABL&&((chtInfo.dirc===DIRC.VERTICAL&&zoneId===YAXIS)||(chtInfo.dirc===DIRC.HORIZONTAL&&zoneId===XAXIS))){fakeMetricId="idx:"+index;groupInfo=this.fillGroupInfo({dndGM:false},groupInfo,fakeMetricId,isPrimary);gmCtr.setGroupInfo(groupInfo);if(xtab.isXMLDirty()){return xtab.getPersistAction();}}}return null;}});}());