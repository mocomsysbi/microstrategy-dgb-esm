(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.gmaps.MapEnums","mstrmojo.mstr.EnumDSSXMLObjectTypes","mstrmojo.vi.viz.EnumVizStyles");mstrmojo.requiresClsP("mstrmojo.vi.viz","MapHelper","EnumDSSDropZones","VisualizationTransition","GraphMatrixHelper","HeatMapVisualizationHelper","ImageLayoutHelper","NetworkVisualizationHelper");var $MOJO=mstrmojo,$ARR=$MOJO.array,$GMAPS=mstrmojo.gmaps,$EnumGraphicType=$GMAPS.EnumGraphicType,$EnumPropertyType=$GMAPS.EnumPropertyType,$VIZ=$MOJO.vi.viz,$EDZ=$VIZ.EnumDSSDropZones,$MH=$VIZ.MapHelper,$GRID="Grid",$OBJ_TYPES=mstrmojo.mstr.EnumDSSXMLObjectTypes,ENUM_VIZ_STYLES=mstrmojo.vi.viz.EnumVizStyles,TEMPLATE_METRICS_ID="-1";function newMapHelper(props){return new $VIZ.MapHelper(props);}function add2DropZoneHandler(did,t,zoneId,data,mapHelper,actions){if(did){actions.push({act:"addDropZoneUnit",zoneId:zoneId,unitId:did,unitType:t});}switch(zoneId){case $EDZ.GeoAttribute:mapHelper.geoAttribute=did;break;case $EDZ.Latitude:mapHelper.latitude=did;break;case $EDZ.Longitude:mapHelper.longitude=did;break;case $EDZ.ColorBy:mapHelper.colorBy=did;break;case $EDZ.SizeBy:mapHelper.sizeBy=did;break;case $EDZ.AdditionalMetrics:mapHelper.tooltip.push(did);break;case $EDZ.Angle:mapHelper.angle=did;break;case $EDZ.SliceBy:mapHelper.slice.push(did);break;}}function add2DropZone(did,t,zoneId,data,mapHelper,actions){add2DropZoneHandler(did,t,zoneId,data,mapHelper,actions);if(mapHelper.isMapbox&&$MH.shouldSyncItemToTooltipZone(did,zoneId,mapHelper&&mapHelper.tooltip)){add2DropZoneHandler(did,t,$EDZ.AdditionalMetrics,data,mapHelper,actions);}}function getUpdateTemplateAction(templateActions,key){return{act:"updateTemplate",actions:templateActions,keyContext:key};}function isAddedToSingleObjZone(mapHelper,id){return mapHelper.geoAttribute===id||mapHelper.latitude===id||mapHelper.longitude===id||mapHelper.colorBy===id||mapHelper.sizeBy===id||mapHelper.slice===id||mapHelper.angle===id;}function isAddedToMultiObjZone(mapHelper,id){var found=false;$ARR.forEach(mapHelper.slice,function(item){if(item===id){found=true;return false;}});return found;}function newVizHelper(visName,data,vis){var vizHelper;switch(visName){case ENUM_VIZ_STYLES.GRAPH_MATRIX:vizHelper=new $VIZ.GraphMatrixHelper({data:data});vizHelper.setData(data.dz);$ARR.forEach(vizHelper.colorByObjects,function(item){if(vizHelper.isMetric(item)){vizHelper.colorByItem=item;return false;}});vizHelper.sizeByItem=vizHelper.sizeByObjects&&vizHelper.sizeByObjects[0];vizHelper.angleItem=vizHelper.angleObjects&&vizHelper.angleObjects[0];vizHelper.sliceItem=vizHelper.sliceObjects;break;case ENUM_VIZ_STYLES.HEAT_MAP:vizHelper=new $VIZ.HeatMapVisualizationHelper({data:data});vizHelper.setData(data.dz);vizHelper.colorByItem=vizHelper.getFirstColorByUnit(true);vizHelper.sizeByItem=vizHelper.sizeByMetric;break;case ENUM_VIZ_STYLES.IMAGE_LAYOUT:vizHelper=new $VIZ.ImageLayoutHelper();vizHelper.setData(data.dz);vizHelper.colorByItem=vizHelper.colorByMetric;vizHelper.sizeByItem=vizHelper.sizeByMetric;break;case ENUM_VIZ_STYLES.NETWORK:vizHelper=new $VIZ.NetworkVisualizationHelper();vizHelper.setData(data.dz);vizHelper.colorByItem=vizHelper.edgeColorMetric;vizHelper.sizeByItem=vizHelper.nodeSizeMetric;break;case ENUM_VIZ_STYLES.GOOGLE_MAP:case ENUM_VIZ_STYLES.ESRI_MAP:case ENUM_VIZ_STYLES.MAPBOX:var isMapbox=visName===ENUM_VIZ_STYLES.MAPBOX,colorBy;vizHelper=newMapHelper({isMapbox:isMapbox,data:data});vizHelper.setWidget(vis.getTopLayerHost());colorBy=vizHelper.getColorByUnit();vizHelper.colorByItem=(colorBy&&colorBy.t)===$OBJ_TYPES.Metric?colorBy:undefined;vizHelper.sizeByItem=vizHelper.getSizeByUnit();break;default:vizHelper=null;break;}return vizHelper;}function inheritDropZonesFromOldWidget(curVisName,data,mapHelper,actions,vis){var add2SizeBy=function(did){mapHelper.setMapType($EnumGraphicType.Bubble);add2DropZone(did,$OBJ_TYPES.Metric,$EDZ.SizeBy,data,mapHelper,actions);},add2ColorBy=function(did){add2DropZone(did,$OBJ_TYPES.Metric,$EDZ.ColorBy,data,mapHelper,actions);},add2Slice=function(did){add2DropZone(did,$OBJ_TYPES.Attribute,$EDZ.SliceBy,data,mapHelper,actions);},add2Angle=function(did){add2DropZone(did,$OBJ_TYPES.Metric,$EDZ.Angle,data,mapHelper,actions);},vizHelper=newVizHelper(curVisName,data,vis),colorByItem,sizeByItem,sliceItem,angleItem;if(vizHelper){colorByItem=vizHelper.colorByItem&&vizHelper.colorByItem.did;sizeByItem=vizHelper.sizeByItem&&vizHelper.sizeByItem.did;sliceItem=vizHelper.sliceItem;angleItem=vizHelper.angleItem&&vizHelper.angleItem.did;if(sizeByItem&&(mapHelper.vp.gtp===undefined||mapHelper.showSizeByZone(mapHelper.vp))){add2SizeBy(sizeByItem);}else{if(mapHelper.vp.gtp===undefined){mapHelper.setMapType($EnumGraphicType.Marker);}}if(mapHelper.showColorByZone(mapHelper.vp)&&colorByItem){add2ColorBy(colorByItem);}if(!mapHelper.isMapbox){if(mapHelper.showSliceZone(mapHelper.vp)&&sliceItem){$ARR.forEach(sliceItem,function(item){add2Slice(item.did);});}if(mapHelper.showAngleZone(mapHelper.vp)&&angleItem){add2Angle(angleItem);}}}}function updateDropZonesFromOldWidget(mx,attrs,data,mapHelper,actions){if(mx&&mx.length){if(mapHelper.showColorByZone(mapHelper.vp)&&!mapHelper.colorBy){$ARR.forEach(mx,function(m){if(!isAddedToSingleObjZone(mapHelper,m)){add2DropZone(m.did,$OBJ_TYPES.Metric,$EDZ.ColorBy,data,mapHelper,actions);return false;}});}if(mapHelper.showSizeByZone(mapHelper.vp)&&!mapHelper.sizeBy){$ARR.forEach(mx,function(m){if(!isAddedToSingleObjZone(mapHelper,m)){add2DropZone(m.did,$OBJ_TYPES.Metric,$EDZ.SizeBy,data,mapHelper,actions);return false;}});}if(mapHelper.showAngleZone(mapHelper.vp)&&!mapHelper.angle){$ARR.forEach(mx,function(m){if(!isAddedToSingleObjZone(mapHelper,m)){add2DropZone(m.did,$OBJ_TYPES.Metric,$EDZ.Angle,data,mapHelper,actions);return false;}});}if(mapHelper.showSliceZone(mapHelper.vp)&&!mapHelper.slice){var sliceCnt=0;$ARR.forEach(attrs,function(attr){if(sliceCnt===2){return false;}if(!isAddedToMultiObjZone(mapHelper,attr)){add2DropZone(attr.did,$OBJ_TYPES.Attribute,$EDZ.Angle,data,mapHelper,actions);sliceCnt++;}});}}}function addGeoAttributes(data,actions,mapHelper,datasets){var gts=data.gts,gsi=data.gsi,row=gts&&gts.row,col=gts&&gts.col,all=(row||[]).concat(col||[]),geo=null,lat=null,lng=null,card=0,itemFound=false,gsiAll=(gsi&&gsi.rows||[]).concat(gsi&&gsi.cols||[]),tmpActions=[],findAndAdd=function(cb){$ARR.forEach(all,function(o){var _rtn;$ARR.forEach(o.fs,function(f){return _rtn=cb(o,f);});return _rtn;});},isLatForm=function(f){return $MH.isLatitude(f.n,f.fgr);},isLngForm=function(f){return $MH.isLongitude(f.n,f.fgr);},addForm=function(unitId,formId){tmpActions.push({act:"addForm",unitId:unitId,attFormId:formId,unitPos:1});},checkAndAddForm=function(unitId,templateAtt,datasetAtt){var formIds=[];$ARR.forEach(templateAtt,function(item){formIds.push(item.id);});$ARR.forEach(datasetAtt,function(item){if(formIds.indexOf(item.fid)===-1){addForm(unitId,item.fid);}});},findGeoRole=function(displayAllForms){if(displayAllForms){var datasetAtts={};$ARR.forEach(Object.keys(datasets),function(key){$ARR.forEach(datasets[key].att,function(att){datasetAtts[att.did]=att;});});$ARR.forEach(all,function(element){if(element.id){checkAndAddForm(element.id,element.fs,datasetAtts[element.id].fs);element.fs=datasetAtts[element.id].fs;}});}findAndAdd(function(o,f){if($MH.isGeoRoleSupportArea(f.fgr)){geo=o;return false;}});if(geo){add2DropZone(geo.id,$OBJ_TYPES.Attribute,$EDZ.GeoAttribute,data,mapHelper,actions);$ARR.forEach(tmpActions,function(tmpAction){actions.push(tmpAction);});if(displayAllForms){mapHelper.setUseAttributeForm(true);}mapHelper.setMapType($EnumGraphicType.Area);return ;}if(!geo){$ARR.forEach(all,function(item){var id=item.id;findAndAdd(function(o,f){if(o.id===id&&isLatForm(f)){lat=f.id||f.fid;card=o.card;}if(o.id===id&&isLngForm(f)&&f.id!==lat){lng=f.id||f.fid;card=o.card;}});if(lat&&lng){geo={id:item.id};return false;}lat=null;lng=null;});if(geo){add2DropZone(geo.id,$OBJ_TYPES.Attribute,$EDZ.GeoAttribute,data,mapHelper,actions);add2DropZone(lat,$OBJ_TYPES.AttributeForm,$EDZ.Latitude,data,mapHelper,actions);add2DropZone(lng,$OBJ_TYPES.AttributeForm,$EDZ.Longitude,data,mapHelper,actions);$ARR.forEach(tmpActions,function(tmpAction){actions.push(tmpAction);});mapHelper.setUseAttributeForm(true);return ;}}if(!geo&&!displayAllForms){findAndAdd(function(o,f){if(isLatForm(f)||$MH.isLatitude(o.n)){lat=o.id;card=o.card;}if((isLngForm(f)||$MH.isLongitude(o.n))&&(lat!==o.id)){lng=o.id;card=o.card;}});if(lat&&lng){add2DropZone(lat,$OBJ_TYPES.Attribute,$EDZ.Latitude,data,mapHelper,actions);add2DropZone(lng,$OBJ_TYPES.Attribute,$EDZ.Longitude,data,mapHelper,actions);mapHelper.setUseAttributeForm(false);return ;}}};if(data.egt!==undefined&&data.eg!==undefined&&data.eg!==""&&all.length===0&&gsiAll.length>0){$ARR.forEach(gsiAll,function(item){Object.keys(datasets).every(function(datasetId){(datasets[datasetId].att||[]).every(function(attribute){if(attribute.did===item.did){itemFound=true;all.push(attribute);}return !itemFound;});return !itemFound;});});}findGeoRole(false);if(!(geo||(lat&&lng))){findGeoRole(true);}if(actions.length===0){mapHelper.setMapType(this.getDefaultGraphicType());}}function transitionRemainingObjects(data,mx,actions,mapHelper){var gsi=data.gsi,rows=gsi.rows||[],cols=gsi.cols||[];$ARR.forEach(rows.concat(cols),function(item){if(item.did!==TEMPLATE_METRICS_ID&&!isAddedToSingleObjZone(mapHelper,item.did)&&!isAddedToMultiObjZone(mapHelper,item.did)){add2DropZone(item.did,item.t||$OBJ_TYPES.Metric,$EDZ.AdditionalMetrics,data,mapHelper,actions);}});$ARR.forEach(mx,function(item){if(item.did!==TEMPLATE_METRICS_ID&&!isAddedToSingleObjZone(mapHelper,item.did)){add2DropZone(item.did,item.t||$OBJ_TYPES.Metric,$EDZ.AdditionalMetrics,data,mapHelper,actions);}});}mstrmojo.vi.viz.MapVisualizationTransition=mstrmojo.declare(mstrmojo.vi.viz.VisualizationTransition,null,{scriptClass:"mstrmojo.vi.viz.MapVisualizationTransition",shouldSkipTransition:function shouldSkipTransition(curVisName){return curVisName===ENUM_VIZ_STYLES.ESRI_MAP||curVisName===ENUM_VIZ_STYLES.GOOGLE_MAP;},transitionDropZones:function transitionDropZones(templateActions){var vis=this.vis,node=vis.node,data=node.data,curVisName=data.visName||$GRID,isMapbox=this.scriptClass==="mstrmojo.vi.viz.MapboxVisualizationTransition",mapHelper=newMapHelper({isMapbox:isMapbox}),gsi=data.gsi,mx=gsi.mx,gts=data&&data.gts,attrs=(gts&&gts.row||[]).concat(gts&&gts.col||[]),datasets=this.vis.model.docModel.datasets,dzActions={act:"updateTemplate",keyContext:data.k,actions:[]},actions=dzActions.actions;if(this.shouldSkipTransition(curVisName)){return{wp:"",handled:false};}addGeoAttributes.call(this,data,actions,mapHelper,datasets);inheritDropZonesFromOldWidget(curVisName,data,mapHelper,actions,vis);if(data.visName===ENUM_VIZ_STYLES.GRAPH_MATRIX||data.visName===ENUM_VIZ_STYLES.NEW_GRAPH_MATRIX){mx=this.filterGMTrainingMetric(data.dz,mx);}updateDropZonesFromOldWidget(mx,attrs,data,mapHelper,actions);transitionRemainingObjects(data,mx,actions,mapHelper);if(actions.length){templateActions.push(dzActions);}if(mapHelper.colorBy){templateActions.push(getUpdateTemplateAction(this.addThresholds({data:data},{did:mapHelper.colorBy,t:$OBJ_TYPES.Metric},[]),data.k));}return{wp:mapHelper.getXml(),wgtName:mapHelper.vp[$EnumPropertyType.layerName],handled:false,gtp:mapHelper.getMapType(),ln:mapHelper.getLayerName()};},getDefaultGraphicType:function getDefaultGraphicType(){return $EnumGraphicType.Marker;}});}());