(function(){mstrmojo.requiresCls("mstrmojo.DocXtabModel","mstrmojo.vi.ui._CanDropFromSchema","mstrmojo.models.template.DataInterface","mstrmojo.vi.models.EnumDragSources","mstrmojo.array","mstrmojo.expr","mstrmojo.func","mstrmojo.hash","mstrmojo.DocDataService","mstrmojo.vi.ui.DatasetUnitMenuUtils","mstrmojo.fe.FilterUtils","mstrmojo.vi.enums.EnumVisFilterType","mstrmojo.EnumRWUnitType","mstrmojo.models.FormatModel","mstrmojo.models.template.DataInterface","mstrmojo.warehouse.EnumObjectTypes","mstrmojo.mstr.EnumDSSXMLObjectSubTypes");var $EXP=mstrmojo.expr,$ENUM_FUNCTION=$EXP.FN,$ENUM_EXPR_TYPE=$EXP.ET,$HASH=mstrmojo.hash,$ARR=mstrmojo.array,$ENUM_DRAG_SOURCES=mstrmojo.vi.models.EnumDragSources,$GET_EXPR_XML=mstrmojo.fe.FilterUtils.getExprXml,$IS_EXPR_EMPTY=mstrmojo.fe.FilterUtils.isExprEmpty,$DU=mstrmojo.vi.ui.DatasetUnitMenuUtils,$A=mstrmojo.array,$S=mstrmojo.string,$XTABFM=mstrmojo.models.FormatModel,$ENUM_PROP_NAMES=$XTABFM.ENUM_PROPERTY_NAMES,VIS_FILTER_TYPE=mstrmojo.vi.enums.EnumVisFilterType,$RW_UNIT_TYPE=mstrmojo.EnumRWUnitType,$DI=mstrmojo.models.template.DataInterface,$FIT_TO_CONTENTS=$DI.ENUM_GRID_RESIZE.FIT_TO_CONTENTS,$ENUM_OBJ_TYPES=mstrmojo.warehouse.EnumObjectTypes,$ENUM_OBJ_SUBTYPES=mstrmojo.mstr.EnumDSSXMLObjectSubTypes,$FEATURES=mstrmojo.vi.enums.EnumFeatures,$EH=mstrmojo.elementHelper;var TYPE_METRIC=4,TYPE_ATTRIBUTE=12,TEMPLATE_METRICS_ID="-1";var TYPE_BOOLEAN=3;var formattingPadddingProps=[$ENUM_PROP_NAMES.GRID_VERTICAL_PADDING,$ENUM_PROP_NAMES.GRID_HORIZONTAL_PADDING],paddingPropKeyMap={},Format_Grid_Top_Padding="tp",Format_Grid_left_Padding="lp";paddingPropKeyMap[$ENUM_PROP_NAMES.GRID_VERTICAL_PADDING]=Format_Grid_Top_Padding;paddingPropKeyMap[$ENUM_PROP_NAMES.GRID_HORIZONTAL_PADDING]=Format_Grid_left_Padding;function getCmdMgr(me){return me.docModel.controller.cmdMgr;}function getPartialRetrievalKeys(me,action){var xtabKey=me.xtab.k,model=me.docModel,selectUnit=model.getSelectedViUnit(),viz=selectUnit&&selectUnit.boxContent,needUpdateFilterPanel=!(viz&&viz.isInFilterPanel&&viz.isInFilterPanel());return[xtabKey].concat(needUpdateFilterPanel?model.getSourceFilterKeys(xtabKey,true):[]);}function addClearActions(vis,templateThresholds,metricId,actions,objectType){templateThresholds.reverse().forEach(function(thresholdData){actions.push(vis.model.getClearThresholdAction(metricId,objectType,thresholdData.tid));});}mstrmojo.vi.models.DocXtabModel=mstrmojo.declare(mstrmojo.DocXtabModel,[mstrmojo.vi.ui._CanDropFromSchema],{scriptClass:"mstrmojo.vi.models.DocXtabModel",getUnHiddenDrillPathsForCell:function getUnHiddenDrillPathsForCell(cell,title){var allDrillPaths=this.getAllDrillPathsForCell(cell,title),datasets=this.docModel.datasets,fnShowInUnits=function(units,drillPath){var i=$A.find(units,"did",drillPath.id),unit=units[i];if(unit&&!unit.hide){drillPath.n=unit.n;return true;}return false;};return $A.filter(allDrillPaths,function(drillPath){var key;for(key in datasets){var ds=datasets[key];if(fnShowInUnits(ds.att,drillPath)){return true;}}return false;});},getAllDrillWithinPathsForCell:function getAllDrillWithinPathsForCell(cell,title,excludeHidden){var allDrillPaths=excludeHidden?this.getUnHiddenDrillPathsForCell(cell,title):this.getAllDrillPathsForCell(cell,title);return allDrillPaths.filter(function(drillPath){return !!drillPath.within;});},sort:function sort(params,callback){var me=this;getCmdMgr(this).execute({execute:function execute(){var nodeKey=me.xtab.k;this.submit(me.docModel.getDataService().getUpdateTemplateAction(nodeKey,{act:"sort",sorts:params.sorts,nodeKey:nodeKey,subTotalsPos:params.stp||me.getSubTotalsPos(),stt:params.stt||-1}),callback);}});},customSort:function customSort(params,callback,extras){var me=this,params=$HASH.clone(params);getCmdMgr(this).execute({execute:function execute(){var nodeKey=me.xtab.k;this.submit(me.docModel.getDataService().getUpdateTemplateAction(nodeKey,params),callback,extras);}});},drillGrid:function drillGrid(params,callback){var me=this;getCmdMgr(this).execute({execute:function execute(){this.submit(me.docModel.getDataService().getDrillGridAction(params),callback);}});},getClearThresholdAction:function getThresholdAction(unitId,unitType,thresholdIndex){return{act:"clearThreshold",unitId:unitId,unitType:unitType,tid:thresholdIndex};},getCreateSimpleThresholdAction:function getCreateSimpleThresholdAction(thresholds,nodeKey,objectId,thresholdType,basedOnId,objectType){return{act:"threshold",nodeKey:nodeKey,thresholds:thresholds,thresholdType:thresholdType,basedOnId:basedOnId||objectId,did:objectId,objType:objectType};},getZoneFormatAction:function getZoneFormatAction(zone,formats,nodeKey,extra){var skipSubtotals=extra&&extra.skipSubtotals,isSubtotalFormat=extra&&extra.isSubtotalFormat,isSubtotalUseGridFormatting=extra&&extra.isSubtotalUseGridFormatting,units=[],axis=[],header="h",grid="g",subtotalHeader="sh",subtotalGrid="sg",fnAddAxis=function(axisId,regions){axis.push({axis:axisId,regions:regions});};if(isSubtotalFormat){if(zone==="ch"){fnAddAxis(2,[subtotalHeader]);}else{if(zone==="rh"){fnAddAxis(1,[subtotalHeader]);}else{if(zone==="va"){fnAddAxis(1,[subtotalGrid]);fnAddAxis(2,[subtotalGrid]);}}}}else{if(zone==="ch"){fnAddAxis(1,[header]);fnAddAxis(2,!skipSubtotals&&isSubtotalUseGridFormatting?[header,grid,subtotalHeader]:[header,grid]);}else{if(zone==="rh"){fnAddAxis(1,!skipSubtotals&&isSubtotalUseGridFormatting?[grid,subtotalHeader]:[grid]);}else{if(zone==="va"){this.data.gsi.mx.forEach(function(unit){units.push({unitId:unit.did,unitType:4,regions:[grid]});});if(!skipSubtotals&&isSubtotalUseGridFormatting){fnAddAxis(1,[subtotalGrid]);fnAddAxis(2,[subtotalGrid]);}}}}}return{act:"formatGridZone",nodeKey:nodeKey,props:formats,units:units,axis:axis};},getApplyGridCellFormatToSubtotalAction:function getApplyGridCellFormatToSubtotalAction(zone){var currProps={},fmtAction,xtab=this.xtab,gridInfoFmts=xtab.gridInfo.fmts,zoneFmts=gridInfoFmts[zone];var dInfo;$HASH.forEach(zoneFmts,function(item,key){dInfo=$XTABFM.getFormatPropertyInfo(key);if(dInfo&&dInfo.ps!==$XTABFM.ENUM_PROPERTY_SETS.FORMATTING_NUMBER){currProps=$HASH.mergeHashes(currProps,$XTABFM.getFormatUpdate(key,(dInfo.pt==TYPE_BOOLEAN)?item:$XTABFM.decodeValue(key,item)));}});fmtAction=xtab.model.getZoneFormatAction.call(xtab.model,zone,currProps,xtab.k,{isSubtotalFormat:true});return fmtAction;},getSelectorDataFromTemplateLimit:function getSelectorDataFromTemplateLimit(expr){return this.getSelectorDataFromViewFilter(expr);},getSelectorDataFromViewFilter:function getSelectorDataFromViewFilter(viewFilterExpr){var result=[],UNSUPPORTED_VF_ERROR="The expression is not supported by the View Filter Exception Parser.",checkNode=function checkNode(el){if($EH.isNullElem(el.id)&&$S.isEmpty(el.v)){throw UNSUPPORTED_VF_ERROR;}},isKeepOnlyTree=function isKeepOnlyTree(currentNode){var result=null;if([$ENUM_EXPR_TYPE.AE,$ENUM_EXPR_TYPE.ANDOR].indexOf(currentNode.et)>-1||(currentNode.et===$ENUM_EXPR_TYPE.AQ&&currentNode.fn===$ENUM_FUNCTION.IS_NULL)){if(!currentNode){return true;}var nodes=currentNode.nds;result=!(currentNode.not||currentNode.fn===$ENUM_FUNCTION.NOT||currentNode.fn===$ENUM_FUNCTION.NOT_IN_LIST);if(nodes){nodes.every(function(node){result=result&&isKeepOnlyTree(node);});}}else{throw UNSUPPORTED_VF_ERROR;}return result;},buildData=function buildData(currentNode,data,parentData){var childNodes=currentNode&&currentNode.nds,isORNode=currentNode.fn===$ENUM_FUNCTION.OR;parentData=parentData||data;if(childNodes&&childNodes.length){var childData=data;childNodes.forEach(function(childNode){if(isORNode){childData=[];}buildData(childNode,childData,parentData);if(isORNode&&childData.length>0){data.push(childData);}});}else{if(currentNode.fn===$ENUM_FUNCTION.IS_NULL){var attributeInfo=currentNode.a=currentNode.a||{n:"Null Attribute",did:""};data.push({tn:attributeInfo.n,tid:attributeInfo.did,eid:null,v:""});}else{if(currentNode.et===$ENUM_EXPR_TYPE.AE){var elements=currentNode.es||[];var eleCnt=elements.length;if(eleCnt===1){checkNode(elements[0]);data.push({tn:currentNode.a.n,tid:currentNode.a.did,eid:elements[0].v,v:elements[0].n});}else{if(parentData){elements.forEach(function(element){checkNode(element);parentData.push([{tn:currentNode.a.n,tid:currentNode.a.did,eid:element.v,v:element.n}]);});}}}}}return data;};try{if(viewFilterExpr){(viewFilterExpr.nds||[]).forEach(function(rootNode){var data=buildData(rootNode,[]);if(data.length>0){result.push({keepOnly:isKeepOnlyTree(rootNode),data:data});}});}}catch(err){if(err!==UNSUPPORTED_VF_ERROR){console.error("vi.models.DocXtabModel: Encountered a problem parsing the view filter expression ("+err+")");}else{return[];}}return result;},getRemoveMetricLimitsAction:function getRemoveMetricLimitsAction(limitExpr){var metricIds=[],actions=[],addLimitMetricIds=function addLimitMetricIds(currentNode,metricIds){if(!currentNode){return ;}var nodes=currentNode.nds;if(nodes){nodes.forEach(function(node){var metricInfo=node.m;if(metricInfo!==undefined){metricIds.push(metricInfo.did);}else{addLimitMetricIds(node,metricIds);}});}};if(limitExpr){addLimitMetricIds(limitExpr,metricIds);metricIds.forEach(function(metricId){actions.push({act:"removeMetricLimits",unitId:metricId});});}return actions;},getAddTemplateUnitAction:function getAddTemplateUnitAction(item,dsid,axis,idx){var rtn=this._super(item,dsid,axis,idx),prKeys=getPartialRetrievalKeys(this,rtn);if(prKeys.length>0){rtn.partialRetrieval={nodes:prKeys};}return rtn;},getRemoveTemplateUnitAction:function getRemoveTemplateUnitAction(unit){var rtn=this._super(unit),prKeys=getPartialRetrievalKeys(this,rtn);if(unit.axis!==undefined&&unit.unitPos!==undefined){rtn.axis=unit.axis;rtn.unitPos=unit.unitPos;}if(prKeys.length>0){rtn.partialRetrieval={nodes:prKeys};}return rtn;},getAdvancedPropertiesAction:function getCreateSimpleThresholdAction(props){return{act:"advancedProperties",props:props};},canShowCellMenu:function canShowCellMenu(cell){return true;},isSubtotalValue:function isSubtotalValue(cell){var union=this.getCellDataUnion(cell);return !cell.stt&&union.some(function(item){return !!item.isSubtotal;});},getKeepOnlyActionsForAssociatedNodes:function getKeepOnlyActionsForAssociatedNodes(selectorData,callback,xtab){var docModel=this.docModel,actions=[docModel.getKeepOnlyOrExcludeAction(this.xtab.k,selectorData)],visualization=!!xtab?xtab:this.xtab,associatedNodes=!mstrApp.isInVFConfigMode?(visualization.getAssociatedNodes&&visualization.getAssociatedNodes()||[]):[];callback=mstrmojo.func.wrapMethods(callback,{success:function success(){$A.forEach(associatedNodes,function(node){var unit=docModel.getPanel().getUnitByKey(node.k);if(unit&&unit.boxContent){unit.boxContent.raiseEvent({name:"regenerateToolbar"});}});}});$A.forEach(associatedNodes,function(node){actions.push(docModel.getKeepOnlyOrExcludeAction(node.k,selectorData));});return{actions:actions,callback:callback};},getSaveViewFilterAction:function getSaveViewFilterAction(xtab,expr){return{act:"saveViewFilter",nodeKey:(xtab&&xtab.k)||this.xtab.k,expr:$IS_EXPR_EMPTY(expr)?'<exp><nd et="14" fn="19"></nd></exp>':$GET_EXPR_XML(expr)};},getClearLinkingAction:function getClearViewFilterAction(vis){var actions=[],model=this.docModel,unitKey=vis.k,curLayoutKey=model.getCurrentLayoutKey(),layout=(model.defn.layouts).filter(function(layout){return layout.k===curLayoutKey;})[0],cgb=layout.cgbMap||{},lu=layout.units||{},uc,filterSource=$HASH.keyarray(cgb).filter(function(key){if(cgb[key]===unitKey){uc=lu[key];return uc&&uc.isNavigation;}return false;});$A.forEach(filterSource,function(ucKey){actions.push({act:"clearUCNodeCondition",nodeKey:ucKey});});return actions;},getClearFiltersForVisActions:function getClearFiltersForVisActions(visualization,xtab,filtersToClear,callback){var docModel=this.docModel,dataService=docModel.getDataService(),visModel=visualization.model,data=visualization.gridData||visualization.model.data||visualization.node.data,vfexpr=data.vfexpr,limitExpression=data.vlexpr,nodeKey=(xtab&&xtab.k)||this.xtab.k,actionInfo={actions:[],callback:callback};filtersToClear=[].concat(filtersToClear);if(filtersToClear.indexOf(VIS_FILTER_TYPE.KEEP_ONLY)>-1){actionInfo=visModel.getKeepOnlyActionsForAssociatedNodes([],actionInfo.callback,xtab);}if(filtersToClear.indexOf(VIS_FILTER_TYPE.ADV_QUALIFICATION)>-1){if(limitExpression){actionInfo.actions.push(dataService.getUpdateTemplateAction(visualization.k,visModel.getRemoveMetricLimitsAction(limitExpression)));}if(vfexpr){var drillIdx=filtersToClear.indexOf(VIS_FILTER_TYPE.DRILLING);if(drillIdx>-1){actionInfo.actions.push(visModel.getSaveViewFilterAction(xtab));filtersToClear.splice(drillIdx,1);}else{actionInfo.actions.push(visModel.getSaveViewFilterAction(xtab,docModel.getVfexprWithUpdatedVf(nodeKey)));}}}if(filtersToClear.indexOf(VIS_FILTER_TYPE.DRILLING)>-1){var viewFilterExpression=docModel.getVfNdFromExpr(vfexpr)||{et:14,nds:[]};actionInfo.actions.push(visModel.getSaveViewFilterAction(xtab,viewFilterExpression));}if(filtersToClear.indexOf(VIS_FILTER_TYPE.LINKING)>-1){actionInfo.actions=actionInfo.actions.concat(visModel.getClearLinkingAction(visualization));actionInfo.extras={style:{params:{treesToRender:3}}};}return actionInfo;},getObjectInfo:function getObjectInfo(objectId){var zonesModel=this.xtab.zonesModel,oi=null;if(zonesModel){(zonesModel.getDropZones().zones||[]).some(function(zone){return !!zone.items.some(function(item){if(item.did===objectId){oi=item;return true;}});});}else{oi=this._super(objectId);}return oi;},getObjectInfoFromDataset:function getObjectInfo(objectId){var objectInfo;$HASH.forEach(this.docModel.datasets,function(dataset){if(!objectInfo){objectInfo=(dataset.mx.concat(dataset.att)).filter(function(metric){return metric.did===objectId;})[0];}});return objectInfo;},hasDerivedElements:function hasDerivedElements(objectId){var objectInfo=this.getObjectInfo(objectId);return !!(objectInfo&&objectInfo.de);},isRecursiveAttribute:function isRecursiveAttribute(objectId){var deObject=this.docModel.getDEObject(objectId),objectInfo=this.getObjectInfoFromDataset(deObject?deObject.attId:objectId);return objectInfo&&objectInfo.t===12&&objectInfo.st===3076;},getNDEFormsFromDataset:function getNDEFormsFromDataset(attrId){var objectInfo=this.getObjectInfoFromDataset(attrId);return objectInfo&&objectInfo.fs;},hasRecursiveAttribute:function hasRecursiveAttribute(gridData){var me=this,gsi=(gridData||this.data).gsi||{};return(gsi.rows||[]).concat(gsi.cols||[]).some(function(item){return me.isRecursiveAttribute(item.did);});},hasSameRecursiveAttributeGroup:function hasSameRecursiveAttributeGroup(item,gridData,excludeItems){var docModel=this.docModel,itemId=item.did,itemDeObj=docModel.getDEObject(itemId),gsi=(gridData||this.data).gsi||{};if(this.isRecursiveAttribute(itemId)){return $A.filterOne((gsi.rows||[]).concat(gsi.cols||[]),function(gItem){var gItemId=gItem.did,gItemDeObj=docModel.getDEObject(gItemId);return $A.find($A.ensureArray(excludeItems),"did",gItemId)<0&&(gItemId!==itemId)&&(itemDeObj?itemDeObj.attId:itemId)===(gItemDeObj?gItemDeObj.attId:gItemId);});}return false;},supportsViewFilterActions:function supportsViewFilterActions(objectId){var objectInfo=this.getObjectInfo(objectId);return objectInfo&&!objectInfo.de&&(objectInfo.t!==1)&&(objectInfo.t!==47||objectInfo.st===12033);},addEditNodeForDatasetAction:function addEditNodeForDatasetAction(context,key){this.augmentDropContextForSchema(context,this.docModel);var dragData=context.getCtxtDragData(),dragSrc=dragData.src;if(dragSrc===$ENUM_DRAG_SOURCES.DATASETS||dragSrc===$ENUM_DRAG_SOURCES.ALL_OBJECT_LIST){var datasetId=context.getCtxtDragData().dsid,actions=context.actions||[];if(datasetId){actions.push({act:"editNode",nodeKey:key,datasetId:datasetId});}context.actions=actions;}},getCurrentUnitAxisAndPosition:function getCurrentUnitAxisAndPosition(id){return new mstrmojo.models.template.DataInterface(this.data).getUnitById(id)||null;},getNumberFormatEditorCfg:function getNumberFormatEditorCfg(itemContext){var model=this,vis=model.xtab,data=model.data,nfArr=(data.gnf||[]).concat(data.gnfu),item=itemContext.item,idx=$A.find(nfArr,"id",item.did),formatValues=idx===-1?{}:nfArr[idx],isXtab=vis&&(!vis.defn.vis||!vis.defn.vis.ve);var NFEditor=$DU.getNumberFormatEditor(itemContext.item,formatValues,function(data){var numberFormatAction=model.docModel.getNumberFormatAction(item.did,item.t,data),hasPartialRetrieval=!!numberFormatAction.partialRetrieval,extras,urInfo;if(hasPartialRetrieval){extras=mstrmojo.DocDataService.REQUEST_DEFN_DATA;urInfo={treesToRender:3};}vis.controller.submitUndoRedoTemplateUpdates(vis,numberFormatAction,model.docModel.controller._getXtabCallback(vis,undefined,hasPartialRetrieval),extras,urInfo);});return NFEditor;},showNumberFormat:function(item){var applicableFormTypes=[1,2,8,9,11],showForAttribute;if(item.t===12){var nodeData=this.xtab.node.data,gts=nodeData&&nodeData.gts,dataInterface=new mstrmojo.models.template.DataInterface(nodeData),titles=gts&&(dataInterface.getRowTitles().titles||[]).concat(dataInterface.getColTitles().titles||[]),templateItem=$A.filterOne(titles,function(unit){return item.did===unit.id;}),shownForms=((templateItem&&templateItem.fs)||[]).map(function(shownform){return shownform.id;});showForAttribute=(item.fs||[]).some(function(form){return applicableFormTypes.indexOf(form.bftp)!==-1&&shownForms.indexOf(form.fid||form.id)!==-1;});}var webNumberFormattingPrivilegeExists=mstrApp&&mstrApp.supportFeature&&mstrApp.supportFeature($FEATURES.NUMBER_FORMATTING);return(item.t===4&&item.did!==TEMPLATE_METRICS_ID&&webNumberFormattingPrivilegeExists)||showForAttribute;},openThresholdEditor:function(item,isColorBy,canSupportImage){var model=this,vis=model.xtab,docModel=model.docModel,gridData=model.data,gridStructureInfo=gridData.gsi,itemId=item.did,titleString=mstrmojo.desc(3647,"Thresholds");if(item.t===TYPE_METRIC||item.t===TYPE_ATTRIBUTE){var metricsArray=$HASH.clone(gridStructureInfo.mx),targetArr;metricsArray.forEach(function(mx){mx.t=4;});targetArr=gridStructureInfo.rows.concat(gridStructureInfo.cols,metricsArray).filter(function(item){var type=item.t,subType=item.st,did=item.did;return !((type===1&&subType===257)||(type===47&&subType===12032)||(model.hasDerivedElements(did))||(did==="-1")||(type===14));});targetArr.forEach(function(item){if(item.t===12){var oi=this.getObjectInfo(item.did);item.da=oi?oi.da:undefined;}else{if(item.t===47&&item.st===12033){var oi=this.getObjectInfo(item.did);item.ndetype=oi.ndetype;}else{if(item.t===4){var metric=this.getObjectInfoFromDataset(item.did);item.dt=metric&&metric.dt;}}}},this);if(itemId!==TEMPLATE_METRICS_ID){titleString+=" - "+item.n;}var FEATURES=mstrmojo.threshold.ThresholdModel.FEATURES,thresholdController=new mstrmojo.threshold.ThresholdController({metricId:itemId,objectType:item.t,title:titleString,data:gridData,targets:targetArr,messageId:docModel.mid,datasets:docModel.datasets,dataService:docModel.getDataService(),supportsFeature:function supportsFeature(featureId){switch(featureId){case FEATURES.SHOW_ADVANCED_EDITOR:return !isColorBy;case FEATURES.SHOW_BASED_ON:return !isColorBy;case FEATURES.SHOW_IMAGE:return canSupportImage;case FEATURES.SHOW_VALUE_ITEM:var metricObject=model.getObjectInfoFromDataset(this.model.basedOnId),metricType=metricObject&&metricObject.dt,nonSupportedType=[8,9,10,14,15,16,30];return !metricType||nonSupportedType.indexOf(metricType)===-1;}},onSubmitActions:function(newThresholds,templateThresholds,metricId,basedOnId,type,isApply,objectType){var controller=this,actions=[];if(templateThresholds){addClearActions(vis,templateThresholds,metricId,actions,objectType);}actions.push(model.getCreateSimpleThresholdAction(newThresholds,vis.k,metricId,type,basedOnId,objectType));vis.controller.submitUndoRedoTemplateUpdates(vis,actions,{success:function(){if(isApply){controller.set("data",model.data);controller.openEditor();isApply=false;}}});},onSaveThresholds:function(thresholds,basedOnId,thresholdType,saveAsParam,callback){this.dataService.saveThresholds($HASH.copy(saveAsParam,{thresholds:JSON.stringify(thresholds),basedOnId:basedOnId,thresholdType:thresholdType}),callback,{hideFailureErr:true});},onLoadThresholds:function(metricId,thresholdsId){var thModel=this.model;this.dataService.getThresholds({thresholdsID:thresholdsId},{success:function(res){var ths=res.thresholds,validThs=[],targets,isValid,tgtsNotOnTemp={};$A.forEach(ths||[],function(th){targets=$EXP.findTargets(th.expr,"did");isValid=true;$HASH.forEach(targets,function(t,did){if(!model.getObjectInfo(did)){tgtsNotOnTemp[did]=t.n;isValid=false;}});if(isValid){validThs.push(th);}});if(!$HASH.isEmpty(tgtsNotOnTemp)){var tgtsArr=$HASH.valarray(tgtsNotOnTemp);mstrmojo.alert(mstrmojo.desc(15431,"The following objects: # are not on the visualization, so some thresholds will not be loaded...").replace("#",tgtsArr.join(",")));}thModel.addThresholds(validThs);}});}});if(item.t===TYPE_ATTRIBUTE){thresholdController.model.editorMode=mstrmojo.threshold.ThresholdModel.EDITOR_TYPES.ADVANCED_EDITOR;}thresholdController.openEditor();}},buildThresholdMenuOptions:function buildThresholdMenuOptions(cfg,itemContext,isColorBy,canSupportImage){var model=this,vis=model.xtab,gridData=model.data,gridStructureInfo=gridData.gsi,threshold=gridStructureInfo.thresholds,item=itemContext.item,itemId=item.did,hasThresholds=threshold&&threshold[itemId],STR_CLEAR=mstrmojo.desc(13261,"Clear Thresholds"),isPauseMode=vis.excludeData;if((!isPauseMode&&item.t===TYPE_METRIC)||item.t===TYPE_ATTRIBUTE&&!model.docModel.isOldDEObject(itemId)){cfg.addMenuItem(mstrmojo.desc(6050,"Thresholds..."),"",function(){model.openThresholdEditor(item,isColorBy,canSupportImage);},this);if(itemId!==TEMPLATE_METRICS_ID){if(hasThresholds){cfg.addMenuItem(STR_CLEAR,"",function(){var actions=[];addClearActions(vis,hasThresholds,itemId,actions,item.t);vis.controller.submitUndoRedoTemplateUpdates(vis,actions);},this);}}}},moveSubTotals:function moveSubTotals(cell,positions){var me=this;getCmdMgr(this).execute({execute:function execute(){var xtab=me.xtab,nodeKey=xtab.k;this.submit(me.docModel.getDataService().getUpdateTemplateAction(nodeKey,me.getMoveSubTotalAction(cell.data,positions,nodeKey)),xtab.controller._getXtabCallback(xtab));}});},getAttributeFormsInTemplate:function(attrId){var gts=this.data.gts,attrForms=[];(gts.row||[]).concat(gts.col||[]).forEach(function(obj){if(obj.id===attrId&&obj.fs){attrForms=attrForms.concat(obj.fs);}});return attrForms;},getPivotFormAction:function(cell,btn,type){var titleInfo=this.getCellTitleInfo(cell),title=titleInfo.title,formsUnderHeader=title.fs,attrId=title.id,formsInTemplate=this.getAttributeFormsInTemplate(attrId),formIdx=(title.fix&&title.fix-1)||(cell.fi||0),form=formsInTemplate[formIdx],toIdx;if(btn==="l"){toIdx=formIdx-1;}else{if(btn==="r"){toIdx=formIdx+1;}}return{act:"pivot",unitPos:toIdx+1,attFormId:form.id,unitId:attrId,unitType:type||"",originUnitPos:formIdx+1};},getValuesDefaultFormatGridZoneAction:function(units,skipSubtotals){var currProps={},vaFmtAction,xtab=this.xtab,gridInfo=xtab&&xtab.gridInfo,gridInfoFmts=gridInfo&&gridInfo.fmts,newFmtUnits=[],dInfo,extra={};$HASH.forEach(units,function(item){newFmtUnits.push({unitId:item.did,unitType:TYPE_METRIC,regions:["g"]});});if(gridInfoFmts){var va=gridInfoFmts.va,rh=gridInfoFmts.rh,ch=gridInfoFmts.ch;$HASH.forEach(gridInfoFmts.va,function(item,key){dInfo=$XTABFM.getFormatPropertyInfo(key);if(dInfo&&dInfo.ps!==$XTABFM.ENUM_PROPERTY_SETS.FORMATTING_NUMBER){currProps=$HASH.mergeHashes(currProps,$XTABFM.getFormatUpdate(key,(dInfo.pt==TYPE_BOOLEAN)?item:$XTABFM.decodeValue(key,item)));}});var fmtsInfo=va[Format_Grid_Top_Padding]?va:(rh[Format_Grid_Top_Padding]?rh:ch),value;$ARR.forEach(formattingPadddingProps,function(prop){dInfo=$XTABFM.getFormatPropertyInfo(prop);if(dInfo){value=fmtsInfo[paddingPropKeyMap[prop]];currProps=$HASH.mergeHashes(currProps,$XTABFM.getFormatUpdate(prop,$XTABFM.decodeValue(prop,value)));}});}extra.skipSubtotals=skipSubtotals;vaFmtAction=xtab.model.getZoneFormatAction.call(xtab.model,"va",currProps,xtab.k,extra);vaFmtAction.units=[].concat(newFmtUnits);return vaFmtAction;},getRAExpandAction:function getRAExpandAction(cell,sliceId,isExpandDescendants){var titleId=this.getCellTitleInfo(cell).title.id,deObject=this.docModel.getDEObject(titleId),result={act:"raExpandCollapse",sliceId:sliceId,depth:cell.dpt,ordinal:(cell.o!==undefined)?cell.o:cell._ei,id:cell._e&&cell._e.id,isExpand:isExpandDescendants?1:(cell.epd?0:1)},prKeys=getPartialRetrievalKeys(this);if(isExpandDescendants){result.expand_dsts=1;}result[deObject?"deId":"attId"]=titleId;if(prKeys.length>0){result.partialRetrieval={nodes:prKeys};}return result;},getRAExpandAllAction:function getRAExpandAllAction(unitId,isExpandAll){var deObject=this.docModel.getDEObject(unitId),result={act:"raExpandCollapseAll",isExpandAll:isExpandAll?1:0},prKeys=getPartialRetrievalKeys(this);result[deObject?"deId":"attId"]=unitId;if(prKeys.length>0){result.partialRetrieval={nodes:prKeys};}return result;},getCreateCSVizActions:function getCreateCSVizActions(cell,axis,newKey,extraActions){var actions=[],updateTemplateActions=[],docModel=this.docModel,dataService=docModel.getDataService(),panel=docModel.getVizContentPanel(),panelKey=panel.k,xtab=this.xtab,xtabKey=xtab.k,vizBox=xtab.parent;actions.push({act:"macroCopyUnit",newKey:newKey,unitType:$RW_UNIT_TYPE.GRID,unitKey:xtabKey,toKey:panelKey,partialRetrieval:{nodes:[newKey]}});var clearVisFilterAct=docModel.clearVisAsFilterAction(vizBox),clearVisFilterActions=clearVisFilterAct&&clearVisFilterAct.actions;$ARR.forEach(clearVisFilterActions,function(action){if(!action.controlKey){action.nodeKey=newKey;actions.push(action);}});var vizBoxs=vizBox.parent.children,cgbKey,separateFilter=xtab.getFilterType()===1;$ARR.forEach(vizBoxs,function(box){if($ARR.find(box.defn&&box.defn.an,"k",xtabKey)!==-1){actions.push({act:"associateNodes",nodeKey:box.k,targetKeys:[newKey]});var selectorControl=box.boxContent.selectorControl;if(selectorControl){var newCGB=cgbKey===undefined||separateFilter,cgbKey=newCGB?docModel.getNextKey():cgbKey;actions.push({act:"addVisToFilter",parentKey:xtabKey,targetKey:newKey,ctrlKey:selectorControl.ckey,newCGB:newCGB,cgbKey:cgbKey});}}});$ARR.forEach(vizBoxs,function(box){var defn=box.defn,targetKeys=(defn&&defn.tks||"").split("\u001E");$ARR.forEach(targetKeys,function(tk){if(tk===xtabKey){var keyContext=defn.ck,srcType=defn.srct,srcSubType=defn.srcst,isGroupBySelector=(srcType===$ENUM_OBJ_TYPES.Consolidation&&srcSubType!==$ENUM_OBJ_SUBTYPES.ConsolidationManaged)||srcType===$ENUM_OBJ_TYPES.Filter;actions.push(dataService.getAddCtrlTargetAction(keyContext,newKey,newKey,isGroupBySelector));}});});var gridData=this.data,gsi=gridData.gsi,me=this,addRemoveNonTargetUnitsActions=function(units,axis){$ARR.forEach(units,function(unit,idx){if(unit.did==="-1"){$ARR.forEach(gsi.mx,function(metric,metridIdx){var metrciCell=$HASH.copy(metric);metrciCell.axis=-1;metrciCell.unitPos=metridIdx+1;updateTemplateActions.push(me.getRemoveTemplateUnitAction(metrciCell));});}else{if(unit.did!==cell.id){var unitCell=$HASH.copy(unit);unitCell.axis=axis;unitCell.unitPos=idx+1;updateTemplateActions.push(me.getRemoveTemplateUnitAction(unitCell));}}});};addRemoveNonTargetUnitsActions(gsi.rows,1);addRemoveNonTargetUnitsActions(gsi.cols,2);if(axis===2){updateTemplateActions.push(this.getPivotUnitAction(1,0,cell.id,12,2,0));}updateTemplateActions.push({act:"advancedProperties",props:{"Template Formatting":{ShowColumnHeaders:"-1",LockColumnHeaders:"-1"}}});var dataInterface=new $DI(gridData);if(dataInterface.getColResizeScenario()!==$FIT_TO_CONTENTS){updateTemplateActions.push({act:"changeXtabColWidthScenario",value:$FIT_TO_CONTENTS});}if(extraActions){updateTemplateActions=updateTemplateActions.concat(extraActions);}$ARR.forEach(updateTemplateActions,function(act){delete act.partialRetrieval;});actions.push(dataService.getUpdateTemplateAction(newKey,updateTemplateActions));return actions;},getUnitNameInDataSet:function(unitId){return this.docModel.findUnitNameInDataSetFromUnit(unitId);}});}());