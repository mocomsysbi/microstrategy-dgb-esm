(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.array","mstrmojo.dom","mstrmojo.func","mstrmojo.vi.controllers.UICmdMgr");var $F=mstrmojo.func,$HASH=mstrmojo.hash,$ARR=mstrmojo.array,$COMMAND_STATES=mstrmojo.vi.controllers.UICmdMgr.STATES,FILTER_TYPE={SHARED:0,SEPARATE:1},OPERATOR={AND:19,OR:20},mergeAttributeValues=function mergeAttributeValues(obj1,obj2){var result={},mergeAtts=function(atts1,atts2){var res=[];if(!atts2){return atts1;}$ARR.forEach((atts2||[]),function(item){res.push(item);});$ARR.forEach((atts1||[]),function(item){var ix=$ARR.find(atts2,"id",item.id);if(!~ix){res.push(item);}});return res;};$HASH.forEach(obj2,function(selAtts,attId){result[attId]=selAtts;});$HASH.forEach(obj1,function(selAtts,attId){result[attId]=mergeAtts(selAtts,obj2[attId]);});return result;},metricValuesSelCells=function metricValuesSelCells(datas){var selCells=[];$HASH.forEach(datas,function(data){selCells.push({ft:OPERATOR.AND,d:data});});return selCells;},attValueSelCells=function(datas){var finalData={},getInfo=function(data){var id=$HASH.keyarray(data)[0];return{id:id,d:data[id][0]};};$HASH.forEach(datas,function(data){var tmpData={},attInfo=getInfo(data),attSelection=tmpData[attInfo.id];if(attInfo.id){if(!attSelection){tmpData[attInfo.id]=attSelection=[];}attSelection.push(attInfo.d);}finalData=mergeAttributeValues(finalData,tmpData);},this);return[{ft:OPERATOR.OR,d:finalData}];},getSelectionDataTree=function getSelectionDataTree(data,st){var model=this.model,selectionData,selections=[],$ST=mstrmojo.vi.ui.rw.SelectionType,noSelection=true,hasElements=false,vis=this;if(!st){st=this.getSelectionType();}if(!$HASH.isEmpty(data)){if(st===$ST.METRICS){selectionData=metricValuesSelCells.call(this,data);}else{selectionData=attValueSelCells.call(this,data);}}$HASH.forEach(selectionData,function(v){noSelection=false;var node=[];$HASH.forEach(v.d,function(w,id){if(vis.isSupportViewFilterForSelection(id)){hasElements=true;var elems=[],item={id:id,elems:elems,fm:w[0].fm,v:$ARR.map(w,function(widget){return widget.n;}).reverse()},oi=model.getObjectInfo(id);if(oi){item.t=oi.t;item.st=oi.st;if(oi.st===12033){item.attId=oi.attId;}}$ARR.forEach((w||[]),function(e){elems.push(e.id);});node.push(item);}});if(node.length){selections.push({ft:v.ft,d:node});}});selections.hasElements=hasElements;selections.clearSelections=noSelection;return selections;},getContextMenuSelectionDataTree=function getContextMenuSelectionDataTree(data){var st=this.getContextMenuSelectionType(),selections=[];selections=getSelectionDataTree.call(this,data,st);return selections;},handleMUSelection=function handleMUSelection(selectionData,isNavigation){var sc=this.selectorControl,controller,model,select,that=this,layoutKey,panelKey;if(sc){if(selectionData.clearSelections||selectionData.hasElements){controller=this.controller;if(isNavigation){model=controller.model;panelKey=sc.navPage;layoutKey=model.getLayoutKeyByUnitKey(panelKey);this.clearSelections();this.setSelectionCache();}sc.exp=null;if(controller.onGridSelector){select=function(){controller.onGridSelector(that,{type:mstrmojo.EnumRWUnitType.GRID,ck:sc.ck,tks:sc.tks,cgb:$HASH.valarray(sc.cgb),ctlKey:sc.ckey,sliceId:this.sid,isUConDS:sc.isUConDS,isNavigation:isNavigation,layoutKey:layoutKey,panelKey:panelKey,ct:sc.ct,selections:selectionData});};if(this.multiUnitCtrlInterval){window.clearInterval(this.multiUnitCtrlInterval);this.multiUnitCtrlInterval=null;}if(controller.cmdMgr.state===$COMMAND_STATES.BUSY){this.multiUnitCtrlInterval=window.setInterval(function(){if(controller.cmdMgr.state!==$COMMAND_STATES.BUSY){window.clearInterval(that.multiUnitCtrlInterval);if(!that.destroyed){that.multiUnitCtrlInterval=null;select();}}},1000);}else{select();}}}}},getSelectorDataFromExpression=function getSelectorDataFromExpression(exp){var res={type:mstrmojo.vi.ui.rw.SelectionType.ATTS,data:exp},lookupType=function(nd,prevTy){if(parseInt(nd.fn,10)===22&&parseInt(prevTy,10)===19){res.type=mstrmojo.vi.ui.rw.SelectionType.METRICS;}$ARR.forEach((nd.nds||[]),function(i){lookupType(i,nd.fn);});};lookupType(exp,null);return res;},getCGBMap=function getCGBMap(){return this.parent.model.getCurrentLayoutDef().cgbMap;},getSourceCGBs=function getSourceCGBs(){var cgbMap=getCGBMap.call(this),res=[];$HASH.forEach(cgbMap,function(v,k){if(this.k===v){res.push(k);}},this);return res;},shouldClearSelectionAfterUpdate=function shouldClearSelectionAfterUpdate(){var cmdMgr=this.controller&&this.controller.cmdMgr;if(cmdMgr&&cmdMgr.isUndoRedo()){return true;}return false;};mstrmojo.vi.ui.rw.selectors._IsMultiUnitControl=mstrmojo.provide("mstrmojo.vi.ui.rw.selectors._IsMultiUnitControl",{_mixinName:"mstrmojo.vi.ui.rw.selectors._IsMultiUnitControl",selectorControl:null,multiUnitCtrlInterval:null,postBuildRendering:function postBuildRendering(){if(this._super){this._super();}var sc=mstrApp.isInVFConfigMode||this.isCustomSort?null:this.findSelectorControl();if(shouldClearSelectionAfterUpdate.call(this)){this.clearSelections();}if(sc&&!sc.isNavigation&&!$HASH.isEmpty(sc.exp)&&this.addSelectionsFromExpression){this.addSelectionsFromExpression(getSelectorDataFromExpression(sc.exp));if(this.highlight){this.highlight(this.getSelectionType(),this.getSelectionHash(),true);}}},getSelectorDataFromExpression:getSelectorDataFromExpression,getSelectionDataTree:getSelectionDataTree,getContextMenuSelectionDataTree:getContextMenuSelectionDataTree,deleteSelectorControl:function deleteSelectorControl(){if(this._super){return this._super();}this.throwAbstractMethodError("deleteSelectorControl");},findSelectorControl:function findSelectorControl(){if(this._super){return this._super();}this.throwAbstractMethodError("findSelectorControl");},handlesMultiSelection:function handlesMultiSelection(evt){return(this._super&&this._super(evt))||!!this.selectorControl;},isSupportViewFilterForSelection:function isSupportViewFilterForSelection(id){var model=this.model;return model.supportsViewFilterActions(id);},isLinkedFilter:function(){var sc=this.findSelectorControl&&this.findSelectorControl();return sc&&sc.isNavigation;},isLinkedFilterEnabled:function(){return this.isLinkedFilter()&&this.getContextMenuSelectionHash&&!$HASH.isEmpty(this.getContextMenuSelectionHash());},handleContextMenuSelectionData:function hcmsd(isNavigation){this.isNavigation=isNavigation;this.onContextMenuSelectionChange(this.getContextMenuSelectionHash&&this.getContextMenuSelectionHash());},onSelectionChange:function onSelectionChange(data){var cgbs=(this.model.getSelectorControlMapInfo?this.model.getSelectorControlMapInfo():[]),handled=false,isNavigation=this.isNavigation;if(isNavigation){delete this.isNavigation;}if(this._super){handled=this._super(data);}if(!isNavigation&&this.isLinkedFilter()){return true;}if(cgbs.length>0){this.singleUnitSelect();handled=true;}else{if(!!this.selectorControl&&!this.isCustomSort){var selectionData=getSelectionDataTree.call(this,data);handleMUSelection.call(this,selectionData,isNavigation);return true;}}return handled;},onContextMenuSelectionChange:function onContextMenuSelectionChange(data){var cgbs=(this.model.getSelectorControlMapInfo?this.model.getSelectorControlMapInfo():[]),handled=false,isNavigation=this.isNavigation;if(isNavigation){delete this.isNavigation;}if(this._super){handled=this._super(data);}if(!isNavigation&&this.isLinkedFilter()){return true;}if(cgbs.length>0){this.singleUnitSelect();handled=true;}else{if(!!this.selectorControl){var selectionData=getContextMenuSelectionDataTree.call(this,data);handleMUSelection.call(this,selectionData,isNavigation);return true;}}return handled;},singleUnitSelect:function singleUnitSelect(){if(this._super){this._super();}},clearAllSelections:function clearAllSelections(){return this.selectorControl&&this.selectorControl.showall;},onClearBrushing:function onClearBrushing(evt){if(this.selectorControl){return true;}if(this._super){return this._super(evt);}return false;},getFilterType:function getFilterType(){return this.defn.ins||FILTER_TYPE.SHARED;},switchFilterType:function switchFilterType(type){var that=this,sourceCGBs,currentType=that.getFilterType(),model=that.parent.model,controlInfos,update={actions:[]},cgbKey,CGBMap=getCGBMap.call(that),nk,filtersModified=false,units,uc,sc,ciKey,firstCGBKey;if(currentType!==type){sourceCGBs=getSourceCGBs.call(that);units=model.getCurrentLayoutDef().units;if(sourceCGBs.length&&currentType===FILTER_TYPE.SHARED){cgbKey=$ARR.filterOne(sourceCGBs,function(cgb){uc=units[cgb];if(uc){sc=uc.scs||[];return true;}controlInfos=model.getSourceControls(that.parent,cgb);sc=controlInfos;return controlInfos.length;});if(!controlInfos||!controlInfos.length){controlInfos=model.getSourceControls(that.parent,cgbKey);controlInfos=$ARR.filter(controlInfos,function(ci){ciKey=ci.control.key;return !$ARR.find(sc,"ckey",ciKey);});sc=sc.concat(controlInfos);}$ARR.forEach(sc,function(controlInfo,c){if(c!==0){nk=model.getNextKey();CGBMap[nk]=that.k;update.actions.push(model.redoFilterAssociations(true,controlInfo.ckey||controlInfo.control.ckey,controlInfo.pnk||controlInfo.sourceKey,that.k,cgbKey,nk));filtersModified=true;}}.bind(that));}else{firstCGBKey="";$ARR.forEach(sourceCGBs,function(cgbKey){uc=units[cgbKey];if(!uc){controlInfos=model.getSourceControls(that.parent,cgbKey);uc=controlInfos.length&&controlInfos[0];if(!uc){return true;}uc.pnk=uc.sourceKey;uc.ckey=uc.control.ckey;}if(!firstCGBKey){firstCGBKey=cgbKey;}else{delete CGBMap[cgbKey];sc=(uc.scs&&uc.scs[0])||uc;update.actions.push(model.redoFilterAssociations(false,sc.ckey,sc.pnk,that.k,cgbKey,firstCGBKey));filtersModified=true;}}.bind(that));}update.actions.push(model.getUnitFormatAction(that,1,{FormattingSelector:{IndependentNodeSelector:type}},true));var useCurrent=false;update.callback=({success:function(){that.defn.ins=useCurrent?currentType:type;useCurrent=!useCurrent;}});if(filtersModified){update.callback=$F.wrapMethods(update.callback,model.getRebuildCallback());}}update.extras={style:{params:{treesToRender:3}}};return update;}});}());