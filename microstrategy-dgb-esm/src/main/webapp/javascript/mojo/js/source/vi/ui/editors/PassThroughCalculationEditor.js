(function(){mstrmojo.requiresClsP("mstrmojo","Editor","TextBoxWithLabel","List","desc","css","func","dom","string","hash","HBox","Button");mstrmojo.requiresCls("mstrmojo.vi.ui.editors.DerivedElementsEditor","mstrmojo.vi.ui.editors.PassThroughExpressionInputBox","mstrmojo.PassThroughOptions","mstrmojo.warehouse.EnumDatabaseType","mstrmojo.mstr.EnumDSSXMLObjectTypes");mstrmojo.requiresDescs(221,2827,15358,15357,945,13355,118,15656);var $DESC=mstrmojo.desc,$CSS=mstrmojo.css,$FUNC=mstrmojo.func,$DOM=mstrmojo.dom,$STR=mstrmojo.string,$HASH=mstrmojo.hash,$DBT=mstrmojo.warehouse.EnumDatabaseType,$OTP=mstrmojo.mstr.EnumDSSXMLObjectTypes,$EID;mstrmojo.vi.ui.editors.PassThroughCalculationEditor=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.vi.ui.editors.PassThroughCalculationEditor",cssClass:"mstrmojo-PassThroughCalculationEditor",title:$DESC(13355,"Calculated Member"),help:"create_derived_element_mdx_hierarchy_reports.htm",enablePTO:false,init:function init(props){this._super(props);$EID=this.id;},onOpen:function onOpen(){this.expressionBox.clearExpression();this.deParentTB.set("value",$STR.decodeHtmlString(this.action.peName,true));this.deParentTB.inputNode.disabled=true;this.deNameBox.deNameTB.set("value",this.action.deName);var dataset=$HASH.any(this.view.model.docModel.datasets),dbt=dataset.tables[0].dbt;this.set("enablePTO",dbt===$DBT.MSAS||dbt===$DBT.EssBase);},onClose:function onClose(){delete this.mptf;},addDE:function addDE(ceid,cid){var view=this.view,action=this.action,controller=this.controller,docModel=view.model.docModel,actions=[],callbacks={},isFirst=action.oTp===$OTP.Attribute;action.exp=this.expressionBox.value;action.ceid=ceid;if(isFirst){action.cid=cid;}docModel.addUpdateObjects(action,{id:action.oId,type:action.oTp,flag:mstrmojo.DocDataService.PARTIAL_UPDATE_FLAGS.DATA_CHANGE});actions.push(controller.dataService().getUpdateTemplateAction(view.k,action));if(this.mptf){actions.push(controller.dataService().getSetMDXPassThroughOptionsForCMAction({mptf:this.mptf,cid:isFirst?action.cid:action.oId,ceid:action.ceid}));}if(docModel.hasSelectionOnVisFilter()&&action.act!=="editQuickDECalculation"){actions=docModel.wrapUnsetVisualizationFilterAction(actions);docModel.clearSelectionOnVisFilter(true);}callbacks=$FUNC.wrapMethods(callbacks,docModel.getDatasetsUpdateCallback(),controller._getXtabCallback(view),docModel.getUpdateHiddenPanelsCallback(),docModel.getUpdateHiddenLayoutsCallback(),docModel.getHighLightNDECallback());controller.submitUndoRedoUpdates(actions,{},callbacks);},children:[{scriptClass:"mstrmojo.HBox",cssClass:"mstrmojo-HBox deNameBox",alias:"deNameBox",slot:"containerNode",children:[{scriptClass:"mstrmojo.TextBoxWithLabel",cssClass:"deNameTB",alias:"deNameTB",label:$DESC(945,"Name"),value:"Attribute(Calculated Member)",cssDisplay:"block",onvalueChange:function onvalueChange(){mstrmojo.all[$EID].action.deName=this.value;}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-WebHoverButton",alias:"ptoBtn",text:$DESC(15656,"Pass-through Options"),onclick:function(){var editor=this.parent.parent,ID="mstrPTO",pto=mstrmojo.all[ID]||mstrmojo.insert({scriptClass:"mstrmojo.PassThroughOptions",help:"create_derived_element_mdx_hierarchy_reports.htm",id:ID}),pos=$DOM.position(this.domNode,true),dataset=$HASH.any(editor.view.model.docModel.datasets),config={zIndex:editor.zIndex+10,left:Math.max(0,(pos.x-333+pos.w/2))+"px",top:pos.y+"px",dbt:dataset.tables[0].dbt,so_dft:dataset.so_dft,sim_dft:dataset.sim_dft,onOK:function(mptf){editor.mptf=mptf;}};if(editor.mptf){config.mptf=editor.mptf;}pto.open(editor,config);},bindings:{visiable:function(){return this.parent.parent.enablePTO;}}}]},{scriptClass:"mstrmojo.TextBoxWithLabel",slot:"containerNode",alias:"deParentTB",label:$DESC(15357,"Parent"),value:"Element(Parent)",cssClass:"last",cssDisplay:"block",inputNodeCssClass:"unselectable"},{scriptClass:"mstrmojo.List",slot:"containerNode",alias:"ptCalcLabel",cssClass:"mstrmojo-pthr-calc-labels",items:[{t:1,n:$DESC(15358,"MDX Expression"),cls:"expression label"},{t:2,n:$DESC(2827,"Clear"),cls:"clear right"}],itemMarkupFunction:function(item,index){switch(item.t){case 1:return'<div class="mstrmojo-item '+item.cls+'" idx='+index+' title="'+(item.n||"")+'">'+(item.n||"")+"</div>";case 2:return'<div class="mstrmojo-Button mstrmojo-WebHoverButton '+item.cls+' hoverLink"><div class="mstrmojo-Button-text" idx='+index+">"+(item.n||"")+"</div></div>";default:return"";}},getClearBtn:function getClearBtn(){return this.itemsContainerNode.lastElementChild.firstElementChild;},onmouseup:function(evt){var el=$DOM.eventTarget(evt.hWin,evt.e),idx=el&&el.getAttribute("idx")||-1,selectedItem;this.set("selectedIndex",idx);selectedItem=this.selectedItem;if(selectedItem&&selectedItem.t===2){mstrmojo.all[$EID].expressionBox.clearExpression();}}},{scriptClass:"mstrmojo.vi.ui.editors.PassThroughExpressionInputBox",alias:"expressionBox",slot:"containerNode",onvalueChange:function(){$CSS.toggleClass(mstrmojo.all[$EID].ptCalcLabel.getClearBtn(),"disabled",!this.value);this.set("invalid",this.isExpressionInvalid());},onexprNodeHasChildrenChange:function(){$CSS.toggleClass(mstrmojo.all[$EID].ptCalcLabel.getClearBtn(),"disabled",!this.exprNodeHasChildren);}},{scriptClass:"mstrmojo.Button",slot:"buttonNode",cssClass:"mstrmojo-WebButton",text:$DESC(221,"Cancel"),onclick:function(){mstrmojo.all[$EID].close();}},{scriptClass:"mstrmojo.Button",slot:"buttonNode",alias:"okBtn",cssClass:"mstrmojo-WebButton",iconClass:"hot",text:$DESC(118,"Save"),onclick:function(){if(this.enabled){var me=mstrmojo.all[$EID],deName=me.deNameBox.deNameTB.value,ptExpr=me.expressionBox.value;if(mstrmojo.vi.ui.editors.DerivedElementsEditor.validateElementName(deName)){var isFirst=me.action.oTp===$OTP.Attribute;mstrApp.serverRequest({taskId:"getGUIDs",count:isFirst?2:1},{success:function(res){me.addDE.apply(me,res);me.close();}});}}},bindings:{enabled:function(){var expInvalid=this.parent.expressionBox.isExpressionInvalid();return this.parent.deNameBox.deNameTB.value&&this.parent.expressionBox.value&&!expInvalid;}}}]});}());