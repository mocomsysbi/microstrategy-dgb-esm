(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.Button","mstrmojo.EnumRWUnitType","mstrmojo.vi.models.VIComponentMap","mstrmojo.VisEnum","mstrmojo.gmaps.EnumGraphicType","mstrmojo.models.template.DataInterface");mstrmojo.requiresDescs(15518,15519,15526);var $ARR=mstrmojo.array,ATTR_TYPE=12,METR_TYPE=4,METR_SET_ID="-1",ROWS=1,COLUMNS=2,METR_SET=-1,$NWB=mstrmojo.Button.newWebButton,$VI_TYPES=mstrmojo.vi.models.VIComponentMap.TYPES,$DATAINTERFACE=mstrmojo.models.template.DataInterface;mstrmojo.vi.models._CheckDataCards=mstrmojo.provide("mstrmojo.vi.models._CheckDataCards",{_mixinName:"mstrmojo.vi.models._CheckDataCards",CARDLIMIT:mstrmojo.VisEnum.VIS_CARDLIMIT.NON_GRID,isUnitRestrictedInViz:function(){var host=this.getHost&&this.getHost(),defn=host&&host.defn,isVisFilter=!!(defn&&defn.iifp);if(isVisFilter){return false;}var docModel=this.docModel,units=[],filterPanel=docModel.getVIComponent($VI_TYPES.FILTER_PANEL),filterPanelStack=filterPanel&&filterPanel.parent;units=units.concat((filterPanelStack&&filterPanelStack.getFilterDefinitions())||[]);return units.length;},_addInLargeItems:[],_columnCardinalityCount:1,_totalRow:0,clearCardinalityFlags:function(){this._addInLargeItems=[];this._columnCardinalityCount=1;this._totalRow=0;},existLargeOrManyItems:function(){return(!!this._addInLargeItems.length||this._columnCardinalityCount>this.CARDLIMIT);},existLargeRowCount:function(){return(this._totalRow>mstrmojo.vi.models.editors.XtabEditorModel.ENUM_MAX_ROWS_OUTLINE);},findTotalColumnCount:function(items,zone){var me=this,itmCnt,potColCount=1,ignoreCount=0,gridData=this.getHost().gridData;me._columnCardinalityCount=1;if(gridData){if(zone&&zone.id===ROWS){var rw=gridData.rw,row=rw&&rw.row;me._columnCardinalityCount=(row&&row.tc)||1;return ;}var ghs=gridData.ghs,chs=ghs&&ghs.chs;$ARR.forEach(chs&&chs.items,function(colItem){if(colItem.items){potColCount=Math.max(potColCount,colItem.items.length);}});}$ARR.forEach(items,function(item){if(zone&&zone.id===COLUMNS){zone.items.every(function(zoneItem){if(zoneItem.t===ATTR_TYPE&&zoneItem.did===item.did&&zoneItem.card){ignoreCount++;potColCount=potColCount/zoneItem.card;return false;}return true;});}itmCnt=item.cardg>0?item.cardg:item.card;if(!itmCnt&&item.otp===ATTR_TYPE&&item.es){itmCnt=item.es.length+1;}if(itmCnt){potColCount=potColCount*itmCnt;}});me._columnCardinalityCount=(ignoreCount===items.length)?1:potColCount;},findEstimatedTotalRow:function(items,axis,removeItems){var me=this,itmCnt,potRowCount=1,metricCount=0,gridData=this.getHost().gridData,docModel=this.docModel,removeItems=removeItems||[],dataSets=docModel&&docModel.datasets;me._totalRow=1;function findAttributeCard(id){var card=0;Object.keys(dataSets).every(function(dsKey){return dataSets[dsKey].att&&dataSets[dsKey].att.every(function(a){if(a.did===id){card=a.card;return false;}return true;});});return card;}function checkExistItems(exist){return items.some(function(item){return exist.did===item.did;})||removeItems.some(function(item){return exist.did===item.did;});}if(gridData){var rows=gridData.gsi.rows,mx=gridData.gsi.mx;$ARR.forEach(rows,function(rowItem){if(checkExistItems(rowItem)){return ;}if(rowItem.t===ATTR_TYPE){potRowCount*=findAttributeCard(rowItem.did)||1;}else{if(rowItem.t===METR_TYPE){if(rowItem.did===METR_SET_ID&&mx){metricCount=mx.length;$ARR.forEach(mx,function(m){checkExistItems(m)&&metricCount--;});}}}});}$ARR.forEach(items,function(item){if(item.t===METR_TYPE){if(axis===ROWS||axis===METR_SET){if(item.did===METR_SET_ID&&gridData&&gridData.gsi.mx){metricCount=gridData.gsi.mx.length;}else{metricCount++;}}}itmCnt=item.cardg>0?item.cardg:item.card;if(!itmCnt&&item.otp===ATTR_TYPE&&item.es){itmCnt=item.es.length+1;}if(itmCnt){if(axis===ROWS){potRowCount=potRowCount*itmCnt;}}});potRowCount=potRowCount+potRowCount*metricCount;me._totalRow=potRowCount;return me._totalRow;},addAttributeNameAndTargetVisForAddUnits:function(curObjData,titleUnits,visName,graphicType,layerName){if(!curObjData){return ;}var dataModel={data:curObjData},vp=curObjData&&curObjData.vp,isMap;visName=visName||curObjData&&curObjData.vis&&curObjData.vis.vn;graphicType=graphicType||vp&&vp.gtp;layerName=layerName||vp&&vp.ln;isMap=visName===mstrmojo.vi.viz.EnumVizStyles.GOOGLE_MAP||visName===mstrmojo.vi.viz.EnumVizStyles.ESRI_MAP||visName===mstrmojo.vi.viz.EnumVizStyles.MAPBOX;$ARR.forEach(titleUnits,function(gtsUnit){var id=gtsUnit.id,gsiUnit;if(id&&!gtsUnit.attributeName){gsiUnit=$DATAINTERFACE.prototype.getUnitById.call(dataModel,id);gtsUnit.attributeName=gsiUnit&&gsiUnit.unit&&gsiUnit.unit.n;}if(graphicType===mstrmojo.gmaps.EnumGraphicType.Area&&isMap){if(!gtsUnit.targetVis){gtsUnit.targetVis={};}gtsUnit.targetVis.vis=visName;gtsUnit.targetVis.gtp=graphicType;gtsUnit.targetVis.ln=layerName;}else{if(gtsUnit.targetVis){gtsUnit.targetVis=undefined;}}});},findLargeItemsForAddUnits:function(items,render,cardinate){var me=this,cardCnt,attributeNameMap={};if((!render&&!me.isUnitRestrictedInViz())||render){items.forEach(function(item){var itmCnt=item.cardg>0?item.cardg:item.card;cardCnt=!!cardinate?cardinate:me.CARDLIMIT;if(item.targetVis&&item.targetVis.gtp===mstrmojo.gmaps.EnumGraphicType.Area){cardCnt=mstrmojo.VisEnum.VIS_CARDLIMIT.AREA_MAP;}if(itmCnt&&itmCnt>cardCnt){var itemDisplayName=item.attributeName||item.n;if(!attributeNameMap[itemDisplayName]){attributeNameMap[itemDisplayName]=true;var largeItem=item.targetVis&&item.targetVis.ln?(itemDisplayName+"("+item.targetVis.ln+") ("+itmCnt+")"):itemDisplayName+" ("+itmCnt+")";me._addInLargeItems.push(largeItem);}}});}},warnAndExecCallBackForOutlineAddUnits:function(callback,cancelCallBack){var me=this,cancelCallBack=cancelCallBack||mstrmojo.emptyFn;if(this.existLargeRowCount()){mstrmojo.confirm(mstrmojo.desc(15792,"The dossier will attempt to display more than 5000 rows in outline mode. This may affect performance and stability. Do you want to continue?"),null,{id:"OutlineModeWarningDialog",title:mstrmojo.desc(11812,"Notification"),allowHTML:false,buttons:[mstrmojo.Button.newWebButton(mstrmojo.desc(212,"Continue"),callback),mstrmojo.Button.newWebButton(mstrmojo.desc(3416,"Cancel"),cancelCallBack)],onPreClose:function(){cancelCallBack();return true;}});}else{callback();}},checkAndWarnForOutlineAddUnits:function(items,axis,callback,cancelCallBack,removeItems){if(this.getHost().isOutlineMode){this.findEstimatedTotalRow(items,axis,removeItems);this.warnAndExecCallBackForOutlineAddUnits(callback,cancelCallBack);}else{callback();}},warnAndExecCallBackForAddUnits:function(callback,alternateCallback,isInitialRender,cancelCallBack){if(this.existLargeOrManyItems()&&!mstrApp.isAppStatePresentation()){var largeItems=this._addInLargeItems,largeItemsLength=largeItems.length,warningMsg;if(largeItemsLength>1){warningMsg=mstrmojo.desc(15518,"The following attributes contain a large number of elements: ##. This action may impact dossier performance.").replace("##",largeItems);}else{if(largeItemsLength===1){warningMsg=mstrmojo.desc(15519,"The attribute ## has too many elements. This action may impact dossier performance.").replace("##",largeItems);}else{warningMsg=mstrmojo.desc(15526,"The dossier will attempt to display more than ### columns. This can affect performance and stability.").replace("###",this.CARDLIMIT);}}var buttonsList=[];if(largeItemsLength&&alternateCallback){buttonsList.push($NWB(mstrmojo.desc(7977,"Move to Rows"),function(){alternateCallback();},true));}buttonsList.push($NWB(mstrmojo.desc(212,"Continue"),function(){callback();}));buttonsList.push($NWB(mstrmojo.desc(2140,"Cancel"),function(){if(isInitialRender){if(cancelCallBack){cancelCallBack();}else{if(mstrApp.isWorkstation&&mstrApp.isSingleTier){window.FormWrapper.closeWindow("{}");}else{mstrmojo._DocToolbarActions.close.call({model:{isnew:false}});}}}}));mstrmojo.warn(warningMsg,{},{buttons:buttonsList});largeItems.splice(0,largeItems.length);return ;}callback();},checkAndWarnLargeItemsForAddUnits:function(items,callback,alternateCallback,checkColumnCount,zone,isInitialRender,cardinate,cancelCallBack){this.clearCardinalityFlags();if(!zone||zone.id===COLUMNS){this.findLargeItemsForAddUnits(items,isInitialRender,cardinate);}if(checkColumnCount){this.findTotalColumnCount(items,zone);}this.warnAndExecCallBackForAddUnits(callback,alternateCallback,isInitialRender,cancelCallBack);}});}());