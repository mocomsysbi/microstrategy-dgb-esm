(function(){mstrmojo.requiresCls("mstrmojo.Box","mstrmojo.css","mstrmojo.dom","mstrmojo.hash","mstrmojo.DI.DIConstants");mstrmojo.requiresDescs(212,373,946,1143,1902,2102,12668,12726,12727,12315,14512,14821,1281,14822,14823,12666,15614);var $CSS=mstrmojo.css,$DOM=mstrmojo.dom,$HASH=mstrmojo.hash,constants=mstrmojo.DI.DIConstants,ITEM_DISPLAY="inline-block",GRID_MODE=constants.mainPage.GRID_MODE,LIST_MODE=constants.mainPage.LIST_MODE;var TOOLBAR_CMD={LEFT:1,RIGHT:2,GRID:3,LIST:4,LIVE:5,EDIT:6,FILTER:7,SEARCH:8,OBJECTS:9,WRANGLE:10};function ddaVisible(){if(window.mstrAppSchema){return false;}var model=mstrApp.getRootController().model;if(mstrApp.showDDAOptions===false){return false;}if(mstrApp.diParams.ImportDatabase===0){return false;}if(model.currentDataset){return false;}var count=0,prop,sources=model.importSources;for(prop in sources){if(sources.hasOwnProperty(prop)){count++;}}return count<1;}function handleToggleLive(){var controller=mstrApp.getRootController(),model=controller.getModel(),isDDA=!model.isDirectDataAccess;controller.getDDAController().setDirectDataAccess(isDDA);}function handleCmd(item,cmd,value){var controller=mstrApp.getRootController(),rootView=controller.rootView,currentPage=rootView.currentPage;switch(cmd){case TOOLBAR_CMD.LEFT:controller.onBackButtonClick();break;case TOOLBAR_CMD.RIGHT:controller.onNextButtonClick();break;case TOOLBAR_CMD.GRID:rootView.setSourceListMode(GRID_MODE);break;case TOOLBAR_CMD.LIST:rootView.setSourceListMode(LIST_MODE);break;case TOOLBAR_CMD.LIVE:handleToggleLive.call(item);break;case TOOLBAR_CMD.EDIT:controller.showPage(constants.pageType.sourceAdmin);break;case TOOLBAR_CMD.SEARCH:rootView.setSearchPattern(value);break;case TOOLBAR_CMD.FILTER:if(currentPage.pageType===constants.pageType.dataSelection){currentPage.showEditorConfig({hostId:currentPage.id,hostElement:item.domNode});}break;case TOOLBAR_CMD.OBJECTS:controller.allObjectsController.showAllObjects();break;case TOOLBAR_CMD.WRANGLE:controller.launchWrangleForTable();break;default:break;}}function updateTooltipConfig4Toolbar(toolbar){var pos=$DOM.position(toolbar.domNode);toolbar.set("richTooltip",{cssClass:"vi-regular vi-tooltip-A root-toolbar-tooltip",top:Math.max(pos.y+pos.h+5,0),left:pos.x+2,posType:mstrmojo.tooltip.POS_TOPLEFT,content:toolbar.title});}var closeBtn={scriptClass:"mstrmojo.Button",cssClass:"di-title-btn",iconClass:"mstrmojo-di-close",alias:"closeBtn",title:mstrmojo.desc(2102,"Close"),tooltipOpenDelay:0,useRichTooltip:true,updateTooltipConfig:function(){updateTooltipConfig4Toolbar(this);},onclick:function(){this._ontooltipout();mstrApp.getRootController().onCancelButtonClick();},premousedown:function(){$CSS.toggleClass(this.domNode,"hit",true);},premouseup:function(){$CSS.toggleClass(this.domNode,"hit",false);}};function getDefaultToolbarItems(){this.set("visible",false);this.set("cssText","");return[$HASH.copy(closeBtn,{visible:this.showCloseBtn})];}function getToolbarItemsForDataSelectionPage(){this.set("visible",true);this.set("cssText","");return[{scriptClass:"mstrmojo.Button",cssClass:"toolbar-item btn grid",alias:"gridBtn",cssDisplay:ITEM_DISPLAY,title:mstrmojo.desc(14821,"Icon View"),tooltipOpenDelay:0,useRichTooltip:true,updateTooltipConfig:function(){updateTooltipConfig4Toolbar(this);},onclick:function(){handleCmd(this,TOOLBAR_CMD.GRID);},visible:false},{scriptClass:"mstrmojo.Button",cssClass:"toolbar-item btn list",alias:"listBtn",cssDisplay:ITEM_DISPLAY,title:mstrmojo.desc(946,"List View"),tooltipOpenDelay:0,useRichTooltip:true,updateTooltipConfig:function(){updateTooltipConfig4Toolbar(this);},onclick:function(){handleCmd(this,TOOLBAR_CMD.LIST);},visible:false},{scriptClass:"mstrmojo.Button",bindings:{cssClass:function(){var controller=mstrApp.getRootController(),model=controller.getModel(),isDDA=model.isDirectDataAccess;if(isDDA){return"toolbar-item btn dda on";}else{return"toolbar-item btn dda";}},visible:function(){return ddaVisible();}},alias:"liveBtn",cssDisplay:ITEM_DISPLAY,title:mstrmojo.desc(14822,"Live Connect Only"),tooltipOpenDelay:0,useRichTooltip:true,updateTooltipConfig:function(){this.title=!!mstrApp.getRootController().model.isDirectDataAccess?mstrmojo.desc(15614,"All connectors"):mstrmojo.desc(14822,"Live Connect Only");updateTooltipConfig4Toolbar(this);},onclick:function(){handleCmd(this,TOOLBAR_CMD.LIVE);}},{scriptClass:"mstrmojo.Button",cssClass:"toolbar-item btn admin",cssDisplay:ITEM_DISPLAY,title:mstrmojo.desc(14823,"Customize Shortcuts"),tooltipOpenDelay:0,useRichTooltip:true,updateTooltipConfig:function(){updateTooltipConfig4Toolbar(this);},onclick:function(){this.hideTooltip();handleCmd(this,TOOLBAR_CMD.EDIT);}},$HASH.copy(closeBtn,{visible:this.showCloseBtn}),{scriptClass:"mstrmojo.ui.SearchBox",cssClass:"toolbar-item searchBox",cssDisplay:ITEM_DISPLAY,searchDelay:600,alias:"searchSource",searchTriggered:function(pattern){handleCmd(this,TOOLBAR_CMD.SEARCH,pattern);},postBuildRendering:function postBuildRendering(){if(this._super){this._super();}this.inputNode.setAttribute("placeholder",mstrmojo.desc(12666,"Search..."));}},{scriptClass:"mstrmojo.Button",cssClass:"toolbar-item btn advSearch",alias:"filter",cssDisplay:ITEM_DISPLAY,title:mstrmojo.desc(1281,"Filter"),tooltipOpenDelay:0,useRichTooltip:true,visible:true,updateTooltipConfig:function(){updateTooltipConfig4Toolbar(this);},onclick:function(){handleCmd(this,TOOLBAR_CMD.FILTER);}}];}function openAggregationEditor(opener){var aggEditorID="aggEditor",editor=aggEditorID&&window.mstrmojo&&mstrmojo.all[aggEditorID],controller,zIndex=mstrApp.getRootController().getDialogController().getNextZIndex(),msgID=mstrApp.getRootController().dataService.messageID,tableID,item,isRefined,hasAggFilter,sourceInfo,launchEditor=function launchEditor(){var launchingApp=window.launchingApp=mstrApp;window.mstrApp=new mstrmojo.qb.QBApp();window.mstrApp.isWorkstation=launchingApp.isWorkstation;mstrApp.sessionState=launchingApp.sessionState;mstrApp.msgid=msgID;mstrApp.isSingleTier=launchingApp.isSingleTier;mstrApp.serverProxy=launchingApp.serverProxy;mstrApp.sessionManager=launchingApp.sessionManager;mstrApp.enableAutomaticSessionRecovery=launchingApp.enableAutomaticSessionRecovery;mstrApp.maxSessionIdleTime=launchingApp.maxSessionIdleTime;mstrApp.timeBeforeSessionTimeoutWarning=launchingApp.timeBeforeSessionTimeoutWarning;mstrApp.enableWarningSessionTimeout=launchingApp.enableWarningSessionTimeout;mstrApp.projectName=launchingApp.projectName;mstrApp.serverName=launchingApp.serverName;mstrApp.serverPort=launchingApp.serverPort;mstrApp.authMode=launchingApp.authMode;mstrApp.name=launchingApp.name;mstrApp.persistTaskParams=launchingApp.persistTaskParams;mstrApp.helpUrl=launchingApp.helpUrl;mstrApp.userHelpPage=launchingApp.userHelpPage;mstrApp.autocomplete=launchingApp.autocomplete;mstrApp.localeId=(launchingApp.helpLocaleId||launchingApp.localeId);controller=mstrApp.rootController=mstrmojo.insert({scriptClass:"mstrmojo.qb.EmmaController"});controller.dataService=mstrmojo.qb.DataService;controller.model=new mstrmojo.qb.EmmaModel({tableID:tableID});controller.model.set("id","QBuilderModel");controller.isBDE=true;if(!editor){editor=mstrmojo.insert({id:aggEditorID,scriptClass:"mstrmojo.DI.ui.dialogs.DIAggregationDialog",onClose:function onClose(){var qbApp=window.mstrApp;msgID=mstrApp.msgid;window.mstrApp=window.launchingApp;controller.model.destroy();controller.destroy();qbApp.destroy();mstrApp.getRootController().dataService.messageID=msgID;if(editor.fromAggregation){editor.opener.parent.parent.currentPage.parent.fromAggregation=true;mstrApp.getRootController().getImportedDataEMMA(constants.actions.refreshData,constants.requestFlag.mapping|constants.requestFlag.sourceInfo|constants.requestFlag.relationship|constants.requestFlag.preview,null,null,tableID);}}});}editor.hasAggFilter=hasAggFilter;controller.rootView=editor;controller.zIndex=zIndex;editor.model=controller.model;editor.tableID=tableID;editor.controller=controller;editor.open(opener,{zIndex:zIndex});};item=mstrApp.getRootController().model.currentSource;tableID=item.tableID;sourceInfo=item.sourceInfo;isRefined=sourceInfo.isRefined;hasAggFilter=sourceInfo.hasAggFilter;if(isRefined){mstrmojo.confirm(mstrmojo.desc(12717,"Previous changes made in wrangle will be discarded. Would you like to continue?"),{confirmBtn:{fn:function(){mstrApp.getRootController().dataService.cancelRefineStage({success:function success(res){msgID=res.msgid;mstrApp.getRootController().dataService.set("messageID",msgID);var source=mstrApp.getRootController().model.currentSource;delete source.projectID;var flags=constants.requestFlag.mapping|constants.requestFlag.sourceInfo|constants.requestFlag.relationship|constants.requestFlag.preview|constants.requestFlag.transformations;mstrApp.getRootController().editImportedDataEMMA(flags,null,null,null,source.tableID,null,null,null,null,true,{success:launchEditor.bind(editor)});}},{did:tableID,automap:1,dbr:sourceInfo.dbRoleId,shtIx:sourceInfo.sheetIndex?sourceInfo.sheetIndex:""});}}});}else{launchEditor();}}function getToolbarItemsForEmmaPreviewPage(){this.set("visible",true);this.set("cssText","background-color:#fafafa");return[{scriptClass:"mstrmojo.Button",cssClass:"toolbar-item  mtdi-preview objects",cssDisplay:ITEM_DISPLAY,text:mstrmojo.desc(12668,"All Objects View"),onclick:function(){handleCmd(this,TOOLBAR_CMD.OBJECTS);}},{scriptClass:"mstrmojo.Button",alias:"wrangleBtn",cssClass:"toolbar-item mtdi-preview wrangle",cssDisplay:ITEM_DISPLAY,text:mstrmojo.desc(12315,"Wrangle"),onclick:function(){handleCmd(this,TOOLBAR_CMD.WRANGLE);},postCreate:function postCreate(){var model=mstrApp.getRootController().model;model.attachEventListener("SourceInfoFetched",this.id,"update");model.attachEventListener("CurrentSourceChanged",this.id,"update");},update:function(){var model=mstrmojo.all.DIModel;var source=model.currentSource;if(source){this.set("visible",source.canRefine());}}},{scriptClass:"mstrmojo.Button",cssClass:"toolbar-item mtdi-preview aggregation",cssDisplay:ITEM_DISPLAY,postCreate:function(){this.model=mstrmojo.all.DIModel;this.model.attachEventListener("CurrentSourceChanged",this.id,"makeVisible");this.makeVisible();},makeVisible:function(){var model=mstrmojo.all.DIModel;var source=model.currentSource;var visible=false;if(source&&source.type===constants.sourceType.hadoop&&source.subtype===constants.sourceSubtype.hadoop){visible=true;}this.set("visible",visible);},text:mstrmojo.desc(15255,"Aggregation"),onclick:function(){openAggregationEditor(this);}},$HASH.copy(closeBtn,{visible:this.showCloseBtn}),{scriptClass:"mstrmojo.DI.DISearchTableBox",alias:"searchTable",cssDisplay:ITEM_DISPLAY}];}mstrmojo.DI.DIToolbar=mstrmojo.declare(mstrmojo.Box,null,{scriptClass:"mstrmojo.DI.DIToolbar",markupString:'<div id="{@id}" class="mstrmojo-Box mstrmojo-DI-DIToolbar {@cssClass}" style="{@cssText}"></div>',titleText:"",subtitleText:"",showCloseBtn:false,pageType:null,ontitleTextChange:function(){if(window.FormWrapper.setTitle&&!mstrApp.isPopup){window.FormWrapper.setTitle(this.titleText);}},onsubtitleTextChange:function(){},preBuildRendering:function preBuildRendering(){var controller=mstrApp.getRootController(),model=controller.getModel(),rootView=this.parent;if(this._super){this._super();}rootView.attachEventListener("preShowRootViewPage",this.id,"onpreShowRootViewPage");model.attachEventListener("isDirectDataAccessChange",this.id,"onisDirectDataAccessChange");model.attachEventListener("CurrentSourceChanged",this.id,"onCurrentSourceChanged");model.attachEventListener("sourceListModeChange",this.id,"onSourceListModeChange");},onpreShowRootViewPage:function onpreShowRootViewPage(evt){var pageType=evt.pageType;var children;this.pageType=pageType;switch(pageType){case constants.pageType.dataSelection:children=getToolbarItemsForDataSelectionPage.call(this);break;case constants.pageType.emmaPreview:children=getToolbarItemsForEmmaPreviewPage.call(this);break;case constants.pageType.suggestNewSource:case constants.pageType.sourceIntro:return ;default:children=getDefaultToolbarItems.call(this);break;}$CSS.toggleClass(this.domNode,"grey",pageType===constants.pageType.emmaPreview);this.removeChildren();this.addChildren(children);},onSourceListModeChange:function onsourceListModeChange(evt){var mode=evt&&evt.mode;if(this.hasRendered&&this.pageType===constants.pageType.dataSelection){$CSS.toggleClass(this.gridBtn.domNode,"on",mode===GRID_MODE);$CSS.toggleClass(this.listBtn.domNode,"on",mode===LIST_MODE);}},onisDirectDataAccessChange:function onisDirectDataAccessChange(evt){var v=evt.value;if(this.hasRendered&&this.pageType===constants.pageType.dataSelection){$CSS.toggleClass(this.liveBtn.domNode,"on",v);}},onCurrentSourceChanged:function onCurrentSourceChanged(){var model=mstrApp.getRootController().getModel();var source=model.currentSource;var visible=false;if(this.hasRendered&&this.pageType===constants.pageType.emmaPreview){if(source){visible=source.canRefine();}this.wrangleBtn.set("visible",visible);}}});}());