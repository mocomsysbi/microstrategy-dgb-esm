(function(){mstrmojo.requiresCls("mstrmojo.DI.DIConstants","mstrmojo.DI.DIMultiFormEditor","mstrmojo.DI.DIHelpers");mstrmojo.requiresDescs(13134,13136,13396,13887,14451);var constants=mstrmojo.DI.DIConstants,formsOptions=mstrmojo.DI.DIConstants.formsOptions,$ARR=mstrmojo.array,$H=mstrmojo.hash,$HELPER=mstrmojo.DI.DIHelpers;function shareSameTable(map1,map2){var linkedTbs1=map1.linkedTbs,tableId1=map1.tableId,linkedTbs2=map2.linkedTbs,tableId2=map2.tableId,ret,linkedTbs,tableId;if(!linkedTbs1&&!linkedTbs2){return tableId1===tableId2;}if(linkedTbs1&&linkedTbs2){ret=false;$H.forEach(linkedTbs2,function(v,id){if(v){if(linkedTbs1[id]){ret=true;return false;}}});return ret;}linkedTbs=linkedTbs1||linkedTbs2;tableId=linkedTbs1?tableId2:tableId1;return linkedTbs[tableId];}function getItemPropFromArray(arr,propFind,propGet,value){var idx=$ARR.find(arr,propFind,value);if(idx<0){return"";}return $H.walk(idx.toString()+"."+propGet,arr);}function generateRemoveGeoFlagsByFormId(formMaps,formId){var flgs=$ARR.map(formMaps,function(form){if(form.formId===formId){return 0;}else{return 1;}});return flgs.join(",");}function generateRemoveGeoRoleFlags(attributes,formMaps,mfaSubCols){var idFormDesc="ID",idFormId,idFormColId,idGeo,descFormDesc="DESC",descFormId,descFormColId,descGeo,textFormColId,textFormId,randFormColId,randFormId,formCategory,flags="",geoAttributes,geoColsInMFA;if((attributes&&attributes.length===0)||formMaps.length===0){return"";}formCategory=$H.walk("0.forms",formMaps);idFormId=getItemPropFromArray(formCategory,"fmn","fmid",idFormDesc);descFormId=getItemPropFromArray(formCategory,"fmn","fmid",descFormDesc);idFormColId=getItemPropFromArray(formMaps,"formId","columnId",idFormId);descFormColId=getItemPropFromArray(formMaps,"formId","columnId",descFormId);idGeo=getItemPropFromArray(attributes,"columnId","georole",idFormColId);descGeo=getItemPropFromArray(attributes,"columnId","georole",descFormColId);if(mfaSubCols){if(!idGeo){idGeo=getItemPropFromArray(mfaSubCols,"did","georole",idFormColId);}if(!descGeo){descGeo=getItemPropFromArray(mfaSubCols,"did","georole",descFormColId);}}if(idGeo>0){flags=generateRemoveGeoFlagsByFormId(formMaps,idFormId);}else{if(descGeo>0){flags=generateRemoveGeoFlagsByFormId(formMaps,descFormId);}else{geoAttributes=$ARR.filter(attributes,function(a){return a.georole>0;});if(mfaSubCols){geoColsInMFA=$ARR.filter(mfaSubCols,function(c){return c.georole>0;});}if(geoAttributes.length===0){flags=$ARR.map(formMaps,function(form){return"0";}).join(",");return flags;}textFormColId=getItemPropFromArray(geoAttributes,"dtp","columnId",constants.dataTypeMenuItems.TEXT);if(mfaSubCols&&!textFormColId){textFormColId=getItemPropFromArray(geoColsInMFA,"dtp","did",constants.dataTypeMenuItems.TEXT);}if(textFormColId){textFormId=getItemPropFromArray(formMaps,"columnId","formId",textFormColId);flags=generateRemoveGeoFlagsByFormId(formMaps,textFormId);}else{randFormColId=geoAttributes[0].columnId;if(mfaSubCols&&!randFormColId){randFormColId=geoColsInMFA[0].did;}randFormId=getItemPropFromArray(formMaps,"columnId","formId",randFormColId);flags=generateRemoveGeoFlagsByFormId(formMaps,randFormId);}}}return flags;}mstrmojo.DI.controller.DIFormsController=mstrmojo.declare(mstrmojo.Obj,null,{getLinkedAttribute:function countLinkedAttribute(attributes){var i,linkedAttribute=[];for(i=0;i<attributes.length;i++){if(this.isLinkedAttribute(attributes[i])){linkedAttribute.push(attributes[i]);}}return linkedAttribute;},countLinkedAttribute:function countLinkedAttribute(attributes){var count=0,i;for(i=0;i<attributes.length;i++){if(this.isLinkedAttribute(attributes[i])){count++;}}return count;},countSingleFormLinkedAttribute:function countSingleFormLinkedAttribute(attributes){var count=0,i;for(i=0;i<attributes.length;i++){if(this.isLinkedAttribute(attributes[i])&&this.isAllSingleFormAttribute(attributes[i])){count++;}}return count;},getLinkedColumnId:function getLinkedColumnId(attribute,attributes,idFormId){var i,columns;if(this.isLinkedAttribute(attribute)&&!this.isSingleFormAttribute(attribute)){columns=attribute.subColumns;for(i=0;i<columns.length;i++){if(columns[i].fmid===idFormId||columns[i].isIdForm){return columns[i].did;}}}else{for(i=0;i<attributes.length;i++){if(this.isLinkedAttribute(attributes[i])){return attributes[i].did;}}}},isLinkedAttribute:function isLinkedAttribute(attribute){return attribute.isLinked;},isSingleFormAttribute:function isSingleFormAttribute(attribute){return !(attribute.isMultiForm);},isAllSingleFormAttribute:function(attribute){var ret=true,attrs;if(!attribute.isLinked){ret=!(attribute.isMultiForm);}else{attrs=mstrApp.getRootController().getModel().findMappingItem(attribute);$ARR.forEach(attrs,function(att){if(att.isMultiForm){ret=false;return false;}});}return ret;},isVisible:function isVisible(option,selection){switch(option){case formsOptions.ADDTO_MULTIFORM_ATTRIBUTE:return this.isVisibleAddtoMultiformAttribute(selection);case formsOptions.CREATE_MULTIFORM_ATTRIBUTE:return this.isVisibleCreateMultiformAttribute(selection);case formsOptions.EDIT_MULTIFORM_ATTRIBUTE:return this.isVisibleEditMultiformAttribute(selection);}return false;},isVisibleAddtoMultiformAttribute:function isVisibleAddtoMultiformAttribute(selection){if(selection.length<2){return false;}var countMultiformAttribute=0,i;for(i=0;i<selection.length;i++){if(!(this.isAllSingleFormAttribute(selection[i]))){countMultiformAttribute++;}if(countMultiformAttribute>=2){return false;}if(selection[i].ipa){return false;}if(!shareSameTable(selection[0],selection[i])){return false;}}return(countMultiformAttribute===1);},isVisibleCreateMultiformAttribute:function isVisibleCreateMultiformAttribute(selection){if(selection.length<2){return false;}var i;for(i=0;i<selection.length;i++){if(!(this.isAllSingleFormAttribute(selection[i]))){return false;}if(selection[i].ipa){return false;}}return true;},isVisibleEditMultiformAttribute:function isVisibleEditMultiformAttribute(selection){if(selection.length!==1){return false;}return !(this.isSingleFormAttribute(selection[0]))&&selection[0].subColumns&&selection[0].subColumns[0].ipa!==1;},onClick:function onClick(option,tableId,attribute,selection){switch(option){case formsOptions.ADDTO_MULTIFORM_ATTRIBUTE:this.onClickAddtoMultiformAttribute(tableId,selection);break;case formsOptions.CREATE_MULTIFORM_ATTRIBUTE:this.onClickCreateMultiformAttribute(tableId,attribute,selection);break;case formsOptions.EDIT_MULTIFORM_ATTRIBUTE:this.onClickEditMultiformAttribute(tableId,attribute);break;}},onClickAddtoMultiformAttribute:function onClickAddtoMultiformAttribute(tableId,selection){var attribute=null,i;for(i=0;i<selection.length;i++){if(!(this.isAllSingleFormAttribute(selection[i]))){if(attribute!==null){return ;}attribute=selection[i];}}var countSingleFormSharedAttribute=this.countSingleFormLinkedAttribute(selection);if(this.isLinkedAttribute(attribute)){if(countSingleFormSharedAttribute>=1){this.showUnlinkError();}else{this.showMultiformDialog(formsOptions.ADDTO_MULTIFORM_ATTRIBUTE,tableId,attribute,selection,true);}}else{if(countSingleFormSharedAttribute>=2){this.showUnlinkError();}else{if(countSingleFormSharedAttribute===1){attribute=this.getLinkedAttribute(selection)[0];this.showMultiformDialog(formsOptions.ADDTO_MULTIFORM_ATTRIBUTE,tableId,attribute,selection,true);}else{this.showMultiformDialog(formsOptions.ADDTO_MULTIFORM_ATTRIBUTE,tableId,attribute,selection,false);}}}},checkMultiLinkedAttributes:function checkMultiLinkedAttributes(selection){var sharedAttributes=this.getLinkedAttribute(selection);var controller=mstrApp.getRootController();var model=controller.model;var sharedTables,allSharedTables=[],sharedTableIds;$ARR.forEach(sharedAttributes,function(attribute){sharedTableIds="";sharedTables=model.findMappingSource(attribute);$ARR.forEach(sharedTables,function(table){sharedTableIds+=table.tableID;sharedTableIds+=";";});allSharedTables.push(sharedTableIds);});var tables=allSharedTables[0].split(";");var i,j,notMatch=false,length=tables.length;for(i=0;i<allSharedTables.length;i++){if(allSharedTables[i].split(";").length!==length){notMatch=true;break;}}if(notMatch){return false;}for(i=0;i<tables.length;i++){for(j=1;j<allSharedTables.length;j++){if(allSharedTables[j].indexOf(tables[i])===-1){notMatch=true;break;}}}if(notMatch){return false;}return true;},onClickCreateMultiformAttribute:function onClickCreateMultiformAttribute(tableId,attribute,selection){var countShared=this.countLinkedAttribute(selection),ctrl=mstrApp.getRootController(),hasRecursive=false,hasLinkedNonRecursive=false;for(var i=0;i<selection.length;i++){if(selection[i].recursive){hasRecursive=true;}else{if(selection[i].isLinked){hasLinkedNonRecursive=true;}}}if(hasRecursive&&hasLinkedNonRecursive){ctrl.displayError(mstrmojo.desc(null,"We do not support a MFA with a linked non-hierarchy attribute."));return ;}if(countShared>=2){if(!this.checkMultiLinkedAttributes(selection)){this.showCreateMFAError();return ;}attribute=this.getLinkedAttribute(selection)[0];this.showMultiformDialog(formsOptions.CREATE_MULTIFORM_ATTRIBUTE,tableId,attribute,selection,true,true);}else{if(countShared===1){attribute=this.getLinkedAttribute(selection)[0];this.showMultiformDialog(formsOptions.CREATE_MULTIFORM_ATTRIBUTE,tableId,attribute,selection,true);}else{this.showMultiformDialog(formsOptions.CREATE_MULTIFORM_ATTRIBUTE,tableId,attribute,selection,false);}}},onClickEditMultiformAttribute:function onClickEditMultiformAttribute(tableId,attribute){if(this.isLinkedAttribute(attribute)){this.showMultiformDialog(formsOptions.EDIT_MULTIFORM_ATTRIBUTE,tableId,attribute,[attribute],true);}else{this.showMultiformDialog(formsOptions.EDIT_MULTIFORM_ATTRIBUTE,tableId,attribute,[attribute],false);}},showMultiformDialog:function showMultiformDialog(option,tableId,attribute,attributes,isLinked,isMultiLinked){var controller=mstrApp.getRootController(),showDialog=this.showMultiformDialog2,attributeIds="",a;for(a=0;a<attributes.length;a++){attributeIds+=attributes[a].oid;if(a<attributes.length-1){attributeIds+=",";}}var params={tableID:tableId,selectedAttributeIds:attributeIds};var callback={success:function(res){showDialog(option,tableId,attribute,attributes,isLinked,res,isMultiLinked);},failure:function(res){controller.displayError(mstrmojo.desc(13134,"Cannot retrieve attribute form info.")+res);}};controller.dataService.getAttributeGroupInfo(callback,params);},showMultiformDialog2:function showMultiformDialog2(option,tableId,attribute,attributes,isLinked,res,isMultiLinked){var maps=[],fms=[],fms_used=[],tables=null,allTablesConfig={},config,i,sharedColumns;var columnEqualFn=function(col1,col2){return col1.name===col2.name;};allTablesConfig.tableIds=[tableId];allTablesConfig.tables={};fms=res.agi.fms;fms_used=res.agi.attribute_forms;tables=res.agi.ts;if(option===formsOptions.EDIT_MULTIFORM_ATTRIBUTE&&isLinked&&tables.length>1){sharedColumns=tables[0].maps;for(i=1;i<tables.length;i++){sharedColumns=$HELPER.getCommonElements(sharedColumns,tables[i].maps,columnEqualFn);}if(sharedColumns.length>=2){isMultiLinked=true;}}for(i=0;i<tables.length;i++){var table=tables[i];maps=table.maps;var tid=table.tbid;if(tid!==tableId){allTablesConfig.tableIds.push(tid);}config=mstrApp.getRootController().formsController.populateMFACommand(maps,fms,fms_used,option,isLinked,attribute,attributes,table.tbid,table.tbn,isMultiLinked);allTablesConfig.tables[tid]=config;}mstrApp.getRootController().showDialog(constants.dialogType.multiFormEditor,allTablesConfig);},populateMFACommand:function populateMFACommand(maps,fms,fms_used,option,isLinked,attribute,attributes,tableId,tableName,isMultiLinked){var formMaps=[],idMap=null,idFormId,idFormName,fmsCopy,i,l;idFormId=fms[0].fmid;idFormName=fms[0].fmn;fmsCopy=fms.slice(0);$ARR.forEach(maps,function(map){var idx=$ARR.find(fmsCopy,"fmid",map.fmid);if(idx<0){var idx2=$ARR.find(fms_used,"fmid",map.fmid);if(idx2>=0){fmsCopy.push({fmid:fms_used[idx2].fmid,fmn:fms_used[idx2].fmn,});}else{fmsCopy.push({fmid:map.fmid,fmn:map.fmn||map.name});}}});if(isLinked&&!isMultiLinked){if(fmsCopy[0].fmn==="ID"){fmsCopy.splice(0,1);}}for(i=0,l=maps.length;i<l;i++){var col=maps[i],columnId=col.cmid,name=col.name,formId=col.fmid,flags=col.flags,alias=col.alias,displayForm=col.isdf?"1":"0",atid=col.atid;var idx=$ARR.find(attributes,"did",columnId);if(idx!==-1){name=attributes[idx].alias;}var formMap={columnId:columnId,name:name,formId:formId,displayForm:displayForm,remove:"0",forms:fmsCopy,flags:flags,alias:alias,atid:atid};formMaps.push(formMap);if(formId===idFormId){idMap=formMap;}}var config={};config.formsOption=option;config.tableId=tableId;config.tableName=tableName;config.attribute=attribute;config.attributes=attributes;config.isShared=isLinked;config.isMultiLinked=isMultiLinked;config.formMaps=formMaps;config.idMap=idMap;config.idFormId=idFormId;config.idFormName=idFormName;if(isLinked){var linkedColumnId=mstrApp.getRootController().formsController.getLinkedColumnId(attribute,attributes,idFormId);if(linkedColumnId){config.linkedColumnId=linkedColumnId;}}return config;},showUnlinkError:function showUnlinkError(){var controller=mstrApp.getRootController();controller.displayError(mstrmojo.desc(13396,"Unlink the Attribute that you want to use as the Non-ID form."));},showCreateMFAError:function showCreateMFAError(){var controller=mstrApp.getRootController();controller.displayError(mstrmojo.desc(14451,"Unable to create Multi-form attribute since the selected attributes are not present in all tables."));},updateMapping:function updateMapping(option,tableId,attribute,attributes,isLinked,formMaps,idMap,callback){switch(option){case formsOptions.ADDTO_MULTIFORM_ATTRIBUTE:this.updateMappingAddtoMultiformAttribute(tableId,attribute,attributes,isLinked,formMaps,idMap,callback,514);break;case formsOptions.CREATE_MULTIFORM_ATTRIBUTE:this.updateMappingCreateMultiformAttribute(tableId,attribute,isLinked,formMaps,idMap,callback,514,attributes);break;case formsOptions.EDIT_MULTIFORM_ATTRIBUTE:this.updateMappingEditMultiformAttribute(tableId,attribute,attributes,isLinked,formMaps,idMap,callback,640);break;}},updateMappingAddtoMultiformAttribute:function updateMappingAddtoMultiformAttribute(tableId,attribute,attributes,isLinked,formMaps,idMap,callback,flags){this.updateMappingSourceTable(tableId,false,attribute.oid,attribute.alias,formMaps,idMap,callback,flags,attributes);},updateMappingCreateMultiformAttribute:function updateMappingCreateMultiformAttribute(tableId,attribute,isLinked,formMaps,idMap,callback,flags,attributes){if(isLinked){this.updateMappingSourceTable(tableId,true,attribute.oid,attribute.alias,formMaps,idMap,callback,flags,attributes);}else{this.updateMappingSourceTable(tableId,true,"",attribute.alias,formMaps,idMap,callback,flags,attributes);}},updateMappingEditMultiformAttribute:function updateMappingEditMultiformAttribute(tableId,attribute,attributes,isLinked,formMaps,idMap,callback,flags){this.updateMappingSourceTable(tableId,false,attribute.oid,attribute.alias,formMaps,idMap,callback,flags);},updateMappingSourceTable:function updateMappingSourceTable(tableId,newAttribute,attributeId,attributeName,formMaps,idMap,callback,flags,attributes){if(newAttribute){attributeId="";}var formMapsColumnIds="",formMapsFormIds="",formMapsDisplayForms="",formMapsRemoves="",formMapsRemoveGeoRoleFlags="",formMapsRemoveTimeRoleFlags="",formMapsRemoveDeriveFlags="",i,hierarchyMaps,relationTableId,recursiveAttr,mapping,idAttr=attributes?$ARR.find(attributes,"columnId",idMap.columnId):-1,model=mstrApp.getRootController().getModel();for(i=0;i<formMaps.length;i++){formMapsColumnIds+=formMaps[i].columnId;if(i<formMaps.length-1){formMapsColumnIds+=",";}formMapsFormIds+=formMaps[i].formId;if(i<formMaps.length-1){formMapsFormIds+=",";}formMapsDisplayForms+=formMaps[i].displayForm;if(i<formMaps.length-1){formMapsDisplayForms+=",";}formMapsRemoves+=formMaps[i].remove;if(i<formMaps.length-1){formMapsRemoves+=",";}var flag=formMaps[i].flags;if((flag&constants.formMappingFlag.formMappingFlagRemoveGeoRole)===constants.formMappingFlag.formMappingFlagRemoveGeoRole){formMapsRemoveGeoRoleFlags+="1";}else{formMapsRemoveGeoRoleFlags+="0";}if(i<formMaps.length-1){formMapsRemoveGeoRoleFlags+=",";}if((flag&constants.formMappingFlag.formMappingFlagRemoveTimeRole)===constants.formMappingFlag.formMappingFlagRemoveTimeRole){formMapsRemoveTimeRoleFlags+="1";}else{formMapsRemoveTimeRoleFlags+="0";}if(i<formMaps.length-1){formMapsRemoveTimeRoleFlags+=",";}if((flag&constants.formMappingFlag.formMappingFlagRemoveDeriveFlags)===constants.formMappingFlag.formMappingFlagRemoveDeriveFlags){formMapsRemoveDeriveFlags+="1";}else{formMapsRemoveDeriveFlags+="0";}if(i<formMaps.length-1){formMapsRemoveDeriveFlags+=",";}}if(newAttribute){formMapsRemoveGeoRoleFlags=generateRemoveGeoRoleFlags(attributes,formMaps);}else{var subCols=getItemPropFromArray(attributes,"isMultiForm","subColumns",true);formMapsRemoveGeoRoleFlags=generateRemoveGeoRoleFlags(attributes,formMaps,subCols);}var params={newAttribute:newAttribute,tableId:tableId,attributeId:attributeId,attributeName:attributeName,idMapColumnId:idMap.columnId,idMapFormId:idMap.formId,idMapDisplayForm:idMap.displayForm,formMapsColumnIds:formMapsColumnIds,formMapsFormIds:formMapsFormIds,formMapsDisplayForms:formMapsDisplayForms,formMapsRemoves:formMapsRemoves,formMapsRemoveGeoRoleFlags:formMapsRemoveGeoRoleFlags,formMapsRemoveTimeRoleFlags:formMapsRemoveTimeRoleFlags,formMapsRemoveDeriveFlags:formMapsRemoveDeriveFlags,};if(idAttr>=0&&attributes[idAttr].recursive){recursiveAttr=attributes[idAttr];model.set("hierarchyMFA",true);params.recursive="1";hierarchyMaps=model.getHierarchyRdcs(recursiveAttr.oid);relationTableId=model.getHierarchyRelationTabele(recursiveAttr.oid);mapping={tbid:relationTableId,mapping:$HELPER.getHierarchyMappingXML(null,hierarchyMaps)};model.set("hierarchyMFAMapping",JSON.stringify(mapping));}if(flags!==undefined){params.formMapsFlags=flags;}var controller=mstrApp.getRootController();var me=this;var updateMappingSourceTableCallback={success:function(res){var model=controller.model;var source=model.getImportSource(tableId);source.invalidPreview();if(source.canAutoMappingAndDetectRelation()){controller.dataService.detectRelationshipSourceTable(callback||me.onRSDetected,{did:tableId});}else{if(callback&&callback.success){callback.success(res);}else{me.onRSDetected.success(res);}}},failure:function(res){var controller=mstrApp.getRootController();controller.displayError(mstrmojo.desc(13136,"Cannot remap columns. "),false,res.message);}};controller.dataService.updateMappingSourceTable(updateMappingSourceTableCallback,params);},onRSDetected:{success:function(res){var controller=mstrApp.getRootController();controller.dataService.set("messageID",res.msgid);var flags=constants.requestFlag.mapping|constants.requestFlag.sourceInfo|constants.requestFlag.relationship;controller.getImportedDataEMMA(constants.actions.none,flags);},failure:function(){var controller=mstrApp.getRootController();controller.displayError(mstrmojo.desc(13136,"Cannot remap columns."));}}});}());