(function(){mstrmojo.requiresCls("mstrmojo.dom","mstrmojo.array","mstrmojo.css","mstrmojo.vi.ui.rw._IsMultiselectXtab");var $D=mstrmojo.dom,$CSS=mstrmojo.css;function renderingCleanUp(){var timer=this._outlineRenderTimer;if(timer){self.clearInterval(timer);delete this._outlineRenderTimer;this.renderingRows=false;}}function startLoadingNextPageForGrid(grid,pageNum,table,iDepth,iRow,expandToLevel,expand){var me=this,id=this.id;this.renderingRows=true;this._outlineRenderTimer=self.setInterval(function(){try{if(!grid){return ;}var pages=[],stat=grid.pageStatus[pageNum],numRowsToDownload=0,rpp=grid.rowsPerPage;if(!stat||!stat.filled){pages.push({idx:pageNum,fill:true});}if(pages.length>0){grid.preRenderPages();grid.renderPages(pages);grid.postRenderPages();grid._postPagesClearup=true;}else{if(grid._postPagesClearup){grid.postRenderPagesCleanup();grid.configureActions();grid._postPagesClearup=false;}renderingCleanUp.call(me);if(grid.isRenderingComplete()){grid.postRenderingCleanup();}if(expandToLevel){pageNum++;if(grid.pageStatus[pageNum]){startLoadingNextPageForGrid.call(me,grid,pageNum,table,iDepth,iRow,expandToLevel);}else{collapseCleanUp.call(me);me.domNode.style.visibility="visible";}}else{if(expand){preShowRows.call(me,table,iDepth,iRow,expand);}else{preHideRows.call(me,table,iDepth,iRow,expand);}}}}catch(ex){renderingCleanUp.call(me);throw ex;}},grid.renderPause);}function refreshClonedNodesLocal(){var sb=this.scrollboxNode;if(!this.heightLimit){sb.style.height=sb.firstChild.offsetHeight+(sb.offsetHeight-sb.clientHeight)+"px";}var xtabClonedNodes=this.xtabClonedNodes,idx;for(idx in xtabClonedNodes){xtabClonedNodes[idx].refreshNode();}this._adjustClipSize();this.alignLockNodes(this.scrollboxLeft,this.scrollboxTop);}function triggerOnScroll(){var grid=this.getTargetZone();if(grid&&grid.onscroll){grid.onscroll();}}function collapseCleanUp(){$CSS.removeClass(this.domNode,"outlineBusyCursor");var sb=this.scrollboxNode;if(!this.heightLimit){sb.style.height=sb.firstChild.offsetHeight+(sb.offsetHeight-sb.clientHeight)+"px";this.refreshResizeHandlers();}if(!this.widthLimit){this.scrollboxNode.firstChild.style.position="relative";this.onGridWidthChanged();}if(this.scrollboxHeightFixed){refreshClonedNodesLocal.call(this);this._refreshClonedNodes();}this.refreshResizeHandlers();triggerOnScroll.call(this);this.updateScrollbars&&this.updateScrollbars();}function changeImageState(imgElem,markedAsCollapsed){if(!imgElem){return ;}if(markedAsCollapsed){imgElem.className="icon-outline-span outline-expand";imgElem.setAttribute("collapsed",true);}else{imgElem.className="icon-outline-span outline-collapse";imgElem.setAttribute("collapsed",false);}}function isAllPagesLoaded(){if(this.allPagesLoaded){return true;}var i=0,pageStatus=this.children[0].pageStatus,length=pageStatus.length;for(i=0;i<length;i++){if(!pageStatus[i].filled){return false;}}this.allPagesLoaded=true;var tableNode=this.getTargetZone().tableNode,rows=tableNode.rows,maxLevel=this.gridData.maxLevel,idxDepth,rowDepth,outlineIconElement;length=rows.length;initializeIndividualCollapseCount.call(this,maxLevel,true);for(i=0;i<length;i++){outlineIconElement=rows[i].getElementsByClassName("icon-outline-span")[0];rowDepth=(outlineIconElement&&parseInt(outlineIconElement.getAttribute("dpt"),10))||0;if(rowDepth>0){rowDepth=parseInt(outlineIconElement.getAttribute("dpt"),10);idxDepth="depth"+(rowDepth-1);this.maxIndividualCollapseCount[idxDepth]+=1;if(outlineIconElement.getAttribute("collapsed")==="true"){this.individualCollapseCount[idxDepth]+=1;}}}return true;}function markRowAsCollapsed(outlineIconElement){outlineIconElement.setAttribute("collapsed","true");outlineIconElement.className="icon-outline-span outline-expand";}function preHideRows(table,iDepth,iRow,expand){var rows=table.rows,len=rows.length,grid=this.getTargetZone(),row,rowDepth,i,nextPageToLoad=0,needLoadNextPage=true;for(i=iRow+1;i<len;i++){row=rows[i];rowDepth=parseInt(row.getAttribute("level"),10);if(isNaN(rowDepth)){nextPageToLoad=parseInt(row.parentElement.getAttribute("n")||1,10);if((iRow===i-1)&&grid.pageStatus[nextPageToLoad].filled===true){i++;}break;}if(rowDepth<=iDepth){nextPageToLoad=parseInt(row.parentElement.getAttribute("n")||0,10)+1;if(nextPageToLoad<grid.totalPages&&grid.pageStatus[nextPageToLoad].filled){needLoadNextPage=false;}delete this.outlineState.collapseToLevel;break;}}if(i===len){nextPageToLoad=parseInt(rows[len-1].parentElement.getAttribute("n")||0,10)+1;if(nextPageToLoad<grid.totalPages&&grid.pageStatus[nextPageToLoad].filled===true){nextPageToLoad++;}}if(needLoadNextPage&&nextPageToLoad<grid.totalPages){startLoadingNextPageForGrid.call(this,grid,nextPageToLoad,table,iDepth,i-1,false,expand);}else{showHideRows.call(this,table,iDepth,this.startCollapseRowIndex||iRow,expand);if(this.isAutoTableLayout()){refreshClonedNodesLocal.call(this);}delete this.startCollapseRowIndex;delete this.outlineState.collapseToLevel;}}function preShowRows(table,iDepth,iRow,expand){var rows=table.rows,len=rows.length,grid=this.getTargetZone(),row,rowDepth,i,nextPageToLoad=grid.pageStatus.length,needLoadNextPage=true;for(i=iRow+1;i<len;i++){row=rows[i];rowDepth=parseInt(row.getAttribute("level"),10);if(isNaN(rowDepth)){nextPageToLoad=parseInt(row.parentElement.getAttribute("n")||1,10);if(grid.pageStatus[nextPageToLoad].filled===true){grid.pageStatus[nextPageToLoad].filled=false;i++;}break;}if(rowDepth<=iDepth){nextPageToLoad=parseInt(row.parentElement.getAttribute("n")||0,10)+1;if(nextPageToLoad<grid.totalPages&&grid.pageStatus[nextPageToLoad].filled){needLoadNextPage=false;}delete this.outlineState.collapseToLevel;break;}}if(needLoadNextPage&&nextPageToLoad<grid.totalPages){startLoadingNextPageForGrid.call(this,grid,nextPageToLoad,table,iDepth,i-1,false,expand);}else{showHideRows.call(this,table,iDepth,this.startCollapseRowIndex||iRow,expand);if(this.isAutoTableLayout()){refreshClonedNodesLocal.call(this);}delete this.startCollapseRowIndex;delete this.outlineState.collapseToLevel;}}function showHideRows(table,iDepth,iRow,expand){var me=this,rows=table.rows,len=rows.length,row,stickedTableRow,rowDepth,i,j,cssClass="outlineMode "+(expand?"":" hiddenRow"),tableNodes=me.getStickedTableNodes(),grid=me.children[0],outlineState=this.outlineState,outlineIconElement,ei,rowsPerPage=grid.rowsPerPage;for(i=iRow+1;i<len;i++){row=rows[i];rowDepth=parseInt(row.getAttribute("level"),10);if(rowDepth<=iDepth){break;}if(expand&&rowDepth>iDepth+1){continue;}row.className=cssClass;ei=row.getAttribute("ei");outlineIconElement=row.getElementsByClassName("icon-outline-span")[0];if(!expand){outlineState[ei]={expanded:false,hidden:true};if(outlineIconElement&&outlineIconElement.getAttribute("collapsed")!=="true"){me.individualCollapseCount["depth"+(rowDepth-1)]+=1;markRowAsCollapsed(outlineIconElement);}}else{outlineState[ei]={expanded:false,hidden:false};}for(j=0;j<tableNodes.length;j++){stickedTableRow=tableNodes[j].rows[i];if(stickedTableRow){stickedTableRow.className=cssClass;if(!expand){outlineIconElement=stickedTableRow.getElementsByClassName("icon-outline-span")[0];if(outlineIconElement){markRowAsCollapsed(outlineIconElement);}}}}}collapseCleanUp.call(me);var dptLevel="depth"+(iDepth-1);if(isAllPagesLoaded.call(me)){if(me.individualCollapseCount[dptLevel]===0){setCollapseStatusForAllHeaderNodes.call(me,iDepth+1,true);}else{if(!expand&&this.maxIndividualCollapseCount[dptLevel]===this.individualCollapseCount[dptLevel]){setCollapseStatusForHeaderNodes.call(me,iDepth);}}}var w=mstrmojo.findAncestor(this,"adjustAutoWidth",null,mstrmojo.grid);if(w){w.adjustAutoWidth(this);}}function setCollapseStatusForAllHeaderNodes(expandToLevel,isExpanding){if(!this.gridData.gts.show){return ;}var tableNode=this.getTargetZone().tableNode,tableNodes=this.getStickedTableNodes(),expandedLevel=expandToLevel-1,outlineIconElement,i;tableNodes.push(tableNode);mstrmojo.array.forEach(tableNodes,function(table){var spanElems=table.rows[0].getElementsByClassName("icon-outline-span");for(i=0;i<spanElems.length;i++){outlineIconElement=spanElems[i];if(i<expandedLevel){outlineIconElement.setAttribute("collapsed",0);$CSS.removeClass(outlineIconElement,"outline-expand");$CSS.addClass(outlineIconElement,"outline-collapse");}else{if(!isExpanding){outlineIconElement.setAttribute("collapsed",1);$CSS.removeClass(outlineIconElement,"outline-collapse");$CSS.addClass(outlineIconElement,"outline-expand");}}}});}function setCollapseStatusForHeaderNodes(expandToLevel){if(expandToLevel===this.gridData.maxLevel){return ;}var dptLevel="depth"+(expandToLevel-1);if(this.individualCollapseCount[dptLevel]===this.maxIndividualCollapseCount[dptLevel]){setCollapseStatusForAllHeaderNodes.call(this,expandToLevel);}else{setCollapseStatusForHeaderNodes.call(this,expandToLevel+1);}}function initializeIndividualCollapseCount(level,resetMaxCounts){var gd=this.gridData,maxLevel=gd.maxLevel||(gd.gts&&gd.gts.row&&gd.gts.row.length)||0,idxDepth,i;for(i=0;i<maxLevel;i++){idxDepth="depth"+i;if(resetMaxCounts){this.maxIndividualCollapseCount[idxDepth]=0;}if(i>=level){this.individualCollapseCount[idxDepth]=this.maxIndividualCollapseCount[idxDepth];}else{this.individualCollapseCount[idxDepth]=0;}}}function getStartIndexForCollapsableRows(){var gridData=this.gridData,index=gridData.gts.show?1:0;if(gridData.gts.col&&gridData.gts.col.length>1){index=gridData.gts.col.length;}return index;}function clearOutlineState(){this.outlineState={};if(mstrApp.outlineStates[this.id]){delete mstrApp.outlineStates[this.id];}}function setUpRetainState(){this.retainOutlineState=true;if(!mstrApp.outlineStates[this.id]){mstrApp.outlineStates[this.id]=this.outlineState;}}mstrmojo.vi.ui.rw._IsOutlineXtab=mstrmojo.provide("mstrmojo.vi.ui.rw._IsOutlineXtab",{_mixinName:"mstrmojo.vi.ui.rw._IsOutlineXtab",onclick:function onclick(evt){var me=this,target=evt.getTarget&&evt.getTarget(),clickedCell=target&&$D.findAncestorByName(target,"td",true,this.viewport),outlineIconElement=clickedCell&&$D.findAncestorByName(target,"span",true,clickedCell),expandToLevel=outlineIconElement&&parseInt(outlineIconElement.getAttribute("expandTo"),10);if(outlineIconElement&&(outlineIconElement.getAttribute("sty")==="outimg"||expandToLevel>=1)){var row=clickedCell.parentElement;if(outlineIconElement&&!evt.shiftKey&&!evt.ctrlKey){var tableNode=this.getTargetZone().tableNode;if(this.renderingRows){return ;}if(expandToLevel>=1){clearOutlineState.call(this);this.scrollboxNode.scrollTop=0;var gridData=this.gridData,ds=me.model.getDataService(),isCollapsed=parseInt(outlineIconElement.getAttribute("collapsed"),10)||0;expandToLevel+=isCollapsed?1:0;setCollapseStatusForAllHeaderNodes.call(this,expandToLevel);gridData.lvlepd=expandToLevel=expandToLevel<gridData.maxLevel?expandToLevel:-1;ds.setOutlineExpanding({unitKey:me.node.k||me.node.data.k,outlineLevel:expandToLevel});window.setTimeout(function(){me.refresh();},10);}else{if(outlineIconElement.getAttribute("sty")==="outimg"){$CSS.addClass(this.domNode,"outlineBusyCursor");var iDepth=parseInt(outlineIconElement.getAttribute("dpt"),10),expand=target.getAttribute("collapsed")==="true",ei=row.getAttribute("ei");this.outlineState[ei]={expanded:expand,hidden:false};if(expand){target.className="icon-outline-span outline-collapse";target.setAttribute("collapsed","false");this.individualCollapseCount["depth"+(iDepth-1)]-=1;window.setTimeout(function(){me.outlineState.isExpanding=true;me.outlineState.collapseToLevel=iDepth+1;me.startCollapseRowIndex=row.rowIndex;preShowRows.call(me,tableNode,iDepth,row.rowIndex,true);},10);}else{target.className="icon-outline-span outline-expand";target.setAttribute("collapsed","true");this.individualCollapseCount["depth"+(iDepth-1)]+=1;window.setTimeout(function(){me.outlineState.isExpanding=false;me.outlineState.collapseToLevel=iDepth;me.startCollapseRowIndex=row.rowIndex;preHideRows.call(me,tableNode,iDepth,row.rowIndex,false);},10);}}}}}else{this._super(evt);}},refresh:function refresh(postUnrender,isResize){var me=this;if(isResize){var zone=this.getTargetZone(),tableNode=zone&&zone.tableNode,gd=this.gridData;if(!gd||!zone||!tableNode){return this._super(postUnrender);}var formats=this.getFormats(),containerNode=zone.gridContainerNode,clonedXtabNodes=this.xtabClonedNodes||[],width=(formats&&formats.width)||containerNode.style.width,height=(formats&&formats.height)||this.scrollboxNode.style.height,widthSize=parseInt(width,10);if(gd.afc){widthSize=Math.max(tableNode.offsetWidth,widthSize);}containerNode.style.width=widthSize+"px";mstrmojo.array.forEach(clonedXtabNodes,function(clonedXtab){if(clonedXtab.domNode){clonedXtab.domNode.firstChild.style.width=widthSize+"px";}});this.widthLimit=widthSize;this.heightLimit=parseInt(height,10);this.scrollboxNode.style.height=height;this.resize();this.updateScrollbars();return ;}if(!this.retainOutlineState){clearOutlineState.call(this);}else{this.retainOutlineState=false;}this._super(postUnrender);},postBuildRendering:function postBuildRendering(){var gd=this.gridData;this.isOutlineMode=(gd&&gd.olm&&!(gd.rw&&gd.rw.row.bc>0)&&!this.defn.txi);if(!mstrApp.outlineStates){mstrApp.outlineStates=[];}if(mstrApp.outlineStates[this.id]){this.outlineState=mstrApp.outlineStates[this.id];}else{if(!this.outlineState){this.outlineState={};}}this._super();var zone=this.getTargetZone(),tableNode=zone&&zone.tableNode;if(!gd||!zone||!tableNode){return ;}var lvlepd=gd.lvlepd||0,maxLevel=gd.maxLevel||(gd.gts&&gd.gts.row&&gd.gts.row.length)||0,needCollapse=gd.olm&&!(gd.rw&&gd.rw.row.bc>0)&&(lvlepd>=1&&lvlepd<maxLevel);this.allPagesLoaded=false;this.individualCollapseCount={};this.maxIndividualCollapseCount={};initializeIndividualCollapseCount.call(this,maxLevel,true);if(needCollapse){zone._defaultPageHeight=Math.min(tableNode.tBodies[0].offsetHeight,zone._defaultPageHeight);zone.gridContainerNode.style.minHeight=zone._defaultPageHeight*zone.totalPages+"px";setCollapseStatusForAllHeaderNodes.call(this,lvlepd);this.scrollboxNode.scrollTop=0;triggerOnScroll.call(this);}},gridPagesRendered:function gridPagesRendered(){this._super();if(isAllPagesLoaded.call(this)&&!this.outlineState.isExpanding){setCollapseStatusForHeaderNodes.call(this,1);}},isOutlineMode:true,showBanding:function showBanding(show){setUpRetainState.call(this);this._super(show);},formatGridZone:function formatGridZone(zone,formats,extra){setUpRetainState.call(this);this._super(zone,formats,extra);},batchFormatGridZones:function formatGridZones(zones,formats,extra){setUpRetainState.call(this);this._super(zones,formats,extra);},formatPadding:function formatPadding(horizontal,vertical,extra){setUpRetainState.call(this);this._super(horizontal,vertical,extra);},updateRelatedColWidths:function updateRelatedColWidths(colWidths){setUpRetainState.call(this);this._super(colWidths);},updateScenario:function updateScenario(scenario){setUpRetainState.call(this);this._super(scenario);}});}());