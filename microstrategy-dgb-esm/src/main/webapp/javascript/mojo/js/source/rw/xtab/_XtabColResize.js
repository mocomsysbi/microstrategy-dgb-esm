(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.hash","mstrmojo.dom","mstrmojo.num","mstrmojo._HasOwnAvatar","mstrmojo.XtabBase","mstrmojo.models.template.DataInterface");var $A=mstrmojo.array,$DOM=mstrmojo.dom,$N=mstrmojo.num,$CFG=mstrConfig,$PX="px",CLASS_XTAB_RESIZE="xrsz",NODE_ATTR_TYPE="t",HANDLE_WIDTH_BUFFER=3,ENUM_LOCKED_HEADERS=mstrmojo.XtabBase.EnumLockedHeaders,LOCK_ROW=ENUM_LOCKED_HEADERS.ROW,LOCK_BOTH=ENUM_LOCKED_HEADERS.BOTH;function getTemplateUnits(){var gridTitlesData=this.gridData.gts;return gridTitlesData.row.concat(gridTitlesData.col);}function getIndexBasedWidthModel(){var gridData=this.gridData,lockedHeaderCase=this.lockHeadersCase,gridTitlesData=gridData.gts,gridHeaders=gridData.ghs,rhs=gridHeaders.rhs||[],chs=gridHeaders.chs||[],rowHeaderWidths=rhs.cws||[],topWidths=(gridTitlesData.cws||[]).concat(chs.cws||[]),gvs=gridData.gvs||[],bottomWidths=rowHeaderWidths.concat(gvs.cws||[]),rowNodes=this.zone.domNode.getElementsByTagName("tr"),lastRow=rowNodes&&rowNodes[rowNodes.length-1],isColumnNoWidth=false,isOutlineMode=this.isOutlineMode;if(lastRow){var cell=lastRow.getElementsByTagName("td")[0];gridData.xrh=(cell&&cell.offsetHeight)||0;}isColumnNoWidth=$A.some(rowHeaderWidths,function(rowHeaderWidth){return rowHeaderWidth.w==="";});if(gridData.afw||gridData.afc||isColumnNoWidth){var resizeHandlesMap=this.rszmap;if(window.neeHandlingForSvgImgs){neeHandlingForSvgImgs(this.zone.domNode);}var expectedColumns=Math.max(topWidths.length,bottomWidths.length);$A.forEach(rowNodes,function(trNode){var columnNodes=trNode.childNodes;if(columnNodes.length===expectedColumns||isOutlineMode){var topIndex=bottomIndex=0;$A.forEach(trNode.getElementsByTagName("td"),function(tdNode,i){var width=$DOM.position(tdNode).w;var columns=parseInt(tdNode.colSpan,10),eachWidth=width/columns;if(topWidths[topIndex]&&tdNode.offsetParent!==null){if(!tdNode.colSpan||tdNode.colSpan===1){topWidths[topIndex++].w=width+$PX;}else{for(var j=0;j<columns;j++){if(!topWidths[topIndex]){topWidths[topIndex]={};}topWidths[topIndex].w=eachWidth+$PX;topIndex=topIndex+1;}}}if(bottomWidths[bottomIndex]&&tdNode.offsetParent!==null){if(!tdNode.colSpan||tdNode.colSpan===1){bottomWidths[bottomIndex++].w=width+$PX;}else{for(var j=0;j<columns;j++){if(!bottomWidths[bottomIndex]){bottomWidths[bottomIndex]={};}bottomWidths[bottomIndex].w=eachWidth+$PX;bottomIndex=bottomIndex+1;}}}});return false;}});}if(bottomWidths.length!==topWidths.length){var templateUnits=getTemplateUnits.call(this);$A.forEach(templateUnits,function(templateUnit,idx){var forms=templateUnit.fs,formCount=(forms&&forms.length)||0;if(formCount>1){var currentWidth=topWidths[idx],formIdx;for(formIdx=0;formIdx<formCount-1;formIdx++){topWidths.splice(idx+formIdx+1,0,currentWidth);}}});if(bottomWidths.length>topWidths.length){topWidths.push(bottomWidths[bottomWidths.length-1]);}}return{top:topWidths,bottom:bottomWidths};}function createResizeHandles(){var gridData=this.gridData,isOutlineMode=this.isOutlineMode,outlineModeBuffer=isOutlineMode?2:0;if(!gridData.gts.show&&isOutlineMode&&mstrApp.isExpress){return ;}var resizeHandleMap=this.rszmap=[],leftPos=0,offsetLeft=0,indexBasedWidthModel=gridData.twm=getIndexBasedWidthModel.call(this),colWidths=indexBasedWidthModel.bottom,templateInterface=new mstrmojo.models.template.DataInterface(gridData),columnHeaders=templateInterface.getColumnHeaderData(true),resizeColumnCount=columnHeaders.length;var tempWidth=0;$A.forEach(colWidths,function(colWidth,index){if(index>=resizeColumnCount){return false;}var width=parseInt(colWidth.w,10);if(isNaN(width)){return false;}if(isOutlineMode&&columnHeaders&&columnHeaders[index]&&columnHeaders[index+1]&&columnHeaders[index].id===columnHeaders[index+1].id&&!columnHeaders[index]._ridx){tempWidth=tempWidth+width;}else{tempWidth=tempWidth+width;leftPos+=tempWidth;offsetLeft+=tempWidth;if(index===resizeColumnCount-1){leftPos=leftPos-1-outlineModeBuffer;offsetLeft=offsetLeft-1-outlineModeBuffer;}resizeHandleMap.push({left:leftPos,offsetLeft:offsetLeft});tempWidth=0;}});$A.forEach(resizeHandleMap,function(resizeColInfo,idx){var nextLeftObj=resizeHandleMap[idx+1],nextLeft=(nextLeftObj&&nextLeftObj.left),nextWidth=(nextLeft-resizeColInfo.left),handleNodes=[this.zone.domNode],clonedColGrid=this.getColClonedZone&&this.getColClonedZone();if(clonedColGrid){handleNodes.push(clonedColGrid);}if(!nextLeftObj||(nextWidth>(HANDLE_WIDTH_BUFFER*2))){$A.forEach(handleNodes,function addHandle(parentNode){var div=document.createElement("div"),divNodeStyle=div.style,me=this;div.setAttribute("idx",String(idx));div.setAttribute(NODE_ATTR_TYPE,CLASS_XTAB_RESIZE);div.className=CLASS_XTAB_RESIZE+((idx>0&&resizeHandleMap[idx-1].skipped)?" zero":"");divNodeStyle.left=isNaN(resizeColInfo.offsetLeft)?"":((resizeColInfo.offsetLeft-HANDLE_WIDTH_BUFFER)+$PX);parentNode.appendChild(div);div.ondblclick=function(evt){me.onHandleDblClick(evt);};},this);}else{resizeColInfo.skipped=true;}},this);}function cleanResizeHandler(domNode){if(!domNode){return ;}var handlerNodes=domNode.getElementsByClassName(CLASS_XTAB_RESIZE),i=handlerNodes.length-1;for(;i>-1;i--){domNode.removeChild(handlerNodes[i]);}}function copyResizeHandlerNodes(fromNode,ToNode){var handlerNodes=fromNode.getElementsByClassName(CLASS_XTAB_RESIZE),i=0;for(i=0;i<handlerNodes.length;i++){ToNode.appendChild(handlerNodes[i].cloneNode());}}mstrmojo.rw.xtab._XtabColResize=mstrmojo.provide("mstrmojo.rw.xtab._XtabColResize",{_mixinName:"mstrmojo.rw.xtab._XtabColResize",rszmap:undefined,onRender:function onRender(){if(this._super){this._super();}if(this.gridData.eg!==undefined){return ;}var $this=this;var delayMeasureColumn=mstrApp&&$DOM.isMac()&&mstrApp.getWSLiveMode&&mstrApp.getWSLiveMode();window.setTimeout(function(){if(!$this.hasRendered){return ;}if(!mstrApp.isExpress||mstrApp.features["grid-layout"]){createResizeHandles.call($this);}$this.raiseEvent({name:"xtabColsMeasured"});},delayMeasureColumn?500:0);$DOM.attachMarkupEvent(this.id,this.domNode,"mousedown");},unrender:function unrender(ignoreDom){$DOM.detachEvent(this.domNode,"mousedown",mstrmojo.emptyFn);this._super(ignoreDom);},refreshResizeHandlers:function refreshResizeHandlers(){if(!mstrApp.isExpress||mstrApp.features["grid-layout"]){cleanResizeHandler(this.getTargetZone().domNode);cleanResizeHandler(this.getColClonedZone&&this.getColClonedZone());createResizeHandles.call(this);if(this.clonedRowHeader&&this.clonedRowHeader.domNode){cleanResizeHandler(this.clonedRowHeader.domNode.firstChild);copyResizeHandlerNodes(this.getTargetZone().domNode,this.clonedRowHeader.domNode.firstChild);}if(this.clonedTitle&&this.clonedTitle.domNode){cleanResizeHandler(this.clonedTitle.domNode.firstChild);copyResizeHandlerNodes(this.getTargetZone().domNode,this.clonedTitle.domNode.firstChild);}}},gridPagesRendered:function gridPagesRendered(){this.refreshResizeHandlers();if(this._super){this._super();}},isColResizeNode:function isColResizeNode(node){return(node.className||"").indexOf(CLASS_XTAB_RESIZE)>=0;},isDragValid:function isDragValid(context){return this.isColResizeNode(context.src.node)||(this._super&&this._super(context))||false;},ondragstart:function ondragstart(context){if(this.isColResizeNode(context.src.node)){var domNodePosition=$DOM.position(this.domNode),sourceData=$DOM.findAncestorByAttr(context.src.node,"idx",true,this.domNode),index=sourceData&&parseInt(sourceData.value,10),resizeHandleMap=this.rszmap,originalWidth=resizeHandleMap[index].left-(index>0?resizeHandleMap[index-1].left:0),previousHandlerPosition=Math.max(domNodePosition.x,(context.src.pos.x-originalWidth)),templateInterface=new mstrmojo.models.template.DataInterface(this.gridData),gridData=this.gridData,isOutlineMode=this.isOutlineMode,rowNodes=this.zone.domNode.getElementsByTagName("tr");if(isOutlineMode){var headerRow=rowNodes[0],tdNodes=headerRow.getElementsByTagName("td"),indexTemp=0;$A.forEach(tdNodes,function(tdNode,i){var columns=parseInt(tdNode.colSpan,10)||1;if(i<=index){indexTemp=i>0?indexTemp+1:indexTemp;indexTemp=indexTemp+columns-1;}else{return false;}});index=indexTemp;}this.rszData={idx:index,originalWidth:originalWidth,min:previousHandlerPosition,max:domNodePosition.x+domNodePosition.w,colName:templateInterface.getColumnHeaderData(true)[index].n};}if(this._super){this._super(context);}this.ignoreHover=true;},ondragmove:function ondragmove(context){if(this.rszData){var resizeDragData=this.rszData,sourcePos=context.src.pos,newWidth=Math.max((resizeDragData.originalWidth+(context.tgt.pos.x-sourcePos.x)),0);this.avatar.firstChild.innerHTML=resizeDragData.colName+" "+(($N.UNIT.PX==$CFG.units)?newWidth:parseFloat($N.convertUnits($N.UNIT.PX,$CFG.units,newWidth)).toFixed(2))+" "+$CFG.unitsLabel;}this._super(context);},ondragend:function ondragend(context){if(this.rszData){var gridData=this.gridData,index=this.rszData.idx,columnsData=(new mstrmojo.models.template.DataInterface(gridData)).getColumnHeaderData(true),selectedHeader=columnsData[index],forms=selectedHeader.fs,formIndex=selectedHeader.fix||1;if(forms&&forms.length>0){formIndex=index-$A.find(columnsData,"id",selectedHeader.id)+1;}var selectedHeaderId=selectedHeader.oid||selectedHeader.id;this.changeColumnWidth(selectedHeaderId,selectedHeader.otp,Math.max((parseInt(getIndexBasedWidthModel.call(this).bottom[index].w,10)+(context.tgt.pos.x-context.src.pos.x)),0),formIndex,(selectedHeaderId===""&&selectedHeader.axis===2));delete this.rszData;}this._super(context);this.ignoreHover=false;},createAvatar:function createAvatar(sourceNode){var div=document.createElement("div"),divStyle=div.style,sourcePos=$DOM.position(sourceNode),domPos=$DOM.position(this.domNode);if(this.isColResizeNode(sourceNode)){this.avatarCssClass=CLASS_XTAB_RESIZE;divStyle.top=domPos.y+$PX;divStyle.left=sourcePos.x+$PX;divStyle.height=domPos.h+$PX;var tooltipCtrNode=document.createElement("div");tooltipCtrNode.className=CLASS_XTAB_RESIZE+"-ttp";var anchorNode=document.createElement("div");anchorNode.className=CLASS_XTAB_RESIZE+"-anchr";div.appendChild(tooltipCtrNode);div.appendChild(anchorNode);}else{delete this.avatarCssClass;}return div;},positionAvatar:function positionAvatar(pos,context){if(this.rszData){var avatar=this.avatar,avatarStyle=avatar.style,resizeDragData=this.rszData;if(!this.avatar||!this.rszData){return ;}avatarStyle.left=Math.min(Math.max(pos.x,resizeDragData.min),resizeDragData.max)+"px";}else{this._super(pos,context);}},isHandleNode:function isHandleNode(node){return !!node&&node.getAttribute&&node.getAttribute(NODE_ATTR_TYPE)===CLASS_XTAB_RESIZE;},onHandleDblClick:mstrmojo.emptyFn});}());