(function(){mstrmojo.requiresCls("mstrmojo.ui.menus.MenuConfig","mstrmojo.ui.menus.EditorConfig","mstrmojo.Box","mstrmojo.Label","mstrmojo.ui.CheckList","mstrmojo.vi.ui.DatasetUnitMenuUtils","mstrmojo.models.datasets.DataInterface","mstrmojo.expr","mstrmojo.array","mstrmojo.VisUtility");mstrmojo.requiresDescs(2031,3945,3946,11505,11571,13629,13630,13860,14595,15952);var $DS_UTILS=mstrmojo.vi.ui.DatasetUnitMenuUtils,$DATASET_INTERFACE=mstrmojo.models.datasets.DataInterface,$DTP=mstrmojo.expr.DTP,$ARR=mstrmojo.array,$VIS_UTILITY=mstrmojo.VisUtility;function forceTwoLineText(text){var MAX_WIDTH=350,fs={fontFamily:"Arial",fontSize:"12px"},editorTextWidth=$VIS_UTILITY.measureTextWidth(text,fs);if(editorTextWidth>MAX_WIDTH){var subStr,subStrWidth,wordEnd=text.indexOf(" "),lastWord=wordEnd;while(wordEnd>-1){subStr=text.substring(0,wordEnd);subStrWidth=$VIS_UTILITY.measureTextWidth(subStr,fs);if(subStrWidth>=MAX_WIDTH){break;}lastWord=wordEnd;wordEnd=text.indexOf(" ",wordEnd+1);}if(wordEnd>-1){text=text.substring(0,lastWord)+"\n"+text.substring(lastWord);}}return text;}function getTargetEditorConfig(itemContext){var cfg,selector=itemContext.selector,targets=itemContext.fn(),currentTargetKeys=targets.keys,targetItems=targets.items,targetList=new mstrmojo.ui.CheckList({cssClass:"units",items:targetItems.map(function(item){item.css=$DS_UTILS.getUnitCssClass(item.src||{});return item;}),onchange:function(){if(cfg){cfg.set("okEnabled",true);}}}),editorText=forceTwoLineText(itemContext.title);targetList.setSelectedItems(targetItems.filter(function(item){return currentTargetKeys.indexOf(item.id)>-1;}));cfg=new mstrmojo.ui.menus.EditorConfig({contents:new mstrmojo.Box({cssClass:"mstrmojo-vi-FilterBox-content",children:[{scriptClass:"mstrmojo.Label",text:editorText},targetList]}),okEnabled:false,data:{},onOpen:function(){targetList.updateScrollbars();},cssClass:"mstrmojo-vi-FilterBox-targets",okBtnText:mstrmojo.desc(2031,"Apply"),fnOk:function(){selector.model.changeFilterTargets(selector,currentTargetKeys,targetList.getSelectedItems().map(function(item){return item.id;}),selector.isInFilterPanel());}});return cfg;}function getUpdateMenuItemValueFunction(selector,property){return function(v,vWas){var wasChanged=v!==vWas;if(wasChanged){selector.set(property,v);}return wasChanged;};}mstrmojo.vi.ui.rw.selectors._HasFilterContextMenu=mstrmojo.provide("mstrmojo.vi.ui.rw.selectors._HasFilterContextMenu",{_mixinName:"mstrmojo.vi.ui.rw.selectors._HasFilterContextMenu",addModeMenuItems:function addModeMenuItems(cfg,selector,fnChangeMode){if(!selector.supportsInclude()){return false;}var fnGetModeMenuItem=function(text,isIncludeItem){var isSelected=selector.include===isIncludeItem;cfg.addMenuItem(text,isSelected?"on":"",function(){if(!isSelected){selector.set("include",isIncludeItem);this.generateToolbar();if(fnChangeMode){fnChangeMode();}}return !isSelected;}.bind(this));}.bind(this);fnGetModeMenuItem(mstrmojo.desc(3945,"Include"),true);fnGetModeMenuItem(mstrmojo.desc(3946,"Exclude"),false);cfg.hasToggleItem=true;cfg.addSeparator();return true;},addShowAllMenuItem:function addShowAllMenuItem(cfg,selector){if(!selector.supportsShowAllToggle()||selector.isAttrQualSelector()||selector.isRecursiveAttributeSelector()||selector.isSearchBox()||mstrApp.isAppStatePresentation&&mstrApp.isAppStatePresentation()){return false;}var menuText=mstrmojo.desc(4741,"Show option for all");if(!selector.include){cfg.addNonInteractiveMenuItem(menuText,"",true);return true;}var fnToggle=function(){var showall=!selector.defn.showall,model=selector.model,propsChangeActions=model.getSelectorPropsChangeAction(selector,{showAll:showall}),actions=propsChangeActions.concat(model.getCtrlActionsByStyleForToggleShowAll(selector,showall));model.submitToggleShowAllActions(selector,actions);};cfg.addToggleMenuItem(menuText,"",fnToggle,fnToggle,this.id,selector.defn.showall);return true;},addClearFilterMenuItem:function addClearFilterMenuItem(cfg,selector,fnClear){cfg.addMenuItem(mstrmojo.desc(14595,"Unset Filter"),"",function(){selector.clearSelector(true);if(fnClear){fnClear();}});return true;},addMenuItemIfSelectTargetsValid:function isSelectTargetsValid(cfg,selector,title){if(!mstrApp.isAppStatePresentation()){var targetInfo=this.getTargetInfo();if(targetInfo.items.length){cfg.addEditorMenuItem(mstrmojo.desc(13629,"Select Targets"),this.id,getTargetEditorConfig,{selector:selector,fn:this.getTargetInfo.bind(this),title:title});}}},addFilterStyleMenuItem:function addFilterStyleMenuItem(cfg,selector){if(mstrApp.isAppStatePresentation()||selector.isSolrSelector()){return false;}var styleList=selector.getSelectorStyleList();if(!styleList.length){return false;}cfg.addSubMenuItem(mstrmojo.desc(11505,"Display Style"),"",this.id,function(){var currentStyle=selector.defn.style,getGetChangeFn=function(newStyle){return function(){if(newStyle!==currentStyle){var aqs=mstrmojo.DocSelector.STYLES.ATTR_QUAL;if(newStyle===aqs||currentStyle===aqs){selector.model.openSelWarnFlag(selector.k);}selector.model.changeFilterStyle(selector,newStyle);}};};var menuCfg=new mstrmojo.ui.menus.MenuConfig();if(selector.isDynamicAttributeSelector()&&selector.expr){menuCfg.useTooltip=true;styleList.forEach(function(style){var styleName=style.n;if(currentStyle!==style.v){styleName=typeof styleName==="object"?styleName.n:styleName;menuCfg.addDisabledMenuItem({n:styleName,ttp:mstrmojo.desc(15952,"Please unset filter selections before switching to the # display style").replace("#",styleName)});}else{menuCfg.addMenuItem(styleName,"on",mstrmojo.emptyFn);}});}else{styleList.forEach(function(style){var itemStyle=style.v;menuCfg.addMenuItem(style.n,currentStyle===itemStyle?"on":"",getGetChangeFn(itemStyle));},this);}menuCfg.hasToggleItem=true;return menuCfg;});return true;},addMultiSelectMenuItem:function addMultiSelectMenuItem(cfg,selector){if(!selector.allowsTogglingMultiSelect()||mstrApp.isAppStatePresentation()){return false;}cfg.addMenuItem(mstrmojo.desc(13860,"Allow Multiple Selections"),selector.multi?"on":"",function(){selector.model.changeFilterStyle(selector,selector.style,!selector.multi,selector.iase);});cfg.hasToggleItem=true;return true;},addAutoSearchMenuItem:function addAutoSearchMenuItem(cfg,selector){if(!selector.allowsTogglingAutoSearch()||mstrApp.isAppStatePresentation()){return false;}cfg.addMenuItem(mstrmojo.desc(15913,"Allow Instant Search"),selector.iase?"on":"",function(){selector.model.changeFilterStyle(selector,selector.style,selector.multi,!selector.iase);});cfg.hasToggleItem=true;return true;},addConfigVisSelectorMenu:function addConfigVisSelectorMenu(cfg,selector){var filterPortlet=this;cfg.addMenuItem(mstrmojo.desc(3224,"Edit..."),"",function(){filterPortlet.closeVisSelectorPanel();var model=selector.model,nodeKey=selector.k;model.checkLargeItemsForVisFilter(nodeKey,function(){var container=model.addVisFilterContainer(),oldSelectedUnit=model.getSelectedViUnit(),vizBox;model.oldSelectedVizBoxId=oldSelectedUnit.id;mstrApp.isInVFConfigMode=true;mstrApp.restoreVFKey=nodeKey;vizBox=model.insertVizBox(nodeKey,container,{});model.controller.rootCtrl.initPanelStautsInConfigMode();model.selectVIUnit(vizBox.id,true,{isAddAction:true});mstrApp.getRootController().enterVizFilterConfigMode(selector.parent.baseTitle,true);});});},addQualMenuItems:function addQualMenuItems(cfg,selector){if(selector.isSolrSelector()||!selector.isMetricSelector()||selector.isRankMetricSelector()||!selector.isNumericMetricSelector()){return false;}cfg.addRadioMenuGroup(selector.qua>0?1:0,getUpdateMenuItemValueFunction(selector,"qua"),[{value:0,text:mstrmojo.desc(11571,"Qualify on Value")},{value:1,text:mstrmojo.desc(13630,"Qualify on Rank")}],"",undefined,true);cfg.addSeparator();return true;},addSetDisplayFormsMenuItem:function addSetDisplayFormsMenuItem(cfg,selector){var dt=selector.node.data.dt;if(!selector.isAttributeSelector()&&!selector.isNewDerivedRecursiveElementSelector()||(selector.isAttrQualSelector()&&(dt===$DTP.DATE||dt===$DTP.TIMESTAMP))){return false;}var model=selector.model,defn=selector.defn,selectedIndices=[],newDEUnit=$DS_UTILS.getUnitFromDataset(model.datasets,defn.srcid,defn.srct),attId=newDEUnit&&newDEUnit.attId,forms=$DATASET_INTERFACE.getFormsByAttrId(attId||defn.srcid,model.datasets);if(selector.isRecursiveAttributeSelector()){forms=$ARR.filter(forms,function(form){return form.fid!=="A9BFF03B4D72CC4F457ACBB4B185E91D"&&form.fnm!=="LEVEL_NUMBER";});}if(forms.length<2){return false;}var customForms=defn.fs;if(!customForms){var fs=[],item=model.getDatasetUnits(["att","mx"],function(it){return it.did===(attId||defn.srcid);})[0]||{};(item.fs||[]).forEach(function(form){if(form.isbf){fs.push({did:form.fid});}});if(fs.length){customForms=fs;}}forms=$ARR.map(forms,function(form,index){var formId=form.fid;if($ARR.find(customForms,"did",formId)!==-1){selectedIndices[index]=true;}return{id:formId,n:form.fnm};});if(mstrmojo.resolveFeature("set-attributeform-display")&&!mstrApp.isAppStatePresentation()){cfg.addPopupMenuItem(mstrmojo.desc(11908,"Display Attribute Forms"),this.id,function(){return new mstrmojo.ui.menus.EditorConfig({cssClass:"displayForms",data:{defn:defn,oldSelectedIndices:selectedIndices.slice()},contents:[{alias:"formCheckList",scriptClass:"mstrmojo.ui.CheckList",minimumSelectCnt:1,items:forms,selectedIndices:selectedIndices.slice()}],fnOk:function fnOk(data,editor){var selectedItems=[],formCheckList=editor.formCheckList,items=formCheckList.items,selectedIndices=formCheckList.selectedIndices,isSelectionChanged=false,i;for(i=0;i<items.length;i++){var oldSelectedIndex=!!data.oldSelectedIndices[i],newSelectedIndex=!!selectedIndices[i];if(oldSelectedIndex!==newSelectedIndex){isSelectionChanged=true;break;}}if(!isSelectionChanged){return ;}$ARR.forEach(selectedIndices,function(selectedIndex,index){if(selectedIndex){selectedItems.push(items[index]);}});model.setFilterDisplayForms(selector,selectedItems);},onOpen:function onOpen(){this.formCheckList.updateScrollbars();}});});}},addReplaceWithMenuItem:function addReplaceWithMenuItem(cfg,selector){var units=selector.getSelectorReplaceUnitList();if(units.length===0){return false;}cfg.addEditorMenuItem(mstrmojo.desc(14003,"Replace with"),"",function(){return new mstrmojo.ui.menus.EditorConfig({data:{},cssClass:"replaceReference",okVisible:false,cancelVisible:false,contents:[{scriptClass:"mstrmojo.ui.ScrollableContainer",children:[{scriptClass:"mstrmojo.vi.ui.InteractiveUnitList",draggable:false,CLS_HAS_MENU:"",items:selector.getSelectorReplaceUnitList(),listHooks:{select:function select(el,unit){if(selector.isInFilterPanel()){selector.model.replaceFilterStackSelectors(selector.defn,unit);}else{selector.model.replaceFilter(selector,unit);}}}}]}]});});return true;},getTargetInfo:function getTargetInfo(){this.throwAbstractMethodError("getTargetInfo");}});}());