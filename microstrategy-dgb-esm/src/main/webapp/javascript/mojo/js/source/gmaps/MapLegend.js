(function(){mstrmojo.requiresCls("mstrmojo.gm.GMLegend","mstrmojo.dom","mstrmojo.css","mstrmojo.array","mstrmojo.gm.GMEnums");var EMPTY_FUNC=mstrmojo.emptyFn,$CSS=mstrmojo.css,$DOM=mstrmojo.dom,$ARR=mstrmojo.array,$GM=mstrmojo.gm,$MAP=mstrmojo.gmaps,PRP_LEGEND_SLOT=$GM.EnumLegendSlot,DOCK_POSITION=$GM.EnumDockPosition,GM_LEGEND_SPACING=5;function getPositionInBoundary(pos,boundaryPosition){return{x:pos.x-boundaryPosition.x,y:pos.y-boundaryPosition.y};}function getLegendConWidth(){return this.widget.legendCon.domNode.clientWidth;}function getLegendConHeight(){return this.widget.legendCon.domNode.clientHeight;}mstrmojo.gmaps.MapLegend=mstrmojo.declare(mstrmojo.gm.GMLegend,null,{scriptClass:"mstrmojo.gmaps.MapLegend",cssClass:"gm-legend vis-map-legend",dockedPositions:[{pos:PRP_LEGEND_SLOT.LEFT_TOP},{pos:PRP_LEGEND_SLOT.LEFT_MIDDLE},{pos:PRP_LEGEND_SLOT.LEFT_BOTTOM},{pos:PRP_LEGEND_SLOT.RIGHT_TOP},{pos:PRP_LEGEND_SLOT.RIGHT_MIDDLE},{pos:PRP_LEGEND_SLOT.RIGHT_BOTTOM}],calculateDockedPositions:EMPTY_FUNC,getSplitterDockPos:function(){return(this.widget.legendCon.currDockedPositionIdx<3)?DOCK_POSITION.RIGHT:DOCK_POSITION.LEFT;},updateDropZonePosition:function(docPos){var visMapBase=this.widget,dropZoneStyle=visMapBase.legendCon.dropZoneNode.style;if(docPos){dropZoneStyle.left=docPos.x+"px";dropZoneStyle.top=docPos.y+"px";}},calculateLegendDockedPositions:function(w,h){var i,wLegend=getLegendConWidth.call(this),hLegend=getLegendConHeight.call(this),visMapBase=this.widget,dockedPositions=this.dockedPositions,tbHeight=parseInt(visMapBase.mapViewer.toolbar.TOOLBAR_HEIGHT||0,10),lgdSpacing=tbHeight+GM_LEGEND_SPACING,calculateDockedPosition=function(dockedPos){switch(dockedPos.pos){case PRP_LEGEND_SLOT.LEFT_TOP:dockedPos.x=0;dockedPos.y=lgdSpacing;break;case PRP_LEGEND_SLOT.LEFT_MIDDLE:dockedPos.x=0;dockedPos.y=Math.max(lgdSpacing,(h-hLegend-tbHeight)>>1);break;case PRP_LEGEND_SLOT.LEFT_BOTTOM:dockedPos.x=0;dockedPos.y=Math.max(0,h-hLegend-GM_LEGEND_SPACING);break;case PRP_LEGEND_SLOT.RIGHT_TOP:dockedPos.x=w-wLegend;dockedPos.y=lgdSpacing;break;case PRP_LEGEND_SLOT.RIGHT_MIDDLE:dockedPos.x=w-wLegend;dockedPos.y=Math.max(lgdSpacing,(h-hLegend-tbHeight)>>1);break;case PRP_LEGEND_SLOT.RIGHT_BOTTOM:dockedPos.x=w-wLegend;dockedPos.y=Math.max(0,h-hLegend-GM_LEGEND_SPACING);break;}};for(i=0;i<dockedPositions.length;i++){calculateDockedPosition(dockedPositions[i]);}this.updateDropZonePosition(visMapBase.getLegendConDockedPosition());},getSplitterInfo:function(splitter){if(!splitter){return{};}var splitterDockPos=this.getSplitterDockPos(),pos=getPositionInBoundary($DOM.position(this.domNode),this.boundaryPosition),currentW=this.width,pWidth=this.GMW,minLegendW=50,maxLegendW=Math.floor(pWidth/3),rtn={};rtn.dockPosition=splitterDockPos;if(splitterDockPos===DOCK_POSITION.LEFT){rtn.min=Math.min(0,Math.max(-pos.x,currentW-maxLegendW));rtn.max=Math.max(0,currentW-minLegendW);}else{if(splitterDockPos===DOCK_POSITION.RIGHT){rtn.min=minLegendW;rtn.max=Math.min(maxLegendW,pWidth-pos.x);}}return rtn;},splitterMoved:function(position,info){if(position!=0&&info.dockPosition===DOCK_POSITION.LEFT){var pos=getPositionInBoundary($DOM.position(this.domNode),this.boundaryPosition);this.dropZoneNode.style.left=(pos.x+position)+"px";}if(this._super){this._super(position,info);}},adjustColorPickerPos:EMPTY_FUNC,onmouseover:function(evt){if(this._super){this._super(evt);}},onclick:function(evt){var target=evt.getTarget();if(target===this.triBtn){if(!this.autoCollapse){this.raiseEvent({name:"gm-legend-clicked",action:(this.isMinimal?"restore":"minimize")});}}else{if(target===this.closeBtn){this.raiseEvent({name:"gm-legend-clicked",action:"close",mousePos:evt.e});}}$DOM.stopPropogation(null,evt.e);},updateSplitter:function(){this.dockPos=this.getSplitterDockPos();this._super.call(this.widget.legendCon);},postBuildRendering:function(){this._super();this.parentNode=this.domNode.parentNode;this.boundaryPosition=$DOM.position(this.widget.domNode,true);},ondragstart:function(evt){var lgdCon=this.widget.legendCon,lgdConDom=lgdCon.domNode,lgdConWidth=lgdConDom.clientWidth,lgdConHeight=lgdConDom.clientHeight,dropZoneNodeStyle=lgdCon.dropZoneNode.style;dropZoneNodeStyle.width=lgdConWidth+"px";dropZoneNodeStyle.height=lgdConHeight+"px";this.width=lgdConWidth;this.height=lgdConHeight;this._super(evt);},setupScrollNodes:function(){var visMapBase=this.widget,lgdCon=visMapBase.legendCon,lgdContainer=lgdCon&&lgdCon.legendContainer;if(lgdCon&&lgdContainer.parentNode){lgdCon.scrollNode=lgdCon&&lgdContainer;lgdCon.scrollNode.style.maxHeight=visMapBase.getHeight()+"px";}},onscroll:function(){var scrollNode=this.widget.legendCon.scrollNode;if(scrollNode&&this.hasCustomScrollbar){var getNumber=function getNumber(value){var n=parseInt(value);return n===null||isNaN(n)?0:n;},scrollNodePos=$DOM.position(scrollNode),scrollNodeHeight=scrollNodePos.h-getNumber($CSS.getStyleValue(scrollNode,"padding-bottom")),scrollNodeWidth=scrollNodePos.w-getNumber($CSS.getStyleValue(scrollNode,"padding-right")),scrollBarNodes=this.scrollBarNodes,vScrollBar=scrollBarNodes.v,hScrollBar=scrollBarNodes.h;if(scrollNode.scrollHeight-scrollNodeHeight>0){vScrollBar.style.top=((scrollNodeHeight-$DOM.position(vScrollBar).h)*(scrollNode.scrollTop/(scrollNode.scrollHeight-scrollNodeHeight)))+"px";}if(scrollNode.scrollWidth-scrollNodeWidth>0){hScrollBar.style.left=((scrollNodeWidth-$DOM.position(hScrollBar).w)*(scrollNode.scrollLeft/(scrollNode.scrollWidth-scrollNodeWidth)))+"px";}}},ondragend:function(evt){var dropZoneNodeStyle=this.widget.legendCon.dropZoneNode.style;dropZoneNodeStyle.width="";dropZoneNodeStyle.height="";this._super(evt);},updateDropZoneNode:function(context){this._super(context);var me=this,layerKeys=me.widget.layerIdxMappingArr,graphicLayer;$ARR.forEach(layerKeys,function(key){graphicLayer=me.widget.getGraphicLayer(key);if(graphicLayer&&graphicLayer.legend){graphicLayer.updateSingleLegendAlignClass();}});}});$MAP.MapLegend.applyHTML5Props=$GM.GMLegend.applyHTML5Props;$MAP.MapLegend.getLegendSize4MinMode=$GM.GMLegend.getLegendSize4MinMode;$MAP.MapLegend.getLegendSize=$GM.GMLegend.getLegendSize;}());