(function(){mstrmojo.requiresCls("mstrmojo.SearchWidget","mstrmojo.hash","mstrmojo.array","mstrmojo.css","mstrmojo.elementHelper","mstrmojo.mstr.EnumDSSXMLObjectTypes");var $HASH=mstrmojo.hash,$ARR=mstrmojo.array,$CSS=mstrmojo.css,$EH=mstrmojo.elementHelper,$OBJECT_TYPE=mstrmojo.mstr.EnumDSSXMLObjectTypes;var BLOCK_BEGIN_OFFSET=1,ERR_SDK_E_INVALID=2147762227,ERR_SDK_E_PROMPT_NUMERICAL_VALUES=2147762262,ERR_SDK_E_PROMPT_DATE_TIME=2147762269;mstrmojo.vi.ui.rw.selectors._CanSearchOnServer=mstrmojo.provide("mstrmojo.vi.ui.rw.selectors._CanSearchOnServer",{_mixinName:"mstrmojo.vi.ui.rw.selectors._CanSearchOnServer",searchBlockSize:500,expressionXML:"",browseFlags:1,getSourceDefn:mstrmojo.emptyFn,getDataService:mstrmojo.emptyFn,init:function init(props){this._super(props);this.clearSearchItems();},execSearchOnServer:function execSearchOnServer(searchPattern,blockBegin,blockCount){var id=this.id,ds=this.getDataService(),defn=this.getSourceDefn();if(ds&&defn&&!this.isSearching){var useClientForm=defn.srct===$OBJECT_TYPE.Consolidation;this.set("isSearching",true);ds.browseControlElements({searchPattern:searchPattern,blockBegin:blockBegin,blockCount:blockCount,attributeId:defn.srcid,expressionXML:this.expressionXML,dataSourcesXML:defn.dsrc,datasetId:defn.dsid,controlKey:defn.ckey,searchForms:defn.fs||defn.sfs,browseFlags:this.browseFlags,objectType:defn.srct,useClientForm:useClientForm},{success:function(res){var me=mstrmojo.all[id],attId=res.did||defn.srcid;if(res){var items=$EH.buildElemsTerseID(res.es,attId,true)||[];me.onSearchSuccess(items,{attributeId:attId,blockBegin:blockBegin,blockCount:blockCount,size:res.sz});}},failure:function(res){var me=mstrmojo.all[id],ec=parseInt(res.code,10)+4294967296;if(ec!==ERR_SDK_E_INVALID&&ec!==ERR_SDK_E_PROMPT_NUMERICAL_VALUES&&ec!==ERR_SDK_E_PROMPT_DATE_TIME){mstrmojo.alert(res.message);}me.onSearchFailure();},complete:function(){var me=mstrmojo.all[id];me.set("isSearching",false);}},{hideFailureErr:true});}},onSearchSuccess:function onSearchSuccess(items,config){var loadItems=this.loadItems,start=loadItems.length;this.loadItems=loadItems.concat(items);this.loadCompleted=start+items.length>=config.size;this.renderFilteredItems(start);},onSearchFailure:function onSearchFailure(){this.loadCompleted=true;this.renderFilteredItems();},renderFilteredItems:function renderFilteredItems(start){var filteredItems=this.loadItems,itemsContainerNode=this.itemsContainerNode;if(filteredItems&&itemsContainerNode){var originalItems=this.items,itemsMarkup;this.items=filteredItems;itemsMarkup=this._buildItemsMarkup(start||0,filteredItems.length-1,this._markupPrefix&&this._markupPrefix(),this._markupSuffix&&this._markupSuffix(),this._itemPrefix&&this._itemPrefix(),this._itemSuffix&&this._itemSuffix()).join("");this.items=originalItems;itemsContainerNode.innerHTML=(start>0?itemsContainerNode.innerHTML:"")+itemsMarkup;}if(this.updateScrollbars){this.updateScrollbars();}},renderOriginalItems:function renderOriginalItems(){var itemsContainerNode=this.itemsContainerNode,len=this.renderOnScroll?(this.renderIndex+1)*this.renderBlockSize:this.items.length;if(len){itemsContainerNode.innerHTML=this._buildItemsMarkup(0,len-1,this._markupPrefix&&this._markupPrefix(),this._markupSuffix&&this._markupSuffix(),this._itemPrefix&&this._itemPrefix(),this._itemSuffix&&this._itemSuffix()).join("");}if(this.updateScrollbars){this.updateScrollbars();}},onScrollEnd:function onScrollEnd(){var pattern=this.pattern,node=this.scrollNode,last=this.loadItems.length;if(node&&this.isOnSearch()){if(node.offsetHeight+Math.ceil(node.scrollTop)>=node.scrollHeight&&!this.loadCompleted){this.execSearchOnServer(pattern,last+BLOCK_BEGIN_OFFSET,this.searchBlockSize);}}if(this._super){this._super();}},_set_pattern:function _set_pattern(n,v){var pattern=this.pattern=v;this.clearSearchItems();if(pattern.length>0){this.execSearchOnServer(pattern,BLOCK_BEGIN_OFFSET,this.searchBlockSize);}else{this.renderOriginalItems();}return true;},onisSearchingChange:function onisSearchingChange(evt){var isSearching=evt.value,searchbox=this.searchbox;if(searchbox){var inputNode=searchbox.inputNode,clearNode=searchbox.clearNode;if(inputNode){inputNode.disabled=isSearching;}if(clearNode){$CSS.toggleClass(clearNode,"show",!isSearching);}}},getSearchbarCfg:function getSearchbarCfg(){return{scriptClass:"SearchWidget",placeholder:this.searchboxNode,onsearch:function onsearch(pattern){this.parent.set("pattern",pattern);},onclear:function onclear(){this.parent.set("pattern","");}};},postBuildRendering:function postBuildRendering(){var tb=this.getSearchbarCfg(),sn=tb.placeholder,searchbox=this.searchbox,Clazz=$HASH.walk(tb.scriptClass,mstrmojo);if(sn){if(!searchbox){delete tb.scriptClass;tb.parent=this;searchbox=new Clazz(tb);this.searchbox=searchbox;}searchbox.placeholder=sn;searchbox.render();}if(this.isOnSearch()){searchbox.setSearchPattern(this.pattern);this.renderFilteredItems();}return this._super();},unrender:function unrender(ignoreDom){var searchbox=this.searchbox;if(searchbox){searchbox.unrender(ignoreDom);}return this._super(ignoreDom);},getItemFromTarget:function getItemFromTarget(target){if(this._super){if(this.isOnSearch()){var originalItems=this.items,ret;this.items=this.loadItems;ret=this._super(target);this.items=originalItems;return ret;}return this._super(target);}return undefined;},isOnSearch:function isOnSearch(){return this.pattern&&this.pattern.length>0;},getSearchItems:function getSearchItems(){return this.loadItems;},updateSearchItems:function updateSearchItems(items){if($ARR.isArray(items)){this.loadItems=items;}},clearSearch:function clearSearch(){this.pattern="";this.clearSearchItems();},clearSearchItems:function clearSearchItems(){this.loadItems=[];this.loadCompleted=false;}});}());