(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.expr","mstrmojo.elementHelper");var $HASH=mstrmojo.hash,$EXPR=mstrmojo.expr,$EH=mstrmojo.elementHelper,$ET=$EXPR.ET,$FN=$EXPR.FN;var FUNCTION_ALL=0,FUNCTION_BRANCH=1,FUNCTION_LEVEL=2;var ALL_EXPR_IDX=0,ELEM_ALL_ID="u;",LEVEL_FORM_NAME="LEVEL_NUMBER",DEFAULT_SELECTION=false,MAX_LEVEL_NUMBER=1000;function getAllSelected(exprs){return !exprs[ALL_EXPR_IDX].isNot;}function setAllSelected(exprs,isSelected){return exprs[ALL_EXPR_IDX].isNot=!isSelected;}function isNotNode(node){return !!node.not||node.fn===$FN.NOT_IN_LIST||node.fn===$FN.NOT_EQUAL;}function getAttrNode(objInfo){return{did:objInfo.did,n:objInfo.n,t:objInfo.t,st:objInfo.st};}function isNDEObject(objInfo){return objInfo.t===47&&objInfo.st===12033;}function getElementNode(item,objInfo){var node={v:$EH.terseLong2OldShort(item.v),n:item.n};if(isNDEObject(objInfo)){node.t=item.t;node.conid=objInfo.did;}return node;}function isItemIsolated(item){return item&&item.lv>0&&!item.parent;}function getBranchExprPosMap(exprs,rootItems){var branchPosMap={},curBranchPos=ALL_EXPR_IDX;exprs.forEach(function(expr,idx){if(expr.fn===FUNCTION_BRANCH){branchPosMap[expr.item.v]=idx;}});rootItems.forEach(function walkDescendants(item){var branchPos=branchPosMap[item.v],tempBranchPos;if(branchPos>curBranchPos){tempBranchPos=curBranchPos;curBranchPos=branchPos;}else{branchPosMap[item.v]=curBranchPos;}(item.children||[]).forEach(function(child){walkDescendants(child);});if(tempBranchPos>=0){curBranchPos=tempBranchPos;}});return branchPosMap;}function getLevelExprPosMap(exprs){var levelPosMap={};exprs.forEach(function(expr,idx){if(expr.fn===FUNCTION_LEVEL){levelPosMap[expr.level]=idx;}});return levelPosMap;}mstrmojo.vi.ui.rw.selectors._IsDynamicExpression=mstrmojo.provide("mstrmojo.vi.ui.rw.selectors._IsDynamicExpression",{_mixinName:"mstrmojo.vi.ui.rw.selectors._IsDynamicExpression",init:function init(props){this._super(props);this.exprData={};this.resetExprData();},resetExprData:function resetExprData(isSelected){var exprData=this.exprData;exprData.exprs=[{fn:FUNCTION_ALL,isNot:isSelected!==undefined?!isSelected:!DEFAULT_SELECTION}];exprData.selectedItems={};exprData.unselectedItems={};return exprData;},getLevelExprJSON:function getLevelExprJSON(objInfo,level,isNot){var levelForm=(objInfo.fs||[]).filter(function(f){return f.fnm===LEVEL_FORM_NAME;})[0];return levelForm?{et:$ET.AQ,fn:isNot?$FN.NOT_EQUAL:$FN.EQUAL,a:getAttrNode(objInfo),fm:{did:levelForm.fid,n:levelForm.fnm,dtp:$EXPR.DTP.INTEGER},cs:[{v:level,dtp:$EXPR.DTP.INTEGER}]}:null;},getBranchExprJSON:function getBranchExprJSON(objInfo,item,isNot){return{et:$ET.AE,fn:$FN.DESCENDANT,not:isNot,a:getAttrNode(objInfo),es:[getElementNode(item,objInfo)]};},getListExprJSON:function getListExprJSON(objInfo,hash,isNot){var es=$HASH.valarray(hash).map(function(item){return getElementNode(item,objInfo);});return es.length>0?{et:$ET.AE,fn:isNot?$FN.NOT_IN_LIST:$FN.IN_LIST,a:getAttrNode(objInfo),es:es}:null;},getExprJSON:function getExprJSON(objInfo){var exprData=this.exprData,exprs=exprData.exprs,exprNodes=[],allSelected=getAllSelected(exprs),addExprJSON=function(nodes,node){if(!$HASH.isEmpty(node)&&(nodes.length>0||allSelected===isNotNode(node))){nodes.push(node);}};exprs.forEach(function(expr){switch(expr.fn){case FUNCTION_LEVEL:addExprJSON(exprNodes,this.getLevelExprJSON(objInfo,expr.level,expr.isNot));break;case FUNCTION_BRANCH:addExprJSON(exprNodes,this.getBranchExprJSON(objInfo,expr.item,expr.isNot));break;}},this);addExprJSON(exprNodes,this.getListExprJSON(objInfo,exprData.selectedItems));addExprJSON(exprNodes,this.getListExprJSON(objInfo,exprData.unselectedItems,true));if(exprNodes.length>0){var exprJSON=exprNodes[0];exprNodes.forEach(function(node,idx,nodes){var isNot=isNotNode(node);if(idx>0){if(isNot===isNotNode(nodes[idx-1])&&exprJSON.nds){exprJSON.nds.push(node);}else{exprJSON={et:$ET.ANDOR,fn:isNot?$FN.AND:$FN.OR,nds:[exprJSON,node]};}}});return exprJSON;}return allSelected?{et:$ET.AE,fn:$FN.NOT_IN_LIST,a:getAttrNode(objInfo),es:[]}:null;},updateExpr:function updateExpr(exprJSON){var exprData=this.resetExprData(),itemMap=this.itemMap,hasSetAllSelected=false,walkExprJSON=function(node,exprData){if($HASH.isEmpty(node)){return ;}if(node.et===$ET.ANDOR){(node.nds||[]).forEach(function(nd){walkExprJSON(nd,exprData);});}else{var exprs=exprData.exprs,isNot=isNotNode(node);if(!hasSetAllSelected){hasSetAllSelected=true;setAllSelected(exprs,isNot);}if(node.et===$ET.AQ&&node.fm&&node.fm.n===LEVEL_FORM_NAME){exprs.push({fn:FUNCTION_LEVEL,level:parseInt(node.cs[0].v,10),isNot:isNot});}if(node.et===$ET.AE){var selectedItems=exprData.selectedItems,unselectedItems=exprData.unselectedItems;(node.es||[]).forEach(function(e){var itemId=$EH.oldShort2terseLong(e.v),item=itemMap[itemId]||{v:itemId,n:e.n};if(node.fn===$FN.DESCENDANT){exprs.push({fn:FUNCTION_BRANCH,item:item,isNot:isNot});}else{if(node.fn===$FN.IN_LIST){selectedItems[item.v]=item;}else{if(node.fn===$FN.NOT_IN_LIST){unselectedItems[item.v]=item;}}}});}}};walkExprJSON(exprJSON,exprData);this.updateSelection();},updateExprByList:function updateExprByList(items,include){var itemMap=this.itemMap,selectedItems={},isUnset=false,item,itemId;for(var i=0,len=items.length;i<len;i++){item=items[i];itemId=item.v;if(itemId===ELEM_ALL_ID){isUnset=true;break;}else{selectedItems[itemId]=itemMap[itemId]||item;}}if(isUnset){this.resetExprData();}else{var exprData=this.resetExprData(!include);exprData[include?"selectedItems":"unselectedItems"]=selectedItems;}this.updateSelection();},buildElementExpr:function buildElementExpr(item,isSelected){var exprData=this.exprData,selectedItems=exprData.selectedItems,unselectedItems=exprData.unselectedItems,isForceAdd=isItemIsolated(item),itemId=item.v;if(isSelected){if(isForceAdd||!unselectedItems[itemId]){selectedItems[itemId]=item;}delete unselectedItems[itemId];}else{if(isForceAdd||!selectedItems[itemId]){unselectedItems[itemId]=item;}delete selectedItems[itemId];}},buildBranchExpr:function buildBranchExpr(branchItem,isSelected){var exprData=this.exprData,exprs=exprData.exprs,descendantMap={},isAllSelected=getAllSelected(exprs),walkDescendants=function(item){descendantMap[item.v]=true;(item.children||[]).forEach(function(child){walkDescendants(child);});};walkDescendants(branchItem);$HASH.forEach(exprData.selectedItems,function(item,itemId,selectedItems){if(descendantMap[item.v]){delete selectedItems[itemId];}});$HASH.forEach(exprData.unselectedItems,function(item,itemId,unselectedItems){if(descendantMap[item.v]){delete unselectedItems[itemId];}});var minLevel=MAX_LEVEL_NUMBER;exprs=exprData.exprs=exprs.filter(function(expr){switch(expr.fn){case FUNCTION_BRANCH:if(descendantMap[expr.item.v]){return false;}minLevel=Math.min(expr.item.lv,minLevel);break;case FUNCTION_LEVEL:if(expr.isNot!==isAllSelected&&expr.level<minLevel){return false;}break;}return true;});var expr,i,ancestorMap={},isRedundant=isSelected===isAllSelected;var ancestorItem=branchItem.parent;while(ancestorItem){ancestorMap[ancestorItem.v]=true;ancestorItem=ancestorItem.parent;}for(i=exprs.length-1;i>=0;i--){expr=exprs[i];if(expr.fn===FUNCTION_LEVEL&&expr.level>=branchItem.lv&&expr.isNot===isSelected){isRedundant=false;break;}if(expr.fn===FUNCTION_BRANCH){if(isItemIsolated(branchItem)){isRedundant=false;break;}if(ancestorMap[expr.item.v]){isRedundant=expr.isNot!==isSelected;break;}}}if(!isRedundant){exprs.push({fn:FUNCTION_BRANCH,item:branchItem,isNot:!isSelected});}},buildLevelExpr:function buildLevelExpr(level,isSelected){var exprData=this.exprData,exprs=exprData.exprs,isAllSelected=getAllSelected(exprs);$HASH.forEach(exprData.selectedItems,function(item,itemId,selectedItems){if(item.lv===level){delete selectedItems[itemId];}});$HASH.forEach(exprData.unselectedItems,function(item,itemId,unselectedItems){if(item.lv===level){delete unselectedItems[itemId];}});var branchPosMap=getBranchExprPosMap(exprs,this.getRootItems()),minLevel=MAX_LEVEL_NUMBER,levelPos=-1;exprs=exprData.exprs=exprs.filter(function(expr,idx,exprs){switch(expr.fn){case FUNCTION_BRANCH:var parentItem=expr.item.parent,branchPos=parentItem?branchPosMap[parentItem.v]:ALL_EXPR_IDX;if(branchPos>levelPos&&expr.isNot===exprs[branchPos].isNot){return false;}minLevel=Math.min(expr.item.lv,minLevel);break;case FUNCTION_LEVEL:if(expr.level===level||expr.isNot!==isAllSelected&&expr.level<minLevel){return false;}levelPos=idx;break;}return true;});var isRedundant=isSelected===isAllSelected;for(var i=0,len=exprs.length;isRedundant&&i<len;i++){if(exprs[i].fn===FUNCTION_BRANCH&&exprs[i].item.lv<=level){isRedundant=false;}}if(!isRedundant){exprs.push({fn:FUNCTION_LEVEL,level:level,isNot:!isSelected});}},buildAllExpr:function buildAllExpr(isSelected){this.resetExprData(isSelected);},updateSelection:function updateSelection(){var rootItems=this.getRootItems(),exprData=this.exprData,exprs=exprData.exprs,selectedItems=exprData.selectedItems,unselectedItems=exprData.unselectedItems,branchPosMap=getBranchExprPosMap(exprs,rootItems),levelPosMap=getLevelExprPosMap(exprs);this.getItems().forEach(function(item){var levelPos=levelPosMap[item.lv]||ALL_EXPR_IDX,branchPos=branchPosMap[item.v]||ALL_EXPR_IDX,isSelected;if(selectedItems[item.v]){isSelected=true;}else{if(unselectedItems[item.v]){isSelected=false;}else{isSelected=!exprs[Math.max(levelPos,branchPos)].isNot;}}item.isSelected=isSelected;item.isBranchSelected=!exprs[branchPos].isNot;});},getLevelInfo:function getLevelInfo(){var exprs=this.exprData.exprs,maxLevel=0,levels={};this.getItems().forEach(function(item){var level=item.lv;if(level>maxLevel&&!item.hid){maxLevel=level;}});exprs.forEach(function(expr){if(expr.fn===FUNCTION_LEVEL){var level=expr.level,levelInfo=levels[level]={};maxLevel=Math.max(maxLevel,level);levelInfo.dynamic=!expr.isNot;}});return $HASH.copy({allSelected:getAllSelected(exprs),maxLevel:maxLevel,isLevelSelected:function(level){var levelInfo=this[level]||{};return levelInfo.dynamic||this.allSelected&&levelInfo.dynamic!==false;}},levels);}});}());