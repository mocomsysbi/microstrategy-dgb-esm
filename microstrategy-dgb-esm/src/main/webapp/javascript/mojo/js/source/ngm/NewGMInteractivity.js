(function(){mstrmojo.requiresCls("mstrmojo.string","mstrmojo.dom","mstrmojo.array","mstrmojo.css","mstrmojo.hash","mstrmojo.num","mstrmojo.VisUtility","mstrmojo.gm.GMUtility","mstrmojo.ui.menus.PopupConfig","mstrmojo.vi.enums.EnumFeatures","mstrmojo.vi.ui.rw._HasVisSelections");mstrmojo.requiresClsP("mstrmojo.ui.menus","MenuConfig","EditorConfig","ToolbarEditorConfig");var $MOJO=mstrmojo,$VISUTIL=$MOJO.VisUtility,$DOM=$MOJO.dom,$ARR=$MOJO.array,$HASH=$MOJO.hash,$NUM=mstrmojo.num,$GM=$MOJO.gm,$DU=$MOJO.vi.ui.DatasetUnitMenuUtils,GMUTIL=$GM.GMUtility,$WRAP=mstrmojo.func.wrapMethods,ENUM_XML_TAG=$GM.WidgetPropertyTag,ENUM_FORMAT_TAG=$GM.FormatingPropertyTag,$FEATURES=mstrmojo.vi.enums.EnumFeatures,ENUM_DZID=mstrmojo.vi.viz.EnumDSSDropZones,CHART_TYPE=$GM.EnumGraphType,ENUM_CONTEXTMENUTARGETS={AX_TITLE:"title",DATA_PT:"datapt",LASSO:"lasso",DO_NOT_CLEAR:"donotclear"};function getGroupsInChart(chartDiv){var elements=chartDiv.getElementsByClassName("trace bars");if(!elements.length){elements=chartDiv.getElementsByClassName("trace scatter");}if(!elements.length){elements=chartDiv.getElementsByClassName("trace boxes");}return elements;}function cloneHighlightSelections(widget){var data,res,gmCtr=widget.GMController,isHistogram=gmCtr.isHistogram,isBoxPlot=gmCtr.isBoxPlot;widget.contextMenuSelectedShapes=widget.highlights;if(isBoxPlot){res=getBoxPlotSelection(widget.highlights,widget,true);widget.addContextMenuMetricValueSelection(res);}else{(widget.highlights||[]).forEach(function(pt){if(isHistogram){data=pt.__data__.newText;(data||[]).forEach(function(elements){res=getSelections(elements,{},widget);widget.addContextMenuMetricValueSelection(res);});}else{data=pt.__data__.information||(pt.__data__.trace&&pt.__data__.trace._input.information);if(data&&data!==-1){res=getSelections(data,{},widget);widget.addContextMenuMetricValueSelection(res);}}});}}function isTargetSelected(widget,div,point){if(point.__target){point=point.__target[0]&&point.__target[0][0];if(widget.highlights.indexOf(point)!==-1){cloneHighlightSelections(widget);return true;}}else{var data=point.information,res={},shapes;if(data&&data!==-1){res=getCandidateInfo(widget,[point],false,false,false);}shapes=getBoxPlotShapes(div,[res],widget);if(shapes.length&&widget.highlights.indexOf(shapes[0][0])!==-1){cloneHighlightSelections(widget);return true;}}}function filterAggregateShapes(widget,div,selectionData,vah){if(widget.GMController.isBoxPlot){if(!selectionData){selectionData=minifySelection(widget._viSelections);}return getBoxPlotShapes(div,selectionData,widget,vah);}else{return getHistogramShapes(div,selectionData,widget);}}function getHistogramShapes(div,selInfo,widget){var shapes=div.getElementsByClassName("trace bars")[0].childNodes[0].childNodes,bins,binVals,shapesIdx,selections=[];if(!shapes.length||!selInfo||!selInfo.length){return[];}bins=shapes[0].__data__.trace._input.newText;shapesIdx=0;for(var i=0;i<bins.length;i++){binVals=bins[i];(binVals||[]).forEach(function(texts){if(texts&&selections.indexOf(shapes[shapesIdx])===-1&&matchSelectionData(widget,texts,selInfo)){selections.push(shapes[shapesIdx]);}});if(binVals){shapesIdx++;}}return selections;}function getBoxPlotShapes(div,selInfo,widget,vah){var shapes=div.getElementsByClassName("trace boxes"),texts,noAxisAttr=!widget.GMController.dz.XAxis.TemplateUnit&&!widget.GMController.dz.YAxis.TemplateUnit,bp,selections=[],targetNodes;for(var i=0;i<shapes.length;i++){bp=shapes[i];if(vah||noAxisAttr){texts=bp.__data__[0].trace._input.information;(texts||[]).forEach(function(text){if(text&&matchSelectionData(widget,text,selInfo,true)){targetNodes=shapes[i].querySelectorAll("path");selections.push(targetNodes);}});}else{texts=bp.__data__[0].trace._input.information[0];if(texts&&matchSelectionData(widget,texts,selInfo,vah)){targetNodes=shapes[i].querySelectorAll("path");selections.push(targetNodes);}}}return selections;}function RMCStyleBoxPlot(points,selected,div){div.classList.add("shallow");if(!points[0]){return ;}var i,j,point;for(j=0;j<points.length;j++){point=points[j];for(i=0;i<point.length;i++){point[i].classList.add("RMClicked");if(selected){point[i].classList.add("selected");}}}return points;}function hoverBoxPlot(widget,points,div){var shapes=div.getElementsByClassName("trace boxes"),curveNumber;if(!points[0]){return ;}var point,nodes,childN,i,j,k;for(i=0;i<points.length;i++){point=points[i];for(var m=0;m<shapes.length;m++){if(shapes[m].__data__[0].trace.index===point.curveNumber){curveNumber=m;break;}}nodes=shapes[curveNumber].childNodes;for(j=0;j<nodes.length;j++){if(!nodes[j].classList.contains("boxtext")){if(nodes[j].childNodes.length){childN=nodes[j].childNodes;for(k=0;k<childN.length;k++){childN[k].classList.add("hovered");widget.hoveredShape.push(childN[k]);}}else{nodes[j].classList.add("hovered");widget.hoveredShape.push(nodes[j]);}}}}}function getMultiSelectSelection(points,widget){var res={};(points||[]).forEach(function(pt){if(pt.__target&&pt.__target[0]){var data=pt.__target[0][0].__data__.information;if(data&&data!==-1){res=getSelections(data,res,widget);widget.addMetricValueSelection(res);res={};}}});}function getBoxPlotSelection(points,widget,ctx,isSelection){var res={};if(!points){return ;}([points[0]]||[]).forEach(function(pt){var texts=pt.data?pt.data.information:pt.__data__.trace._input.information;(texts||[]).forEach(function(info){res={};res=getSelections(info,res,widget);if(ctx){widget.addContextMenuMetricValueSelection(res);}else{if(isSelection){widget.addMetricValueSelection(res);}}});});return res;}function getAggregateSelection(points,widget,ctx){var res={},data,bins;(points||[]).forEach(function(pt){data=pt.data;bins=data.newText[pt.pointNumber];(bins||[]).forEach(function(elements){res={};res=getSelections(elements,res,widget);if(ctx){widget.addContextMenuMetricValueSelection(res);}else{widget.addMetricValueSelection(res);}});});return res;}function getGroupAndCalculationCMForDP(visGM,selections){return $VISUTIL.getGroupAndCalculationContextMenuForDataPoints(visGM,{selection:selections,fnCellName:function(cell){return cell.innerText||cell.textContent;},fnUnique:function(){var uniqIdnts=[],gmCtr=visGM.GMController,rAttrs=gmCtr.dz.Rows.TemplateUnit||[],cAttrs=gmCtr.dz.Columns.TemplateUnit||[],rowAndColumnAttrs=rAttrs.concat(cAttrs);selections.forEach(function(shape){shape.forEach(function(identity){if($ARR.find(rowAndColumnAttrs,"id",identity.tid)===-1){uniqIdnts=uniqIdnts.filter(function(idnt){return idnt.tid!==identity.tid||idnt.id!==identity.id;});uniqIdnts.push(identity);}});});return uniqIdnts;},fnMakeNode:function(identity){return{identity:identity,innerText:identity.headerText};}});}function getCandidateInfo(widget,points,multiSelect,ctx,isSelection){if(widget.GMController.isHistogram){return getAggregateSelection(points,widget,ctx);}else{if(widget.GMController.isBoxPlot){return getBoxPlotSelection(points,widget,ctx,isSelection);}else{if(multiSelect){getMultiSelectSelection(points,widget);}else{return getSelectionInfo(points,widget);}}}}function getSelectionInfo(pts,widget){var res={};(pts||[]).forEach(function(pt){var data=pt.data;var texts=data.information[pt.pointNumber];res=getSelections(texts,res,widget);});return res;}function getSelections(texts,mods,widget){if(texts===-1){return mods;}var queryEngine=widget.GMController.jsonModel;(texts||[]).forEach(function(info){if(!("mix" in info)){var u=queryEngine.queryByIdentity(info,[]);if(u){var id=u.tid;mods[id]=mods[id]||[];mods[id].push(u);}}});return mods;}function minifySelection(selections){var s,ids=[];for(s in selections){if(selections.hasOwnProperty(s)){ids.push(selections[s]);}}return ids;}function getTarget(){}function allowSelection(widget,points,ctrlKey){var fnDataPointsInBins=function(pts){var c=0;if(widget.GMController.isHistogram){pts.forEach(function(p){if(c>threshold){return c;}c+=p.data.newText[p.pointNumber].length;});return c;}else{if(widget.GMController.isBoxPlot){c++;}else{if(widget.GMController.isWaterfall){pts.forEach(function(p){if(!p.data.isFakeBar){if(c>threshold){return c;}c+=1;}});}else{c+=points.length;}}}return c;};if(!points.length){return true;}else{var threshold=widget.getWidgetPropertyValue(ENUM_FORMAT_TAG.SELECTION_LIMIT),numPtsSelected=fnDataPointsInBins(points);if(numPtsSelected<=threshold&&ctrlKey){numPtsSelected+=widget._viSelections?Object.keys(widget._viSelections).length:0;if(numPtsSelected>threshold){return false;}}else{if(numPtsSelected>threshold){return false;}}}return true;}function removeBoxOrLasso(div){if(!div.getElementsByClassName){return ;}var box=div.getElementsByClassName("ngm-select-outline");while(box.length>0){box[0].parentNode.removeChild(box[0]);}}function filterSelectedIdentities(selections){var s,header,ids=[],str;for(s in selections){if(selections.hasOwnProperty(s)){str="";for(header in selections[s]){if(selections[s].hasOwnProperty(header)){ids.push(selections[s][header]);}}}}return ids;}function filterShapes(widget,chart,selected,selectionData,vah){if(widget.GMController.isBoxPlot||widget.GMController.isHistogram){return filterAggregateShapes(widget,chart,selectionData,vah);}if(!selectionData||!selectionData.length){return selected;}var model=widget.GMController.xtabModel;var i,j,n,g,groupElem,shape,texts,groups=getGroupsInChart(chart)||[],groupCount=groups.length;for(i=0;i<groupCount;i++){g=groups[i];if(!g){continue;}groupElem=g.childNodes.length>1?g.childNodes[g.childNodes.length-1].childNodes:g.childNodes[0].childNodes;groupElem=d3v4.selectAll(groupElem).filter(".point").nodes();n=groupElem.length;for(j=0;j<n;j++){shape=groupElem[j];texts=shape.__data__.information===-1?[]:shape.__data__.information;if(texts&&selected.indexOf(shape)===-1&&matchSelectionData(widget,texts,selectionData)){selected.push(shape);}}}return selected;}function elementIdsMatched(arr,id,model){var i,n=arr.length,nId1,innerId,nId2;nId2=model.getNormalizedFormElementId(id);for(i=0;i<n;i++){innerId=arr[i].id;if(innerId===id){return true;}nId1=model.getNormalizedFormElementId(innerId);if(nId1===nId2){return true;}}return false;}function matchSelectionData(widget,texts,selectionData,ignoreBreakBy){var i,n,j,m,item,unit,info=[],queryEngine=widget.GMController.jsonModel,model=widget.GMController.xtabModel,validValues,innerMatched,unitId,unitIdsObj={},index,ruleLen=selectionData.length,rule,ruleMatched,hasAttrMatched,attrMatched,currIdx=0;n=texts.length;for(i=0;i<n;i++){if(!widget.GMController.isBoxPlot||ignoreBreakBy||(!ignoreBreakBy&&texts[i].dropzones.indexOf("BreakBy")===-1)){var obj=queryEngine.queryByIdentity(texts[i],[]);if(obj.tid||obj.oid){info.push(obj);unitId=obj.tid?String(obj.tid):"-1";unitIdsObj[currIdx]=[unitId];currIdx++;}}}for(index=0;index<ruleLen;index++){rule=selectionData[index];ruleMatched=true;hasAttrMatched=false;for(unit in rule){if(rule.hasOwnProperty(unit)){validValues=rule[unit];innerMatched=true;attrMatched=false;for(i=0;i<currIdx;i++){item=unitIdsObj[i];for(j=0,m=item.length;j<m;j++){if(item[j]===unit){attrMatched=true;if(!elementIdsMatched(validValues,info[i].id,model)){innerMatched=false;}else{hasAttrMatched=true;}break;}}if(attrMatched){break;}}if(!innerMatched){ruleMatched=false;break;}}}if(ruleMatched&&hasAttrMatched){return true;}}return false;}function cmdMgr(me){return me.model.controller.cmdMgr;}function getToolbarUpdateCallback(){return{success:function success(){this.raiseEvent({name:"regenerateToolbar"});}.bind(this)};}function prepareForGroup(selections){var s,header,ids=[],id,sel;for(s in selections){if(selections.hasOwnProperty(s)){sel=[];for(header in selections[s]){if(selections[s].hasOwnProperty(header)){id=selections[s][header][0];if(id){sel.push(id);}}}}if(sel.length){ids.push(sel);}}return ids;}mstrmojo.ngm.NewGMInteractivity=mstrmojo.declare(mstrmojo.Obj,[mstrmojo.vi.ui._CanDropFromSchema],{scriptClass:"mstrmojo.ngm.NewGMInteractivity",widget:null,selectedShapes:[],contextMenuSelection:[],contextMenuSelectedTargets:[],gmMenuOnCloseFlag:false,domWidget:undefined,init:function(props){this.widget=null;this.selectedShapes=[];this.selectedTargets=[];this.contextMenuSelection=[];this.contextMenuSelectedTargets=[];this.gmMenuOnCloseFlag=false;if(this._super){this._super(props);}var div=document.createElement("div");div.setAttribute("class","gm-menu-placeholder");this.domMenuPH=div;},destroy:function destroy(ignoreDOM){delete this.domWidget;this._super(ignoreDOM);},clearAll:function(){this.selectedShapes.length=0;this.contextMenuSelection.length=0;this.selectedTargets.length=0;this.contextMenuSelectedTargets.length=0;},unHighlightPoint:function(pt){if(pt.classList){pt.classList.remove("highlight");}else{pt.classed("highlight",false);}if(!this.widget.GMController.isHistogram&&!this.widget.GMController.isBoxPlot&&!this.widget.GMController.isWaterfall&&(this.widget.GMController.chartType===CHART_TYPE.LINE||this.widget.GMController.chartType===CHART_TYPE.AREA)&&pt.style){var trace=this.getTraceInfoFromPoint(pt),isSinglePoint=trace&&trace.singlepoint;if(typeof pt.style==="function"){pt.style("fill-opacity",isSinglePoint?1:0);pt.style("stroke-opacity",isSinglePoint?1:0);}else{pt.style["fill-opacity"]=isSinglePoint?1:0;pt.style["stroke-opacity"]=isSinglePoint?1:0;}}},highlightPoint:function(pt,fromVaH){if(!this.widget.GMController.isHistogram&&!this.widget.GMController.isBoxPlot&&!this.widget.GMController.isWaterfall&&(this.widget.GMController.chartType===CHART_TYPE.LINE||this.widget.GMController.chartType===CHART_TYPE.AREA)&&pt.style){if(typeof pt.style==="function"){pt.style("fill-opacity",1);pt.style("stroke-opacity",1);}else{pt.style["fill-opacity"]=1;pt.style["stroke-opacity"]=1;}}if(pt.classList){pt.classList.add("highlight");if(fromVaH){pt.classList.add("isTarget");}}else{if(pt.classed){pt.classed("highlight",true);if(fromVaH){pt.classed("isTarget",true);}}}this.widget.highlights.push(pt);},getTraceInfoFromPoint:function(pt){var info=pt[0]&&pt[0][0],trace=info&&info.__data__.trace;return trace&&trace._input;},styleWaterfallOverlappedBar:function(data,pointNumber,selected,div,style){var widget=this.widget;var ids=data.information[pointNumber];var header="";ids.forEach(function(e){if(e.t&&e.t===12&&e.dropzones){header+=e.id;}});var shapes=filterShapes(widget,div,[],[header]),xtrace=data.information[pointNumber].xaxis,ytrace=data.information[pointNumber].yaxis;for(var i=0;i<shapes.length;i++){if(!shapes[i].__data__.information.noStyle&&shapes[i].__data__.information.xaxis===xtrace&&shapes[i].__data__.information.yaxis===ytrace){if(style==="rightMouse"){shapes[i].classList.add("RMClicked");if(selected){shapes[i].classList.add("selected");}widget.rightMouseHighlights.push(shapes[i]);}else{if(style==="highlight"){shapes[i].classList.add("highlight");widget.highlights.push(shapes[i]);}else{if(style==="hover"){shapes[i].classList.add("hovered");widget.hoveredShape.push(shapes[i]);}}}}}},highlightSelected:function(widget,shapes,div,fromVaH){var me=this;if(!shapes.length){return ;}if(!fromVaH){div.classList.add("shallow");}shapes&&shapes.forEach(function(pt){if(pt.length){[].forEach.call(pt,function(p){me.highlightPoint(p,fromVaH);});}else{me.highlightPoint(pt,fromVaH);}});},clearRMCStyle:function(widget){if(window.NodeList&&!NodeList.prototype.forEach){NodeList.prototype.forEach=function(callback,thisArg){thisArg=thisArg||window;for(var i=0;i<this.length;i++){callback.call(thisArg,this[i],i,this);}};}(widget.rightMouseHighlights||[]).forEach(function(h){if(h.classed){h.classed("RMClicked",false);h.classed("selected",false);}else{if(h.classList){h.classList.remove("RMClicked");h.classList.remove("selected");}else{if(h.length&&h.length>0&&h[0].classList){h.forEach(function(n){n.classList.remove("RMClicked");n.classList.remove("selected");});}}}if(!widget.GMController.isHistogram&&!widget.GMController.isBoxPlot&&!widget.GMController.isWaterfall&&(widget.GMController.chartType===CHART_TYPE.LINE||widget.GMController.chartType===CHART_TYPE.AREA)&&h[0].style){h[0].style["stroke-opacity"]=0;}});widget.rightMouseHighlights=[];},resetHighlights:function(widget,div){if($HASH.isEmpty(widget._viSelections)){this.clearHighlight(widget);div.classList.remove("shallow");}},clearHighlight:function(widget){var me=this;(widget.highlights||[]).forEach(function(h){me.unHighlightPoint(h);});widget.highlights=[];},doHighlight:function(type,selectionData,visAsFilter){var widget=this.widget,visAsHighlight=!!selectionData&&!visAsFilter;if(widget.isEmpty()){return ;}var div=widget.div,sel=selectionData?minifySelection(selectionData):minifySelection(widget.getSelectionHash()),toHighlight=filterShapes(widget,div,[],sel,visAsHighlight);if(selectionData){this.clearHighlight(widget);}widget.selectedShapes=toHighlight;this.highlightSelected(widget,widget.selectedShapes,div,visAsHighlight);},findRealTarget:function(widget,div,e){var type,value,axis,axisNum,shape={},titleStart,titleNum,attrAxis,axisNumString,axisName,layout,target,gmCtr=widget.GMController;target=e&&e.target;if(target&&target.classList[0]==="ngm-select-outline"){shape.type=ENUM_CONTEXTMENUTARGETS.LASSO;return shape;}else{if(target&&target.classList[0]==="drag"){shape.type=ENUM_CONTEXTMENUTARGETS.DO_NOT_CLEAR;return shape;}else{if(target){value=target.classList.length>1?target.classList[1]:target.classList[0];if(value.indexOf(ENUM_CONTEXTMENUTARGETS.AX_TITLE)!==-1){titleStart=value.indexOf(ENUM_CONTEXTMENUTARGETS.AX_TITLE);titleNum=value.slice(titleStart+ENUM_CONTEXTMENUTARGETS.AX_TITLE.length);axis=value[0];attrAxis=widget.GMController.getAttributeAxesLetters().indexOf(axis)!==-1||(axis==="x"&&gmCtr.isHistogram);type=ENUM_CONTEXTMENUTARGETS.AX_TITLE;if(attrAxis){axisNumString=value.slice(1,titleStart)||0;if(titleNum===undefined||titleNum===""){titleNum=0;}shape.type=type;axis=value[0];if(value.indexOf(ENUM_CONTEXTMENUTARGETS.AX_TITLE)===1){axisNum=1;}else{axisNum=$NUM.parseNumeric(axisNumString);}titleNum=$NUM.parseNumeric(titleNum);shape.titleNum=titleNum;shape.axisNum=axisNum;}else{axisNumString=value.slice(1,titleStart)||"1";axisName=axis+"axis"+axisNumString;layout=widget.layouter.getPlotlyLayout();if(e.target.identity){shape.identity=e.target.identity;}else{if(gmCtr.getChartInfo().isABL&&gmCtr.isMetricNamesInZone("BreakBy")){shape.identity=layout[axis+"axis1"].identity[axis+"axis"+titleNum];}else{shape.identity=layout[axisName].identity;shape.rowId=layout[axisName].rowId;}}}shape.type=type;shape.axis=axis;shape.attrAxis=attrAxis;return shape;}}}}},onPaperClick:function(widget,div,e,ctrlKey){if(e&&(e.button===0||e.button===2)&&(e.which!==1||e.type==="contextmenu")&&!ctrlKey){var shape=this.findRealTarget(widget,div,e);if(shape){var data={event:e,shape:shape};this.onContextMenu(widget,div,data);return ;}}removeBoxOrLasso(div);this.clearRMCStyle(widget);this.clearHighlight(widget);div.classList.remove("shallow");if(!$HASH.isEmpty(widget._viSelections)){widget.clearSelections();widget.endSelections();}},hideContextMenu:function(){var ph=this.domMenuPH,phChild=ph.firstChild,phParent=ph.parentNode,widget=this.widget;GMUTIL.destroyDisposable(widget,widget.menuEditor);if(phChild){ph.removeChild(phChild);}if(phParent){phParent.removeChild(ph);}var _this=widget.menuEditor;if(_this){widget.removeChildren(_this);_this.unrender=function(){_this._super();};_this.destroy();_this.unrender=function(){};delete widget.menuEditor;}if(widget.menuEditorClosefn){$DOM.detachEvent(document.body,"touchstart",widget.menuEditorClosefn,true);$DOM.detachEvent(document.body,"mousedown",widget.menuEditorClosefn,true);delete widget.menuEditorClosefn;}},showContextMenu:function(pos,menuData){var widget=this.widget,ph=this.domMenuPH,_this=this;ph.innerHTML="";document.body.appendChild(ph);widget._lastOpened=null;ph.style.top=pos.y+"px";ph.style.left=pos.x+"px";menuData.hostId=widget.id;menuData.hostElement=ph;widget.menuEditor=menuData.newInstance({locksHover:false,unrender:function(){}});widget.menuEditorClosefn=function(evt){if(!widget.menuEditor){return ;}var target=evt.target,menuRoot=widget.menuEditor.domNode;if(!$DOM.contains(menuRoot,target,true,menuRoot)&&!$VISUTIL.isHostedPopupNode(target,"class",true,document.body)){if(widget.toolEditor){var toolbarRoot=widget.toolEditor.domNode;if(!$DOM.contains(toolbarRoot,target,true,toolbarRoot)){_this.hideContextMenu();}}else{_this.hideContextMenu();}}};$DOM.attachEvent(document.body,"touchstart",widget.menuEditorClosefn,true);$DOM.attachEvent(document.body,"mousedown",widget.menuEditorClosefn,true);widget.openPopup(widget.menuEditor);},getMenuConfig:function(widget,shape,config,info){var i,drillTo=widget.GMController.disabledUnits,n=drillTo.length,data,presentationMode=mstrApp.isAppStatePresentation(),dzModel=widget.zonesModel.gmZones,isDropZoneUnit=info&&info.el,zonesModelId=mstrmojo.all[dzModel.hostId].zonesModel.id;var addDrillTo=function(attrId,forLasso){var refineDrillTo=function(attrId){var allDrillPaths=(function(){var res;$ARR.forEach(widget.model.data.gts.row.concat(widget.model.data.gts.col),function(unit){if(unit.id&&unit.id===attrId){res=unit.dp;data=unit;}});return res;}()),datasets=widget.model.docModel.datasets,fnShowInUnits=function(units,drillPath){var i=$ARR.find(units,"did",drillPath.id),unit=units[i];if(unit&&!unit.hide){drillPath.n=unit.n;return true;}return false;},paths=$ARR.filter(allDrillPaths,function(drillPath){var key;for(key in datasets){var ds=datasets[key];if(fnShowInUnits(ds.att,drillPath)){return true;}}return false;});if(paths){drillTo=$ARR.filter(drillTo,function(dt){for(var i in paths){if(paths[i].n===dt.n){dt.drillPath=paths[i];return true;}}return false;});n=drillTo.length;}else{n=0;}return n;},getDrillSubMenu=function(){var subMenu=new $MOJO.ui.menus.MenuConfig({supportsScroll:true,maxHeight:350});for(i=0;i<n;i++){if(forLasso){subMenu.addMenuItem(drillTo[i].n,"xt",drill,{drillUnit:drillTo[i],fromUnit:data});}else{subMenu.addMenuItem(drillTo[i].n,"xt",drill,{drillUnit:drillTo[i],fromUnit:{tid:data.id,isRowAttribute:false}});}}return subMenu;};n=refineDrillTo(attrId);switch(n){case 0:config.addNonInteractiveMenuItem(mstrmojo.desc(145,"Drill"),"",true);break;default:config.addSubMenuItem(mstrmojo.desc(145,"Drill"),"",this.id,getDrillSubMenu);}},drillGM=function(drillUnit){var me=widget,model=me.model,update=me.getTemplateUpdateForKeepOnlyAndShow(drillUnit);var selections=me.getContextMenuSelections(),selectorData=model.getSelectorDataFromTemplateLimit(me.model.data.tpl).concat({keepOnly:true,data:selections}),toolbarCallback=getToolbarUpdateCallback.call(me),ko=model.getKeepOnlyActionsForAssociatedNodes(selectorData,toolbarCallback);if(selections&&selections.length>0){update.add(ko.actions,ko.callback);}cmdMgr(me).execute({execute:function execute(){this.submitUpdate(update);},urInfo:{callback:update.callback}});};var updateAfterKeepOnly=function(isKeepOnly){var docModel=(widget.getDocModel&&widget.getDocModel())||widget.model.docModel,controller=widget.model.controller||docModel.controller,callback=$WRAP(controller._getXtabCallback(widget),getToolbarUpdateCallback.call(widget));controller.applyKeepOnly(widget,callback,{keepOnly:isKeepOnly,data:widget.getContextMenuSelections()},isKeepOnly?-2:undefined);};var sortAttributeTitle=function(menuItem){var ctx=menuItem.ctxt,gmCtr=widget.GMController,isAsc=ctx.isAsc,sortArray,actions,identity=ctx.identity;identity.tid=identity.id;widget.GMController.sortingMetric=false;if(identity){if(widget.getWidgetPropertyValue(ENUM_XML_TAG.SORT_INDEX)){gmCtr.property.removeItem(ENUM_XML_TAG.SORT_INDEX);gmCtr.property.removeItem(ENUM_XML_TAG.SORT_ORDER);}var header=gmCtr.attributeSelectionInfo[identity.tid];sortArray=gmCtr.getSortArray(null,null,header,isAsc);actions=gmCtr.getSortActions(sortArray);widget.updateAfterSort(actions);}};var sortMetricTitle=function(menuItem){widget.setWidgetPropertyValue("attributeSort",undefined);var ctx=menuItem.ctxt,gmCtr=widget.GMController,isAsc=ctx.isAsc,selInfo=ctx.selInfo,sortArray,cellHandle=selInfo.cellHandler||gmCtr.getCellHandler(0,0,selInfo.idx);if(cellHandle){gmCtr.sortingMetric=true;sortArray=gmCtr.getSortArray(cellHandle,isAsc);var actions=gmCtr.getSortActions(sortArray);widget.setWidgetPropertyValue(ENUM_XML_TAG.SORT_ORDER,isAsc);widget.setWidgetPropertyValue(ENUM_XML_TAG.SORT_INDEX,cellHandle);widget.updateAfterSort(actions);}};var addAttributeForm=function(identity){if(identity&&mstrmojo.resolveFeature("set-attributeform-display")){var gmZones=widget.zonesModel.gmZones,datasets=widget.zonesModel.docModel.datasets;if(!widget.GMController.isHistogram&&$DU.hasMultiForms(identity.did,datasets)){config.addEditorMenuItem(mstrmojo.desc(11908,"Display Attribute Forms"),gmZones.id,function(){var gmDropZones=widget.zonesModel;return $DU.getDisplayFormsMenu(identity,gmDropZones.getHost(),gmDropZones.docModel.datasets,function(actions){gmDropZones.submitDropZoneUpdates(actions);});});}}};var drill=function(menuItem){var drillUnit=menuItem.ctxt.drillUnit;drillGM(drillUnit);widget.noHighlightAfterKeepOnlyExcludeDrill=true;};var selectionKeepOnly=function(){updateAfterKeepOnly(true);widget.noHighlightAfterKeepOnlyExcludeDrill=true;};var selectionExclude=function(){updateAfterKeepOnly(false);widget.noHighlightAfterKeepOnlyExcludeDrill=true;};var addFormatOption=function(cfg){if(mstrApp.appState===mstrmojo.vi.VisualInsightApp.APP_STATES.PRESENTATION||mstrApp.isInVFInteractMode){return ;}cfg.addSeparator();cfg.addMenuItem(mstrmojo.desc(1918,"Format"),"xt",function(){mstrApp.rootCtrl.docCtrl.selectViPanel("propertiesPanel");widget.parent.selectVIUnit();});};var sortAscendingAttribute=function(menuItem){sortAttributeTitle(menuItem);widget.setWidgetPropertyValue("attributeSort","ascending");};var sortDescendingAttribute=function(menuItem){sortAttributeTitle(menuItem);widget.setWidgetPropertyValue("attributeSort","ascending");};var clearSort=function(){var actions=widget.GMController.getSortActions([]);widget.removeWidgetProperty(ENUM_XML_TAG.SORT_ORDER);widget.removeWidgetProperty(ENUM_XML_TAG.SORT_INDEX);widget.updateAfterSort(actions);widget.setWidgetPropertyValue("attributeSort",undefined);widget.clientRerenderGraphMatrix();};var getAttributeAxisMenu=function(info){var dzModel=widget.zonesModel.gmZones,items,item,zone,isMngdCG,EGTitle,zoneIdx;var fnFindZone=function(){var zones,i,j;zones=dzModel.dropZones;for(i in zones){items=zones[i].items;for(j in items){if(items[j].did===info.identity.id){item=items[j];return zones[i];}}}},fnFindZoneId=function(){var zones,i,j;zones=dzModel.dropZones;for(i in zones){if(zones[i].id===info.identity.zone){items=zones[i].items;for(j in items){if(items[j].did===info.identity.id){item=items[j];return zones[i];}}}}};zone=isDropZoneUnit?fnFindZoneId():fnFindZone();zoneIdx=$ARR.find(items,"id",item.id);var itemContext={zone:zone,axis:zone&&zone.id,idx:zoneIdx,da:items[zoneIdx].da,cnt:items.length,item:item,useDropzone:true};var attrId=info.identity.id||"",header=widget.GMController.attributeSelectionInfo[attrId],itemNotFromMDXCube=!dzModel.docModel.isFromMDXCube(attrId);if(!presentationMode&&itemContext.da&&itemNotFromMDXCube&&!mstrApp.isInVFConfigMode){config.addMenuItem(mstrmojo.desc(3224,"Edit..."),"",function(){dzModel.editDerivedAttribute(itemContext);},itemContext);config.addSeparator();}if(info.identity.zone!==ENUM_DZID.AdditionalMetrics&&info.identity.zone!==ENUM_DZID.ColorBy&&info.identity.zone!==ENUM_DZID.BreakBy&&!widget.GMController.isHistogram&&header&&!dzModel.isCustomGroup(info.identity)){config.addMenuItem(mstrmojo.desc(7974,"Sort Ascending"),"xt",sortAscendingAttribute,{isAsc:true,identity:info.identity,item:item});config.addMenuItem(mstrmojo.desc(7975,"Sort Descending"),"xt",sortDescendingAttribute,{isAsc:false,identity:info.identity,item:item});if(widget.getWidgetPropertyValue("attributeSort")||widget.GMController.firstRes.gsi.sorts[0].length!==0||widget.GMController.firstRes.gsi.sorts[1].length!==0){config.addMenuItem(mstrmojo.desc(11699,"Clear Sort"),"xt",clearSort,{identity:info.identity,item:item});}config.addSeparator();}if(!mstrApp.isInVFInteractMode){var isDynamicLinkAttr=dzModel.isDynamicLink(item);if(!mstrApp.isInVFConfigMode&&!presentationMode&&info.identity.zone!==ENUM_DZID.ColorBy){itemNotFromMDXCube=!dzModel.docModel.isFromMDXCube(item.did);if(dzModel.allowInsertNewAttribute(zone)&&!$VISUTIL.isCGorCon(widget,item)&&itemNotFromMDXCube&&!isDynamicLinkAttr&&mstrmojo.resolveFeature($FEATURES.INSERT_NEW_METRIC)){config.addMenuItem(mstrmojo.desc(13625,"Create Attribute..."),"",function(){dzModel.newDerivedAttribute(itemContext);},itemContext);}isMngdCG=item.t===47&&dzModel.getUnitInfoInTemplate(item.did).unit.ost===12033;EGTitle=dzModel.isAttribute(item)&&!dzModel.hasOldDEOverDatasets(item.did)?mstrmojo.desc(13295,"Create Groups..."):(isMngdCG?mstrmojo.desc(13296,"Edit Groups..."):null);if(EGTitle!==null&&!isDynamicLinkAttr){config.addMenuItem(EGTitle,"eg",dzModel.getCreateOrEditElementGroupFunc(itemContext));}config.addSeparator();}if(!mstrApp.isInVFConfigMode&&!widget.GMController.isHistogram&&!isDropZoneUnit&&mstrmojo.resolveFeature($FEATURES.WEB_DRILL_AND_LINK)){addDrillTo(info.identity&&info.identity.id);}if(!presentationMode){if(!isDynamicLinkAttr){addAttributeForm(item);config.addSeparator();}}if(dzModel.hasReplaceCandidates(itemContext)&&(!presentationMode||!!mstrmojo.resolveFeature($FEATURES.WEB_DRILL_AND_LINK))){config.addSubMenuItem(mstrmojo.desc(14003,"Replace With"),"",widget.zonesModel.id,dzModel.getReplaceSubMenu,itemContext);}if(info.el){config.addMenuItem(mstrmojo.desc(1388,"Rename"),"xt",function(){dzModel.renameItem(info.el,item);});}if(!presentationMode){config.addMenuItem(mstrmojo.desc(190,"Remove"),"xt",function(){dzModel.deleteItem(zone,itemContext.idx);});}}return config;};var getMetricAxisMenu=function(info){var extraInfo=info.identity,visGM=widget,gmCtr=visGM.GMController;extraInfo.rowId=shape.rowId;if(widget.GMController.isHistogram&&shape.axis==="y"){return ;}var combinedDZ=visGM.zonesModel,DZ=combinedDZ.gmZones,item=null,items=[],zone=(function(){var zones,i,j;zones=DZ.dropZones;for(i in zones){if(zones.hasOwnProperty(i)){items=zones[i].items;for(j in items){if(items.hasOwnProperty(j)){if(items[j].did===extraInfo.id){item=items[j];return zones[i];}}}}}}()),itemContext={zone:zone,axis:zone&&zone.id,idx:$ARR.find(items,"id",item.id),cnt:items.length,item:item,useDropzone:true};if(item.um&&!presentationMode&&!mstrApp.isInVFInteractMode&&!mstrApp.isInVFConfigMode){config.addMenuItem(mstrmojo.desc(3224,"Edit..."),"",function(){combinedDZ.editDerivedMetric(itemContext,"edit");},itemContext);config.addSeparator();}if(!widget.excludeData&&gmCtr.supportSort()&&widget.GMController.getChartInfo().isABL&&!widget.GMController.isHistogram&&!widget.GMController.isBoxPlot&&info.identity.zone!==ENUM_DZID.AdditionalMetrics&&info.identity.zone!==ENUM_DZID.ColorBy){config.addMenuItem(mstrmojo.desc(7974,"Sort Ascending"),"xt",sortMetricTitle,{isAsc:true,selInfo:extraInfo});config.addMenuItem(mstrmojo.desc(7975,"Sort Descending"),"xt",sortMetricTitle,{isAsc:false,selInfo:extraInfo});if(widget.GMController.firstRes.gsi.sorts[0].length!==0||widget.GMController.firstRes.gsi.sorts[1].length!==0){config.addMenuItem(mstrmojo.desc(11699,"Clear Sort"),"xt",clearSort,{item:item});}config.addSeparator();}if(!mstrApp.isInVFInteractMode){if(!mstrApp.isInVFConfigMode&&!widget.GMController.isHistogram&&!presentationMode&&mstrmojo.resolveFeature($FEATURES.INSERT_NEW_METRIC)){if(DZ.docModel.findDatasetIdFromUnit(item.did)&&!DZ.docModel.isFromSolrCube(item.did)&&!DZ.docModel.isFromMDXCube(item.did)){config.addSubMenuItem(mstrmojo.desc(11806,"Aggregate By"),"xt",combinedDZ.id,combinedDZ.getAggregateByMetricSubMenu,itemContext);config.addSeparator();}config.addEditorMenuItem(mstrmojo.desc(5188,"Calculation"),combinedDZ.id,combinedDZ.getCalculationEditorCfg,itemContext);config.addSubMenuItem(mstrmojo.desc(12287,"Shortcut Metric"),"xt",combinedDZ.id,combinedDZ.getShortcutMetricSubMenu,itemContext);config.addMenuItem(mstrmojo.desc(13624,"New Metric..."),"xt",function(){combinedDZ.newDerivedMetric(itemContext);},itemContext);config.addSeparator();}config.addSeparator();if(!presentationMode&&mstrApp&&mstrApp.supportFeature&&mstrApp.supportFeature($FEATURES.NUMBER_FORMATTING)){config.addEditorMenuItem(mstrmojo.desc(13237,"Number Format"),zonesModelId,dzModel.getNumberFormatEditorCfg,itemContext);}if(isDropZoneUnit){if(info.identity.zone===ENUM_DZID.ColorBy){dzModel.buildThresholdMenuOptions(config,itemContext,true);}}config.addSeparator();if(DZ.hasReplaceCandidates(itemContext)&&(!presentationMode||!!mstrmojo.resolveFeature($FEATURES.WEB_DRILL_AND_LINK))){config.addSubMenuItem(mstrmojo.desc(14003,"Replace With"),"",visGM.zonesModel.id,DZ.getReplaceSubMenu,itemContext);}if(isDropZoneUnit){config.addMenuItem(mstrmojo.desc(1388,"Rename"),"xt",function(){DZ.renameItem(info.el,item);});}if(!presentationMode){config.addMenuItem(mstrmojo.desc(190,"Remove"),"xt",function(){DZ.deleteItem(zone,itemContext.idx);});}}return config;};var attrId,cfg;if(shape.type===ENUM_CONTEXTMENUTARGETS.AX_TITLE){if(dzModel.isMetricName(info.identity)){if(info.identity.zone===ENUM_DZID.ColorBy){var id=mstrmojo.all[dzModel.hostId].zonesModel.id,zone=dzModel.getZoneModelByZoneId(ENUM_DZID.ColorBy);config.addMenuItem(mstrmojo.desc(190,"Remove"),"xt",function(){mstrmojo.all[id].deleteItem(zone,info.identity._renderIdx);});return config;}return config;}else{if(info.attributeAxis){cfg=getAttributeAxisMenu(info);}else{cfg=getMetricAxisMenu(info);}}if(!isDropZoneUnit){addFormatOption(cfg);}return cfg;}else{if(shape.type===ENUM_CONTEXTMENUTARGETS.DATA_PT||shape.type===ENUM_CONTEXTMENUTARGETS.LASSO){if(mstrApp.isInVFInteractMode){return config;}var dz=widget.model.data.dz,dzs=[dz.SliceBy,dz.BreakBy,dz.XAxis,dz.YAxis,dz.Rows,dz.Columns],uniqAttrIds=[];widget.contextMenuSelectedShapes.forEach(function(shape){shape.forEach(function(identity){uniqAttrIds=uniqAttrIds.filter(function(idnt){return idnt!==identity.id;});if(identity.id){uniqAttrIds.push(identity.tid);}});});$ARR.forEach(dzs,function(dz){if(dz.TemplateUnit){for(var i=dz.TemplateUnit.length-1;i>=0;i--){if(uniqAttrIds.indexOf(dz.TemplateUnit[i].id)!==-1){attrId=dz.TemplateUnit[i].id;return false;}}}});if(widget.GMController.supportViewFilter&&widget.isLinkedFilterEnabled&&widget.isLinkedFilterEnabled()){var fnApplyFilter=function(){widget.handleContextMenuSelectionData(true);};config.addMenuItem(mstrmojo.desc(15070,"Go to Targets"),"",fnApplyFilter);config.addSeparator();}if(attrId&&widget.GMController.supportViewFilter){config.addMenuItem(mstrmojo.desc(11701,"Keep Only"),"xt",selectionKeepOnly);config.addMenuItem(mstrmojo.desc(3946,"Exclude"),"xt",selectionExclude);if(!widget.GMController.isHistogram){if(mstrmojo.resolveFeature($FEATURES.WEB_DRILL_AND_LINK)){addDrillTo(attrId,true);}if(!presentationMode){config.addSeparator();var menuContext=prepareForGroup(widget._viContextMenuSelections),result=getGroupAndCalculationCMForDP(widget,menuContext);["editGroup","editCalculation","createDe"].forEach(function(name){$VISUTIL.absorbMenuItems(config,result[name],true);});}}}}}return config;},onContextMenu:function(widget,div,d,ctrlKey){if(ctrlKey){return ;}if(d&&d.shape&&d.shape.type===ENUM_CONTEXTMENUTARGETS.DO_NOT_CLEAR){return ;}widget.tooltip.hideTooltip(0);if(widget.noHighlightAfterKeepOnlyExcludeDrill){widget.clearSelections();}this.clearRMCStyle(widget);var menuConfig,point,candidate,cfg,e,selected,header,shape,noStyle;if(d.points){d.shape={};d.shape.type=ENUM_CONTEXTMENUTARGETS.DATA_PT;e=d.event;widget._viContextMenuSelections=[];if(e){if(e.stopPropagation){e.stopPropagation();}e.preventDefault();e.cancelBubble=true;}point=d.points[0];if(!point.information){return ;}}else{if(d.shape&&d.shape.type===ENUM_CONTEXTMENUTARGETS.AX_TITLE){shape=d.shape;var axis=shape.axis,axisNum=shape.axisNum,titleNum=shape.titleNum,attrAxis=shape.attrAxis;if(attrAxis){if(axis==="x"){header=widget.GMController.getXAxisHeaders(1,axisNum)[titleNum];}else{if(axis==="y"){header=widget.GMController.getYAxisHeaders(1,axisNum)[titleNum];}}}else{if(shape.identity){header=shape.identity;}else{return ;}}}else{if(d.shape&&d.shape.type!==ENUM_CONTEXTMENUTARGETS.LASSO){return ;}}}cfg=new $MOJO.ui.menus.MenuConfig();shape=d.shape;if(shape){if(shape.type===ENUM_CONTEXTMENUTARGETS.AX_TITLE){var info={identity:header,attributeAxis:shape.attrAxis};menuConfig=this.getMenuConfig(widget,shape,cfg,info);}else{if(shape.type===ENUM_CONTEXTMENUTARGETS.DATA_PT||shape.type===ENUM_CONTEXTMENUTARGETS.LASSO){if(d.points){candidate=getCandidateInfo(widget,d.points,false,true,false);if(!widget.GMController.isHistogram||!widget.GMController.isBoxPlot){widget.addContextMenuMetricValueSelection(candidate);}}else{d.points=[];cloneHighlightSelections(widget);}selected=shape.type===ENUM_CONTEXTMENUTARGETS.LASSO||isTargetSelected(widget,div,point);widget.contextMenuSelectedShapes=filterSelectedIdentities(widget._viContextMenuSelections);if(shape.type===ENUM_CONTEXTMENUTARGETS.DATA_PT){if(widget.GMController.isWaterfall&&point.data.isFakeBar&&point.data.information[point.pointNumber]){this.styleWaterfallOverlappedBar(point.data,point.pointNumber,selected,div,"rightMouse");}else{if(widget.GMController.isWaterfall&&point.data.isFakeBar){return ;}else{if(widget.GMController.isWaterfall){noStyle=point.information===-1;}}}if(point&&point.__target&&!noStyle){div.classList.add("shallow");point.__target.classed("RMClicked",true);if(selected){point.__target.classed("selected",true);}widget.rightMouseHighlights=[point.__target[0][0]];}else{if(shape.type!==ENUM_CONTEXTMENUTARGETS.LASSO&&!noStyle){var target=minifySelection(widget._viContextMenuSelections);widget.rightMouseHighlights=RMCStyleBoxPlot(getBoxPlotShapes(div,target,widget),selected,div);}}}menuConfig=this.getMenuConfig(widget,shape,cfg,d.points);}}}if(menuConfig&&menuConfig.hasMenuItems()&&!ctrlKey){this.showContextMenu({x:d.event.clientX,y:d.event.clientY},menuConfig);}return false;},onLayoutChanged:function(e,div){removeBoxOrLasso(div);},onClick:function(widget,div,d,ctrlKey,multiSelect){var endSelections=false;widget.noHighlightAfterKeepOnlyExcludeDrill=false;if(!multiSelect){removeBoxOrLasso(div);}if(!allowSelection(widget,d.points,ctrlKey)){var me=this,fnClearSelections=function(){widget.clearSelections();removeBoxOrLasso(div);div.classList.remove("shallow");me.clearHighlight(widget);widget.endSelections();};var pathString=mstrmojo.desc(16266,"To increase the maximum limit on data point selection, please go to Format Panel > Histogram Options > More Options.");if(widget.GMController.isWaterfall){pathString=mstrmojo.desc(16267,"To increase the maximum limit on data point selection, please go to Format Panel > Waterfall Options > More Options.");}else{if(widget.GMController.isBoxPlot){pathString=mstrmojo.desc(16268,"To increase the maximum limit on data point selection, please go to Format Panel > Box Plot Options > More Options.");}}mstrmojo.alert(mstrmojo.desc(16269,"The amount of data points you have selected is outside the maximum limit.")+"\n \n"+pathString,fnClearSelections);return ;}this.clearRMCStyle(widget);if(d.event&&!ctrlKey&&!$HASH.isEmpty(widget._viSelections)){endSelections=true;widget.clearSelections();}else{if(!d.points){return ;}}div.classList.add("shallow");if(!multiSelect&&!ctrlKey){this.clearHighlight(widget);widget.highlights=[];}var selInfo,shapes;selInfo=getCandidateInfo(widget,d.points,multiSelect,false,true);if(selInfo&&!$HASH.isEmpty(selInfo)){endSelections=true;widget.addMetricValueSelection(selInfo);}if(widget.GMController.isBoxPlot||widget.GMController.isHistogram){shapes=filterAggregateShapes(widget,div);this.highlightSelected(widget,shapes,div);}var pt=d.points&&d.points[0];if(pt.data.isFakeBar&&pt.data.information&&pt.data.information[pt.pointNumber]){this.styleWaterfallOverlappedBar(pt.data,pt.pointNumber,false,div,"highlight");}else{if(d.points&&d.points[0].__target&&!multiSelect&&!$HASH.isEmpty(widget._viSelections)){if(d.points[0].information){this.highlightPoint(d.points[0].__target[0][0]);}}}this.resetHighlights(widget,div);if(endSelections||!$HASH.isEmpty(widget._viSelections)){widget.endSelections();}},onSelected:function(widget,div,d,ctrlKey){delete widget.noHighlightAfterKeepOnlyExcludeDrill;var me=this,isEmptySelection=(!d||!d.points||!d.points.length);if(isEmptySelection){removeBoxOrLasso(div);if(d){if(!ctrlKey){if(!$HASH.isEmpty(widget._viSelections)){widget.clearSelections();widget.endSelections();}this.resetHighlights(widget,div);}}}else{if(!ctrlKey&&d.event.which!==3){if(!$HASH.isEmpty(widget._viSelections)){widget.clearSelections();}this.resetHighlights(widget,div);div.classList.add("shallow");}var emptySel=true;d&&d.points.forEach(function(pt){if(pt.data.isFakeBar||pt.data.information===-1||pt.data.information[pt.pointNumber]===-1){return ;}emptySel=false;if(pt.__target){me.highlightPoint(pt.__target[0][0]);}});if(emptySel&&d&&!ctrlKey){widget.endSelections();this.resetHighlights(widget,div);}this.onClick(widget,div,d,ctrlKey,true);}},onHover:function(tooltip,eventData,gmCtr,context,rct,layouter,calcdata,div,widget,touchHover){var xaxis,yaxis,points,hovermode,dataAdded,noStyle=false,isWaterfall=gmCtr.isWaterfall,isBoxPlot=gmCtr.isBoxPlot;points=eventData.points[0];xaxis=points.xaxis;yaxis=points.yaxis;hovermode=eventData.hovermode;if(hovermode==="closest"||hovermode===undefined){if(isBoxPlot){var bpStats=calcdata[points.curveNumber][0];dataAdded=tooltip.addDataAndSize(bpStats,xaxis,yaxis,gmCtr,rct);hoverBoxPlot(widget,eventData.points,div);}else{if(isWaterfall){if(points.data.information===-1){return ;}if(points.data.isFakeBar&&points.data.information[points.pointNumber]){noStyle=true;this.styleWaterfallOverlappedBar(points.data,points.pointNumber,false,div,"hover");}else{if(points.data.isFakeBar){return ;}}var ttA=points.data.tooltipMetrics,text=ttA[points.pointNumber];if(points.fullData.orientation==="v"){points.y=text;}else{points.x=text;}}if(points.__target&&!noStyle){widget.hoveredShape.push(points.__target.classed("hovered",true));if(!widget.GMController.isHistogram&&!widget.GMController.isBoxPlot&&(widget.GMController.chartType===CHART_TYPE.LINE||widget.GMController.chartType===CHART_TYPE.AREA)&&points.__target.style){points.__target.style("stroke-opacity",1);}}dataAdded=tooltip.addDataAndSize(points,xaxis,yaxis,gmCtr,rct);}if(!touchHover){$DOM.attachEvent(div,"mousemove",tooltip.move.call(tooltip,layouter));}if(dataAdded){tooltip.showTooltip();}}},onUnhover:function(div,tooltip,widget,touchHover){widget.hoveredShape.forEach(function(p){if(p.classed){p.classed("hovered",false);}else{if(p.classList.remove){p.classList.remove("hovered");}}if(!widget.GMController.isHistogram&&!widget.GMController.isBoxPlot&&!widget.GMController.isWaterfall&&(widget.GMController.chartType===CHART_TYPE.LINE||widget.GMController.chartType===CHART_TYPE.AREA)&&p.style&&!p.classed("RMClicked")){p.style("stroke-opacity",0);}});widget.hoveredShape=[];tooltip.hideTooltip();if(!touchHover){$DOM.detachEvent(div,"mousemove",tooltip.move.call(tooltip));}}});}());