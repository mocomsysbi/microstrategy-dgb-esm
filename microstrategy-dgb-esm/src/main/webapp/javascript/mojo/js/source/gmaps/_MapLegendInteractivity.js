(function(){mstrmojo.requiresCls("mstrmojo.dom","mstrmojo.css","mstrmojo.hash","mstrmojo.VisUtility","mstrmojo.gm.GMUtility","mstrmojo.gmaps.MapLegendEnums","mstrmojo.ui.editors.controls.AdvancedColorPicker");var $MOJO=mstrmojo,$DOM=$MOJO.dom,$HASH=$MOJO.hash,$CSS=$MOJO.css,$UTIL=$MOJO.VisUtility,$GM=$MOJO.gm,$GMU=$GM.GMUtility,$ACP=$MOJO.ui.editors.controls.AdvancedColorPicker,LGD_FORMAT_PROP=$MOJO.gmaps.LEGEND_FORMAT_PROPERTY;function getWidget(widgetId){return $MOJO.all[widgetId];}function updateColor(newColor){var map=getWidget(this.widgetId),oldColor=map.colorSqureIdentity.decodedColor;if(!$HASH.equals(newColor,oldColor)){newColor=$GMU.encodeColor(newColor);map.setProperty(LGD_FORMAT_PROP.COLOR_SQUARE_COLOR,newColor,{});}}function getColorPickerToolbar(colorIdentity){var me=this,map=getWidget(this.widgetId);map.colorSqureIdentity=colorIdentity;return new mstrmojo.ui.menus.ToolbarEditorConfig({cssClass:"cbsquare-colorpicker",contents:[new mstrmojo.ui.editors.controls.AdvancedColorPicker({showAutomatic:!colorIdentity.isDefaultColor,color:colorIdentity.decodedColor,colorChanged:function(color){color=(this.showAutomatic&&color===$ACP.VAL_AUTOMATIC)?"default":color;updateColor.call(me,color);me.hideToolbar();},colorCanceled:function(){me.hideToolbar();}})]});}function showToolBar(tfg){var map=getWidget(this.widgetId),domToolbarPH=map.domToolbarPH,me=this,toolEditor;map._lastOpened=null;domToolbarPH.innerHTML="";document.body.appendChild(domToolbarPH);$CSS.toggleClass(domToolbarPH,mstrApp.getThemeClassName(),true);tfg.hostId=map.id;tfg.hostElement=domToolbarPH;toolEditor=map.toolEditor=tfg.newInstance({unrender:function(){}});map.toolEditorClosefn=function(evt){var target=evt.target,toolbarRoot=toolEditor.domNode;if(!$DOM.contains(toolbarRoot,target,true,toolbarRoot)&&!$UTIL.isHostedPopupNode(target,"class",true,document.body)){me.hideToolbar();}};$DOM.attachEvent(document.body,"mousedown",map.toolEditorClosefn,true);map.openPopup(toolEditor);$CSS.toggleClass(document.body,"hasToolbarPopup",true);}function adjustColorPickerPos(ele){var pos=$DOM.position(ele),retPos={};retPos.x=pos.x+pos.w;retPos.y=pos.y+pos.h;return retPos;}function positionToolbarAndContextMenu(pos){var map=getWidget(this.widgetId),domToolbarPH=map.domToolbarPH,toolBar=domToolbarPH.firstChild,tbWidth,tbHeight,bodyWidth,bodyHeight,gap,upperPadding,outer,toolbarTop;if(!toolBar){return ;}tbWidth=toolBar.offsetWidth;tbHeight=toolBar.offsetHeight;bodyWidth=document.body.offsetWidth;bodyHeight=document.body.offsetHeight;gap=10;upperPadding=5;outer={w:tbWidth,h:tbHeight};toolbarTop=0;toolBar.style.left="0";toolBar.style.right="auto";toolBar.style.top="0";toolBar.style.bottom="auto";domToolbarPH.style.left=pos.x+"px";domToolbarPH.style.top=pos.y-tbHeight-gap/2+"px";if(pos.x+outer.w>bodyWidth){domToolbarPH.style.left=pos.x-tbWidth+"px";}if(pos.y-tbHeight-gap/2<upperPadding){toolbarTop=upperPadding;domToolbarPH.style.top=toolbarTop+"px";}else{if(pos.y+gap/2>bodyHeight){toolbarTop=Math.max(bodyHeight-gap-tbHeight,upperPadding);domToolbarPH.style.top=toolbarTop+"px";}}}mstrmojo.gmaps._MapLegendInteractivity=mstrmojo.provide("mstrmojo.gmaps._MapLegendInteractivity",{_mixinName:"mstrmojo.gmaps._MapLegendInteractivity",initializePH:function initializePH(){var map=getWidget(this.widgetId),domToolbarPH;if(!map.domToolbarPH){domToolbarPH=document.createElement("div");domToolbarPH.setAttribute("class","map-legend-placeholder");map.domToolbarPH=domToolbarPH;}},handleRMCColorPicker:function handleRMCColorPicker(target){var colorIdentity,tfg,pos;colorIdentity=target.colorIdentity;tfg=getColorPickerToolbar.call(this,colorIdentity);pos=adjustColorPickerPos(target);if(tfg){showToolBar.call(this,tfg);}positionToolbarAndContextMenu.call(this,pos);},hideToolbar:function hideToolbar(){var map=getWidget(this.widgetId),domToolbarPH=map.domToolbarPH,phChild=domToolbarPH.firstChild,phParent=domToolbarPH.parentNode,toolEditor;if(phChild){domToolbarPH.removeChild(phChild);}if(phParent){phParent.removeChild(domToolbarPH);}toolEditor=map.toolEditor;if(toolEditor){toolEditor.unrender=function(){toolEditor._super();};toolEditor.destroy();toolEditor.unrender=function(){};delete map.toolEditor;$CSS.toggleClass(document.body,"hasToolbarPopup",false);$CSS.toggleClass(domToolbarPH,mstrApp.getThemeClassName(),false);}if(map.toolEditorClosefn){$DOM.detachEvent(document.body,"mousedown",map.toolEditorClosefn,true);delete map.toolEditorClosefn;}}});}());