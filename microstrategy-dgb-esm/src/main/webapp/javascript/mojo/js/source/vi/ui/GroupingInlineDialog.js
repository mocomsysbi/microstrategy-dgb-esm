(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.vi.ui.tabs.TabStrip","mstrmojo.Button","mstrmojo.Label","mstrmojo.Widget","mstrmojo._HasLayout","mstrmojo.hash","mstrmojo.css","mstrmojo.array");var $HASH=mstrmojo.hash,$CSS=mstrmojo.css,$ARR=mstrmojo.array;var selectedKeys=[];function getButtonConfig(text,fn,isHot,props){return mstrmojo.Button.newWebButton(text,fn,isHot,$HASH.copy(props,{slot:"buttonNode",ignoreLayout:true}));}function getInitBoxStatusFn(groupInfo){return function initBoxStatus(child){var isInGroup=false;$HASH.forEach(groupInfo,function(groupArr){if(groupArr.indexOf(child.k)!==-1){isInGroup=true;return false;}});child.startGrouping(!isInGroup);};}function doGroupSelection(keys,groupInfo,vizContentPanel,dialog,extra){var newGroupId=extra&&extra.selectedGroupId,deleteGroupId=extra&&extra.deleteGroupId;if(deleteGroupId){dialog.deleteGroup(deleteGroupId);return ;}if(!newGroupId){if(!keys.length){return ;}var newGroup=[];$HASH.forEach(keys,function(key){newGroup.push(key);var groupId=vizContentPanel.findGroupByKey(key);if(groupId){vizContentPanel.deleteGroup(groupId);}});newGroupId=vizContentPanel.addGroup(newGroup);}vizContentPanel.setLastSelectionClass(null,selectedKeys[selectedKeys.length-1]);dialog.updateGroupList(groupInfo,newGroupId);}function getOnBoxSelectionChangeFn(id){return function(keys,isDone,extra){var dialog=mstrmojo.all[id],vizContentPanel=dialog.vizContentPanel,selectedKeyCount=selectedKeys.length,groupInfo=vizContentPanel.getGroupInfo();var groupList=dialog.groupList,selectedGroup=groupList.getSelectedTab(),selectedGroupId=selectedGroup&&selectedGroup.k;if(selectedGroupId){groupList.setSelectedTab(null);vizContentPanel.disableGroup(selectedGroupId);}if(isDone){doGroupSelection(keys,groupInfo,vizContentPanel,dialog,extra);return ;}var isAdded=true,changedKey=null,inGroupId,groupArr;$ARR.forEach(selectedKeys,function(key){var pos=$ARR.indexOf(keys,key);if(pos!==-1){keys.splice(pos,1);}else{isAdded=false;changedKey=key;return false;}});if(isAdded){changedKey=keys[0];vizContentPanel.setLastSelectionClass(selectedKeyCount>0?changedKey:null,selectedKeys[selectedKeyCount-1]);inGroupId=vizContentPanel.findGroupByKey(changedKey);if(inGroupId){var inGroup=groupInfo[inGroupId];groupArr=$ARR.filter(inGroup,function(key){return key!==changedKey;});vizContentPanel.selectGroup(selectedGroupId===inGroupId?inGroup:groupArr);selectedKeys=selectedKeys.concat(groupArr);groupList.shineGroup(inGroupId);}selectedKeys.push(changedKey);}else{selectedKeys.splice(selectedKeys.indexOf(changedKey),1);inGroupId=vizContentPanel.findGroupByKey(changedKey);if(inGroupId){vizContentPanel.disableGroup(inGroupId);groupArr=groupInfo[inGroupId];selectedKeys=$ARR.filter(selectedKeys,function(key){var isInGroup=$ARR.indexOf(groupArr,key)!==-1;if(isInGroup){vizContentPanel.setLastSelectionClass(null,key);}return !isInGroup;});}selectedKeyCount=selectedKeys.length;vizContentPanel.setLastSelectionClass(selectedKeyCount>1?selectedKeys[selectedKeyCount-1]:null,changedKey);if(selectedKeyCount===1){vizContentPanel.setLastSelectionClass(null,selectedKeys[0]);}var isInOneGroup,selectedUnitsGroupId=vizContentPanel.findGroupByKey(selectedKeys[0]);if(selectedUnitsGroupId&&selectedKeyCount>1){isInOneGroup=true;$ARR.forEach(selectedKeys,function(key){if(vizContentPanel.findGroupByKey(key)!==selectedUnitsGroupId){isInOneGroup=false;return false;}});}if(isInOneGroup){vizContentPanel.setLastSelectionClass(null,selectedKeys[selectedKeyCount-1]);}}};}function fnEnableChild(child){child.endGrouping();}mstrmojo.vi.ui.GroupingInlineDialog=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasLayout],{scriptClass:"mstrmojo.vi.ui.GroupingInlineDialog",markupString:'<div id="{@id}" class="mstrmojo-grouping {@cssClass}"><div class="content"></div><div class="buttons"></div></div>',markupSlots:{containerNode:function(){return this.domNode.firstChild;},buttonNode:function(){return this.domNode.lastChild;}},layoutConfig:{w:{containerNode:"100%",buttonNode:"240px"},xt:true},vizContentPanel:null,groupList:null,hingMsg:null,children:[{scriptClass:"mstrmojo.vi.ui.tabs.TabStrip",alias:"groupList",slot:"containerNode",isAlignRight:false,onvisibleChange:mstrmojo.Widget.visibleMarkupMethod,layoutConfig:{w:{tabContainerNode:"100%",btnBarNode:"52px"},xt:true},getTabCfg:function getTabCfg(tabObjects,currentTab,cfg){return $HASH.copy({title:currentTab.n,onclick:function onclick(evt){var target=evt.getTarget(),tabStrip=this.parent,key=this.k;if(target===this.menuBtnNode){tabStrip.parent.deleteGroup(key);}else{if(!this.isSelected){tabStrip.setSelectedTab(key);}}}},cfg);},setSelectedTab:function setSelectedTab(selectedKey){if(selectedKey){var lastSelectedTab=this.getSelectedTab();this.parent.highlightGroup(selectedKey,lastSelectedTab&&lastSelectedTab.k);}mstrmojo.vi.ui.tabs.TabStrip.prototype.setSelectedTab.call(this,selectedKey);},shineGroup:function shineGroup(groupId){var tab=(this.children||[]).filter(function(tab){return tab.k===groupId;})[0],tabNode=tab.domNode;$CSS.addClass(tabNode,"shine");window.setTimeout(function(){$CSS.addClass(tabNode,"animation-fade");},10);window.setTimeout(function(){$CSS.removeClass(tabNode,["shine","animation-fade"]);},500);}},getButtonConfig(mstrmojo.desc(221,"Cancel"),function cancel(){this.parent.close();},false),{scriptClass:"mstrmojo.Label",alias:"hintMsg",slot:"containerNode",allowHTML:true,text:mstrmojo.desc(15279,"Select containers to create group(s) for responsive view (width &le; 768px)")},getButtonConfig(mstrmojo.desc(118,"Save"),function apply(){var dialog=this.parent;dialog.vizContentPanel.submitGroupInfo();dialog.close();},true,{alias:"saveBtn",enabled:false}),getButtonConfig("",function apply(){mstrApp.rootCtrl.togglePreviewMode();var me=this;me.hideTooltip();window.setTimeout(function(){me.showTooltip({target:me.domNode});},0);},false,{cssClass:"previewBtn",useRichTooltip:true,updateTooltipConfig:function(evt){var target=evt.target;this.richTooltip={content:mstrApp.isLayoutModePreview()?mstrmojo.desc(15278,"Full View"):mstrmojo.desc(15277,"Responsive Preview"),cssClass:"vi-regular vi-tooltip-A A-center btn root-toolbar-tooltip",posType:"TC",left:target.offsetLeft+9,top:target.offsetTop+25};}})],open:function open(){var formWrapper=window.FormWrapper;if(formWrapper){formWrapper.toggleNetMenu("disable");}var isPause=mstrApp.isAppStatePause&&mstrApp.isAppStatePause(),appStates=mstrmojo.vi.VisualInsightApp.APP_STATES;mstrApp.set("appState",appStates.SELECTOR_TARGETING|(isPause?appStates.PAUSE:0));var vizContentPanel=this.vizContentPanel,groupInfo=vizContentPanel.getGroupInfo();vizContentPanel.restoreAnyMaxedVizBox();this._orgGroupInfo=$HASH.clone(groupInfo);this.updateGroupList(groupInfo,null);this.changeTabStripMask(true);vizContentPanel.enterTargetSelectionMode(getOnBoxSelectionChangeFn(this.id),null,null,getInitBoxStatusFn(groupInfo));},close:function onClose(){if(mstrApp.isLayoutModePreview()){mstrApp.rootCtrl.togglePreviewMode();}this.changeTabStripMask(false);this.vizContentPanel.exitTargetSelectionMode(false,fnEnableChild);this.vizContentPanel.clearGroupInfo();selectedKeys=[];mstrApp.rootCtrl.view.closeInlineDialog();var isPause=mstrApp.isAppStatePause&&mstrApp.isAppStatePause(),appStates=mstrmojo.vi.VisualInsightApp.APP_STATES;mstrApp.set("appState",isPause?appStates.PAUSE:appStates.DEFAULT);var formWrapper=window.FormWrapper;if(formWrapper){formWrapper.toggleNetMenu("enable");}},changeTabStripMask:function changeTabStripMask(enter){var panelSelector=this.vizContentPanel.parent.selector,docView=mstrApp.rootCtrl.view.documentView,layoutSelector=docView.layoutViewer.docLayout.selector;layoutSelector.set("isMasked",enter);panelSelector.set("isMasked",enter);},updateGroupList:function updateGroupList(groupInfo,selectedGroupId){var items=[],groupList=this.groupList,selectedItem=groupList.getSelectedTab();if(!selectedGroupId){selectedGroupId=selectedItem&&selectedItem.k;}$HASH.forEach(groupInfo,function(groupArr,groupId){items.push({n:mstrmojo.desc(1911,"Group")+" "+(items.length+1),k:groupId});});groupList.setTabs(items);if(selectedGroupId){groupList.setSelectedTab(selectedGroupId);}groupList.setStatic(false,true);var hasItem=items.length>0;groupList.set("visible",hasItem);this.hintMsg.set("visible",!hasItem);this.vizContentPanel.toggleHasGroupCSS(items.length>0);this.saveBtn.set("enabled",!$HASH.equals(this._orgGroupInfo,groupInfo));},highlightGroup:function highlightGroup(newGroupId,oldGroupId){var vizContentPanel=this.vizContentPanel,disableGroups=[];selectedKeys.forEach(function(key){var groupId=vizContentPanel.findGroupByKey(key);if(disableGroups.indexOf(groupId)===-1){disableGroups.push(groupId);}});if(oldGroupId&&disableGroups.indexOf(oldGroupId)===-1){disableGroups.push(oldGroupId);}vizContentPanel.clearGroupSelection();disableGroups.forEach(function(groupId){vizContentPanel.disableGroup(groupId);});selectedKeys=[];vizContentPanel.highlightGroup(newGroupId);},deleteGroup:function deleteGroup(groupId){var vizContentPanel=this.vizContentPanel;vizContentPanel.deleteGroup(groupId);this.updateGroupList(vizContentPanel.getGroupInfo(),null);}});}());