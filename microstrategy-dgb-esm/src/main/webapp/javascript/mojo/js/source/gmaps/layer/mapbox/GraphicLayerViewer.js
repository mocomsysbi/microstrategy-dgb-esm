(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.hash","mstrmojo.gmaps.MapEnums","mstrmojo.mapbox.MapboxEnums","mstrmojo.gmaps.MapUtils","mstrmojo.gmaps.GraphicUtils","mstrmojo.gmaps.layer.mapbox._ClusterViewerWrapper","mstrmojo.gmaps.layer.mapbox._DataLabelViewerWrapper","mstrmojo.gmaps.layer.AbstractGraphicLayerViewer");var $MOJO=mstrmojo,emptyFn=$MOJO.emptyFn,$ALL=$MOJO.all,$ARR=$MOJO.array,$H=$MOJO.hash,$GMAPS=$MOJO.gmaps,$EnumPropertyType=$GMAPS.EnumPropertyType,$MAPBOX=$MOJO.mapbox,$MUTILS=$GMAPS.MapUtils,$GUTILS=$GMAPS.GraphicUtils,$EnumGeomertyDefaultShapeFormat=$GMAPS.EnumDefaultShapeFormatStyle,$FILTER=$MAPBOX.FILTER,FMTS_DEFAULT={fillColor:$EnumGeomertyDefaultShapeFormat.FILL_COLOR,fillOpacity:0.85,strokeColor:$EnumGeomertyDefaultShapeFormat.BORDER_COLOR,strokeWidth:parseInt($EnumGeomertyDefaultShapeFormat.BORDER_WIDTH),strokeOpacity:0.8},ID_SUFFIX=$MAPBOX.ID_SUFFIX,$ZoomAnimationDelta=$GMAPS.ZoomAnimationDelta;function searchFeaturesInsideExtent(map,layerIds,extent){if(!extent||!map||!layerIds){return ;}var bbox=[[extent.x,extent.y],[extent.x+extent.width,extent.y+extent.height]];return map.queryRenderedFeatures(bbox,{layers:layerIds});}function searchFeaturesInsideCircle(map,layerIds,circle){if(!circle||!circle.radius||!map||!layerIds){return ;}var radius=circle.radius,x=circle.x,y=circle.y,geoRadius=circle.geoRadius,bbox=[x-radius,y-radius,x+radius,y+radius],centerLatLng=map.unproject([x,y]),geoCenter=turf.point([centerLatLng.lng,centerLatLng.lat]),circlePolygon,unit="kilometers";if(geoRadius&&geoCenter){circlePolygon=turf.circle([circle.lng,circle.lat],geoRadius,1024,unit);return circlePolygon&&searchFeaturesInsidePolygon(map,layerIds,circlePolygon,bbox,function(point){return turf.distance(geoCenter,point,unit)<=geoRadius;});}}function searchFeaturesInsidePolygon(map,layerIds,geoPolygon,bbox,checkPointInside){if(!geoPolygon||!map||!layerIds||!bbox||bbox.length<1){return ;}var features=map.queryRenderedFeatures([[bbox[0],bbox[1]],[bbox[2],bbox[3]]],{layers:layerIds});features=$ARR.filter(features,function(feature){var ret;switch(getFeatureType(feature)){case"Point":if(checkPointInside){return checkPointInside(feature);}else{return turf.inside(feature,geoPolygon);}case"Polygon":case"MultiPolygon":try{ret=turf.intersect(turf.buffer(feature,0),turf.buffer(geoPolygon,0));return !!ret.geometry;}catch(e){console.log("Invalid selection shape.");return false;}default:return false;}});return features;}function convertToGeoPolygon(polygon,map){if(!polygon||!map){return ;}var geoPoint,coordinates=$ARR.map(polygon.geometry.coordinates,function(polyline){return $ARR.map(polyline,function(point){if(point){geoPoint=map.unproject(point);return[geoPoint.lng,geoPoint.lat];}});});return turf.polygon(coordinates);}function getFeatureType(feature){if(feature&&feature.geometry){return feature.geometry.type;}}function adjustOpacity(opacity,factor){if(typeof opacity==="number"){opacity=opacity*factor;}else{var stops=opacity.stops;opacity["default"]=factor*opacity["default"];if(stops){$ARR.forEach(stops,function(stop){stop[1]=factor*stop[1];});}}return opacity;}mstrmojo.gmaps.layer.mapbox.GraphicLayerViewer=mstrmojo.declare(mstrmojo.gmaps.layer.AbstractGraphicLayerViewer,[mstrmojo.gmaps.layer.mapbox._ClusterViewerWrapper,mstrmojo.gmaps.layer.mapbox._DataLabelViewerWrapper],{scriptClass:"mstrmojo.gmaps.layer.mapbox.GraphicLayerViewer",data:null,type:"fill",_layerIds:null,cluster:null,strokeColorSelection:"#000000",fillOpacitySelection:1,labelTextAnchor:"top",hoverOpacity:0.9,shapeFmtNames:null,init:function init(props){this._super(props);this.data=this.data||this.getData(props.graphics);delete this.graphics;this.addComponents();this.setVisibility(this.isVisible());},addComponents:function addComponents(){this.initCluster();var ret=this.addSource();if(ret){this.addLayers();}},initCluster:function initCluster(){var baseLayer;if(this.isCluster){var cluster=this.cluster=supercluster({radius:this.clusterRadius,maxZoom:this.clusterMaxZoom-1});cluster.load(this.data.features);baseLayer=this.parent&&this.parent.getBaseLayer();this.zoomLevelChangeListener=baseLayer&&baseLayer.attachEventListener("zoomLevelChanged",this.id,function(e){this.highlightGraphics(this.parent.selectedGraphics);});}},getLayerId:function getLayerId(){return this.key;},getSourceId:function getSourceId(){return this.getLayerId()+ID_SUFFIX.Source;},getLayerCtrlProps:function getLayerCtrlProps(id,type,sourceId,filter,sourceLayerName,zoomRange){var props={id:id,type:type,source:sourceId};if(filter){props.filter=filter;}if(sourceLayerName){props["source-layer"]=sourceLayerName;}if(!zoomRange){zoomRange=this.getLayerZoomRange();}props.minzoom=zoomRange.minzoom;props.maxzoom=zoomRange.maxzoom;return props;},getDataLabelSourceLayer:emptyFn,getLabelTextOffset:function getLabelTextOffset(){return{type:"identity",property:"labelOffset"};},addSource:function addSource(){var map=this.getMapInstance(),sourceId=this.getSourceId();if(map){if(map.getSource(sourceId)){map.removeSource(sourceId);}map.addSource(sourceId,$H.copy(this.getExtraSourceProps(),{type:"geojson",data:this.data,cluster:this.isCluster,clusterMaxZoom:this.clusterMaxZoom-1,clusterRadius:this.clusterRadius}));return true;}else{return false;}},addLayers:function addLayers(){var map=this.getMapInstance(),id=this.getLayerId(),type=this.type,sourceId=this.getSourceId();if(!map){return ;}this._layerIds=[id,id+ID_SUFFIX.Unselected,id+ID_SUFFIX.Selection,id+ID_SUFFIX.ContextMenu,id+ID_SUFFIX.Hover];map.addLayer($H.copy(this.getLayerOptions(),this.getLayerCtrlProps(id,type,sourceId,this.getBaseFilters())));map.addLayer($H.copy(this.getLayerOptionsUnselected(),this.getLayerCtrlProps(id+ID_SUFFIX.Unselected,type,sourceId,$FILTER.NOFEATURE)));map.addLayer($H.copy(this.getLayerOptionsSelection(),this.getLayerCtrlProps(id+ID_SUFFIX.Selection,type,sourceId,$FILTER.NOFEATURE)));map.addLayer($H.copy(this.getLayerOptionsContextMenu(),this.getLayerCtrlProps(id+ID_SUFFIX.ContextMenu,type,sourceId,$FILTER.NOFEATURE)));map.addLayer($H.copy(this.getLayerOptionsHover(),this.getLayerCtrlProps(id+ID_SUFFIX.Hover,type,sourceId,$FILTER.NOFEATURE)));if(this.isCluster){this.addClusterLayers(map,sourceId);}this.addDataLabelLayer(map);},getQueryLayers:function getQueryLayers(){var id=this.getLayerId(),layerIds=[];if(id){layerIds=[id+ID_SUFFIX.Hover,id+ID_SUFFIX.Selection,id+ID_SUFFIX.Unselected,id+ID_SUFFIX.ContextMenu,id];if(this.isCluster){layerIds.push(id+ID_SUFFIX.Cluster);}}return this.validLayers(layerIds);},setVisibility:function setVisibility(isVisible){var map=this.getMapInstance();if(map){$ARR.forEach(this.validLayers(this._layerIds),function(id){map.setLayoutProperty(id,"visibility",isVisible?"visible":"none");});}},setLayerZIndex:function setLayerZIndex(zIndex,nextLayerKey){var map=this.getMapInstance(),_layerIds=this._layerIds,style=map&&map.getStyle(),layers=style&&style.layers;if(!map||!$ARR.isArray(_layerIds)){return ;}if(nextLayerKey&&$ARR.find(layers,"id",nextLayerKey)<0){return ;}$ARR.forEach(this.validLayers(_layerIds),function(id){map.moveLayer(id,nextLayerKey);});},hide:function hide(){var map=this.getMapInstance();if(map){$ARR.forEach(this._layerIds,function(id){map.setLayoutProperty(id,"visibility","none");});}},getBaseFilters:function getBaseFilters(){return $FILTER.SINGLE;},getFilters4MainLayer:function getFilters4MainLayer(reset,featureIds){var baseFilters=this.getBaseFilters();if(reset){return baseFilters;}else{return["all",baseFilters,["!in","id"].concat(featureIds)];}},getHoverLayerFromFeature:function getHoverLayerFromFeature(feature){return feature.layer.id;},handleHover:function handleHover(feature,e){var map=this.getMapInstance(),layers=this.getPrimaryShapeLayers();if(!map||!layers){return ;}if(feature){if(this.isClusterFeature(feature)){this.handleClusterHover(feature);}else{this.handleFeatureHover(map,this.getHoverLayerFromFeature(feature),feature);}var vismap=this.parent&&this.parent.map,isTooltipShown=vismap&&vismap.getPropertyValue($EnumPropertyType.tooltipSwitch);if(isTooltipShown!=="false"){this.showTooltip(feature,e);}}else{$ARR.forEach(layers,function(layerId){this.handleFeatureHover(map,layerId);},this);if(this.isCluster){this.handleClusterHover();}}},handleFeatureHover:function handleFeatureHover(map,layerId,feature){layerId=this.getLayerId();if(map&&layerId){if(feature){map.setFilter(layerId+ID_SUFFIX.Hover,["==","id",feature.properties.id]);}else{map.setFilter(layerId+ID_SUFFIX.Hover,$FILTER.NOFEATURE);}}},handleColorByOpacityChange:function handleColorByOpacityChange(updatedOpacityStop){this.data.opacityStops=updatedOpacityStop;this.setShapeFillOpacity(this.getFillOpacity());},handleColorByColorChange:function handleColorByColorChange(updatedColor,updatedSeleColor,updatedHoverColor,unSelectedColor){this.data.colorStops=updatedColor;this.data.seleColorStops=updatedSeleColor;this.data.hoverColorStops=updatedHoverColor;this.data.unSelectedColorStops=unSelectedColor;this.setShapeFillColor();},handleContextMenu:function handleContextMenu(graphics){var map=this.getMapInstance(),idList=this.getFeatureIDsFromGraphics(graphics),layerId=this.getLayerId(),isCluster=this.isCluster;if(!map||!map.getLayer(layerId)){return ;}if(isCluster){this.handleClusterContextMenu(idList);}if(!idList||idList.length<1){map.setFilter(layerId,this.getFilters4MainLayer(true));map.setFilter(layerId+ID_SUFFIX.ContextMenu,["==","id",""]);}},handleSelections:function handleSelections(idList){var map=this.getMapInstance(),layerId=this.getLayerId(),isCluster=this.isCluster;if(!map||!map.getLayer(layerId)){return ;}if(isCluster){this.handleClusterSelection(idList);}if(!idList||idList.length<1){map.setFilter(layerId,this.getFilters4MainLayer(true));map.setFilter(layerId+ID_SUFFIX.Selection,$FILTER.NOFEATURE);map.setFilter(layerId+ID_SUFFIX.ContextMenu,$FILTER.NOFEATURE);map.setFilter(layerId+ID_SUFFIX.Unselected,$FILTER.NOFEATURE);}},handleHighlight:function handleHighlight(graphicsSel,graphicsCtx){var idListSel=this.getFeatureIDsFromGraphics(graphicsSel),idListCtx=this.getFeatureIDsFromGraphics(graphicsCtx);var map=this.getMapInstance(),layerId=this.getLayerId(),isCluster=this.isCluster;if(!map||!map.getLayer(layerId)){return ;}if(isCluster){this.handleClusterSelection(idListSel);this.handleClusterContextMenu(idListCtx);}map.setFilter(layerId,$FILTER.NOFEATURE);map.setFilter(layerId+ID_SUFFIX.Selection,["in","id"].concat(idListSel));map.setFilter(layerId+ID_SUFFIX.ContextMenu,["in","id"].concat(idListCtx));map.setFilter(layerId+ID_SUFFIX.Unselected,this.getFilters4MainLayer(false,idListSel.concat(idListCtx)));},contain:function contain(feature){var targetLayerId=feature&&feature.layer.id,layerIds=this.getQueryLayers();return layerIds&&targetLayerId&&layerIds.indexOf(targetLayerId)!==-1;},showTooltip:function showTooltip(feature,e){var map=this.getMapInstance(),parent=this.parent;if(map&&parent&&feature&&e){parent.showTooltip(this.getGraphicsFromFeature(feature),{x:e.clientX,y:e.clientY});}},getData:function getData(graphics){var me=this,colorStops=[],opacityStops=[],seleColorStops=[],hoverColorStops=[],unSelectedColorStops=[],featureId;$ARR.forEach(graphics,function(graphic){var attributes=graphic.attributes,properties=me.extractShapeProps(attributes);featureId=graphic.id;if(featureId&&properties.fillColor){colorStops.push([featureId,properties.fillColor]);opacityStops.push([featureId,properties.fillOpacity]);seleColorStops.push([featureId,$MUTILS.fillColorAjustForCMSelection(properties.fillColor)]);hoverColorStops.push([featureId,$MUTILS.fillColorAjustForHover(properties.fillColor)]);unSelectedColorStops.push([featureId,properties.fillColor]);}});return{type:"FeatureCollection",colorStops:colorStops,opacityStops:opacityStops,seleColorStops:seleColorStops,hoverColorStops:hoverColorStops,unSelectedColorStops:unSelectedColorStops,features:$ARR.map(graphics,function(shape){var geoData=shape&&shape.geoData;if(geoData){return{type:"Feature",geometry:{type:shape.type,coordinates:[geoData.lng,geoData.lat]},properties:$H.copy(me.extractShapeProps(shape.attributes),{id:shape.id})};}})};},getExtraSourceProps:emptyFn,extractShapeProps:function extractShapeProps(attributes){if(!attributes){return ;}var threshold=attributes.threshold,color=attributes.color,fillColor=FMTS_DEFAULT.fillColor,fontSize=this.getFontSize(),labelOffset=this.getLabelOffset(attributes),values=attributes.values,imgUrl,fillOpacity=FMTS_DEFAULT.fillOpacity;if(threshold){fillColor=threshold.colorStr||fillColor;imgUrl=this.getIconInStudio(threshold.url);}else{if(color){fillColor=color.value;fillOpacity=color.opacity;}}if(labelOffset&&fontSize){labelOffset=$ARR.map(labelOffset,function(offset){return offset/fontSize;});}return{fillColor:fillColor,fillColorCMSelection:$MUTILS.fillColorAjustForCMSelection(fillColor),imgUrl:imgUrl,labelText:attributes.dataLabelText,labelValues:(values&&values.length>0)?values.join(", "):"",labelOffset:labelOffset,fillOpacity:fillOpacity};},getIconInStudio:function getIconInStudio(imgUrl){if(!imgUrl){return ;}var arr=imgUrl.split("/"),tmp;if(arr.length>0){tmp=arr[arr.length-1];return tmp&&tmp.split(".")[0];}},getGraphicIDsFromFeatureIDs:function getGraphicIDsFromFeatureIDs(features){var rets=[];$ARR.forEach(features,function(feature){$ARR.forEach(this.desolveFeature(feature),function(item){rets.push(item.properties.id);});},this);return rets;},getGraphicsFromFeature:function getGraphicsFromFeature(feature){var features=this.desolveFeature(feature),graphicIds=this.getGraphicIDsFromFeatureIDs(features);return $ARR.map(graphicIds,function(gid){if(gid){return $ALL[gid];}});},getGraphicsFromFeatures:function getGraphicsFromFeatures(features){var graphicIds=this.getGraphicIDsFromFeatureIDs(features);return $ARR.map(graphicIds,function(gid){if(gid){return $ALL[gid];}});},getFeatureIDsFromGraphics:function getFeatureIDsFromGraphics(graphics){return $ARR.map(graphics,function(graphic){return graphic.id;});},isLayerZoomRangeAnimationEnable:function isLayerZoomRangeAnimationEnable(){var minzoom=this.minzoom,maxzoom=this.maxzoom,baseLayer=this.parent.getBaseLayer(),baseLayerMinZoom=baseLayer.minZoom,baseLayerMaxZoom=baseLayer.maxZoom,enableMinZoomAnimation=minzoom>baseLayerMinZoom,enableMaxZoomAnimation=maxzoom<baseLayerMaxZoom,enableAnimation=(enableMaxZoomAnimation||enableMinZoomAnimation)&&((maxzoom-minzoom)>$ZoomAnimationDelta*2);return{enableAnimation:enableAnimation,enableMaxZoomAnimation:enableMaxZoomAnimation,enableMinZoomAnimation:enableMinZoomAnimation};},getLayerPropVal:function getLayerPropVal(matchProp,defaultVal,selectedIDs,specialVal){var stops=[];if(!selectedIDs||selectedIDs.length===0){return defaultVal;}$ARR.forEach(selectedIDs,function(id){stops.push([id,specialVal]);});return{property:matchProp,type:"categorical","default":defaultVal,stops:stops};},getFillOpacityForZoomAnimation:function getFillOpacityForZoomAnimation(fillOpacityValue){var fillOpacity,minzoom=this.minzoom,maxzoom=this.maxzoom,isAnimationEnable=this.isLayerZoomRangeAnimationEnable(),enableMinZoomAnimation=isAnimationEnable.enableMinZoomAnimation,enableMaxZoomAnimation=isAnimationEnable.enableMaxZoomAnimation,enableAnimation=isAnimationEnable.enableAnimation;if(enableAnimation){fillOpacity={stops:[]};fillOpacity["default"]=fillOpacityValue;if(enableMinZoomAnimation){fillOpacity.stops.push([minzoom,0]);fillOpacity.stops.push([minzoom+$ZoomAnimationDelta,fillOpacityValue]);}if(enableMaxZoomAnimation){fillOpacity.stops.push([maxzoom-(this.hasConnectingLayer?2:1)*$ZoomAnimationDelta,fillOpacityValue]);fillOpacity.stops.push([maxzoom,0]);}}else{fillOpacity=fillOpacityValue;}return fillOpacity;},getFillOpacityNormal:function getFillOpacityNormal(selectedIDs){var fmts=this.getFmts(),defaultVal=fmts.fillOpacity,fillOpacity;fillOpacity=this.getLayerPropVal("id",defaultVal,selectedIDs,defaultVal*$EnumGeomertyDefaultShapeFormat.FILL_OPACITY_FACTOR_HOVER);return this.getFillOpacityForZoomAnimation(fillOpacity);},getFillOpacity:function getFillOpacity(selectedIDs){var ret;if(this.hasColorByAttr()){ret=this.getFillOpacityInColorByAttr(selectedIDs);}else{ret=this.getFillOpacityNormal(selectedIDs);}return ret;},getFillOpacityInColorByAttr:function getFillOpacityInColorByAttr(selectedIDs){var fmts=this.getFmts(),defaultVal=fmts.fillOpacity,stops=[],opacityStops=this.data.opacityStops,fFillOpacity,fId,selId=null,minzoom=this.minzoom,maxzoom=this.maxzoom,minStartStops=[],minEndStops=[],maxStartStops=[],maxEndStops=[],isAnimationEnable=this.isLayerZoomRangeAnimationEnable(),enableMinZoomAnimation=isAnimationEnable.enableMinZoomAnimation,enableMaxZoomAnimation=isAnimationEnable.enableMaxZoomAnimation,enableAnimation=isAnimationEnable.enableAnimation;if(selectedIDs&&selectedIDs.length>=1){selId=selectedIDs[0];}if(!opacityStops){return defaultVal;}$ARR.forEach(opacityStops,function(opacityStop){fId=opacityStop[0];fFillOpacity=opacityStop[1];if(selId===fId){fFillOpacity*=$EnumGeomertyDefaultShapeFormat.FILL_OPACITY_FACTOR_HOVER;}if(enableAnimation){if(enableMinZoomAnimation){minStartStops.push([{zoom:minzoom,value:fId},0]);minEndStops.push([{zoom:minzoom+$ZoomAnimationDelta,value:fId},fFillOpacity]);}if(enableMaxZoomAnimation){maxStartStops.push([{zoom:maxzoom-(this.hasConnectingLayer?2:1)*$ZoomAnimationDelta,value:fId},fFillOpacity]);maxEndStops.push([{zoom:maxzoom,value:fId},0]);}}else{stops.push([fId,fFillOpacity]);}});if(enableAnimation){stops=minStartStops.concat(minEndStops,maxStartStops,maxEndStops);}return{property:"id",type:"categorical","default":defaultVal,stops:stops};},getFillColorPropVal:function getFillColorPropVal(defaultColor,colorStops){var stops=colorStops;if(!this.hasColorBy()||!colorStops||colorStops.length===0){stops=[["",defaultColor]];}return{property:"id",type:"categorical","default":defaultColor,stops:stops};},getFillColor:function getFillColor(){var fmts=this.getFmts(),defaultVal=(fmts&&fmts.fillColor)||FMTS_DEFAULT.fillColor;return this.getFillColorPropVal(defaultVal,this.data.colorStops);},getFillColorHover:function getFillColorHover(){var fmts=this.getFmts(),defaultVal=$MUTILS.fillColorAjustForHover((fmts&&fmts.fillColor)||FMTS_DEFAULT.fillColor);return this.getFillColorPropVal(defaultVal,this.data.hoverColorStops);},getFillColorCMSelection:function getFillColorCMSelection(){var fmts=this.getFmts(),defaultVal=$MUTILS.fillColorAjustForCMSelection((fmts&&fmts.fillColor)||FMTS_DEFAULT.fillColor);return this.getFillColorPropVal(defaultVal,this.data.seleColorStops);},getFillColorUnselected:function getFillColorUnselected(){var fmts=this.getFmts(),defaultVal=(fmts&&fmts.fillColor)||FMTS_DEFAULT.fillColor;return this.getFillColorPropVal(defaultVal,this.data.unSelectedColorStops);},getFmts:function getFmts(){return $H.copy(this._super(),$H.clone(FMTS_DEFAULT));},validLayers:function validLayers(layerIds){var map=this.getMapInstance();return map?$ARR.filter(layerIds,function(id){return !!map.getLayer(id);}):[];},getPrimaryShapeLayers:function getPrimaryShapeLayers(){var id=this.getLayerId();return this.validLayers([id,id+ID_SUFFIX.Hover,id+ID_SUFFIX.ContextMenu,id+ID_SUFFIX.Selection,id+ID_SUFFIX.Unselected]);},getStrokeClrFmtLayers:function getStrokeClrFmtLayers(){var id=this.getLayerId();return[id];},setPaintProperty:function setPaintProperty(propName,newVal){var layers=this.getPrimaryShapeLayers(),map=this.getMapInstance();if(map&&propName){$ARR.forEach(layers,function(layer){map.setPaintProperty(layer,propName,newVal);});}},setShapeFillColor:function setShapeFillColor(){var map=this.getMapInstance(),layerId=this.getLayerId(),shapeFmtNames=this.shapeFmtNames,propName=shapeFmtNames&&shapeFmtNames.fillColor,propStrokeName=shapeFmtNames&&shapeFmtNames.strokeColor,propVal=this.getFillColor();if(map&&propName){$ARR.forEach([layerId,layerId+ID_SUFFIX.Selection],function(id){map.setPaintProperty(id,propName,propVal);});map.setPaintProperty(layerId+ID_SUFFIX.ContextMenu,propName,this.getFillColorCMSelection());map.setPaintProperty(layerId+ID_SUFFIX.Hover,propName,this.getFillColorHover());map.setPaintProperty(layerId+ID_SUFFIX.Unselected,propName,this.getFillColorUnselected());this.setCMBorderColor(map,layerId,propStrokeName,propVal);}},setCMBorderColor:function setCMBorderColor(map,layerId,propStrokeName,propVal){map.setPaintProperty(layerId+ID_SUFFIX.ContextMenu,propStrokeName,propVal);},setShapeFillOpacity:function setShapeFillOpacity(newVal){var map=this.getMapInstance(),layerId=this.getLayerId(),shapeFmtNames=this.shapeFmtNames,propName=shapeFmtNames&&shapeFmtNames.fillOpacity,newValUnSelected;if(typeof newVal==="number"){newValUnSelected=this.getFillOpacityForZoomAnimation($EnumGeomertyDefaultShapeFormat.FILL_OPACITY_FACTOR_UNSEL*newVal);newVal=this.getFillOpacityForZoomAnimation(newVal);}else{newValUnSelected=$H.clone(newVal);newValUnSelected=adjustOpacity(newValUnSelected,$EnumGeomertyDefaultShapeFormat.FILL_OPACITY_FACTOR_UNSEL);}if(map&&newVal&&propName){map.setPaintProperty(layerId,propName,newVal);map.setPaintProperty(layerId+ID_SUFFIX.Unselected,propName,newValUnSelected);}},setShapeStrokeColor:function setShapeStrokeColor(){var map=this.getMapInstance(),shapeFmtNames=this.shapeFmtNames,propName=shapeFmtNames&&shapeFmtNames.strokeColor,fmts=this.getFmts(),newVal=(fmts&&fmts.strokeColor)||FMTS_DEFAULT.strokeColor;if(map&&newVal&&propName){$ARR.forEach(this.getStrokeClrFmtLayers(),function(id){map.setPaintProperty(id,propName,newVal);});}},setShapeStrokeStyle:function setShapeStrokeStyle(newVal){var shapeFmtNames=this.shapeFmtNames,strokeWidth=newVal&&newVal.shapeBorderWidth,id=this.getLayerId(),layers=this.getPrimaryShapeLayers(),map=this.getMapInstance(),propName=shapeFmtNames&&shapeFmtNames.strokeWidth;if(map&&propName){$ARR.forEach(layers,function(layer){if(layer===id+ID_SUFFIX.Selection&&strokeWidth===0){map.setPaintProperty(layer,propName,1);}else{map.setPaintProperty(layer,propName,strokeWidth);}});}},setClusterMode:function setClusterMode(clusterMode,isCluster){this.changeClusterProps({clusterMode:clusterMode,isCluster:isCluster});},changeClusterProps:function changeClusterProps(props){var map=this.getMapInstance();$H.copy(props,this);if(map){this.removeComponents();this.addComponents();}},changeLayerZoomRange:function changeLayerZoomRange(layerZoomRange){var map=this.getMapInstance();this.minzoom=layerZoomRange.minzoom;this.maxzoom=layerZoomRange.maxzoom;if(map){$ARR.forEach(this.validLayers(this._layerIds),function(id){map.setLayerZoomRange(id,layerZoomRange.minzoom,layerZoomRange.maxzoom);});}},getLayerZoomRange:function getLayerZoomRange(){return{minzoom:this.minzoom,maxzoom:this.maxzoom};},getLayerOptions:function getLayerOptions(){return{layout:this.getLayout()||{},paint:this.getPaint()||{}};},getLayerOptionsContextMenu:function getLayerOptionsContextMenu(){return{layout:this.getLayoutContextMenu()||{},paint:this.getPaintContextMenu()||{}};},getLayerOptionsSelection:function getLayerOptionsSelection(){return{layout:this.getLayoutSelection()||{},paint:this.getPaintSelection()||{}};},getLayerOptionsHover:function getLayerOptionsHover(){return{layout:this.getLayoutHover()||{},paint:this.getPaintHover()||{}};},getLayerOptionsUnselected:function getLayerOptionsUnselected(){return{layout:this.getLayout()||{},paint:this.getPaintUnselected()||{}};},getPaint:function getPaint(){var fmts=this.getFmts(),shapeFmtNames=this.shapeFmtNames,paint={};if(shapeFmtNames){if(shapeFmtNames.fillColor){paint[shapeFmtNames.fillColor]=this.getFillColor();}if(shapeFmtNames.fillOpacity){paint[shapeFmtNames.fillOpacity]=this.getFillOpacity();}if(shapeFmtNames.strokeColor){paint[shapeFmtNames.strokeColor]=fmts.strokeColor;}if(shapeFmtNames.strokeWidth){paint[shapeFmtNames.strokeWidth]=fmts.strokeWidth;}}return paint;},getPaintHover:function getPaintHover(){var paint=this.getPaint(),shapeFmtNames=this.shapeFmtNames;if(shapeFmtNames){if(shapeFmtNames.fillColor){paint[shapeFmtNames.fillColor]=this.getFillColorHover();}if(shapeFmtNames.fillOpacity){paint[shapeFmtNames.fillOpacity]=this.hoverOpacity;}if(shapeFmtNames.strokeWidth){paint[shapeFmtNames.strokeWidth]=0;}}return paint;},getPaintContextMenu:function getPaintContextMenu(){var paint=this.getPaint(),shapeFmtNames=this.shapeFmtNames;if(paint&&shapeFmtNames){if(shapeFmtNames.fillColor){paint[shapeFmtNames.fillColor]=this.getFillColorCMSelection();}if(shapeFmtNames.fillOpacity){paint[shapeFmtNames.fillOpacity]=this.fillOpacitySelection;}if(shapeFmtNames.strokeColor){paint[shapeFmtNames.strokeColor]=this.getFillColor();}return paint;}},getPaintSelection:function getPaintSelection(){var paint=this.getPaint(),fmts=this.getFmts(),shapeFmtNames=this.shapeFmtNames;if(paint&&shapeFmtNames){if(shapeFmtNames.fillOpacity){paint[shapeFmtNames.fillOpacity]=this.getFillOpacityForZoomAnimation(this.fillOpacitySelection);}if(shapeFmtNames.strokeColor){paint[shapeFmtNames.strokeColor]=this.strokeColorSelection;}if(shapeFmtNames.strokeWidth){if(fmts.strokeWidth>0){paint[shapeFmtNames.strokeWidth]=fmts.strokeWidth*2;}else{paint[shapeFmtNames.strokeWidth]=2;}}return paint;}},getPaintUnselected:function getPaintUnselected(){var paint=this.getPaint();shapeFmtNames=this.shapeFmtNames;if(paint&&shapeFmtNames&&shapeFmtNames.fillOpacity){var opacity=this.getFillOpacity();opacity=adjustOpacity(opacity,$EnumGeomertyDefaultShapeFormat.FILL_OPACITY_FACTOR_UNSEL);paint[shapeFmtNames.fillOpacity]=opacity;}return paint;},getLayout:emptyFn,getLayoutContextMenu:function getLayoutContextMenu(){return this.getLayout();},getLayoutSelection:function getLayoutSelection(){return this.getLayout();},getLayoutHover:function getLayoutHover(){return this.getLayout();},getGraphicsContained:function getGraphicsContained(selectionShape,anySelected){var map=this.getMapInstance(),layerIds=[this.getLayerId()],features=[],polygon;if(this.isCluster){layerIds.push(this.getClusterLayerId());}if(anySelected){layerIds.push(this.getLayerId()+ID_SUFFIX.Unselected);}switch(selectionShape.scriptClass){case"mstrmojo.gmaps.geometry.Extent":features=searchFeaturesInsideExtent(map,layerIds,selectionShape);break;case"mstrmojo.gmaps.geometry.Circle":features=searchFeaturesInsideCircle(map,layerIds,selectionShape);break;case"mstrmojo.gmaps.geometry.Polygon":polygon=turf.feature({type:"Polygon",coordinates:$GUTILS.unifyPolygonJSON(selectionShape.screenPolylineArr)});features=searchFeaturesInsidePolygon(map,layerIds,convertToGeoPolygon(polygon,map),turf.bbox(polygon));break;default:break;}return this.getGraphicsFromFeatures(features);},highlightGraphics:function highlightGraphics(graphics){var idList=$ARR.map(graphics,function(graphic){if(graphic){return graphic.id;}});this.handleSelections(idList);},clearHighlights:function clearHighlights(selectedGraphics){this._super(selectedGraphics);this.handleSelections();},removeLayers:function removeLayers(){var map=this.getMapInstance(),_layerIds=this._layerIds;if(map){$ARR.forEach(this.validLayers(_layerIds),function(id){map.removeLayer(id);});}},removeSource:function removeSource(){var map=this.getMapInstance(),sourceId=this.getLayerId()+ID_SUFFIX.Source,baseLayer;if(map&&map.getSource(sourceId)){map.removeSource(sourceId);}delete this.cluster;if(this.zoomLevelChangeListener){baseLayer=this.parent&&this.parent.getBaseLayer();baseLayer&&baseLayer.detachEventListener(this.zoomLevelChangeListener);delete this.zoomLevelChangeListener;}},removeComponents:function removeComponents(){this.removeLayers();this.removeSource();},destroy:function destroy(){this.removeComponents();delete this.data;this._super();}});}());