(function(){mstrmojo.requiresCls("mstrmojo.dom");var $DOM=mstrmojo.dom;var TOUCHSTART="touchstart",MOUSEDOWN="mousedown",isIOSTouch=$DOM.isIOSTouch,EVENT_TO_CLOSE=isIOSTouch?TOUCHSTART:MOUSEDOWN;function attachHotSlot(me){var el=me[me.hotSlot||"domNode"];if(el){if(!me._closeCallback){var id=me.id,fnCallback=function(mthName){return function(e){var p=mstrmojo.all[id];if(p&&!p.ignoreHover){p["auto"+mthName](e,self);}};};me._uncloseCallback=fnCallback("Unclose");me._closeCallback=fnCallback("Close");}$DOM.attachEvent(el,"mouseover",me._uncloseCallback);$DOM.attachEvent(el,"mouseout",me._closeCallback);}}function detachHotSlot(me){if(me._closeCallback){var el=me[me.hotSlot||"domNode"];if(el){$DOM.detachEvent(el,"mouseover",me._uncloseCallback);$DOM.detachEvent(el,"mouseout",me._closeCallback);}}}function toggleLock(me,lock){var w=me,count;while(w){if(w.open||w.openPopup){count=w.ignoreHoverCount||0;count=lock?(count+1):(count>0?count-1:count);w.ignoreHoverCount=count;if(w.set){w.set("ignoreHover",(count>0));}else{w.ignoreHover=(count>0);}}w=w.opener||w.parent;if(w&&w.shouldPropagateLockHover&&!w.shouldPropagateLockHover()){break;}}}function clearLockHoverCallback(){var fn=this._lockHoverCallback,curtainNode=this.curtainNode,_onClickChange=this._onClickChange;if(fn){$DOM.detachEvent(document.body,EVENT_TO_CLOSE,fn,true);delete this._lockHoverCallback;}if(!curtainNode||!_onClickChange){return ;}var isTouchApp=mstrApp&&mstrApp.isTouchApp&&mstrApp.isTouchApp()||isIOSTouch,clickChangeMethodName=isTouchApp?TOUCHSTART:MOUSEDOWN;$DOM.detachEvent(curtainNode,clickChangeMethodName,_onClickChange);delete this._onClickChange;}mstrmojo._CanAutoClose=mstrmojo.provide("mstrmojo._CanAutoClose",{autoCloses:false,autoCloseDelay:100,locksHover:false,hotSlot:null,closeOnClick:false,curtainNode:null,postBuildRendering:function postBuildRendering(){this._super();if(this.autoCloses){attachHotSlot(this);}this.oncloseOnClickChange();},onautoClosesChange:function onautoClosesChange(){var fn=(this.autoCloses)?attachHotSlot:detachHotSlot;fn(this);},oncloseOnClickChange:function oncloseOnClickChange(){if(!this.curtainNode){return ;}var me=this,isTouchApp=mstrApp&&mstrApp.isTouchApp&&mstrApp.isTouchApp()||isIOSTouch,clickChangeMethodName=isTouchApp?TOUCHSTART:MOUSEDOWN;this._onClickChange=function(){me.close();if(isTouchApp){mstrmojo.touchManager.notify([]);}};$DOM.attachEvent(me.curtainNode,clickChangeMethodName,this._onClickChange);},autoUnclose:function autoUnclose(){var t=this._autoCloseTimer;if(t){self.clearTimeout(t);delete this._autoCloseTimer;}},autoClose:function autoClose(){if(this.ignoreHover){return ;}if(this._autoCloseTimer){self.clearTimeout(this._autoCloseTimer);}if(this.opener){if(this.autoCloseDelay){var xid=this.opener.id;this._autoCloseTimer=self.setTimeout(function(){mstrmojo.all[xid].closePopup();},this.autoCloseDelay);}else{this.opener.closePopup();}}},destroy:function destroy(ignoreDom){clearLockHoverCallback.call(this);this._super(ignoreDom);},lockHover:function lockHover(){toggleLock(this,true);if(!this._lockHoverCallback){var id=this.id,fn=this._lockHoverCallback=function(evt){mstrmojo.all[id]._unlockHoverCheck(evt,self);};if(($DOM.isIE7||$DOM.isIE8)&&window.event&&(window.event.type===EVENT_TO_CLOSE)&&this.opener){this.opener._ignoreMousedown=true;}$DOM.attachEvent(document.body,EVENT_TO_CLOSE,fn,true);}},unlockHover:function unlockHover(){toggleLock(this,false);clearLockHoverCallback.call(this);},hoverLock:function(isLocked){toggleLock(this,isLocked);},suppressClose:function suppressClose(target){return $DOM.contains(this.domNode,target,true,document.body);},_unlockHoverCheck:function _unlockHoverCheck(e,hWin){var opener=this.opener;if(opener&&opener._ignoreMousedown){delete opener._ignoreMousedown;return ;}var target=$DOM.eventTarget(hWin,e);if(!this.suppressClose(target)){if(this.isWithinParentWidget(target)){return ;}if(opener&&opener.onPopupAutoClosed){opener.onPopupAutoClosed(e,hWin);}this.close(target);}},isWithinParentWidget:function isWithinParentWidget(target){var widget=$DOM.findWidget(target);while(widget){if(widget===this){return true;}widget=widget.parent||widget.opener;}return false;},open:function open(opener,config){if(this.autoCloses){this.autoUnclose();}this._super(opener,config);if(this.locksHover){this.lockHover();}},close:function close(cfg){if(this.locksHover){this.unlockHover();}this._super(cfg);},shouldPropagateLockHover:function shouldPropagateLockHover(){return true;}});}());