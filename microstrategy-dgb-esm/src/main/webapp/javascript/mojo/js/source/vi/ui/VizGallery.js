(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo._HasLayout","mstrmojo.ui._HasScroller","mstrmojo.util.ui._HostsSplitter","mstrmojo.vi.ui._HasMask","mstrmojo.vi._MonitorsAppState","mstrmojo.vi.models.DropZonesModel","mstrmojo.dom","mstrmojo.css","mstrmojo.string","mstrmojo.ui.menus._HasMenuPopup","mstrmojo.vi.ui.toolbars._HasToolbar","mstrmojo.tooltip","mstrmojo.vi.ui._IsDropTarget","mstrmojo.vi.enums.EnumFeatures","mstrmojo.vi.models.EnumDragSources");mstrmojo.requiresClsP("mstrmojo.vi.ui","_IsViPanel","VizGalleryList","CollapsibleTitleBar");mstrmojo.requiresClsP("mstrmojo.vi.viz","EnumVisualizationTemplates","EnumVizStyles","EnumWidgetTypes");mstrmojo.requiresDescs(114,517,518,1143,1995,7696,7697,11790,14813,10833,13521,14119);var $MOJO=mstrmojo,$VIZ=$MOJO.vi.viz,$DOM=$MOJO.dom,$CSS=$MOJO.css,$STRING=$MOJO.string,$WIDGET_TYPES=$VIZ.EnumWidgetTypes,WTP_GRID=$WIDGET_TYPES.GRID,$VIZ_TEMPLATES=$VIZ.EnumVisualizationTemplates,$ARR=mstrmojo.array,$VizGalList=mstrmojo.vi.ui.VizGalleryList,$VIZ_LIST_TYPE=$VizGalList.VIZ_LIST_TYPE,FEATURES=mstrmojo.vi.enums.EnumFeatures,ENUM_SOURCE=mstrmojo.vi.models.EnumDragSources;var GRID_VIZ_ELEMENT={n:mstrmojo.desc(114,"Grid"),id:"VisGrid",summary:mstrmojo.desc(16057,"Displays data in a tabular format"),example:mstrmojo.desc(16058,"Example: Create directory with customer information and key performance indicators (KPIs)"),requirements:mstrmojo.desc(16059,"Uses 1+ ##attributes### and/or 1+ #metrics###"),vt:$VIZ_TEMPLATES.GRID},CUSTOM_STYLE="custom",DISPLAY_NONE="none",GALLERY_URL="https://community.microstrategy.com/s/gallery";function getConnectivityProxy(){if(mstrApp.isSingleTier&&!(mstrApp.supportFeature(FEATURES.SUPPORT_LIVEMODE)&&mstrApp.getWSLiveMode&&mstrApp.getWSLiveMode())){return new mstrmojo.onetier.vi.prefs.DesktopConnectivityProxy();}return new mstrmojo.onetier.vi.prefs.HostedDesktopConnectivityProxy();}function getTooltipContent(requirements,model,preview){var selectedUnit=model.getSelectedViUnit(),unitDropZones=selectedUnit&&selectedUnit.getZonesModel(),htmlTooltip=['<div><span class="vi-name">{@n}</span>'+(preview?'<div class="vi-tooltip-icn icn-tooltip-{@id}"></div>':"")],htmlRequirements=[],fulfilledRequirements={};if(unitDropZones&&requirements){requirements.forEach(function(req){var type=req.t,requiredCnt=req.r,singleMetric=!!req.s,cnt=unitDropZones.getRequiredItemsInfo(type),requiredLabels={12:mstrmojo.desc(13429,"# more ##attributes###"),4:mstrmojo.desc(13431,"# more ##metrics###"),"long":mstrmojo.desc(13433,"# more ##longitudes###"),lat:mstrmojo.desc(13435,"# more ##latitudes###"),sglmtc:mstrmojo.desc(15668,"# ##metric###")};if(cnt<requiredCnt){htmlRequirements.push(requiredLabels[singleMetric?"sglmtc":type].replace("###","</span><br/>").replace("##",'<span class="type'+type+'">').replace("#",requiredCnt-cnt));}else{fulfilledRequirements["t"+type]=requiredCnt;}});if(!htmlRequirements.length){var attributeRequirements=fulfilledRequirements["t"+12],metricRequirements=fulfilledRequirements["t"+4],resolvedLabels=[mstrmojo.desc(13436,"# attribute and ## metric"),mstrmojo.desc(13437,"# attribute and ## metrics"),mstrmojo.desc(13438,"# attributes and ## metric"),mstrmojo.desc(13439,"# attributes and ## metrics"),mstrmojo.desc(13440,"# attribute"),mstrmojo.desc(13441,"# attributes"),mstrmojo.desc(13442,"## metric"),mstrmojo.desc(13443,"## metrics")],resolvedLabelsIndex=-1;if(attributeRequirements&&metricRequirements){resolvedLabelsIndex=Math.min(attributeRequirements-1,1)<<1|Math.min(metricRequirements-1,1);}else{if(attributeRequirements){resolvedLabelsIndex=3+Math.min(attributeRequirements,2);}else{if(metricRequirements){resolvedLabelsIndex=5+Math.min(metricRequirements,2);}}}if(resolvedLabelsIndex!==-1){htmlRequirements.push(resolvedLabels[resolvedLabelsIndex].replace("##",metricRequirements).replace("#",attributeRequirements));}}}if(htmlRequirements.length){htmlRequirements=['<span class="vi-reqs">'].concat(htmlRequirements).concat(["</span>"]);}htmlTooltip=htmlTooltip.concat(htmlRequirements);htmlTooltip.push("</div>");return htmlTooltip.join("");}function isGalleryMasked(){var selectedUnit=this.model.getSelectedViUnit();return !selectedUnit||!(selectedUnit instanceof mstrmojo.vi.ui.rw.VizBox);}function viUnitSelected(){this.set("isMasked",isGalleryMasked.call(this));var viz=this.model.getVizOfSelectedViUnit();this.selectViz(viz&&viz.id,viz&&viz.s);}function onItemSelection(evt){var added=evt.added,item=added&&this.items[added[0]];if(item){this.parent.model.changeSelectedVisType(item.s||"",item.vt,item.wtp||WTP_GRID,item.dz);}}function getDragSourceFrom(context){var dragData=context&&context.src&&context.src.data;return dragData&&dragData.src;}mstrmojo.vi.ui.VizGallery=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasLayout,mstrmojo.vi.ui._IsViPanel,mstrmojo.ui._HasScroller,mstrmojo.vi.ui._HasMask,mstrmojo.vi._MonitorsAppState,mstrmojo.util.ui._HostsSplitter,mstrmojo.ui.menus._HasMenuPopup,mstrmojo.vi.ui._IsDropTarget,mstrmojo.vi.ui.toolbars._HasToolbar],{scriptClass:"mstrmojo.vi.ui.VizGallery",markupString:'<div id="{@id}" class="mstrmojo-VIPanel mstrmojo-VIGallery {@cssClass}" style="{@cssText}" ><div class="mstrmojo-VIGallery-handle splitter v"></div><div class="mstrmojo-VIPanel-titlebar"></div><div class="mstrmojo-VIGallery-contents"><div class="mstrmojo-VIGallery-builtInLabel"></div><div class="mstrmojo-VIGallery-builtinVizList"></div><div class="mstrmojo-VIGallery-divider"></div><div class="mstrmojo-VIGallery-galleryLabel"></div><div class="mstrmojo-VIGallery-customVizList"></div><div class="mstrmojo-VIGallery-importCustomVizButton"></div></div><div class="mstrmojo-VIDND-mask"></div></div>',markupSlots:{handleNode:function handleNode(){return this.domNode.firstChild;},titlebarNode:function titlebarNode(){return this.domNode.childNodes[1];},containerNode:function containerNode(){return this.domNode.childNodes[2];},builtInLabelNode:function builtInLabelNode(){return this.domNode.childNodes[2].childNodes[0];},builtinVizListNode:function builtinVizListNode(){return this.domNode.childNodes[2].childNodes[1];},dividerNode:function dividerNode(){return this.domNode.childNodes[2].childNodes[2];},galleryLabelNode:function galleryLabelNode(){return this.domNode.childNodes[2].childNodes[3];},customVizListNode:function customVizListNode(){return this.domNode.childNodes[2].childNodes[4];},importCustomVizBtnNode:function importCustomVizBtnNode(){return this.domNode.childNodes[2].childNodes[5];},maskNode:function maskNode(){return this.domNode.lastChild;}},layoutConfig:{h:{titlebarNode:"0px",containerNode:"100%"},xt:true},markupMethods:{onvisibleChange:mstrmojo.Widget.visibleMarkupMethod},init:function init(props){if(!!mstrApp.isWSStyling){this.layoutConfig={h:{titlebarNode:"28px",containerNode:"100%"},xt:true};}this._super(props);mstrApp.features=mstrApp.features||{};var meId=this.id,oNGM=mstrApp.features.ngm,oNGMPartial=mstrApp.features.ngmPartial;this.toolbar=this.titleBar;getConnectivityProxy().getSavedPreferences({success:function success(res){function callback(){if(oNGM!==mstrApp.features.ngm||oNGMPartial!==mstrApp.features.ngmPartial){if(mstrmojo.all[meId]){mstrmojo.all[meId].update();}}}if(mstrApp.updateFeatureFlag){mstrApp.updateFeatureFlag(res,callback);}}.bind(this)});this.model.attachEventListener("viUnitSelected",this.id,viUnitSelected);},useRichTooltip:true,preview:false,DEFAULT_WIDTH:60,DEFAULT_LEFT_MARGIN:7,vizList:null,customVizList:null,model:null,title:$MOJO.desc(10833,"Gallery"),titleBar:null,titlebarNode:null,handleNode:null,ttpContentMarkup:'<div class="vi-rich-gallery-tooltip"><div class="vi-tooltip-name name">{@n}</div><div class="vi-tooltip-desc dsc">{@summary}</div><div class="vi-tooltip-example dsc">{@example}</div><div class="vi-tooltip-requirement dsc">{@requirements}</div></div>',onAppStateChange:function onAppStateChange(evt){this._super(evt);this.set("isMasked",isGalleryMasked.call(this)||mstrApp.isAppStateSelection());},setOpenStatus:function setOpenStatus(isOpen,noSave,update,skipReLayout){this._super(isOpen,noSave,update,skipReLayout);if(!noSave){var lv=mstrApp.rootCtrl.docCtrl.view.layoutViewer;lv.boxLayoutConfig.setVizGalleryOpen(this.visible);lv.saveBoxLayout(undefined,undefined,undefined,update);}},children:[{scriptClass:"mstrmojo.vi.ui.CollapsibleTitleBar",slot:"titlebarNode",alias:"titleBar",editTitleOnDoubleClick:false,close:function close(){},onclick:function(){},bindings:{title:"this.parent.title"}},{scriptClass:"mstrmojo.Label",text:$MOJO.desc(14119,"Built-in"),slot:"builtInLabelNode",cssClass:"galleryLabel builtInLabel"},{scriptClass:"mstrmojo.vi.ui.VizGalleryList",slot:"builtinVizListNode",alias:"vizList",selectionPolicy:"reselect",type:$VIZ_LIST_TYPE.BUILT_IN_LIST,items:[GRID_VIZ_ELEMENT],postselectionChange:function postselectionChange(evt){this.parent.customVizList.clearSelect();onItemSelection.call(this,evt);}},{scriptClass:"mstrmojo.Widget",markupString:"<div class='separator'></div>",slot:"galleryLabelNode"},{scriptClass:"mstrmojo.Label",text:$MOJO.desc(13521,"Custom"),slot:"galleryLabelNode",cssClass:"galleryLabel"},{scriptClass:"mstrmojo.vi.ui.VizGalleryList",slot:"customVizListNode",alias:"customVizList",type:$VIZ_LIST_TYPE.CUSTOM_LIST,selectionPolicy:"reselect",items:[],postselectionChange:function postselectionChange(evt){this.parent.vizList.clearSelect();onItemSelection.call(this,evt);}},{scriptClass:"mstrmojo.Button",slot:"importCustomVizBtnNode",cssClass:"importVizButton",onclick:function(){var position=$DOM.position(this.domNode),customVizButtonDiv=this.domNode.parentNode;position.x=position.x+4;position.y=position.y+3.65;$CSS.addClass(customVizButtonDiv,"clicked");var menuCfg=new mstrmojo.ui.menus.MenuConfig({position:position,isHostedWithin:false,menuCssClass:"importVizMenu"});menuCfg.addMenuItem(mstrmojo.desc(14736,"Import Visualization..."),"",function(){window.FormWrapper.importCustomVisualization();});menuCfg.addSeparator();menuCfg.addMenuItem(mstrmojo.desc(14691,"Browse Gallery..."),"",function(){window.FormWrapper.openPage(GALLERY_URL);});this.parent.openPopup(menuCfg.newInstance(),{onClose:function(){$CSS.removeClass(customVizButtonDiv,"clicked");}});}}],postBuildRendering:function postBuildRendering(){var handleNode=this.handleNode;handleNode.style.display="block";this.registerSplitter(handleNode);if(!mstrApp.isSingleTier||(mstrApp.supportFeature(mstrmojo.vi.enums.EnumFeatures.SUPPORT_LIVEMODE)&&mstrApp.getWSLiveMode())){this.importCustomVizBtnNode.style.display=DISPLAY_NONE;if(this.customVizList.items.length===0){this.dividerNode.style.display=DISPLAY_NONE;this.galleryLabelNode.style.display=DISPLAY_NONE;this.customVizListNode.style.display=DISPLAY_NONE;}}return this._super();},updateToolbar:function updateToolbar(cfg){cfg.isHostedWithin=false;cfg.addMenuItem(mstrmojo.desc(1143,"Help"),"help",function(){mstrApp.showHelpTopic("viz_gallery.htm");});return this._super(cfg);},selectViz:function selectViz(vizId,vizStyle){var idx=-1;this.vizList.clearSelect();this.customVizList.clearSelect();(this.vizList.items||[]).forEach(function(item,i){if(item.id===vizId&&(!vizStyle||vizStyle===item.s)){idx=i;return true;}});if(idx>-1){this.vizList.select([idx]);}else{if((idx=$ARR.find(this.customVizList.items,"id",vizId))>-1){this.customVizList.select([idx]);}}},setDimensions:function setDimensions(h,w){this._super(h,w);var width=parseInt(w,10),titleBarNode=this.titlebarNode,titleBarNodeStyle=titleBarNode&&titleBarNode.style;if(titleBarNodeStyle){titleBarNodeStyle.display=width<2*(this.DEFAULT_WIDTH-this.DEFAULT_LEFT_MARGIN)?"none":this.cssDisplay;}var handleNode=this.handleNode,handleStyle=handleNode&&handleNode.style;if(handleStyle){handleStyle.top=0;handleStyle.right=w;handleStyle.height=h;handleStyle.width="6px";}},getSplitterInfo:function getSplitterInfo(){return{isReverseMove:true,min:this.DEFAULT_WIDTH,max:(this.DEFAULT_WIDTH-this.DEFAULT_LEFT_MARGIN)*3+this.DEFAULT_LEFT_MARGIN+4};},splitterMoved:function splitterMoved(pixelsMoved){var prop="width",currentVizGalleryWidth=parseInt(this[prop],10),offset=0,ratio=pixelsMoved/this.DEFAULT_WIDTH,numberOfCoulmns=parseInt(ratio),isAnotherColumn=Math.abs(ratio%1);if(isAnotherColumn>0.25){offset=(pixelsMoved>0)?1:-1;}numberOfCoulmns+=offset;if(numberOfCoulmns!==0){currentVizGalleryWidth+=(this.DEFAULT_WIDTH-this.DEFAULT_LEFT_MARGIN)*numberOfCoulmns;this.set(prop,currentVizGalleryWidth+"px");}this.parent.doLayout();},splitterMouseDown:function splitterMouseDown(){this.domNode.parentNode.previousSibling.style.pointerEvents="none";},splitterMouseUp:function splitterMouseUp(){this.domNode.parentNode.previousSibling.style.pointerEvents="inherit";},update:function update(isOnVizDeletion){if(mstrApp.getRecentGallery){mstrApp.getRecentGallery(isOnVizDeletion);}this.vizList.set("items",[GRID_VIZ_ELEMENT].concat($VizGalList.getVizList($VIZ_LIST_TYPE.BUILT_IN_LIST)));this.customVizList.set("items",$VizGalList.getVizList($VIZ_LIST_TYPE.CUSTOM_LIST));var viz=this.model.getVizOfSelectedViUnit();this.selectViz(viz&&viz.id,viz&&viz.s);this.cleanUpListeners();this.updateScrollbars(true);},showTooltip:function showTooltip(evt,win){var target=$DOM.findAncestorByAttr($DOM.eventTarget(win,evt),"idx",true,this.domNode),node=target&&target.node,isCustom=node&&node.className.indexOf(CUSTOM_STYLE)>-1,list=isCustom?this.customVizList:this.vizList,item=target&&node.className.indexOf("mnu")===-1&&list.items[target.value],name=item&&item.n,id=item&&item.id;if(!name||name===""){return ;}var position=$DOM.position(node),content="";if(item.summary&&item.example&&item.requirements){var metricIcon='<span class="icon vi-tooltip-metricIcon">',attrIcon='<span class="icon vi-tooltip-attrIcon">',requirements=item.requirements.replace(/###/g,"</span>").replace("##",attrIcon).replace("#",metricIcon);content=$STRING.apply(this.ttpContentMarkup,{n:name,summary:item.summary,example:item.example,requirements:requirements});}else{content=$STRING.apply(getTooltipContent(item.mr,this.model,this.preview),{n:name,id:id});}if(!content){return ;}this.richTooltip={posType:mstrmojo.tooltip.POS_TOPRIGHT,cssClass:"viGallery-tooltip vi-regular vi-tooltip-D"+(this.preview?" preview":""),content:content,top:position.y-12-(this.preview?56:0),left:position.x-7,keepArrowYPos:true,updatePosition:function updatePosition(){this.domNode.style.top="-100000px";this.domNode.style.left="-100000px";$MOJO.Tooltip.prototype.updatePosition.call(this);}};this._super(evt,win);},setupScrollNodes:function setupScrollNodes(){this.scrollNode=this.containerNode;},updateScrollbars:function updateScrollbars(reRender){this._super();if(reRender){this.addScrollNodeProperties();}},cleanUpListeners:function cleanUpListeners(){$ARR.forEach(this.installedEventListeners,function(h){$DOM.detachEvent(h.e,h.evt,h.fn);});},allowDrop:function allowDrop(context){var srcZones=[ENUM_SOURCE.VIZ_EDITOR];return srcZones.indexOf(getDragSourceFrom(context))>-1;},ondrop:function ondrop(context){if(getDragSourceFrom(context)===ENUM_SOURCE.VIZ_EDITOR){var dragData=context&&context.src&&context.src.data;dragData.onRemove(dragData.items&&dragData.items.length>1?dragData.items:dragData.item);}},getDropAvatarIcon:function getDropAvatarIcon(context){return getDragSourceFrom(context)===ENUM_SOURCE.VIZ_EDITOR?"remove":"move";}});}());