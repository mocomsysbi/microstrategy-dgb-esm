(function(){mstrmojo.requiresCls("mstrmojo.func","mstrmojo.array","mstrmojo.VisUtility","mstrmojo.kpicard.KPICardEnum","mstrmojo.util.FontLoader");var $VisUtil=mstrmojo.VisUtility,$BADGE_MODE=mstrmojo.kpicard.BADGE_MODE,$DISPLAY_MODE=mstrmojo.kpicard.DISPLAY_MODE,$KPI_STYLES_CONFIG=mstrmojo.kpicard.KPI_STYLES_CONFIG,$KPI_STYLES=mstrmojo.kpicard.KPI_STYLES,$KPI_PROPERTIES=mstrmojo.kpicard.KPI_PROPERTIES,$TEXT_SIZE_TYPE=mstrmojo.kpicard.TEXT_SIZE_TYPE,$CAN_SET_FONT_PARTS=mstrmojo.kpicard.CAN_SET_FONT_PARTS,$ENUM_PROPERTY_NAMES=mstrmojo.models.FormatModel.ENUM_PROPERTY_NAMES,$DEFAULT_PROPERTY=mstrmojo.kpicard.DEFAULT_PROPS,$HASH=mstrmojo.hash,$ARR=mstrmojo.array;var JSON_PROPS=[$KPI_PROPERTIES.CUSTOM_KPI_STYLE,];mstrmojo.kpicard._KPICardProperty=mstrmojo.provide("mstrmojo.kpicard._KPICardProperty",{_mixinName:"mstrmojo.kpicard._KPICardProperty",handlePropValChange:function handlePropValChange(propName,newValue,urFlag){switch(propName){case $KPI_PROPERTIES.SHOW_METRIC_NAME:this.onShowMetricNameChange(newValue);break;case $KPI_PROPERTIES.DISPLAY_MODE:this.onDisplayModeChange(newValue);break;case $KPI_PROPERTIES.AUTO_PLAY:this.onAutoPlayChange(newValue);break;case $KPI_PROPERTIES.KPI_STYLE:this.onStyleChange(newValue);break;case $KPI_PROPERTIES.CUSTOM_KPI_STYLE:this.onCustomKPIStyleChange();break;case $KPI_PROPERTIES.NEW_FONT:this.onFontChange(newValue);break;case $KPI_PROPERTIES.TEXT_SIZE_TYPE:this.onTextSizeTypeChange(newValue);break;case $KPI_PROPERTIES.PREVIOUS_METRIC_NAME:this.onPrevMetricNameChange();break;case $KPI_PROPERTIES.INCREASE_BG_COLOR:case $KPI_PROPERTIES.DECREASE_BG_COLOR:this.onBadgeBgClrChange();break;case $KPI_PROPERTIES.BADGE_MODE:this.onBadgeModeChange();break;case $KPI_PROPERTIES.COLOR_THRESHOLDS:this.onColorThresholdsChange();break;case $KPI_PROPERTIES.CURRENT_SLIDE_ELEMENT:this.onStackedSlideChange(newValue,urFlag);break;case $KPI_PROPERTIES.FIX_CARD_HEIGHT:case $KPI_PROPERTIES.GRID_COLUMN_COUNT:case $KPI_PROPERTIES.CARD_HEIGHT:this.plot();this.initialHighlight();break;default:break;}},migrateOldFontProps:function migrateFontProps(){var props=this.model.data.vp;if(!props){return ;}var font=props[$KPI_PROPERTIES.FONT];var steps=props[$KPI_PROPERTIES.UNIFY_STEPS];if((font||steps)&&!props[$KPI_PROPERTIES.NEW_FONT]){var newFont={};$HASH.forEach($CAN_SET_FONT_PARTS,function(value){newFont[value]={};newFont[value][$ENUM_PROPERTY_NAMES.FONT_FAMILY]=font;if(steps){newFont[value][$KPI_PROPERTIES.UNIFY_STEPS]=steps;}});props[$KPI_PROPERTIES.NEW_FONT]=JSON.stringify(newFont);}var unified=props[$KPI_PROPERTIES.UNIFY_TEXT_SIZE];if(unified&&!props[$KPI_PROPERTIES.TEXT_SIZE_TYPE]){props[$KPI_PROPERTIES.TEXT_SIZE_TYPE]=unified==="true"?$TEXT_SIZE_TYPE.UNIFIED:$TEXT_SIZE_TYPE.FIT_TO_CONTAINER;}},onDisplayModeChange:function onDisplayModeChange(newValue){var textSizeType=this.getFormatPropertyValue($KPI_PROPERTIES.TEXT_SIZE_TYPE);if(newValue===$DISPLAY_MODE.STACKED&&textSizeType===$TEXT_SIZE_TYPE.UNIFIED){this.updateProperties($KPI_PROPERTIES.TEXT_SIZE_TYPE,$TEXT_SIZE_TYPE.FIT_TO_CONTAINER);}this.plot();this.initialHighlight();},onShowMetricNameChange:function onShowMetricNameChange(checked){this.layoutor.forEachChild(function(kpiCard){kpiCard.renderMetricName(checked);});this.unifyNodeFontSize("metricNameNode");},onAutoPlayChange:function onAutoPlayChange(play){if(typeof this.layoutor.toggleSlick==="function"){this.layoutor.toggleSlick(play);}},onCustomKPIStyleChange:function(){this.layoutor.forEachChild(function(kpiCard){kpiCard.updateStyle();});},onStyleChange:function onStyleChange(propVal){var me=this;var updateAllFontColorProps=function(){var fontColor=me.getDefaultFontColor();var updateArr=[];$HASH.forEach($CAN_SET_FONT_PARTS,function(partName){if($CAN_SET_FONT_PARTS.TREND_IDENTITY!==partName){updateArr.push({part:partName,propName:$ENUM_PROPERTY_NAMES.COLOR,propValue:fontColor});}});me.updateProperties($KPI_PROPERTIES.NEW_FONT,updateArr);};var isDefaultStyle=this.isDefaultKPIStyle(propVal);if(isDefaultStyle){updateAllFontColorProps();}this.layoutor.forEachChild(function(kpiCard){kpiCard.updateStyle();if(kpiCard&&kpiCard.applyDefaultFontColor&&isDefaultStyle){kpiCard.applyDefaultFontColor();}});if(isDefaultStyle){this.applyColorThresholds();}},onFontChange:function onFontChange(newValue){var me=this;var partArr=newValue.map(function(v){return v.part;});var renderFont=function(){me.layoutor.forEachChild(function(kpiCard){kpiCard.renderByFont(partArr);});if(me.getFormatPropertyValue($KPI_PROPERTIES.TEXT_SIZE_TYPE)!==$TEXT_SIZE_TYPE.FIXED){me.modifyFontSize(partArr);}};var propName=newValue[0].propName;if(propName===$ENUM_PROPERTY_NAMES.FONT_FAMILY){var fontName=newValue[0].propValue;this.loadFonts([{name:fontName,isItalic:false,isBold:false},{name:fontName,isItalic:false,isBold:true},],{success:renderFont,failure:renderFont});return ;}if(propName===$KPI_PROPERTIES.UNIFY_STEPS){this.onUnifyStepsChange(newValue);return ;}renderFont();},onTextSizeTypeChange:function onTextSizeTypeChange(newValue){if(newValue===$TEXT_SIZE_TYPE.FIXED){var table=[[this.unifyMetricNameSize,$CAN_SET_FONT_PARTS.LABEL],[this.unifyMetricValueSize,$CAN_SET_FONT_PARTS.PRIMARY_VALUE],[this.unifyPrevMetricSize,$CAN_SET_FONT_PARTS.PREVIOUS_VALUE],[this.unifyBadgeSize,$CAN_SET_FONT_PARTS.TREND_IDENTITY],];var updateArr=[];$ARR.forEach(table,function(item){if(!isNaN(item[0])){updateArr.push({part:item[1],propName:$ENUM_PROPERTY_NAMES.FONT_SIZE,propValue:item[0]+"px",});}});this.updateProperties($KPI_PROPERTIES.NEW_FONT,updateArr);}this.layoutor.forEachChild(function(kpiCard){kpiCard.renderByFont();});if(newValue!==$TEXT_SIZE_TYPE.FIXED){this.modifyFontSize();}},onUnifyStepsChange:function onUnifyStepsChange(newValue){var me=this;var partArr=newValue.map(function(v){return v.part;});this.layoutor.forEachChild(function(kpiCard){var dataModel=kpiCard.dataModel;if(dataModel.prevMetricFmtValue&&partArr.indexOf($CAN_SET_FONT_PARTS.PREVIOUS_VALUE)>-1){dataModel.prevMetricInfo=me.getPrevMetricInfoString(dataModel.prevMetricFmtValue);kpiCard.renderPrevMetricInfo();}if(me.plusMinus===0&&newValue[0].propValue==="0"){kpiCard.renderByFont(partArr);}kpiCard.applyUnifySteps(me.plusMinus===1?"plus":"minus",partArr);});},onPrevMetricNameChange:function onPrevMetricNameChange(){var me=this;this.layoutor.forEachChild(function(kpiCard){var dataModel=kpiCard.dataModel;if(dataModel.prevMetricFmtValue){dataModel.prevMetricInfo=me.getPrevMetricInfoString(dataModel.prevMetricFmtValue);kpiCard.renderPrevMetricInfo();}});this.unifyNodeFontSize("prevMetricNode");},onBadgeModeChange:function onBadgeModeChange(){var badgeMode=this.getFormatPropertyValue($KPI_PROPERTIES.BADGE_MODE),me=this;this.layoutor.forEachChild(function(kpiCard){var dataModel=kpiCard.dataModel;if(dataModel.prevMetricFmtValue){me.generateCmpString(dataModel,badgeMode);kpiCard.renderCompareNode();}});if(badgeMode!==$BADGE_MODE.NONE){this.unifyNodeFontSize("compareNode");}},onBadgeBgClrChange:function onBadgeBgClrChange(){var insBgClr=this.getFormatPropertyValue($KPI_PROPERTIES.INCREASE_BG_COLOR),desBgClr=this.getFormatPropertyValue($KPI_PROPERTIES.DECREASE_BG_COLOR),me=this;this.layoutor.forEachChild(function(kpiCard){var dataModel=kpiCard.dataModel,chartOption=dataModel.chartOption,chart=kpiCard.chartInstance;dataModel.cmpBgClr=dataModel.compareToPrev>=0?insBgClr:desBgClr;if(chartOption){chartOption.series[0].itemStyle=me.getItemStyle(kpiCard);}if(chart){chart.setOption(chartOption);}if(kpiCard.compareNode.textContent||kpiCard.compareNode.innerText){kpiCard.applyCmpNodeBgClr();}});},onColorThresholdsChange:function onColorThresholdsChange(){this.initColorThresholds();this.applyColorThresholds();},onStackedSlideChange:function onStackedSlideChange(newValue,urFlag){var layoutor=this.layoutor,slideIndex;if(!layoutor){return ;}layoutor.urFlag=false;slideIndex=layoutor.findCardIdxByElemId(newValue);if(this.isInStackedMode()&&!this.isStackedAutoPlay()&&layoutor.getCurrentSlickSlideIndex()!==slideIndex){layoutor.urFlag=!!urFlag;layoutor.manualSlickGoto(slideIndex,true);}},getProperties:function(){var modelData=this.model.data;return(modelData&&modelData.vp)||{};},getPrevMetricInfoString:function getPrevMetricInfoString(prevMetricFmtValue){var previousMatricName=this.getFormatPropertyValue($KPI_PROPERTIES.PREVIOUS_METRIC_NAME),infoString;if(previousMatricName===""){infoString=prevMetricFmtValue;}else{infoString=previousMatricName+": "+prevMetricFmtValue;}return infoString;},getDefaultPrimaryValueColor:function(){var font=this.getFontValue();return font[$CAN_SET_FONT_PARTS.PRIMARY_VALUE][$ENUM_PROPERTY_NAMES.COLOR];},getFontValue:function getFontValue(noDefaults){this.migrateOldFontProps();var props=this.getProperties();var fontProps;try{fontProps=JSON.parse(props[$KPI_PROPERTIES.NEW_FONT]);}catch(e){fontProps={};}if(noDefaults){return fontProps;}var $DEFAULT_FONT_PROPS={};$DEFAULT_FONT_PROPS[$ENUM_PROPERTY_NAMES.FONT_FAMILY]=this.getDefaultFontFamily();$DEFAULT_FONT_PROPS[$ENUM_PROPERTY_NAMES.FONT_SIZE]="8pt";$DEFAULT_FONT_PROPS[$ENUM_PROPERTY_NAMES.FONT_WEIGHT]=false;$DEFAULT_FONT_PROPS[$ENUM_PROPERTY_NAMES.FONT_STYLE]=false;$DEFAULT_FONT_PROPS[$ENUM_PROPERTY_NAMES.UNDERLINE]=false;$DEFAULT_FONT_PROPS[$ENUM_PROPERTY_NAMES.LINE_THROUGH]=false;$DEFAULT_FONT_PROPS[$ENUM_PROPERTY_NAMES.COLOR]=this.getDefaultFontColor();$DEFAULT_FONT_PROPS[$KPI_PROPERTIES.UNIFY_STEPS]="0";$HASH.forEach($CAN_SET_FONT_PARTS,function(v){var defaults=$HASH.copy($DEFAULT_FONT_PROPS,{});if(v===$CAN_SET_FONT_PARTS.TREND_IDENTITY){defaults[$ENUM_PROPERTY_NAMES.COLOR]="#ffffff";}else{if(v===$CAN_SET_FONT_PARTS.PREVIOUS_VALUE){defaults[$ENUM_PROPERTY_NAMES.FONT_WEIGHT]=true;defaults[$ENUM_PROPERTY_NAMES.FONT_STYLE]=true;}}fontProps[v]=$HASH.copy(fontProps[v]||{},defaults);});return fontProps;},getFormatPropertyValue:function getFormatPropertyValue(propertyName){var props=this.getProperties(),propValue;if(props[propertyName]===undefined){if(propertyName===$KPI_PROPERTIES.BADGE_MODE){propValue=this.isPercentNumberStyle?$BADGE_MODE.VALUE:$BADGE_MODE.PERCENTAGE;}else{if(propertyName===$KPI_PROPERTIES.PREVIOUS_METRIC_NAME){propValue=mstrmojo.desc(1058,"Previous")+" "+this.getTrendAttributeName();}else{if(propertyName===$KPI_PROPERTIES.GRID_COLUMN_COUNT){propValue=$DEFAULT_PROPERTY[propertyName];propValue=parseInt(propValue);var maxColCnt=this.singleKPIModels.length;propValue=propValue<=maxColCnt?propValue:maxColCnt;propValue=propValue.toString();this.updateProperties(propertyName,propValue);}else{propValue=$DEFAULT_PROPERTY[propertyName];}}}}else{propValue=props[propertyName];}if(propertyName===$KPI_PROPERTIES.NEW_FONT){propValue=this.getFontValue();}if(JSON_PROPS.indexOf(propertyName)>-1&&propValue!==undefined){try{propValue=JSON.parse(propValue);}catch(e){console.error(e,propValue);propValue=undefined;}}if(propertyName===$KPI_PROPERTIES.AUTO_PLAY||propertyName===$KPI_PROPERTIES.FIX_CARD_HEIGHT){propValue=$VisUtil.isTrue(propValue);}else{if(propertyName===$KPI_PROPERTIES.CARD_HEIGHT||propertyName===$KPI_PROPERTIES.GRID_COLUMN_COUNT){propValue=parseInt(propValue);}}return propValue;},generateFontProps:function(newValue){var font=this.getFontValue(true);$ARR.forEach(newValue,function(v){font[v.part]=font[v.part]||{};font[v.part][v.propName]=v.propValue;});return font;},generateUpdatedCustomStyleConfigs:function(styleId,propName,newValue){var currentConfigs=this.getFormatPropertyValue($KPI_PROPERTIES.CUSTOM_KPI_STYLE);var index=$ARR.find(currentConfigs||[],"id",styleId);if(index<0){console.error("invalid styleId: ",styleId);return currentConfigs;}currentConfigs[index][propName]=newValue;return currentConfigs;},getSpecificKPIStyle:function(kpiStyle){if(this.isDefaultKPIStyle(kpiStyle)){return $KPI_STYLES_CONFIG[kpiStyle];}var customStyles=this.getFormatPropertyValue($KPI_PROPERTIES.CUSTOM_KPI_STYLE);var index=$ARR.find(customStyles||[],"id",kpiStyle);if(index<0){return undefined;}return customStyles[index];},initCustomKPIStyle:function(newValue){var currentStyle=this.getFormatPropertyValue($KPI_PROPERTIES.KPI_STYLE);var customStyleConfigs=this.getFormatPropertyValue($KPI_PROPERTIES.CUSTOM_KPI_STYLE);var config=$KPI_STYLES_CONFIG[currentStyle];var CUSTOM="custom";if(!this.isDefaultKPIStyle(newValue)&&this.isDefaultKPIStyle(currentStyle)&&!customStyleConfigs){customStyleConfigs=[{id:CUSTOM,name:mstrmojo.desc(14417,"Customize"),bgColor:config.bgColor,bgOpacity:config.bgOpacity,chartColor:config.chartColor,chartOpacity:config.chartOpacity,},];this.updateProperties($KPI_PROPERTIES.CUSTOM_KPI_STYLE,customStyleConfigs);}},isDefaultKPIStyle:function(kpiStyle){kpiStyle=kpiStyle||this.getFormatPropertyValue($KPI_PROPERTIES.KPI_STYLE);var isDefault=false;$HASH.forEach($KPI_STYLES,function(value){if(value===kpiStyle){isDefault=true;}});return isDefault;},updateProperties:function updateProperties(propertyName,newValue){if(!propertyName){return ;}if(propertyName===$KPI_PROPERTIES.NEW_FONT){newValue=JSON.stringify(this.generateFontProps(newValue));}else{if(propertyName===$KPI_PROPERTIES.KPI_STYLE){this.initCustomKPIStyle(newValue);}}var modelData=this.model.data,properties=modelData&&modelData.vp,valChanged=true;if(!properties){console.log("invalid properties");return ;}if(newValue===undefined){delete properties[propertyName];}else{if(properties[propertyName]===undefined||properties[propertyName].toString()!==newValue.toString()){if(JSON_PROPS.indexOf(propertyName)>-1){properties[propertyName]=JSON.stringify(newValue);}else{properties[propertyName]=newValue;}}else{valChanged=false;}}if(valChanged){this.postUpdateProperties(propertyName,newValue);}return valChanged;},postUpdateProperties:function postUpdateProperties(propertyName,newValue){var layoutor,slideIndex,elemId;if(propertyName===$KPI_PROPERTIES.AUTO_PLAY){if(newValue===false){layoutor=this.layoutor;if(!(layoutor&&layoutor.getCurrentSlickSlideIndex)){return ;}slideIndex=layoutor.getCurrentSlickSlideIndex();elemId=layoutor.findCardElemIdByIdx(slideIndex);this.updateProperties($KPI_PROPERTIES.CURRENT_SLIDE_ELEMENT,elemId);}else{this.updateProperties($KPI_PROPERTIES.CURRENT_SLIDE_ELEMENT,undefined);}}else{if(propertyName===$KPI_PROPERTIES.KPI_STYLE){this.initCustomKPIStyle();}}},getFontOldValue:function(newValue){var oldValue;this.fontStack=this.fontStack||[];var popValue=this.fontStack.pop();if(popValue){oldValue=popValue;}else{oldValue=[];var currentFont=this.getFontValue();$ARR.forEach(newValue,function(v){oldValue.push({part:v.part,propName:v.propName,propValue:currentFont[v.part][v.propName],});});}this.fontStack.push(newValue);return oldValue;},writeProperties:function writeProperties(propertyName,newValue,dependedPropertyChanges){var hostId=this.id;var oldValue;if(propertyName===$KPI_PROPERTIES.NEW_FONT){oldValue=this.getFontOldValue(newValue);}else{oldValue=this.getFormatPropertyValue(propertyName);}var valChanged=this.updateProperties(propertyName,newValue);var silentSubmit=true;var dzPropUpdateCallback=this.zonesModel&&this.zonesModel.getUpdateCallback();var updateAndRefresh=function(propVal,doUpdate,urFlag,dependedChanges,undo){var host=mstrmojo.all[hostId];if(!host){return ;}if(dependedChanges){$ARR.forEach(dependedChanges,function(change){host.updateProperties(change.propertyName,undo?change.oldValue:change.value);});}if(doUpdate){host.updateProperties(propertyName,propVal);}if(!(host.isEmpty()||host.excludeData)){host.handlePropValChange(propertyName,propVal,urFlag);}if(silentSubmit&&dzPropUpdateCallback){dzPropUpdateCallback.success();}};if(valChanged){updateAndRefresh(newValue,false,undefined,dependedPropertyChanges,false);var urInfo={undo:function(){updateAndRefresh(oldValue,true,true,dependedPropertyChanges,true);},redo:function(){updateAndRefresh(newValue,true,true,dependedPropertyChanges,false);}};var requestCallback;if(silentSubmit){urInfo.silent=true;}else{requestCallback=this.getDocModel().controller._getXtabCallback(this);}if(requestCallback){urInfo.callback=requestCallback;}this.submitUpdates({requestCallback:requestCallback,urInfo:urInfo},silentSubmit);}},submitUpdates:function submitUpdates(updatesInfo,suppressData){if(!updatesInfo){return ;}var docModel=this.getDocModel(),dataService=docModel&&docModel.getDataService(),urInfo=updatesInfo.urInfo,extra={style:{params:{treesToRender:2}}},actions=this.getSetPropertiesAction(),cmdMgr;if(!dataService||!docModel||!docModel.controller||actions.length===0){return ;}if(suppressData){extra.style=mstrmojo.DocDataService.SUPPRESS_DATA;}cmdMgr=docModel.controller.cmdMgr;if(cmdMgr){cmdMgr.execute({execute:function(){var update=dataService.newUpdate();update.add(actions,updatesInfo.requestCallback,extra);if(suppressData){this.submitSilent(update.actions);}else{this.submitUpdate(update);}},urInfo:urInfo});}}});}());