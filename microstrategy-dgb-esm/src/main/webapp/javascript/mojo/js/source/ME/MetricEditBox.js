(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.hash","mstrmojo.Container","mstrmojo.desc","mstrmojo.ME.TokenInputBox","mstrmojo.mstr.EnumDSSXMLTokenTypes","mstrmojo.ME.Enum","mstrmojo._HasTooltip","mstrmojo.dom","mstrmojo.string");mstrmojo.requiresDescs(221,547,9106,9565,9566,9567,9568,11897,13542,13543,15665);var $ARR=mstrmojo.array,$HASH=mstrmojo.hash,$DESC=mstrmojo.desc,$DSS_XML_TOKEN_TYPES=mstrmojo.mstr.EnumDSSXMLTokenTypes,$METRIC_EDIT_TYPES=mstrmojo.ME.Enum.METRIC_EDIT_TYPES,$ENCODE=mstrmojo.string.escape4HTMLText,$DOM=mstrmojo.dom;var _VSTATUS={VALID:0,UNKNOWN:1,VALIDATING:2,ERROR:3,AMBIGUITY:4},_VSTATUSCSS={0:"valid",1:"unknown",2:"validating",3:"error",4:"ambiguity"},_VSTATUSDESC={0:$DESC(9565,"Valid Metric Formula."),1:$DESC(9106,"Require Validation?"),2:$DESC(9566,"Validation in Progress..."),3:$DESC(9567,"Validation Failed with Syntax Error!"),4:$DESC(9568,"Validation Failed with Object Ambiguity!")},_BACKEND_ERR_CODES={ERROR:"-2147214845",AMBIGUITY:"-2147214846"},_ERROR_MAP={};_ERROR_MAP[_BACKEND_ERR_CODES.ERROR]=_VSTATUS.ERROR;_ERROR_MAP[_BACKEND_ERR_CODES.AMBIGUITY]=_VSTATUS.AMBIGUITY;function _mapErrorCode(code){if(!code){return _VSTATUS.VALID;}return _ERROR_MAP[code]||_VSTATUS.ERROR;}mstrmojo.ME.MetricEditBox=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasPopup,mstrmojo._HasTooltip],{scriptClass:"mstrmojo.MetricEditBox",vStatus:_VSTATUS.VALID,iStatus:"",showStatus:true,browseItemVisible:true,absorbAmbiguity:true,validateFunc:null,isObjectVisible:function(itm){return true;},markupString:'<div id="{@id}" class="mstrmojo-MEBox {@cssClass}" style="{@cssText}"><div class="mstrmojo-MEBox-edit"></div><div class="mstrmojo-MEBox-status {@statusCssClass}"><div class="mstrmojo-MEBox-vStatus"></div><div class="mstrmojo-MEBox-iStatus"></div></div></div>',markupSlots:{editNode:function(){return this.domNode.firstChild;},iStatusNode:function(){return this.domNode.lastChild.lastChild;},vStatusNode:function(){return this.domNode.lastChild.firstChild;},statusNode:function(){return this.domNode.lastChild;}},markupMethods:{onvStatusChange:function(){var s=this.vStatus,vn=this.vStatusNode;vn.className="mstrmojo-MEBox-vStatus "+_VSTATUSCSS[s];vn.innerHTML=(this.getStatusDesc&&this.getStatusDesc(s))||_VSTATUSDESC[s]||"";if(this.vStatus===_VSTATUS.VALID){this.set("cValid",true);}},oniStatusChange:function(){this.iStatusNode.innerHTML=this.iStatus;}},children:[{scriptClass:"mstrmojo.ME.TokenInputBox",alias:"inputBox",slot:"editNode",renderOnScroll:false,renderBlockSize:0,bindings:{browseItemVisible:"this.parent.browseItemVisible",candidates:"this.parent.candidates"},editEmbeddedFilterToken:function(token){var editBox=this.parent;if(editBox.editEmbeddedFilterToken){editBox.editEmbeddedFilterToken(token);}}}],init:function init(props){var me=this,vFunc=props.validateFunc||this.validateFunc;if(vFunc){me.children=[{scriptClass:"mstrmojo.Button",alias:"validateBtn",slot:"statusNode",text:$DESC(11897,"Validate"),cssClass:"mstrmojo-WebHoverButton right hoverLink",cssDisplay:"inline-block",onclick:vFunc}].concat(this.children);}if(this._super){this._super(props);}this.statusCssClass=this.showStatus?"":"hidden";},getSearchPattern:function getSearchPattern(){return this.inputBox.getSearchPattern();},getHighlightedText:function getHighlightedText(p,t){return this.inputBox.getHighlightedText(p,t);},item2textCss:function item2textCss(data){return{4:"m",7:"am",11:"fx",12:"a",13:"fc",43:"tr",47:"cs"}[data.t]||"";},handleSuggestionItemSelect:function handleSuggestionItemSelect(it){var p=this.ambiguityDialog;if(it){p.onItemSelect(it);}p.close();},showDesc:true,showPath:true,ambiguityDialog:{scriptClass:"mstrmojo.Editor",cssClass:"mstrmojo-ME-ambiguityDialog",onOpen:function(){this.set("title",$DESC(13542,"Object Ambiguity - ##").replace("##",this.ambiguousName));this.list.clearSelect();this.list.set("items",this.items);this.list.singleSelect(0);this.label.set("text",$DESC(13543,"More than one object with the name '##' were found.").replace("##",this.ambiguousName));},children:[{scriptClass:"mstrmojo.Label",alias:"label",text:""},{scriptClass:"mstrmojo.ui.ScrollableSuggestionList",alias:"list",cssClass:"mstrmojo-ME-ambiguityList",bindings:{items:"this.parent.opener.suggestionItems"},onclick:function(evt){mstrmojo._IsList.onclick.call(this,evt);},getItemMarkup:function(item,idx){var opener=this.parent.opener,encode=mstrmojo.string.escape4HTMLText;var itemIconCss=(opener&&opener.item2textCss(item))||"";var additionalInfoMarkup="";if(item.path){additionalInfoMarkup='<div class="mstrmojo-object-additional-info" idx="'+idx+'">'+mstrmojo.desc(16154,"From Dataset:")+" "+$ENCODE(item.path)+"</div>";}else{item.standalone=true;}return'<div class="mstrmojo-object-item" idx="'+idx+'"><div class="mstrmojo-object-name '+itemIconCss+'" idx="'+idx+'">'+$ENCODE(item.n)+"</div>"+additionalInfoMarkup+"</div>";},buildTooltip:function(item,excludeSelf){if(item.standalone){return $ENCODE(item.path)+"> "+$ENCODE(item.n);}else{return $ENCODE(item.n)+'<div class="mstrmojo-object-additional-info">'+mstrmojo.desc(16154,"From Dataset:")+" "+$ENCODE(item.path)+"</div>";}}}],buttons:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-Button mstrmojo-WebButton hot",text:$DESC(547,"Select"),onclick:function(){var dlg=this.parent.parent;dlg.opener.handleSuggestionItemSelect(dlg.list.selectedItem);}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-Button mstrmojo-WebButton",text:$DESC(221,"Cancel"),onclick:function(){this.parent.parent.close();}}]},defaultOnTokensModify:function(){this.set("vStatus",_VSTATUS.UNKNOWN);this.set("iStatus","");},postBuildRendering:function postBuildRendering(){this._super();this.inputBox.attachEventListener("tokensModify",this.id,"defaultOnTokensModify");this.inputBox.attachEventListener("tokensModify",this.id,"ontokensModify");},updateInputBoxItems:function updateInputBoxItems(r){this.inputBox.set("items",r.items);},replaceErrorToken:function replaceErrorToken(oi){this.inputBox.replaceErrorToken(oi);},clientSideValidation:function clientSideValidation(r){if(!r){return ;}var isMDX=false,isApplySimple=false,items=r.items;try{isMDX=mstrApp.rootCtrl.docCtrl.model.isMDXDataset($HASH.any(this.parent.parent.datasets));isApplySimple=r.met==$METRIC_EDIT_TYPES.ADVANCED&&items[0].tp==$DSS_XML_TOKEN_TYPES.SimpPrefixFun&&items[0].v==="ApplySimple";}catch(e){}if(isMDX&&isApplySimple){var doubleQString=$ARR.filterOne(items,function(item){return item.tp===$DSS_XML_TOKEN_TYPES.DoubleQString;});var regExp=/(\'|\/\/|\-\-|\/\*|\*\/)/;if(doubleQString&&regExp.test(doubleQString.v)){r.vs=_VSTATUS.ERROR;r.rjec=_BACKEND_ERR_CODES.ERROR;r.rjed=$DESC(15665,"MDX pass-through expression should not contain ', //, --, /*, */.");}}},handleValidation:function handleValidation(r){if(!r){this.set("vStatus",_VSTATUS.ERROR);return ;}r.vs=_mapErrorCode(r.rjec);this.set("vStatus",r.vs);this.set("iStatus",mstrmojo.string.encodeHtmlString(r.rjed)||"");this.updateInputBoxItems(r);this.inputBox.focus();if(r.vs===_VSTATUS.AMBIGUITY){var me=this,its=r.items,ei=$ARR.find(its,"sta",-1),ambiguousName=its[ei].v,f=function(oi){me.replaceErrorToken(oi);me.set("iStatus","");me.set("vStatus",_VSTATUS.UNKNOWN);if(me.continueValidataion){me.continueValidataion();}else{me.set("vStatus",_VSTATUS.VALID);}};var ambiguityItems=$ARR.filter(r.srfd.items,this.isObjectVisible);var c=this.parent.candidates,citms=c&&c.items;if(citms){$ARR.forEach(ambiguityItems,function(item){var idx=$ARR.find(citms,"did",item.did);if(idx===-1){if(this.absorbAmbiguity){citms.push(item);}}else{item.path=citms[idx].path;}});}if(ambiguityItems.length===1){f(ambiguityItems[0]);return ;}this.openPopup("ambiguityDialog",{zIndex:100,items:ambiguityItems,ambiguousName:ambiguousName,onItemSelect:f});}else{if(this.postHandleValidation){this.postHandleValidation();}}},tooltip:"",useRichTooltip:true,updateTooltipConfig:function updateTooltipConfig(evt){var target=evt.target||$DOM.eventTarget(evt.hWin,evt.e),position=$DOM.position(target);this.richTooltip={posType:mstrmojo.tooltip.POS_TOPLEFT,content:this.getTooltipContent(evt),top:position.y+position.h,left:position.x+10,cssClass:"vi-regular vi-tooltip-A"};},getTooltipContent:function(evt){return this.iStatus;},showTooltip:function showTooltip(evt,win){if(evt.target===this.iStatusNode){this._super(evt,win);}}});mstrmojo.ME.MetricEditBox.VALIDATION_STATUS=_VSTATUS;mstrmojo.ME.MetricEditBox.VALIDATION_STATUS_CSS=_VSTATUSCSS;mstrmojo.ME.MetricEditBox.VALIDATION_STATUS_DESC=_VSTATUSDESC;}());