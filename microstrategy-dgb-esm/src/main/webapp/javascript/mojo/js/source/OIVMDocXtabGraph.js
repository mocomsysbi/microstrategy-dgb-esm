(function(){mstrmojo.requiresCls("mstrmojo.DocXtabGraph");var $D=mstrmojo.dom,$A=mstrmojo.array;function buildCoordsHashMap(coords){var coordObj={},coordHelperMap={},keysHelperMap={};$A.forEach(coords,function(coord){var coordkey=coord.goid+"."+coord.ggid+"."+((coord.gsid===undefined)?-1:coord.gsid);if(!coordObj[coordkey]){coordObj[coordkey]={};}if(!coordHelperMap[coord.co+"."+coordkey]){if(keysHelperMap[coordkey]===undefined){keysHelperMap[coordkey]=0;}else{keysHelperMap[coordkey]++;}coordObj[coordkey][keysHelperMap[coordkey]]={co:coord.co,sh:coord.sh};coordHelperMap[coord.co+"."+coordkey]="true";}});return coordObj;}function replaceCoordinates(mapCoords,coordObj){var keysHelperMap={},coordkey="";$A.forEach(mapCoords,function(mapCoord){coordkey=mapCoord.goid+"."+mapCoord.ggid+"."+((mapCoord.gsid===undefined)?-1:mapCoord.gsid);if(keysHelperMap[coordkey]===undefined){keysHelperMap[coordkey]=0;}else{keysHelperMap[coordkey]++;}var coord=coordObj[coordkey]&&coordObj[coordkey][keysHelperMap[coordkey]];if(coord){mapCoord.coords=coord.co;mapCoord.shape=coord.sh;}});}mstrmojo.OIVMDocXtabGraph=mstrmojo.declare(mstrmojo.DocXtabGraph,null,{scriptClass:"mstrmojo.OIVMDocXtabGraph",unrender:function unrender(){this.clearCache();delete this.preLoader;this._super();},postBuildRendering:function postBuildRendering(){if(!this.preLoader){this.preLoader=document.createElement("img");}return this._super();},retrieveGraphSrc:function retrieveGraphSrc(h,w){if(!h||parseInt(h,10)===0||parseInt(w,10)===0){return ;}if(isNaN(parseInt(this.node.data.sid,10))){return ;}var src=mstrConfig.taskURL+"?taskId=getRWGraphImage&taskEnv=xhr&__ts__="+(new Date().getTime())+"&messageID="+this.model.docModel.mid+"&nodeKey="+this.k+"&sliceID="+parseInt(this.node.data.sid,10)+"&imgType=4&width="+parseInt(w,10)+"&height="+parseInt(h,10),preLoader=this.preLoader,imgNode=this.imgNode,id=this.id,me=this;src=mstrmojo.addCSRFTokenToURL(src);if(preLoader.dsrc!==src){preLoader.dsrc=src;var fnComplete=function(){mstrApp.removeLoadingGraph(id);},load="load",err="error",fnPreFail,fnPreLoad,fnMainFail,fnMainLoad;fnPreLoad=$D.attachOneTimeEvent(preLoader,load,function(){fnMainLoad=$D.attachOneTimeEvent(imgNode,load,function(){fnComplete();imgNode.style.background="none";mstrmojo.all[id].defn.set("readyState",mstrmojo.EnumReadystate.IDLE);$D.detachEvent(imgNode,err,fnMainFail);},true);fnMainFail=$D.attachOneTimeEvent(imgNode,err,function(){fnComplete();$D.detachEvent(imgNode,load,fnMainLoad);},true);$D.detachEvent(preLoader,err,fnPreFail);imgNode.src=preLoader.src;},true);fnPreFail=$D.attachOneTimeEvent(preLoader,"error",function(){fnComplete();$D.detachEvent(preLoader,load,fnPreLoad);},true);var zt=this.model.docModel.zt;this.model.docModel.dataService.getRWGraphImage({k:this.k,sid:parseInt(this.node.data.sid,10),w:w,h:h,encodeImage:true,needCoordinate:mstrApp.optimizeFitToPage&&(zt===1||zt===2)?1:0},{success:function(res){preLoader.src="data:image/png;base64,"+(res.image||res);if(res.coords){var coords=JSON.parse(res.coords),coordObj={};coordObj=buildCoordsHashMap.call(me,coords);replaceCoordinates.call(me,me.as,coordObj);me.refreshMap();}},failure:function(){fnPreFail();}});}}});}());