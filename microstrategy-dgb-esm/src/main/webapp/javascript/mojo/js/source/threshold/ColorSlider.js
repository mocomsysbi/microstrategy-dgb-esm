(function(){mstrmojo.requiresClsP("mstrmojo","Widget","num","css","Container","Box","Label","EditableLabel","Image");mstrmojo.requiresClsP("mstrmojo.threshold","ColorBand","ImageBand","MarkersNode","ColorMarker","ThresholdModel");var $DOM=mstrmojo.dom,$NUM=mstrmojo.num,$CSS=mstrmojo.css,$ARR=mstrmojo.array,$HASH=mstrmojo.hash,ALIAS=["bands","markers"];var ENUM_TP_BAND=0,ENUM_TP_MARKER=1;var thresholdModel=mstrmojo.threshold.ThresholdModel,SLIDER_MODE=thresholdModel.SLIDER_MODE,BASED_ON_TYPES=thresholdModel.BASED_ON_TYPES,ASC_SORTER=function(n1,n2){return n1-n2;},DESC_SORTER=function(n1,n2){return n2-n1;},MIN_MARKER_DIST=5;function addChild(alias){var childWidget;if(alias===ALIAS[ENUM_TP_BAND]){childWidget=this.sliderMode===SLIDER_MODE.IMAGE_BASED?new mstrmojo.threshold.ImageBand():new mstrmojo.threshold.ColorBand();}else{childWidget=new mstrmojo.threshold.ColorMarker();}this[alias].addChildren([childWidget]);}function adjustMarkerPositions(positions,minDist,sliderLength,isboundaryPadded){var n=positions.length-1,lo=isboundaryPadded?0:1,hi=isboundaryPadded?n-1:n-2;for(var i=lo;i<=hi;i++){if(i===lo&&positions[i]<=0){positions[i]=minDist;}else{var deltaDist=positions[i]-positions[i-1];positions[i]+=(deltaDist<minDist)?(minDist-deltaDist):0;positions[i]=positions[i]>=sliderLength?(sliderLength-minDist):positions[i];}}for(var i=hi;i>lo;i--){if(i===hi&&positions[hi]>=sliderLength){positions[i]=sliderLength-minDist;}else{var deltaDist=Math.abs(positions[i+1]-positions[i]);positions[i]-=(deltaDist<minDist)?(minDist-deltaDist):0;}}positions.sort(ASC_SORTER);}function updateColorSlider(type){var containerWidget=this[ALIAS[type]],children=containerWidget.children,domLen=children?children.length:0,comp=this.getComp().sort(ASC_SORTER),palette=this.getPalette(),sliderWidth=this.width,mapLen=type?comp.length-1:comp.length,isImageBased=this.sliderMode===SLIDER_MODE.IMAGE_BASED,globalMinMax=this.parent.model.globalMinMax(this.minValue(),this.maxValue()),i,child,width;var markerPositions=$ARR.map(comp,function(c){return parseInt(sliderWidth*c,10);});adjustMarkerPositions(markerPositions,MIN_MARKER_DIST,sliderWidth,this.selectedOption===BASED_ON_TYPES.VALUE);if(domLen>mapLen){for(i=domLen-mapLen-1;i>=0;i--){containerWidget.removeChildren(children[i]);}}else{if(mapLen>domLen){for(i=0;i<mapLen-domLen;i++){addChild.call(this,ALIAS[type]);}}}if(type===0&&this.getReversedValue()){palette=palette.concat().reverse();}children=containerWidget.children;var previousPosition,currentPosition;for(i=0;i<mapLen;i++){child=children[i];previousPosition=(i===0)?0:markerPositions[i-1];currentPosition=markerPositions[i];if(type===0){child.set("left",(this.containerNode.offsetLeft+previousPosition+1)+"px");width=currentPosition-previousPosition;$CSS.toggleClass(child.domNode,"no-border",!width);child.set("width",width+"px");if(isImageBased){child.set("src",palette[i]);child.domNode.firstChild.style.left=child.domNode.clientWidth/2-12+"px";}else{child.set("backgroundColor",palette[i]);}}else{child.set("left",currentPosition-(isImageBased?0:1)+"px");child.updateCompValue(comp[i]);var thresholdModel=this.parent.model,realValue=thresholdModel.getRealValue(comp[i],this.selectedOption,this.minValue(),this.maxValue());child.updateRealValue(realValue);child.updatePosition(markerPositions[i]);}child.set("index",i);}}function buildDefaultMap(map,defaultModel,isImageBased){defaultModel.forEach(function(defaultSet){var m=map[defaultSet.id]={palette:[],comp:[],reversed:false};defaultSet.bands.forEach(function(band){m.palette.push(band[isImageBased?"url":"bc"]);m.comp.push(band.end/100);});});}function getDefaultColorMap(){var model=this.parent.model,map={};buildDefaultMap(map,model.getDefaultColors(),false);buildDefaultMap(map,model.getDefaultImages(),true);return map;}function parseNumeric(text){var value=$NUM.parseNumeric(text);if(isNaN(value)&&window.numeral){var val=window.numeral(text.toLowerCase()).value();value=typeof val==="number"?val:value;}return value;}mstrmojo.threshold.TextBubble=mstrmojo.declare(mstrmojo.EditableLabel,null,{scriptClass:"mstrmojo.EditableLabel",visible:false,cssClass:"editable-bubble",text:"",isPercentage:true,maxValue:1,showBubble:function(value,realValue,pos){this.updatePosition(value,pos);this.updateText(realValue);this.set("visible",true);},hideBubble:function(){this.set("visible",false);},updatePosition:function updatePosition(value,position){var pos=(position!==undefined)?position:this.parent.width*value;this.domNode.style.left=pos+"px";},updateText:function(realValue){var slider=this.parent,model=slider.parent.model,displayValue=realValue;if(slider.selectedOption===BASED_ON_TYPES.VALUE){this.realValue=displayValue;displayValue=$NUM.formatByMask(model.getFormatString(),displayValue);}if(this.isPercentage){displayValue+="%";}this.set("text",String(displayValue));}});mstrmojo.threshold.ColorSlider=mstrmojo.declare(mstrmojo.Container,null,{scriptClass:"mstrmojo.threshold.ColorSlider",markupString:'<div class = "mstrmojo-color-slider {@cssClass}"  style="{@cssText}" mstrAttach:click,keyup><div class="labels"></div><input type="text" class="hidden-field"></div>',markupSlots:{containerNode:function containerNode(){return this.domNode;},labelsNode:function labelsNode(){return this.domNode.firstChild;},hiddenField:function hiddenField(){return this.domNode.lastChild;}},sliderMode:SLIDER_MODE.COLOR_BASED,baseColor:undefined,editableBubble:undefined,hoverBubble:undefined,bands:undefined,markers:undefined,colorMap:undefined,selectedOption:undefined,userComp:[],getComp:function getComp(){return this.userComp;},getPalette:function getPalette(){return this.colorMap[this.baseColor].palette;},getReversedValue:function getReversedValue(){var colorMap=this.colorMap;return colorMap&&colorMap[this.baseColor].reversed||false;},postBuildRendering:function postBuildRendering(){this.width=$DOM.position(this.containerNode).w;this.resetColorMap();if(this._super){this._super();}this.update();},resetColorMap:function resetColorMap(){var prevCustom=undefined;if(this.colorMap){prevCustom=this.colorMap.custom;}this.colorMap=getDefaultColorMap.call(this);if(prevCustom){this.colorMap.custom=prevCustom;}if(this.baseColor in this.colorMap){this.userComp=$HASH.clone(this.colorMap[this.baseColor].comp);}},onkeyup:function(event){var evt=window.event||event.e,keyCode=evt.keyCode;if(this.sliderMode===SLIDER_MODE.COLOR_BASED&&(keyCode===mstrmojo.Enum_Keys.DELETE||keyCode===mstrmojo.Enum_Keys.BACKSPACE)){if(this.editableBubble.isEditing){return ;}var node,idx;if(this.bands.isSelected){node=this.bands;}else{if(this.markers.isSelected){node=this.markers;}else{return ;}}idx=node.selectedIndex;node.children[idx].unselect();node.remove(idx);this.update();}},update:function update(){if(this.baseColor){updateColorSlider.call(this,ENUM_TP_BAND);updateColorSlider.call(this,ENUM_TP_MARKER);}this.updateMinMax();},onsliderModeChange:function onsliderModeChange(){$CSS.toggleClass(this.domNode,"image-mode",this.sliderMode===SLIDER_MODE.IMAGE_BASED);this.resetMinMax();this.unselectAll();this.bands.removeChildren();},onbaseColorChange:function onbaseColorChange(v){if(v.value&&v.value in this.colorMap){this.userComp=$HASH.clone(this.colorMap[v.value].comp);}this.resetMinMax();this.unselectAll();this.update();},onselectedOptionChange:function selectedOption(v){var model=this.parent.model,editableBubble=this.editableBubble,oldBubbleValue=v.valueWas===BASED_ON_TYPES.VALUE?editableBubble.realValue:editableBubble.text;if(v.valueWas!==undefined){this.resetMinMax();this.markers.setMarkerRealValues(model.getRealValue.bind(model),v.value,this.minValue(),this.maxValue());this.update();}if(editableBubble.visible){if(v.valueWas===BASED_ON_TYPES.LOWEST_PERCENT||v.valueWas===BASED_ON_TYPES.HIGHEST_PERCENT){oldBubbleValue=oldBubbleValue.slice(0,oldBubbleValue.length-1);}var selectedIndex=this.markers.selectedIndex;editableBubble.updateText(this.markers.children[selectedIndex].realValue);}},updateLabels:function updateLabels(basedOnType){var model=this.parent.model,editableBubble=this.editableBubble,hoverBubble=this.hoverBubble,selectedMarkerIndex=this.markers.selectedIndex,start,end;basedOnType=basedOnType||this.selectedOption;if(basedOnType===BASED_ON_TYPES.LOWEST_PERCENT||basedOnType===BASED_ON_TYPES.HIGHEST_PERCENT){start="0%";end="100%";editableBubble.set("isPercentage",true);hoverBubble.set("isPercentage",true);}else{if(basedOnType===BASED_ON_TYPES.LOWEST||basedOnType===BASED_ON_TYPES.HIGHEST){start="0";end=model.getMetricsCount();editableBubble.set("isPercentage",false);hoverBubble.set("isPercentage",false);}else{var formatString=model.getFormatString();start=(this.minValue()<model.getMetricsMinValue())?"-&#8734":$NUM.formatByMask(formatString,model.getMetricsMinValue());end=(this.maxValue()>model.getMetricsMaxValue())?"&#8734":$NUM.formatByMask(formatString,model.getMetricsMaxValue());editableBubble.set("isPercentage",false);hoverBubble.set("isPercentage",false);}}this.startLabel.set("text",start);this.endLabel.set("text",end);if(!!this.markers.children&&selectedMarkerIndex>-1&&selectedMarkerIndex<this.markers.children.length){editableBubble.updateText(this.markers.children[selectedMarkerIndex].realValue);}},setColorComp:function setColorComp(color,comp){this.userComp=$HASH.clone(comp);var colorMap=this.colorMap;if(colorMap){colorMap[color].comp=comp;this.unselectAll();this.update();}},addCustomScheme:function(comp,palette){this.colorMap.custom={comp:comp,palette:palette,reversed:false};this.set("baseColor","custom");},addMarkerToMap:function addMarkerToMap(x){var comp=this.getComp(),len=comp.length,i;if(comp[0]>x){i=0;}else{for(i=1;i<len;i++){if(comp[i-1]<=x&&comp[i]>=x){break;}}}comp.splice(i,0,x);this.unselectAll();this.resetMinMax();return i;},unselectAll:function unselectAll(){var bands=this.bands,curBand=bands.children&&bands.selectedIndex>-1&&bands.children[bands.selectedIndex];if(bands.isSelected&&curBand&&typeof (curBand.unselect)==="function"){curBand.unselect();}var markers=this.markers,selectedIndex=markers.selectedIndex;if(markers.isSelected&&markers.children[selectedIndex]){markers.children[selectedIndex].unselect();}},reverseMapColor:function reverseMapColor(){if(this.colorMap&&this.baseColor){var map=this.colorMap[this.baseColor];map.reversed=!map.reversed;this.unselectAll();this.update();}},_minRealValue:undefined,_maxRealValue:undefined,resetMinMax:function resetMinMax(){this.set("_minRealValue",undefined);this.set("_maxRealValue",undefined);},updateMinMax:function updateMinMax(){var markerValues=this.markers.getMarkerRealValues(ASC_SORTER),thresholdModel=this.parent.model,globalMinMaxVals=this.parent.model.globalMinMax(),min=globalMinMaxVals.min,max=globalMinMaxVals.max,index=-1;if($ARR.isArray(markerValues)){while(++index<markerValues.length){if(markerValues[index]!==undefined){min=markerValues[index];break;}}index=markerValues.length;while(--index>=0){if(markerValues[index]!==undefined){max=markerValues[index];break;}}}this.set("_minRealValue",min);this.set("_maxRealValue",max);this.updateLabels(this.selectedOption);},minValue:function minValue(){return this._minRealValue;},maxValue:function maxValue(){return this._maxRealValue;},children:[{scriptClass:"mstrmojo.Label",cssClass:"start-label",alias:"startLabel",slot:"labelsNode",text:"0%",allowHTML:true},{scriptClass:"mstrmojo.Label",cssClass:"end-label",alias:"endLabel",slot:"labelsNode",text:"100%",allowHTML:true},{scriptClass:"mstrmojo.threshold.TextBubble",alias:"editableBubble",slot:"labelsNode",allowEmptyText:true,onTextEditComplete:function(changed,oldText){if(changed){var slider=this.parent,model=slider.parent.model,selectedIdx=slider.markers.selectedIndex,currentMarker=slider.markers.children[selectedIdx];var text=this.text;if(this.isPercentage){text=text.replace(/%$/,"");}var prefix=text.charAt(0),sign=1;if(prefix==="-"||prefix==="+"){text=text.substring(1);sign=(prefix==="-")?-1:1;prefix=text.charAt(0);}if(prefix.match(/\W/)!==null){text=text.replace(new RegExp("^\\"+prefix),"");}var formatStr=model.getFormatString(),isNumberFormatPercent=(formatStr||"").indexOf("%")>-1,scaleFactor=1,isBasedOnValue=slider.selectedOption===BASED_ON_TYPES.VALUE;if(isBasedOnValue&&isNumberFormatPercent&&text.indexOf("%")===-1){scaleFactor=0.01;}text=parseNumeric(text)*scaleFactor;if(isNaN(text)){this.set("text",oldText);return ;}text=text*sign;if(text<0&&!isBasedOnValue){text=0;}currentMarker.updateRealValue(text);slider.updateMinMax();var realValues=slider.markers.getMarkerRealValues(ASC_SORTER);selectedIdx=realValues.indexOf(text);var tempComps=realValues.map(function(v){return model.getNormalizedValue(v,slider.selectedOption,slider.minValue(),slider.maxValue());}),comp=slider.getComp(),normalizedValue=tempComps[selectedIdx],sliderWidth=slider.width,isImageBased=(slider.sliderMode===SLIDER_MODE.IMAGE_BASED),markerPosition=parseInt(sliderWidth*normalizedValue,10);tempComps.forEach(function(c,idx){comp[idx]=c;slider.markers.children[idx].updateCompValue(c);});this.updatePosition(normalizedValue);currentMarker.updateCompValue(normalizedValue);currentMarker.set("left",markerPosition-(isImageBased?0:1)+"px");currentMarker.unselect();slider.update();slider.markers.children[selectedIdx].select();}}},{scriptClass:"mstrmojo.threshold.TextBubble",alias:"hoverBubble",slot:"labelsNode",allowEmptyText:false},{scriptClass:"mstrmojo.Box",cssClass:"color-bands",alias:"bands",isSelected:false,selectedIndex:0,remove:function deleteBand(i){if(this.children.length===1){return ;}var slider=this.parent;var comp=slider.getComp(),palette=slider.getPalette();if(i===this.children.length-1){comp.splice(i-1,1);}else{comp.splice(i,1);}palette.splice(i,1);},onBandHovered:function(){this.isSelected=true;},onBandUnhovered:function(){this.isSelected=false;},onBandSelected:function(index){var i,bands=this.children,slider=this.parent,markers=slider.markers;for(i=0;i<bands.length;i++){if(i!==index&&bands[i].selected){bands[i].unselect();}}if(markers.isSelected===true){markers.children[markers.selectedIndex].unselect();}slider.hiddenField.focus();this.isSelected=true;this.selectedIndex=index;},onBandUnselected:function(index){var i,bands=this.children;for(i=0;i<bands.length;i++){if(i!==index&&bands[i].selected){return ;}}this.isSelected=false;}},{scriptClass:"mstrmojo.threshold.MarkersNode",alias:"markers",isSelected:false,selectedIndex:0,onMarkerSelected:function onMarkerSelected(index){var m=this.parent,currentMarker=this.children[index];m.editableBubble.showBubble(currentMarker.compValue,currentMarker.realValue,currentMarker.position);var i,markers=this.children;for(i=0;i<markers.length;i++){if(i!==index&&markers[i].selected){markers[i].unselect();}}var bands=m.bands;if(bands.isSelected===true){bands.children[bands.selectedIndex].unselect();}this.parent.hiddenField.focus();this.isSelected=true;this.selectedIndex=index;},onMarkerUnselected:function(index){var i,markers=this.children;for(i=0;i<markers.length;i++){if(i!==index&&markers[i].selected){return ;}}this.parent.editableBubble.hideBubble();this.isSelected=false;},onMarkerHovered:function onMarkerHovered(index){var m=this.parent,currentMarker=this.children[index];m.hoverBubble.showBubble(currentMarker.compValue,currentMarker.realValue,currentMarker.position);this.isSelected=true;},onMarkerUnhovered:function onMarkerUnhovered(){this.parent.hoverBubble.hideBubble();this.isSelected=false;}}]});}());