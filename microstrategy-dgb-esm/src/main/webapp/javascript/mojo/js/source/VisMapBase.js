(function(){mstrmojo.requiresCls("mstrmojo.dom","mstrmojo.hash","mstrmojo.func","mstrmojo.array","mstrmojo.css","mstrmojo.VisBase","mstrmojo.VisEnum","mstrmojo.VisUtility","mstrmojo.gm.GMEnums","mstrmojo.vi.viz.EnumVizStyles","mstrmojo.vi.viz.EnumDSSDropZones","mstrmojo.vi.ui.rw.selectors._IsMultiUnitControl","mstrmojo._VizSelectionHelper","mstrmojo.vi.ui.rw._HasVisSelections","mstrmojo.vi.ui.rw.selectors._BrushesAndHighlights","mstrmojo.gmaps._SupportMapBrushesAndHighlights","mstrmojo.gmaps._MapDataSelectionHelper","mstrmojo.gmaps.MapUtils","mstrmojo.gmaps.MapEnums","mstrmojo.gmaps.MapLayerZone","mstrmojo.gmaps.CustomMapViewer","mstrmojo.gmaps._MapProperty","mstrmojo.gmaps._CanExportPDF","mstrmojo.gmaps._HasContextMenu","mstrmojo.gmaps._LayerManipulation","mstrmojo.PerformanceLogOutput","mstrmojo.gmaps._MapLegendController","mstrmojo._colorPalette");var $MOJO=mstrmojo,$DOM=$MOJO.dom,$FUNC=$MOJO.func,$HASH=$MOJO.hash,$ARR=$MOJO.array,$CSS=$MOJO.css,$GMAPS=$MOJO.gmaps,$UTIL=$GMAPS.MapUtils,$VISUTIL=$MOJO.VisUtility,$VIZ=$MOJO.vi.viz,$EDZ=$VIZ.EnumDSSDropZones,$VIS_ENUM=mstrmojo.VisEnum,$Legend_Property=$VIS_ENUM.LegendPropertyTag,$Maps_Properties=$VIS_ENUM.MAPS_PROPERTIES,$EnumVizStyles=$VIZ.EnumVizStyles,$EnumBaseMapType=$GMAPS.EnumBaseMapType,$EnumGraphicType=$GMAPS.EnumGraphicType,$EnumMarkerType=$GMAPS.EnumMarkerType,$EnumClusterMode=$GMAPS.EnumClusterMode,$EnumPropertyType=$GMAPS.EnumPropertyType,$EnumDynamicZoomStatus=mstrmojo.gmaps.EnumDynamicZoomStatus,REG_SPLIT32=new RegExp(".{32}","g"),DIRTY_VP=$EnumPropertyType.dirtyVp,ENUM_LEGEND_MODE=$VIS_ENUM.EnumLegendMode,ENUM_SINGLE_LEGEND_MODE=$VIS_ENUM.EnumSingleLegendMode,PRP_LEGEND_SLOT=mstrmojo.gm.EnumLegendSlot,$PerfLog=$MOJO.PerformanceLogOutput;var MAP_CONFIG,isWarningShown,MAP_ATTACHED_EVENTS=["mousedown","contextmenu","mouseover","mouseout"],CSS_LOADED=false;var WIDGET_CLASS_NAMME_VIZ_STYLE_MAP={"com.microstrategy.web.vf.viewer.EsriMapApplicationViewer":$EnumVizStyles.ESRI_MAP,"com.microstrategy.web.vf.viewer.GoogleMapApplicationViewer":$EnumVizStyles.GOOGLE_MAP};function isGridDataContainsError(egt,eg){return egt!==undefined&&eg!==undefined&&eg!=="";}mstrmojo.VisMapBase=mstrmojo.declare(mstrmojo.VisBase,[mstrmojo._colorPalette,mstrmojo._VizSelectionHelper,mstrmojo.vi.ui.rw._HasVisSelections,mstrmojo.vi.ui.rw.selectors._IsMultiUnitControl,mstrmojo.vi.ui.rw.selectors._BrushesAndHighlights,mstrmojo.gmaps._SupportMapBrushesAndHighlights,mstrmojo.gmaps._MapDataSelectionHelper,mstrmojo.gmaps._MapProperty,mstrmojo.gmaps._HasContextMenu,mstrmojo.ui.menus._HasMenuPopup,mstrmojo.gmaps._MapLegendController,mstrmojo.gmaps._LayerManipulation],{scriptClass:"mstrmojo.VisMapBase",formatHandlers:{domNode:["RW"]},markupString:'<div id="{@id}" class="claro mstrmojo-Map {@cssClass} {@iconClass}" sty="gmap" style="position:{@position};overflow:hidden;width:{@width}px;height:{@height}px; left:{@left}px; top:{@top}px; z-index: {@zIndex};" mstrAttach:contextmenu,mousedown,mouseover,mouseout><div id="{@id}-toolbar"></div><div id="{@id}-map" style="height:{@height}px"><div id="{@id}-baseLayerDiv" style="height:{@height}px;position:absolute;top:0px;left:0px"></div></div><div id="{@id}-clearAllWindow"></div><div id="{@id}-metricSelectDiv"></div><div id="{@id}-clearAllPopupDiv"></div><div id="{@id}-singleSelectPopupDiv"></div><div id="{@id}-legend"></div><div class="map-err-message" style="font-size:15px;height:100px;width:100%;position:absolute;top:0;bottom:0;left:0;right:0;margin:auto;text-align:center;z-index:100;display:none"></div></div>',markupSlots:{toolBarDiv:function(){return this.domNode.firstChild;},mapDiv:function(){return this.domNode.childNodes[1];},baseLayerDiv:function(){return this.domNode.childNodes[1].firstChild;},clearAllWindowDiv:function(){return this.domNode.childNodes[2];},metricSelectDiv:function(){return this.domNode.childNodes[3];},clearAllPopupDiv:function(){return this.domNode.childNodes[4];},singleSelectPopupDiv:function(){return this.domNode.childNodes[5];},legendPlaceholder:function(){return this.domNode.childNodes[6];},errorMsgDiv:function(){return this.domNode.childNodes[7];}},isVisMap:true,viewerCls:$GMAPS.CustomMapViewer,mapViewer:null,mapDiv:null,tempMapDiv:null,reuseDOM:false,position:"absolute",gridParams:null,mapStylesCache:null,editorContentReady:false,propEditorListener:null,previousMapStyleId:null,isClientExport:null,mapEventListeners:null,refitContent:false,layerIdxMappingArr:[],widgetIdMapping:null,layerCount:0,isRefresh:null,isKeepOnlyExclude:false,needUpdateLayers:[],vpNameMappings:{ga:"ga",lat:"lat",lng:"lng"},oldVpNameMappings:{ga:"ma",lat:"flat",lng:"flong"},canOnlyDragOnTitleBar:true,visPropsUpdated:false,affinityLineTempKeys:{},previousWidth:null,previousHeight:null,layerZoneCacheInfo:null,registeredSDPKeys:null,errorMsg:null,defaultMarkerType:$EnumMarkerType.Pin,init:function init(props){this._super(props);if($DOM.isIE){this.tempMapDiv=document.createElement("div");}this.mapEventListeners=[];this.registeredSDPKeys={};if($DOM.isIE9){this.isClientExport=false;}if(!$UTIL.isOIVM()){this.position="relative";}this.loadMapCss();this.dynZoomStatus=$EnumDynamicZoomStatus.INIT;},setMapDimension:function setMapDimension(){var fmts=(this.getFormats&&this.getFormats())||(this.defn&&this.defn.fmts);if($UTIL.isExpress()&&fmts){if(fmts.width!==undefined){this.width=parseInt(fmts.width,10);}if(fmts.height!==undefined){this.height=parseInt(fmts.height,10);}}},isMapbox:function isMapbox(){return this.scriptClass==="mstrmojo.mapbox.VisMapbox";},buildRendering:function buildRendering(){if($UTIL.isVI()){this.zIndex=1;}this._super();},postBuildRendering:function postBuildRendering(){$PerfLog.endTimer("timerid_DataModel");$PerfLog.visPrint("postBuildRendering start");$PerfLog.startTimer({functionName:"VisMapBase.postBuildRendering: ",purpose:"from Build to End"},"timerid_fromBuildtoEnd");if(this.waitingForData){return ;}if($VISUTIL.isOnExpressMode()&&this.isEmpty()){$VISUTIL.renderWidgetErrorRSD(this,this.error,MAP_ATTACHED_EVENTS);return ;}this._super();var me=this,splitParams,callback;if(this.isLoadingExtraConfig){return ;}this.setMapDimension();if(!MAP_CONFIG){if($UTIL.isOIVM()){splitParams={taskId:"getMultiMapConfig",key:this.node.k,taskEnv:"xhr",taskContentType:"json"};callback={success:function(res){delete me.isLoadingExtraConfig;if(res){me.processData(res);me.buildMap();if(mstrmojo.vi.VisualInsightApp&&$UTIL.checkHasFunction(mstrApp,"isAppStateSelection")&&mstrApp.isAppStateSelection()){me.getDocModel().raiseEvent({name:"buildBoxLayoutComplete"});}}},failure:function(res){var msg=res&&res.getResponseHeader&&res.getResponseHeader("X-MSTR-TaskFailureMsg");delete me.isLoadingExtraConfig;$UTIL.hideWait(true);if(msg){me.displayError("Error loading Configuration: "+res.getResponseHeader("X-MSTR-TaskFailureMsg"));}else{me.displayError("Error loading Configuration.");}}};this.isLoadingExtraConfig=true;mstrApp.serverRequest(splitParams,callback);}else{me.processData(this.gridParams);me.buildMap();}}else{if(this.isRefresh!==true||this.requiresBuildByVF){if(!mstrApp.requireRestoreVFConfigMode){this.buildMap();this.requiresBuildByVF=false;}else{this.requiresBuildByVF=true;}}else{this.updateMap();}}this.isRefresh=null;},buildMap:function buildMap(){$PerfLog.endTimer("timerid_callback_buildMap");$PerfLog.visPrint("buildMap start");var me=this,docModel=this.getDocModel(),tmid=$PerfLog.startTimer({functionName:"VisMapBase.buildMap",purpose:"build Map and Graphics"});try{this.initBaseMapProps();this.initMapViewer();this.registerSdpInDocModel($HASH.keyarray(this.affinityLineTempKeys));if(docModel){this.sliceEvtListener=docModel.attachEventListener("secondaryDataSliced",this.id,function(evt){me.onSecondaryDataSliced(evt.key,evt.data);});this.docSaveListener=docModel.attachEventListener("updWgtsProps",this.id,function(){me.saveZoomLevelandPosition();});}this.previousWidth=this.width;this.previousHeight=this.height;}catch(e){console.log("build map error");console.log(e.stack);$UTIL.hideWait(true);}$PerfLog.endTimer(tmid);$PerfLog.visPrint("buildMap end");$PerfLog.startTimer({functionName:"VisMapBase.postBuildRendering: ",purpose:"time gap between buildMap completion and map load"},"timerid_callback_LoadMainModule");$PerfLog.startTimer({functionName:"VisMapBase.postBuildRendering: ",purpose:"time gap between buildMap completion and map load"},"timerid_callback_CustomLayerinitShapeInfo");},onSecondaryDataSliced:function onSecondaryDataSliced(key,data){var nodeData=this.model.data,sdp=nodeData&&nodeData.sdp,mapViewer=this.mapViewer,affinityLineTempKeys=this.affinityLineTempKeys;if(sdp&&sdp[key]){sdp[key]=data;}if(affinityLineTempKeys[key]){affinityLineTempKeys[key]=data;}if(mapViewer){mapViewer.onSecondaryDataSliced(key);}},initMapViewer:function initMapViewer(){var baseLayer=this.mapViewer&&this.mapViewer.baseLayer,params={};if(baseLayer&&baseLayer.isActive()){baseLayer.parent=null;params={baseLayer:baseLayer,hasInit:true};}else{baseLayer=null;}this.destroyComponents(!!baseLayer);var gridsMapping=this.loadGridData(),commonConfig=MAP_CONFIG.common,mapViewer,beanPath,gridBone;if(!gridsMapping){return ;}if(commonConfig){if(!!commonConfig.beanPath){beanPath=commonConfig.beanPath;}else{if(!!commonConfig.boneId&&typeof (microstrategy)!==undefined){gridBone=microstrategy.bone(commonConfig.boneId);beanPath=gridBone&&gridBone.getDocViewer().beanPath;}}}mapViewer=this.mapViewer=new (this.viewerCls)($HASH.copy(params,{parent:this,gridsMapping:gridsMapping,beanPath:beanPath,k:(this.node&&this.node.k)||this.model.data.k}));this.needUpdateLayers=Object.keys(gridsMapping);mapViewer.initAllLayers();},needMapReadyEvent:function needMapReadyEvent(){return !!mstrApp.isExporting;},checkForMapReady:function checkForMapReady(){var mapViewer=this.mapViewer,baseLayer=mapViewer.baseLayer,me=this;if(!this.graphicsReady){var mapGeoExtent=mapViewer.getMapGeoExtent();if(!mapGeoExtent){var cloudLayerLoaded=true;if(baseLayer.baseMapType===$EnumBaseMapType.Esri){mapViewer.forEachGraphicLayer(function(graphicLayer){if(graphicLayer&&graphicLayer.scriptClass==="mstrmojo.gmaps.layer.CloudLayer"){if(graphicLayer.geoPosition>=0&&!graphicLayer.shapeInfoArr){cloudLayerLoaded=false;}}});}if(cloudLayerLoaded){this.graphicsReady=true;}}}if(!this.needMapReadyEvent()||!this.graphicsReady){return ;}if(baseLayer.isBaseMapReady&&!this.firstRenderFinish&&mapViewer.hasInit){window.setTimeout(function(){me.raiseEvent({name:"mapReady",id:me.k});me.firstRenderFinish=true;baseLayer.isBaseMapReady=false;},0);}if(this.duringResize&&baseLayer.isBaseMapReady){window.setTimeout(function(){me.raiseEvent({name:"mapReadyAfterResize",id:me.k});me.duringResize=false;},0);}},updateMap:function updateMap(){$UTIL.showWait();var mapViewer=this.mapViewer;if(mapViewer){mapViewer.restore();this.updateMapViewer();if(this.hasResized()){this.resizeLegendByWidget();mapViewer.resize();this.displayError();}}$UTIL.hideWait();},updateMapViewer:function updateMapViewer(){var graphicLayer,layerKey,widget,data,mapViewer=this.mapViewer,graphicLayerMapping=mapViewer&&mapViewer.graphicLayerMapping,layersToUpdate={};if(!graphicLayerMapping){return ;}this.loadGridData();this.needUpdateGraphicLayersCnt=mapViewer.getVisibleGraphicLayerCount();this.needUpdateLayers=mapViewer.getVisibleGraphicLayers();var isAllGraphicLayerNoChange=true;for(layerKey in graphicLayerMapping){graphicLayer=graphicLayerMapping[layerKey];data=this.getGridData(layerKey);if(data!==graphicLayer.data){layersToUpdate[layerKey]=data;}else{mapViewer.updateNeedUpdLayers(this,layerKey);}}for(layerKey in layersToUpdate){data=layersToUpdate[layerKey];isAllGraphicLayerNoChange=false;widget=this.fnGetWidget(layerKey);mapViewer.gridsMapping[layerKey]={data:data};mapViewer.updateGraphicLayer(data,widget&&widget.useRefresh);if(widget){delete widget.useRefresh;}}if(!isAllGraphicLayerNoChange){mapViewer.highlightAllLayers();}if(isAllGraphicLayerNoChange){$PerfLog.endTimer("timerid_fromBuildtoEnd");}mapViewer.applyViewPort2Graphics();},hasResized:function hasResized(){var result=$UTIL.checkVal(this.previousWidth)&&$UTIL.checkVal(this.previousHeight)&&(this.previousWidth!==this.width||this.previousHeight!==this.height);this.previousWidth=this.width;this.previousHeight=this.height;return result;},processData:function processData(mapConfig){MAP_CONFIG=mapConfig;if(mapConfig.err&&!isWarningShown){mstrmojo.alert(mapConfig.err);isWarningShown=true;}},loadGridData:function loadGridData(){var model=this.getData();if(!model){return ;}var gridsMapping={},me=this,primaryKey=model.k,xtab;if(this.isGraphicLayerGrid(model)===true){gridsMapping[primaryKey]={data:model};}this.forEachSecondaryProvider(function(layerData,key){if(!layerData){return ;}gridsMapping[key]={data:layerData};xtab=me.fnGetWidget(key,layerData);me.syncPropsForSdpXtab(xtab);});return gridsMapping;},update:function update(node){var continueUpdate=this._super(node),me=this;if(continueUpdate!==false){this.preparePropsForDocument();this.forEachSecondaryProvider(function(xtabData,layerKey){var xtab=me.fnGetWidget(layerKey,xtabData);if(xtab){xtab.node.data=xtabData;}});this.oldDataAdaptor();if(!this.visPropsUpdated){this.visPropsUpdated=true;this.initLayerIdxMappingArr();}}return continueUpdate;},hasError:function(){var nodeData=this.model.data,sdp=(nodeData&&nodeData.sdp)||{},dataList=[],eg,egt,layerName,key,me=this,layerIdxMappingArr=this.layerIdxMappingArr,layerNum=layerIdxMappingArr.length;this.clearError();if(!nodeData){return false;}dataList.push(nodeData);for(key in sdp){dataList.push(sdp[key]);}$ARR.forEach(dataList,function(data){$ARR.forEach(layerIdxMappingArr,function(layerIdx){if(data&&data.k===layerIdx){egt=data&&data.egt;eg=data&&data.eg;layerName=data&&data.vp&&data.vp.ln;if(isGridDataContainsError(egt,eg)){me.error.push(layerName?(layerName+": "+eg):eg);me.errorType.push(egt);}return false;}});});return(me.errorType.indexOf(2)>-1)?true:(me.errorType.length===layerNum);},clearError:function(){this.error=[];this.errorType=[];},isEmpty:function(){return !this.excludeData&&this.hasError();},isBaseMapValid:function isBaseMapValid(){return $HASH.walk("mapViewer.baseLayer.isSupport",this);},getVisEmptyMsgControls:function(){if(this.excludeData){return $VISUTIL.getVisEmptyMsgControls.call(this);}if(!this.hasError()){return ;}var msg="";$ARR.forEach(this.error,function(item){msg+='<div style="padding-bottom:8px">'+item+"</div>";});return[{scriptClass:"mstrmojo.Container",cssClass:"error-msg",markupString:'<div class="{@cssClass}"><div class="error-content" style="visibility: visible">'+msg+"</div></div>",markupSlots:{containerNode:function(){return this.domNode;}}}];},preparePropsForDocument:function preparePropsForDocument(){var key,keys={},primaryKey=this.k,data=this.getData(),vp=data&&data.vp,sgProps=(vp&&vp.sgProps)||{},docModel=this.getDocModel(),sdp=data&&data.sdp,afTempProp=$EnumPropertyType.affinityLineGrid,checkAndPushFn=function(props){if(props&&(props[$EnumPropertyType.showAffinityLines]==="1")&&props[afTempProp]){keys[props[afTempProp]]=true;}};if(docModel){if(!sdp){sdp=docModel.getMapLayersDataByHostKey(primaryKey);data.sdp=sdp;}else{$ARR.forEach($HASH.keyarray(sdp),function(layerKey){docModel.updatePrimaryScdpMap(primaryKey,layerKey,true);});}}sdp=sdp||{};checkAndPushFn(vp);for(key in sdp){if(sgProps[key]){vp=sgProps[key];if(sdp[key]){sdp[key].vp=vp;}}else{vp=sdp[key]&&sdp[key].vp;}checkAndPushFn(vp);}for(key in keys){keys[key]=sdp[key]||{};}this.affinityLineTempKeys=keys;},forEachSecondaryProvider:function forEachSecondaryProvider(callback){var key,nodeData=this.model.data,sdp=(nodeData&&nodeData.sdp)||{},affinityLineTempKeys=this.affinityLineTempKeys;for(key in sdp){if(!affinityLineTempKeys[key]){callback(sdp[key],key);}}},getAffinityLineTemplate:function getAffinityLineTemplate(key){return this.affinityLineTempKeys[key];},updatePropEditor:function updatePropEditor(){var listener=this.propEditorListener;if(!!listener&&listener.listener&&listener.callback){listener.callback.call(listener.listener,listener.args);}this.propEditorListener=null;},hasColorByOrSizeBy:function hasColorByOrSizeBy(gridKey){var colorByItems=this.getDropZoneItems($EDZ.ColorBy,gridKey),sizeByItems=this.getDropZoneItems($EDZ.SizeBy,gridKey);return colorByItems&&colorByItems.length||(sizeByItems&&sizeByItems.length);},hasSizeBy:function hasSizeBy(gridKey){var sizeByItems=this.getDropZoneItems($EDZ.SizeBy,gridKey);return sizeByItems&&sizeByItems.length;},upgradeWidgetProperties:function upgradeWidgetProperties(vp){if(!vp){return ;}vp.separateColorSize="1";},getWidgetForTemplateSelection:function getWidgetForTemplateSelection(sourcekey){var key=sourcekey||this.getKeyForTemplateSelection();return this.fnGetWidget(key);},getDefnAnForTemplateSelection:function getDefnAnForTemplateSelection(){var xtab=this.getWidgetForTemplateSelection(),node=xtab&&xtab.node,an=node&&node.defn.an;return an;},getAllLayerKeys:function getAllLayerKeys(addPrimaryKey){var mapViewer=this.mapViewer,graphicLayerMapping=mapViewer&&mapViewer.graphicLayerMapping,keys=(graphicLayerMapping&&Object.keys(graphicLayerMapping))||[];if(addPrimaryKey&&keys.indexOf(this.k)<0){keys=keys.concat(this.k);}return $ARR.ensureArray(keys);},getKeyForTemplateSelection:function getKeyForTemplateSelection(noDefault){var layerIdxMappingArr=this.layerIdxMappingArr,map=this,vis,node,an,keyForTemplateSelection;$ARR.forEach(layerIdxMappingArr,function(layerKey){vis=map.fnGetWidget(layerKey);node=vis&&vis.node;if(!!node){an=node.defn&&node.defn.an;if(an&&an.length>0){keyForTemplateSelection=layerKey;}}});if(!keyForTemplateSelection&&!noDefault){keyForTemplateSelection=this.getGridKeyByIdx(0);}return keyForTemplateSelection;},getEditingLayerIdx:function getEditingLayerIdx(){var props=this.getProperties(),editingLayerIdx=props&&props[$EnumPropertyType.editingLayerIdx];return(isNaN(editingLayerIdx))?0:editingLayerIdx;},updateEditingLayerIdx:function updateEditingLayerIdx(newIdx){this.updateProperties($EnumPropertyType.editingLayerIdx,newIdx);},getEditingGridKey:function getEditingGridKey(){var editingLayerIdx=this.getEditingLayerIdx();if(isNaN(editingLayerIdx)){editingLayerIdx=0;}if(this.layerIdxMappingArr){return this.layerIdxMappingArr[editingLayerIdx];}},getEditingHost:function getEditingHost(){var key=this.getEditingGridKey();return this.fnGetWidget(key);},getEditingGridData:function getEditingGridData(){var key=this.getEditingGridKey();return this.getGridData(key);},getEditingGridProps:function getEditingGridProps(){var gridData=this.getEditingGridData();return gridData&&gridData.vp;},getEditingDz:function getEditingDz(){var gridData=this.getEditingGridData();return gridData&&gridData.dz;},getEditingDropZoneItems:function getEditingDropZoneItems(zoneId){var key=this.getEditingGridKey();return this.getDropZoneItems(zoneId,key);},isEditingDropZoneColorByAttr:function isEditingDropZoneColorByAttr(){var key=this.getEditingGridKey();return this.isColorByAttribute(key);},fnGetWidget:function fnGetWidget(_key,data){var docModel,widget,id;if(!$UTIL.checkDefined(_key)||_key===this.k){return this;}else{if(this.affinityLineTempKeys[_key]){return undefined;}else{docModel=this.getDocModel();if(docModel){id=this.getWidgetId(_key);if(id){widget=mstrmojo.all[id];}if(this.builder&&!widget&&data&&(!$UTIL.isVI()||docModel.getLayoutUnitDefn(_key))){widget=this.createSdpXtab(_key,docModel,data,this.getVisName(data));}if(widget&&widget.model&&widget.model.data&&!(widget.model.data.visName)){widget.model.data.visName=this.getVisName(widget.model.data);}if(widget&&widget.node&&widget.node.data&&widget.node.data.gsi&&!(widget.gridInfo)){widget.gridInfo=widget.node.data.gsi;}return widget;}}}},getWidgetId:function getWidgetId(nodeKey){if(this.widgetIdMapping){return this.widgetIdMapping[nodeKey];}},getTopLayerHost:function getTopLayerhost(){var topLayerKey=this.layerIdxMappingArr&&this.layerIdxMappingArr[0];return this.fnGetWidget(topLayerKey);},registerSdpInDocModel:function registerSdpInDocModel(layerKeys){var data,primaryKey,primaryVisName,registeredSDPKeys,docModel=this.getDocModel();if(docModel){data=this.getData();registeredSDPKeys=this.registeredSDPKeys;primaryKey=data.k;primaryVisName=data.visName;$ARR.forEach(layerKeys,function(key){docModel.addSDP(key,{k:primaryKey,visName:primaryVisName});registeredSDPKeys[key]=true;});}},unRegisterSdpInDocModel:function unRegisterSdpInDocModel(layerKeys){var registeredSDPKeys,docModel=this.getDocModel();if(docModel){registeredSDPKeys=this.registeredSDPKeys;$ARR.forEach(layerKeys,function(key){if(registeredSDPKeys[key]){docModel.removeSDP(key);delete registeredSDPKeys[key];}});}},createSdpXtab:function createSdpXtab(nodeKey,docModel,data,visName){var widget=this,builder=widget.builder,widgetIdMapping=this.widgetIdMapping=this.widgetIdMapping||{};if(!docModel||!data||!visName||!builder){return ;}visName=(visName===$EnumVizStyles.ESRI_MAP)?$EnumVizStyles.GOOGLE_MAP:visName;data.wid=1;var obj=builder.newXtab(docModel,{data:data,defn:docModel.getLayoutUnitDefn(nodeKey)||{},id:docModel.getWidgetId(data)}),ModelClass=builder.getModelClassByVisName(visName);obj.isSdp=true;widgetIdMapping[nodeKey]=obj.id;this.registerSdpInDocModel([nodeKey]);if(ModelClass){obj.setModel(new ModelClass({xtab:obj,controller:widget.controller,docModel:docModel,data:data}));obj.k=nodeKey;this.addMethods2SdpXtab(obj);return obj;}},updateXtabProps:function updateXtabProps(gridData){var vp,key=gridData.k,data=this.getData(),hostVp=data&&data.vp,sgProps=(hostVp&&hostVp.sgProps)||{},layerIdx=Math.max(0,this.layerIdxMappingArr.indexOf(key));vp=sgProps[key]?sgProps[key]:gridData.vp;gridData.vp=this.vpAdapter(vp,layerIdx);},addMethods2SdpXtab:function addMethods2SdpXtab(xtab){var oriUpdate,newUpdate,widget=this,_addMethod2Xtab=function(methodName,func){xtab[methodName]=func;xtab.methodArr.push(methodName);};if(widget&&xtab&&!(xtab instanceof mstrmojo.VisMapBase)){oriUpdate=xtab.update;newUpdate=function(xtabNode){var continueUpdate=true;if(this._super){continueUpdate=this._super(xtabNode);}if(xtabNode&&xtabNode.data){widget.updateXtabProps(xtabNode.data);}return continueUpdate;};xtab.methodArr=[];_addMethod2Xtab("update",function(){var tmp=this._super;this._super=oriUpdate;var ret=newUpdate.apply(this,arguments||[]);this._super=tmp;return ret;});_addMethod2Xtab("getData",function(){return this.node&&this.node.data;});_addMethod2Xtab("refresh",function(){var mapViewer=widget&&widget.mapViewer,visMap=mapViewer.parent,graphicLayer=mapViewer&&(mapViewer.getGraphicLayer instanceof Function)&&mapViewer.getGraphicLayer(this.k),isRefreshGraphicLayer=this.useRefresh,gridData=this.getData();if(!mapViewer||!graphicLayer||!gridData){return ;}if(gridData!==graphicLayer.data){var eg=gridData.eg,egt=gridData.egt;widget.model.data.sdp[this.k]=gridData;if(!isGridDataContainsError(egt,eg)){if(visMap.needUpdateLayers.length===0){if(visMap.isKeepOnlyExclude){visMap.needUpdateLayers=mapViewer.getVisibleGraphicLayers();}else{visMap.needUpdateLayers.push(graphicLayer.key);}}mapViewer.updateGraphicLayer(gridData,isRefreshGraphicLayer);}widget.raiseEvent({name:"toggleCtrlOverlay",visible:widget.isEmpty()||widget.excludeData,controls:widget.getVisEmptyMsgControls()});widget.applyBackground();}delete this.useRefresh;});_addMethod2Xtab("fnGetWidget",function(){return widget;});}},applyBackground:function applyBackground(){var unitContainer=this.parent,ctrOverLay=unitContainer&&unitContainer.ctrlOverlay,ctrlOverLayDomNode=ctrOverLay&&ctrOverLay.domNode,unitContainerDomNode=unitContainer&&unitContainer.domNode,unitContainerStyle=unitContainerDomNode&&unitContainerDomNode.style,backgroundColor;if(ctrlOverLayDomNode&&unitContainerStyle){backgroundColor=unitContainerStyle.backgroundColor;ctrlOverLayDomNode.style.backgroundColor=backgroundColor;ctrlOverLayDomNode.style.visibility="visible";}this._super();},getSdpKeyArr:function getSdpKeyArr(){var layerIdxMappingArr=this.layerIdxMappingArr,primaryKey=this.k,sdpKeyArr,idx;if(!layerIdxMappingArr||!(layerIdxMappingArr instanceof Array)||!$UTIL.checkDefined(primaryKey)){return[];}sdpKeyArr=layerIdxMappingArr.slice();idx=sdpKeyArr.indexOf(primaryKey);if(idx!==-1){sdpKeyArr.splice(idx,1);}return sdpKeyArr;},getGridData:function getGridData(k){var data=this.getData(),host;if(!$UTIL.checkDefined(k)||(data.k&&data.k===k)){return data;}host=this.fnGetWidget(k);return $UTIL.checkHasFunction(host,"getData")?host.getData():(data&&data.sdp&&data.sdp[k]);},getGridKey:function getGridKey(host){host=host||this;var data=host&&host.getData();return !!data&&data.k;},getGridKeyByIdx:function getGridKeyByIdx(idx){idx=parseInt(idx);if(!isNaN(idx)){return this.layerIdxMappingArr&&this.layerIdxMappingArr[idx];}},getBottomGridKey:function getBottomGridKey(){var idxMap=this.layerIdxMappingArr,len=(idxMap&&idxMap.length)||0;return len>0?idxMap[len-1]:"";},getDz:function getDz(k){var data=this.getGridData(k);return data&&data.dz;},getProperties:function getProperties(k){var data=this.getGridData(k);return data&&data.vp;},isColorByAttribute:function isColorByAttribute(k){var dz=this.getDz(k);if(dz&&dz.ColorBy&&dz.ColorBy.TemplateUnit){return true;}return false;},showInfoIcon4GeoItem:function showInfoIcon4GeoItem(){var layerKey=this.getEditingGridKey(),mapViewer=this.mapViewer,layer=mapViewer&&mapViewer.getGraphicLayer(layerKey);if(layer&&typeof layer.showInfoIcon4GeoItem==="function"){layer.showInfoIcon4GeoItem();}},getTtpContent4GeoItem:function getTtpContent4GeoItem(index){var layerKey=this.getEditingGridKey(),mapViewer=this.mapViewer,layer=mapViewer&&mapViewer.getGraphicLayer(layerKey);if(layer&&typeof layer.getTtpContent4GeoItem==="function"){return layer.getTtpContent4GeoItem(index);}},getDropZoneItems:function getDropZoneItems(zoneId,k){var data=this.getGridData(k),dz=this.getDz(k),vp=this.getProperties(k),r=[],me=this,atId,tooltips,ids,units,i,latId,lat,lngId,lng,colorBy;if(!data){return ;}switch(zoneId){case $EDZ.GeoAttribute:if(dz&&dz.Geo){r=dz.Geo.TemplateUnit||[];}else{atId=(!!vp&&vp[$EnumPropertyType.graphicType]===$EnumGraphicType.Area&&vp[$EnumPropertyType.attributeId])?vp[$EnumPropertyType.attributeId]:(!!vp&&vp[$EnumPropertyType.geoAttribute]);r=getUnitsById.call(this,atId,data);}for(i=0;i<r.length;i++){r[i].zone=$EDZ.GeoAttribute;}break;case $EDZ.Latitude:if(dz&&dz.Lat){r=dz.Lat.TemplateUnit||[];}else{latId=!!vp&&vp[$EnumPropertyType.latitude];lat=getUnitsById.call(this,latId,data);if(latId){r=lat.length?lat:[{id:latId,t:21}];}}break;case $EDZ.Longitude:if(dz&&dz.Long){r=dz.Long.TemplateUnit||[];}else{lngId=!!vp&&vp[$EnumPropertyType.longitute];lng=getUnitsById.call(this,lngId,data);if(lngId){r=lng.length?lng:[{id:lngId,t:21}];}}break;case $EDZ.Angle:if(dz&&dz.AngleBy){r=dz.AngleBy.TemplateMetric||[];}else{r=getUnitsById.call(this,!!vp&&vp.amt,data);}break;case $EDZ.ColorBy:if(dz&&dz.ColorBy){colorBy=dz.ColorBy;if(colorBy.TemplateMetric){r=colorBy.TemplateMetric||[];}else{if(colorBy.TemplateUnit){r=colorBy.TemplateUnit||[];}}}else{r=getUnitsById.call(this,!!vp&&vp.cmt,data);}break;case $EDZ.SizeBy:if(dz&&dz.SizeBy){r=dz.SizeBy.TemplateMetric||[];}else{r=getUnitsById.call(this,!!vp&&vp.smt,data);}break;case $EDZ.SliceBy:if(dz&&dz.SliceBy){r=dz.SliceBy.TemplateUnit||[];}else{ids=!!vp&&vp[$EnumPropertyType.slice];ids=ids?ids.match(REG_SPLIT32):[];$ARR.forEach(ids,function(id){units=getUnitsById.call(me,id,data);if(units.length){r=r.concat(units);}});}break;case $EDZ.AdditionalMetrics:tooltips=dz&&dz.AdditionalMetrics;if(tooltips){r=(tooltips.TemplateMetric||[]).concat(tooltips.TemplateUnit||[]).sort(function(a,b){return a.idx-b.idx;});}else{ids=!!vp&&vp.tooltip;ids=ids?ids.match(REG_SPLIT32):[];$ARR.forEach(ids,function(id){units=getUnitsById.call(me,id,data);if(units.length){r=r.concat(units);}});}break;default:break;}$ARR.forEach(r,function(x){if(!x.did){x.did=x.id;}});return r;},getDropZones:function getDropZones(k){var dropZones={};var geoItems=this.getDropZoneItems($EDZ.GeoAttribute,k);dropZones.geoAttribute=getIDFromDropZoneItems(geoItems);var latitudeItems=this.getDropZoneItems($EDZ.Latitude,k);dropZones.latitude=getIDFromDropZoneItems(latitudeItems);var longitudeItems=this.getDropZoneItems($EDZ.Longitude,k);dropZones.longitude=getIDFromDropZoneItems(longitudeItems);var sliceItems=this.getDropZoneItems($EDZ.SliceBy,k);dropZones.sliceBy=$ARR.map(sliceItems,function(sliceItem){return sliceItem&&sliceItem.id;});var angleItems=this.getDropZoneItems($EDZ.Angle,k);dropZones.angle=getIDFromDropZoneItems(angleItems);var isColorByAttr=this.isColorByAttribute(k);var colorByItems=this.getDropZoneItems($EDZ.ColorBy,k);if(isColorByAttr===true){dropZones.colorBy=$ARR.map(colorByItems,function(colorByItem){return colorByItem&&colorByItem.id;});dropZones.isColorByAttr=true;}else{dropZones.colorBy=getIDFromDropZoneItems(colorByItems);dropZones.isColorByAttr=false;}var sizeByItems=this.getDropZoneItems($EDZ.SizeBy,k);dropZones.sizeBy=getIDFromDropZoneItems(sizeByItems);var tooltipItems=this.getDropZoneItems($EDZ.AdditionalMetrics,k);dropZones.tooltips=getIDListFromDropZoneItems(tooltipItems);return dropZones;},getColorByDzRawData:function getColorByDzRawData(k){var dz=this.getDz(k);return dz&&dz.ColorBy&&dz.ColorBy.TemplateUnit;},getBaseMapType:function getBaseMapType(){var props=this.getProperties();return props&&props[$EnumPropertyType.baseMapType];},replaceSpace:function replaceSpace(str,replaceStr){var replace=replaceStr;if(replace===undefined){replace="_";}return str.replace(/ /g,replace);},getVisName:function getVisName(data){var visObj=data.vis,visName=data.visName||(visObj&&visObj.vn);if(!visName&&visObj&&visObj.we&&visObj.wcn){visName=WIDGET_CLASS_NAMME_VIZ_STYLE_MAP[visObj.wcn];}return visName||$EnumVizStyles.ESRI_MAP;},getLayerZoneControl:function getLayerZoneControl(source){return new $GMAPS.MapLayerZone({items:this.getGraphicLayerNameArr(),selectedItemIdx:this.getEditingLayerIdx(),source:source,vis:this});},wrapUpdatesInfo:function wrapUpdatesInfo(srcInfo,destInfo){destInfo=destInfo||{};if(!!srcInfo){destInfo.actions=(destInfo.actions)?destInfo.actions.concat(srcInfo.actions):srcInfo.actions;destInfo.urInfo=this.wrapUndoRedoInfo(srcInfo.urInfo,destInfo.urInfo);destInfo.treesToRender=srcInfo.treesToRender;destInfo.requestCallback=$FUNC.wrapMethods(srcInfo.requestCallback,destInfo.requestCallback);}return destInfo;},wrapUndoRedoInfo:function wrapUndoRedoInfo(src,dest){dest=dest||{};if(!!src){var callback=dest.callback;delete dest.callback;dest=$FUNC.wrapMethods(src,dest);dest.callback=$FUNC.wrapMethods(src.callback,callback);}return dest;},submitMapUpdates:function submitMapUpdates(updatesInfo,suppressData){if(!updatesInfo){return ;}var docModel=this.getDocModel(),actions=updatesInfo.actions||[],dataService=docModel&&docModel.getDataService(),urInfo=updatesInfo.urInfo,extra={style:{params:{treesToRender:($UTIL.checkDefined(updatesInfo.treesToRender))?updatesInfo.treesToRender:2}}},cmdMgr;actions=actions.concat(this.getUpdateLayersFormatActions());if(!dataService||!docModel||!docModel.controller||actions.length===0){return ;}if(suppressData){extra.style=mstrmojo.DocDataService.SUPPRESS_DATA;}cmdMgr=docModel.controller.cmdMgr;if(cmdMgr){cmdMgr.execute({execute:function(){var update=dataService.newUpdate();update.add(actions,updatesInfo.requestCallback,extra);if(suppressData){this.submitSilent(update.actions);}else{this.submitUpdate(update);}},urInfo:urInfo});}},getUpdateLayersFormatActions:function getUpdateLayersFormatActions(){var vp,actions=[],me=this,hostKey=this.k,layerKeys=[];$HASH.copy(this.layerIdxMappingArr,layerKeys);if(layerKeys.indexOf(hostKey)<0){layerKeys.unshift(hostKey);}if($UTIL.isExpress()){vp=me.getProperties(hostKey);delete vp.sgProps;delete vp[DIRTY_VP];if(layerKeys.length>1){vp.sgProps=this.updateSgPropsUsingLayerProps(layerKeys,hostKey);}delete me.modelData;actions=me.getSetPropertiesAction();}else{$ARR.forEach(layerKeys,function(key){vp=me.getProperties(key);if(vp[DIRTY_VP]){delete vp[DIRTY_VP];if(key===hostKey){delete me.modelData;}else{me.modelData=me.getGridData(key);}actions=actions.concat(me.getSetPropertiesAction());}});delete me.modelData;}return actions;},syncPropsForSdpXtab:function syncPropsForSdpXtab(xtab){var defn=this.defn;if(!xtab||!defn){console.log("syncPropsForSdpXtab: invalid xtab/defn");return ;}xtab.defn={t:defn.t,tt:defn.tt};xtab.parent=this.parent;},resetEditingLayerIdx:function resetEditingLayerIdx(toRemoveIdx){var editingLayerIdx=parseInt(this.getEditingLayerIdx()),layerIdxMappingArr=this.layerIdxMappingArr,newIdx;if(!layerIdxMappingArr||isNaN(editingLayerIdx)||!$ARR.isArray(layerIdxMappingArr)||layerIdxMappingArr.length<1){return ;}if(editingLayerIdx>toRemoveIdx){newIdx=editingLayerIdx-1;}else{if(editingLayerIdx===toRemoveIdx&&(layerIdxMappingArr[toRemoveIdx]===undefined)){newIdx=layerIdxMappingArr.length-1;}}if(!isNaN(newIdx)&&newIdx!==editingLayerIdx){this.updateEditingLayerIdx(newIdx);}},syncLayerProperties:function syncLayerProperties(srcVp,destVp){var properties=[$EnumPropertyType.graphicType,$EnumPropertyType.markerType,$EnumPropertyType.layerIdx,$EnumPropertyType.layerName];if(!srcVp||!destVp){return ;}properties.forEach(function(prop){if(srcVp[prop]!==undefined&&destVp[prop]!==srcVp[prop]){destVp[prop]=srcVp[prop];destVp[DIRTY_VP]=true;}});},isCurrentVizBoxSelected:function isCurrentVizBoxSelected(){var docModel=this.getDocModel(),vizUnit,viz;if(docModel&&typeof docModel.getSelectedViUnit==="function"){vizUnit=docModel.getSelectedViUnit();viz=vizUnit&&vizUnit.boxContent;return viz===this;}},refreshDzPropPanels:function refreshDzPropPanels(){var parent=this.parent;if(parent&&(typeof parent.selectVIUnit==="function")&&this.isCurrentVizBoxSelected()){parent.selectVIUnit(true);}},isPrimaryKey:function isPrimaryKey(key){return key===this.k;},displayError:function displayError(message){var mapViewer=this.mapViewer,msg=this.errorMsg||message;if(this.errorMsgDiv&&msg){if(mapViewer){mapViewer.hideAllGraphicLayers();}this.errorMsgDiv.innerHTML=this.errorMsg=msg;this.errorMsgDiv.style.display="block";}},clearMapError:function clearMapError(){if(this.errorMsgDiv){this.errorMsgDiv.innerHTML="";this.errorMsg=null;this.errorMsgDiv.style.display="none";}},reset:function reset(){this.submitMapUpdates(this.getResetMapUpdatesInfo(),false);},preRefresh:function preRefresh(){var mapViewer=this.mapViewer;if(mapViewer){this.reuseDOM=$DOM.isAndroid&&!!mapViewer.preRefresh();}},postViewerInit:mstrmojo.emptyFn,redraw:function redraw(){if(this.reuseDOM){return true;}return this._super();},stageMapNodes:function(){var tempNode=this.tempMapDiv,mapViewer=this.mapViewer,toastNode=mapViewer&&mapViewer.getToastNode();if($DOM.isIE&&tempNode){$ARR.forEach([this.toolBarDiv,this.mapDiv,this.legendPlaceholder,toastNode],function(node){if(node){tempNode.appendChild(node);}});}},refresh:function(){if(this.hasRendered){this.isRefresh=true;this.stageMapNodes();}this.preRefresh();this._super();if(this.reuseDOM){this.updateMap();this.reuseDOM=false;}},reRender:function reRender(){if(this.hasRendered){this.isRefresh=true;this.stageMapNodes();}this._super();},createDefaultVp:function createDefaultVp(vp){var props=vp||{};props[$EnumPropertyType.graphicType]=$EnumGraphicType.Marker;props[$EnumPropertyType.markerType]=$EnumMarkerType.Pin;props[$EnumPropertyType.layerIdx]=this.generateNewLayerIdx();props[$EnumPropertyType.layerName]=this.generateNewLayerName();props[$EnumPropertyType.isHidden]="0";props[$Legend_Property.LEGEND_MODE]=ENUM_LEGEND_MODE.RESTORED;props[$Legend_Property.LEGEND_POSITION]=PRP_LEGEND_SLOT.RIGHT_MIDDLE;props[$Maps_Properties.SHOW_LEGEND]=false;props[$EnumPropertyType.collapseLegend]=ENUM_SINGLE_LEGEND_MODE.RESTORE;props[$EnumPropertyType.legendSwitch]=false;props[$EnumPropertyType.clusterRadius]=50;props[$EnumPropertyType.clusterMaxZoom]=22;return props;},generateNewLayerIdx:function generateNewLayerIdx(){var layerIdxMappingArr=this.layerIdxMappingArr;return(layerIdxMappingArr&&$ARR.isArray(layerIdxMappingArr))?layerIdxMappingArr.length:0;},generateNewLayerName:function generateNewLayerName(){return mstrmojo.desc(14750,"Layer")+" "+(this.layerCount+1);},updateSgPropsUsingLayerProps:function updateSgPropsUsingLayerProps(layerKeys,hostKey){var layerVp,me=this,sgProps={};$ARR.forEach(layerKeys,function(key){if(key!==hostKey){layerVp=me.getProperties(key);if($HASH.isEmpty(layerVp)){return ;}delete layerVp[DIRTY_VP];sgProps[key]=layerVp;}});return sgProps;},createLayersPropsXml:function createLayersPropsXml(sgProps){var layerVp,key,k,gridXml="<sgProps>";for(key in sgProps){layerVp=sgProps[key];if($HASH.isEmpty(layerVp)){return ;}delete layerVp[DIRTY_VP];gridXml+='<g k="'+key+'">';for(k in layerVp){gridXml+="<"+k+' value="'+layerVp[k]+'" />';}gridXml+="</g>";}gridXml+="</sgProps>";return gridXml;},createWidgetPropsXML:function createWidgetPropsXML(){var k,vp,widgetPropsXml,val;if($UTIL.isExpress()){widgetPropsXml="<widgetProps><fmt>";vp=this.getProperties(this.k);for(k in vp){if(k==="sgProps"&&vp[k]){val=this.createLayersPropsXml(vp[k]);}else{val=vp[k];}widgetPropsXml+="<"+k+' value="'+$UTIL.encode($UTIL.encode(val))+'" />';}widgetPropsXml+="</fmt></widgetProps>";}return widgetPropsXml;},initLayerIdxMappingArr:function initLayerIdxMappingArr(){var layerIdxMappingArr=this.layerIdxMappingArr=[],node=this.node,data=this.getData(),key=(node&&node.k)?node.k:data.k,vp=data&&data.vp,layerIdxPropName=$EnumPropertyType.layerIdx,layerIdx;if(!vp){return ;}if(!key){key=data.k="unique_map_key";}layerIdx=vp[layerIdxPropName];if(!isNaN(layerIdx)&&vp[$EnumPropertyType.isRemoved]!=="1"){layerIdxMappingArr[layerIdx]=key;}this.forEachSecondaryProvider(function(layerData,key){vp=layerData&&layerData.vp;layerIdx=vp&&vp[layerIdxPropName];if(!isNaN(layerIdx)){layerIdxMappingArr[layerIdx]=key;}});this.layerCount=layerIdxMappingArr.length;},getNodeKeys:function getNodeKeys(){return this.layerIdxMappingArr;},initBaseMapProps:function initBaseMapProps(){var data=this.getData(),vp=data&&data.vp;if(!vp){return ;}if(vp[$EnumPropertyType.baseMapType]===$EnumBaseMapType.Reserved){vp[$EnumPropertyType.baseMapType]=this.getDefaultBaseMapType();}if(!$UTIL.checkDefined(vp[$EnumPropertyType.mapStyle])){vp[$EnumPropertyType.mapStyle]=this.getDefaultMapStyle(vp[$EnumPropertyType.baseMapType]);}},oldDataAdaptor:function oldDataAdaptor(){var data=this.getData(),vp=data&&data.vp,newlyCreatedMap=false,me=this,layerCount=0;if(!data){return ;}if(!vp||$HASH.keyarray(vp).length<=0){newlyCreatedMap=true;}vp=data.vp=this.vpAdapter(vp,layerCount,data.visName);if(!$UTIL.checkDefined(vp[$EnumPropertyType.baseMapType])){vp[$EnumPropertyType.baseMapType]=newlyCreatedMap?$EnumBaseMapType.Reserved:this._initBaseMapType(this.getVisName(data));}if(!$UTIL.checkDefined(vp[$EnumPropertyType.editingLayerIdx])){vp[$EnumPropertyType.editingLayerIdx]=0;}if(vp[$EnumPropertyType.isRemoved]!=="1"){layerCount++;}this.forEachSecondaryProvider(function(layerData){if(!layerData){return ;}layerData.vp=me.vpAdapter(layerData.vp,layerCount);layerCount++;});},vpAdapter:function vpAdapter(vp,layerCount,visName){var oldMapping=this.oldVpNameMappings,mapping=this.vpNameMappings,graphicType=$EnumPropertyType.graphicType,markerType=$EnumPropertyType.markerType,prop;if(!vp){return this.createDefaultVp(vp);}if($UTIL.checkDefined(vp[graphicType])){this._markerTypeAdaptor4RWDFromNewMap(vp);return vp;}for(prop in oldMapping){if(vp[oldMapping[prop]]){vp[mapping[prop]]=vp[oldMapping[prop]];delete vp[oldMapping[prop]];}}vp[graphicType]=vp[markerType];if(vp.sa==="1"&&vp.sm!=="1"){vp[graphicType]=$EnumGraphicType.Area;}this._markerTypeAdapter(vp,visName);if(vp[graphicType]===$EnumGraphicType.Bubble&&vp[$EnumPropertyType.clusterMode]===$EnumClusterMode.PIE){vp[$EnumPropertyType.clusterMode]=$EnumClusterMode.ON;}if(!$UTIL.checkDefined(vp[$EnumPropertyType.layerIdx])){vp[$EnumPropertyType.layerIdx]=layerCount;}if(!$UTIL.checkDefined(vp[$EnumPropertyType.layerName])){vp[$EnumPropertyType.layerName]=mstrmojo.desc(14750,"Layer")+" "+(layerCount+1);}if(!$UTIL.checkDefined(vp[$EnumPropertyType.isHidden])){vp[$EnumPropertyType.isHidden]="0";}return vp;},_markerTypeAdapter:function _markerTypeAdapter(vp,visName){if(!vp){return ;}if(vp[$EnumPropertyType.graphicType]===$EnumGraphicType.Marker){var img=vp[$EnumPropertyType.imageUrl];if(img){vp[$EnumPropertyType.markerType]=$EnumMarkerType.Image;}else{if(img===""&&vp[$EnumPropertyType.markerType]===$EnumMarkerType.Pin){vp[$EnumPropertyType.markerType]=$EnumMarkerType.Diamond;}else{vp[$EnumPropertyType.markerType]=(visName===$EnumVizStyles.ESRI_MAP&&vp[$EnumPropertyType.markerType]===$EnumMarkerType.Pin)?$EnumMarkerType.Diamond:$EnumMarkerType.Pin;delete vp[$EnumPropertyType.imageUrl];}}}else{delete vp[$EnumPropertyType.markerType];}},_markerTypeAdaptor4RWDFromNewMap:function _markerTypeAdaptor4RWDFromNewMap(vp){if(vp[$EnumPropertyType.graphicType]===$EnumGraphicType.Marker){var img=vp[$EnumPropertyType.imageUrl];if(img===""&&vp[$EnumPropertyType.markerType]===$EnumMarkerType.Pin){vp[$EnumPropertyType.markerType]=$EnumMarkerType.Diamond;}}},_initBaseMapType:function _initBaseMapType(visName){var mapType;switch(visName){case $EnumVizStyles.ESRI_MAP:mapType=$EnumBaseMapType.Esri;break;case $EnumVizStyles.GOOGLE_MAP:mapType=$EnumBaseMapType.Google;break;case $EnumVizStyles.MAPBOX:mapType=$EnumBaseMapType.Mapbox;break;default:mapType=$EnumBaseMapType.Esri;break;}return mapType;},getDefaultBaseMapType:function getDefaultBaseMapType(){var isESRIKeyValid=this.isESRIKeyValid(),hasGooglePlugin=this.hasGooglePlugin();if(!isESRIKeyValid&&hasGooglePlugin){return $EnumBaseMapType.Google;}return $EnumBaseMapType.Esri;},getGraphicLayerNameArr:function getGraphicLayerNameArr(){var data=this.getData(),layerIdxMappingArr=this.layerIdxMappingArr,nameArr=[],propLayerName=$EnumPropertyType.layerName,props=$EnumPropertyType.layerIdx,layerKey,layerName;if(!data||!layerIdxMappingArr){return ;}for(var i=0,il=layerIdxMappingArr.length;i<il;i++){layerKey=layerIdxMappingArr[i];props=this.getProperties(layerKey);if(!!props){layerName=props[propLayerName];nameArr[i]={n:layerName,k:layerKey};}}return nameArr;},isGraphicLayerGrid:function isGraphicLayerGrid(gridData){var props=gridData&&gridData.vp;if(!props){return false;}return props[$EnumPropertyType.isRemoved]!=="1";},loadMapCss:function loadMapCss(){if(!CSS_LOADED){mstrmojo.insertCSSLinks([$MOJO.getJsRoot()+"mojo/css/vi-map.css"]);mstrmojo.insertCSSLinks([$MOJO.getStyleRoot()+"/mstr/googleMap.css"]);CSS_LOADED=true;}},getMapConfig:function getMapConfig(){return MAP_CONFIG;},hasGooglePlugin:function hasGooglePlugin(){var mapConfig=this.getMapConfig(),googleConfig=mapConfig&&mapConfig.google;return !!googleConfig&&!!(googleConfig.clientId||googleConfig.trialKey);},isESRIKeyValid:function isESRIKeyValid(){var mapConfig=this.getMapConfig(),esriConfig=mapConfig&&mapConfig.esri,error=esriConfig&&esriConfig.err;return !(error&&error.length>0);},postExportHook:function(){var svgNodes,node,i,il;if($DOM.isIE9||$DOM.isIE10||$DOM.isIEW3C){this.reviveImages();this.reviveStyles(this.getRootDivForPDF());}else{$CSS.toggleClass(this.mapDiv,"clientExportAdjust",false);svgNodes=this.getRootDivForPDF().getElementsByTagName("svg");for(i=0,il=svgNodes.length;i<il;i++){node=svgNodes[i];node.removeAttribute("xmlns");node.removeAttribute("xmlns:xlink");if($DOM.isChrome){node.parentNode.style.transform=0;}}}},hideMapTools:function(){var baseLayer=this.mapViewer&&this.mapViewer.baseLayer;baseLayer.hideMapTools();},showMapTools:function(){var baseLayer=this.mapViewer&&this.mapViewer.baseLayer;baseLayer.showMapTools();},oncontextmenu:function oncontextmenu(evt){var e=evt&&evt.e;if(e!==null){$DOM.stopPropogation(e.hWin,e);$DOM.preventDefault(e.hWin,e);return false;}},isTitleBarVisible:function isTitleBarVisible(){var titleBar=this.parent&&this.parent.titleBar;return !!titleBar&&titleBar.visible;},destroyAllSdp:function destroyAllSdp(){var docModel=this.getDocModel(),sdpKeyArr=$ARR.ensureArray(this.getSdpKeyArr()),key,i,il;if(!sdpKeyArr){return ;}for(i=0,il=sdpKeyArr.length;i<il;i++){key=sdpKeyArr[i];if(!$UTIL.checkDefined(key)){continue;}this.destroySdpXtab(key);}this.widgetIdMapping=null;if(docModel&&this.sliceEvtListener){docModel.detachEventListener(this.sliceEvtListener);this.sliceEvtListener=null;}this.unRegisterSdpInDocModel($HASH.keyarray(this.registeredSDPKeys));},destroySdpXtab:function destroySdpXtab(key){var xtab=this.fnGetWidget(key);if(xtab){xtab.destroy();$ARR.forEach(xtab.methodArr,function(methodName){delete xtab[methodName];});}},destroyComponents:function destroyComponents(skipBaseMap){var mapViewer=this.mapViewer,docModel=this.getDocModel();this.destroyLegendCon();if($UTIL.checkHasFunction(mapViewer,"destroy")){mapViewer.destroy(undefined,skipBaseMap);}delete this.mapViewer;delete this.isRefresh;delete this.errorMsg;if(docModel&&this.docSaveListener){docModel.detachEventListener(this.docSaveListener);this.docSaveListener=null;}this.destroyAllSdp();},destroy:function destroy(ignoreDom){this.destroyComponents();this._super(ignoreDom);},unrender:function unrender(ignoreDom){if($UTIL.isOIVM()){this.clearCache();}var lastOpened=this._lastOpened;if(lastOpened){this.closePopup();}this._super(ignoreDom);if(!$UTIL.isOIVM()){this.updated=false;this.visPropsUpdated=false;this.isRefresh=false;}},updateColorPaletteChange:function updateColorPaletteChange(){var mapViewer=this.mapViewer,editingLayer=this.getGraphicLayer();mapViewer.forEachGraphicLayer(function(layer){if(layer.isColorByAttr){layer.updateLayerColorByColor();}},false,true,undefined);if(editingLayer.isColorByAttr){this.raiseEvent({name:"colorByColorChange",type:"invalidateCache"});this.raiseEvent({name:"colorByColorChange",type:"colorFullUpdate"});}},setModel:function setModel(model){this._super(model);this.listenToUpdateColorMap(this.updateColorPaletteChange);}});function getUnitsById(did,data){var gsi=data.gsi||{},r=[];if(did){$ARR.forEach((gsi.rows||[]).concat(gsi.cols||[]),function(item){if(item.did===did){r=[{id:did,t:item.t}];return false;}});if(!r.length){$ARR.forEach(gsi.mx||[],function(m){if(m.did===did){r=[{id:did,t:4}];return false;}});}}return r;}function getIDFromDropZoneItems(items){if(!!items&&items.length>0){return items[0].id;}return null;}function getIDListFromDropZoneItems(items){if(!!items&&items.length>0){var itemCount=items.length,item,result=[],index;for(index=0;index<itemCount;index++){item=items[index];result.push(item.id);}return result;}return null;}}());