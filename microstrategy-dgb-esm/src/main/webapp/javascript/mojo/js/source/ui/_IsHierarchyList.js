(function(){mstrmojo.requiresClsP("mstrmojo","hash","css","array","desc");var $HASH=mstrmojo.hash,$FUNC=mstrmojo.func,$CSS=mstrmojo.css,$ARR=mstrmojo.array;var DEFAULT_ITEM={lv:-1,hcd:false,epd:false,hid:false,dhid:false,children:[],displayChildren:[],parent:null,displayParent:null},EMPTY_HIERARCHY_LIST={rootItems:{},items:[],itemMap:{}};var CSS_HIDDEN="hidden",CSS_EXPANDED="expanded",CSS_COLLAPSED="collapsed",CSS_HIERARCHY="hierarchy",CSS_HAS_CHILDREN="hasChildren",ELEM_ALL_ID="u;",LEVEL_INDENT=10,ELEMENT_TYPE_CONSOLIDATION=7,GDDE_FLAG_USE_OPT=32;mstrmojo.ui._IsHierarchyList=mstrmojo.provide("mstrmojo.ui._IsHierarchyList",{_mixinName:"mstrmojo.ui._IsHierarchyList",itemValueField:"v",init:function init(props){this._super(props);this.clearItems();},getItemProps:function getItemProps(item,idx){var props=this._super(item,idx),levelIndent=0;if(item.hcd){props.addCls(CSS_HAS_CHILDREN);}if(item.v===ELEM_ALL_ID){props.addCls(CSS_HIDDEN);}if(this.isHiearachyDisplay()){props.addCls(CSS_HIERARCHY);if(item.hid){props.addCls(CSS_HIDDEN);}levelIndent=item.lv>=0?item.lv*LEVEL_INDENT:0;}props.indent=levelIndent;return props;},_getItemNode:function _getItemNode(idx){var itemsNode=this.itemsContainerNode;return $ARR.filterOne(itemsNode&&itemsNode.childNodes,function(node){return parseInt(node.getAttribute("idx"),10)===idx;});},_buildItemsMarkup:function _buildItemsMarkup(start,end,markupPrefix,markupSuffix,itemPrefix,itemSuffix){var mu;if(this.isHiearachyDisplay()){mu=this._buildDescendantsMarkup();}else{mu=this._super(start,end,markupPrefix,markupSuffix,itemPrefix,itemSuffix);}return mu;},_buildDescendantsMarkup:function _buildDescendantsMarkup(rootItem,includeRoot){var markup=[],fnItemRender=this.itemRenderer&&this.itemRenderer.render,roots=rootItem?(includeRoot?[rootItem]:rootItem.displayChildren):(this.raad?this.getDisplayRoots():this.getRootItems()),bc=this.blockCount,buildMarkup=function(root){if(!root.hid&&!root.dhid){markup.push(fnItemRender(root,root.idx,this));}if(root.epd||root.hid){$ARR.forEach(root.displayChildren,function(root,idx){return renderItemWithIncFunc.call(this,root,idx);},this);}},renderItemWithIncFunc=function(item,idx){if(this.raad&&idx>=bc){var renderer=this.createRenderer(item.lv,item.displayParent,item.parent,this.items.length,idx);this.items.push(renderer);if(renderer.displayParent){renderer.displayParent.displayChildren.push(renderer);}if(renderer.parent){renderer.parent.children.push(renderer);}buildMarkup.call(this,renderer);return false;}else{buildMarkup.call(this,item);}};if(fnItemRender&&typeof fnItemRender==="function"){if(this.raad&&!rootItem){if(roots.length>bc){var toRenderItems=roots.slice(0,bc),renderer=this.createRenderer(roots[bc-1].lv,null,null,this.items.length,bc);this.items.push(renderer);roots.push(renderer);toRenderItems.push(renderer);markup=this._buildSiblingsMarkup(toRenderItems);}else{markup=this._buildSiblingsMarkup(roots);}}else{$ARR.forEach(roots,function(root,idx){return renderItemWithIncFunc.call(this,root,idx);},this);}}return markup;},getItems:function getItems(){return this.items;},getItemByValue:function getItemByValue(value){return this.itemMap[value];},isRootItem:function(item){return item.lv>=0&&item.v!==ELEM_ALL_ID&&!item.pid&&!item.parent;},getRootItems:function getRootItems(){return $HASH.valarray(this.rootItems);},getDisplayRoots:function getDisplayRoots(){if(!this.displayRoots){var dRoots=this.displayRoots=[],roots=this.getRootItems(),getDisplayDescendants=function(items){$ARR.forEach(items,function(item){if(!item.hid){dRoots.push(item);}if(item.epd||item.hid){getDisplayDescendants(item.displayChildren);}});};getDisplayDescendants(roots);}if(!this.initialDisplayRoots){this.initialDisplayRoots=dRoots.slice();}return this.displayRoots;},getInitialDisplayRoots:function getInitialDisplayRoots(){if(!this.initialDisplayRoots){this.initialDisplayRoots=(this.getDisplayRoots()||[]).slice();}return this.initialDisplayRoots;},createRenderer:function createRenderer(lv,displayParent,parent,idx,nextSiblingIdx){return{n:mstrmojo.desc(1005,"More..."),lv:lv,displayParent:displayParent,parent:parent,idx:idx,fetcher:true,fake:true,config:{nextSiblingIdx:nextSiblingIdx}};},getItemAncestorMap:function getItemAncestorMap(item){var itemValueField=this.itemValueField,ancestorMap={};while(item&&item[itemValueField]){ancestorMap[item[itemValueField]]=true;item=item.parent;}return ancestorMap;},getItemDescendantMap:function getItemDescendantMap(item){var itemValueField=this.itemValueField,descendantMap={},walkDescendants=function(item){descendantMap[item[itemValueField]]=true;$ARR.forEach(item.children,function(child){walkDescendants(child);});};walkDescendants(item);return descendantMap;},clearItems:function clearItems(){var itemsContainerNode=this.itemsContainerNode;$HASH.copy($HASH.clone(EMPTY_HIERARCHY_LIST),this);if(itemsContainerNode){itemsContainerNode.innerText="";this.updateScrollbars();}},addItems:function addItems(newItems,silent){var items=this.items,itemMap=this.itemMap,rootItems=this.rootItems,itemValueField=this.itemValueField,addedItems=[];$ARR.forEach(newItems,function(newItem){var itemValue=newItem[itemValueField],curItem=this.getItemByValue(itemValue),item=$HASH.copy(newItem,(curItem?curItem:$HASH.clone(DEFAULT_ITEM)));if(!curItem){item.idx=items.length;items.push(item);if(itemValue){itemMap[itemValue]=item;}}if(this.isRootItem(item)){rootItems[itemValue]=item;}addedItems.push(item);},this);$ARR.forEach(addedItems,function(item){var parentItem=this.getItemByValue(item.pid),displayParentItem=this.getItemByValue(item.dpid)||parentItem;if(parentItem){if(!item.parent){item.parent=parentItem;parentItem.children.push(item);}if(!item.hid&&!item.dhid&&!item.displayParent){displayParentItem.hcd=true;item.displayParent=displayParentItem;displayParentItem.displayChildren.push(item);}}delete item.pid;delete item.dpid;},this);if(!silent){if(this.postAddItems){this.postAddItems(addedItems);}var itemsContainerNode=this.itemsContainerNode;if(itemsContainerNode){if(this.isHiearachyDisplay()){this.refresh();}else{itemsContainerNode.innerHTML+=this._buildSiblingsMarkup(this.getFlatDisplayItems(addedItems)).join("");this.updateScrollbars();}}}return addedItems;},addSiblingItems:function addSiblingItems(newItems,parentId){var parentItem=this.getItemByValue(parentId),addedItems;if(parentItem){$ARR.forEach(newItems,function(item){if(item.v!==parentId){item.pid=item.pid||parentId;}});}addedItems=this.addItems(newItems,true);if(this.postAddSiblingItems){this.postAddSiblingItems(addedItems,parentItem);}var itemsContainerNode=this.itemsContainerNode;if(itemsContainerNode&&this.isHiearachyDisplay()){var itemsMarkup=this._buildSiblingsMarkup(addedItems).join("");if(!parentId){itemsContainerNode.innerHTML+=itemsMarkup;}else{if(parentItem){var parentsMap={},itemNode=this._getItemNode(parentItem.idx),nextItem;if(itemNode){parentsMap[parentItem.v]=true;while(itemNode.nextSibling){nextItem=this.getItemFromTarget(itemNode.nextSibling);if(nextItem&&nextItem.displayParent&&parentsMap[nextItem.displayParent.v]){parentsMap[nextItem.v]=true;itemNode=itemNode.nextSibling;}else{break;}}itemNode.outerHTML+=itemsMarkup;}}}this.updateScrollbars();}return addedItems;},addBranchItems:function addBranchItems(newItems,branchId){var branchItem=this.getItemByValue(branchId),addedItems;if(branchItem){$ARR.forEach(newItems,function(item){item.pid=item.pid||branchId;});}addedItems=this.addItems(newItems,true);if(this.postAddBranchItems){this.postAddBranchItems(addedItems,branchItem);}var itemsContainerNode=this.itemsContainerNode;if(itemsContainerNode&&this.isHiearachyDisplay()){if(!branchId){$ARR.forEach(addedItems,function(item){if(this.isRootItem(item)){itemsContainerNode.innerHTML+=this._buildDescendantsMarkup(item,true).join("");}},this);}else{if(branchItem){var itemNode=this._getItemNode(branchItem.idx);if(itemNode){itemNode.outerHTML+=this._buildDescendantsMarkup(branchItem).join("");}}}this.updateScrollbars();}return addedItems;},updateItems:function updateItems(items,itemRelations){if(itemRelations){$ARR.forEach(items,function(item,idx,items){var relation=itemRelations[idx],parentItem=items[relation.p_index];if(parentItem){item.pid=parentItem.v;}});}this.handleOriginalParent(items,itemRelations);this.setDisplayParent(items,itemRelations);this.clearItems();this.addItems(items,true);},handleOriginalParent:function handleOriginalParent(items,itemRelations){if(itemRelations){$ARR.forEach(items,function(item,idx,items){var relation=itemRelations[idx],parentItem=items[relation.p_index],originalParentItem=items[relation.original_p_index];if(parentItem&&parentItem.t===ELEMENT_TYPE_CONSOLIDATION&&item.lv!==parentItem.lv&&originalParentItem&&originalParentItem.pid===parentItem.v){item.pid=originalParentItem.v;}});}},setDisplayParent:function setDisplayParent(items,itemRelations,usePid){if(usePid){this.idMap=this.idMap||{};$ARR.forEach(items,function(item){this.idMap[item.v]=item;},this);}var me=this,getParentItem=function(item,idx){var parentItem;if(!usePid&&itemRelations){var parentIdx=itemRelations[idx].p_index;parentItem=items[parentIdx];}else{if(usePid){parentItem=me.idMap[item.pid];}}return parentItem;};$ARR.forEach(items,function findAndSetDisplayParent(item,idx,items){var parentItem=getParentItem(item,idx);if(!parentItem||me.isRootItem(item)){return item.v;}if(!item.dpid){item.dpid=parentItem.hid?findAndSetDisplayParent(parentItem,itemRelations&&itemRelations[idx]&&itemRelations[idx].p_index,items):parentItem.v;}return item.dpid;});},fetchItems:function fetchItems(params,callback){if(this.raad&&this.isHiearachyDisplay()&&(this.items||[]).length>0){return ;}params=params||{};var me=this,branch=params.branch,isInit=params.browseFlags&GDDE_FLAG_USE_OPT,level=parseInt(params.level,10),hasLevel=level>=0;this.fetchItemsThroughTaskCall(params,$FUNC.wrapMethods(callback,{success:function(res){if(me.raad===undefined&&res&&me.isHiearachyDisplay()){me.raad=res.raad;}if(res&&res.es){var es=res.es;if(level===(branch&&branch.lv+1||0)||(isInit&&!me.raad)){me.addSiblingItems(es,branch&&branch.v);}else{if(branch&&!hasLevel){me.addBranchItems(es,branch.v);}else{me.addItems(es);}}}}}));},updateItemNodesStatus:function updateItemNodesStatus(){var itemNodes=this.itemsContainerNode&&this.itemsContainerNode.childNodes;$ARR.forEach(itemNodes,function(itemNode){var item=this.getItemFromTarget(itemNode);if(item){$CSS.toggleClass(itemNode,CSS_SELECTED,item.isSelected);}},this);},_buildSiblingsMarkup:function _buildSiblingsMarkup(siblingItems){var markup=[],fnItemRender=this.itemRenderer&&this.itemRenderer.render;if(fnItemRender&&typeof fnItemRender==="function"){$ARR.forEach(siblingItems,function(item){markup.push(fnItemRender(item,item.idx,this));},this);}return markup;},toggleCollapseExpandCss:function toggleCollapseExpandCss(itemNode,isExpanding){$CSS.toggleClass(itemNode,CSS_COLLAPSED,!isExpanding);$CSS.toggleClass(itemNode,CSS_EXPANDED,isExpanding);},doExpandCollapse:function doExpandCollapse(itemNode,item){var isExpanding=!item.epd;item.epd=isExpanding;this.toggleCollapseExpandCss(itemNode,isExpanding);if(!this.isHiearachyDisplay()){return ;}var descendantMap=this.getItemDescendantMap(item),descItemNode,descItem;if(isExpanding){var child=item.displayChildren&&item.displayChildren[0];if(child){var sibItem=this.getItemFromTarget(itemNode.nextSibling);if(sibItem&&sibItem.displayParent===item){var hiddenParentsMap={},descDisplayParent;descItemNode=itemNode.nextSibling;while(descItemNode){descItem=this.getItemFromTarget(descItemNode);descDisplayParent=descItem&&descItem.displayParent;if(!descDisplayParent||!descendantMap[descItem.v]){break;}if(hiddenParentsMap[descDisplayParent.v]){$CSS.addClass(descItemNode,CSS_HIDDEN);hiddenParentsMap[descItem.v]=true;}else{$CSS.removeClass(descItemNode,CSS_HIDDEN);if(!descItem.epd){hiddenParentsMap[descItem.v]=true;}}descItemNode=descItemNode.nextSibling;}}else{itemNode.outerHTML+=this._buildDescendantsMarkup(item).join("");}}else{this.fetchItems({branch:item,level:item.lv+1});}}else{descItemNode=itemNode.nextSibling;while(descItemNode){descItem=this.getItemFromTarget(descItemNode);if(!descItem||!descendantMap[descItem.v]){break;}$CSS.addClass(descItemNode,CSS_HIDDEN);descItemNode=descItemNode.nextSibling;}}this.updateScrollbars();},isHiearachyDisplay:function isHiearachyDisplay(){return true;},fetchItemsThroughTaskCall:mstrmojo.emptyFn,getFlatDisplayItems:mstrmojo.emptyFn});}());