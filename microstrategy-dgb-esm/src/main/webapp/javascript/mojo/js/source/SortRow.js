(function(){mstrmojo.requiresClsP("mstrmojo","Box","Button","RadioList","Label","array");mstrmojo.requiresClsP("mstrmojo.ui","Pulldown");var $DESC=mstrmojo.desc,$CSS=mstrmojo.css,$ARR=mstrmojo.array;function popupOpen(){$CSS.addClass(this.list.domNode,"AdvancedSort-PopupList");this.parent.isActive(true);}mstrmojo.SortRow=mstrmojo.declare(mstrmojo.Box,null,{scriptClass:"mstrmojo.SortRow",markupString:'<div id="{@id}" class="mstrmojo-SortRow {@cssClass}" style="{@cssText}" mstrAttach:click><div></div><div class="mstrmojo-sort-rule-delete"></div><div style="clear:both;"></div></div>',markupSlots:{containerNode:function containerNode(){return this.domNode.firstChild;},deleteNode:function deleteNode(){return this.domNode.children[1];}},sortRule:undefined,sortOrder:undefined,rank:undefined,originalPos:null,isActive:function isActive(isOpen){this.parent&&this.parent.pulldownActive(isOpen);},onclick:function onclick(event){if(event.getTarget()===this.deleteNode){this.parent.deleteSortRule(this);}},isAscending:function isAscending(){return this.sortOrder.value===0;},isCustomSort:function isCustomSort(){return this.sortOrder&&this.sortOrder.value===2;},getSortKey:function getSortKey(){return this.sortRule.value;},setPulldownOptions:function setPulldownOptions(gridData){var sortRule=this.sortRule;sortRule.set("items",sortRule.items.concat(gridData));},resetPulldownOptions:function resetPulldownOptions(){this.sortRule.set("selectedIndex",0);this.sortRule.set("items",[{v:"",n:" ",cls:"firstItem"}]);},setSelected:function setSelected(value,isAsc,name){var idx=$ARR.find(this.sortRule.items,"v",value);if(isAsc===2){if(idx===-1){var docModel=mstrApp.rootCtrl.docCtrl.model,nameInModel=docModel.findUnitInDataSet&&(docModel.findUnitInDataSet((value||"").split("!")[1])||{}).n;this.sortRule.set("items",this.sortRule.items.concat([{v:value,n:nameInModel}]));idx=this.sortRule.items.length-1;}this.sortRule.set("selectedIndex",idx);this.sortRule.set("enabled",false);var orderIdx=$ARR.find(this.sortOrder.items,"v",2);if(orderIdx===-1){this.sortOrder.set("items",this.sortOrder.items.concat({n:$DESC(5705,"Custom Sort"),v:2}));orderIdx=this.sortOrder.items.length-1;}this.sortOrder.set("selectedIndex",orderIdx);this.sortOrder.set("enabled",false);}else{if(idx===-1){if(!name){this.sortRule.set("selectedIndex",0);this.sortOrder.set("selectedIndex",0);return ;}else{this.sortRule.set("items",this.sortRule.items.concat([{v:value,n:name}]));idx=$ARR.find(this.sortRule.items,"v",value);}}this.sortRule.set("selectedIndex",idx);var orderItems=this.sortOrder.items;if(orderItems.length>2){this.sortOrder.set("items",orderItems.slice(0,2));}this.sortOrder.set("selectedIndex",(isAsc===0?1:0));}},setRank:function setRank(value){this.rank.set("number",value);},getRank:function getRank(){return this.rank.number;},children:[{scriptClass:"mstrmojo.Widget",alias:"rank",number:0,markupString:'<div class="order-column"><div class="draggable-icon"></div><div class="order">{@number}</div></div>',markupMethods:{onnumberChange:function onnumberChange(){this.domNode.children[1].innerText=this.number;this.refresh();}}},{scriptClass:"mstrmojo.ui.Pulldown",alias:"sortRule",cssClass:"mstrmojo-sort-rule-pulldown",selectedIndex:0,value:"",allowHTML:false,items:[{v:"",n:" ",cls:"firstItem"}],bindings:{enabled:"this.items && this.items.length > 1"},isHostedWithin:false,onPopupWidgetOpened:function onPopupWidgetOpened(){popupOpen.call(this);},onPopupWidgetClosed:function onPopupWidgetClosed(){this.parent.isActive(false);},onitemSelected:function onitemSelected(item){this.value=item.v;this.parent.parent.itemSelected();}},{scriptClass:"mstrmojo.ui.Pulldown",alias:"sortOrder",cssClass:"mstrmojo-sort-rule-order",value:0,selectedIndex:0,bindings:{enabled:"this.parent.sortRule.items && this.parent.sortRule.items.length > 1"},isHostedWithin:false,onPopupWidgetOpened:function onPopupWidgetOpened(){popupOpen.call(this);},onPopupWidgetClosed:function onPopupWidgetClosed(){this.parent.isActive(false);},onitemSelected:function onitemSelected(item){this.value=item.v;},items:[{n:$DESC(1885,"Ascending"),v:0},{n:$DESC(1886,"Descending"),v:1}]}]});}());