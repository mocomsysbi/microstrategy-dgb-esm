(function(){mstrmojo.requiresCls("mstrmojo.Editor","mstrmojo.Button","mstrmojo.Box","mstrmojo.dom","mstrmojo.Label","mstrmojo.Image","mstrmojo.Pulldown","mstrmojo.ui.Pulldown","mstrmojo.tooltip","mstrmojo.CheckBox","mstrmojo.TextBox","mstrmojo.SREditor","mstrmojo.DI.DIHelpers","mstrmojo.warehouse.EnumDatabaseType","mstrmojo.DI.DIModel","mstrmojo.locales","mstrmojo.date","mstrmojo.ProgressBar","mstrmojo.DI.DNTextBox","mstrmojo.AS.DIAppSchemaTableStatusList","mstrmojo.AS.DIAppSchemaRefreshFileEditor","mstrmojo.DI.DIConfirmSaveEditor","mstrmojo.css","mstrmojo.string");mstrmojo.requiresDescs(221,773,1302,4311,4364,4996,8473,10160,12761,12762,12763,12764,12765,12766,12767,12769,13005,13028,13029,2502,13257,9242,13274,13444,13882,15071,15072,15077,3464,5923,10639,10159,9705,9704,9380,15095,15096,15097,15098,15099,15100,15101,15102,15103,15104,15105,15205,15206);var $A=mstrmojo.array,$H=mstrmojo.hash,$DIHelper=mstrmojo.DI.DIHelpers,$S=mstrmojo.string,constants=mstrmojo.DI.DIConstants,EVENT_CAN_START_REFRESH="canStartRefresh",DISABLED_BUTTON_TOOLTIP=mstrmojo.desc(13882,"Please upload the data or unselect the source in order to enable this option."),$C=mstrmojo.css,dialogWidth="712px",APP_SCHEMA_MODEL_ID="DIAppSchemaModel",tablePublishedStatus={Reserved:0,Waiting:1,Publishing:2,Completed:3,Error:4,SchemaComparisonCompleted:5,SchemaComparisonError:6},cubePublishedStatus={finished:1,jobExecutionError:3,executionError:18};function getModel(model){return mstrApp.getRootController().getModel();}function refreshHandler(model,sourceArr,rootCtrl,callback,pipelineInfos){$H.forEach(model.importSources,function(source){$A.forEach(source.items,function(item){item.needUploadFile&&sourceArr.push(item);});});if(sourceArr.length>0){var postData=[],uploadedFiles=[],counter=0;$A.forEach(sourceArr,function(source,index,self){var pipelineObj,dataSource;$A.forEach((rootCtrl.model.appSchemaTables&&rootCtrl.model.appSchemaTables.pipelineInfos)||pipelineInfos,function(infoObj){var tableGroups=infoObj.tableGroups,tableGroup;$A.forEach(tableGroups,function(group){var sourceTable=group[0];if(sourceTable.id===source.id){pipelineObj=infoObj;dataSource=sourceTable.dataSource;return false;}});});var param={tableId:source.id,pipelineId:pipelineObj.id,sheetIndex:dataSource.sheetIndex,uploadingId:dataSource.fileId,workspaceId:rootCtrl.model.workspaceId,requestId:rootCtrl.model.requestId,mode:constants.operationMode.republish,showProgress:false};postData.push(param);if(source.needUploadFile){mstrmojo.AS.DIAppSchemaService.uploadFile(source.fileUploader.fileNode,param,function(uploadedFileObj){uploadedFiles.push(uploadedFileObj);postData[counter++]["uploadingId"]=uploadedFileObj.uploadingId;if(counter===sourceArr.length){postData=postData.filter(function(data){return !!data.uploadingId;});callback.call();}});}else{counter++;}});}else{callback.call();}}mstrmojo.AS.DIPublishAppSchemaEditor=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.AS.DIPublishAppSchemaEditor",cssClass:"mstrmojo-di-scheduleEMMA",title:"",allowHTMLTitle:true,simpleProgressMode:false,showTimeWarningMsg:false,height:"auto",useRichTooltip:false,operationMode:null,cubeName:"",cubeId:null,tablesInfo:null,dataService:null,publishCube:null,operationMode:null,forceFullPublish:null,closeAppSchema:null,onOpen:function(){var model=this.model=getModel(this.model);model.populateExternalSources();if(this.opened){return ;}this.opened=true;if(this.subEvt){model.detachEventListener(this.subEvt);}this.subEvt=model.attachEventListener("PublishStatusUpdate",this.id,"update");this.set("width",dialogWidth);if(this.operationMode===constants.operationMode.refresh){this.subEvt=model.attachEventListener("PublishStatusUpdate",this.id,"update");this.set("title",mstrmojo.desc(15103,"Refresh ####").replace("####",this.cubeName));if(this.publishCube){mstrmojo.css.addClass(this.domNode,"mstrmojo-di-publishAppSchema workstation");}if($DIHelper.isWS()){this.set("height","460px");}else{}this.okButton.set("visible",true);this.cancelButton.set("visible",true);this.cancelButton.set("text",mstrmojo.desc(221,"Cancel"));}if(this.operationMode===constants.operationMode.create){this.set("title",mstrmojo.desc(13028,"### Publishing Status").replace("###",$S.htmlAngles(this.cubeName)));mstrmojo.css.addClass(this.domNode,"pub-create mstrmojo-di-publishAppSchema workstation");this.model.raiseEvent({name:"PublishStatusUpdate"});}if(this.operationMode===constants.operationMode.edit){this.subEvt=model.attachEventListener("PublishStatusUpdate",this.id,"update");this.okButton.set("visible",true);this.cancelButton.set("visible",true);this.cancelButton.set("text",mstrmojo.desc(221,"Cancel"));this.set("title",mstrmojo.desc(13028,"### Publishing Status").replace("###",this.cubeName));mstrmojo.css.addClass(this.domNode,"mstrmojo-di-publishAppSchema workstation");if(this.simpleProgressMode){this.okButton.set("visible",false);this.cancelButton.set("visible",false);mstrmojo.css.addClass(this.domNode,"mstrmojo-hide-di-publishAppSchema");mstrmojo._IsWebApp.showWait({cssClass:"mstr-appschema-wait",message:mstrmojo.desc(15916,"Building the cube...")});}this.publishCube();this.model.raiseEvent({name:"PublishStatusUpdate",completed:false});}},updatePublishStatus:function(cubeStatus){if(this.statusList&&this.statusList.items){var statusListItems=this.statusList.items,shouldSetErrorStatus=false;$A.forEach(statusListItems,function(item){if(cubeStatus.tableStatus){var publishedTableIndex=$A.find(cubeStatus.tableStatus,"tableId",item.id);var publishedTable=cubeStatus.tableStatus[publishedTableIndex];if(publishedTable){item.errmsg=publishedTable.errorMessage;item.status=tablePublishedStatus[publishedTable.status];}}shouldSetErrorStatus=cubeStatus.result.allCompleted&&cubeStatus.result.hasError&&item.status===tablePublishedStatus.Reserved;if(shouldSetErrorStatus){item.status=tablePublishedStatus.Error;}});}this.model.raiseEvent({name:"PublishStatusUpdate",completed:cubeStatus.result.allCompleted,error:cubeStatus.result.hasError});if(cubeStatus.result.allCompleted&&cubeStatus.result.hasError){this.publishErrorHandler(cubeStatus);}},publishErrorHandler:function(cubeStatus){var generalMsg=mstrmojo.desc(13065,"Unable to publish the cube."),detailMsg="",errorCode=parseInt(cubeStatus.status,10),message=cubeStatus.exceptionMessage;if(message){detailMsg=$S.encodeHtmlString(message,true,true);}if(cubeStatus.status<0&&cubeStatus.tableStatus&&cubeStatus.tableStatus.length>0){message="<ul>";var statusListItems=this.statusList&&this.statusList.items;$A.forEach(cubeStatus.tableStatus,function(table){if(table.errorMessage){var tableIndex=$A.find(statusListItems,"id",table.tableId),source=statusListItems[tableIndex];if(source){message+="<li>"+source.name+"<br>"+table.errorMessage+"</li>";}}});message+="</ul>";detailMsg=message;}var publishController=new mstrmojo.DI.controller.DIPublishController(),errorMsg=publishController.getErrorMessage(errorCode,message,detailMsg,false,true,this.operationMode);detailMsg=errorMsg?errorMsg:detailMsg;mstrmojo.error({shortDesc:generalMsg,longDesc:detailMsg},undefined,{title:mstrmojo.desc(11812,"Notification"),allowHTML:true});},finishPublish:function(completed,error){this.model.raiseEvent({name:"PublishStatusUpdate",completed:completed,error:error});},onClose:function(){var model=this.model,controller,cubeId,editor=this,refreshMultipleCubesCallback;if(mstrApp&&mstrApp.getRootController!=undefined){controller=mstrApp.getRootController();}this.opened=false;if(this.subEvt){model.detachEventListener(this.subEvt);}$A.forEach(model.getAllTableID(),function(id){var source=model.getImportSource(id);source.hasSelectFile=false;source.republishError=undefined;});this.toggleEnable(true);this.statusList.updateStarted=false;this.stopPublishAnimation();if(this.model.id===APP_SCHEMA_MODEL_ID){this.model.destroy();}this.destroy();if(this.onCompleted&&this.operationMode===constants.operationMode.refresh&&controller.dialogController.pageZIndex>0){cubeId=model.cubeID;refreshMultipleCubesCallback=function(){var model,cubesInfo,cubes,idx,dataset={did:cubeId};if(mstrApp.refreshMultipleCubes){model=mstrApp.getRootController().getModel();model.publishedDatasets.push(dataset);cubesInfo=model.cubesInfo;cubes=cubesInfo&&cubesInfo.cubes&&cubesInfo.cubes.cube;idx=$A.find(cubes,"cube_id",cubeId);if(idx>=0){cubes.splice(idx,1);model.raiseEvent({name:"cubesInfoChange"});}}};}if(this.operationMode===constants.operationMode.refresh){if(this.onCompleted&&!mstrApp.fromCubesList){mstrmojo.AS.DIAppSchemaService.deleteWorkspace({workspaceId:controller.model.workspaceId},{complete:function(){refreshMultipleCubesCallback&&window.setTimeout(refreshMultipleCubesCallback,1);mstrApp.getRootController().exitApplication();}});}else{if(mstrApp.fromCubesList){refreshMultipleCubesCallback&&window.setTimeout(refreshMultipleCubesCallback,1);mstrApp.fromCubesList=false;var cubeID=mstrApp.getRootController().model.cubeID;controller.resetAppforImport();if(!mstrApp.refreshMultipleCubes){controller.getCubeQuota();}else{controller.getCubeInfo(cubeID);}}else{mstrmojo.AS.DIAppSchemaService.deleteWorkspace({workspaceId:controller.model.workspaceId},{complete:function(){refreshMultipleCubesCallback&&window.setTimeout(refreshMultipleCubesCallback,1);mstrApp.getRootController().cancelApplication();}});}}}this.toggleEnable(true);this.statusList.updateStarted=false;if(this.closeAppSchema){this.closeAppSchema();}},onwidthChange:function(){if(this.editorNode){this.editorNode.style.width=this.width||"auto";}},startPublishAnimation:function(){var origTitle=this.title,tickCnt=0,me=this;this._origTitle=origTitle;var animationTick=function(){var txt,dots;if(me._tickTimer===null||!me.titleNode){return ;}switch(tickCnt%3){case 0:dots=".&nbsp;&nbsp;";break;case 1:dots="..&nbsp;";break;case 2:dots="...";break;}txt='<span class="republish-success-label">'+me._origTitle+'</span><span class="republish-success-label color">(&nbsp;'+mstrmojo.desc(4311,"Processing")+dots+"&nbsp)</span>";me.titleNode.innerHTML=txt;tickCnt++;};if(this._tickTimer){return ;}this._tickTimer=window.setInterval(animationTick,1000);},stopPublishAnimation:function(){if(this._tickTimer){window.clearInterval(this._tickTimer);this._tickTimer=null;this.titleNode.innerHTML=this._origTitle;}},update:function(evt){var model=this.model,res,cnt,i,title;this.onCompleted=false;this.onError=false;if(this.operationMode===constants.operationMode.refresh||(this.operationMode===constants.operationMode.edit&&!this.simpleProgressMode)){this.startPublishAnimation();if(evt.completed!==undefined){this.onCompleted=evt.completed;}if(evt.error!==undefined){this.onError=evt.error;}if(this.onCompleted){this.toggleEnable(true);}else{this.toggleEnable(false);}this.cancelButton.set("text",mstrmojo.desc(221,"Cancel"));if(this.onError){this.okButton.set("visible",false);if(this.operationMode===constants.operationMode.refresh){this.cancelButton.set("visible",true);}else{this.cancelButton.set("visible",false);}this.sendToHistoryList.set("visible",false);this.statusBox.statusState.set("visible",true);this.statusBox.statusText.set("visible",true);if(this.onCompleted){this.statusBox.statusText.set("text",mstrmojo.desc(13065,"Unable to publish the cube."));$C.removeClass(this.statusBox.statusState.domNode,"tablestatus-col status waiting");$C.addClass(this.statusBox.statusState.domNode,"tablestatus-col status warning");this.stopPublishAnimation();}}else{if(this.onCompleted&&!this.onError){this.stopPublishAnimation();title=this.title;if(title.indexOf('<span class="republish-success-label">')<0){title='<span class="republish-success -label">'+title+'</span><span class="republish-success-label color">'+mstrmojo.desc(13444,"( Successfully published to memory )")+"</span>";}this.set("title",title);this.okButton.set("visible",false);this.cancelButton.set("text",mstrmojo.desc(8473,"Done"));this.cancelButton.set("enabled",true);this.sendToHistoryList.set("visible",false);this.cancelButton.set("visible",true);this.statusBox.statusText.set("text",mstrmojo.desc(15100,"Successfully refreshed."));$C.addClass(this.statusBox.statusText.domNode,"finished");$C.removeClass(this.statusBox.statusState.domNode,"tablestatus-col status waiting");$C.addClass(this.statusBox.statusState.domNode,"tablestatus-col status finished");}else{if(!this.onCompleted&&!this.onError){this.toggleEnable(false);this.okButton.set("text",mstrmojo.desc(15079,"Refreshing..."));this.statusBox.statusText.set("visible",true);this.statusBox.statusState.set("visible",true);$C.addClass(this.statusBox.statusState.domNode,"tablestatus-col status waiting");$C.addClass(window.document.body,"invisible-wait");}}}if(evt&&evt.reset){this.stopPublishAnimation();this.toggleEnable(true);this.okButton.set("visible",true);this.cancelButton.set("visible",true);this.cancelButton.set("enabled",true);this.statusBox.statusText.set("visible",false);this.statusBox.statusState.set("visible",false);}}if(this.operationMode===constants.operationMode.create&&!this.simpleProgressMode){if(evt.error){this.stopPublishAnimation();this.statusBox.statusText.set("text",mstrmojo.desc(13065,"Unable to publish the cube."));this.statusBox.statusState.set("visible",true);$C.removeClass(this.statusBox.statusState.domNode,"tablestatus-col status waiting");$C.addClass(this.statusBox.statusState.domNode,"tablestatus-col status warning");}else{if(evt.completed&&!evt.error){this.stopPublishAnimation();title=this.title;this.statusBox.statusText.set("visible",true);this.statusBox.statusText.set("text",mstrmojo.desc(13444,"( Successfully published to memory )"));this.statusBox.statusState.set("visible",true);$C.removeClass(this.statusBox.statusState.domNode,"tablestatus-col status waiting");$C.addClass(this.statusBox.statusState.domNode,"tablestatus-col status finished");}else{this.statusBox.statusText.set("visible",true);this.statusBox.statusState.set("visible",true);$C.addClass(this.statusBox.statusState.domNode,"tablestatus-col status waiting");$C.addClass(window.document.body,"invisible-wait");}}}if(this.operationMode===constants.operationMode.edit&&this.simpleProgressMode){if(evt.completed){mstrmojo._IsWebApp.hideWait(true);if(!evt.error){this.onClose();}}}},toggleEnable:function(bEnable){this.okButton.set("enabled",!!bEnable);},getFileUploader:function(tableID){return this.statusList.getFileUploader(tableID);},checkCanRefresh:function(){return this.statusList.checkCanRefresh();},checkCanChange:function(){if(this.operationMode===constants.operationMode.refresh&&$DIHelper.isWS()&&!this.okButton.enabled){return false;}return this.statusList.checkCanChange();},children:[{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(13956,"Publishing time depends on your dataset. Are you sure you want to republish?"),cssClass:"timewarning-label",bindings:{visible:"this.parent.showTimeWarningMsg"}},{scriptClass:"mstrmojo.AS.DIAppSchemaTableStatusList",alias:"statusList",forceFullPublish:true,cssText:"height: auto;",bindings:{model:function(){this.parent.model=getModel(this.parent.model);if(this.parent.operationMode){this.parent.model.operationMode=this.parent.operationMode;}return this.parent.model;},forceFullPublish:function(){var isForceFullPublish=true;if(this.parent.operationMode===constants.operationMode.refresh){isForceFullPublish=(!this.parent.model.isCubePublished||!this.parent.model.rawDataExistsInAE);}else{if(this.parent.operationMode===constant.operationMode.edit){isForceFullPublish=this.parent.forceFullPublish;}}return isForceFullPublish;},items:"this.parent.items",bHasRefreshPolicy:function(){return this.parent.operationMode===constants.operationMode.refresh||this.parent.operationMode===constants.operationMode.edit;},visible:"!this.parent.simpleProgressMode"}},{slot:"buttonNode",alias:"cancelButton",scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton",text:mstrmojo.desc(221,"Cancel"),visible:false,onclick:function(){var editor=this.parent;editor.close();},postBuildRendering:function(){var model=this.parent.model;if(model){model.attachEventListener("PublishStatusUpdate",this.id,"update");}},update:function(evt){if(evt&&evt.name&&!evt.completed&&!evt.hasError){this.set("enabled",false);}if(evt&&evt.reset){this.set("enabled",true);}},bindings:{visible:function(){return(this.parent.operationMode!==constants.operationMode.create&&!this.parent.simpleProgressMode);}}},{slot:"buttonNode",alias:"okButton",scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton hot",text:mstrmojo.desc(773,"Refresh"),useRichTooltip:true,richTooltip:{cssClass:"vi-regular vi-tooltip-V",posType:mstrmojo.tooltip.POS_BOTTOMLEFT},postBuildRendering:function(){this.richTooltip.refNode=this.domNode;this.attachEventListener("renderComplete",this.id,this.onuseRichTooltipChange);},postCreate:function postCreate(){var me=this,evtConfig={},listConfig=evtConfig[this.id]={};var evtHandler=function(evt){var model=me.parent.model,operationMode=me.parent.operationMode;if(operationMode===constants.operationMode.refresh||operationMode===constants.operationMode.edit){me.set("enabled",!!evt.value);me.richTooltip.content=evt.value?"":DISABLED_BUTTON_TOOLTIP;}};listConfig[EVENT_CAN_START_REFRESH]=evtHandler;if(mstrApp&&mstrApp.rootController!=undefined){mstrApp.getRootController().attachDataChangeListeners(evtConfig);}},onclick:function(){var rootCtrl,buttonNode=this,editor=this.parent,model=this.parent.model,operationMode=this.parent.operationMode,sourceArr=[];if(mstrApp&&mstrApp.getRootController!=undefined){rootCtrl=mstrApp.getRootController();}if(operationMode===constants.operationMode.refresh||operationMode===constants.operationMode.edit){this.parent.toggleEnable(false);this.parent.okButton.set("text",mstrmojo.desc(15079,"Refreshing..."));this.parent.statusBox.statusText.set("visible",true);this.parent.statusBox.statusState.set("visible",true);$C.addClass(this.parent.statusBox.statusState.domNode,"tablestatus-col status waiting");$C.addClass(window.document.body,"invisible-wait");}if(operationMode===constants.operationMode.refresh&&rootCtrl){var callback=buttonNode.parent.publishCube?function(){buttonNode.parent.publishCube();}:function(){rootCtrl.saveAndPublish();};refreshHandler(model,sourceArr,rootCtrl,callback,buttonNode.parent.items&&buttonNode.parent.items.pipelineInfos);}if(operationMode===constants.operationMode.edit){if(this.parent.publishCube){this.parent.publishCube();}this.parent.model.raiseEvent({name:"PublishStatusUpdate",completed:false});}},bindings:{visible:function(){var operationMode=me.parent.operationMode;return(operationMode!==constants.operationMode.create&&!this.parent.simpleProgressMode);}}},{slot:"buttonNode",alias:"sendToHistoryList",scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton sendToHistory",text:mstrmojo.desc(4364,"Send to History List"),useRichTooltip:true,richTooltip:{cssClass:"vi-regular vi-tooltip-V",posType:mstrmojo.tooltip.POS_BOTTOMLEFT},onclick:function(){if(mstrApp&&mstrApp.getRootController!=undefined){mstrApp.getRootController().getPublishController().sendToHistoryList();}},postBuildRendering:function(){this.richTooltip.refNode=this.domNode;this.attachEventListener("renderComplete",this.id,this.onuseRichTooltipChange);},postCreate:function postCreate(){var me=this,evtConfig={},listConfig=evtConfig[this.id]={};var evtHandler=function(evt){var model=me.parent.model,operationMode=me.parent.operationMode;if(operationMode===constants.operationMode.refresh||operationMode===constants.operationMode.edit){me.set("enabled",evt.value);me.richTooltip.content=evt.value?"":DISABLED_BUTTON_TOOLTIP;}};listConfig[EVENT_CAN_START_REFRESH]=evtHandler;if(mstrApp&&mstrApp.rootController!=undefined){mstrApp.getRootController().attachDataChangeListeners(evtConfig);}},bindings:{visible:function(){var operationMode=this.parent.operationMode;return false;}}},{scriptClass:"mstrmojo.Box",slot:"buttonNode",alias:"statusBox",children:[{scriptClass:"mstrmojo.Label",cssClass:"appschema-refreshBox-status",alias:"statusState",cssText:"display: inline-block;",visible:false,text:""},{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(15105,"Loading data..."),alias:"statusText",cssClass:"republish-appschema-status-text",cssText:"display: inline-block;",visible:false}]},{scriptClass:"mstrmojo.Label",slot:"buttonNode",alias:"statusBusy",cssClass:"schedule-status-busy",visible:false}]});}());