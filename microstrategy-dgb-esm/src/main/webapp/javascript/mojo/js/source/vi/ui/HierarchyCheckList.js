(function(){mstrmojo.requiresCls("mstrmojo.ui.HierarchyCheckList","mstrmojo.ui._HierarchyListSelection","mstrmojo.EnumSelectionType","mstrmojo.hash","mstrmojo.array","mstrmojo.css");var $HASH=mstrmojo.hash,$CSS=mstrmojo.css,$ARR=mstrmojo.array,$SELECTION_TYPE=mstrmojo.EnumSelectionType;var CSS_DYNAMIC="dynamic",CSS_SELECTED_DESCENDANT="hasSelectedDsct";var ELEMENT_TYPE_CONSOLIDATION=7;function getLevelItemConfig(levels,levelSeletion,startLevel){var levelItems=[],levelIndices={};$ARR.forEach(levels,function(level){var value=level.v;if(value>=startLevel){levelItems.push(level);if(levelSeletion.isLevelSelected(value)){levelIndices[levelItems.length-1]=true;}}});return{items:levelItems,selectedIndices:levelIndices};}mstrmojo.vi.ui.HierarchyCheckList=mstrmojo.declare(mstrmojo.ui.HierarchyCheckList,[mstrmojo.ui._HierarchyListSelection],{scriptClass:"mstrmojo.vi.ui.HierarchyCheckList",getItemMarkup:function getItemMarkup(item,idx){return'<{@tag} class="item {@cls}" idx="{@idx}" style="{@style}" title="{@tt}"><div class="right"><span class="refresh" title="{@refreshTitle}"></span><span class="branch" title="{@branchTitle}"></span><span class="level" title="{@levelTitle}"></span></div><div class="content"><span class="indent" style="padding-left: {@indent}px;"></span><span class="triangle"></span><span class="checkbox"></span><span class="text">{@en@n}</span></div></{@tag}>';},getItemProps:function getItemProps(item,idx){var props=this._super(item,idx);if(item.isBranchSelected){props.addCls(CSS_DYNAMIC);}if(item.hasDsctSelected){props.addCls(CSS_SELECTED_DESCENDANT);}$HASH.copy({refreshTitle:mstrmojo.desc(15251,"Dynamic"),branchTitle:item.isSelected?mstrmojo.desc(15921,"Single Deselect"):mstrmojo.desc(15920,"Single Select"),levelTitle:mstrmojo.desc(15919,"Level Select"),},props);return props;},onclick:function onclick(evt){var target=evt.getTarget(),itemNode=this.getItemNodeFromTarget(target),item=this.getItemFromTarget(target);if(item){if($CSS.hasClass(target,"triangle")){if(item.hcd){this.doExpandCollapse(itemNode,item);}}else{if($CSS.hasClass(target,"branch")){this.doElementSelect(itemNode,item,!item.isSelected);}else{if($CSS.hasClass(target,"level")){this.openLevelPopup(itemNode,item,target);}else{if(!$CSS.hasClass(target,"indent")&&!$CSS.hasClass(target,"refresh")){this.doBranchSelect(itemNode,item,!item.isSelected);}}}}evt.cancel();}},onSelectionChange:function onSelectionChange(type,isSelected,item,level){if(type===$SELECTION_TYPE.ALL&&isSelected){this.clearSelections();(this.raad?this.getInitialDisplayRoots():this.getRootItems()).forEach(function(root){if(root.v){this.selectionList.push({func:$SELECTION_TYPE.BRANCH,itemValue:root.v,isNot:false});}},this);if(this.postSelectionChange){this.postSelectionChange();}}else{this._super(type,isSelected,item,level);}},updateItemNodesStatus:function updateItemNodesStatus(){var itemNodes=this.itemsContainerNode&&this.itemsContainerNode.childNodes;this._super();$ARR.forEach(itemNodes,function(itemNode){var item=this.getItemFromTarget(itemNode),singleSelectIcon=itemNode.getElementsByClassName("branch")[0];if(item){$CSS.toggleClass(itemNode,CSS_DYNAMIC,item.isBranchSelected);$CSS.toggleClass(itemNode,CSS_SELECTED_DESCENDANT,item.hasDsctSelected);if(singleSelectIcon){singleSelectIcon.title=item.isSelected?mstrmojo.desc(15921,"Single Deselect"):mstrmojo.desc(15920,"Single Select");}}},this);},getSummaryText:function getSummaryText(){return"";},getLevels:function getLevels(){return[];},getLevelItems:function getLevelItems(includeAll){var levels=this.getLevels(),levelItems=includeAll?[{v:-1,n:mstrmojo.desc(15824,"All Levels")}]:[];if(levels.length>0){return levelItems.concat(levels);}var maxLevel=this.getMaxLevel();for(var i=0;i<=maxLevel;i++){levelItems.push({v:i,n:mstrmojo.desc(493,"Level")+" "+(i+1)});}return levelItems;},postBuildRendering:function postBuildRendering(){var levelPopup=this.levelPopup,domNode=this.domNode;if(!levelPopup){var levelConfig=this.getLevelPopupConfig(),Clazz=$HASH.walk(levelConfig.scriptClass,window);delete levelConfig.scriptClass;levelPopup=this.levelPopup=new Clazz(levelConfig);this.addDisposable(levelPopup);}levelPopup.placeholder=domNode.insertBefore(document.createElement("div"),domNode.firstChild);levelPopup.render();return this._super();},unrender:function unrender(ignoreDom){var levelPopup=this.levelPopup;if(levelPopup){levelPopup.unrender(ignoreDom);}return this._super(ignoreDom);},onScrollEnd:function onScrollEnd(){var levelPopup=this.levelPopup,levelPopupWidget=levelPopup&&levelPopup.getPopupWidget();if(levelPopupWidget&&levelPopupWidget.visible){levelPopup.closePopup();}this.hideTooltip();},openLevelPopup:function openLevelPopup(itemNode,item,offsetNode){var levelPopup=this.levelPopup,levelPopupWidget=levelPopup.getPopupWidget();if(levelPopup&&item.hcd&&this.isHiearachyDisplay()){levelPopup.openPopup(levelPopupWidget,{branch:item,branchNode:itemNode});if(offsetNode){levelPopupWidget.domNode.style.left=offsetNode.offsetLeft+"px";levelPopupWidget.domNode.style.top=offsetNode.offsetTop+offsetNode.offsetHeight-this.scrollNode.scrollTop+"px";}}},getLevelPopupConfig:function getLevelPopupConfig(config){return $HASH.copy(config,{scriptClass:"mstrmojo.ui.PopupButton",markupString:'<div id="{@id}" class="level-popup-btn" title="{@title}" mstrAttach:click></div>',title:mstrmojo.desc(15919,"Level Select"),isHostedWithin:false,parent:this,widget:this,children:{scriptClass:"mstrmojo.ui.PopupWidget",alias:"levelPopup",visible:false,children:[{scriptClass:"mstrmojo.ui.CheckList",alias:"checklist",doItemSelect:function doItemSelect(item,evt){var popup=this.parent,widget=popup.opener.widget,isSelected=!this.selectedIndices[item._renderIdx];if(popup.branch&&popup.branchNode){widget.doBranchLevelSelect(popup.branchNode,popup.branch,item.v,isSelected);}else{widget.doLevelSelect(item.v,isSelected);}mstrmojo._IsList.doItemSelect.call(this,item,evt);},onclick:function onclick(evt){if(!$CSS.hasClass(evt.getTarget(),"refresh")){mstrmojo._IsList.onclick.call(this,evt);}},getItemMarkup:function getItemMarkup(item){return mstrmojo.ui.CheckList.prototype.getItemMarkup.call(this,item).replace('<span class="text">{@en@n}</span>','<span class="refresh"></span><span class="text">{@en@n}</span>');}}],onOpen:function onOpen(){var widget=this.opener.widget,branch=this.branch,itemCfg=getLevelItemConfig(widget.getLevelItems(),widget.getLevelSelection(branch),branch&&branch.lv+1||0);this.checklist.set("items",itemCfg.items);this.checklist.set("selectedIndices",itemCfg.selectedIndices);}},getPopupWidget:function getPopupWidget(){return this.levelPopup;},onPopupWidgetOpened:function onPopupWidgetOpened(){$CSS.addClass(this.levelPopup.branchNode,"level-popup-open");},onPopupWidgetClosed:function onPopupWidgetClosed(){$CSS.removeClass(this.levelPopup.branchNode,"level-popup-open");}});},getAllButtonConfig:function getAllButtonConfig(isSelected,config){return $HASH.copy(config,isSelected?{scriptClass:"mstrmojo.Button",text:mstrmojo.desc(3474,"Select All"),alias:"selectAllBtn",cssClass:"selectAll",widget:this,onclick:function(){this.widget.doAllSelect(true);}}:{scriptClass:"mstrmojo.Button",text:mstrmojo.desc(1763,"Clear All"),alias:"clearAllBtn",cssClass:"clearAll",widget:this,onclick:function(){this.widget.doAllSelect(false);}});}});}());