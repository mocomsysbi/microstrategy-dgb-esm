(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.EnumRWUnitType","mstrmojo.DocDataService","mstrmojo.func","mstrmojo.array","mstrmojo.vi.viz.KnownVisualizations","mstrmojo.VisEnum","mstrmojo.vi.viz.EnumVizStyles","mstrmojo.vi.controllers.ControlUtils","mstrmojo.vi.controllers.EnumEvents","mstrmojo.gmaps.EnumGraphicType");mstrmojo.requiresClsP("mstrmojo.vi.models","EnumPanelTypes");var $ARRAY=mstrmojo.array,$HASH=mstrmojo.hash,$FUNC=mstrmojo.func,$RW_UNIT_TYPES=mstrmojo.EnumRWUnitType,$VI_COMPONENT_TYPES=mstrmojo.vi.models.VIComponentMap.TYPES,$KNOWN_VIZ=mstrmojo.vi.viz.KnownVisualizations,$PANEL_TYPES=mstrmojo.vi.models.EnumPanelTypes,ENUM_VIZ_STYLES=mstrmojo.vi.viz.EnumVizStyles,ITEM_SEPARATOR="\u001E",REQUEST_DEFN_DATA=mstrmojo.DocDataService.REQUEST_DEFN_DATA,SUPPRESS_DATA=mstrmojo.DocDataService.SUPPRESS_DATA,UTILS=mstrmojo.vi.controllers.ControlUtils,CARDLIMIT=mstrmojo.VisEnum.VIS_CARDLIMIT.NON_GRID,EVENTS=mstrmojo.vi.controllers.EnumEvents;var TYPE_METRIC=4,THRESHOLD_EXCEPTIONS=[$KNOWN_VIZ.HEATMAP];function createNewVizNode(params){params=params||{};return this.createNewUnitNode(function(data){data.eg="";if(params.fnData){data=params.fnData(data);}return data;},function(defn){defn.t=$RW_UNIT_TYPES.GRID;defn.n=params.n||"";defn.ttl=params.title||defn.n;defn.ds=0;defn.tt=1;defn.eo=0;if(params.fnDefn){defn=params.fnDefn(defn);}return new mstrmojo.Model(defn);},params.fnNode,params.nodeKey,params.layoutKey);}function copyMoveMapLayers(me,vizBox,isMoving,update,destination,dstVizNode){var dataService=me.getDataService(),widget=vizBox.boxContent,srcScdps=me.getMapLayerKeys(widget),newScdps=[];$ARRAY.forEach(srcScdps,function(key){var newKey,nodeDefn=me.getLayoutUnitDefn(key),node={k:key,defn:{t:nodeDefn.t||522}};if(isMoving){update.addActions(dataService.getMacroMoveNodeAction(node,destination));}else{newKey=me.getNextKey();newScdps.push(newKey);update.addActions(dataService.getMacroCopyNodeAction(node,destination,newKey));}});if(newScdps&&dstVizNode){update.addActions(me.getFormatSDPAction(dstVizNode,newScdps));}return newScdps;}function copyVisAsFilterDeferred(me,srcVizBox,dstVizBox,update,extraTargetKeys){var srcVizKey=srcVizBox.k,dstVizKey=dstVizBox.k,vizBoxs=srcVizBox.parent.children,puKeys=[],bc=srcVizBox.boxContent,separateFilter=bc.getFilterType()===1,newCGB=true,cgbKey,tks,dataService=me.getDataService(),targetKeys=[dstVizKey].concat(extraTargetKeys||[]);$ARRAY.forEach(vizBoxs,function(vizBox){var an=vizBox.defn.an,isTargetSrcViz=$ARRAY.find(an,"k",srcVizKey)!==-1,sc;$ARRAY.forEach(targetKeys,function(targetKey){if(newCGB){cgbKey=me.getNextKey();}if(isTargetSrcViz){sc=vizBox.boxContent.selectorControl;puKeys.push(vizBox.k);an.push({k:targetKey,muc:24});update.addActions({act:"associateNodes",nodeKey:vizBox.k,targetKeys:[targetKey],partialRetrieval:dataService.newRetrievalKeysConfig().addNode(vizBox.k)});if(sc){sc.cgb[$HASH.keyarray(sc.cgb).length+1]=cgbKey;update.addActions({act:"addVisToFilter",parentKey:srcVizKey,targetKey:targetKey,ctrlKey:sc.ckey,newCGB:newCGB,cgbKey:cgbKey});}}});if(!separateFilter){newCGB=false;}});if(bc&&bc.selectorControl){var cgbMap=me.getCurrentLayoutDef().cgbMap,newCGBNodeKeys=[],oldCGBNodeKeys=[],sourceControl=bc.selectorControl,findCGBKey=function(targetKey){var r;$HASH.forEach(cgbMap,function(cgbTarget,mapCGBKey){if($HASH.valarray(sourceControl.cgb).indexOf(mapCGBKey)!==-1&&targetKey===cgbTarget){r=mapCGBKey;}});return r;},ft;targetKeys=[];tks=(sourceControl.tks||"").split("\u001E");tks.forEach(function(targetKey){var newKey,oldKey,cgbIndex,bx=(vizBoxs.filter(function(b){return b.k===targetKey;}))[0];if(bx){ft=bx.boxContent.getFilterType();}if(ft===1){targetKeys.push(targetKey);newKey=me.getNextKey();cgbMap[newKey]=targetKey;newCGBNodeKeys.push([newKey,true]);oldKey=findCGBKey(targetKey);$HASH.forEach(sourceControl.cgb,function(v,k){if(v===oldKey){cgbIndex=k;}});if(cgbIndex){sourceControl.cgb[cgbIndex]=newKey;}oldCGBNodeKeys.push([oldKey,false]);}});if(targetKeys.length){update.addActions({act:"replaceControlCGB",oldCGBNodeKey:oldCGBNodeKeys,targetKeys:targetKeys,newCGBNodeKeys:newCGBNodeKeys,controlKey:bc.selectorControl.ckey,sourceKey:srcVizKey});}}if(puKeys.length>0){update.addCallbacks({success:function(res){me.partialUpdate(res.data,me.getTargetDefn(puKeys),res.defn,puKeys);}});}}function copyMoveVisualization(me,vizBox,vizPanelStack,dstPanelKey,dstLayoutKey,isMoving){me.execute({execute:function(){var dataService=me.getDataService(),cmdMgr=me.cmdMgr(),cmd=this,docView=me.controller.view,update=dataService.newUpdate(),srcPanel=vizBox.parent,srcPanelKey=srcPanel.k,srcLayoutKey=me.getCurrentLayoutKey(),dstPanel,sameLayout=dstLayoutKey===srcLayoutKey,srcVizKey=vizBox.k,dstVizKey,destination,loaded,existing,cmdPhase;if(isMoving&&vizBox.boxContent&&vizBox.boxContent.updateAssociatedNodesOnMove){vizBox.boxContent.updateAssociatedNodesOnMove();}if(sameLayout){existing=!!dstPanelKey;if(!existing){dstPanel=me.addPanel(update,vizPanelStack.k);dstPanelKey=dstPanel.k;loaded=true;var vizPanelStackId=vizPanelStack.id,vizPanelStackParentId=vizPanelStack.parent.id,vizPanelStackKey=vizPanelStack.k,fnPreUndoRedoNewPanel=function(){this.urInfo.puKeys=[vizPanelStackKey];}.bind(this);this.urInfo=$HASH.copy({undo:function(){fnPreUndoRedoNewPanel();var defn=me.getLayoutUnitDefn(dstPanelKey,dstLayoutKey);if(defn){defn._isDeleted=true;}this.urInfo.extras.style.params.treesToRender=3;},redo:function(){fnPreUndoRedoNewPanel();var defn=me.getLayoutUnitDefn(dstPanelKey,dstLayoutKey);if(defn&&defn._isDeleted){delete defn._isDeleted;}},callback:$FUNC.wrapMethods({success:function(res){me.controller.view.updateXtabStyles(dstLayoutKey,res.data.layouts[$ARRAY.find(res.data.layouts,"k",dstLayoutKey)].xtabStyles);me.updateDefnCache(res.defn,[vizPanelStackKey,srcPanelKey,dstPanelKey]);me.updateDataCache(res.data,me.getTargetDefn(vizPanelStackKey));var parent=mstrmojo.all[vizPanelStackParentId];parent.rebuildChild(mstrmojo.all[vizPanelStackId]);parent.doLayout();me.raiseEvent({name:EVENTS.UPDATE_TOC});}},me.getRebuildCallback())},this.urInfo);}else{dstPanel=me.getPanel(dstPanelKey);loaded=dstPanelKey===srcPanelKey||dstPanel.defn.l;if(dstPanelKey!==srcPanelKey){this.urInfo=$HASH.copy({undo:function(){this.urInfo.puKeys=[srcPanelKey];},redo:function(){this.urInfo.puKeys=[dstPanelKey];},callback:$FUNC.wrapMethods({success:function(){me.getPanel(srcPanelKey).unload();me.getPanel(dstPanelKey).unload();}},me.getRebuildCallback()),treesToRender:3},this.urInfo);}}destination={parentKey:dstPanelKey};}else{if(dstLayoutKey){loaded=false;existing=true;me.markDirtyLayout(dstLayoutKey);docView.showLayout(docView.getLayout(dstLayoutKey),null,update);destination={layoutKey:dstLayoutKey,analysisSectionType:$PANEL_TYPES.VISUALIZATION};cmd.urInfo=$HASH.copy({callback:$FUNC.wrapMethods({success:function(){if(isMoving){me.markDirtyLayout(srcLayoutKey);}me.markDirtyLayout(dstLayoutKey);}},me.getRebuildCallback())},this.urInfo);}else{loaded=false;existing=false;dstLayoutKey=me.getNextKey();dstPanelKey=me.getNextKey();cmdPhase=cmdMgr.CMD_PHASE.FIRST;docView.addNewLayout(update,-1,{nodeKey:dstLayoutKey,newPanelKey:dstPanelKey,analysisSectionType:$PANEL_TYPES.VISUALIZATION});destination={parentKey:dstPanelKey};cmd.urInfo=$HASH.copy({callback:UTILS.rebuildAndUpdateTOCcallback.call(me)},cmd.urInfo);}}if(isMoving){dstVizKey=srcVizKey;var srcDefn=me.getTargetDefn(srcVizKey)[srcVizKey];if(srcDefn&&srcDefn.gi){var oldGroupInfo=srcDefn.gi,modelId=me.id,fnUndoRedoGroup=function(isUndo){var model=mstrmojo.all[modelId];if(model){var defn=model.getTargetDefn(srcVizKey)[srcVizKey];if(defn){if(isUndo){defn.gi=oldGroupInfo;}else{delete defn.gi;}}}};$FUNC.wrapMethods({undo:function(){fnUndoRedoGroup(true);},redo:function(){fnUndoRedoGroup(false);}},cmd.urInfo);delete srcDefn.gi;}if(!srcPanel.hasMultipleChildren()){var newUnitKey=me.addVisualizationDeferred(update,srcPanelKey).k;update.addCallbacks({success:function(res){var newUnitDefn=null;$ARRAY.forEach(res.defn.layouts,function(layout){if(layout.k===srcLayoutKey){newUnitDefn=layout.units[newUnitKey];return false;}});me.getLayoutDefn(srcLayoutKey).units[newUnitKey]=newUnitDefn;}});}srcPanel.deleteBoxAndSubmitDeferred(update,vizBox,undefined,true,true);update.addActions(dataService.getMacroMoveNodeAction(vizBox,destination));copyMoveMapLayers(me,vizBox,isMoving,update,destination);if(loaded){vizBox.unrender();dstPanel.insertNewBoxAndSaveDeferred(update,vizBox);update.addCallbacks({success:function(res){var pukeys=[dstPanelKey,vizBox.k];me.updateDefnCache(res.defn,pukeys);me.updateDataCache(res.data,me.getTargetDefn(pukeys.join(ITEM_SEPARATOR)));dstPanel.rebuildChild(vizBox);}});}else{if(!sameLayout){me.markDirtyLayout(srcLayoutKey);}vizBox.destroy();}}else{var dstVizNode=createNewVizNode.call(me,{n:vizBox.title,layoutKey:dstLayoutKey}),extraTargetKeys;dstVizKey=dstVizNode.k;update.addActions(dataService.getMacroCopyNodeAction(vizBox,destination,dstVizKey));extraTargetKeys=copyMoveMapLayers(me,vizBox,isMoving,update,destination,dstVizNode);if(loaded){var dstVizBox=me.createUnit(dstVizNode,dstPanelKey);me.deferredInsertUnit(update,dstVizBox,dstPanelKey);if(srcPanelKey===dstPanelKey){copyVisAsFilterDeferred(me,vizBox,dstVizBox,update,extraTargetKeys);this.urInfo.puKeys=[srcPanelKey];}}}if(sameLayout){if(!existing){me.selectNewPanel(update,dstPanelKey);}else{if(srcPanelKey!==dstPanelKey){vizPanelStack.selectPanelDeferred(update,dstPanelKey);}}}if(existing){if(!loaded){cmdPhase=cmdMgr.CMD_PHASE.FIRST;update.addCallbacks({success:function(){dstPanel=me.getPanel();var dstViz=dstPanel.getUnitByKey(dstVizKey),prevCmd=cmdMgr.getInterimCmd();if(!dstPanel.hasBoxLayoutChild(dstViz)){dstPanel.insertNewBox(dstViz);}if(dstPanel.defn.layoutXML){dstPanel.saveBoxLayout(prevCmd,cmdMgr.CMD_PHASE.LAST,null,null,true);}else{dstPanel.saveBoxLayout(prevCmd,cmdMgr.CMD_PHASE.LAST,null,null,true);}}});}update.addCallbacks({success:function(){var newCopiedViz=dstPanel.getUnitByKey(dstVizKey);newCopiedViz.selectVIUnit();},complete:function(){dstPanel.restoreAnyMaxedVizBox();}});}update.addExtras(REQUEST_DEFN_DATA);this.submitUpdate(update,cmdPhase);},urInfo:{treesToRender:3}});}function clearVisAsFilterActionHandler(vizBox,controlNode,an,sourceKey,visNodeKeys,isVisDeleted){var model=this,prKeys=[],acs=[],ac,cb,cgbKeys=[],cgbMap=this.getCGBMap(),getCGBs=function(){return $ARRAY.filter($HASH.keyarray(cgbMap),function(item){return visNodeKeys.indexOf(cgbMap[item])>-1;});},cgbs;if(an){an.forEach(function(node){prKeys.push(node.k);});ac={act:"clearVisAsFilter",nodeKey:sourceKey,associatedNodes:prKeys,partialRetrieval:{nodes:prKeys}};if(controlNode){$ARRAY.forEach($HASH.valarray(controlNode.cgb),function(cgbKey){cgbKeys.push([cgbKey,model.getSourceControls(vizBox,cgbKey).length<=1]);});ac.cgbNodeKeys=cgbKeys;ac.controlKey=controlNode.ckey;}cb=isVisDeleted?{success:function(res){model.partialUpdate(res.data,model.getTargetDefn(prKeys));}}:$FUNC.wrapMethods(this.associatedNodesUpdate([vizBox]).callback,this.controller._getXtabCallback(vizBox.boxContent));acs.push(ac);}if(isVisDeleted){cgbs=getCGBs();$ARRAY.forEach(cgbs,function(cgbKey){var targetVisKey=cgbMap[cgbKey],sources=model.getSourceControls(vizBox,cgbKey),deleted=false,targetKeys,cgbsArr,sourcebc,sourceIsVisMap,sourceNodeKey,node,sourceCtrl;delete cgbMap[cgbKey];$ARRAY.forEach(sources,function(source){sourcebc=source.bc;sourceCtrl=source.control;sourceIsVisMap=sourcebc&&sourcebc.isVisMap;sourceNodeKey=sourceIsVisMap?sourcebc.getKeyForTemplateSelection():source.sourceKey;node=sourceIsVisMap?sourcebc.getWidgetForTemplateSelection().node:sourcebc.node;targetKeys=sourceCtrl.tks.split("\u001E");ac={act:"clearVisAsFilter",nodeKey:sourceNodeKey,associatedNodes:[targetVisKey],cgbNodeKeys:[[cgbKey,!deleted]],controlKey:sourceCtrl.ckey,removeControl:targetKeys.length===1,partialRetrieval:{nodes:[sourceNodeKey]}};deleted=true;if(targetKeys.length>1){cgbsArr=$HASH.valarray(sourceCtrl.cgb);cgbsArr.splice(cgbsArr.indexOf(cgbKey),1);sourceCtrl.cgb={};$ARRAY.forEach(cgbsArr,function(c,i){sourceCtrl.cgb[i]=c;});targetKeys.splice(targetKeys.indexOf(targetVisKey),1);sourceCtrl.tks=targetKeys.join("\u001E");if(node.defn&&node.defn.an){node.defn.an.splice($ARRAY.find(node.defn.an,"k",targetVisKey),1);}}else{delete node.data.sc;delete node.defn.an;delete sourcebc.selectorControl;}acs.push(ac);});});}if(acs.length>0){return{actions:acs,callback:cb,extras:{style:{params:{treesToRender:isVisDeleted?2:3}}}};}}mstrmojo.vi.models._VisActions=mstrmojo.provide("mstrmojo.vi.models._VisActions",{_mixinName:"mstrmojo.vi.models._VisActions",createNewVizNode:createNewVizNode,addVisualizationDeferred:function(update,panelKey,layoutKey){var model=this,title=mstrmojo.desc(11659,"New Visualization"),node=model.createNewUnitNode(null,null,null,null,layoutKey);layoutKey=layoutKey||this.getLayoutKeyByUnitKey(panelKey);$HASH.copy({t:$RW_UNIT_TYPES.GRID,ttl:title,n:title,ds:0,tt:1,eo:0},node.defn);node.data.eg="";var unit=model.createUnit(node,panelKey,layoutKey);update.addActions([model.getCopyEmptyTemplateAction(unit.k,panelKey,layoutKey)]);model.deferredInsertUnit(update,unit,panelKey);update.actions.some(function(act){if(act.unitKey===unit.k){act.partialRetrieval={nodes:[unit.k]};return true;}});update.addExtras(REQUEST_DEFN_DATA);return unit;},addVisualization:function addVisualization(){var model=this,vizKey,node,panelKey=this.getPanel().k;model.execute({execute:function(){var dataService=model.getDataService(),update=dataService.newUpdate(this);var unit=model.addVisualizationDeferred(update,panelKey);vizKey=unit.k;node=unit.boxContent.node;this.submitUpdate(update);},urInfo:{treesToRender:3,undo:function(){this.urInfo.puKeys=[];this.urInfo.callback={};var panel=model.getUnitInstance(panelKey,1),viz=panel.getUnitByKey(vizKey),defn=model.getLayoutUnitDefn(vizKey),parentDefn=model.getLayoutUnitDefn(defn.pnk),parentXml=parentDefn.layoutXML;defn._isDeleted=true;parentXml.children=parentXml.children.filter(function(c){return c.k!==vizKey;});panel.removeChildren(viz);viz.destroy();model.restoreUIState(this.undoUIState);return true;},redo:function(){this.urInfo.puKeys=[vizKey];this.urInfo.callback={success:function(res){var unit=model.createUnit(node,panelKey),panel=model.getUnitInstance(panelKey,1),defn=model.getLayoutUnitDefn(vizKey);if(defn){delete defn._isDeleted;}panel.addChildren(unit);panel.boxLayoutConfig.dirty=true;model.partialUpdate(res.data,model.getTargetDefn([vizKey]),res.defn,[vizKey]);panel.rebuildChild(unit);}};return false;}}});},duplicateVisualization:function duplicateVisualization(vizBox){var curLayoutKey=this.getCurrentLayoutKey(),panelStack=vizBox.boxContent.builder.getLayoutVIMap(curLayoutKey).getComponent($VI_COMPONENT_TYPES.VIZ_CONTENT);copyMoveVisualization(this,vizBox,panelStack,panelStack.selectedKey,curLayoutKey,false);},copyVisualization:function(vizBox,vizPanelStack,dstPanelKey,dstLayoutKey){copyMoveVisualization(this,vizBox,vizPanelStack,dstPanelKey,dstLayoutKey,false);},moveVisualization:function(vizBox,vizPanelStack,dstPanelKey,dstLayoutKey){copyMoveVisualization(this,vizBox,vizPanelStack,dstPanelKey,dstLayoutKey,true);},renameRWUnitTitle:function renameRWUnitTitle(title,oldTitle,key,callback){this.updateTitle(title,oldTitle,key,this.currlaykey,"ttl",callback);},changeSelectedVisType:function changeSelectedVisType(style,vt,widgetType,dropZone){var selectedUnit=this.getSelectedViUnit();if(!selectedUnit){return ;}var layerKeys,model=this,templateActions=[],w=selectedUnit.boxContent,visKey=w.k,data=w.node.data,visName=data.visName,curVisType=(typeof w.getVisType==="function"?w.getVisType():{}).vt,newVisType=typeof vt==="object"?[vt.v,vt.h]:[vt],curStyle=visName||"",isMapViz=visName===ENUM_VIZ_STYLES.ESRI_MAP||visName===ENUM_VIZ_STYLES.GOOGLE_MAP||visName===ENUM_VIZ_STYLES.MAPBOX,visDefinition=$KNOWN_VIZ.getDefinition(style),visTransition=this.controller.visTransitionFactory.newVisualizationTransition(style||"Grid",{vis:w,newVizInfo:{s:style,dz:dropZone}});if(curStyle===style){var isOneGraphMatrix=visTransition.isGraphMatrix(curVisType)||visTransition.isGraphMatrix(newVisType[0]);if(isOneGraphMatrix&&(newVisType[0]!==undefined&&curVisType===newVisType[0]||newVisType[1]!==undefined&&curVisType===newVisType[1])){return ;}else{if(!isOneGraphMatrix){return ;}}}if(isMapViz){layerKeys=this.getMapLayerKeys(w);templateActions=this.getExtraActionsForChangeMapViz(w,layerKeys,templateActions);}if($KNOWN_VIZ.getDefinition(visName||"Grid").id===$KNOWN_VIZ.GRID&&THRESHOLD_EXCEPTIONS.indexOf(visDefinition.id)===-1){var thresholdActions=[];visTransition.addClearAllThresholdsActions(thresholdActions);templateActions.push({act:"updateTemplate",keyContext:w.k,actions:thresholdActions});}if(style!==""&&visDefinition.id!==$KNOWN_VIZ.UNKNOWN){templateActions.push({act:"updateTemplate",keyContext:w.k,actions:[{act:"createDefaultDropZones",nodeKey:w.k,treeType:w.defn.tt,datasetId:data.datasetId,datasetType:3,widgetType:widgetType,partialUpdate:{nodes:[w.k]}}]});}var transitionData=visTransition?visTransition.transitionDropZones(templateActions,vt):{wp:""},widgetProps=transitionData.wp,widgetName=transitionData.wgtName,handled=transitionData.handled,allowedItems=[],viz=visTransition&&visTransition.vis,vizGts=(viz&&viz.node&&viz.node.data&&viz.node.data.gts)||{},items=(vizGts.col||[]).concat(vizGts.row||[]);if(widgetType){$ARRAY.forEach(items,function(item){allowedItems.push(item);});}var datasetId=[],attrArr={},h,fn=function(item){if(!item.id){item.id=item.did;}var itmId=item.id;attrArr[itmId]=item.card;};$HASH.keyarray(this.datasets).forEach(function(datasetid){datasetId.push(datasetid);});for(h=0;h<datasetId.length;h++){$ARRAY.forEach(this.datasets[datasetId[h]].att,fn);}$ARRAY.forEach(allowedItems,function(item){if(!item.id){item.id=item.did;}if(!item.cardg&&!item.card){item.card=attrArr[item.id];}});var graphicType=transitionData&&transitionData.gtp;visTransition.vis.zonesModel.addAttributeNameAndTargetVisForAddUnits(viz.node.data,allowedItems,style,graphicType,transitionData&&transitionData.ln);visTransition.vis.zonesModel.checkAndWarnLargeItemsForAddUnits(allowedItems,function(w,selectedUnit){if(widgetProps.length>0&&!handled){var widgetClassName=this.getWidgetClassNameByStyle(style,widgetType),extraFormatting=widgetName?({FormattingAppearance:{Name:widgetName}}):undefined,extras=REQUEST_DEFN_DATA,undoRedo=function(isDeleted){if(isMapViz&&layerKeys&&layerKeys.length>0){model.syncLayerDefn(visKey,layerKeys,isDeleted);}},urInfo={undo:function undo(){undoRedo(false);},redo:function redo(){undoRedo(true);}},key=selectedUnit.k;templateActions.push(this.getUnitChangeVizAction(style,widgetClassName,selectedUnit,widgetProps,extraFormatting));templateActions.push({act:"changeGridDisplayMode",nodeKey:key,displayMode:style===ENUM_VIZ_STYLES.GRAPH_MATRIX?2:1});if(style==="KPICardVisualizationStyle"){templateActions.push(this.getDataService().getUpdateTemplateAction(visKey,{act:"clearSort"}));}if(w.model.data.eg!==undefined){extras=$HASH.copy(extras,{preserveUndo:true});}var me=this;var deferredSubmit=function(hookVFUnset){var _templateActions=[].concat(templateActions);if(hookVFUnset){_templateActions=me.wrapUnsetVisualizationFilterAction(templateActions);}me.controller.submitUndoRedoUpdates(_templateActions,null,{success:function success(res){var currentLayoutKey=me.getCurrentLayoutKey(),targetDefinitions,panel=me.getPanel();me.refreshDefinition(key,me.getRawLayoutUnitDefn(key,res.defn));me.updateDataCache(res.data,me.getTargetDefn(key));if(hookVFUnset){var vizBox=me.getSelectedViUnit(),vis=vizBox&&vizBox.boxContent,vizFilterKey=vis&&vis.k,puKeys=res.pukeys,puKeysArr=puKeys&&puKeys.split("\u001E"),index=(puKeysArr&&puKeysArr.indexOf(vizFilterKey))||-1;if(vizFilterKey&&index!==-1){puKeysArr.splice(index,1);puKeys=puKeysArr.join("\u001E");}if(puKeys){targetDefinitions=model.getUnitDefinitions(puKeys);}me.partialUpdate(res.data,targetDefinitions,res.defn,puKeysArr,res.puFilters);}if(res.data){res.data.layouts.some(function(layout){var isCurrentLayout=layout.k===currentLayoutKey;if(isCurrentLayout){me.controller.view.updateXtabStyles(currentLayoutKey,layout.xtabStyles);}return isCurrentLayout;},me);}if(mstrApp.isInVFConfigMode){me.selectVIUnit(me.rebuildVizBox(key).id,true);}else{me.selectVIUnit(panel.rebuildChild(panel.getUnitByKey(key)).id,true);}}.bind(me)},extras,urInfo);};me.checkAndNotifyVFChangeOnVisTypeUpdate({},function(){deferredSubmit(true);},function(){deferredSubmit(false);});}}.bind(this,w,selectedUnit),null,!widgetType,null,false,CARDLIMIT);},getUnitChangeVizAction:function getUnitChangeVizAction(visStyle,widgetClassName,selectedUnit,widgetProps,extraFormatting){var visDefinition=$KNOWN_VIZ.getDefinition(visStyle);var mobileVIStyles={IPhoneVisualization:"",IPadVisualization:"",APhoneVisualization:"",ATabletVisualization:""};if(visDefinition&&visDefinition.mobileVIStyles){mobileVIStyles=$HASH.copy(visDefinition.mobileVIStyles,mobileVIStyles);}var visProps={Visualization:$HASH.copy(mobileVIStyles,{VisualizationsEnabled:visStyle?-1:0,ViewMode:visStyle?51:0,SelectedVisualization:visStyle||"",VisualizationList:visStyle||""}),FormattingIncrementalFetch:{EnableIFOnGrid:visStyle?0:-1},FormattingWidget:{ClassName:visStyle?widgetClassName:"",Enable:(widgetClassName!=="")?1:0}};if(widgetProps){visProps.FormattingWidget.WidgetProps=widgetProps;}$HASH.forEach(extraFormatting,function(subFormattings,propertySet){if(!visProps[propertySet]){visProps[propertySet]={};}$HASH.forEach(subFormattings,function(propVal,property){visProps[propertySet][property]=propVal;});});return this.getUnitFormatAction(selectedUnit,1,visProps);},setVisAsFilter:function setVisAsFilter(vis,delta,update){var actions=[],controlNode=delta.sc,targets=delta.targetKeys,fos=delta.isFilter,showAll=delta.clearAll,isNav=delta.isNav,navPage=delta.navPage,model=this,panelKey=delta.srcKey,layoutKey=this.getLayoutKeyByUnitKey(vis.k),puTgts=[],oldTargets=[],newTargets=[],changedTargets=[],targetsUpdated=false,ac,filterType,controlKey,CGBKeys=[],targetKeys=[],resetToMulti=delta.forAllData!==undefined&&delta.forAllData,oldNodeCleared=false,newNodeCreated=false,singleUnit=delta.singleUnit,cgbMap=model.getCurrentLayoutDef().cgbMap,addToCGBMap={},newCGB,deleteCGBKeys=[],nk,contentVis=vis&&vis.boxContent,isVisMap=contentVis.isVisMap,isLayerChanged=delta.isLayerChanged,newSourceKey=isVisMap?(isLayerChanged?delta.layerKey:contentVis.getKeyForTemplateSelection()):vis.k,oldSourceKey=isVisMap?(contentVis.getKeyForTemplateSelection()):vis.k,newNode,oldNode=(isVisMap?contentVis.getWidgetForTemplateSelection(oldSourceKey):contentVis).node,undoRedo=function undoRedo(){delete vis.defn.an;},isShowAll=function(){if(showAll===undefined&&controlNode){return controlNode.all||controlNode.showall;}return showAll===undefined?true:!!showAll;},isFilterOnSelection=function(){if(targetsUpdated&&fos===undefined){if(newTargets.length===changedTargets.length){return true;}return !!controlNode;}if(fos!==undefined){return fos;}return true;},amountOfJSON=SUPPRESS_DATA,isSingleSelectionCGB=function(cgbKey){var res=false;$HASH.forEach(targets,function(target){if(target.cgbs&&target.cgbs.length){target.cgbs.forEach(function(controlCGB){res=res||$HASH.valarray(controlCGB.sc.cgb).indexOf(cgbKey)!==-1;});}});return res;},isInCanvasSelector=function(cgbKey){var res=false,selectors=model.getPanel().defn.ck,layout=model.defn.layoutMap[model.getCurrentLayoutKey()],units=layout&&layout.units,un,cgb;if(units){$HASH.forEach(selectors,function(val,selKey){un=units[selKey];cgb=un&&(un.t===$RW_UNIT_TYPES.SELECTOR)&&un.cgb&&$HASH.valarray(un.cgb);if(cgb&&cgb.length){if(cgb.indexOf(cgbKey)!==-1){res=true;return false;}}});}return res;};if(isLayerChanged){targetsUpdated=true;}mstrmojo.hash.forEach(targets,function(target,k){if(target.c){targetsUpdated=true;changedTargets.push(k);}if((target.v&&!target.c)||(!target.v&&target.c)||(isLayerChanged&&oldNode.defn.an)){oldTargets.push(k);}if(target.v){newTargets.push(k);}return true;},this);if(singleUnit){puTgts=[vis.k];amountOfJSON=REQUEST_DEFN_DATA;}var hasNewTarget=newTargets.length;if(hasNewTarget===0&&!singleUnit&&(!!oldNode.defn.an&&oldNode.defn.an.length>0)){if(controlNode){fos=undefined;}else{fos=false;}}if(singleUnit&&!resetToMulti&&targetsUpdated){$ARRAY.forEach($HASH.valarray(controlNode.cgb),function(cgbKey){deleteCGBKeys.push([cgbKey,true]);delete cgbMap[cgbKey];});if(!hasNewTarget){ac={act:"clearVisAsFilter",nodeKey:vis.k,associatedNodes:oldTargets,cgbNodeKeys:deleteCGBKeys,controlKey:controlNode.ckey};puTgts=puTgts.concat(oldTargets);oldNodeCleared=true;}else{newTargets.forEach(function(k){CGBKeys.push(model.getNextKey());if(puTgts.indexOf(k)===-1){puTgts.push(k);}},this);ac={act:"updateSingleUnitControl",controlKey:controlNode.ckey,nodeKey:vis.k,removeTargetKeys:deleteCGBKeys,newTargetKeys:newTargets,CGBKeys:CGBKeys,unitId:delta.unitId};}actions.push(ac);}else{if(resetToMulti||targetsUpdated||fos!==undefined){ac={act:"clearVisAsFilter",nodeKey:oldSourceKey};if(oldTargets){ac.associatedNodes=oldTargets;puTgts=puTgts.concat(oldTargets);}if(controlNode){$ARRAY.forEach($HASH.valarray(controlNode.cgb),function(cgbKey){var del=model.getAllSources(contentVis,cgbKey).length<=1;if(del){delete cgbMap[cgbKey];}deleteCGBKeys.push([cgbKey,del]);});ac.cgbNodeKeys=deleteCGBKeys;ac.controlKey=controlNode.ckey;}if(controlNode||!$HASH.isEmpty(oldTargets)){oldNodeCleared=true;actions.push(ac);amountOfJSON=REQUEST_DEFN_DATA;}}if(resetToMulti||(targetsUpdated&&hasNewTarget>0)||fos!==undefined){if(isFilterOnSelection()){controlKey=model.getNextKey();}newTargets.forEach(function(k){if(isFilterOnSelection()){filterType=targets[k].ft;if(!filterType){newCGB=true;$HASH.forEach(cgbMap,function(tk,cgbk){if(k===tk&&!isSingleSelectionCGB(cgbk)&&!isInCanvasSelector(cgbk)){CGBKeys.push([cgbk,false]);newCGB=false;}});if(newCGB){nk=model.getNextKey();addToCGBMap[nk]=k;CGBKeys.push([nk,true]);}}else{nk=model.getNextKey();addToCGBMap[nk]=k;CGBKeys.push([nk,true]);}}if(puTgts.indexOf(k)===-1){puTgts.push(k);}targetKeys.push(k);},this);actions.push({act:"setVisAsFilter",sourceKey:newSourceKey,targetKeys:targetKeys,controlKey:controlKey,CGBKeys:CGBKeys,showAll:isShowAll(),fos:isFilterOnSelection(),isNav:isNav});amountOfJSON=isFilterOnSelection()&&model.hasUnitSelector?REQUEST_DEFN_DATA:amountOfJSON;newNodeCreated=true;}}if(!newNodeCreated&&hasNewTarget>0&&showAll!==undefined){actions.push({act:"setControlShowAll",nodeKey:newSourceKey,controlKey:controlNode.ckey,showAll:showAll});}if(actions.length){$HASH.copy(addToCGBMap,cgbMap);actions[0].partialUpdate={nodes:puTgts};if(!update){var updateToolbar=function(){if(contentVis){contentVis.raiseEvent({name:"regenerateToolbar"});}},executeFn=function(){this.execute({execute:function(){var dataService=model.getDataService();update=dataService.newUpdate(this);update.addActions(actions);update.addExtras(amountOfJSON);if(amountOfJSON!==SUPPRESS_DATA){update.addCallbacks(model.getRebuildCallback());}update.addCallbacks({success:function(){var cgb=[],an,bc=mstrmojo.all[contentVis.id],unitLayout=model.getLayoutKeyByUnitKey(bc.k),lyt=unitLayout&&model.getLayoutDefn(unitLayout),sc,key,unit;if(oldNodeCleared){sc=oldNode.data.sc||{};$ARRAY.forEach(sc.cgb,function(v){if(sc.isNavigation&&lyt){unit=lyt.units[v];if(unit){unit.scs=unit.scs||[];key=$ARRAY.find(unit.scs,"ckey",sc.ckey);if(key>-1){unit.scs.splice(key,1);if(!unit.scs.length){delete lyt.units[v];}}}}});delete oldNode.data.sc;delete oldNode.defn.an;if(bc&&bc.deleteSelectorControl){bc.deleteSelectorControl();}unit=lyt.units[bc.k];if(unit){delete unit.an;}}newNode=(isVisMap?bc.getWidgetForTemplateSelection(newSourceKey):bc).node;if(newNodeCreated){if(isFilterOnSelection()){$ARRAY.forEach(CGBKeys,function(v){key=v[0];cgb.push(key);if(isNav&&lyt){unit=lyt.units[key];if(unit){unit.scs=unit.scs||[];if($ARRAY.find(unit.scs,"pnk",bc.k)===-1){unit.scs.push({ckey:controlKey,isNavigation:true,pnk:bc.k});}}else{lyt.units[key]={pnk:panelKey,t:$RW_UNIT_TYPES.UNITCONTAINER,isNavigation:false,scs:[{ckey:controlKey,isNavigation:true,pnk:bc.k}]};}}});newNode.data.sc={ck:[1].concat([newSourceKey,controlKey]).join(ITEM_SEPARATOR),ckey:controlKey,ct:6,showall:isShowAll(),cgb:cgb,tks:targetKeys.join(ITEM_SEPARATOR),isNavigation:isNav,navPage:navPage};}an=newNode.defn.an=[];targetKeys.forEach(function(item){an.push({k:item,muc:24});},this);}if(!newNodeCreated&&hasNewTarget&&showAll!==undefined){newNode.data.sc.showall=showAll;}if(bc&&bc.findSelectorControl){bc.findSelectorControl();}},complete:updateToolbar});this.submitUpdate(update);},urInfo:{treesToRender:3,undo:undoRedo,redo:undoRedo,extraPuKeys:singleUnit?null:$ARRAY.distinct([oldSourceKey,newSourceKey]),puKeys:amountOfJSON===SUPPRESS_DATA&&$ARRAY.distinct([oldSourceKey,newSourceKey]).concat(puTgts),callback:$FUNC.wrapMethods(model.getRebuildCallback(),{success:updateToolbar})}});};if(isNav){model.raiseEvent({name:"layoutSelected",panelKey:panelKey,layoutKey:layoutKey,callback:{complete:executeFn.bind(this)}});}else{executeFn.call(this);}}else{update.addActions(actions);}}return oldNodeCleared;},updateVisSelector:function updateVisSelector(vis,ctrlKey,targetKeys,CGBKeys){if(!vis){return ;}var cgb=[],node=vis.node,an;$ARRAY.forEach(CGBKeys,function(v){cgb.push(v[0]);});node.data.sc={ck:[1].concat([vis.k,ctrlKey]).join(ITEM_SEPARATOR),ckey:ctrlKey,ct:6,showall:true,cgb:cgb,tks:targetKeys.join(ITEM_SEPARATOR)};an=node.defn.an=[];targetKeys.forEach(function(item){an.push({k:item,muc:24});},this);node.data.sc.showall=true;if(vis.findSelectorControl){vis.findSelectorControl();}},getAllSources:function getAllSources(boxContent,cgbKey){var getSC=function(bc){return bc.selectorControl||(bc.findSelectorControl&&bc.findSelectorControl());},sourceControl=getSC(boxContent),tgtKey=((sourceControl&&sourceControl.tks)||"").split(ITEM_SEPARATOR),unitLayout=this.getLayoutKeyByUnitKey((tgtKey.length&&tgtKey[0])||cgbKey),vizBoxs=this.getVizContentPanel(unitLayout).children,unit=unitLayout&&this.getLayoutDefn(unitLayout).units[cgbKey],sc,vizKey,scs=(unit&&unit.scs)||[],res=$HASH.copy(scs,[]),bc;$ARRAY.forEach(vizBoxs,function(vizBox){sc=getSC(vizBox.boxContent);if(sc&&$HASH.valarray(sc.cgb).indexOf(cgbKey)>=0){if(parseInt(sc.ct,10)===6){vizKey=vizBox.k;if($ARRAY.find(scs,"pnk",vizKey)<0){res.push({bc:bc,sourceKey:vizKey,control:sc});}}}});return res;},getSourceControls:function getSourceControls(vis,cgbKey){var vizBoxs=vis.parent.children,sc,res=[],bc;$ARRAY.forEach(vizBoxs,function(vizBox){bc=vizBox.boxContent;sc=bc.selectorControl||(bc.findSelectorControl&&bc.findSelectorControl());if(sc&&$HASH.valarray(sc.cgb).indexOf(cgbKey)>=0){res.push({bc:bc,sourceKey:vizBox.k,control:sc});}});return $ARRAY.filter(res,function(ctrl){return Number(ctrl.control.ct)===6;});},clearVisAsFilterAction:function clearVisAsFilterAction(vis,isVisDeleted){var boxContent=vis.boxContent,isVisMap=boxContent.isVisMap,controlNode=boxContent.selectorControl,an=isVisMap?boxContent.getDefnAnForTemplateSelection():vis.defn.an,sourceKey=isVisMap?boxContent.getKeyForTemplateSelection():vis.k,visNodeKeys=isVisMap?boxContent.getAllLayerKeys(true):[vis.k];return clearVisAsFilterActionHandler.call(this,vis,controlNode,an,sourceKey,visNodeKeys,isVisDeleted);},clearVisAsFilterActionForMapLayer:function clearVisAsFilterActionForMapLayer(vizBox,layerXtab,isLayerDeleted){var controlNode=layerXtab.findSelectorControl(),an=layerXtab.node.defn.an,sourceKey=layerXtab.k,visNodeKeys=[layerXtab.k];return clearVisAsFilterActionHandler.call(this,vizBox,controlNode,an,sourceKey,visNodeKeys,isLayerDeleted);},getVisualizationByKey:function getVisualizationByKey(key){var vizStack=this.getVIComponent($VI_COMPONENT_TYPES.VIZ_CONTENT),ret;$ARRAY.forEach(vizStack.children,function(panel){$ARRAY.forEach(panel.children,function(viz){if(key===viz.k){ret=viz;return false;}});if(ret){return false;}});return ret;},associatedNodesUpdate:function associatedNodesUpdate(viss){var m=this,layoutKey=m.getCurrentLayoutKey(),layout;return{callback:{success:function(res){res.defn.layouts.some(function(l){layout=l;return l.k===layoutKey&&l.loaded;});$ARRAY.forEach(viss,function(vis){var visDefn=layout.units[vis.k];if(visDefn){if($HASH.isEmpty(visDefn.an)){delete vis.defn.an;}else{vis.defn.an=visDefn.an;}}});}},extras:{style:{params:{treesToRender:1}}}};},redoFilterAssociations:function redoFilterAssociations(isNewCGB,controlKey,sourceKey,targetKey,removeCGB,addCGB){return{act:"redoFilterAssociations",isNewCGB:isNewCGB,controlKey:controlKey,sourceKey:sourceKey,targetKey:targetKey,removeCGB:removeCGB,addCGB:addCGB,partialUpdate:{nodes:[sourceKey,targetKey]}};},setFilterType:function setFilterType(update,vis,type){update.addActions({act:"setVisFilterType",nodeKey:vis.k,type:type});},getTargetFilterKeys:function getTargetFilterKeys(sourceViz){var filterKeys=[],layout=this.getCurrentLayoutDef(),vizContent=this.getVizContentPanel(layout.k),cgbMap=layout.cgbMap,units=layout.units,bc=sourceViz.boxContent,sc=bc&&bc.selectorControl,sourceDefn=units[sourceViz.k],an=sourceDefn&&sourceDefn.an,tgtKey=an&&an.length&&an[0].k;if(sc){$HASH.forEach(sc.cgb,function(tgt){if(units[tgt]){filterKeys.push(tgt);filterKeys.push(cgbMap[tgt]);}});}if(tgtKey&&vizContent&&$ARRAY.some(vizContent.children,function(vizBox){return vizBox.k===tgtKey;})){filterKeys=filterKeys.concat($ARRAY.map(an,function(node){return node.k;}));}return filterKeys;},getSourceFilterKeys:function getSourceFilterKeys(targetKey,onlyMetricFilters){var filterKeys=[],filterStack=this.getVIComponent($VI_COMPONENT_TYPES.FILTER_STACK),layout=this.getCurrentLayoutDef(),vizContent=this.getVizContentPanel(layout&&layout.k),units=layout&&layout.units,src,pnk,cgbKeys=$HASH.forEach(layout&&layout.cgbMap,function(val,key){if(val===targetKey){src=units[key];if(src&&src.scs){$ARRAY.forEach(src.scs,function(sc){pnk=sc.pnk;if(units[pnk]){filterKeys.push(pnk);}});}}});if(filterStack){if(onlyMetricFilters){$ARRAY.forEach(filterStack.getFilters(),function(lFilter){if(lFilter.node.defn.srct===TYPE_METRIC){filterKeys.push(lFilter.k);}});}else{filterKeys.push(filterStack.k);}}if(vizContent){vizContent.children.forEach(function(vizBox){var tks=(vizBox.getTargetKeys&&vizBox.getTargetKeys())||[];if($ARRAY.indexOf(tks,targetKey)>-1&&$ARRAY.indexOf(filterKeys,vizBox.k)===-1){filterKeys.push(vizBox.k);}});}return filterKeys;},getAddVisActions:function getAddVisActions(parentKey,nodeKey,widget,props){var actions=[],style,unit;actions.push(this.getCopyEmptyTemplateAction(nodeKey,parentKey));props='<props ><widgetProps ><fmt ><visStyle value="GraphMatrixVisualizationStyle" ></visStyle><Shape value="Bar" ></Shape><Subtype value="Automatic" ></Subtype></fmt></widgetProps></props>';if(widget){actions.push({act:"updateTemplate",keyContext:nodeKey,actions:[{act:"createDefaultDropZones",nodeKey:nodeKey,treeType:1,datasetType:3,widgetType:widget.type}]});style=widget.style;unit={k:nodeKey,defn:{t:$RW_UNIT_TYPES.GRID}};actions.push(this.getUnitChangeVizAction(style,this.getWidgetClassNameByStyle(style,widget.type),unit,props,widget.extraFormatting));}return actions;},getClearVisFilterAction:function getClearVisFilterAction(nodeKey,targets,ctrlKey,deleteCGBKeys){var ac={act:"clearVisAsFilter",nodeKey:nodeKey,controlKey:ctrlKey,cgbNodeKeys:deleteCGBKeys};if(targets){ac.associatedNodes=targets;}return{act:"clearVisAsFilter",nodeKey:nodeKey};},getSetVisAsFilterAction:function getSetVisAsFilterAction(nodeKey,ctrlKey,updateNodeKeys,targetKeys,CGBKeys){return{act:"setVisAsFilter",sourceKey:nodeKey,targetKeys:targetKeys,controlKey:ctrlKey||this.getNextKey(),CGBKeys:CGBKeys,showAll:true,fos:true,partialRetrieval:{nodes:$ARRAY.ensureArray(updateNodeKeys)}};}});}());