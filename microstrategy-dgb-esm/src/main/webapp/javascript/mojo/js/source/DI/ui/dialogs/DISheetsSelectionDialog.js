(function(){mstrmojo.requiresCls("mstrmojo.Label","mstrmojo.WidgetList","mstrmojo.HBox","mstrmojo.VBox","mstrmojo.ui.CheckList","mstrmojo.RadioList","mstrmojo.StackContainer","mstrmojo.Editor","mstrmojo.hash","mstrmojo.css");mstrmojo.requiresDescs(373,547,2140,12724,12909,16033);var $ARR=mstrmojo.array,$HASH=mstrmojo.hash,$CSS=mstrmojo.css,HELPER=mstrmojo.DI.DIHelpers,$S=mstrmojo.string;function setSelectAllClass(button,selectCnt,totCnt){$CSS.removeClass(button.domNode,["select-all","unselect-all","select-some"]);if(selectCnt===0){$CSS.addClass(button.domNode,"unselect-all");}else{if(selectCnt===totCnt){$CSS.addClass(button.domNode,"select-all");}else{$CSS.addClass(button.domNode,"select-some");}}}function shouldAlertWarning(items){var result={shouldAlert:false,num:0},jsonType=".json",tableNumber=50;$ARR.forEach(items,function(item){var fileName=item.n,fileType=fileName&&fileName.substr(fileName.lastIndexOf("."));if((fileType&&fileType.toLowerCase())===jsonType&&item.sheets&&item.sheets.length>=tableNumber){var subset=$ARR.filter(item.sheets,function(sheet){return sheet.selected===true;});if(subset&&subset.length>=tableNumber){result.shouldAlert=true;result.num+=subset.length;}}});return result;}function alertWarning4JsonFile(tableCount,clickHandler){var msg=mstrmojo.desc(16301,"#numbers# tables were identified in the selected file, which is likely not the expected result. The structure of the JSON file you selected is likely not handled correctly. Please refer to #link# for more information on supported JSON data formats."),docLink="https://community.microstrategy.com/s/article/KB442251-Best-practice-of-JSON-File-Import-in-MicroStrategy-10-4-and-above";msg=msg.replace("#numbers#",tableCount);if(mstrApp.isWorkstation){msg=msg.replace("#link#",'<a onclick="mstrmojo.DI.DIHelpers.createPopupWindow(\'#docLink#\');return false;" href="">KB442251</a>'.replace("#docLink#",docLink));}else{msg=msg.replace("#link#",'<a href="#docLink#" target="_blank">KB442251</a>'.replace("#docLink#",docLink));}mstrmojo.confirm(msg,{confirmBtn:{t:mstrmojo.desc(1442,"OK"),fn:function(){clickHandler();}},cancelBtn:{t:mstrmojo.desc(221,"Cancel")}},{allowHTML:true});}mstrmojo.DI.ui.dialogs.DISheetsSelectionDialog=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.DI.ui.dialogs.DISheetsSelectionDialog",cssClass:"mstrmojo-di-sheets-selection-dialog",title:mstrmojo.desc(12724,"Select Worksheets"),items:null,onBack:mstrmojo.func.emptyFn,onOK:function(){this.close();},noButtonCls:true,children:[{scriptClass:"mstrmojo.HBox",cssClass:"mstrmojo-di-ssd-file-content",alias:"filesAndSheets",colHTML:'<colgroup><col style="width: 200px;"/><col/></colgroup>',children:[{scriptClass:"mstrmojo.VBox",alias:"leftPanel",cssClass:"mstrmojo-di-ssd-left-panel",children:[{scriptClass:"mstrmojo.WidgetList",alias:"fileList",cssClass:"mstrmojo-di-ssd-file-list",selectedIndex:0,itemFunction:function(item,idx,list){var name;if(item.n&&/^hdfs:\/\//.test(item.n)){name=item.n.substring(item.n.lastIndexOf("/")+1);}else{name=item.n;}name=mstrmojo.string.htmlAngles(HELPER.truncate(name,28));var iw=new mstrmojo.Button({text:name,title:mstrmojo.string.encodeHtmlString(item.n),sheets:item.sheets,widget:list,onclick:function(){list.updateSheetsList(item,false);}});return iw;},bindings:{items:"this.parent.parent.parent.items"},onitemsChange:function(){if(this.items&&this.items.length>0){this.set("selectedIndex",0);this.updateSheetsList(this.items[0],true);}},updateSheetsList:function(item,isItemChanged){var sheetsSelectionDialog=this.parent.parent.parent;var rightPanel=this.parent.parent.rightPanel;var sheetsStack=rightPanel.sheets;var sheetsWidget,i,encodeHtmlItem=item.sheets;if(!item.sheets||item.sheets.length<=0){sheetsStack.set("selected",null);rightPanel.fileName.set("text",mstrmojo.desc(12909,"There are no sheets in this file."));return ;}if(sheetsStack.children){for(i=0;i<sheetsStack.children.length;i++){if(sheetsStack.children[i].id===item.id){sheetsWidget=sheetsStack.children[i];}}}$ARR.forEach(encodeHtmlItem,function(item){item.title=$S.encodeHtmlString(item.title)||"";});var defaultSelect={};if(!item.multiSelection){defaultSelect[item.defaultSheetsIndex||0]=true;}else{$ARR.forEach(item.sheets,function(v,idx){defaultSelect[idx]=true;});$ARR.forEach(this.items,function(it){$ARR.forEach(it.sheets,function(sheet){if(sheet.selected===undefined){sheet.selected=true;}});});}if(!sheetsWidget){sheetsWidget=sheetsStack.addChildren([mstrmojo.insert({scriptClass:"mstrmojo.ui.CheckList",cssClass:"mstrmojo-di-ssd-sheets-list",alias:"list",items:encodeHtmlItem,list:item.sheets,id:item.id,multiSelect:item.multiSelection,sheetsSelectionDialog:sheetsSelectionDialog,selectedIndices:defaultSelect,getItemMarkup:function getItemMarkup(){return'<{@tag} class="item {@cls}" idx="{@idx}" style="{@style}" title="{@title}"><span class="text">{@en@n}</span></{@tag}>';},postBuildRendering:function(){if(this._super){this._super();}this.onchange();window.setTimeout((function($this){return function(){$this.disableScroll(true,false);};})(this),0);},onchange:function(){var items=this.items,sel=this.selectedIndices;$ARR.forEach(items,function(item){item.selected=false;});$HASH.forEach(sel,function(v,k){if(k){items[k].selected=v;}});var hasSelected=false;mstrmojo.array.forEach(this.items,function(item){hasSelected=hasSelected||item.selected;});this.parent.parent.parent.parent.btnHbox.selectBtn.set("enabled",hasSelected);var selCnt=Object.keys(sel).length,totCnt=items.length,selectAllButton=$HASH.walk("parent.parent.selectAllButton",this);setSelectAllClass(selectAllButton,selCnt,totCnt);}})])[0];}else{if(isItemChanged){sheetsWidget.set("list",item.sheets);sheetsWidget.set("items",item.sheets);sheetsWidget.set("selectedIndices",defaultSelect);}}var name;if(item.n&&/^hdfs:\/\//.test(item.n)){name=item.n.substring(item.n.lastIndexOf("/")+1);}else{name=item.n;}name=HELPER.truncate(name,42);rightPanel.fileName.set("text",name);sheetsStack.set("selected",sheetsWidget);var selCnt=Object.keys(sheetsWidget.selectedIndices).length,totCnt=sheetsWidget.items.length;setSelectAllClass(rightPanel.selectAllButton,selCnt,totCnt);}}]},{scriptClass:"mstrmojo.VBox",alias:"rightPanel",cssClass:"mstrmojo-di-ssd-right-panel",children:[{scriptClass:"mstrmojo.Label",alias:"fileName"},{scriptClass:"mstrmojo.Button",alias:"selectAllButton",text:mstrmojo.desc(16033,"All worksheets"),cssClass:"select-all-button",cssDisplay:"none",cssText:"",onclick:function(){var fileIndex=$HASH.walk("parent.parent.leftPanel.fileList.selectedIndex",this),list=$HASH.walk("parent.sheets.children."+fileIndex,this),selectedCnt,totCnt;if(list){selectedCnt=Object.keys(list.selectedIndices).length;totCnt=list.items.length;if(selectedCnt===totCnt){list.set("selectedIndices",[]);}else{list.set("selectedIndices",$ARR.map(list.items,function(i){return i.idx;}));}}}},{scriptClass:"mstrmojo.TextBox",cssClass:"mstrmojo-di-ssd-search",cssText:"font-size:10pt;",alias:"searchBox",visible:false,onkeyup:function(){var input=this.value;var items=this.parent.sheets.list.list;var k,index,result=[];for(k=0;k<items.length;k++){index=items[k].n.toLowerCase().search(input.toLowerCase());if(index>-1){result.push(items[k]);}}this.parent.sheets.list.set("items",result);}},{scriptClass:"mstrmojo.StackContainer",cssClass:"mappingpage-bottom",alias:"sheets"}]}]}],buttons:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton hot",text:mstrmojo.desc(547,"Select"),alias:"selectBtn",enabled:true,onclick:function(){var e=this.parent.parent,clickHandler=function(){if(e.onOK){e.onOK();}else{e.close();}},result=shouldAlertWarning(e.items);if(result.shouldAlert){alertWarning4JsonFile(result.num,clickHandler);}else{clickHandler();}}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton",text:mstrmojo.desc(2140,"Cancel"),alias:"backBtn",onclick:function(){var editor=this.parent.parent;if(editor.onBack){editor.onBack();}if(editor&&editor.filesAndSheets&&editor.filesAndSheets.rightPanel&&editor.filesAndSheets.rightPanel.sheets){$ARR.forEach(editor.filesAndSheets.rightPanel.sheets.children,function(child){child&&child.destroy&&child.destroy();});editor.filesAndSheets.rightPanel.sheets.removeChildren();}editor.close();}}],postBuildRendering:function postBuildRendering(){if(this._super){this._super();}var btn=$HASH.walk("filesAndSheets.rightPanel.selectAllButton",this);if(btn){if($HASH.walk("items.0.multiSelection",this)){btn.domNode.style.display="inline-block";}else{btn.domNode.style.display="none";btn.domNode.className+=" none-display";}}},onOpen:function(){if(this.visible&&HELPER.getEnvObj().isWeb()){this.filesAndSheets.rightPanel.sheets.list.updateScrollbars();}}});}());