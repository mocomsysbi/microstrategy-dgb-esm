(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.array","mstrmojo.gmaps.MapEnums","mstrmojo.gmaps.MapUtils","mstrmojo.vi.enums.EnumFilterClearActionType","mstrmojo.vi.enums.EnumVisFilterType");var $HASH=mstrmojo.hash,$ARR=mstrmojo.array,$SelectionHashType=mstrmojo.gmaps.SelectionHashType,$MUTIL=mstrmojo.gmaps.MapUtils,CLEAR_FILTER_TYPE=mstrmojo.vi.enums.EnumFilterClearActionType,VIS_FILTER_TYPE=mstrmojo.vi.enums.EnumVisFilterType,UNIT_SELECT_ALL="OA:(All)";mstrmojo.gmaps._MapDataSelectionHelper=mstrmojo.provide("mstrmojo.gmaps._MapDataSelectionHelper",{_mixinName:"mstrmojo.gmaps._MapDataSelectionHelper",showData:function showData(){var xtab;this.selectionHashType=$SelectionHashType.RMC_LAYER;if(!this.gridData){xtab=this.getXtabForSelection();if(!xtab){xtab=this;}this.gridData=xtab&&xtab.getData();}mstrmojo.vi.ui.ViewDataDialog.open(this.parent,true);},endSelections:function endSelections(){if($MUTIL.isOIVM()){this.selectionHashType=$SelectionHashType.TEMPLATE_SELECTION;this._super();}},raiseGraphicsSelectedEvent:function raiseGraphicsSelectedEvent(){if($MUTIL.isEmbedded()){var mapViewer=this.mapViewer,result=[];mapViewer.forEachGraphicLayer(function(graphicLayer){result.push({key:graphicLayer.key,name:graphicLayer.getLayerName(),graphics:graphicLayer.getSelectedGraphicsInfo()});},true);mstrApp.raiseEvent({name:"graphicsSelected",value:{graphics:result,vizKey:this.k}});}},handleTemplateUnitSelections:function handleTemplateUnitSelections(forceToSend){if(!$MUTIL.isVI()){var mapViewer=this.mapViewer,actions=[];mapViewer.forEachGraphicLayer(function(graphicLayer){graphicLayer.addTemplateUnitSelection(actions);},null,true);actions=this.reorderTemplateSelectionActions(actions);if(actions.length>0&&(!$HASH.equals(actions,this.lastTemplateUnitSelection)||forceToSend)){this.submitTemplateUnitSelection(actions);this.lastTemplateUnitSelection=actions;}}},reorderTemplateSelectionActions:function reorderTemplateSelectionActions(actions){var act4All=[],act4Elements=[];$ARR.forEach(actions,function(action){if(action&&action.eid===UNIT_SELECT_ALL){act4All.push(action);}else{act4Elements.push(action);}});return act4All.concat(act4Elements);},getGraphicLayerForTemplateSelection:function getGraphicLayerForTemplateSelection(){var keyForTemplateSelection=this.getKeyForTemplateSelection(),mapViewer=this.mapViewer;return mapViewer.getGraphicLayer(keyForTemplateSelection);},getGraphicLayerForSelection:function getGraphicLayerForSelection(){var nodeKey,mapViewer=this.mapViewer;switch(this.selectionHashType){case $SelectionHashType.PRIMARY:nodeKey=this.k;break;case $SelectionHashType.TEMPLATE_SELECTION:nodeKey=this.getKeyForTemplateSelection();break;case $SelectionHashType.EDITING_LAYER:nodeKey=this.getEditingGridKey();break;case $SelectionHashType.RMC_LAYER:nodeKey=this.RMCSelectedLayerKey||this.k;break;default:nodeKey=this.k;}return mapViewer&&mapViewer.getGraphicLayer(nodeKey);},getXtabForSelection:function getVisModelForSelection(){var graphicLayer=this.getGraphicLayerForSelection(),xtab=graphicLayer&&graphicLayer.getXtab();return xtab;},getSelectionHash:function getSelectionHash(){var graphicLayer=this.getGraphicLayerForSelection();return graphicLayer&&graphicLayer.getSelectionHash();},getSelectionSize:function getSelectionSize(){var selections=this.getSelectionHash();return(selections&&$HASH.keyarray(selections).length)||0;},getSelectionType:function(){var graphicLayer=this.getGraphicLayerForSelection();return graphicLayer&&graphicLayer.getSelectionType();},getContextMenuSelectionHash:function getContextMenuSelectionHash(){var graphicLayer=this.getGraphicLayerForSelection();return graphicLayer&&graphicLayer.getContextMenuSelectionHash();},getContextMenuSelectionType:function(){var graphicLayer=this.getGraphicLayerForSelection();return graphicLayer&&graphicLayer.getContextMenuSelectionType();},deleteSelectorControl:function deleteSelectorControl(){var key=this.getKeyForTemplateSelection(),data=this.getGridData(key),sc=data.sc;if(sc&&parseInt(sc.ct,10)===6){delete data.sc;}},findSelectorControl:function findSelectorControl(){var key=this.getKeyForTemplateSelection(),data=this.getGridData(key),v=data&&data.sc;if(v&&parseInt(v.ct,10)===6){this.selectorControl=v;this.isMultiSelect=true;}else{delete this.selectorControl;}this.controller=!!this.model?this.model.controller:null;this.sid=data&&data.sid;return this.selectorControl;},isSupportViewFilterForSelection:function isSupportViewFilterForSelection(id){var graphicLayer=this.getGraphicLayerForTemplateSelection();return graphicLayer&&graphicLayer.supportsViewFilterActions(id);},getAssociatedNodes:function getAssociatedNodes(){var graphicLayer=this.getGraphicLayerForTemplateSelection();return graphicLayer&&graphicLayer.getAssociatedNodes();},submitTemplateUnitSelection:function submitTemplateUnitSelection(actions){if($MUTIL.isOIVM()){var events={};$ARR.forEach(actions,function(action){events[action.key]=action;});(mstrApp.docModel||this.parent.model.docModel).slice({events:events});}else{microstrategy.updateManager.add(actions);microstrategy.updateManager.flushAndSubmitChanges();}},getSelectorObjectsFromViewFilter:function getSelectorObjectsFromViewFilter(){var vis=this,mapViewer=vis.mapViewer,selectorObjects={};if(mapViewer){mapViewer.forEachGraphicLayer(function(graphicLayer){var xtab=graphicLayer.getXtab(),layerKey=graphicLayer.key,selectorDatas=xtab&&xtab.getSelObjsFromVFHandler&&xtab.getSelObjsFromVFHandler();if(selectorDatas&&selectorDatas.length>0){selectorObjects[layerKey]=selectorDatas;}},false,true);}return selectorObjects;},getSelectorObjectsFromTemplateLimit:function getSelectorObjectsFromTemplateLimit(){var vis=this,mapViewer=vis.mapViewer,selectorObjects={};if(mapViewer){mapViewer.forEachGraphicLayer(function(graphicLayer){var xtab=graphicLayer.getXtab(),layerKey=graphicLayer.key,selectorDatas=xtab&&xtab.getSelObjsFromTemlateLimitHandler&&xtab.getSelObjsFromTemlateLimitHandler();if(selectorDatas&&selectorDatas.length>0){selectorObjects[layerKey]=selectorDatas;}},false,true);}return selectorObjects;},getFilterMenuPairs:function getFilterMenuPairs(selectorObjects){var me=this,menuPair=[],mapViewer=this.mapViewer,CLEAR_STR=mstrmojo.desc(2827,"Clear"),menuStringForLayer,graphicLayer,layerName,ctxt,layerKey,selectorDatas,selectorDatasLen,selectorData,menuTtpStringForLayer,index;for(layerKey in selectorObjects){selectorDatas=selectorObjects[layerKey];graphicLayer=mapViewer.getGraphicLayer(layerKey);layerName=graphicLayer&&graphicLayer.getLayerName();selectorDatasLen=selectorDatas.length;for(index=0;index<selectorDatasLen;index++){selectorData=selectorDatas[index];menuStringForLayer=me.getSelectorExpr(selectorData);menuTtpStringForLayer=me.getSelectorExpr(selectorData,true);ctxt=layerKey+";"+index;if(menuStringForLayer){menuPair.push({menuString:layerName+": "+CLEAR_STR+' "'+menuStringForLayer+'"',menuTtpString:layerName+": "+CLEAR_STR+' "'+menuTtpStringForLayer+'"',ctxt:ctxt});}}}return menuPair;},filterMenuHandler:function filterMenuHandler(ctxt,callback){var ctxts,layerKey,index,controller=this.controller,selectionInfos;switch(ctxt.type){case CLEAR_FILTER_TYPE.CLEAR_KEEP_ONLY:ctxt=ctxt.idx;if(ctxt&&ctxt.split&&ctxt.split instanceof Function){ctxts=ctxt.split(";");if(ctxts&&ctxts.length===2){layerKey=ctxts[0];index=parseInt(ctxts[1],10);}}else{index=ctxt;}selectionInfos=this.constructSelectionInfos&&this.constructSelectionInfos(null,true,index,layerKey);controller.applyKeepOnlyForMutilTemplate(selectionInfos,callback);break;case CLEAR_FILTER_TYPE.CLEAR_ALL:selectionInfos=this.constructSelectionInfos&&this.constructSelectionInfos(null,true,-1,undefined);controller.clearFiltersForVisMultipleTemplate(selectionInfos,[VIS_FILTER_TYPE.KEEP_ONLY,VIS_FILTER_TYPE.LINKING,VIS_FILTER_TYPE.DRILLING],callback);break;case CLEAR_FILTER_TYPE.CLEAR_ADV_QUALIFICATION:selectionInfos=this.constructSelectionInfos&&this.constructSelectionInfos(null,true,undefined,undefined);controller.clearFiltersForVisMultipleTemplate(selectionInfos,[VIS_FILTER_TYPE.ADV_QUALIFICATION],callback);break;case CLEAR_FILTER_TYPE.CLEAR_KEEP_ONLY_AND_LINKING:selectionInfos=this.constructSelectionInfos&&this.constructSelectionInfos(null,true,undefined,undefined);controller.clearFiltersForVisMultipleTemplate(selectionInfos,[VIS_FILTER_TYPE.KEEP_ONLY,VIS_FILTER_TYPE.LINKING],callback);break;case CLEAR_FILTER_TYPE.CLEAR_LINKING:selectionInfos=this.constructSelectionInfos&&this.constructSelectionInfos(null,true,undefined,undefined);controller.clearLinkingMultiFilter(ctxt,selectionInfos,callback);break;case CLEAR_FILTER_TYPE.CLEAR_DRILLING:selectionInfos=this.constructSelectionInfos&&this.constructSelectionInfos(null,true,undefined,undefined);controller.clearFiltersForVisMultipleTemplate(selectionInfos,[VIS_FILTER_TYPE.DRILLING],callback);break;default:break;}},hasKeepOnly:function hasKeepOnly(selectorObjects){return selectorObjects===null||Object.keys(selectorObjects).length>0;},genSelectionMapping:function genSelectionMapping(){var mapViewer=this.mapViewer,selectionMap={};if(mapViewer){mapViewer.forEachGraphicLayer(function(graphicLayer){selectionMap[graphicLayer.key]={selType:graphicLayer.getSelectionType(),selHash:graphicLayer.getSelectionHash()};});}return selectionMap;}});}());