(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.css","mstrmojo.dom","mstrmojo.expr","mstrmojo.hash","mstrmojo.string","mstrmojo.vi.ui.HierarchyElementsCheckListBrowser","mstrmojo.vi.ui.ElementsBrowser","mstrmojo.ValidationTextBox","mstrmojo.DateTextBox","mstrmojo.Label","mstrmojo._IsList","mstrmojo.rw.ConditionWalkProviderBase","mstrmojo.ui.Pulldown","mstrmojo.ui.SearchablePulldown","mstrmojo.ui.CheckList","mstrmojo.ui.ColumnContainer","mstrmojo.vi.ui.DatasetUnitMenuUtils");var ARRAY=mstrmojo.array,CSS=mstrmojo.css,STR=mstrmojo.string,EXPR=mstrmojo.expr,$DOM=mstrmojo.dom,$HASH=mstrmojo.hash,EXPRTYPE=EXPR.ET,ET2TGT=EXPR.ET2TGT,D2FD=EXPR.DTP2FN_DTP,FN=EXPR.FN,FNT=EXPR.FNT,FN_MRP=EXPR.FN_MRP,CWPB=mstrmojo.rw.ConditionWalkProviderBase,onWalkChange=CWPB.onWalkChange,updateList=CWPB.updateList,fnItem=CWPB.fnItem,isComparisonAllowed=CWPB.isComparisonAllowed,clearInvalid=CWPB.clearInvalid,shouldShowCst=CWPB.shouldShowCst,getConstant=CWPB.getConstant,getConstantDataType=CWPB.getConstantDataType,getConstantValue=CWPB.getConstantValue,isDATE=CWPB.isDATE,getCstListCompareTgts=CWPB.getCstListCompareTgts,fmJson=CWPB.fmJson,allowedTargetTypes=CWPB.allowedTargetTypes,updatePulldown=CWPB.updatePulldown,onWalkChangeThroughPulldown=CWPB.onWalkChangeThroughPulldown,$TP=mstrmojo.mstr.EnumDSSXMLObjectTypes,$STP=mstrmojo.mstr.EnumDSSXMLObjectSubTypes,$DS_UTILS=mstrmojo.vi.ui.DatasetUnitMenuUtils,$HASLTTP=mstrmojo.ui._HasListTooltip;var fnUpdateColumnContainer=mstrmojo.ui.ColumnContainer.prototype.updateColumnContainer;var META_TP=mstrmojo.meta.TP,META_STP=mstrmojo.meta.STP,BROWSE_OBJECTS_ID="-2";var CHOOSE_ELEMENT_METHOD={SELECT:0,QUALIFICATION:1};var MQ_LEVEL={TEMPLATE_LEVEL:0,DATASET_LEVEL:1};var FN_GROUP_TYPE={VALUE:1,RANK_PERCENTAGE:2,BOTH:3};var FORM_SELECTION_NOT_AE=0,FORM_SELECTION_AE=1;var COLUMN_HEIGHT=368,COLUMN_CONTENT_HEIGHT=COLUMN_HEIGHT-5,COLUMN_PADDING_TO_BOTTOM=5,LABEL_HEIGHT=26,WSVI_ELEMENT_PADDING=10;var ET2FNS={};ET2FNS[EXPRTYPE.MQ]={key:"metricFns",def:EXPR.METRIC_FNS};ET2FNS[EXPRTYPE.MC]={key:"metricFns",def:EXPR.METRIC_FNS};ET2FNS[EXPRTYPE.AQ]={key:"formFns",def:EXPR.FORM_FNS};ET2FNS[EXPRTYPE.AL]={key:"formFns",def:EXPR.FORM_FNS};ET2FNS[EXPRTYPE.AC]={key:"formFns",def:EXPR.FORM_FNS};ET2FNS[EXPRTYPE.AE]={key:"elemFns",def:EXPR.ELEM_FNS};function getPdInnerHTML(item){return'<div class="unit item '+$DS_UTILS.getUnitCssClass(item)+'">'+STR.encodeHtmlString(item.n)+"</div>";}function getPulldownTextInnerHTML(item){var selectedNode=this.selectedNode;ARRAY.forEach(selectedNode.classList,function(item){if(item&&STR.startsWith(item,"ic")){CSS.removeClass(selectedNode,item);}});CSS.addClass(selectedNode,"unit");CSS.addClass(selectedNode,"item");CSS.addClass(selectedNode,$DS_UTILS.getUnitCssClass(item));return STR.encodeHtmlString(item.n);}function updateCstList(p,idx){var model=p.model,et=model.et,targetId=model&&model[ET2TGT[et]]&&model[ET2TGT[et]][p.columnWalk.target.itemIdField||"did"],targetForm=model&&model.fm,targetFmDataType=targetForm&&targetForm.dtp,isFnCompare=isComparisonAllowed(model,p.ets);if(this.targetsLastMod&&this.targetsLastMod===p.targetsLastMod&&targetId&&targetId===this._lastTargetId&&this.lastFmDtp===targetFmDataType&&this.lastFnTp===isFnCompare&&this.lastEt===et){return ;}var attMxPulldown=this.attMxPd,attMxLbl=this.attMxLabel;if(!isFnCompare){attMxPulldown.set("items",[]);attMxLbl.set("visible",false);attMxPulldown.set("visible",false);}else{var lblTxt=model.a?mstrmojo.desc(518,"Attribute"):model.m?mstrmojo.desc(517,"Metric"):"",targets=getCstListCompareTgts(p),cstUnit=model[ET2TGT[model.et]+(2+idx)],selectedIdx=cstUnit?ARRAY.find(targets,"did",cstUnit.did):undefined;attMxLbl.set("text",lblTxt);attMxPulldown.items=targets;attMxPulldown.selectedIndex=selectedIdx>=0?selectedIdx:undefined;attMxPulldown.refresh();attMxLbl.set("visible",true);attMxPulldown.set("visible",true);}this._lastTargetId=targetId;this.lastFnTp=isFnCompare;this.lastFmDtp=targetFmDataType;this.lastEt=et;this.targetsLastMod=p.targetsLastMod;}function updateCst(me,idx){me.updating=true;var conditionWalk=me.parent.parent.parent,show=shouldShowCst(conditionWalk,idx);if(!show){me.updating=false;return ;}var model=conditionWalk.model||{},c=getConstant(conditionWalk,idx),dtp=getConstantDataType(conditionWalk,c),v=getConstantValue(conditionWalk,idx),fn=model.fn,isListFn=EXPR.fn_List(fn,model.fnt),isDateType=isDATE[dtp];var inputWidget=isDateType?me.dateInput:me.txtInput;var widgetToHide=isDateType?me.txtInput:me.dateInput;widgetToHide.set("visible",false);inputWidget.updating=true;inputWidget.set("dtp",dtp);inputWidget.set("isList",isListFn);inputWidget.set("value",v);inputWidget.set("visible",true);inputWidget.set("hint",isListFn?mstrmojo.desc(8191,"value1## value2## ...## valueN").replace(/##/g,mstrConfig.listSep||";"):"");inputWidget.updating=false;if(fn===1||fn===2){inputWidget.constraints.min=0;}if(inputWidget.clearValidation&&inputWidget.inputNode){inputWidget.clearValidation();}updateCstList.call(me,conditionWalk,idx);switch(model.et){case EXPRTYPE.AQ:case EXPRTYPE.AL:case EXPRTYPE.MQ:me.attMxPd.set("selectedIndex",undefined);break;}me.updating=false;}function onCstChg(){var d=this.parent,w=d.parent.parent.parent,v=(this.isValid&&this.isValid())||(!this.isValid&&!STR.isEmpty(this.value)),m=w.model;w["invalid"+d.cstIndex]=!v;if(!this.updating){this.updating=true;if(m){m.edit(d.alias,{v:this.value,dtp:this.dtp});}this.updating=false;}if(w.updateOkBtn){w.updateOkBtn();}}function getTooltipText(item){if(item){var n=item.n,dsName=item.dsName;if(n&&dsName){return'<div class="name">'+STR.encodeHtmlString(n,true)+'</div><div class="dsc dataset">'+STR.encodeHtmlString(dsName,true)+"</div>";}else{return $HASLTTP.getTooltipText.call(this,item);}}}function cstJson(props){return $HASH.copy(props,{scriptClass:"mstrmojo.Box",children:[{scriptClass:"mstrmojo.ValidationTextBox",alias:"txtInput",cssText:"width: 100%",required:true,constraints:{trigger:mstrmojo.validation.TRIGGER.VALUESET},onValid:onCstChg,onInvalid:onCstChg,onClearValidation:clearInvalid,size:6,visible:true},{scriptClass:"mstrmojo.DateTextBox",alias:"dateInput",cssDisplay:"inline-block",required:true,constraints:{trigger:mstrmojo.validation.TRIGGER.ALL},onValid:onCstChg,onInvalid:onCstChg,onClearValidation:clearInvalid,calendarToBody:true,autoFormat:false,calConfig:{onmousedown:function(evt){$DOM.stopPropogation(evt.hWin,evt.e);}},visible:true},{scriptClass:"mstrmojo.Label",cssClass:"attMxLabel",text:"Attribute",alias:"attMxLabel"},{scriptClass:"mstrmojo.ui.Pulldown",alias:"attMxPd",itemIdField:"did",cssClass:"conditionWalk-attMxPd",onSelectedItemChange:function onSelectedItemChange(newItem,oldItem){if(this.hasRendered){var walk=this.parent.parent.parent.parent;onWalkChangeThroughPulldown.call(this,walk,newItem,"c0");}},getPulldownTextInnerHTML:getPdInnerHTML,getPopupListConfig:function getPopupListConfig(){var config=mstrmojo.ui.Pulldown.prototype.getPopupListConfig.call(this);config.showTooltipForLargeText=false;config.getItemProps=function getItemProps(item,idx){var props=mstrmojo._IsList.getItemProps.call(this,item,idx);props.title="";props.style=this.parent.itemCssText||"";props.addCls("unit "+$DS_UTILS.getUnitCssClass(item));return props;};config.getTooltipText=getTooltipText;return config;}}],update:function(){updateCst(this,this.cstIndex);this.parent.updateScrollbars();},postCreate:function(){this._super();this.parent.parent.parent.attachEventListener("updateTargets",this.id,function(){this.update();});}});}function isRecursiveAttribute(attInfo){return attInfo[META_TP]===$TP.Attribute&&attInfo[META_STP]===$STP.AttributeRecursive;}function isRAConsolidation(conInfo){var isConsolidation=conInfo[META_TP]===$TP.Consolidation&&conInfo[META_STP]===$STP.ConsolidationManaged,docModel=mstrApp&&mstrApp.rootCtrl&&mstrApp.rootCtrl.docCtrl&&mstrApp.rootCtrl.docCtrl.model;if(isConsolidation&&docModel&&docModel.findUnitInDataSet){conInfo=docModel.findUnitInDataSet(conInfo.did);if(conInfo&&conInfo.attId){return isRecursiveAttribute(docModel.findUnitInDataSet(conInfo.attId));}}}mstrmojo.vi.ui.ConditionWalkProvider=mstrmojo.declare(mstrmojo.rw.ConditionWalkProviderBase,null,{scriptClass:"mstrmojo.vi.ui.ConditionWalkProvider",getTargetNodeProps:function getTargetNodeProps(){var me=this;return{alias:"target",isAttribute:false,isMetric:false,showChooseMethod:true,showLevel:false,children:[{scriptClass:"mstrmojo.Label",cssClass:"baseOn",text:mstrmojo.desc(15115,"Based on")},{scriptClass:"mstrmojo.ui.SearchablePulldown",alias:"target",itemIdField:"did",cssClass:"conditionWalk-target",allowEmptyText:true,onRender:function(){if(this.hasRendered){this[this.editableSlot].setAttribute("placeholder",mstrmojo.desc(10,"Search"));}},postCreate:function(){this.parent.parent.parent.attachEventListener("updateTargets",this.id,function(){this.update();});},getEditableTextInnerHTML:function getEditableTextInnerHTML(){var selectedIndex=this.selectedIndex,popupList=this.getPopupList(),items=popupList&&popupList.items;if(this.selectedNode&&items&&items[selectedIndex]){return this.getPulldownTextInnerHTML(items[selectedIndex]);}else{return"";}},update:function update(){var conditionWalk=this.parent.parent.parent,model=conditionWalk.model,targetsLastMod=conditionWalk.targetsLastMod,et=model&&model.et;if(this.lastModel!==model||this.targetsLastMod!==targetsLastMod){this.lastModel=model;this.targetsLastMod=targetsLastMod;var tgs=conditionWalk.targets,ets=conditionWalk.ets;if(ets&&tgs&&tgs.length){var ok=allowedTargetTypes(conditionWalk.ets);tgs=ARRAY.filter(tgs,function(item){return ok[item[META_TP]];});}var t=model&&model[ET2TGT[et]],objectBrowsingEnabled=conditionWalk.objectBrowsingEnabled,isInitObjectBrowsing=objectBrowsingEnabled&&(!tgs||ARRAY.find(tgs,"did",BROWSE_OBJECTS_ID)===-1);if(et===EXPRTYPE.ANDOR){t=model.a||model.m||null;}this.set("objectBrowsingEnabled",objectBrowsingEnabled);if(isInitObjectBrowsing){tgs=tgs||[];var browseText=mstrmojo.desc(15346,"Browse Metadata Objects...");tgs.push({did:BROWSE_OBJECTS_ID,n:browseText,t:-1,title:browseText});}updatePulldown(this,true,EXPR.getSortedObjectsByTypeGroup(tgs),t);if((!objectBrowsingEnabled||isInitObjectBrowsing)&&!t){this.set("isEditing",true);this.openPopup(this.getPopupList());}}},onitemSelected:function onitemSelected(item,index){if(this.hasRendered){var walk=this.parent.parent.parent;onWalkChangeThroughPulldown.call(this,walk,item,"target");}},preisEditingChange:function preisEditingChange(){if(this.hasRendered&&this.isEditing){var selectedNode=this.selectedNode;this._lastText=selectedNode.innerHTML;CSS.removeClass(selectedNode,"unit");CSS.removeClass(selectedNode,"item");}return true;},postisEditingChange:function postisEditingChange(){if(this.hasRendered&&!this.isEditing){var selectedNode=this.selectedNode;if(this._lastText){selectedNode.innerHTML=this._lastText;CSS.addClass(selectedNode,"unit");CSS.addClass(selectedNode,"item");}else{selectedNode.innerHTML="";}delete this._lastText;}},onPopupWidgetClosed:function onPopupWidgetClosed(config){if(this.objectBrowsingEnabled&&config&&config.pressingEnter){var popupList=this.getPopupList(),oldItems=popupList._oldItems,text=this.text;if(oldItems&&text){var selectedItem=ARRAY.filterOne(oldItems,function(item){return item.n===text;});selectedItem=selectedItem||popupList.items[0];if(!selectedItem){delete popupList._oldItems;popupList.set("items",oldItems);return ;}if(selectedItem.did===BROWSE_OBJECTS_ID){var conditionWalk=this.parent.parent.parent;conditionWalk.browse(this);delete popupList._oldItems;popupList.set("items",oldItems);return ;}}}mstrmojo.ui.SearchablePulldown.prototype.onPopupWidgetClosed.call(this,config);},getPulldownTextInnerHTML:getPulldownTextInnerHTML,getPopupListConfig:function getPopupListConfig(){var config=mstrmojo.ui.SearchablePulldown.prototype.getPopupListConfig.call(this);config.showTooltipForLargeText=false;config.getItemProps=function getItemProps(item,idx){var props=mstrmojo._IsList.getItemProps.call(this,item,idx);props.title="";props.style=this.parent.itemCssText||"";props.addCls("unit "+$DS_UTILS.getUnitCssClass(item));props.addCls(item.isInvalid?"invalid":"");return props;};config.doItemSelect=function doItemSelect(item,evt){if(item.did===BROWSE_OBJECTS_ID){var pulldown=this.parent;pulldown.parent.parent.parent.browse(pulldown);}else{if(item.isInvalid){var me=this;window.setTimeout(function(){me.showTooltip({target:me._getItemNode(item._renderIdx)},window);},0);}else{mstrmojo._IsList.doItemSelect.call(this,item,evt);}}};config.showTooltip=function showTooltip(e,win){if(!this.hasOpenTooltip&&!(this._lastOpened&&this._lastOpened.visible)){var target=$DOM.eventTarget(win,e),item=this.getItemFromTarget(target);if(item&&item.isInvalid){var node=this.getItemNodeFromTarget(target),position=$DOM.position(node);this.richTooltip={content:mstrmojo.desc(15391,"This is an invalid object. Please contact your administrator for more information."),cssClass:"vi-warning triangle-warning vi-tooltip-C A-center",left:position.x+168,top:position.y};mstrmojo._HasTooltip.showTooltip.call(this,e,win);}else{this.constructor.prototype.showTooltip.call(this,e,win);}}};config.tooltipOpenDelay=700;config.getTooltipText=getTooltipText;return config;}},{scriptClass:"mstrmojo.Label",cssClass:"baseOn",text:mstrmojo.desc(15116,"Choose elements by"),alias:"attrLabel",bindings:{visible:"this.parent.isAttribute && this.parent.showChooseMethod"}},{scriptClass:"mstrmojo.ui.Pulldown",alias:"chooseMethodPd",items:null,visible:false,bindings:{visible:"this.parent.isAttribute && this.parent.showChooseMethod"},onitemSelected:function onitemSelected(item){var fm=this.parent.fm,fmCssCls=fm&&fm.cssClass,fmDom=fm&&fm.domNode,selectedItem=fm&&fm.selectedItem;if(item.v===CHOOSE_ELEMENT_METHOD.SELECT){CSS.toggleClass(fmDom,"forms",false);if((fmCssCls||"").indexOf(" forms")>-1){fm.cssClass=fmCssCls.replace(" forms","");}if((!selectedItem)||selectedItem.did!=="1,22"&&selectedItem.did!=="1,57"){fm.singleSelectByField("1,22","did");}}else{CSS.toggleClass(fmDom,"forms",true);if((fmCssCls||"").indexOf(" forms")===-1){fm.cssClass=(fmCssCls||"")+" forms";}if(!selectedItem||selectedItem.did==="1,22"||selectedItem.did==="1,57"){fm.singleSelect(2);}}fm.updateScrollbars();},update:function update(){var conditonWalk=this.parent.parent.parent,conditionModel=conditonWalk&&conditonWalk.model,disableElementsBrowsing=conditonWalk&&conditonWalk.disableElementsBrowsing,attr=conditionModel&&conditionModel.a,disEB=attr&&disableElementsBrowsing&&disableElementsBrowsing(attr);if(disEB){this.set("items",[{n:mstrmojo.desc(15117,"Qualification on"),v:CHOOSE_ELEMENT_METHOD.QUALIFICATION}]);}else{if(attr.ndetype===1){this.children[0].showTooltipForLargeText=false;this.set("items",[{n:mstrmojo.desc(15118,"Selecting in list"),v:CHOOSE_ELEMENT_METHOD.SELECT,ttpDisabled:true},{n:mstrmojo.desc(15117,"Qualification on"),v:CHOOSE_ELEMENT_METHOD.QUALIFICATION,cls:"disabled",dsbld:true,ttp:mstrmojo.desc(16184,"This method is not available for this object type.")}]);}else{this.set("items",[{n:mstrmojo.desc(15118,"Selecting in list"),v:CHOOSE_ELEMENT_METHOD.SELECT},{n:mstrmojo.desc(15117,"Qualification on"),v:CHOOSE_ELEMENT_METHOD.QUALIFICATION}]);}}var selectedItem=this.getSelectedItem();switch(conditionModel.et){case EXPRTYPE.AQ:case EXPRTYPE.AL:case EXPRTYPE.AC:if(!selectedItem||selectedItem.v!==CHOOSE_ELEMENT_METHOD.QUALIFICATION){this.selectItemByField("v",CHOOSE_ELEMENT_METHOD.QUALIFICATION);}break;default:if(!selectedItem||selectedItem.v!==CHOOSE_ELEMENT_METHOD.SELECT){this.selectItemByField("v",CHOOSE_ELEMENT_METHOD.SELECT);}break;}}},fmJson({scriptClass:"mstrmojo.ui.CheckList",alias:"fm",fmPost:"",itemIdField:"did",filter:false,isFirstFm:true,multiSelect:false,minimumSelectCnt:0,hasDummyLabel:false,lastAttrId:null,height:COLUMN_CONTENT_HEIGHT-LABEL_HEIGHT*4-WSVI_ELEMENT_PADDING*2-COLUMN_PADDING_TO_BOTTOM+"px",onchange:function onchange(evt){onWalkChange.call(this,evt,"fm");},bindings:{visible:"this.parent.isAttribute && this.parent.showChooseMethod"},onvisibleChange:function(){this.lastAttrId=null;}}),{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(15119,"Output Level"),cssClass:"baseOn",alias:"metricLabel",bindings:{visible:"this.parent.isMetric && this.parent.showLevel"}},{scriptClass:"mstrmojo.ui.Pulldown",alias:"outputLevelPd",items:[{n:mstrmojo.desc(12178,"Visualization level"),v:MQ_LEVEL.TEMPLATE_LEVEL},{n:mstrmojo.desc(13519,"Dataset level"),v:MQ_LEVEL.DATASET_LEVEL}],selectedIndex:0,bindings:{visible:"this.parent.isMetric && this.parent.showLevel"},onSelectedItemChange:function onSelectedItemChange(newItem,oldItem){var conditionWalk=this.parent.parent.parent,condition=conditionWalk.condition;condition.level=newItem.v;}}],updateColumnContainer:function updateColumnContainer(){this.target.update();var columnWalk=this.parent,conditionWalk=columnWalk.parent,conditionModel=conditionWalk.model,et=conditionModel&&conditionModel.et,idx=this.idx,next=this.next,attr=conditionModel&&conditionModel.a,fm=conditionModel&&conditionModel.fm,inRelation=conditionWalk&&conditionWalk.inRelation;if(et){switch(et){case EXPRTYPE.AQ:case EXPRTYPE.AL:case EXPRTYPE.AC:case EXPRTYPE.AE:case EXPRTYPE.ANDOR:if(attr){this.set("isMetric",false);this.set("isAttribute",true);var disableElementsBrowsing=conditionWalk.disableElementsBrowsing,disEB=attr&&disableElementsBrowsing&&disableElementsBrowsing(attr),attrInfo=conditionWalk.getAttributeInfo(attr.did),isHierarchy=isRecursiveAttribute(attrInfo)||isRAConsolidation(attrInfo),disableHierarchyLevel=conditionWalk.disableHierarchyLevel;if(isHierarchy){conditionModel.et=EXPRTYPE.AE;this.set("showChooseMethod",false);}var oldType=(conditionModel.etWas&&conditionModel.etWas===EXPRTYPE.AE)?FORM_SELECTION_AE:FORM_SELECTION_NOT_AE,newType=FORM_SELECTION_NOT_AE;if(conditionModel.et===EXPRTYPE.AE&&!disEB){newType=FORM_SELECTION_AE;}if(oldType!==newType||newType===FORM_SELECTION_NOT_AE||!columnWalk.next){columnWalk.removeTrailingContainer(idx);if(newType===FORM_SELECTION_NOT_AE&&fm){columnWalk.addNextColumn(me.getFnNodeProps());}else{if(newType===FORM_SELECTION_AE){columnWalk.addNextColumn(me.getEsNodeProps(isHierarchy,disableHierarchyLevel));}}}conditionWalk.condition.level=MQ_LEVEL.DATASET_LEVEL;var fmList=this.fm;fmList.updating=true;fmList.update();this.chooseMethodPd.update();fmList.updating=false;}break;case EXPRTYPE.MQ:case EXPRTYPE.MC:if(conditionModel.m){this.set("isMetric",true);this.set("isAttribute",false);var mdxDM=conditionWalk.isMDXDM(conditionModel.m.did),level=conditionWalk.condition.level,showLimits=conditionWalk.editor&&conditionWalk.editor.showLimits;if(level!==MQ_LEVEL.TEMPLATE_LEVEL&&level!==MQ_LEVEL.DATASET_LEVEL){level=conditionWalk.condition.level=showLimits?MQ_LEVEL.TEMPLATE_LEVEL:MQ_LEVEL.DATASET_LEVEL;}if(!inRelation&&!mdxDM&&showLimits){this.set("showLevel",true);this.outputLevelPd.set("selectedIndex",level);}else{this.set("showLevel",false);}if(!(next&&next.fn)){this.parent.insertAndRemoveTrailing(idx,me.getFnNodeProps());}}break;case EXPRTYPE.R:case EXPRTYPE.F:case EXPRTYPE.XML:this.set("isMetric",false);this.set("isAttribute",false);conditionWalk.condition.level=MQ_LEVEL.DATASET_LEVEL;this.parent.removeTrailingContainer(idx);break;}}else{this.set("isMetric",false);this.set("isAttribute",false);}fnUpdateColumnContainer.call(this);},setupScrollNodes:function setupScrollNodes(){this.scrollNode=null;}};},getEsNodeProps:function getEsNodeProps(isHierarchy,disableHierarchyLevel){var clazz=isHierarchy?"HierarchyElementsCheckListBrowser":"ElementsBrowser",children=[{scriptClass:"mstrmojo.vi.ui."+clazz,alias:"es",height:COLUMN_CONTENT_HEIGHT-5+"px",disableLevel:disableHierarchyLevel,update:function update(){var conditionWalk=this.parent.parent.parent,model=conditionWalk.model,a=model&&model.a,show=!!a&&!a.ilk;if(!show){return ;}this.set("ifDataSource",conditionWalk.getIfDataSource());this.onUpdateBrowseElementsParams=function(params){conditionWalk.onUpdateBrowseElementsParams(params);};if(!model.es){model.es=[];}if(isHierarchy){var attrInfo=conditionWalk.getAttributeInfo(a.did);$HASH.copyProps(["t","st"],attrInfo,a);if(attrInfo&&attrInfo.attId){attrInfo=conditionWalk.getAttributeInfo(attrInfo.attId);}$HASH.copyProps(["fs","lvfs"],attrInfo,a);}else{if(!a.fs){$HASH.copyProps(["fs"],conditionWalk.getAttributeInfo(a.did),a);}}var sel=$HASH.clone(isHierarchy?model.data:model.es);this.set("attribute",a);this.set("selectedItems",sel);},onBrowseElementsFailure:function onBrowseElementsFailure(){var attributeId=this.attributeId,columnWalk=this.parent.parent,conditionWalk=columnWalk.parent,errorAttr=ARRAY.filterOne(conditionWalk.targets,function(item){return item.did===attributeId;});errorAttr.isInvalid=true;errorAttr.cls=(errorAttr.cls||"")+" invalid";conditionWalk.set("model",{et:5,isNew:true,defaultETAttr:5});var targetPulldown=columnWalk.target.target;targetPulldown.openPopup(targetPulldown.getPopupWidget());},onItemsSelectionChange:function onItemsSelectionChange(evt){var conditionWalk=this.parent.parent.parent,model=conditionWalk.model;model.edit(isHierarchy?"data":"es",evt);}}];return{alias:"es",children:children,cssClass:"lastStage",updateColumnContainer:function updateColumnContainer(){this.es.update();},setupScrollNodes:function setupScrollNodes(){this.scrollNode=null;}};},getFnNodeProps:function getFnNodeProps(){var me=this,children=[{scriptClass:"mstrmojo.Label",cssClass:"baseOn",text:mstrApp.isWSStyling?mstrmojo.desc(15006,"Operator"):mstrmojo.desc(9579,"Condition")},{scriptClass:"mstrmojo.ui.Pulldown",alias:"fnTypePulldown",items:[{n:mstrmojo.desc(15302,"By Value"),v:FN_GROUP_TYPE.VALUE},{n:mstrmojo.desc(15303,"By Rank"),v:FN_GROUP_TYPE.RANK_PERCENTAGE}],onSelectedItemChange:function onSelectedItemChange(newItem,oldItem){var column=this.parent;column.fn.update();}},fmJson({scriptClass:"mstrmojo.ui.CheckList",alias:"fn",multiSelect:false,allowUnlistedValues:false,hideCheckMark:true,itemIdField:"did",onchange:function onchange(evt){onWalkChange.call(this,evt);},update:function(){var column=this.parent,conditionWalk=column.parent.parent,m=conditionWalk.model||{},et=m.et,dtp,show=false,fns,sel,fnTypeToDisplay=FN_GROUP_TYPE.BOTH;switch(et){case EXPRTYPE.AE:show=!!m.a;break;case EXPRTYPE.AQ:case EXPRTYPE.AC:case EXPRTYPE.AL:show=!!(m.fm&&m.fm.did);dtp=show?m.fm.dtp:null;break;case EXPRTYPE.MQ:case EXPRTYPE.MC:show=!!m.m;dtp=show?EXPR.METRIC_DTP:null;fnTypeToDisplay=column.fnTypePulldown.getSelectedItem().v;break;}if(!show){return ;}var fndtp=D2FD[dtp];if((this.lastEt!==et)||(this.lastFnDtp!==fndtp)||(this.lastFnTypeToDisplay!==fnTypeToDisplay)){this.lastEt=et;this.lastFnDtp=fndtp;this.lastFnTypeToDisplay=fnTypeToDisplay;var lookin=et?ET2FNS[et]:null,k=lookin&&lookin.key;fns=(k&&conditionWalk[k])||lookin.def||[];if(typeof (fns)==="object"){fns=fns[fndtp]||fns["*"];}if(fnTypeToDisplay!=FN_GROUP_TYPE.BOTH){fns=ARRAY.filter(fns,function(item){var isRankOrPercentage=item.tp===FNT.PER||item.tp===FNT.RANK;return fnTypeToDisplay===FN_GROUP_TYPE.RANK_PERCENTAGE?isRankOrPercentage:!isRankOrPercentage;});}sel=fnItem(m.fn,m.fnt||1);sel=ARRAY.filterOne(fns,function(item){return item.did===(sel&&sel.did);});updateList(this,show,fns,sel);if(!sel){this.set("selectedIndex",0);}}this.parent.updateScrollbars();}})];return{alias:"fn",children:children,updateColumnContainer:function updateColumnContainer(){var columnWalk=this.parent,conditionWalk=columnWalk.parent,model=conditionWalk.model,fn=model&&model.fn,fnt=model&&model.fnt,et=model&&model.et,next=this.next,isFnNull=fn===FN.IS_NULL||fn===FN.IS_NOT_NULL,showFnTypePulldown=(et===EXPRTYPE.MC||et===EXPRTYPE.MQ);this.changeFnTypePdVisibility(showFnTypePulldown);if(showFnTypePulldown){this.fnTypePulldown.getPopupList().singleSelectByField((fnt===FNT.RANK||fnt===FNT.PER)?FN_GROUP_TYPE.RANK_PERCENTAGE:FN_GROUP_TYPE.VALUE,"v");}else{this.fn.update();}if(fn&&isFnNull){columnWalk.removeTrailingContainer(this.idx);}else{if(fn&&!(next&&next.c0)){columnWalk.insertAndRemoveTrailing(this.idx,me.getC0NodeProps());}}next=this.next;if(next){next.updateColumnContainer();}},changeFnTypePdVisibility:function changeFnTypePdVisibility(visible){this.fnTypePulldown.set("visible",visible);var fnListHeight=COLUMN_CONTENT_HEIGHT-COLUMN_PADDING_TO_BOTTOM-LABEL_HEIGHT;if(visible){fnListHeight-=(LABEL_HEIGHT+WSVI_ELEMENT_PADDING);}this.fn.set("height",fnListHeight+"px");},setupScrollNodes:function setupScrollNodes(){this.scrollNode=null;}};},getC0NodeProps:function getC0NodeProps(){var me=this;return{alias:"c0",children:[{scriptClass:"mstrmojo.Label",cssClass:"baseOn",text:mstrmojo.desc(527,"Value")},cstJson({alias:"c0",cstIndex:0}),{scriptClass:"mstrmojo.Label",alias:"btwn",cssClass:"btwn",text:mstrmojo.desc(308,"and"),visible:false},cstJson({alias:"c1",cstIndex:1,visible:false}),{alias:"browseLink",scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-walkstep-browse",text:mstrmojo.desc(7926,"Browse..."),onclick:function(){this.parent.parent.parent.browse(this.parent.c0);},visible:false},fmJson({scriptClass:"mstrmojo.ui.CheckList",alias:"fm2",fmPost:2,itemIdField:"did",filter:false,multiSelect:false,minimumSelectCnt:0,hasDummyLabel:false,height:COLUMN_CONTENT_HEIGHT-LABEL_HEIGHT*4-WSVI_ELEMENT_PADDING*2-COLUMN_PADDING_TO_BOTTOM+"px",onchange:function onchange(evt){onWalkChange.call(this,evt,"fm2");}})],updateColumnContainer:function updateColumnContainer(){this.c0.update();var columnWalk=this.parent,conditionWalk=columnWalk.parent,model=columnWalk.parent.model,fn=model&&model.fn,showBtwn=fn===FN.BETWEEN||fn===FN.NOT_BETWEEN||fn===FN_MRP.BETWEEN||fn===FN_MRP.BETWEEN_DESCENDING,showFm2=fn===FN.EQUAL||fn===FN.NOT_EQUAL||fn===FN.GREATER||fn===FN.GREATER_EQUAL||fn===FN.LESS||fn===FN.LESS_EQUAL,idx=this.idx,next=this.next;this.browseLink.set("visible",conditionWalk.objectBrowsingEnabled&&isComparisonAllowed(model,conditionWalk.ets));this.btwn.set("visible",showBtwn);var c1Widget=this.c1;c1Widget.set("visible",showBtwn);if(showBtwn){c1Widget.update();}else{if(model.c1){model.edit("c1",{v:null,dtp:null,skipET:true},true);}}if((!model.a)&&model.m&&this.domNode){CSS.addClass(this.domNode,"lastStage");}var fm2List=this.fm2;if(model.a2&&showFm2){fm2List.update();fm2List.set("visible",true);}else{fm2List.set("visible",false);}fnUpdateColumnContainer.call(this);},setupScrollNodes:function setupScrollNodes(){this.scrollNode=null;}};},browseObjs:function browseObjs(me,ch,p){var containerNodePos=$DOM.position(me.parent.containerNode);p=p||{};p.x=containerNodePos.x+40;p.y=containerNodePos.y;this._super(me,ch,p);var browser=me.ob.browser,docModel=me.parent.opener.docModel,alias=ch.alias,et=me.model.et;docModel.controller.rootCtrl.loadDataProvider(function(dataProvider){if(alias==="target"||et===EXPRTYPE.AQ){browser.rootFolder={did:"6F55FB47F9974EABA18CB0C5FF46785C"};}else{if(et===EXPRTYPE.MQ){browser.rootFolder={did:"E0CCB9CF22104A489CBE78D974AFD19E"};}}browser.model=docModel;browser.set("dataProvider",dataProvider);browser.set("opened",true);});}});}());