(function(){mstrmojo.requiresCls("mstrmojo.dom","mstrmojo.hash","mstrmojo.array");var $D=mstrmojo.dom,$ARR=mstrmojo.array;function getChildrenCells(cInfo){var model=this.model,gts=model.data.gts,tInfo=model.getCellTitleInfo(cInfo).title,es=[],roots=[],childrenCells=[];function treeTraversal(root){childrenCells.push(root);(root.ch||[]).forEach(function(ch){treeTraversal(ch);});}if(gts){es=$ARR.filterOne(gts.row.concat(gts.col),function(title){return title.id===tInfo.id;}).es;es.forEach(function(e){delete e.ch;});es.forEach(function(e,idx,es){var prt=es[e.p_index];if(model.compareElementsId(e.id,cInfo._e.id)){roots.push(e);}if(prt){if(prt.ch){prt.ch.push(e);}else{prt.ch=[e];}}});roots.forEach(function(root){treeTraversal(root);});}return childrenCells;}mstrmojo.vi.ui.rw._XtabRA=mstrmojo.provide("mstrmojo.vi.ui.rw._XtabRA",{_mixinName:"mstrmojo.vi.ui.rw._XtabRA",_highlightTimer:null,highlightRAcells:function highlightRAcells(cInfo,setClearTimer){var me=this;if(this.allowRAcellsHighlight()){return ;}this.resetRAcellsHighlight();this.highlightGroupCells(this.getRACellGroups(cInfo));if(setClearTimer){this._highlightTimer=window.setTimeout(function(){me.clearGroupHighlights();},1000);}},resetRAcellsHighlight:function resetRAcellsHighlight(){if(this.allowRAcellsHighlight()){return ;}if(this._highlightTimer){window.clearTimeout(this._highlightTimer);this._highlightTimer=null;}this.clearHighlights();},allowRAcellsHighlight:function allowRAcellsHighlight(){return $D.isIE||$D.isIEW3C;},onclick:function onclick(evt){var target=evt.getTarget&&evt.getTarget();if(target&&target.hasAttribute("rabtn")){var me=this,model=this.model,cell=target&&$D.findAncestorByName(target,"td",true,this.viewport),cInfo=this.getCellForNode(cell);this.highlightRAcells(cInfo);var action=model.getRAExpandAction(cInfo,this.sid),cb={success:function(){me.highlightRAcells(cInfo,true);}};if(this.isCustomSort){this.delegateToActionMgr(action,this.getCallbackForRACollapseExpand(cInfo));}else{this.controller.submitTemplateUpdates(this,action,cb,null,null,true);}}else{this._super(evt);}},raExpandAll:function raExpandCollapseAll(data,isExpandAll){var action=this.model.getRAExpandAllAction(data.id,isExpandAll);if(this.isCustomSort){this.delegateToActionMgr(action);}else{this.controller.submitTemplateUpdates(this,action,null,null,null,true);}},raExpandDescendants:function raExpandDescendants(data){var action=this.model.getRAExpandAction(data,this.sid,true);if(this.isCustomSort){this.delegateToActionMgr(action,null,null,{needDataReady:true});}else{this.controller.submitTemplateUpdates(this,action,null,null,null,true);}},getRACellGroups:function getRACellGroups(cInfo){var model=this.model,tInfo=model.getCellTitleInfo(cInfo).title,cellGroup=[],cellGroups=[],childrenCells=getChildrenCells.call(this,cInfo);$ARR.forEach(this.interactiveCellsArray,function(cell){var id=cell._e&&cell._e.id,isAttribute=id&&!cell.hasOwnProperty("mix")&&cell.fi===undefined;if(isAttribute&&model.getCellTitleInfo(cell).title.id===tInfo.id){if(model.compareElementsId(id,cInfo._e.id)||$ARR.find(childrenCells,"id",id)===-1){if(cellGroup.length>0){cellGroups.push(cellGroup);cellGroup=[];}}if($ARR.find(childrenCells,"id",id)>-1){cellGroup.push(cell);}}});if(cellGroup.length>0){cellGroups.push(cellGroup);}return cellGroups;},getAncestors:function getAncestors(titleId,cells){var me=this,cells=cells||$ARR.map(me.selCells,function(cell){return me.getCellForNode(cell);}),gts=this.model.data.gts,es=$ARR.filterOne(gts.row.concat(gts.col),function(tInfo){return tInfo.id===titleId;}).es,ancestors=[],level=cells[0]&&cells[0].lv||0,pIdx,acIdx,maxAcIdx=0;cells.forEach(function(cell,i){pIdx=cell.idx;while(pIdx>=0){if(i>0){acIdx=ancestors.indexOf(pIdx);if(acIdx>=0){maxAcIdx=Math.max(maxAcIdx,acIdx);break;}}else{ancestors.push(pIdx);}pIdx=es[pIdx].p_index;}});return $ARR.map($ARR.get(es,ancestors.slice(maxAcIdx)),function(e,idx){var es=e.id.substring(1).split(";");return{id:es[1]+":"+es[0],n:e.n,level:level-maxAcIdx-idx};});}});}());