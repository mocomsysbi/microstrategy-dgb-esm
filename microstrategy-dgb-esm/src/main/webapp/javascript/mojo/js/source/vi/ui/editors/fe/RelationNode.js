(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.array","mstrmojo.css","mstrmojo.string","mstrmojo.fe.RelationNode","mstrmojo.fe.RelationFilterExprTree","mstrmojo.mstr.EnumDSSXMLObjectTypes","mstrmojo.mstr.EnumNodeDimty","mstrmojo.Box","mstrmojo.ui.Pulldown","mstrmojo.Label","mstrmojo.vi.ui.toolbars.TitleToolbar","mstrmojo.vi.ui.toolbars._HasToolbar");mstrmojo.requiresDescs(2790,5895,5896,7931,12036,12037,15121,15122);var HASH=mstrmojo.hash,ARR=mstrmojo.array,OBJECT_TYPE=mstrmojo.mstr.EnumDSSXMLObjectTypes,DIMTY=mstrmojo.mstr.EnumNodeDimty,CSS=mstrmojo.css,STR=mstrmojo.string,getAttrSetText=function(me){var d=me.data,dmy=d.dmy&&d.dmy.uts||[],len=dmy.length,txt=[],i,setText;for(i=0;i<len;i++){txt.push(STR.encodeHtmlString(dmy[i].n));}setText=txt.join(", ");return'<span class="mstrmojo-text" title="'+setText+'">'+setText+"</span>";};var getSetOfText=function(){var str=mstrmojo.desc(2790,"Set of ##"),pre=str.split("##")[0];var len=pre.length;if(len>0&&pre[len-1]===" "){pre+="&nbsp;";}return pre;};mstrmojo.vi.ui.editors.fe.RelationNode=mstrmojo.declare(mstrmojo.fe.RelationNode,[mstrmojo.vi.ui.toolbars._HasToolbar],{scriptClass:"mstrmojo.vi.ui.editors.fe.RelationNode",markupString:'<div id="{@id}" class="mstrmojo-relation {@cssClass}"  style="position:relative;{@cssText}" mstrAttach:mousedown><div class="mstrmojo-onhoverparent mstrmojo-relation-prefix {@cssClass}"><span class="mstrmojo-textset mstrmojo-relation-prefix-text" mstrAttach:click></span><span class="mstrmojo-onhover-in mstrmojo-andor-tools {@cssClass}"><span class="mstrmojo-indent" onclick="mstrmojo.all[\'{@id}\'].ind()">'+mstrmojo.desc(5895,"Group conditions")+'</span><span class="mstrmojo-outdent" onclick="mstrmojo.all[\'{@id}\'].out()">'+mstrmojo.desc(5896,"Ungroup Conditions")+'</span></span></div><div class="mstrmojo-relationNode"><div class="mstrmojo-relationNode-inf"><div class="mstrmojo-relation-prefix-text">'+getSetOfText()+'</div><div class="mstrmojo-textset"  mstrAttach:click></div><div class="mstrmojo-relation-prefix-text">'+(mstrmojo.desc(2790,"Set of ##").split("##")[1]||"")+'</div><div class="mstrmojo-relation-postfix-text">'+mstrmojo.desc(15121,"filtered by")+'</div><div class="mstrmojo-relation-related-by-box"></div><div class="mstrmojo-relation-toolbar"></div><img class="mstrmojo-del" src="../images/1ptrans.gif" title="'+mstrmojo.desc(7931,"Delete condition")+'"onclick="mstrmojo.all[\'{@id}\'].del()" /></div><div class="mstrmojo-relation-childTreeNode" style="position:relative;"></div></div></div>',markupSlots:{prefixHoverNode:function(){return this.domNode.firstChild;},prefixNode:function(){return this.domNode.firstChild.firstChild;},relationNode:function(){return this.domNode.lastChild;},textNode:function(){return this.domNode.childNodes[1].firstChild.childNodes[1];},relatedByBoxNode:function(){return this.domNode.childNodes[1].firstChild.childNodes[4];},toolbarNode:function(){return this.domNode.childNodes[1].firstChild.childNodes[5];},containerNode:function(){return this.domNode.childNodes[1].childNodes[1];}},markupMethods:{onprefixedAndOrEditableChange:function(){CSS.toggleClass(this.prefixNode,["editable"],this.prefixedAndOrEditable);},onselectedChange:function(){CSS.toggleClass(this.relationNode,["selected"],this.selected);},ondataChange:function(){this.prefixNode.innerHTML=this.andOrTxt();this.textNode.innerHTML=getAttrSetText(this);}},children:[{scriptClass:"mstrmojo.fe.RelationFilterExprTree",alias:"childTree",ignoreLayout:true,dropZone:false,draggable:false,nodeClassMap:{14:mstrmojo.fe.AndOrNode,ph:mstrmojo.fe.DynamicNode,"*":mstrmojo.fe.ConditionNode},onNew:function(inf){this.parent.tree.onNew(inf);},getItemConfig:function(item,idx,widget){var config=mstrmojo.fe.RelationFilterExprTree.prototype.getItemConfig.call(this,item,idx,widget),t=widget.tree||widget;return HASH.copy({tree:t,rootTree:this.parent.tree,noRelation:true,inRelation:true,onremove:function(){if(this.rootTree&&this.rootTree.onremove){this.rootTree.onremove();}},onadd:function(){if(this.rootTree&&this.rootTree.onadd){this.rootTree.onadd();}}},config);},prenodeclick:function(evt){if(!evt||!evt.part){return ;}var t=this.rootTree;if(t&&t.onnodeclick&&this.editable){evt.editor=t.editor;t.onnodeclick.call(this,evt);}}},{scriptClass:"mstrmojo.Box",alias:"relBox",slot:"relatedByBoxNode",cssClass:"RelatedBy-Box",cssDisplay:"inline-block",children:[{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(12036,"Related by"),cssClass:"Label",cssDisplay:"inline-block"},{scriptClass:"mstrmojo.ui.Pulldown",alias:"relPd",cssClass:"Pulldown",cssDisplay:"inline-block",isHostedWithin:false,allowHTML:false,onitemSelected:function onitemSelected(item){var relationNode=this.parent.parent,nodeData=relationNode.data,newGuide=null;if(this.selectedIndex>0){newGuide={n:item.n,did:item.did,t:item.t||OBJECT_TYPE.Metric,st:item.st||1024};}nodeData.dmt=DIMTY.NodeDimtyOutputLevel;nodeData.dmy=nodeData.dmy||{};var relation=nodeData.relation=nodeData.relation||{};if(newGuide){relation.guide=newGuide;nodeData.useSchema=false;}else{delete relation.guide;delete relation.rsTp;delete relation.joTp;delete relation.paTp;delete relation.erTp;nodeData.useSchema=true;}relationNode.set("data",nodeData);}}]},{scriptClass:"mstrmojo.vi.ui.toolbars.TitleToolbar",slot:"toolbarNode",alias:"toolbar",visible:true,hasContextMenuButton:true,cssClass:"relation-toolbar",cssDisplay:"inline-block"}],_set_data:function(n,v){var ret=this._super(n,v);var nodeData=this.data,showRelation=!nodeData.m,relatedByPulldown=this.relBox.relPd,metrics=ARR.filter(this.tree.editor.targetMetrics,function(mx){return !mx.um;}),relatedByItems=[{n:mstrmojo.desc(12037,"System Default"),t:-1,did:"default"}].concat(metrics);this.relBox.set("visible",showRelation);if(showRelation){var idx=0;if(nodeData.relation&&nodeData.relation.guide){var guide=nodeData.relation.guide;idx=ARR.find(relatedByItems,"did",guide.did);}if(idx!==relatedByPulldown.selectedIndex){relatedByPulldown.set("items",relatedByItems);relatedByPulldown.set("selectedIndex",idx>=0?idx:0);}}return ret;},updateToolbar:function updateToolbar(cfg){var me=this;if(this._super){cfg=this._super(cfg);}cfg.addMenuItem(mstrmojo.desc(15122,"Convert to Condition"),"convert",function(){me.parent.removeSet(me);});cfg.isHostedWithin=false;return cfg;}});}());