(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.hash","mstrmojo.num","mstrmojo.gm.GMEnums","mstrmojo.VisUtility","mstrmojo.gm.GMUtility","mstrmojo.ngm.NewGMController","mstrmojo.ngm._NewGMPropertyHandler","mstrmojo.ngm.NewGMInteractivity","mstrmojo.ngm.NewGMProperty","mstrmojo.vi.ui.rw._XtabDE","mstrmojo.ngm.NewGMProperty","mstrmojo._VizSelectionHelper","mstrmojo.gm._SupportGraphMatrixBrushesAndHighlights");mstrmojo.requiresClsP("mstrmojo.vi.ui.rw","_HasVisSelections","selectors._IsMultiUnitControl","selectors._BrushesAndHighlights");mstrmojo.requiresClsP("mstrmojo.ui.menus","ToolbarEditorConfig","MenuConfig","_HasMenuPopup");var $MOJO=mstrmojo,$ARR=mstrmojo.array,$HASH=mstrmojo.hash,$DOM=mstrmojo.dom,$VISUTILS=$MOJO.VisUtility,$VIZ=$MOJO.vi.viz,$GM=$MOJO.gm,$NGM=$MOJO.ngm,$VIZ_STYLES=$VIZ.EnumVizStyles,GRAPH_MATRIX_STYLE=$VIZ_STYLES.GRAPH_MATRIX,$VIZ_TEMPLATES=$VIZ.EnumVisualizationTemplates,$DZ_ID=$VIZ.EnumDSSDropZones,$CDZ_ENUM=mstrmojo.vi.models.CombineDropZonesModel.EnumDropZones,$WRAP=$MOJO.func.wrapMethods,CHART_TYPE=$GM.EnumGraphType,SUBTYPE=$GM.EnumNGMSubtype,GMUTIL=$GM.GMUtility,PRP_SHAPE=$GM.EnumShape,ENUM_XML_TAG=$GM.WidgetPropertyTag,ENUM_FORMAT_TAG=$GM.FormatingPropertyTag,ENUM_FITMODES=$GM.EnumContainerFitModes,VLINE_THICKNESS=1,HLINE_THICKNESS=1,VALINE_THICKNESS=1,HALINE_THICKNESS=1,PT_PX_RATIO=0.75,BUBBLEFILTERTHRESHOLD=200,PRP_GRID_LINE=$GM.EnumGridLines,NGM_GRID_LINE=$GM.EnumNGMGridLines,GHOST_IMG_UTILS=mstrmojo.vi.ui.rw.GhostImageContainer;var GM_VIS_NAMES={barchart:mstrmojo.desc(11820,"Bar Chart"),linechart:mstrmojo.desc(8121,"Line Chart"),areachart:mstrmojo.desc(11821,"Area Chart"),bubblechart:mstrmojo.desc(11822,"Bubble Chart"),piechart:mstrmojo.desc(11823,"Pie Chart"),combochart:mstrmojo.desc(11824,"Combo Chart"),histogram:mstrmojo.desc(350,"Histogram"),boxplot:mstrmojo.desc(3156,"Boxplot"),waterfall:mstrmojo.desc(5594,"Waterfall")};var TEXT_ANCHOR=38;var TEXT_ENDING=16;var LEGEND_INCREMENTAL_THRESHOLD=20;var TRANSFORM="transform",getTranslateString=function(x,y,noPX){if(noPX){return"translate("+x+","+y+")";}else{return"translate("+x+"px,"+y+"px)";}};function transformSVG(svg,x,y){svg.attr("transform","translate("+x+","+y+")");}function parseTranslateString(transformString){return parseTransformString(transformString,"translate");}function parseRotationString(transformString){return parseTransformString(transformString,"rotate");}function parseTransformString(transformString,transformation){var splitter=(mstrmojo.dom.isEdge||mstrmojo.dom.isIE||mstrmojo.dom.isIEW3C)?" ":",",startString=transformation+"(",startIndex=transformString.indexOf(startString),isInString=startIndex!==-1;if(!isInString){return{x:null,y:null};}var xIndex=startIndex+startString.length,yIndex=transformString.indexOf(splitter,xIndex),endIndex=transformString.indexOf(")",xIndex);if(yIndex===-1){yIndex=endIndex;}return{x:+(transformString.substring(xIndex,yIndex)),y:+(transformString.substring(yIndex+1,endIndex))||0};}function cmdMgr(me){return me.model.controller.cmdMgr;}function checkTemplateAndDropzone(){var me=this,data=me.getData(),dz=data.dz,gsi=data.gsi;if(!this.excludeData&&!!data.eg){return true;}var rows=gsi.rows,cols=gsi.cols,gridMetricElements;[cols,rows].forEach(function(titles){if(!gridMetricElements&&titles){var lastTitle=titles[titles.length-1];if(lastTitle&&lastTitle.did==="-1"){gridMetricElements=gsi.mx;}}});var dzNameArray=["Rows","Columns","SizeBy","AngleBy","SliceBy","ColorBy","XAxis","YAxis","BreakBy","AdditionalMetrics"],pass=true;$ARR.forEach(dzNameArray,function(name){var dropzone=dz[name],templateMetric;if(dropzone){templateMetric=dropzone.TemplateMetric;if(templateMetric){$ARR.forEach(templateMetric,function(metric){pass=pass&&($ARR.find(gridMetricElements,"did",metric.id)!==-1);});}}});return pass;}function updateDropZoneInfo(modelData){var dz=modelData.dz;if(!dz){dz=modelData.dz={};}var dzItems=["Rows","Columns","XAxis","YAxis","BreakBy","ColorBy","SizeBy","SliceBy","AdditionalMetrics","AngleBy","visProp"];$ARR.forEach(dzItems,function(item){if(!dz[item]){dz[item]={};}});if(!dz.visProp.fmt){dz.visProp.fmt={};}}function initProperties(fmt,propertyModel,templateObjectMapping){propertyModel.clearCachedXMLDoc();propertyModel.updateDefaults(this.getDefaultProperties(),fmt);propertyModel.setTemplateObjectMapping(templateObjectMapping);propertyModel.consumeJsonFmt(fmt);propertyModel.initFromXML();}function checkViewFilter(modelData,xtabModel,gmCtr){var gts=modelData.gts,supportViewFilter=true,supportViewFilterPool=gmCtr.supportViewFilterPool={};$ARR.forEach(gts.row,function(u){var id=u.id,tp;if(id&&id!==""){tp=xtabModel.supportsViewFilterActions(u.id);if(!tp){supportViewFilter=false;}supportViewFilterPool[u.id]=tp;}});$ARR.forEach(gts.col,function(u){var id=u.id,tp;if(id&&id!==""){tp=xtabModel.supportsViewFilterActions(u.id);if(!tp){supportViewFilter=false;}supportViewFilterPool[u.id]=tp;}});gmCtr.supportViewFilter=supportViewFilter;}function updateToolbarIfNeeded(forceUpdate){var gmCtr=this.GMController,chtInfo=gmCtr.getChartInfo(),currentChartType;if(chtInfo.isABL){currentChartType=0;}else{if(chtInfo.isBubbleOrScatter){currentChartType=1;}else{currentChartType=2;}}if(forceUpdate||(this.lastChartType!==undefined&&currentChartType!==this.lastChartType)){this.raiseEvent({name:"regenerateToolbar"});}this.lastChartType=currentChartType;}function getPersistWidgetPropertyAction(lXML){return{act:"setProperty",nodeKey:this.getData().k,prs:"FormattingWidget",pri:4,v:GMUTIL.replaceSpecialChars(lXML)};}function firstChildNextSibling(node){var lastChild;(node.children&&node.children||[]).forEach(function(child,i){child=firstChildNextSibling(child);if(i){lastChild=lastChild.nextSibling=child;}else{lastChild=node.firstChild=child;}});return node;}function getFCNSRoot(tree,depth){var root={children:[]};for(var key in tree){root.children.push(tree[key]);}cut(root,depth);return firstChildNextSibling(root);}function cut(node,depth){if(depth--){node.children.forEach(function(child){cut(child,depth);});}else{delete node.children;}}function checkSingleChart(layouter){return layouter._rct+layouter._cct<=2;}function ptToPx(pt){return pt&&Math.ceil(parseInt(pt,10)/72*96);}function getModebarMode(layouter){var isMobile=mstrmojo.dom.isMobile,width=layouter.getWidgetWidth(),MODE=ngm.Modebar.MODE;if(isMobile){if(width<212){return MODE.MINI;}else{if(width<550){return MODE.COMPACT;}else{return MODE.NORMAL;}}}else{if(width<168){return MODE.MINI;}else{if(width<400){return MODE.COMPACT;}else{return MODE.NORMAL;}}}}function clearScroll(){var layouter=this.layouter,visDim=layouter.getVisDim(),slots=this._slots;if(visDim.width!==this.getWidth()||visDim.height!==this.getHeight()){layouter.setDeltaX(0);layouter.setDeltaY(0);layouter.setScrollW(0);layouter.setScrollH(0);if(slots){slots.domColContainer.node().scrollLeft=0;slots.domRowContainer.node().scrollTop=0;}}}mstrmojo.ngm.VisNewGraphMatrix=mstrmojo.declare(mstrmojo.VisBase,[mstrmojo.ngm._NewGMPropertyHandler,mstrmojo.vi.ui.rw._HasVisSelections,mstrmojo.ui.menus._HasMenuPopup,mstrmojo.vi.ui.rw.selectors._IsMultiUnitControl,mstrmojo.vi.ui.rw.selectors._BrushesAndHighlights,mstrmojo.gm._SupportGraphMatrixBrushesAndHighlights,mstrmojo.vi.ui.rw._XtabDE,mstrmojo._VizSelectionHelper],{scriptClass:"mstrmojo.ngm.VisNewGraphMatrix",cssClass:"gm-light-theme",noData:false,zIndex:1,formattingMode:false,curSelOptLvl:undefined,handleDndForParentNode:true,avatarCssClass:"mstrmojo-VIUnitList",normalizedIdCache:{},draggable:true,mainContainerNode:"domMainContainer",markupString:'<div id="{@id}" class="{@cssClass}" style="width:{@width}px; position:absolute; height:{@height}px; left:{@left}px; top:{@top}px; z-index:{@zIndex};" ><table><tr><td></td><td></td></tr><tr><td><div class="gm-main-container"></div></td><td></td></tr><tr><td></td><td></td></tr></table></div>',markupSlots:{domMainContainer:function(){return this.domNode.children[0].children[0].children[1].children[0].children[0];},legendTop:function(){return this.domNode.children[0].children[0].children[0].children[0];},legendRight:function(){return this.domNode.children[0].children[0].children[1].children[1];},legendBottom:function(){return this.domNode.children[0].children[0].children[2].children[0];}},init:function(props){this.HTML5PROPS={};this.active=false;this._super(props);if(!window.d3v4){var cachedD3=window.d3;delete window.d3;mstrmojo.requiresDepLib(mstrmojo.getJsRoot()+"libraries/d3.v4.js");window.d3v4=d3;window.d3=cachedD3;}var gmprop=new $NGM.NewGMProperty();this.property=this.addDisposable(gmprop);this.enableDomDommy=false;this.resizenow=true;this.highlights=[];this.rightMouseHighlights=[];this.hoveredShape=[];this.interactor=this.addDisposable(new $NGM.NewGMInteractivity({widget:this}));},redraw:function(){if(this.noData){this.raiseEvent({name:"toggleCtrlOverlay",visible:true,controls:this.getVisEmptyMsgControls()});return false;}var me=this;if(!this.layouter){this.initLayouter();}var visDim=this.layouter.getVisDim();if(visDim.width!==this.getWidth()||visDim.height!==this.getHeight()){if(mstrApp&&mstrApp.isExporting){this.resize();}else{clearTimeout(this.resizeNow);this.resizeNow=setTimeout(function(){me.resize();},250);}return true;}return false;},resize:function(){console.log("resize");var layouter=this.layouter;clearScroll.call(this);layouter.setVisDimWidth(this.getWidth());layouter.setVisDimHeight(this.getHeight());layouter.setWidgetWidth(this.getWidth());layouter.setWidgetHeight(this.getHeight());this.placeLegend();if(this._slots){this.prepareHeaderDimensions();this.setChartLayout();this.sizeRowsAndCols();this.plotPlotly();this.postPlotly();}},destroy:function(){if(this.contextmenuListener){this.contextmenuListener.clear();}if(this._super){this._super();}},update:function update(node){var continueUpdate=this._super(node);if(!continueUpdate){return continueUpdate;}if(!checkTemplateAndDropzone.call(this)){mstrmojo.err({name:"Currently we do not support metric selector targeting to Widget",message:"Attribute/Metric in Dropzone doesn't match Grid Template"});return continueUpdate;}var me=this,xtabModel=me.model,modelData=this.getData(),dz,fmt,gmCtr,property=this.property,docModel=xtabModel.docModel,datasets=docModel.datasets,datasetName,dataset;if($VISUTILS.isOnExpressMode()){this.noData=modelData.eg!==undefined;if(!modelData.eg){this.INVALID_TEMP=GMUTIL.isInvalidTemplate(modelData);}if(this.noData||this.INVALID_TEMP){this.errorMsg=GMUTIL.getInvalidTemplateErrMsg(modelData.eg);return continueUpdate;}}me.sid=modelData.sid;updateDropZoneInfo(modelData);GMUTIL.startTimer({functionName:"VisNewGraphMatrix.update",purpose:"JSON loading & consuming ("+this.k+")"});dz=modelData.dz;fmt=dz.visProp.fmt;var templateUnits,templateObjectMapping={},datasetId,itemId2DsIdMap={};for(datasetName in datasets){if(datasets.hasOwnProperty(datasetName)){dataset=datasets[datasetName];datasetId=dataset.did;templateUnits=dataset.att.concat(dataset.mx);$ARR.forEach(templateUnits,function(item){templateObjectMapping[item.did]=item.t;itemId2DsIdMap[item.did]=datasetId;});}}this.itemId2DsIdMap=itemId2DsIdMap;initProperties.call(this,fmt,property,templateObjectMapping);GMUTIL.destroyDisposable(this,this.GMController);gmCtr=this.GMController=this.addDisposable(new $NGM.NewGMController({view:this,property:this.property,defn:this.defn,firstRes:modelData,xtabModel:xtabModel}));gmCtr.msgCenter={};this.property.updateChartProps(gmCtr.getChartInfo().tp);this.noData=!this.excludeData&&!!modelData.eg;if(!this.noData){gmCtr.postInit();this.absorbGraphStyle();this.resetHTML5Props();checkViewFilter.call(this,modelData,xtabModel,gmCtr);gmCtr.resetChartInfo();updateToolbarIfNeeded.call(this,true);}else{this.errorMsg=modelData.eg;}gmCtr.resetFitTo();GMUTIL.endTimer(undefined,true);return continueUpdate;},isEmpty:function isEmpty(){return(this.GMController.isHistogram&&this.gridInfo&&(!this.gridInfo.mx.length||this.gridInfo.cols.length===1))||this.noData||!this.GMController||this.GMController.isEmptyVis();},getChartInfo:function(){return this.GMController.getChartInfo();},getVisEmptyMsgControls:function getVisEmptyMsgControls(){var gmCtrl=this.GMController,visType=gmCtrl.getAggregatedVisType(),visName=GM_VIS_NAMES[visType]||mstrmojo.desc(5614,"Graph Matrix"),visDesc=GHOST_IMG_UTILS.getVisDesc(visType),attMetric=$VISUTILS.getAttMetricCount.call(this);if(this.excludeData){return[{scriptClass:"mstrmojo.vi.ui.rw.FreezingImageContainer",cssClass:visType,visName:visName,visDropzoneMsg:mstrmojo.vi.ui.rw.FreezingImageContainer.getVisDropzoneMsg(attMetric.attCount,attMetric.metricCount)}];}var mkString;if(this.noData){if(this.model.data.egt===2){mkString=$VISUTILS.getVisEmptyMsg.call(this,"AE_ERROR");}else{mkString=$VISUTILS.getVisEmptyMsg.call(this,"NODATA_OTHERERROR");}}else{mkString=$VISUTILS.getVisEmptyMsg();}if(!(mstrApp&&mstrApp.isWSStyling)||this.noData){return[{scriptClass:"mstrmojo.Container",markupString:mkString,markupSlots:{containerNode:function(){return this.domNode;}}}];}return[{scriptClass:"mstrmojo.vi.ui.rw.GhostImageContainer",cssClass:visType,visName:visName,visDesc:visDesc}];},isClearAllDisabled:function isClearAllDisabled(){var sc=this.findSelectorControl();if(!!sc&&!sc.showall){return true;}return false;},resetSelectionEmptyFlag:function(){this.selectionEmptyFlag=$HASH.isEmpty(this.getSelectionHash());},addToggleToolbarMenuItem:function(cfg){var me=this,fnToggleToolBar=function(visible){me.writeGlobalProperty("showModeBar",visible);me.modebar.setVisibility(visible);};var toolBarButtons=[{n:mstrmojo.desc(170,"Hide toolbar"),cls:"htb",fn:function(){fnToggleToolBar(false);},dsbld:false},{n:mstrmojo.desc(171,"Show toolbar"),cls:"stb",fn:function(){fnToggleToolBar(true);},dsbld:false}];if(!this.getWidgetPropertyValue("showModeBar")){toolBarButtons.reverse();}cfg.addDualStateItem(this.id,toolBarButtons[0],toolBarButtons[1]);},absorbGraphStyle:function(){var me=this,helperContext,chtInfo=this.getChartInfo(),CEU=mstrmojo.chart.common.Utility,gpp=this.defn.gpp,gp=gpp&&gpp.gp,gmp;helperContext={isGridChart:chtInfo.isGrid,isPieShape:chtInfo.isPie,isVertical:chtInfo.dirc===$GM.EnumABLDirection.VERTICAL};var showGraphLevelDatalabel,dataLabelStyle=1,setOnTheFly=false;$ARR.forEach(gp,function(oneProperty){gmp=CEU.transformProperty(oneProperty,0,helperContext);if(gmp&&gmp.Name){setOnTheFly=false;switch(gmp.Name){case"ShowSeriesDataLabel":if(!showGraphLevelDatalabel){showGraphLevelDatalabel=showGraphLevelDatalabel||gmp.Value;}break;case"DataLabel":dataLabelStyle=gmp.Value;setOnTheFly=helperContext.isPieShape;break;default:setOnTheFly=true;break;}if(setOnTheFly&&me.property.readItem(gmp.Name,true)===undefined){me.setWidgetPropertyValue(gmp.Name,gmp.Value);}}});if(showGraphLevelDatalabel===false){me.setWidgetPropertyValue("DataLabel",1);}else{if(showGraphLevelDatalabel===true){me.setWidgetPropertyValue("DataLabel",dataLabelStyle);}}},clientRerenderGraphMatrix:function(){this.update();this.GMController.reRenderGM();},applyHTML5Props:function(styles){VLINE_THICKNESS=parseInt(styles.MATRIX_LINE_V.borderWidth,10)||1;HLINE_THICKNESS=parseInt(styles.MATRIX_LINE_H.borderWidth,10)||1;VALINE_THICKNESS=parseInt(styles.AXIS_LINE_Y.borderWidth,10)||1;HALINE_THICKNESS=parseInt(styles.AXIS_LINE_X.borderWidth,10)||1;var XAXIS_TITLE_HEIGHT=Math.floor((parseInt(styles.AXIS_TITLE_X.fontSize,10)||11)/PT_PX_RATIO+0.5);var YAXIS_TITLE_HEIGHT=Math.floor((parseInt(styles.AXIS_TITLE_Y.fontSize,10)||11)/PT_PX_RATIO+0.5);styles.AXIS_TITLE_X.lineHeight=XAXIS_TITLE_HEIGHT+"px";styles.AXIS_TITLE_Y.lineHeight=YAXIS_TITLE_HEIGHT+"px";},postFillGMControllerStyle:function postFillGMControllerStyle(){var gmCtr=this.GMController,HTML5PROPS=this.HTML5PROPS;gmCtr.rhStyles=HTML5PROPS.RH;gmCtr.chStyles=HTML5PROPS.CH;gmCtr.xTitleStyles=HTML5PROPS.AXIS_TITLE_X;gmCtr.yTitleStyles=HTML5PROPS.AXIS_TITLE_Y;},getNumericAxisOptions:function(isAxisScale){var gmCtr=this.GMController;return gmCtr.getNumericAxisOptions(isAxisScale);},loadNGMStrings:function(){this.tooltipStrings={boxPlot:{maxOutlier:mstrmojo.desc(15795,"Max Outlier"),upperWhisker:mstrmojo.desc(15771,"Upper Whisker"),q3:mstrmojo.desc(15699,"Q3"),median:mstrmojo.desc(15605,"Median"),mean:mstrmojo.desc(15608,"Mean"),sd:mstrmojo.desc(2130,"Standard Deviation"),q1:mstrmojo.desc(15603,"Q1"),lowerWhisker:mstrmojo.desc(15770,"Lower Whisker"),minOutlier:mstrmojo.desc(15794,"Min Outlier"),points:mstrmojo.desc(3704,"Points")},histogram:{bin:mstrmojo.desc(15611,"Bin"),count:mstrmojo.desc(15612,"Count")},waterfall:{subtotal:mstrmojo.desc(9713,"Subtotal")}};this.toolbarStrings={select2d:mstrmojo.desc(15641,"Box Select"),lasso2d:mstrmojo.desc(15642,"Lasso Select"),zoom2d:mstrmojo.desc(15766,"Box Zoom"),pan2d:mstrmojo.desc(15635,"Pan"),zoomIn2d:mstrmojo.desc(5567,"Zoom In"),zoomOut2d:mstrmojo.desc(15636,"Zoom Out"),resetScale2d:mstrmojo.desc(15639,"Reset Axes"),hoverCompareCartesian:mstrmojo.desc(15638,"Show data in category on hover"),NA:mstrmojo.desc(15774,"Not Applicable")};},getWaterfallOptions:function(){var options={},shwTotal=ENUM_FORMAT_TAG.TOTAL_SHOW,totalLabel=ENUM_FORMAT_TAG.TOTAL_LABEL,totalClr=ENUM_FORMAT_TAG.TOTAL_COLOR,posClr=ENUM_FORMAT_TAG.POSITIVE_COLOR,negClr=ENUM_FORMAT_TAG.NEGATIVE_COLOR,shwIntSum=ENUM_FORMAT_TAG.INT_SUM_SHOW,intSumClr=ENUM_FORMAT_TAG.INT_SUM_COLOR,intSumFull=ENUM_FORMAT_TAG.INT_SUM_FULL;options[shwTotal]=this.getWidgetPropertyValue(shwTotal);options[totalLabel]=this.getWidgetPropertyValue(totalLabel);options[totalClr]=GMUTIL.decodeColor(this.getWidgetPropertyValue(totalClr));options[posClr]=GMUTIL.decodeColor(this.getWidgetPropertyValue(posClr));options[negClr]=GMUTIL.decodeColor(this.getWidgetPropertyValue(negClr));options[shwIntSum]=this.getWidgetPropertyValue(shwIntSum);options[intSumClr]=GMUTIL.decodeColor(this.getWidgetPropertyValue(intSumClr));options[intSumFull]=this.getWidgetPropertyValue(intSumFull);return options;},getBoxPlotOptions:function(){var options={},showMean,showOut,jtrType,ptPosType,ptSzType,meanSD=ENUM_FORMAT_TAG.MEAN_SD,shwOutliers=ENUM_FORMAT_TAG.SHOW_OUTLIERS,ptSize=ENUM_FORMAT_TAG.POINT_SIZE,jitter=ENUM_FORMAT_TAG.JITTER,ptPos=ENUM_FORMAT_TAG.POINT_POS;var meanOpts=[false,true,"sd"],outlierOpts=["outliers","all"];showMean=meanOpts[this.getWidgetPropertyValue(meanSD)];showOut=this.getWidgetPropertyValue(shwOutliers);jtrType=this.getWidgetPropertyValue(ENUM_FORMAT_TAG.JTR_TYPE);ptSzType=this.getWidgetPropertyValue(ENUM_FORMAT_TAG.PTSZ_TYPE);ptPosType=this.getWidgetPropertyValue(ENUM_FORMAT_TAG.PTPOS_TYPE);options[meanSD]=showMean;options[shwOutliers]=outlierOpts[showOut];options[jitter]=this.getWidgetPropertyValue(jitter);options[ptSize]=ptSzType===$GM.EnumBoxPlotOutliers.POINT_SIZE?ptSzType:this.getWidgetPropertyValue(ptSize);options[ptPos]=ptPosType===$GM.EnumBoxPlotOutliers.POINT_POS?ptPosType:this.getWidgetPropertyValue(ptPos);return options;},getHistogramOptions:function(){var options={},binsOpt,manualMode,numBinsVal,numBins=ENUM_FORMAT_TAG.NUM_BINS,min,max,binSize,vals,start,end,size;binsOpt=this.getWidgetPropertyValue(ENUM_FORMAT_TAG.CUSTOM_BINS_MODE);manualMode=this.getWidgetPropertyValue(ENUM_FORMAT_TAG.MANUAL_BINS_MODE);numBinsVal=this.getWidgetPropertyValue(numBins);if((binsOpt===$GM.EnumHistogram.MANUAL||binsOpt==="false")&&manualMode===$GM.EnumHistogram.BY_BIN_NUMBER){vals=this.GMController.getExtremes(0,0);min=vals.YMinValue;max=vals.YMaxValue+(numBins>1?Math.min((vals.YMaxValue-min)/(numBinsVal-1)*1e-8,0.01):0.000001);binSize=(max-min)/numBinsVal;options.xBins={start:min,end:max,size:binSize};}else{if(binsOpt===$GM.EnumHistogram.MANUAL||binsOpt==="false"){var ex=this.GMController.getExtremes(0,0);if(this.getWidgetPropertyValue(ENUM_FORMAT_TAG.RANGE_TYPE)===$GM.EnumHistogram.DATASET){vals=this.GMController.getExtremes(0,0);start=vals.YMinValue;end=vals.YMaxValue+(numBins>1?Math.min((vals.YMaxValue-start)/(numBinsVal-1)*1e-8,0.01):0.000001);}else{start=this.getWidgetPropertyValue(ENUM_FORMAT_TAG.XBINS_START);end=this.getWidgetPropertyValue(ENUM_FORMAT_TAG.XBINS_END);}size=this.getWidgetPropertyValue(ENUM_FORMAT_TAG.XBINS_SIZE);min=ex.YMinValue;options.xBins={start:start,end:end,size:size};if(min<end&&min>(start+size)){var binGap=(min-start)/size;var nStart=start+(Math.floor(binGap)*size);options.originalStart=start;options.xBins.start=nStart;}}}return options;},getEnhancedOptions:function(options,gmCtr,i,j){var ori=gmCtr.chartDirection===2?"y":"x",nf=gmCtr.getHeaderFormat(gmCtr["get"+ori.toUpperCase()+"AxisHeaders"](i,j));options=options||{};options.nf=nf;return options;},getHostStructure:function(){return this.GMController.getHostStructure();},getReferenceAxisOption:function(){return this.GMController.getReferenceAxisOption();},isMajorGridLineShow:function(){var drawMajorProp=this.getWidgetPropertyValue(ENUM_FORMAT_TAG.MAJOR_GRID_LINES_SHOW),gmInfo=this.GMInfo,drawMajor=false;if(drawMajorProp===PRP_GRID_LINE.AUTO){drawMajor=gmInfo&&(gmInfo.nRows===1&&gmInfo.nCols===1);}else{if(drawMajorProp===PRP_GRID_LINE.SHOW){drawMajor=true;}}return drawMajor;},getVisType:function getVisType(){var vt=this.getWidgetPropertyValue("visType");if(vt===undefined){var tp=this.GMController.chartType,chartInfo=this.getChartInfo(),VERTICAL_CHART=$GM.EnumABLDirection.VERTICAL;if(chartInfo.isCombo){vt=$VIZ_TEMPLATES.GRAPHCOMBINATIONBARAREADUALAXIS;}else{if(chartInfo.isGrid){var propShape=this.getWidgetPropertyValue(ENUM_XML_TAG.SHAPE);if(propShape===PRP_SHAPE.LINE){tp=CHART_TYPE.LINE;}else{if(propShape===PRP_SHAPE.BAR){tp=CHART_TYPE.BAR;}else{if(propShape===PRP_SHAPE.AREA){tp=CHART_TYPE.AREA;}else{if(propShape===PRP_SHAPE.PIE){tp=CHART_TYPE.BAR;}else{if(propShape===PRP_SHAPE.RING){tp=CHART_TYPE.BAR;}else{tp=CHART_TYPE.BAR;}}}}}}switch(tp){case CHART_TYPE.AREA:vt=(chartInfo.dirc===VERTICAL_CHART)?$VIZ_TEMPLATES.GRAPHMATRIXVERTICALAREAAUTOMATIC:$VIZ_TEMPLATES.GRAPHMATRIXHORIZONTALAREAAUTOMATIC;break;case CHART_TYPE.BAR:vt=(chartInfo.dirc===VERTICAL_CHART)?$VIZ_TEMPLATES.GRAPHMATRIXVERTICALBARAUTOMATIC:$VIZ_TEMPLATES.GRAPHMATRIXHORIZONTALBARAUTOMATIC;break;case CHART_TYPE.LINE:vt=(chartInfo.dirc===VERTICAL_CHART)?$VIZ_TEMPLATES.GRAPHMATRIXVERTICALLINEAUTOMATIC:$VIZ_TEMPLATES.GRAPHMATRIXHORIZONTALLINEAUTOMATIC;break;case CHART_TYPE.SCATTER:case CHART_TYPE.BUBBLE:vt=$VIZ_TEMPLATES.GRAPHMATRIXBUBBLECIRCLEMM;break;case CHART_TYPE.PIE:vt=$VIZ_TEMPLATES.GRAPHMATRIXPIE;break;case CHART_TYPE.GRID:break;}}}return{s:GRAPH_MATRIX_STYLE,vt:vt};},getChartStyle:function(){return this.node.data.visName;},getExistingRefLineOptions:function(){return[];},getSubType:function(){var visType=this.getVisType();switch(visType.vt){case $VIZ_TEMPLATES.GRAPHHORIZONTALBARCLUSTERED:case $VIZ_TEMPLATES.GRAPHVERTICALBARCLUSTERED:case $VIZ_TEMPLATES.GRAPHHORIZONTALAREAABSOLUTE:case $VIZ_TEMPLATES.GRAPHVERTICALAREAABSOLUTE:return 0;case $VIZ_TEMPLATES.GRAPHMATRIXHORIZONTALBARSTACKED:case $VIZ_TEMPLATES.GRAPHMATRIXVERTICALBARSTACKED:case $VIZ_TEMPLATES.GRAPHMATRIXHORIZONTALAREASTACKED:case $VIZ_TEMPLATES.GRAPHMATRIXVERTICALAREASTACKED:return 1;case $VIZ_TEMPLATES.GRAPHMATRIXHORIZONTALBARPERCENT:case $VIZ_TEMPLATES.GRAPHMATRIXVERTICALBARPERCENT:case $VIZ_TEMPLATES.GRAPHMATRIXHORIZONTALAREAPERCENT:case $VIZ_TEMPLATES.GRAPHMATRIXVERTICALAREAPERCENT:case $VIZ_TEMPLATES.GRAPHMATRIXVERTICALWATERFALL:case $VIZ_TEMPLATES.GRAPHMATRIXHORIZONTALWATERFALL:return 2;default:return 0;}},copyRefLineInfoForSwap:function copyRefLineInfoForSwap(){return[];},legendPartialUpdate:function(){this.layouter.setPlotlyLayout("showlegend",this.readGlobalProperty(ENUM_XML_TAG.LEGEND_VISIBLE));},copyTrendLineInfoForSwap:function(){return[];},getPersistAction:function(lXml){lXml=lXml||this.property.getXMLString();return getPersistWidgetPropertyAction.call(this,lXml);},getModelController:function(){return this.model.controller||this.getDocModel().controller;},getXTabRefreshCallBack:function(){return this.getModelController()._getXtabCallback(this);},getUnSilentUndoRedoCallback:function(actions,docModel){var undoRedoCallback=this.getXTabRefreshCallBack(),updateColorMap=false;$ARR.forEach(actions,function(action){if(action.act==="updateElementsPropertiesMap"){updateColorMap=true;return false;}});if(updateColorMap){$WRAP(docModel.getUpdateColorMapCallback(),undoRedoCallback);}return undoRedoCallback;},updateSelections:function(){this.highlight(this.getSelectionType(),this.getSelectionHash());},clearSelectedHighlights:function(){var me=this,chartDiv=me._slots.domChart.node();me.interactor.onPaperClick(me,chartDiv);},raiseEventGlobalPropertyChanged:function(propName,value,option){var obj={name:"propertyChanged",n:propName,opt:option,v:value};this.raiseEvent(obj);return obj;},submitUpdatesAndPersistXML:function submitUpdatesAndPersistXML(actions,requestCallback,silentUndoRedoCallback,suppressData,rqstOnlyDefn,puFiltersConfig){actions=actions||[];if(this.isXMLDirty()){actions.push(this.getPersistAction());}if(actions.length===0){return ;}var me=this,urInfo,puFilters,extra={},docModel=me.getDocModel(),dataService=docModel.getDataService();if(puFiltersConfig){puFilters=this.model.getDataService().newRetrievalKeysConfig();puFilters.addNode(this.k,puFiltersConfig);actions[0].partialRetrieval=puFilters;}if(suppressData){$HASH.copy(mstrmojo.DocDataService.SUPPRESS_DATA,extra);}if(rqstOnlyDefn){$HASH.copy(mstrmojo.DocDataService.REQUEST_ONLY_DEFINITION,extra);}if(suppressData&&silentUndoRedoCallback){urInfo={silent:true,undo:silentUndoRedoCallback.undo,redo:silentUndoRedoCallback.redo};}else{urInfo={callback:this.getUnSilentUndoRedoCallback(actions,docModel)};}cmdMgr(me).execute({execute:function execute(){var update=dataService.newUpdate(this,undefined);update.add(actions,requestCallback,extra);if(!suppressData){this.submitUpdate(update);}else{this.submitSilent(update.actions);}me.resetXMLDirtyFlag();},urInfo:urInfo});},setActive:function(isActive){this.active=isActive;d3v4.select(this.domMainContainer).classed("active",this.active);},postBuildRendering:function(){this.waitingForData=this.waitingForData||this.excludeData&&mstrApp.isAppStatePause();if(this.waitingForData){if(this.excludeData&&mstrApp.isAppStatePause()){this.raiseEvent({name:"toggleCtrlOverlay",visible:true,controls:this.getVisEmptyMsgControls()});}return ;}GMUTIL.startTimer({functionName:"VisNewGraphMatrix.postBuildRendering",purpose:"preplot"});if(this.noData){this.raiseEvent({name:"toggleCtrlOverlay",visible:true,controls:this.getVisEmptyMsgControls()});return ;}if(this.excludeData){this.raiseEvent({name:"toggleCtrlOverlay",visible:true,controls:this.getVisEmptyMsgControls()});return ;}this.initLayouter();this.sizeMainContainer();if(!this.isEmpty()){this.loadNGMStrings();this._slots=this.makeSlots(this.domMainContainer);this.initAxesManager();this.generatePlotlyData();this.prepareHeaderDimensions();this.generateDataLabelData();this.setChartLayout();this.renderHeader();this.sizeRowsAndCols();GMUTIL.endTimer(undefined,true);GMUTIL.startTimer({functionName:"VisNewGraphMatrix.postBuildRendering",purpose:"plot"});this.plotPlotly();GMUTIL.endTimer(undefined,true);GMUTIL.startTimer({functionName:"VisNewGraphMatrix.postBuildRendering",purpose:"postplot"});this.postPlotly();var exp=this.getExp(),gtsModel=this.getRowsAndCols();$VISUTILS.modifyScExp(exp,gtsModel,this.model,this.normalizedIdCache);}else{GMUTIL.endTimer(undefined,true);GMUTIL.startTimer({functionName:"VisNewGraphMatrix.postBuildRendering",purpose:"postplot"});}if(this._super){this._super();}GMUTIL.endTimer(undefined,true);},makeSlots:function(container){var TEMPLATE='<div class="row-divider-viewport"><div class = "row-divider-lines"></div></div><div class="col-divider-viewport"><div class = "col-divider-lines"></div></div><div class = "header-lines"></div><table class="ngm"><tr><td><div class="col-left-no-axis"></div></td><td colspan="3"><div class="col-container overflow-hidden"><div class="col-left"></div><div class="col-content"></div><div class="col-right"></div></div></td></tr><tr class="axis-row"><td style="vertical-align:top"><div class="row-top"></div></td><td><div class="axis-left"></div></td><td><div class="axis-content"></div></td><td><div class="axis-right"></div></td></tr><tr><td style="vertical-align:top"><div class="row-container overflow-hidden"><div class="row-content"></div><div class="row-bottom"></div></div></td><td colspan="3"></td></tr></table>';container.innerHTML=TEMPLATE;var lines={rowViewport:container.children[0],rowDividers:container.children[0].firstChild,colViewport:container.children[1],colDividers:container.children[1].firstChild,headerLines:container.children[2]};var prop;for(prop in lines){lines[prop]=d3v4.select(lines[prop]);}this.lines=lines;var tbody=container.children[3].firstChild,slots={tbody:tbody,domColContainer:tbody.firstChild.children[1].firstChild,domColLeftNoAxis:tbody.firstChild.firstChild.firstChild,domColLeft:tbody.firstChild.children[1].firstChild.firstChild,domColContent:tbody.firstChild.children[1].firstChild.children[1],domColRight:tbody.firstChild.children[1].firstChild.children[2],domRowContainer:tbody.children[2].firstChild.firstChild,domRowTop:tbody.children[1].firstChild.firstChild,domRowContent:tbody.children[2].firstChild.firstChild.firstChild,domRowBottom:tbody.children[2].firstChild.firstChild.children[1],domAxisLeft:tbody.children[1].children[1].firstChild,domAxisContent:tbody.children[1].children[2].firstChild,domAxisRight:tbody.children[1].children[3].firstChild,domChart:tbody.children[2].children[1]};for(prop in slots){slots[prop]=d3v4.select(slots[prop]);}return slots;},setColorByOptions:function(allKeys,allNames,gd){var color=ngm.converter.SCALE.attrColorMapping,names=allNames.ColorBy||[],keys=allKeys.ColorBy||[],gmCtr=this.GMController,thresholds=gmCtr.colorByInfo.thresholds,ctx=ngm.canvas.getContext(),options=thresholds?thresholds.map(function(t){return{text:t.flr+"% - "+t.ceil+"%",color:t.fmt.bc};}):names.map(function(name,i){return{text:name,color:color(keys[i])};}),title;if(options.length<LEGEND_INCREMENTAL_THRESHOLD){var maxLength=0;options.forEach(function(opt){maxLength=Math.max(maxLength,ctx.measureText(opt.text).width);});gd.maxLegendItem=gmCtr.maxLegendItem=maxLength+TEXT_ANCHOR+TEXT_ENDING;}else{gd.maxLegendItem=gmCtr.maxLegendItem=ctx.measureText(options.reduce(function(longest,opt){return opt.text.length>longest.length?opt.text:longest;},"")).width+TEXT_ANCHOR+TEXT_ENDING;}if(gmCtr.colorByInfo){title=gmCtr.getColorByAttrsID().map(function(id){return GMUTIL.restoreSpecialChars(gmCtr.getAttributeById(id).n);}).join(";");}else{title=GMUTIL.restoreSpecialChars(gmCtr.metricInfos[gmCtr.dz.ColorBy.TemplateMetric[0].id].n);}this.colorByTitles=gd.colorByTitles=title;this.colorByOptions=options;},drawLegend:function(g,maxW,maxH){var options=this.colorByOptions;if(!options.length){return ;}var LEGEND_ITEM_HEIGHT=20;var LEGEND_TITLE_HEIGHT=20;var SHOW_TITLE=true;var SCROLL_BAR_WIDTH=4;var SCROLL_BAR_HEIGHT=20;var RECT_ANCHOR=12;var maxLegendItem=this.GMController.maxLegendItem;var SCROLL_TO_BORDER=10;var isVertical=this.legendPosition==="right";var rct=2,cct=1;var totalRowCount=+SHOW_TITLE;if(isVertical){totalRowCount=options.length;cct=1;rct=Math.min(options.length,Math.ceil(maxH/LEGEND_ITEM_HEIGHT));maxW*=0.25;}else{cct=Math.max(1,Math.floor(maxW/maxLegendItem));totalRowCount=Math.ceil(options.length/cct);rct=Math.min(2,totalRowCount);maxH=rct*LEGEND_ITEM_HEIGHT;}var trim=maxLegendItem>maxW;function wrap(){var self=d3v4.select(this),text=self.text(),textLength=self.node().getComputedTextLength();while(TEXT_ANCHOR+textLength+TEXT_ENDING>maxW&&text.length>0){text=text.slice(0,-1);self.text(text+"...");textLength=self.node().getComputedTextLength();}}var legend=g.append("g").attr("class","colorByLegend").attr("font-family","Arial").attr("font-size",11).attr("text-anchor","start");if(SHOW_TITLE){legend.append("text").attr("x",12).attr("y",9.5).attr("dy","0.32em").text(this.colorByTitles);}var bg=legend.append("rect").attr("class","bg").attr("pointer-events","all").attr("touch-action","none").attr("fill","white");function render(d){var x=0,y=0;legend.selectAll(".items").remove();var items=legend.append("g").attr("class","items").selectAll("g").data(d).enter().append("g").attr("transform",function(d,i){if(isVertical){return"translate(0,"+(i+SHOW_TITLE)*LEGEND_ITEM_HEIGHT+")";}else{var str="translate("+x*maxLegendItem+","+(y+SHOW_TITLE)*LEGEND_ITEM_HEIGHT+")";if(++x===cct){x=0;y++;}return str;}});items.append("rect").attr("pointer-events","none").attr("touch-action","none").attr("x",RECT_ANCHOR).attr("width",12).attr("height",12).attr("fill",function(d){return d.color;});var texts=items.append("text").attr("x",TEXT_ANCHOR).attr("y",9.5).attr("pointer-events","none").attr("touch-action","none").text(function(d){return d.text;});if(trim){texts.each(wrap);}}function range(y){var minY=0;var maxY=maxH-SCROLL_BAR_HEIGHT;if(isVertical){var ratio=(totalRowCount*LEGEND_ITEM_HEIGHT-maxH)/(maxY-minY);return options.slice(y*ratio/LEGEND_ITEM_HEIGHT,y*ratio/LEGEND_ITEM_HEIGHT+rct);}else{var start=Math.floor((totalRowCount-rct)/(maxY-minY)*y);return options.slice(start*cct,(start+rct)*cct);}}if(totalRowCount>rct){render(range(0));function onScroll(dom,ey){var y=(+d3v4.select(dom).attr("y"));var dy=ey-y;y+=dy;if(y<0){y=0;}if(y+SCROLL_BAR_HEIGHT>maxH){y=maxH-SCROLL_BAR_HEIGHT;}d3v4.select(dom).attr("y",y+LEGEND_TITLE_HEIGHT);render(range(y));}var scrollbar=legend.append("rect").attr("class","scrollbar").attr("x",(isVertical?Math.min(maxW,maxLegendItem):maxW)-SCROLL_TO_BORDER).attr("y",SHOW_TITLE*LEGEND_ITEM_HEIGHT).attr("width",SCROLL_BAR_WIDTH).attr("height",SCROLL_BAR_HEIGHT).attr("fill","#808BA4");var count=0;legend.on("wheel",function(){count+=(d3v4.event.deltaY<0?-1:1);if(count<0){count=0;}else{if(count>totalRowCount){count=totalRowCount;}}onScroll(scrollbar.node(),count/totalRowCount*maxH);});function onTouchMoveCallback(details){count+=(-details.deltaY<0?-1:1);if(count<0){count=0;}else{if(count>totalRowCount){count=totalRowCount;}}onScroll(scrollbar.node(),count/totalRowCount*maxH);}function onTouchEndCallback(){}$VISUTILS.addBasicTouchSupport(bg.node(),this,undefined,onTouchMoveCallback.bind(this),onTouchEndCallback.bind(this));}else{render(options);}bg.attr("y",LEGEND_TITLE_HEIGHT).attr("width",RECT_ANCHOR+legend.node().getBBox().width+6).attr("height",legend.node().getBBox().height);if(isVertical){var ly=(maxH-legend.node().getBBox().height>>1);legend.attr("transform","translate(0,"+Math.max(ly,0)+")");}return legend;},initLayouter:function(){var gmCtr=this.GMController;this._rct=gmCtr.getRowChartCount();this._cct=gmCtr.getColChartCount();this.layouter=new ngm.Layout(this._cct,this._rct,this.getWidth(),this.getHeight());this.calcMinCellDim();},calcMinCellDim:function(){var nCols=this._cct,nRows=this._rct,gmCtr=this.GMController,layouter=this.layouter,labelsNum,size,i,nSeries=1,minUnitWidth=1,ATTR_CELL_MIN_SIZE=28,CELL_MIN_SIZE=60,attributeAxes=gmCtr.getAttributeAxesLetters();["x","y"].forEach(function(axis){var minSize=[],xAxis=axis==="x";var n=xAxis?nCols:nRows;if(gmCtr.isHistogram){minSize.push(CELL_MIN_SIZE);layouter._cellNumDataPoints[axis][0]=1;}else{if(attributeAxes.indexOf(axis)>-1){layouter._totalNumDataPoints[axis]=0;for(i=0;i<n;i++){labelsNum=xAxis?gmCtr.getAxisLabels(0,i)[axis].length:gmCtr.getAxisLabels(i,0)[axis].length;layouter._cellNumDataPoints[axis][i]=labelsNum;layouter._totalNumDataPoints[axis]+=labelsNum;size=(nSeries*minUnitWidth)*(labelsNum+0.5);minSize.push(Math.max(Math.floor(size+0.5),ATTR_CELL_MIN_SIZE));}}else{for(i=0;i<n;i++){layouter._cellNumDataPoints[axis][i]=1;minSize.push(CELL_MIN_SIZE);}}}if(axis==="x"){layouter.setMinWidths(minSize);}else{layouter.setMinHeights(minSize);}});},sizeRowsAndCols:function(){var layouter=this.layouter,rows=this.domMainContainer.getElementsByClassName("ngm-row-header"),cols=this.domMainContainer.getElementsByClassName("ngm-col-header");size(rows,"height",layouter.getCellHeight.bind(layouter));size(cols,"width",layouter.getCellWidth.bind(layouter));function size(cells,prop,fn){for(var i=0;i<cells.length;i++){cells[i][prop]=fn(i);}}},sizeMainContainer:function(){var layouter=this.layouter;d3v4.select(this.domMainContainer).style("width",layouter.getWidgetWidth()+"px").style("height",layouter.getWidgetHeight()+"px");},initAxesManager:function(){this.axesManager={x:{title:this.getAxisProps("X","TITLE"),label:this.getAxisProps("X","LABELS")},y:{title:this.getAxisProps("Y","TITLE"),label:this.getAxisProps("Y","LABELS")},x2:{},y2:{}};},updateGridLineValue:function(axis){var axisUpper=axis.toUpperCase(),axisLower=axis.toLowerCase(),ori=this.chartInfo.ori,gridVal=this.getWidgetPropertyValue(ENUM_FORMAT_TAG[axisUpper+"_GRID_LINES_SHOW"]),showXOrY=axisLower==="x"?NGM_GRID_LINE.SHOW_X:NGM_GRID_LINE.SHOW_Y,showAuto=(ori==="v"&&axisLower==="y")||(ori==="h"&&axisLower==="x"),showGrid=(gridVal===NGM_GRID_LINE.SHOW)||(gridVal===showXOrY)||(gridVal===NGM_GRID_LINE.AUTO&&showAuto);this.setAxesManager(axisLower,"showGrid",showGrid);},updateAxesManagerColor:function(axis,part,color){this.axesManager[axis][part].font.color=GMUTIL.decodeColor(color.allVal);},updateAxesManagerNumberFormat:function(axis,part,nf){this.axesManager[axis].label.nf=nf;},setAxesManager:function(axis,part,val){var partString=part.split("."),axesManager=this.axesManager[axis];partString.forEach(function(part,i){axesManager[part]=axesManager[part];if(i<partString.length-1){axesManager=axesManager[part];}});axesManager[partString[partString.length-1]]=val;},renderHeader:function(){var gmCtr=this.GMController,me=this,layouter=this.layouter,rct=this._rct,cct=this._cct,rows=gmCtr.getRowHeaderTree(),cols=gmCtr.getColHeaderTree(),rowDepth=rows.length,colDepth=cols.length,rowTree=getFCNSRoot(rows[0],rowDepth),colTree=getFCNSRoot(cols[0],colDepth),dz=gmCtr.dz,hasYAxis=this.hasYAxis;this._colSpan=(dz.XAxis.TemplateMetric&&dz.YAxis.TemplateMetric)?dz.XAxis.TemplateMetric.length:(dz.Columns.MetricNames&&dz.XAxis.TemplateMetric?dz.XAxis.TemplateMetric.length:1);this._rowSpan=1;var colLeft=hasYAxis?this._slots.domColLeft:this._slots.domColLeftNoAxis;var domRowTopTable=this._slots.domRowTop.append("table").style("table-layout","fixed").append("tr"),domColLeftTable=colLeft.append("table").style("table-layout","fixed");var rowHeaderTitles=gmCtr.getRowHeaderTitles(),colHeaderTitles=gmCtr.getColumnHeaderTitles();var i;for(i=0;i<rowDepth;i++){domRowTopTable.append("td").text(rowHeaderTitles[i]);}for(i=0;i<colDepth;i++){var coltr=domColLeftTable.append("tr"),coltd,depth=hasYAxis?0:rowDepth-1;for(var j=0;j<depth;j++){coltd=coltr.append("td");}coltr.append("td").text(colHeaderTitles[i]);}this._slots.domRowContent.append("table");var table=this._slots.domColContent.append("table");var newCol;for(i=0;i<cct;i++){newCol=table.append("col");newCol.classed("ngm-col-header",true);}if(rowTree&&rowTree.firstChild){this.renderRow(rowTree.firstChild,this._slots.domRowContent.node().firstChild,null,0);}if(colTree&&colTree.firstChild){this.renderCol(colTree.firstChild,this._slots.domColContent.node().firstChild,0,0);}if(layouter.getAxisLineLeft().length!==rct&&rct!==1){layouter.setAxisLineLefts(this.calcMetricNameLines(rct,layouter.getAxisLineLeft()));}if(layouter.getAxisLineTop().length!==cct&&cct!==1){layouter.setAxisLineTops(this.calcMetricNameLines(cct,layouter.getAxisLineTop()));}var titles,t,id,handle;if(gmCtr.hasMetricNamesInXHeader()){var titlesCols=this._slots.domColContent.node().getElementsByTagName("tr");if(titlesCols.length){titles=titlesCols[titlesCols.length-1].getElementsByTagName("td");for(i=0;i<titles.length;i++){t=titles[i];t.classList.add("y"+i+"title");id=gmCtr.getYAxisHeaders(0,i)[0];handle=gmCtr.getCellHandler(0,i,id.mIdx);id.cellHandler=handle;t.identity=id;t.addEventListener("contextmenu",function(e){var ctrlKey=e&&(e.ctrlKey||e.metaKey);me.interactor.onPaperClick(me,t,e,ctrlKey);});}}}else{if(gmCtr.hasMetricNamesInYHeader()){var titlesRows=this._slots.domRowContent.node().getElementsByTagName("tr");for(i=0;i<titlesRows.length;i++){var titleRow=titlesRows[i];titles=titleRow.getElementsByTagName("td");if(titles&&titles.length){t=titles[titles.length-1];t.classList.add("x"+i+"title");id=gmCtr.getXAxisHeaders(i,0)[0];handle=gmCtr.getCellHandler(i,0,id.mIdx);id.cellHandler=handle;t.identity=id;t.addEventListener("contextmenu",function(e){var ctrlKey=e&&(e.ctrlKey||e.metaKey);me.interactor.onPaperClick(me,t,e,ctrlKey);});}}}}this.renderAxisHeader();this.setBGColor(this.getFormats());},renderAxisHeader:function(){var gmCtr=this.GMController,slots=this._slots,me=this,div,hasRowHeader=gmCtr.getRowHeaderTree().length>0,hasAxisHeader=this.hasAxisHeader;if(hasAxisHeader){var yTitles=gmCtr.getYAxisHeaderTitles(0,0);var firstClass=yTitles.length>1?"ytitle0":"ytitle";div=slots.domAxisLeft.node().appendChild(document.createElement("div"));div.classList.add("header-text-wrap");div.classList.add(firstClass);div.addEventListener("contextmenu",function(e){var ctrlKey=e&&(e.ctrlKey||e.metaKey);me.interactor.onPaperClick(me,div,e,ctrlKey);});div.innerText=yTitles[0]||"";yTitles.forEach(function(title,i){if(i!==0){div=slots.domAxisLeft.node().appendChild(document.createElement("div"));div.innerText="|";div.classList.add("header-divider");div=slots.domAxisLeft.node().appendChild(document.createElement("div"));div.classList.add("header-text-wrap");div.classList.add("ytitle"+i);div.addEventListener("contextmenu",function(e){var ctrlKey=e&&(e.ctrlKey||e.metaKey);me.interactor.onPaperClick(me,div,e,ctrlKey);});div.innerText=yTitles[i];}});}else{if(!hasRowHeader){d3v4.select(this.domMainContainer).select(".axis-row").selectAll("td").style("border","0px");}}slots.domRowTop.style("height",this.extraHeaderHeight+"px");},checkExtraColHeight:function(){var gmCtr=this.GMController,layouter=this.layouter,hasRowHeader=gmCtr.getRowHeaderTree().length>0,hasAttributeHeader=hasRowHeader||gmCtr.getColHeaderTree().length>0,isAttributeOnY=gmCtr.getAttributeAxesLetters().indexOf("y")>=0,hasAxisHeader=this.hasAxisHeader=hasAttributeHeader&&isAttributeOnY;if(gmCtr.hasMetricNamesInXHeader()){this.axesManager.y.title.isInHeader=true;}if(gmCtr.hasMetricNamesInYHeader()){this.axesManager.x.title.isInHeader=true;}this.axesManager.y.title.isInHeader=this.axesManager.y.title.isInHeader||hasAxisHeader;this.extraHeaderHeight=hasAxisHeader||hasRowHeader?layouter.DIM.COL_HEIGHT:0;if(this.extraHeaderHeight){layouter.pushColHeaderHeight(layouter.DIM.COL_HEIGHT);}},checkExtraRowWidth:function(){var layouter=this.layouter,gmCtr=this.GMController,hasYAxis=this.hasYAxis,hasRowHeader=gmCtr.getRowHeaderTree().length>0,hasColHeader=gmCtr.getColHeaderTree().length>0;if(!hasRowHeader&&!hasYAxis&&hasColHeader){layouter.pushRowHeaderWidth(layouter.DIM.ROW_WIDTH);}},prepareHeaderDimensions:function(){var gmCtr=this.GMController;var layouter=this.layouter;var rows=gmCtr.getRowHeaderTree(),cols=gmCtr.getColHeaderTree(),rowDepth=rows.length,colDepth=cols.length;var hasAttributeInY=gmCtr.getAttributeAxesLetters().indexOf("y")>=0,hasMetricInY=gmCtr.getMetricAxesLetters().indexOf("y")>=0,hasAttributeInX=gmCtr.getAttributeAxesLetters().indexOf("x")>=0,hasMetricInX=gmCtr.getMetricAxesLetters().indexOf("x")>=0,hasWaterfallTotalLabel=gmCtr.isWaterfall&&this.getWaterfallOptions().totalShw;layouter.clearRowHeaderWidth();layouter.clearColHeaderHeight();prepareDimensions(rowDepth,layouter.DIM.ROW_WIDTH,layouter.pushRowHeaderWidth);prepareDimensions(colDepth,layouter.DIM.COL_HEIGHT,layouter.pushColHeaderHeight);this._slots.domRowContainer.style("width",layouter.getRowHeaderFullWidth()+"px");this._slots.domColContainer.style("height",layouter.getColHeaderFullHeight()+"px");this.checkExtraColHeight();var hasYAxis=hasAttributeInY||hasMetricInY&&!this.hasAxisHeader||(hasWaterfallTotalLabel&&hasMetricInX),hasXAxis=hasAttributeInX||hasMetricInX||(hasWaterfallTotalLabel&&hasMetricInY)||gmCtr.isHistogram;this.hasYAxis=hasYAxis;this.hasXAxis=hasXAxis;this.checkExtraRowWidth();this.setPlotlyDimensions();function prepareDimensions(depth,length,pushFn){for(var i=0;i<depth;i++){pushFn.call(layouter,length);}}},setPlotlyDimensions:function(){var layouter=this.layouter;var viewHeight=layouter.getViewHeight(),viewWidth=layouter.getViewWidth();layouter.setPlotlyDim(viewHeight,viewWidth);this._slots.domRowContainer.style("height",layouter.getViewHeight()+"px");this._slots.domColContainer.style("width",layouter.getViewWidth()+"px");},renderRow:function(node,table,row,depth){row=row||table.insertRow();var cell=row.insertCell();cell.innerText=cell.title=node.headerText;var fc=node.firstChild;var span=fc?this.renderRow(fc,table,row,depth+1):this._rowSpan;if(!fc){cell.classList.add("ngm-row-header");}cell.rowSpan=span;var ns=node.nextSibling;if(!fc){if(!ns){this.layouter.pushAxisLineLeft(depth-1);}else{this.layouter.pushAxisLineLeft(depth);}}else{if(!ns){var length=this.layouter.getAxisLineLeft().length;this.layouter.getAxisLineLeft()[length-1]=depth-1;}}span+=ns?this.renderRow(ns,table,null,depth):0;return span;},renderCol:function(node,table,i,depth){var row=table.rows[i]||table.insertRow();var cell=row.insertCell();cell.innerText=cell.title=node.headerText;var fc=node.firstChild;var span=fc?this.renderCol(fc,table,i+1,depth+1):this._colSpan;if(cell){cell.colSpan=span;}var ns=node.nextSibling;if(!fc){if(!ns){this.layouter.pushAxisLineTop(depth-1);}else{this.layouter.pushAxisLineTop(depth);}}else{if(!ns){var length=this.layouter.getAxisLineTop().length;this.layouter.getAxisLineTop()[length-1]=depth-1;}}span+=ns?this.renderCol(ns,table,i,depth):0;return span;},calcMetricNameLines:function(count,headers){var metricCount=count/headers.length;var newHeaders=new Array(count);var j,i=0;for(j=metricCount;j<count;j+=metricCount){newHeaders[j-1]=headers[i++];}return newHeaders;},updateWaterfallLayout:function(data,layouter){layouter.setPlotlyLayout("showlegend",false);layouter.setPlotlyLayout("waterfall",true);},setLineAreaSpacing:function(fitMode,OAL){var layouter=this.layouter,chartInfo=this.chartInfo,ori=chartInfo.ori,newOAL=OAL;var N=ori==="v"?layouter.totalNumXPts():layouter.totalNumYPts(),r=ori==="v"?layouter._cct:layouter._rct;var extraPadding=6;var fnSmallN=function(){return 12*N<=OAL;},fnLargeN=function(){return 12*N>OAL;},fnLargeNContainer=function(){return 2*(N+r)>OAL;},fnSetOALContainer=function(){return 2*(N+r);},fnSetOALAuto=function(){return 12*(N+r);};if(fitMode===ENUM_FITMODES.AUTOMATIC){if(fnSmallN()){extraPadding=0.5*OAL/N/r;}else{if(fnLargeN()){newOAL=fnSetOALAuto();}}}else{if(fitMode===ENUM_FITMODES.FIT_TO_CONTAINER){if(fnSmallN()){extraPadding=0.5*OAL/N/r;}else{if(fnLargeNContainer()){newOAL=fnSetOALContainer();extraPadding=6;}}}else{if(fitMode===ENUM_FITMODES.FIT_TO_CONTENT){newOAL=48*N-36*r;extraPadding=6;}}}layouter.extraPadding=extraPadding;return newOAL;},setHistogramSpacing:function(fitMode,N){var layouter=this.layouter,OAL=layouter.getWidgetWidth(),newOAL=OAL;var fnSmallN=function(){return 144*N+12;},fnLargeN=function(){return 6*N+12;},fnLargerN=function(){return 4*N+4;};if(fnSmallN()<=OAL){layouter.barSpace=144;layouter.extraPadding=(OAL-144*N)/2;}else{if((fnLargeN()<=OAL)&&(OAL<fnSmallN())){layouter.barSpace=(OAL-12)/N;layouter.extraPadding=30;}else{if(fitMode===ENUM_FITMODES.AUTOMATIC){layouter.barSpace=30;newOAL=fnLargeN();layouter.extraPadding=6;}else{if((fnLargerN()<=OAL)&&(OAL<fnLargeN())){layouter.barSpace=OAL/(N+2);layouter.extraPadding=(2.5*OAL)/(N+5);}else{newOAL=fnLargerN();layouter.barSpace=2;layouter.extraPadding=10;}}}}return newOAL;},setBoxPlotSpacing:function(fitMode,OAL){var layouter=this.layouter,chartInfo=this.chartInfo,ori=chartInfo.ori;var newOAL=OAL,n=ori==="v"?layouter.totalNumXPts():layouter.totalNumYPts(),r=ori==="v"?layouter._cct:layouter._rct,extraPadding=(OAL-288*n)/r;var fnSmallN=function(){return(288*n+12*r);},fnLargeN=function(){return(12*n+12*r);},fnLargerN=function(){return(8*n+4*2*r);};if(fitMode===ENUM_FITMODES.FIT_TO_CONTENT){newOAL=36*2*n+12*r;extraPadding=6;}if(fnLargeN()<=OAL&&OAL<fnSmallN()){extraPadding=6;}else{if(fitMode===ENUM_FITMODES.AUTOMATIC&&fnLargeN()>OAL){extraPadding=6;newOAL=fnLargeN();}else{if(fitMode===ENUM_FITMODES.FIT_TO_CONTAINER){if(fnLargerN()<=OAL&&OAL<=fnLargeN()){extraPadding=OAL/(n+r);}else{if(OAL<=fnLargerN()){newOAL=fnLargerN();extraPadding=4;}}}}}layouter.extraPadding=extraPadding;return newOAL;},setBarSpacing:function(fitMode,OAL){var layouter=this.layouter,chartInfo=this.chartInfo,allKeys=this.allKeys,ori=chartInfo.ori;var newOAL=OAL,n=ori==="v"?layouter.totalNumXPts():layouter.totalNumYPts(),r=ori==="v"?layouter._cct:layouter._rct,hasBreakBy=allKeys.BreakBy,showSubTtl,showTtl,isClustered=hasBreakBy&&chartInfo.subtype===SUBTYPE.CLUSTERED,m=(isClustered||(hasBreakBy&&chartInfo.chartType===CHART_TYPE.WATERFALL))?allKeys.BreakBy.length:1,N=n*m,g=m===1?0:n,extraPadding=10,bargroupgap=0,bargap=0,barSpace,hasGrouping=allKeys.BreakBy&&allKeys.BreakBy.length!==0;if(chartInfo.chartType===CHART_TYPE.WATERFALL){showSubTtl=hasGrouping?this.getWidgetPropertyValue(ENUM_FORMAT_TAG.INT_SUM_SHOW):false;showTtl=this.getWidgetPropertyValue(ENUM_FORMAT_TAG.TOTAL_SHOW);if(showSubTtl&&hasGrouping){N+=n;}if(showTtl){N+=r;}layouter.subGroup=m;layouter.showTotal=showTtl;layouter.showSubtotal=showSubTtl;}var fnSmallN=function(){return(192*N+144*g+12*r);},fnLargeN=function(){return(8*N+12*r);},fnLargerN=function(){return isClustered?(2.7*N+2*n+20*r):(2.7*N+20*r);};if(fitMode===ENUM_FITMODES.FIT_TO_CONTENT){bargroupgap=0.25;newOAL=isClustered?(24+8)*N+24*n+20*r:(24+8)*N+20*r;bargap=isClustered?n*24/newOAL:0;extraPadding=10;}else{if(fnLargerN()>OAL&&fitMode===ENUM_FITMODES.FIT_TO_CONTAINER){extraPadding=10;if(isClustered){bargap=3/(4*m+3);bargroupgap=m/(4*m+3);newOAL=2.7*N+2*N+20*r;}else{bargroupgap=0.25;bargap=0;newOAL=(2.7*N)+(20*r);}}else{if(fnLargeN()>OAL){bargroupgap=0.25;if(isClustered){bargap=3/(4*m+3);}if(fitMode===ENUM_FITMODES.FIT_TO_CONTAINER){extraPadding=OAL/(1.3*N+2);if(isClustered){bargroupgap=m/(4*m+3);}}else{if(isClustered){bargroupgap=m/(4*m+3);newOAL=8*N+6*n+12*r;}else{newOAL=8*N+12*r;}}}else{if((fnLargeN()<=OAL)&&(fnSmallN()>OAL)){if(isClustered){bargap=3/(4*m+3);bargroupgap=m/(4*m+3);}else{bargap=0.25;}}else{if((fnSmallN()<OAL)){bargroupgap=0.25;if(isClustered){bargap=3/(4*m+3);extraPadding=(OAL-192*N+144*n)/(2*r);}else{extraPadding=(OAL-192*N)/(2*r);}barSpace=192;}}}}}layouter.bargroupgap=bargroupgap;layouter.bargap=bargap;layouter.extraPadding=extraPadding;layouter.barSpace=barSpace;return newOAL;},spacingCalculations:function(fitMode,OAL){var chartInfo=this.getChartInfo(),ct=chartInfo.tp;if(ct===CHART_TYPE.LINE||ct===CHART_TYPE.AREA){return this.setLineAreaSpacing(fitMode,OAL);}else{if(ct===CHART_TYPE.BAR||ct===CHART_TYPE.WATERFALL){return this.setBarSpacing(fitMode,OAL);}else{if(ct===CHART_TYPE.HISTOGRAM){return ;}else{if(ct===CHART_TYPE.BOXPLOT){return this.setBoxPlotSpacing(fitMode,OAL);}}}}},setChartLayout:function(){var opts={},layouter=this.layouter,gmCtr=this.GMController,converter=ngm.converter,axesManager=this.axesManager,chartInfo=this.chartInfo,allKeys=this.allKeys,allNames=this.allNames,data=this.data,axisTitles=this.axisTitles,spacingFn=this.spacingCalculations.bind(this),containerFitMode=this.getWidgetPropertyValue(ENUM_FORMAT_TAG.CONTAINER_FIT_MODE);chartInfo.hasXAxis=this.hasXAxis;chartInfo.hasYAxis=this.hasYAxis;if(gmCtr.isWaterfall){opts.waterfall=this.getWaterfallOptions();}var marginConfig=this.marginConfig=converter.calcMargins(layouter,gmCtr,ngm.canvas.getContext(),chartInfo,allKeys,allNames,axesManager,data,spacingFn,containerFitMode,opts);layouter.setMargin({l:marginConfig.l,b:marginConfig.b,t:marginConfig.t,r:marginConfig.r});if(this.getWidgetPropertyValue(ENUM_FORMAT_TAG.CONTAINER_FIT_MODE)===ENUM_FITMODES.FIT_TO_CONTENT){if(this.chartInfo.ori==="v"){if(marginConfig.newOAL+layouter.getMarginLeft()<layouter.getViewWidth()){layouter.setMargin({r:layouter.getViewWidth()-(marginConfig.newOAL+layouter.getMarginLeft())});}layouter.setPlotlyWidth(marginConfig.newOAL+layouter.getMarginRight()+layouter.getMarginLeft());}else{layouter.setPlotlyHeight(marginConfig.newOAL+layouter.getMarginTop()+layouter.getMarginBottom());}}else{converter.setMinChartSize(layouter,chartInfo.ori==="v"?marginConfig.newOAL:0,chartInfo.ori==="h"?marginConfig.newOAL:0);}var cellWidths=converter.calcCellDim(layouter.getChartWidth(),layouter.getMinWidths(),this._cct,layouter.getCellXRatios(),layouter.totalNumXPts()),cellHeights=converter.calcCellDim(layouter.getChartHeight(),layouter.getMinHeights(),this._rct,layouter.getCellYRatios(),layouter.totalNumYPts());layouter.setCellWidths(cellWidths);layouter.setCellHeights(cellHeights);converter.sizeMarginsAgain(layouter,axesManager);layouter.setScrollW(layouter.getViewHeight()<Math.floor(layouter.getPlotlyHeight())?layouter.DIM.SCROLL_SPACE:0);layouter.setScrollH(layouter.getViewWidth()<Math.floor(layouter.getPlotlyWidth())?layouter.DIM.SCROLL_SPACE:0);this.axesManager.gmCtr=this.GMController;converter.generateAxes(layouter,axisTitles,axesManager,gmCtr);if(this.chartInfo.chartType===CHART_TYPE.BAR||this.chartInfo.chartType===CHART_TYPE.WATERFALL){layouter.setPlotlyLayout("bargap",layouter.bargap);layouter.setPlotlyLayout("bargroupgap",layouter.bargroupgap);}},getAxisProps:function(axis,type){var me=this;return{show:me.getWidgetPropertyValue(ENUM_FORMAT_TAG[axis+"_AXIS_"+type+"_SHOW"]),angle:0,font:{family:me.getWidgetPropertyValue(ENUM_FORMAT_TAG[axis+"_AXIS_"+type+"_FONT_FAMILY"]),size:ptToPx(me.getWidgetPropertyValue(ENUM_FORMAT_TAG[axis+"_AXIS_"+type+"_FONT_SIZE"])),style:me.getWidgetPropertyValue(ENUM_FORMAT_TAG[axis+"_AXIS_"+type+"_FONT_SIZE"]),color:GMUTIL.decodeColor(me.getWidgetPropertyValue(ENUM_FORMAT_TAG[axis+"_AXIS_"+type+"_FONT_COLOR"]))}};},setBGColor:function(formats){var layouter=this.layouter,bgColor=this.bgColor=formats["background-color"]||GMUTIL.decodeColor(this.property.defaultsObj.bgFillClr);var update={paper_bgcolor:bgColor,plot_bgcolor:bgColor};for(var prop in update){layouter.setPlotlyLayout(prop,update[prop]);}this._slots.domColLeft.selectAll("td").style("background-color",bgColor);return update;},restylePlotly:function(formats){var update=this.setBGColor(formats),rectBGs=this.rectBGs;Plotly.relayout(this.div,update);for(var rect in rectBGs){rectBGs[rect].attr("fill",this.bgColor);}},getDataLabelProps:function(){var me=this;var gmCtr=this.GMController;var dltp=gmCtr.getDataLabelType();var datalabelOpts=me.getShowDataLabelOptions();var metricLevelDataLabelProperty=this.getWidgetPropertyValue(ENUM_XML_TAG.METRIC_LEVEL_DATA_LABEL);var opts=datalabelOpts.map(function(item){var result={opt:item.opt,key:item.key,show:undefined};if(dltp===$GM.EnumDataLabels.SHOW_VALUE_ONLY&&!metricLevelDataLabelProperty){result.show=true;}else{result.show=metricLevelDataLabelProperty&&metricLevelDataLabelProperty[item.key];}return result;});return{isBubbleOrScatter:gmCtr.isBubbleOrScatter(),charttype:gmCtr.getNewChartType(),subtype:me.getSubType(),metric_level_data_label_options:opts,datalabel:dltp,textangle:me.getWidgetPropertyValue(ENUM_XML_TAG.DATA_LABEL_TEXT_ANGLE),constraintext:"none",textfont:{family:me.getWidgetPropertyValue(ENUM_FORMAT_TAG.DATA_LABELS_FONT_FAMILY),size:ptToPx(me.getWidgetPropertyValue(ENUM_FORMAT_TAG.DATA_LABELS_FONT_SIZE)),color:GMUTIL.decodeColor(me.getWidgetPropertyValue(ENUM_FORMAT_TAG.DATA_LABELS_FONT_COLOR))}};},getShowDataLabelOptions:function(){return this.GMController.getShowDataLabelOptions();},postPlotHistogram:function(div,layouter){var gmCtr=this.GMController,data=div.data[0],calcData=div.calcdata?div.calcdata[0]:[],count=calcData.map(function(d){return d.y;}),values=data.x;var options=this.getHistogramOptions();var converter=ngm.converter,axesManager=this.axesManager,chartInfo=this.chartInfo,allKeys=this.allKeys,allNames=this.allNames,binsOpt=this.getWidgetPropertyValue(ENUM_FORMAT_TAG.CUSTOM_BINS_MODE),finNumBins;if(values.length>1||values[0]){layouter.setPlotlyLayout("xaxis1.title","");layouter.setPlotlyLayout("yaxis1.title",mstrmojo.desc(2123,"Count"));var i,attrList=gmCtr.getXAxisHeaderTitles(0,0),attrCnt=attrList.length||0,metricList=gmCtr.getYAxisHeaders(0,1);if(metricList){layouter.setPlotlyLayout("xaxis1.title",metricList[0].n);}if(attrList){var titlesList=[];titlesList.push(layouter.getPlotlyLayout().xaxis1.title+" (");for(i=0;i<attrCnt;i++){if(i===attrCnt-1){titlesList.push(attrList[i]+")");}else{titlesList.push(attrList[i]);}}layouter.setPlotlyLayout("xaxis1.titles",titlesList);layouter.setPlotlyLayout("xaxis1.titlesSkipFirst",true);}if(values){var formatByD3=function(nf,val){var locale=d3v4.formatLocale({decimal:mstrmojo.locales.number.DECIMALSEPARATOR,thousands:mstrmojo.locales.number.THOUSANDSEPARATOR,grouping:[3],currency:""}),format=nf?nf:Math.abs(val)<100?".2f":",.0f";return locale.format(format)(val);},formatByNum=function(nf,val){return mstrmojo.num.formatByMask(nf,val);},nf=gmCtr.getHeaderFormat(metricList),nffunc=nf?formatByNum:formatByD3;var bins=data.xbins,first=options.originalStart!==undefined?options.originalStart:bins.start,last=bins.end,step=bins.size;var range=last-first,nBins=Math.ceil(range/step),binData=[],tickVals=[],half=step/2;var calc=div.calcdata[0];tickVals.push(first-step);calc.forEach(function(c,i){var bRange=nffunc(nf,c.p-half)+" - "+nffunc(nf,c.p+half);tickVals.push(c.p-half);binData.push(bRange);data.text[i]=formatByD3(",.0f",c.s);});tickVals.push(last+step);gmCtr.binData=binData;finNumBins=nBins;layouter.setPlotlyLayout("xaxis1.tick0",tickVals[0]);layouter.setPlotlyLayout("xaxis1.autorange",false);layouter.setPlotlyLayout("xaxis1.tickformat",nf);layouter.setPlotlyLayout("xaxis1.tickformatfunc",nffunc);if(binsOpt!==$GM.EnumHistogram.MANUAL&&!this.getWidgetPropertyValue(ENUM_FORMAT_TAG.HAS_UNCHECKED_AUTO)){if(calcData&&calcData.length){var ex=this.GMController.getExtremes(0,1);if(!this.getWidgetPropertyValue(ENUM_FORMAT_TAG.HAS_UNCHECKED_DATASET_RANGE)){this.setWidgetPropertyValue(ENUM_FORMAT_TAG.XBINS_START,ex.YMinValue);this.setWidgetPropertyValue(ENUM_FORMAT_TAG.XBINS_END,ex.YMaxValue);this.setWidgetPropertyValue(ENUM_FORMAT_TAG.XBINS_SIZE,calcData[0].w);}finNumBins=calcData.length;this.setWidgetPropertyValue(ENUM_FORMAT_TAG.NUM_BINS,calcData.length);}}var spacingFn=this.setHistogramSpacing.bind(this),containerFitMode=this.getWidgetPropertyValue(ENUM_FORMAT_TAG.CONTAINER_FIT_MODE);var marginConfig=this.marginConfig=converter.calcMargins(layouter,gmCtr,ngm.canvas.getContext(),chartInfo,allKeys,allNames,axesManager,data,spacingFn,containerFitMode,{axisLabels:tickVals,numBins:finNumBins,count:count});var showXAxisTitle=axesManager.x.title.show,showYAxisTitle=axesManager.y.title.show,showYAxisLabel=axesManager.y.label.calcShow,showXAxisLabel=axesManager.x.label.calcShow;layouter.setMargin({l:marginConfig.l,b:marginConfig.b,t:marginConfig.t,r:marginConfig.r});layouter.setPlotlyLayout("xaxis1.dtick",axesManager.x.label.step);layouter.setPlotlyLayout("yaxis1.showticklabels",showYAxisLabel);layouter.setPlotlyLayout("xaxis1.showticklabels",showXAxisLabel);layouter.setPlotlyLayout("yaxis1.minDtick",1);layouter.setPlotlyLayout("xaxis1.tickangle",axesManager.x.label.angle);if(!showXAxisTitle){layouter.setPlotlyLayout("xaxis1.title","");}if(!showYAxisTitle){layouter.setPlotlyLayout("yaxis1.title","");}var newOAL=marginConfig.newOAL;var padding;if(layouter.extraPadding){padding=((finNumBins*layouter.extraPadding)/(newOAL-layouter.extraPadding))/(1-(layouter.extraPadding/(newOAL-layouter.extraPadding)));}else{if(containerFitMode===ENUM_FITMODES.AUTOMATIC){padding=((newOAL/layouter.barSpace)-finNumBins)/2;}else{padding=((newOAL/layouter.barSpace)/finNumBins)/2;}}padding*=step;layouter.rangeMin=first-padding;layouter.rangeMax=first+(finNumBins*step)+padding;layouter.setPlotlyLayout("xaxis1.range",[layouter.rangeMin,layouter.rangeMax]);layouter.setPlotlyLayout("bargroupgap",0);layouter.setPlotlyLayout("bargap",0);layouter.setPlotlyLayout("width",newOAL);}Plotly.relayout(div,layouter.clonePlotlyLayout());}},generatePlotlyData:function(){if(this.excludeData){return ;}var div=this._slots.domChart.node();var layouter=this.layouter;var cct=this._cct,rct=this._rct;var axesManager=this.axesManager;function getDirection(gmCtr,config){config=config||{};var y=gmCtr.dz.YAxis,x=gmCtr.dz.XAxis,yHasMetric=y.TemplateMetric,xHasMetric=x.TemplateMetric,yHasAttribute=y.TemplateUnit,xHasAttribute=x.TemplateUnit;config.hasMetricInX=!!xHasMetric;config.hasMetricInY=!!yHasMetric;config.hasAttributeInX=!!xHasAttribute;config.hasAttributeInY=!!yHasAttribute;if(yHasMetric&&xHasMetric||yHasAttribute&&xHasAttribute){return(config.orientation="NA");}if(xHasAttribute||yHasMetric){return(config.orientation="v");}if(yHasAttribute||xHasMetric){return(config.orientation="h");}}function colorByContainsGroupBy(gmCtr,groupBy){var c=gmCtr.dz[colorBy].TemplateUnit||[],g=gmCtr.dz[groupBy].TemplateUnit||[],test=false;c.forEach(function(attr_in_colorBy){g.forEach(function(attr_in_groupBy){if(attr_in_groupBy.id===attr_in_colorBy.id){test=true;}});});return test;}var decode=mstrmojo.color.decodeColor,palette=this.getDocModel().getCurrentPaletteColors().map(function(c){return decode(c);});var chartMap=["","scatter","bar","scatter","scatter","scatter","","","histogram","box","bar"],optionMap=["","fill","","mode:markers+lines","mode:markers","mode:markers"],barModeMap=["group","relative","stack"];var converter=ngm.converter,gmCtr=this.GMController,ori=getDirection(gmCtr,converter.config),groupBy=ori==="v"?"XAxis":"YAxis",seriesBy="BreakBy",colorBy="ColorBy",subtype=this.getSubType(),chartType=gmCtr.getNewChartType(),type=chartMap[chartType],option=optionMap[chartType],data=[],allKeys=this.allKeys={},allNames=this.allNames={},raw,options;this.axisTitles={x:[],y:[]};allNames.Labels=[];if(chartType===1&&subtype===1){layouter.setPlotlyLayout("legend.tracetoggle",false);}layouter.setOrientation(ori);layouter.setPlotlyLayout("barmode",barModeMap[subtype]);var chartInfo=this.chartInfo={ori:ori||"v",type:type,chartType:chartType,subtype:subtype,option:option||"",isSingleChart:checkSingleChart(layouter)};this.updateGridLineValue("x");this.updateGridLineValue("y");converter.initGlobal(d3v4);converter.setPalette(palette);var isBubbleOrScatter=chartType===CHART_TYPE.BUBBLE||chartType===CHART_TYPE.SCATTER,isGridChart=chartType===CHART_TYPE.GRID,isWaterfall=chartType===CHART_TYPE.WATERFALL,isBoxPlot=chartType===CHART_TYPE.BOXPLOT,isABL=false,isClusteredBar,isColorByContainsGroupBy=colorByContainsGroupBy(gmCtr,groupBy),MAX_COLOR_NUM=512,hasColorBy,hasSizeBy;axesManager.hasRangeSlider=chartInfo.isSingleChart&&!isBubbleOrScatter&&this.showRS;this.setGL=chartInfo.isSingleChart&&gmCtr.getMetrics(0,0).length>ngm.threshold.webgl&&type==="scatter"&&isBubbleOrScatter;function setupGL(){var canvas=document.createElement("canvas"),gl=canvas.getContext("webgl")||canvas.getContext("experimental-webgl");if(gl&&gl instanceof WebGLRenderingContext){var getProgramParameter=gl.getProgramParameter;gl.isProgram=function(){return true;};gl.getProgramParameter=function(program,pname){if(pname===gl.LINK_STATUS){return true;}return getProgramParameter.call(gl,program,pname);};}}function isStackedBarSpecialCase(){if(chartType===2&&subtype===1){var dz=gmCtr.dz,colorByUnits=dz.ColorBy,breakByUnits=dz.BreakBy;if(colorByUnits.TemplateMetric&&breakByUnits.TemplateUnit){return true;}}return false;}chartInfo.stackedBarSpecialCase=isStackedBarSpecialCase();converter.config.gl=this.setGL;if(this.setGL&&!this.setupGL){setupGL();this.setupGL=true;}console.time("trace");for(var i=0;i<rct;i++){for(var j=0;j<cct;j++){if(j===0){this.axisTitles.y.push(gmCtr.getYAxisHeaderTitles(i,j));}if(i===rct-1){this.axisTitles.x.push(gmCtr.getXAxisHeaderTitles(i,j));}var config={};hasColorBy=gmCtr.hasColorBy();hasSizeBy=gmCtr.hasSizeBy();if(hasSizeBy){var sbi=gmCtr.getSizeByMetricsInfo(i,j)[0];if(sbi){converter.SCALE.mxSize.domain([sbi.min,sbi.max]);config.has_N_size=true;}}if(hasColorBy){var cbi=gmCtr.getSizeByMetricsInfo(i,j)[0];if(cbi){converter.SCALE.mxColor.domain([cbi.min,cbi.max]);}}raw=gmCtr.getMetrics(i,j);var sizeByInfo;if(gmCtr.hasSizeBy()){sizeByInfo=gmCtr.getSizeByMetricsInfo(i,j).concat(raw[0]&&raw[0].sbi);}raw=converter.attachKeys(raw,gmCtr.jsonModel);converter.concludeKeys(raw,allKeys,allNames);if(isBubbleOrScatter||isGridChart){if(isGridChart){axesManager.showGrid=false;}else{if(isBubbleOrScatter&&raw.length>BUBBLEFILTERTHRESHOLD){raw=converter.filter(raw,gmCtr.getExtremes(i,j),layouter.getWidgetDim());}}if(allKeys[colorBy]){if(allKeys[colorBy].length<MAX_COLOR_NUM){config.has_N_color=false;raw=converter.splitByColor(raw);raw=converter.trace4ScatterWithColor(raw,rct-i-1,j,config,isGridChart);data=data.concat(raw);}else{config.has_N_color=true;raw=converter.trace4Scatter(raw,rct-i-1,j,config,isGridChart);data.push(raw);}}else{config.has_N_color=hasColorBy;if(raw.length<ngm.threshold.density||hasColorBy||isGridChart){raw=converter.trace4Scatter(raw,rct-i-1,j,config,isGridChart);}else{config.exts=gmCtr.getExtremes(i,j);raw=converter.trace4Density(raw,rct-i-1,j,config);}data.push(raw);}}else{if(isABL){if(allKeys[colorBy]){if(allKeys[colorBy].length<MAX_COLOR_NUM){if(isClusteredBar&&isColorByContainsGroupBy){config.has_N_color=true;raw=converter.splitByGroup(raw,seriesBy,groupBy);raw=converter.generateTraces(raw,allKeys[groupBy],groupBy,rct-i-1,j,chartInfo,sizeByInfo,gmCtr.getAxisLabels(i,j),this.getEnhancedOptions(options,gmCtr,i,j));data=data.concat(raw);}else{config.has_N_color=false;}}else{config.has_N_color=true;}}else{config.has_N_color=hasColorBy;}}else{if(isBoxPlot){options=this.getBoxPlotOptions();options=this.getEnhancedOptions(options,gmCtr,i,j);raw=converter.splitByGroup4BoxPlot(raw,groupBy,seriesBy);raw=converter.generateBoxPlotTraces(raw,rct-i-1,j,chartInfo.ori,options);data=data.concat(raw);}else{if(isWaterfall){raw=converter.splitByGroup(raw,groupBy,seriesBy);options=this.getWaterfallOptions();options=this.getEnhancedOptions(options,gmCtr,i,j);raw=converter.generateWaterfallTraces(raw,allKeys[seriesBy],rct-i-1,j,chartInfo.ori,options,gmCtr);data=data.concat(raw);}else{raw=converter.splitByGroup(raw,seriesBy,groupBy);raw=converter.generateTraces(raw,allKeys[groupBy],groupBy,rct-i-1,j,chartInfo,sizeByInfo,gmCtr.getAxisLabels(i,j),this.getEnhancedOptions(options,gmCtr,i,j).nf);data=data.concat(raw);}}}}if(raw.length===0){layouter.addEmptySubplot({x:j+1,y:rct-i});}if((chartType===CHART_TYPE.BUBBLE||chartType===CHART_TYPE.SCATTER)&&chartInfo.isSingleChart&&this.showHistogram){data=data.concat(converter.generateHistogramTraces(data));converter.generateHistogramAxes(layouter);}}}console.timeEnd("trace");if(chartType===CHART_TYPE.LINE||chartType===CHART_TYPE.AREA){var firstWordArray=[],axes=gmCtr.getAttributeAxesLetters();for(i=0;i<axes.length;i++){data.forEach(function(datum,j){if(j%rct===0){firstWordArray.push(datum[axes[i]][0]);}});}}var showLegend;if(isWaterfall){showLegend=false;}else{if(isBoxPlot){showLegend=!!allKeys[colorBy];}else{showLegend=!!allKeys[colorBy]&&!isColorByContainsGroupBy;gmCtr.customLegend=this.GMController.hasColorBy()&&!showLegend;}}showLegend=showLegend&&this.readGlobalProperty(ENUM_XML_TAG.LEGEND_VISIBLE);layouter.setPlotlyLayout("showlegend",showLegend);layouter.setPlotlyLayout("hovermode","closest");this.setColorByOptions(allKeys,allNames,div);gmCtr.showLegend=showLegend;this.div=div;this.data=data;this.placeLegend();if(type==="histogram"){options=this.getHistogramOptions();data[0].nbinsx=options.numBins;if(options.xBins!==0){data[0].autobinx=false;data[0].xbins=options.xBins;}else{data[0].autobinx=true;data[0].xbins="";}layouter.setPlotlyLayout("bargroupgap",0);layouter.setPlotlyLayout("bargap",0);layouter.setPlotlyLayout("xaxis1.type","");}},placeLegend:function(){var gmCtr=this.GMController;if(gmCtr.showLegend||gmCtr.customLegend){var SLOTS=mstrmojo.gm.EnumLegendSlot,orientation="v",position="right",layouter=this.layouter,div=this.div,legendInH=0,legendInW=0,maxLegendItem=gmCtr.maxLegendItem,numberOfLegendItem=this.colorByOptions.length,legendDiv;switch(this.readGlobalProperty(ENUM_XML_TAG.LEGEND_POSITION)){case SLOTS.LEFT_TOP:orientation="h";position="top";legendDiv=this.legendTop;legendInH=(5+maxLegendItem)*numberOfLegendItem>this.getWidth()?60:40;legendDiv.style.height=legendInH+"px";legendDiv.style.width=this.getWidth()+"px";legendDiv.style.borderBottom="1px solid #ddd";layouter.setWidgetHeight(this.getHeight()-legendInH);break;case SLOTS.LEFT_BOTTOM:orientation="h";position="bottom";legendDiv=this.legendBottom;legendInH=(5+maxLegendItem)*numberOfLegendItem>this.getWidth()?60:40;legendDiv.style.height=legendInH+"px";legendDiv.style.width=this.getWidth()+"px";legendDiv.style.borderTop="1px solid #ddd";legendDiv.style.position="absolute";legendDiv.style.top=this.getHeight()-legendInH+"px";layouter.setWidgetHeight(this.getHeight()-legendInH);break;case SLOTS.LEFT:orientation="v";position="left";break;case SLOTS.RIGHT:case SLOTS.RIGHT_MIDDLE:orientation="v";position="right";legendDiv=this.legendRight;legendInW=Math.min(maxLegendItem,this.getWidth()/4);legendDiv.style.width=legendInW+"px";legendDiv.style.height=this.getHeight()+"px";legendDiv.style.borderLeft="1px solid #ddd";legendDiv.style.position="absolute";legendDiv.style.left=this.getWidth()-legendInW+"px";layouter.setWidgetWidth(this.getWidth()-legendInW);break;default:break;}this.legendInH=legendInH;this.legendInW=legendInW;this.legendPosition=position;layouter.setPlotlyLayout("legend.orientation",orientation);layouter.setPlotlyLayout("legend.position",position);div.reverseLegend=gmCtr.getNewChartType()===CHART_TYPE.AREA;div.isLegendCollapsed=false;div.isLegendImage=false;div.legendDiv=legendDiv;div.widgetDim={width:this.getWidth(),height:this.getHeight()};}this.sizeMainContainer();},getSeriesDataLabelProcessor:function getSeriesDataLabelProcessor(){var converter=ngm.converter,series=this.data,gmCtr=this.GMController;var informationCallback=function(information){var results=information.map(function(units){var itm;if(units&&units.length){var itmBuffer=[];for(var i=units.length-1;i>=0;i--){var unit=units[i];if(unit.dropzones.indexOf("BreakBy")!==-1){var u=gmCtr.jsonModel.queryByIdentity(unit);itmBuffer.push(u.headerText);}}if(itmBuffer.length>0){itm=itmBuffer.join("|");}}return itm;});return results;};return new converter.SeriesDataLabelProcessor(series,this.getDataLabelProps(),CHART_TYPE,function(metricIndex){var metricInfo=gmCtr.getMetricFormat(metricIndex);return metricInfo?metricInfo.nf:undefined;},informationCallback);},generateDataLabelData:function generateDataLabelData(){this.getSeriesDataLabelProcessor().attach();},restyleDataLabelData:function restyleDataLabelData(){var result=this.getSeriesDataLabelProcessor().get();Plotly.restyle(this.div,result.update,result.traceIndices);},getCellForNode:function getCellForNode(cell){return cell.identity;},getCellUnitIndex:function getCellUnitIndex(cell){return(cell.o!==undefined)?cell.o:cell._ei;},getAvailableRefLineTypes:function getAvailableRefLineType(){return ;},queryTrendLineStatusForMetric:function queryTrendLineStatusForMetric(){return ;},updateLegendPosition:function updateLegendPosition(value){var SLOTS=mstrmojo.gm.EnumLegendSlot,orientation="v",position="right";switch(value){case SLOTS.LEFT_TOP:orientation="h";position="top";break;case SLOTS.LEFT_BOTTOM:orientation="h";position="bottom";break;case SLOTS.LEFT:orientation="v";position="left";break;case SLOTS.RIGHT:orientation="v";position="right";break;default:break;}this.legendPosition=position;this.layouter.setPlotlyLayout("legend.orientation",orientation);this.layouter.setPlotlyLayout("legend.position",position);},getTemplateUpdateForKeepOnlyAndShow:function getTemplateUpdateForKeepOnlyAndShow(drillUnit,fromUnit){var me=this,ROWS=$DZ_ID.Rows,COLUMNS=$DZ_ID.Columns,XAXIS=$DZ_ID.XAxis,YAXIS=$DZ_ID.YAxis,BREAKBY=$DZ_ID.BreakBy,COLORBY=$DZ_ID.ColorBy,SLICEBY=$DZ_ID.SliceBy,TOOLTIP=$DZ_ID.AdditionalMetrics,HORIZONTAL=$CDZ_ENUM.HORIZONTAL,VERTICAL=$CDZ_ENUM.VERTICAL;var model=me.model,docModel=me.getDocModel(),dataService=docModel.getDataService(),update=dataService.newUpdate(this);var updateTemplateActions={act:"updateTemplate",keyContext:me.k,actions:[]},posIdx,keepParent=true,tplActArr=updateTemplateActions.actions,gmCtr=me.GMController,chtInfo=gmCtr.getChartInfo(),chtType=chtInfo.tp,dzModel=me.zonesModel,nonCombinedDzModel=dzModel.gmZones,unitItem={did:undefined,t:12},argumentZone={id:undefined,items:[]},naiveCallback=dzModel.getUpdateCallback(),callback=this.getXTabRefreshCallBack(),tooltipZone=dzModel.getZoneModelByZoneId(TOOLTIP);if(fromUnit){argumentZone.id=fromUnit.isRowAttribute?ROWS:COLUMNS;unitItem.did=drillUnit.did;unitItem.t=drillUnit.t;if(docModel.prefs&&docModel.prefs.rtprnt){keepParent=parseInt(docModel.prefs.rtprnt,10)===1;}else{if(model.xtab.defn.tkp!==undefined){keepParent=parseInt(model.xtab.defn.tkp,10)===-1;}}var fromUnitItem,zone=nonCombinedDzModel.getZoneModelByZoneId(argumentZone.id);zone.items.forEach(function(it){if(it.did===fromUnit.tid){fromUnitItem=it;return false;}});if(keepParent){tplActArr.push(dzModel.getAddDZUnitAction(argumentZone,unitItem,fromUnitItem?fromUnitItem.uidx+1:0));}else{if(fromUnitItem){Array.prototype.push.apply(tplActArr,nonCombinedDzModel.getRemoveDropZoneUnitActions(argumentZone,fromUnitItem));tplActArr.push(dzModel.getAddDZUnitAction(argumentZone,unitItem,fromUnitItem.uidx));}}}else{if(chtInfo.isPie){var targetZoneID=$DZ_ID.SliceBy,hasAttrInCb=false;unitItem.did=drillUnit.did;unitItem.t=drillUnit.t;if(gmCtr.hasColorBy()){var cz=dzModel.getZoneModelByZoneId(COLORBY);(cz&&cz.items||[]).forEach(function(item){if(dzModel.isAttribute(item)){Array.prototype.push.apply(tplActArr,dzModel.getRemoveDropZoneUnitActions(cz,item));hasAttrInCb=true;}});if(hasAttrInCb){tplActArr.push(dzModel.getAddDZUnitAction($HASH.copy({id:COLORBY},$HASH.copy(argumentZone,{})),unitItem));}}$ARR.forEach([HORIZONTAL,VERTICAL,BREAKBY,SLICEBY],function(zoneID){var dz=dzModel.getZoneModelByZoneId(zoneID);if(dz&&dz.items&&dz.items.length>0){if(zoneID===HORIZONTAL){dz.items.forEach(function(item){if(item.zone===XAXIS){if(dzModel.isAttribute(item)){targetZoneID=item.zone;}}else{if(item.zone===COLUMNS){if(targetZoneID!==XAXIS&&targetZoneID!==YAXIS){targetZoneID=item.zone;}}}});}else{if(zoneID===VERTICAL){dz.items.forEach(function(item){if(item.zone===YAXIS){if(dzModel.isAttribute(item)){if(targetZoneID!==XAXIS){targetZoneID=item.zone;}}}else{if(item.zone===ROWS){if(targetZoneID!==XAXIS&&targetZoneID!==YAXIS&&targetZoneID!==COLUMNS){targetZoneID=item.zone;}}}});}else{targetZoneID=zoneID;}}}});tplActArr.push(dzModel.getAddDZUnitAction($HASH.copy({id:targetZoneID},$HASH.copy(argumentZone,{})),unitItem));}else{if(chtType===CHART_TYPE.BUBBLE||chtType===CHART_TYPE.SCATTER){argumentZone.id=BREAKBY;unitItem.did=drillUnit.did;unitItem.t=drillUnit.t;posIdx=nonCombinedDzModel.getItemCountInZone(argumentZone.id);tplActArr.push(dzModel.getAddDZUnitAction(argumentZone,unitItem,posIdx));}else{if(chtInfo.isABL||chtType===CHART_TYPE.GRID){if(chtInfo.isPie){unitItem.did=drillUnit.did;unitItem.t=drillUnit.t;tplActArr.push(dzModel.getAddDZUnitAction($HASH.copy({id:COLORBY},$HASH.copy(argumentZone,{})),unitItem));tplActArr.push(dzModel.getAddDZUnitAction($HASH.copy({id:SLICEBY},$HASH.copy(argumentZone,{})),unitItem));}else{if(chtType===CHART_TYPE.GRID||chtInfo.dirc===mstrmojo.gm.EnumABLDirection.VERTICAL){$ARR.forEach(dzModel.moveAttributesToZone(XAXIS,COLUMNS),function(act){tplActArr.push(act);});argumentZone.id=XAXIS;unitItem.did=drillUnit.did;unitItem.t=drillUnit.t;tplActArr.push(dzModel.getAddDZUnitAction(argumentZone,unitItem,0));if(tooltipZone){tplActArr.push(dzModel.getAddDZUnitAction(tooltipZone,unitItem,0));}}else{$ARR.forEach(dzModel.moveAttributesToZone(YAXIS,ROWS),function(act){tplActArr.push(act);});argumentZone.id=YAXIS;unitItem.did=drillUnit.did;unitItem.t=drillUnit.t;tplActArr.push(dzModel.getAddDZUnitAction(argumentZone,unitItem,0));if(tooltipZone){tplActArr.push(dzModel.getAddDZUnitAction(tooltipZone,unitItem,dzModel.gmZones.getTooltipDropzoneIdx(unitItem)));}}}}}}}update.add(updateTemplateActions,$WRAP(naiveCallback,callback));return update;},isDragValid:function isDragValid(){return false;},shouldDragBubble:function shouldDragBubble(){return false;},plotPlotly:function(){var layouter=this.layouter;var div=this.div;var gmCtr=this.GMController;var data=this.data;var chartInfo=this.chartInfo,isABL=chartInfo.chartType===CHART_TYPE.BAR||chartInfo.chartType===CHART_TYPE.AREA||chartInfo.chartType===CHART_TYPE.LINE;var modebarMode=getModebarMode(layouter);var buttonsToRemove=["toImage","sendDataToCloud","autoScale2d","hoverClosestCartesian","toggleSpikelines"];if(modebarMode===ngm.Modebar.MODE.COMPACT||modebarMode===ngm.Modebar.MODE.MINI){buttonsToRemove=buttonsToRemove.concat(["zoomOut2d","zoomIn2d"]);}this.config={displaylogo:false,displayModeBar:true,modeBarButtonsToRemove:buttonsToRemove,isMobile:mstrmojo.dom.isMobile,modebarMode:modebarMode};if(this.dragmode===undefined){if(this.config.isMobile){this.dragmode=null;}else{this.dragmode=(chartInfo.chartType===CHART_TYPE.BOXPLOT?"zoom":"select");}}layouter.setPlotlyLayout("dragmode",this.dragmode);if(!isABL){this.config.modeBarButtonsToRemove.push("hoverCompareCartesian");}if(gmCtr.isWaterfall){this.updateWaterfallLayout(data,layouter);}layouter.setPlotlyLayout("hasHorizontalScroll",layouter.getPlotlyWidth()>layouter.getWidgetWidth());console.time("render");div.widgetDim=div.widgetDim={width:this.getWidth(),height:this.getHeight()};Plotly.newPlot(this.div,this.data,layouter.clonePlotlyLayout(),this.config);console.timeEnd("render");var widgetDim=layouter.getWidgetDim(),mainContainer=d3v4.select(this.domMainContainer),hasBreakBy=this.allKeys.BreakBy&&this.allKeys.BreakBy.length>0,disableCompareMode=!(isABL&&hasBreakBy);var isExpanded=this.modebar&&this.modebar.isExpanded;var mb=new ngm.Modebar(mainContainer,widgetDim.width,this.layouter,disableCompareMode,this.toolbarStrings,modebarMode,isExpanded);this.modebar=mb;mb.padding.top=this.parent.showTitleBar?ngm.Modebar.PADDING.TOP_WITH_TITLE:ngm.Modebar.PADDING.TOP_NO_TITLE;if(!this.getWidgetPropertyValue("showModeBar")||(modebarMode===ngm.Modebar.MODE.MINI&&widgetDim.height<300)){this.modebar.setVisibility(false);}if(this.GMController.isHistogram){this.postPlotHistogram(div,layouter);}if(this._viSelections){this.highlight("metric",this._viSelections,true);}},makeAxisLine:function(container,dir,width,top,left,height){var div=document.createElement("div");var line=new mstrmojo.VisSplitter({draggable:false,placeholder:div,cssClass:"gm-axis-line",styles:{borderColor:"#E0E0E0",borderLeftStyle:"solid",borderWidth:"1px"},dir:dir});this.addDisposable(line);line.render();div=line.domNode;container.appendChild(div);line.updatePosition({top:top,left:left,height:height,width:width});return line;},drawDividers:function(){var colDividers=this.lines.colDividers,colViewport=this.lines.colViewport,rowDividers=this.lines.rowDividers,rowViewport=this.lines.rowViewport,headerLines=this.lines.headerLines;var layouter=this.layouter,widgetDim=layouter.getWidgetDim(),viewDim=layouter.getViewDim(),scrollW=layouter.getScrollW(),scrollH=layouter.getScrollH(),margin=layouter.getMarginDim();var me=this;clearAllLines();drawColumnDividers();drawRowDividers();drawColumnHeaderLines();drawRowHeaderLines();function clearAllLines(){colDividers.selectAll("*").remove();rowDividers.selectAll("*").remove();headerLines.selectAll("*").remove();}function drawColumnDividers(){colViewport.style("width",viewDim.width-margin.left-scrollW+"px");colViewport.style("height",widgetDim.height-margin.bottom-scrollH+"px");colViewport.style("left",layouter.getRowHeaderFullWidth()+margin.left+"px");var container=colDividers.node(),cct=layouter._cct;var left=0,top,width=1,height;for(var i=0;i<cct;i++){left+=layouter.getCellWidth(i);height=widgetDim.height-layouter.getAxisLineTop(i);top=layouter.getAxisLineTop(i);me.makeAxisLine(container,"v",width,top,left,height);}}function drawRowDividers(){rowViewport.style("width",widgetDim.width-scrollW+"px");rowViewport.style("height",viewDim.height-margin.bottom-scrollH+"px");rowViewport.style("top",layouter.getColHeaderFullHeight()+"px");var container=rowDividers.node(),rct=layouter._rct;var top=margin.top,left,width,height=1;for(var i=0;i<rct;i++){top+=layouter.getCellHeight(i);left=layouter.getAxisLineLeft(i);width=widgetDim.width-layouter.getAxisLineLeft(i);me.makeAxisLine(container,"h",width,top,left,height);}}function drawColumnHeaderLines(){var colHeaderLines=layouter.getColHeaderHeight();var container=headerLines.node();var top=0,left=0,width=widgetDim.width,height=1;for(var i=0;i<colHeaderLines.length;i++){top+=colHeaderLines[i];me.makeAxisLine(container,"h",width,top,left,height);}}function drawRowHeaderLines(){var rowHeaderLines=layouter.getRowHeaderWidth();var container=headerLines.node();var top=0,left=0,width=1,height=widgetDim.height-margin.bottom;for(var i=0;i<rowHeaderLines.length;i++){left+=rowHeaderLines[i];me.makeAxisLine(container,"v",width,top,left,height);}}},postPlotly:function(){var me=this,rct=me._rct,slots=me._slots,chart=slots.domChart,chartDiv=chart.node(),legendSVG=d3v4.select(me.domNode).select(".legend-svg"),mainContainer=d3v4.select(me.domMainContainer),plot=chart.select(".plot-container"),legendPosition=this.legendPosition;var layouter=this.layouter,widgetDim=layouter.getWidgetDim(),plotlyDim=layouter.getPlotlyDim(),chartDim=layouter.getChartDim(),viewDim=layouter.getViewDim(),scrollW=layouter.getScrollW(),scrollH=layouter.getScrollH(),margin=layouter.getMarginDim();var gmCtr=this.GMController;this.drawDividers();var colDividers=this.lines.colDividers,colViewport=this.lines.colViewport,rowDividers=this.lines.rowDividers,rowViewport=this.lines.rowViewport,headerLines=this.lines.headerLines;slots.domRowContent.style("height",chartDim.height+"px");slots.domRowBottom.style("height",margin.bottom+scrollH+"px");slots.domColLeft.style("width",margin.left+"px");slots.domColContent.style("width",1+"px");slots.domColRight.style("width",margin.right+scrollW+"px");slots.domRowContainer.style("height",viewDim.height-margin.bottom-scrollH+"px");slots.domRowContent.selectAll("td").attr("width",layouter.DIM.ROW_WIDTH+"px");slots.domColContent.selectAll("td").attr("height",layouter.DIM.COL_HEIGHT+"px");slots.domRowTop.selectAll("td").attr("width",layouter.DIM.ROW_WIDTH+"px");slots.domColLeftNoAxis.selectAll("td").attr("width",layouter.DIM.ROW_WIDTH+"px");slots.domColLeftNoAxis.selectAll("td").attr("height",layouter.DIM.COL_HEIGHT+"px");slots.domColLeft.selectAll("td").attr("height",layouter.DIM.COL_HEIGHT+"px");var titleWidth=(margin.left-(16*gmCtr.getYAxisHeaderTitles(0,0).length)-(2*gmCtr.getYAxisHeaderTitles(0,0).length-1))/gmCtr.getYAxisHeaderTitles(0,0).length;slots.domAxisLeft.selectAll(".header-text-wrap").style("width",titleWidth+"px");slots.domAxisLeft.style("width",margin.left+"px");slots.domAxisRight.style("width",margin.right+scrollW+"px");slots.domAxisContent.style("width",chartDim.width+"px");var colMaxScrollLeft=slots.domColContainer.node().scrollWidth-slots.domColContainer.node().clientWidth;var info=chart.select(".infolayer");if(gmCtr.customLegend){this.drawLegend(legendSVG,this.getWidth(),this.getHeight());}var xOrigins=[],yOrigins=[];var yAxes=info.selectAll(".axis .yaxislayer").each(function(){pushTranslateCoords(this,yOrigins);}),xAxes=info.selectAll(".axis .xaxislayer").each(function(){pushTranslateCoords(this,xOrigins);}),yTitles=info.selectAll("g[class^='g-y']"),xTitles=info.selectAll("g[class^='g-x']");this.rectBGs={yBg:info.insert("rect","g").attr("width",margin.left).attr("height",plotlyDim.height).classed("y-bg",true).attr("fill",this.bgColor),xBg:info.insert("rect","g").attr("height",margin.bottom).attr("width",plotlyDim.width).classed("x-bg",true).attr("fill",this.bgColor),intersect:info.append("rect").attr("width",margin.left).attr("height",margin.bottom).classed("intersect",true).attr("fill",this.bgColor),rightBg:legendSVG.insert("rect","g").attr("width",margin.right).attr("height",plotlyDim.height).classed("r-bg",true).attr("fill",this.bgColor)};var xBg=this.rectBGs.xBg,yBg=this.rectBGs.yBg,intersect=this.rectBGs.intersect,rightBg=this.rectBGs.rightBg;if(this.hasYAxis){this.makeAxisLine(headerLines.node(),"v",1,0,layouter.getRowHeaderFullWidth()+margin.left-1,Math.min(plotlyDim.height+layouter.getColHeaderFullHeight(),widgetDim.height)-margin.bottom+1);}if(this.hasXAxis||gmCtr.isHistogram){this.makeAxisLine(headerLines.node(),"h",rct>1?widgetDim.width-scrollW:viewDim.width-margin.left-3-scrollW,Math.min(plotlyDim.height+layouter.getColHeaderFullHeight(),widgetDim.height)-margin.bottom+1,rct>1?0:layouter.getRowHeaderFullWidth()+margin.left,1);}var attributeAxesLetters=gmCtr.getAttributeAxesLetters(),isXAxisAttribute=attributeAxesLetters.indexOf("x")!==-1,isYAxisAttribute=attributeAxesLetters.indexOf("y")!==-1;var xTitleTranslateX=isXAxisAttribute||gmCtr.isHistogram?(viewDim.width-margin.left-margin.right)/2+margin.left:0,xTitleTranslateY=Math.min(0,layouter.getDeltaY()-(plotlyDim.height-viewDim.height)),yTitleTranslate=isYAxisAttribute?(Math.min(viewDim.height,plotlyDim.height)-margin.bottom)/2:0;var mb=this.modebar;if(me.axesManager.truncateAxes.length>0){truncateAxes();}truncateAxesTitles();removeProtrudingMetricAxisLabels(me.axesManager,layouter);initializePositions();if(this.setGL){yBg.style("opacity",0);xBg.style("opacity",0);}function truncateAxesTitles(){var axesManager=me.axesManager;["x","y"].forEach(function(axis){if(!axesManager[axis].title.show||axesManager[axis].title.isInHeader){return ;}var context=ngm.canvas.getContext(),isY=axis==="y",titles=isY?yTitles:xTitles,length;if(gmCtr.getAttributeAxesLetters().indexOf(axis)<0){length=isY?layouter.getCellHeight(0,0):layouter.getCellWidth(0,0);}else{length=isY?layouter.getViewHeight():layouter.getViewWidth();}truncateTitle(axis,titles,length-12,context);});function truncateTitle(axis,titles,requiredPx,context){context.font=me.axesManager[axis].title.font.size+"px "+me.axesManager[axis].title.font.family;var textSVG=titles.selectAll("text");if(textSVG.node()===null){return ;}var maxStringLength=0;textSVG.each(function(){var text=d3v4.select(this).text(),textLength=text.length,textLengthPx=context.measureText(text).width,stringLength=Math.round(textLength*requiredPx/textLengthPx);maxStringLength=Math.max(maxStringLength,stringLength);});textSVG.each(function(){return wrapText.call(this,maxStringLength,requiredPx);});}}function truncateAxes(){var axesManager=me.axesManager;var maxStringLength;var truncateAxesConfig=axesManager.truncateAxes;var axesMap={x:xAxes,y:yAxes};truncateAxesConfig.forEach(function(axisLetter){var axisConfig=axesManager[axisLetter].label.truncate;maxStringLength=Math.round(axisConfig.longestChar*axisConfig.requiredpx/axisConfig.longestpx);for(var i=0;i<axesMap[axisLetter]._groups[0].length;i++){var context=ngm.canvas.getContext(),requiredpx=axisConfig.requiredpx;context.font=axesManager[axisLetter].label.font.size+"px "+axesManager[axisLetter].label.font.family;var textGroup=d3v4.select(axesMap[axisLetter]._groups[0][i]).selectAll("text");textGroup.each(function(){return wrapText.call(this,maxStringLength,requiredpx);});}});}function wrapText(maxStringLength,requiredpx){var self=d3v4.select(this),text=self.text(),textLength=text.length,context=ngm.canvas.getContext();if(textLength>maxStringLength&&context.measureText(text).width>requiredpx){var i=maxStringLength-3;var subText=text.substring(0,i);while(context.measureText(subText+"...").width>requiredpx&&subText.length>0){subText=subText.substring(0,subText.length-1);i--;}while(context.measureText(subText+text[i]+"...").width<requiredpx&&i<textLength){subText+=text[i];i++;}self.text(subText+"...");}}function pushTranslateCoords(axisg,origins){var transform=axisg.getAttribute(TRANSFORM),coords=parseTranslateString(transform),x=coords.x,y=coords.y||0;origins.push({x:x,y:y});}function translate(everyone,origins,x,y){everyone.each(function(a,i){transformSVG(d3v4.select(this),origins[i].x+x,origins[i].y+y);});}function move(everyone,position){everyone.each(function(){var transform=this.getAttribute(TRANSFORM),y=position.y!==undefined?position.y:transform?parseTranslateString(transform).y:0,x=position.x!==undefined?position.x:transform?parseTranslateString(transform).x:0;transformSVG(d3v4.select(this),x,y);});}function position(obj,attr,val){obj.style(attr,val+"px");}function fixScrollBar(){var chartWidth=plotlyDim.width-layouter.getScrollW(),chartHeight=plotlyDim.height-layouter.getScrollH();if(chartWidth<=viewDim.width&&chartHeight<=viewDim.height){plot.style("overflow-y","hidden");plot.style("overflow-x","hidden");}else{if(chartWidth>viewDim.width&&chartHeight<=viewDim.height){plot.style("overflow-y","hidden");plot.style("overflow-x","scroll");}else{if(chartHeight>viewDim.height&&chartWidth<=viewDim.width){plot.style("overflow-x","hidden");plot.style("overflow-y","scroll");}else{plot.style("overflow-y","scroll");plot.style("overflow-x","scroll");}}}}function initializePositions(){intersect.remove();intersect=info.append("rect").attr("width",margin.left).attr("height",margin.bottom).classed("intersect",true).attr("fill",me.bgColor);translate(xAxes,xOrigins,0,Math.min(0,layouter.getDeltaY()-(plotlyDim.height-viewDim.height)));translate(yAxes,yOrigins,layouter.getDeltaX(),0);move(xTitles,{x:xTitleTranslateX,y:xTitleTranslateY});move(yTitles,{x:0,y:yTitleTranslate});move(xBg,{x:0,y:viewDim.height-margin.bottom+layouter.getDeltaY()});move(yBg,{x:layouter.getDeltaX(),y:0});move(intersect,{x:layouter.getDeltaX(),y:viewDim.height-margin.bottom+layouter.getDeltaY()});move(rightBg,{x:plotlyDim.width-margin.right+1,y:0});colDividers.style("left","0px");rowDividers.style("top","0px");}function getLegendPosition(){var SLOTS=mstrmojo.gm.EnumLegendSlot,position="right";switch(me.readGlobalProperty(ENUM_XML_TAG.LEGEND_POSITION)){case SLOTS.LEFT_TOP:position="top";break;case SLOTS.LEFT_BOTTOM:position="bottom";break;case SLOTS.LEFT:position="left";break;case SLOTS.RIGHT:position="right";break;}return position;}function removeProtrudingMetricAxisLabels(axesManager,layouter){var axesMap={x:xAxes,y:yAxes};var metricAxesLetters=gmCtr.isHistogram?["x","y"]:gmCtr.getMetricAxesLetters();var metricAxes=[];metricAxesLetters.forEach(function(letter){metricAxes.push(axesMap[letter]);});metricAxes.forEach(function(axis){removeProtrudingTickLabels(axis);});function removeProtrudingTickLabels(axis){var chartWidth=layouter.getPlotlyWidth(),chartHeight=layouter.getChartHeight(),yAxisTranslate=parseTranslateString(yAxes.node().getAttribute(TRANSFORM)).y,xAxisTranslate=parseTranslateString(xAxes.nodes()[xAxes.size()-1].getAttribute(TRANSFORM)).x;var isProtrudingFn={yMax:function(translate,width){return width/2>translate;},yMin:function(translate,width){return translate+width/2+yAxisTranslate>chartHeight;},xMin:function(translate,width){return width/2>translate;},xMax:function(translate,width){return translate+width/2+xAxisTranslate>chartWidth;}};axis.each(function(){var axisLetter=this.getAttribute("class")[0],textGroup=this.querySelectorAll("[class$='ticklabels']"),size=textGroup.length;if(size>0){removeTickLabel.call(this,axisLetter,textGroup[0],isProtrudingFn[axisLetter+"Min"]);removeTickLabel.call(this,axisLetter,textGroup[size-1],isProtrudingFn[axisLetter+"Max"]);}});}function removeTickLabel(axisLetter,text,isProtruding){var transform,translate,width,fontStyle,fontSize,rotation;transform=text.firstChild.getAttribute(TRANSFORM);rotation=parseRotationString(transform)[axisLetter];translate=parseTranslateString(transform)[axisLetter];fontStyle=mstrmojo.VisUtility.getComputedFontStyle(text.firstChild);fontSize=axesManager[axisLetter].label.font.size;width=(rotation===-90||axisLetter==="y")?fontSize:mstrmojo.VisUtility.measureTextWidth(text.firstChild.textContent,fontStyle);if(isProtruding(translate,width)){text.style.display="none";}}}mainContainer.on("mouseleave",function(){if(!mb.isDragged){mb.setMouseLeave();me.setActive(false);}}).on("mouseenter",function(){mb.setMouseEnter();me.setActive(true);});var tooltip=this.tooltip||new ngm.Tooltip(this.tooltipStrings);if(!this.tooltip){this.tooltip=tooltip;}chartDiv.on("plotly_relayout",function(){if(me.axesManager.truncateAxes.length>0){truncateAxes();}truncateAxesTitles();removeProtrudingMetricAxisLabels(me.axesManager,layouter);});chartDiv.on("plotly_afterplot",function(){clearScroll.call(me);fixScrollBar();plot.style("width",viewDim.width+"px").style("height",viewDim.height+"px");yTitles=info.selectAll("g[class^='g-y']");xTitles=info.selectAll("g[class^='g-x']");xTitleTranslateY=Math.min(0,0-(plotlyDim.height-viewDim.height));legendPosition=getLegendPosition();position(mb.getModebar(),"left",widgetDim.width-mb.getWidth()-ngm.Modebar.PADDING.RIGHT);position(mb.getModebar(),"top",mb.padding.top);initializePositions();if(me.axesManager.truncateAxes.length>0){truncateAxes();}truncateAxesTitles();removeProtrudingMetricAxisLabels(me.axesManager,layouter);});rowViewport.on("wheel mousewheel",function(){plot.node().scrollTop+=d3v4.event.deltaY;plot.node().scrollLeft+=d3v4.event.deltaX;});colViewport.on("wheel mousewheel",function(){plot.node().scrollTop+=d3v4.event.deltaY;plot.node().scrollLeft+=d3v4.event.deltaX;});plot.on("scroll",function(){var target=d3v4.event.target,scrollLeft=target.scrollLeft,scrollTop=target.scrollTop;if(layouter.getDeltaX()!==scrollLeft){layouter.setDeltaX(scrollLeft);translate(yAxes,yOrigins,scrollLeft,0);move(yTitles,{x:scrollLeft});if(xTitleTranslateX){move(xTitles,{x:scrollLeft+xTitleTranslateX});}slots.domColContainer.node().scrollLeft=scrollLeft;slots.domColContainer.style(TRANSFORM,getTranslateString(Math.min(0,colMaxScrollLeft-scrollLeft),0));slots.domColLeft.style(TRANSFORM,getTranslateString(scrollLeft,0));move(yBg,{x:scrollLeft,y:0});colDividers.style("left",-scrollLeft+"px");}if(layouter.getDeltaY()!==scrollTop){layouter.setDeltaY(scrollTop);translate(xAxes,xOrigins,0,Math.min(0,scrollTop-(plotlyDim.height-viewDim.height)));move(xTitles,{y:scrollTop+xTitleTranslateY});if(yTitleTranslate){move(yTitles,{y:scrollTop+yTitleTranslate});}slots.domRowContainer.node().scrollTop=scrollTop;move(xBg,{x:0,y:viewDim.height-margin.bottom+scrollTop});rowDividers.style("top",-scrollTop+"px");}intersect.style(TRANSFORM,getTranslateString(scrollLeft,viewDim.height-margin.bottom+scrollTop));});chartDiv.on("plotly_hover",function(eventData){me.interactor.onHover(tooltip,eventData,gmCtr,ngm.canvas.getContext(),me._rct,layouter,me.div.calcdata,chartDiv.firstChild,me);}).on("plotly_unhover",function(){me.interactor.onUnhover(chartDiv.firstChild,tooltip,me);});var div=chartDiv,ctrlKey;chartDiv.on("ngm_contextmenu",function(d){var ctrlKey=d.event&&(d.event.ctrlKey||d.event.metaKey);me.model.docModel.setVisActive(me.id);me.interactor.onContextMenu(me,div,d,ctrlKey);d.event.preventDefault();d.event.stopPropagation();});chartDiv.on("plotly_click",function(d){ctrlKey=d.event&&(d.event.ctrlKey||d.event.metaKey);me.model.docModel.setVisActive(me.id);if(d.event.which===3){me.interactor.onContextMenu(me,div,d,ctrlKey);d.event.preventDefault();d.event.stopPropagation();return false;}else{var touchHover=true;me.interactor.onHover(tooltip,d,gmCtr,ngm.canvas.getContext(),me._rct,layouter,me.div.calcdata,chartDiv.firstChild,me,touchHover);tooltip.move.call(tooltip,layouter)(d.event);me.interactor.onClick(me,div,d,ctrlKey);function getCleanHoverHandler(chartDiv,tooltip,me,touchHover){return function(){me.interactor.onUnhover(chartDiv.firstChild,tooltip,me,touchHover);};}setTimeout(getCleanHoverHandler(chartDiv,tooltip,me,touchHover),2500);}});chartDiv.on("plotly_selected",function(d){me.model.docModel.setVisActive(me.id);ctrlKey=d.event&&(d.event.ctrlKey||d.event.metaKey);me.interactor.onSelected(me,div,d,ctrlKey);});chartDiv.on("plotly_deselect",function(d){me.model.docModel.setVisActive(me.id);ctrlKey=d&&d.event&&(d.event.ctrlKey||d.event.metaKey);me.interactor.onSelected(me,div,d,ctrlKey);});chartDiv.on("plotly_paper_click",function(d){var e=d.event,ctrlKey=e&&(e.ctrlKey||e.metaKey),touchHover=true;me.interactor.onUnhover(chartDiv.firstChild,tooltip,me,touchHover);me.model.docModel.setVisActive(me.id);me.interactor.onPaperClick(me,chartDiv,e,ctrlKey);var rect=intersect.node().getBoundingClientRect();if(e.x-rect.left<margin.l&&rect.bottom-e.y<margin.b){me.showRS=!me.showRS;me.showHistogram=!me.showHistogram;me.domMainContainer.innerHTML="";me.postBuildRendering();}return false;});chartDiv.addEventListener("contextmenu",function(e){var ctrlKey=e&&(e.ctrlKey||e.metaKey);me.model.docModel.setVisActive(me.id);me.interactor.onPaperClick(me,chartDiv,e,ctrlKey);e.preventDefault();e.stopPropagation();return false;});chartDiv.on("ngm_change_dragmode",function(eventdata){me.dragmode=eventdata.dragmode;});chartDiv.on("ngm_layoutChanged",function(eventdata){me.interactor.onLayoutChanged(eventdata,chartDiv);});chartDiv.on("ngm_before_relayout_zooming",function(eventdata){if(me.dragmode==="pan"||me._rct!==1||me._cct!==1||!eventdata){return ;}else{var width=me.layouter.getPlotlyWidth(),height=me.layouter.getPlotlyHeight();for(var key in eventdata){if(eventdata.hasOwnProperty(key)){if(key.indexOf(".range")!==-1&&key.indexOf(".autorange")===-1){if(key.indexOf("xaxis")!==-1){width=me.layouter.getViewWidth();}if(key.indexOf("yaxis")!==-1){height=me.layouter.getViewHeight();}}else{if(key.indexOf("xaxis")!==-1){width=me.layouter.getPlotlyWidth();}if(key.indexOf("yaxis")!==-1){height=me.layouter.getPlotlyHeight();}}}}eventdata.width=width;eventdata.height=height;}});chartDiv.on("plotly_doubleclick",function(){Plotly.relayout(chartDiv,"");if(me.GMController.isHistogram){me.postPlotHistogram(chartDiv,me.layouter);}});chartDiv.on("ngm_after_relayout",function(){if(me._viSelections){me.highlight("metric",me._viSelections,true);}});var scrollHelper=function(originalEvent,dx,dy){me.model.docModel.setVisActive(me.id);var node=me._slots.domChart.select(".plot-container").node();var nodeDim=node.getBoundingClientRect();var x=node.scrollLeft||0,y=node.scrollTop||0,nx=x-dx,ny=y-dy,maxX=Math.round(node.scrollWidth-nodeDim.width),maxY=Math.round(node.scrollHeight-nodeDim.height);maxX=(maxX>0)?maxX:0;maxY=(maxY>0)?maxY:0;ny=(ny<0)?0:ny;ny=(ny>maxY)?maxY:ny;nx=(nx<0)?0:nx;nx=(nx>maxX)?maxX:nx;if(y===ny){me.getDocModel().raiseEvent($HASH.copy({name:"visOutsideScrolled",deltaX:0,deltaY:dy,originalEvent:originalEvent},{}));}else{if(y!==ny){node.scrollTop=ny;}}if(x===nx){me.getDocModel().raiseEvent($HASH.copy({name:"visOutsideScrolled",deltaX:dx,deltaY:0,originalEvent:originalEvent},{}));}else{if(x!==nx){node.scrollLeft=nx;}}};$VISUTILS.addBasicTouchSupport(chartDiv,me,undefined,function(details){scrollHelper(details.event,details.deltaX,details.deltaY);});chartDiv.on("ngm_none_dragmode_move",function(d){scrollHelper(d.moveFnEvent,d.dx,d.dy);});this.contextmenuListener=$DOM.attachEvent(document,"contextmenu",function(e){if(e.preventDefault){e.preventDefault();}});if(gmCtr.isHistogram){var restButton=chartDiv.ownerDocument.getElementById("resetScale2d");restButton.addEventListener("click",function(){me.postPlotHistogram(chartDiv,layouter);});}var myId=this.id;this.model.docModel.attachEventListener("brushing",myId,function(e){if(me.interactor&&me.interactor.onBrushing){me.interactor.onBrushing(e);}});this.model.docModel.attachEventListener("contextmenu",me.id,function(e){e.preventDefault();return false;});this.model.docModel.attachEventListener("visActive",myId,function(evt){me.setActive(me.id===evt.id);});},requirePreload:true,getFonts:function(){var me=this,res=[],cached={};["dlFntFml","rfLnFntFml","lgdFntFml","xAxTtFntFml","xAxLbFntFml","yAxTtFntFml","yAxLbFntFml","allTxtFntFml","rwHdrTxtFntFml","colHdrTxtFntFml","rwVlTxtFntFml","colVlTxtFntFml","ttlFntFml"].forEach(function(prop){var fontFamily=me.getWidgetPropertyValue(prop);fontFamily=typeof fontFamily==="object"?fontFamily[prop]:fontFamily;var config={name:fontFamily,isItalic:false,isBold:false};var fKey=config.fontFamily+":"+config.isItalic+":"+config.isBold;if(!cached[fKey]){cached[fKey]=true;res.push(config);}});return res;}});}());