(function(){mstrmojo.requiresCls("mstrmojo.XtabBase","mstrmojo._Formattable","mstrmojo._IsSelectorTarget","mstrmojo._IsDocXtab","mstrmojo._XtabSelections","mstrmojo._XtabCellHoverMgr","mstrmojo.XtabCellHoverPopup","mstrmojo._HasPopup","mstrmojo.dom","mstrmojo.array","mstrmojo.vi.ui.rw.CustomSortDisplayPanel","mstrmojo.mstr.EnumWebAPIErrorCodes");var LOCK_OFF=0,OVERFLOW_A="overflow:auto",OVERFLOW_H="overflow:hidden",$DOM=mstrmojo.dom,$P=$DOM.position,$ARR=mstrmojo.array,$PS="mstrmojo.DocPanelStack",PX="px",SUPPRESS_DATA_PROPS=mstrmojo.DocDataService.SUPPRESS_DATA,$DATA_INTERFACE=mstrmojo.models.template.DataInterface,$ENUM_GRID_RESIZE=$DATA_INTERFACE.ENUM_GRID_RESIZE,$FIXED_SCENARIO=$ENUM_GRID_RESIZE.FIXED,$FIT_TO_WIN_SCENARIO=$ENUM_GRID_RESIZE.FIT_TO_WINDOW,$FIT_TO_CON_SCENARIO=$ENUM_GRID_RESIZE.FIT_TO_CONTENTS,isIOSTouch=$DOM.isIOSTouch;var fc=function findContainerByScriptName(w,s){var anc=w&&w.parent;while(anc&&anc.scriptClass!==$PS){if(anc.scriptClass===s){return anc;}anc=anc.parent;}return anc;};function calculateCSPanelDim(){var CS_TOOLBAR_HEIGHT=36;var docRelativePanel=this.model.docModel.getPanel(),panelContainer=docRelativePanel.containerNode,panelPos=$P(panelContainer),viRootToolbar=mstrApp.rootCtrl.view.toolbar,viToolbarPos=$P(viRootToolbar.domNode);var csPanelPos={};csPanelPos.x=panelPos.x;csPanelPos.w=panelPos.w;csPanelPos.y=(viToolbarPos.y+viToolbarPos.h)-CS_TOOLBAR_HEIGHT;csPanelPos.h=(panelPos.y+panelPos.h)-csPanelPos.y;var spacerHeight=panelPos.y-(viToolbarPos.y+viToolbarPos.h);return{csPanelPos:csPanelPos,spacerHeight:spacerHeight};}mstrmojo.Xtab=mstrmojo.declare(mstrmojo.XtabBase,[mstrmojo._Formattable,mstrmojo._IsSelectorTarget,mstrmojo._IsDocXtab,mstrmojo._XtabSelections,mstrmojo._HasPopup],{scriptClass:"mstrmojo.Xtab",cellHoverMgr:"mstrmojo._XtabCellHoverMgr",cellHoverPopupRef:"mstrmojo.XtabCellHoverPopup",preBuildRendering:function preBuildRendering(){var rtn=this._super();var gd=this.gridData;var overflowClip=this.lockHeadersCase===LOCK_OFF&&gd.co;this.scrollboxNodeOverflow=overflowClip&&!this.numRowFixed?OVERFLOW_H:OVERFLOW_A;var f=this.getFormats();if(mstrmojo.dom.isIE8&&!gd.co&&this.lockHeadersCase===LOCK_OFF&&(!gd.rw||(gd.rw&&(gd.rw.row.bc>=gd.rw.row.tc)))&&mstrmojo.string.isEmpty(f.height)&&mstrmojo.string.isEmpty(f.width)){this.scrollboxNodeOverflow="";}this._useFilter=this._useFilter||gd.cssflt||false;return rtn;},postBuildRendering:function postBldRndr(){var gd=this.gridData,rtn=this._super(),sn=this.scrollboxNode;var xtab=this;if(this.viewport){var addCellHoverMgr=function(){xtab.addDisposable(xtab.requiresContrib("cellHoverMgr",true));if(isIOSTouch){xtab.viewport.ontouchstart=null;}else{xtab.viewport.onmouseover=null;}};if(isIOSTouch){this.viewport.ontouchstart=addCellHoverMgr;}else{this.viewport.onmouseover=addCellHoverMgr;}}if(!this.getFormats().width&&this.model.docModel.addAutoWidthID&&(this.parent&&this.parent.scriptClass!=="mstrmojo.ExpressDocPanel")){this.model.docModel.addAutoWidthID(this.id);gd=this.gridData;var afc=gd&&gd.afc;if(afc&&mstrmojo.dom.isIE7){var p=fc(this,$PS);if(p&&p.scriptClass===$PS){this.viewport.style.width=this.contentNode.offsetWidth+(this.scrollboxNode.offsetWidth-this.scrollboxNode.clientWidth)+"px";}}}if($DOM.isIE&&!$DOM.isIE8&&this._useFilter){window.setTimeout(function(){var img=document.createElement("img");sn.appendChild(img);sn.removeChild(img);},0);}return rtn;},onCGBMapChange:function(evt){if(this._resolveCGBToTKS(evt.cgbMap)&&this._currentSelectedTD){this.defaultAction(this._currentSelectedTD);}},_resolveCGBToTKS:function _resolveCGBToTKS(cgbMap){if(!cgbMap){return false;}var scm=this.model.scm,delim="\u001E",i,id,curSelector,cgb,targetKey,updatedTks=false;for(id in scm){curSelector=scm[id];cgb=curSelector.cgb;for(i in cgb){targetKey=cgbMap[cgb[i]];if(targetKey){if(!curSelector.tks){curSelector.tks=targetKey;updatedTks=true;}else{if(curSelector.tks&&(curSelector.tks.indexOf(targetKey)<0)){curSelector.tks+=delim+targetKey;updatedTks=true;}}}}}return updatedTks;},onGridWidthChanged:function onGridWidthChange(b){if(this._super){this._super(b);}if(this.cellHoverMgr.onXtabWidthChanged){this.cellHoverMgr.onXtabWidthChanged();}},getDim:function(){var cn=this.contentNode;return{w:cn.scrollWidth,h:cn.scrollHeight};},unrender:function unrender(ignoreDom){var chm=this.cellHoverMgr;if(chm&&chm.shutdown){chm.shutdown();}this._super(ignoreDom);},link:function link(cell,idx){this.controller.onLink(this,this.model.getLinkAction(cell,idx));},sort:function sort(cell,isAsc){this.controller.onSort(this,this.model.getSortAction(cell,isAsc));},advSort:function advSort(cell,axis,ndeInfo){this.controller.onGetAdvSortData(this,axis,cell._e&&cell._e.otp,ndeInfo);},customSort:function customSort(cell,axis){var me=this,xtabModel=this.model,dataService=xtabModel.getDataService(),docModel=xtabModel.docModel,panelKey=docModel.getUnitDefinitions(this.k)[this.k].pnk,layoutKey=docModel.currlaykey,newVizKey=docModel.getNextKey(),actions=xtabModel.getCreateCSVizActions(cell,axis,newVizKey);dataService.submitUpdates(actions,{success:function(res,request){var resData=res.data,layoutData=$ARR.filterOne(resData.layouts,function(layout){return layout.k===layoutKey;}),xtabStyles={};xtabStyles[newVizKey]=layoutData.xtabStyles[newVizKey];docModel.controller.view.updateXtabStyles(layoutKey,xtabStyles);docModel.updateDefnCache(res.defn,[newVizKey,panelKey]);docModel.updateDataCache(resData,docModel.getTargetDefn(newVizKey));var panelDim=calculateCSPanelDim.call(me),vizDim=$P(me.domNode),TOOLBAR_MIN_WIDTH=600,csPanel=mstrmojo.insert({scriptClass:"mstrmojo.vi.ui.rw.CustomSortDisplayPanel",model:docModel,nodeKey:newVizKey,srcPanelKey:panelKey,srcLayoutKey:layoutKey,srcViz:me,srcUnit:cell,srcAxis:axis,width:Math.max(vizDim.w,TOOLBAR_MIN_WIDTH)+"px",height:panelDim.csPanelPos.h+"px",left:((typeof vizDim.x==="number")?vizDim.x:0)+"px",top:((typeof panelDim.csPanelPos.y==="number")?panelDim.csPanelPos.y:0)+"px",spacer:panelDim.spacerHeight});csPanel.setVizBoxPortalStateRestore();csPanel.open();csPanel.parent=mstrmojo.findAncestor(me,"openXtabCellMenu");},failure:function(res,request){var LIMIT=6,slot=10000,i=0,undo=function(){dataService.submitUpdates({act:"undo",stid:dataService.stid},{success:function(res,request){mstrApp.hideWait();},failure:function(res,request){if(++i<LIMIT&&res.code==mstrmojo.mstr.EnumWebAPIErrorCodes.MSI_ADDUSERJOB_ERROR){setTimeout(undo,slot);}else{mstrApp.hideWait();}}},{config:{silent:true},hideCancel:true,noUpdate:true,preserveStid:true,noDeltaXML:true});};mstrApp.showWait();undo();}},{style:{params:{treesToRender:3}},noUpdate:true,preserveStid:true,noDeltaXML:true,hideCancel:true});},pivot:function pivot(cell,btn){this.controller.onPivot(this,this.model.getPivotAction(cell,btn));},drill:function drill(cell,drillPath){this.controller.onDrill(this,this.model.getDrillAction(this.getActionCells(cell),drillPath));},removeUnit:function removeUnit(cell){this.controller.onRemoveUnit(this,this.model.getRemoveTemplateUnitAction({id:cell._e?cell._e.oid:cell.id,t:cell._e?cell._e.otp:cell.otp}));this.onDemandDrillItems=null;this.onDemandDrillDynamicItems=null;},showViewFilter:function showViewFilter(cell){this.controller.onShowFilterEditor(this,cell);},showTotal:function showTotal(cell,subtotalType,clearSubtotalType){this.controller.onShowTotals(this,this.model.getTotalsAction(cell,subtotalType,clearSubtotalType));},derivedMetric:function derivedMetric(cell,cmd){var config,did=cell._e.oid,actionParams={did:did,alias:cell._e.n,n:cell._e.n,v:cell.um?cell.formula:cell._e.v,idx:cell.mix,host:this,nodeKey:this.k,dsid:this.controller.model.findDatasetIdFromUnit(did)||this.model.data.datasetId},callback;if(cmd==="edit"){config={metricId:actionParams.did,action:{cmd:"edit",n:actionParams.n,alias:actionParams.alias}};callback=this.controller.model.getDataService().getEditDerivedMetricSubmitFunc(actionParams);}else{config={metricId:"",action:{cmd:"editNew",refOi:{did:actionParams.did,n:actionParams.n}}};callback=this.controller.model.getDataService().getAddNewDerivedMetricToXtabSubmitFunc(actionParams);}var docmodel=this.controller.model;if(docmodel.isFromSolrCube&&docmodel.isFromSolrCube(actionParams.did)||docmodel.isFromMDXCube(actionParams.did)){config.disableAFB=true;}this.controller.openDME(this,config,callback);},deleteSelectorControl:function deleteSelectorControl(){var gd=this.gridData,sc=gd.sc;if(sc&&parseInt(sc.ct,10)===6){delete gd.sc;}},findSelectorControl:function findSelectorControl(){var selectorControl=this.gridData.sc;if(selectorControl&&parseInt(selectorControl.ct,10)===6){this.selectorControl=selectorControl;}else{delete this.selectorControl;}return this.selectorControl;},handlesMultiSelection:function handlesMultiSelection(evt){var cell=this.getCellForNode($DOM.findAncestorByName(evt.getTarget(),"td",true,this.viewport)),unit=cell&&this.model.data.gts[cell.axis===1?"row":"col"][cell.tui||cell.ui],singleUnitSelector=unit&&unit.id&&unit.sc;return !!(this.findSelectorControl()||singleUnitSelector);},getBasicSubtotalEditorConfig:function getBasicSubtotalEditorConfig(subtotals){var cfgEditor=new mstrmojo.ui.menus.EditorConfig({contents:new mstrmojo.express.ui.SubtotalsWidget({onchange:function onchange(){var types=this.getSubtotalTypes(),selectionChanged=types[0].length>0||types[1].length>0;cfgEditor.set("okEnabled",selectionChanged);}}),data:{},okEnabled:false});if(!this.model.data.gsi.hidesb){cfgEditor.contents.set("selectedItems",subtotals||[]);}return cfgEditor;},updateRelatedColWidths:function updateRelatedColWidths(colWidths){if(this.isCustomSort&&this.getActionMgr().isCurrentActionSilent()){return ;}var columnsData=(new mstrmojo.models.template.DataInterface(this.gridData)).getColumnHeaderData(true),tabularWidthModel=this.gridData.twm||{},bottomWidths=tabularWidthModel.bottom,topWidths=tabularWidthModel.top,targetZone=this.getTargetZone,colValue;(colWidths||[]).forEach(function(col){var colIndex=col.colIndex,currentHeader=columnsData[colIndex],relatedIndices=currentHeader._ridx||[];colValue=col.value;if(relatedIndices.length>1){relatedIndices.forEach(function(index){topWidths[index]=topWidths[index]||{};topWidths[index].w=bottomWidths[index].w=colValue;});}else{topWidths[colIndex]=topWidths[colIndex]||{};topWidths[colIndex].w=bottomWidths[colIndex].w=colValue;}targetZone.autoFitWindow=false;targetZone.autoFitContent=false;});this.refresh();},updateScenario:function updateScenario(scenario){var gridData=this.gridData;gridData.afc=scenario===$FIT_TO_CON_SCENARIO;gridData.afw=scenario===$FIT_TO_WIN_SCENARIO;if(scenario!==$FIXED_SCENARIO){this.setAllXtabWidths("");}this.refresh();},setAllXtabWidths:function setAllXtabWidths(width){},changeResizeScenario:function changeResizeScenario(scenario,isColumns,changedColumnSize,silent){var templateInterface=new mstrmojo.models.template.DataInterface(this.gridData),tabularWidthModel=this.gridData.twm||{},bottomWidths=tabularWidthModel.bottom,columnsData=templateInterface.getColumnHeaderData(true),me=this,model=this.model,id=this.id,key=this.k,actions=[],currentValues=[],currentFormIndex=1,distinctCols=[];if(isColumns){actions.push({act:"changeXtabColWidthScenario",value:scenario});columnsData.forEach(function(col,index){var id=col.oid||col.id,fnRedundant=function(item){return item.unitId===id&&item.depth===currentFormIndex;};if(!(col.fs&&col.fs.length>0)){currentFormIndex=1;}var isTarget=id===(changedColumnSize&&changedColumnSize.did)&&currentFormIndex===changedColumnSize.depth;if(!distinctCols.some(fnRedundant)){distinctCols.push({unitId:id,depth:currentFormIndex});currentValues.push({colIndex:index,value:isTarget?changedColumnSize.width+PX:bottomWidths[index].w});if(scenario===$FIXED_SCENARIO){actions.push(model.getColumnResizeAction(id,col.otp,isTarget?changedColumnSize.width:parseInt((bottomWidths[index].w)||0,10),currentFormIndex,isTarget?changedColumnSize.isExtra:false));}}currentFormIndex++;});var updateWidths=function updateWidths(scenario,colValues){var xtab=mstrmojo.all[id];if(scenario===$FIXED_SCENARIO){me.updateRelatedColWidths(colValues);}me.updateScenario(scenario);};updateWidths(scenario,currentValues);me.submitColumnWidthChange(actions,silent);}return silent?actions:undefined;},submitColumnWidthChange:function submitColumnWidthChange(actions,silent){if(!silent){this.model.getDataService().submitTemplateUpdates(this.k,actions,{success:function success(){}},SUPPRESS_DATA_PROPS);}},changeColumnWidth:function changeColumnWidth(unitId,unitType,width,formIndex,isExtraColumn,silent){var templateInterface=new mstrmojo.models.template.DataInterface(this.gridData),columnsData=templateInterface.getColumnHeaderData(true),model=this.model,actions=[],me=this,currentValues=[],currentFormIndex=1,currentColIndex=-1,distinctCols=[];if(templateInterface.getColResizeScenario()!==$FIXED_SCENARIO){actions=this.changeResizeScenario($FIXED_SCENARIO,true,{did:unitId,t:unitType,width:width,depth:formIndex,isExtra:isExtraColumn},silent);return silent?actions:undefined;}if(unitId==="all"){columnsData.forEach(function(col,index){var id=col.oid||col.id,fnRedundant=function(item){return item.unitId===id&&item.depth===currentFormIndex;},previousCol=columnsData[index-1];if(!(col.fs&&col.fs.length>0)||(previousCol&&id!==(previousCol.oid||previousCol.id))){currentFormIndex=1;}if(!distinctCols.some(fnRedundant)){distinctCols.push({unitId:id,depth:currentFormIndex});currentValues.push({colIndex:index,value:width+PX});actions.push(model.getColumnResizeAction(id,col.otp,width,currentFormIndex,false));}currentFormIndex++;});}else{columnsData.every(function(col,index){var isItem=(col.oid===unitId||col.id===unitId);if(isItem){currentColIndex=index+formIndex-1;}return !isItem;});if(currentColIndex>=0){currentValues.push({colIndex:currentColIndex,value:width+PX});actions.push(model.getColumnResizeAction(unitId,unitType,width,formIndex,isExtraColumn));}}me.updateRelatedColWidths(currentValues);me.submitColumnWidthChange(actions,silent);return silent?actions:undefined;}});}());