(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.Label","mstrmojo.mstr.EnumWebAPIErrorCodes","mstrmojo.vi.enums.EnumFeatures","mstrmojo.vi.ui.DatasetObjects","mstrmojo.vi.ui.DocDatasetUnitList","mstrmojo.vi.ui.toolbars._HasToolbar","mstrmojo.util.ui._HostsSplitter","mstrmojo.ui.menus._HasMenuPopup","mstrmojo.vi.ui.toolbars._HasToolbar","mstrmojo.ui.menus.MenuConfig","mstrmojo.ui.menus.ToolbarConfig","mstrmojo.IVEDatasetPicker","mstrmojo.vi.ui.PanelContents","mstrmojo.vi.ui.PanelPortlet","mstrmojo.vi.ui.DatasetUnitMenuUtils","mstrmojo.vi.ui.SelectDatasetWizardEditor","mstrmojo.vi.ui.ReplaceObjectEditor","mstrmojo.ui.ScrollableContainer","mstrmojo.fe.FilterEditor","mstrmojo.fe.FilterUtils","mstrmojo.array","mstrmojo.hash","mstrmojo.form","mstrmojo.func","mstrmojo.dom","mstrmojo.Button","mstrmojo.mstr.EnumFunction","mstrmojo.DocDataService","mstrmojo.SaveAsEditor","mstrmojo.vi.ui.ViewDataDialog","mstrmojo.vi.ui.DatasetEditor","mstrmojo.onetier.vi.prefs.DesktopConnectivityProxy","mstrmojo.onetier.vi.prefs.HostedDesktopConnectivityProxy","mstrmojo.DI.DIConstants","mstrmojo.DI.DIHelpers","mstrmojo.vi.enums.EnumDSSAccessRightFlags","mstrmojo.vi.enums.EnumFeatures","mstrmojo._HasPopup","mstrmojo.Popup","mstrmojo.CheckBox","mstrmojo.ui.PopupConfig","mstrmojo.storage.DOMLocalStorage");mstrmojo.requiresDescs(16029,16030);var $HASH=mstrmojo.hash,$ARR=mstrmojo.array,$FUNC=mstrmojo.func,$DOM=mstrmojo.dom,$DUMU=mstrmojo.vi.ui.DatasetUnitMenuUtils,$DICONST=mstrmojo.DI.DIConstants,$NWB=mstrmojo.Button.newWebButton,$DIHELPER=mstrmojo.DI.DIHelpers,$DSS=mstrmojo.chart.model.enums.EnumDSSObjectType,DSM={IN_MEMORY:1,DIRECT_ACCESS:2},SDA={SupportDDAOrInMemory:1,SupportInMemoryOnly:2,SupportDDAOnly:3},onlyDefExtras={style:{params:{treesToRender:1}}},UNIT_TYPE_MAP={att:$DSS.DssTypeAttribute,mx:$DSS.DssTypeMetric},$WARN=mstrmojo.warn,$ACG=mstrmojo.vi.enums.EnumDSSAccessRightFlags,$ERRCODE=mstrmojo.mstr.EnumWebAPIErrorCodes,$FEATURES=mstrmojo.vi.enums.EnumFeatures,EXTTRAS_REQUEST_DEFN_DATA=mstrmojo.DocDataService.REQUEST_DEFN_DATA;var KEY_DONT_SHOW_AGAIN="dontShowAddDataHint";function checkCredentials(dsPanel,dsid,model,extra){model.getDataService().checkMissingCredentials({dsid:dsid},{success:function(res){var callback=extra&&extra.callback;if(res.success){if(callback&&callback.success){callback.success();}}else{if(callback&&callback.failure){callback.failure(res);}else{mstrmojo.confirm(mstrmojo.desc(14396,"Some credentials are missing for the selected dataset. You will have to enter these credentials in order to proceed. Do you want to continue?"),{confirmBtn:{fn:function(){window.setTimeout(function(){if(dsPanel&&dsPanel.showDataImport){dsPanel.showDataImport({documentModel:res,StatusCode:4,callback:function(){checkCredentials(dsPanel,dsid,model,extra);}});}},0);return true;}},cancelBtn:{t:mstrmojo.desc(2140,"Cancel"),fn:mstrmojo.emptyFn}},{title:mstrmojo.desc(1695,"Warning")});}}},failure:function(res){mstrmojo.alert(res);}});}function getConnectivityProxy(){return mstrApp.isSingleTier?new mstrmojo.onetier.vi.prefs.DesktopConnectivityProxy():new mstrmojo.onetier.vi.prefs.HostedDesktopConnectivityProxy();}function executeDynamic(exeFunc){this.model.cmdMgr().execute({execute:function(){exeFunc(this);}});}function getFeature(name){return mstrmojo.resolveFeature(name);}function allowMultipleWorkingsets(){return !getFeature("single-workingset");}function isDownLoadDatasetEditable(dataset){var isEmmaDataCube=dataset.st===779,isManaged=dataset.mngd,model=this.model,isFromFile=model.isFromFile(dataset);return(isManaged&&isEmmaDataCube&&isFromFile)||((!dataset.hcs||dataset.idd)&&!(dataset.tables&&dataset.tables[0]&&dataset.tables[0].xdaType===400));}function getDatasetPicker(config){var id=config.id||"mstrIVE_DS",editor=mstrmojo.all[id];if(!editor){editor=new mstrmojo.IVEDatasetPicker({id:id,onOk:mstrmojo.emptyFn,onCancel:mstrmojo.emptyFn,onPreClose:function(){this.onCancel();return true;},onRender:function onRender(){var importVisible=false;this.btnImport.set("visible",importVisible);this.newLabel.set("visible",importVisible);this.useExistingLabel.set("visible",importVisible);this.ob.set("scrollableIncFetch",true);this.btnHBox.destroyChildren();var btnOk=$NWB(mstrmojo.desc(547,"Select"),function(){if(this.enabled){editor.onOk();editor.close();}},true);btnOk.bindings={enabled:function(){return this.parent.parent.multiSelect?!!this.parent.parent.selectedItems.length:!!this.parent.parent.item;}};this.btnHBox.addChildren([btnOk,$NWB(mstrmojo.desc(221,"Cancel"),function(){editor.onCancel();editor.close();},false)]);}});if(config.title){editor.set("title",config.title);}}$HASH.forEach(config,function(value,key){editor.set(key,value);});return editor;}function insertNewMetric(dataset,docModel){var view=this;return function(){mstrApp.rootCtrl.docCtrl.openDME(view,{metricId:"",editorId:"mstrME",action:{cmd:"editNew"},disableAFB:docModel.isMDXDataset(dataset)},docModel.getDataService().getAddNewDerivedMetricToDatasetSubmitFunc({dsid:dataset.did}));};}function insertNewDerivedAttr(dsid,datasets){var view=this;return function(){mstrApp.rootCtrl.docCtrl.openDAE(view,{dsid:dsid,datasets:datasets},mstrmojo.emptyFn);};}function setJoinBehavior(model,dataset){var setPrimJBCfg=new mstrmojo.ui.menus.MenuConfig(),options=[{n:mstrmojo.desc(14476,"Primary (outer join)"),v:1},{n:mstrmojo.desc(14477,"Secondary (inner join)"),v:0}];options.forEach(function(opt){setPrimJBCfg.addMenuItem(opt.n,opt.v===dataset.ipm?"on":"",function(){var ctrl=model.controller,callback=ctrl.getRefreshCallback();ctrl.cmdMgr.execute({execute:function(){this.submit([{act:"setJoinBehavior",dsid:dataset.did,dst:dataset.type,prm:opt.v}],callback,{style:{params:{treesToRender:3}}});},urInfo:{callback:callback}});});});setPrimJBCfg.hasToggleItem=true;return setPrimJBCfg;}function getManifest(dsPanel,docModel,callback,dsid){var params={taskId:"mojoGetDocumentManifest"},getDatasetInfo=function(indexArray){var datasets=[],index=1;$HASH.forEach(dsPanel.data,function(dataset){indexArray.forEach(function(inx){if(index===parseInt(inx,10)){datasets.push(dataset);}});index++;});return datasets;};if(dsid){params.dsid=dsid;}docModel.getDataService().submitUpdates({},{success:function(manifest){var units=[],all_units={},all_manifest_units={};$HASH.forEach(dsPanel.data,function(dataset){dataset.att.concat(dataset.mx).forEach(function(unit){all_units[unit.did]=unit;});});manifest.manifest_objects.forEach(function(obj){if(all_units[obj.did]){obj.cubes=getDatasetInfo(obj.cube_ids||[]);units.push($HASH.copy(all_units[obj.did],obj));all_manifest_units[obj.did]=obj;}});manifest.manifest_objects.forEach(function(obj){if(obj.dependents){obj.dependentObjects=[];obj.dependents.forEach(function(objID){obj.dependentObjects.push(all_manifest_units[objID]);});}});units=$DUMU.getSortedDatasetUnits(units);callback(units);},failure:function(){docModel.cmdMgr().onFailure();}},{params:params,preserveUndo:true});}function getWorkingSet(docModel,dsid,callback){var targetDataset=docModel.datasets[dsid];if(targetDataset){callback(targetDataset);}else{docModel.getDataService().submitUpdates({},{success:function(workingset){callback(workingset);},failure:function(){docModel.cmdMgr().onFailure();}},{params:{taskId:"mojoGetReportWorkingSet",reportId:dsid,chkViewReport:1},preserveUndo:true});}}function generateWorkingSetObjects(dataset){var workingSet=$HASH.clone(dataset.att.concat(dataset.mx));workingSet.forEach(function(unit){if(unit.hc){unit.cont_did=dataset.did;unit.cont_tp=dataset.type;}});return $ARR.filter(workingSet,function(obj){return !obj.um;});}function getApplyReconciliationFunction(dsPanel,docModel,replaceAll,config,extraActions,extraCallback){return function applyReconciliation(members,clearaf){var actions=[{act:"applyReconciliation",clr_af:clearaf,clr_fs:false,members:members,disablePU:true}].concat(extraActions);if(!!config.isOneTierCubeImport){actions[0].sourceId=(replaceAll?"all":config.source.did);}if(replaceAll){$HASH.forEach(dsPanel.data,function(dataset,did){members.unshift({srcid:did,srct:3,tgtid:config.target.did,tgtt:3});});}else{members.unshift({srcid:config.source.did,srct:3,tgtid:config.target.did,tgtt:3});}var cmdMgr=docModel.cmdMgr(),interimCmd=cmdMgr.getInterimCmd(),refreshCallback=docModel.controller.getRefreshCallback(),cb=$FUNC.wrapMethods(refreshCallback,(extraCallback||mstrmojo.emptyFn));if(interimCmd){interimCmd.urInfo.callback=refreshCallback;interimCmd.submit(actions,cb,EXTTRAS_REQUEST_DEFN_DATA,cmdMgr.CMD_PHASE.LAST);}else{cmdMgr.execute({execute:function(){this.submit(actions,cb,EXTTRAS_REQUEST_DEFN_DATA);},urInfo:{callback:refreshCallback}});}};}function getReplaceDatasetMenuHandler(dsPanel,replaceAll){var docModel=dsPanel.model,ROEDITOR_ID="mstrReconReplaceEditor",roEditor=null,cancelProcess=function cancelProcess(){var cmd=docModel.cmdMgr().getInterimCmd();if(cmd){var urInfo=cmd.urInfo;urInfo.callback={success:mstrmojo.emptyFn};urInfo.treesToRender=0;cmd.cancel();}},openReplaceObjectEditor=function(config){if(!roEditor){roEditor=mstrmojo.all[ROEDITOR_ID]||mstrmojo.insert({scriptClass:"mstrmojo.vi.ui.ReplaceObjectEditor",id:ROEDITOR_ID});}roEditor.set("showUnitTooltip",replaceAll);roEditor.setUnits({source:config.source,target:config.target});updateDatasetsCollapsed($HASH.keyarray(docModel.datasets).filter(function(dsid){return dsid===config.target.did;}).map(function(dsid){return{dsid:dsid,collapsed:false};}),dsPanel);roEditor.onOk=getApplyReconciliationFunction(dsPanel,docModel,replaceAll,config,dsPanel.settings.getSaveActions(),{failure:function(){roEditor.open();}});roEditor.onCancel=cancelProcess;roEditor.set("onBack",config.onBack||mstrmojo.emptyFn);roEditor.open();},openDIDialog=function(callback){window.setTimeout(function(){dsPanel.showDataImport({isEdit:false,AnalysisId:docModel.mid,callback:function onDataImportSuccess(datasets){if(datasets){var dataset=datasets[0];if(dataset.mngd){if(!mstrApp.isSingleTier){docModel.cmdMgr().getInterimCmd().resetCmdMgrOnComplete();}callback(dataset);}else{getWorkingSet(docModel,dataset.did,callback);}}else{cancelProcess();}}});},0);},openDatasetEditor=function(callback){docModel.controller.createDataset({isParam:true,modifiedItems:{create:{act:"createDataset",mgo:true,prm:true,noRowCount:1,newObjectIds:["$GUID_141"]},add:[],del:[],fs:{add:[],del:[]},filter:null},onOk:function(actions){var editor=this,cmdMgr=docModel.cmdMgr(),interimCmd=cmdMgr.getInterimCmd(),cb={success:function(res){$HASH.forEach(res.datasets,function(v,n){if(!docModel.datasets[n]){res.datasets[n].did=n;callback(res.datasets[n]);}});editor.close();},failure:function(res,xhr){this.canceled(xhr.id);}},extras={skipUICmdMgrOnFailure:getCreateDatesetSkippableError()};if(interimCmd){interimCmd.submitInterim(actions,cb,extras);}else{cmdMgr.execute({execute:function(){this.submit(actions,cb,extras);}});}},closeOnSubmit:false,onCancel:cancelProcess});},openDatasetPicker=function(callback){docModel.controller.addDataset({isParam:true,id:"mstrReconDatasetPicker",title:mstrmojo.desc(11940,"Select Existing Dataset"),multiSelect:false,onOk:function(dsId){getWorkingSet(docModel,dsId||this.item.did,callback);},onCancel:cancelProcess});},openCubeBrowser=function(callback){docModel.controller.openCubeBrowser({success:function(res){getWorkingSet(docModel,res.did,callback);},failure:function(){cancelProcess();}});},processReplaceObject=function(config){var sdid=config.sourceDatasetId,isOneTierCubeImport=!!config.isOneTierCubeImport,open=config.openDialog;getManifest(dsPanel,docModel,function(units){function start(){executeDynamic.call(dsPanel,function(){open(function(workingset){var workingSetObjects=generateWorkingSetObjects(workingset);openReplaceObjectEditor({isOneTierCubeImport:isOneTierCubeImport,source:{did:sdid,all:!!replaceAll,units:units},target:{did:workingset.did,units:workingSetObjects},onBack:$FUNC.composite([cancelProcess||mstrmojo.emptyFn,start])});});});}start();},replaceAll?null:sdid);};return function(){var cfg=new mstrmojo.ui.menus.MenuConfig({supportsScroll:true,menuCssClass:"reconsoliationMenu"}),dsid=this.did,manifestId=replaceAll?null:dsid,numOfDatasets=Object.keys(dsPanel.data).length;if(allowMultipleWorkingsets()){var isOneTierApp=mstrApp.isSingleTier;if(docModel.allowImportData()){cfg.addMenuItem(mstrmojo.desc(14303,"New Data..."),"",function(){processReplaceObject({sourceDatasetId:dsid,openDialog:openDIDialog});});cfg.addSeparator();}if(!(mstrApp.isWorkstation&&mstrApp.isVisBuilder)){cfg.addMenuItem(mstrmojo.desc(13573,"Existing Dataset..."),"",function(){processReplaceObject({sourceDatasetId:dsid,isOneTierCubeImport:isOneTierApp,openDialog:openDatasetPicker});});}if(!dsPanel.hasUnsubmitDataset&&docModel.allowNewOrEditRolapDS()&&(docModel.isSchemaDefined()||mstrApp.isWorkstation)){cfg.addMenuItem(mstrmojo.desc(15397,"Existing Objects..."),"",function(){processReplaceObject({sourceDatasetId:dsid,openDialog:openDatasetEditor});});}}if(numOfDatasets>1){cfg.addSeparator();$HASH.forEach(dsPanel.data,function(dataset2,id2){if(id2===dsid){return true;}cfg.addMenuItem(dataset2.name,"",function(){executeDynamic.call(dsPanel,function(){getManifest(dsPanel,docModel,function(units){getWorkingSet(docModel,id2,function(workingset){openReplaceObjectEditor({source:{did:dsid,all:!!replaceAll,units:units},target:{did:id2,units:generateWorkingSetObjects(workingset)}});});},manifestId);});});});}return cfg;};}function getOpenImportDataMenu(){var me=this,model=me.model,ds=[];$HASH.forEach(model.datasets,function(dataset){if(dataset.st===779&&model.hasPrivilegesForAllTables(dataset.tables)){ds.push(dataset);}});return function(){me.showDataImport({isEdit:false,datasets:ds,AnalysisId:me.model.mid,needDefn:true});};}function openDIForMultipleCubeRefresh(){var me=this,model=me.model,ds=[];$HASH.forEach(model.datasets,function(dataset){if(dataset.st===779&&model.hasPrivilegesForAllTables(dataset.tables)){ds.push({cube_id:dataset.did,cname:dataset.name,ddam:dataset.dsm,mdt:"2014-12-10 20:57:25",sz:421,st:dataset.st});}else{if(dataset.st===776){ds.push({cube_id:dataset.did,cname:dataset.name,ddam:dataset.dsm,mdt:"2014-12-10 20:57:25",sz:421,st:dataset.st});}}});return function(){me.showDataImport({isEdit:false,datasets:{cubes:{cube:ds}},AnalysisId:me.model.mid,StatusCode:2,refreshMultipleCubes:true,rwb:model.getDataService().rwb});};}function getAddDatasetMenu(dsPanel){return function(){var cfg=new mstrmojo.ui.menus.MenuConfig(),$this=this;if(allowMultipleWorkingsets()&&$this.model.allowImportData()){cfg.addMenuItem(mstrmojo.desc(14303,"New Data..."),"",getOpenImportDataMenu.call($this));cfg.addSeparator();}if(!(mstrApp.isWorkstation&&mstrApp.isVisBuilder)){cfg.addMenuItem(mstrmojo.desc(13573,"Existing Dataset..."),"",function(){$this.model.controller.addDataset();});}if(!dsPanel.hasUnsubmitDataset&&$this.model.allowNewOrEditRolapDS()&&($this.model.isSchemaDefined()||mstrApp.isWorkstation)){cfg.addMenuItem(mstrmojo.desc(15397,"Existing Objects..."),"",function(){$this.model.controller.createDataset();});}return cfg;};}function hasHiddenObjects(docModel){var datasets=docModel&&docModel.datasets,units=(docModel.datasetsSettings&&docModel.datasetsSettings.units)||{},fnFilterHide=function(unit){return unit.hide&&!(units[unit.n]&&units[unit.n].completeHide);},dataset,did;for(did in datasets){dataset=datasets[did];if($ARR.filterOne(dataset&&dataset.att,fnFilterHide)||$ARR.filterOne(dataset&&dataset.mx,fnFilterHide)){return true;}}return false;}function showHiddenObjects(docModel){var datasets=docModel&&docModel.datasets,hiddenObjectList=[];function addEditorChild(title,unitType){var units=(docModel.datasetsSettings&&docModel.datasetsSettings.units)||{},items=[],dscount=0,selectedIndices={};$HASH.forEach(datasets,function(dataset,dsid){if(dataset.did){++dscount;}var filteredUnits=$ARR.filter(dataset[unitType],function(unit){unit.dsid=dsid;unit.ds=dataset.name;unit.tt=unit.n+" ("+unit.ds+")";unit.css=$DUMU.getUnitCssClass(unit);return unit.hide&&!(units[unit.n]&&units[unit.n].completeHide);});items=items.concat(filteredUnits);});if(!items.length){return ;}items=$DUMU.getSortedDatasetUnits(items);var list=new mstrmojo.ui.CheckList({cssClass:"units",items:items,selectedIndices:selectedIndices,useRichTooltip:true,showTooltip:function showTooltip(evt,win){var target=evt.target||$DOM.eventTarget(evt.hWin,evt.e),item=this.getItemFromTarget(target),child=target.firstChild,pos;target.setAttribute("title","");if(target.offsetWidth<child.offsetWidth||dscount>0){pos=$DOM.position(this.getItemNodeFromTarget(target));this.richTooltip={posType:mstrmojo.tooltip.POS_TOPLEFT,cssClass:"vi-regular vi-tooltip-C",content:item.tt,top:pos.y,left:pos.x+pos.w+18};mstrmojo.ui.CheckList.prototype.showTooltip.apply(this,evt,win);}}});hiddenObjectList.push({scriptClass:"mstrmojo.vi.ui.PanelPortlet",title:title,children:[list],t:UNIT_TYPE_MAP[unitType],getSelectedItems:function(){return list.getSelectedItems()||[];},updateListScrollbars:function(){list.updateScrollbars();}});}addEditorChild(mstrmojo.desc(3581,"Attributes"),"att");addEditorChild(mstrmojo.desc(3582,"Metrics"),"mx");return new mstrmojo.ui.menus.EditorConfig({data:{},cssClass:"mstrmojo-ShowHiddenEditor",contents:hiddenObjectList,onOpen:function opOpen(){hiddenObjectList.forEach(function(portlet){portlet.updateListScrollbars();});},fnOk:function(){var actions=[];hiddenObjectList.forEach(function(portlet){var selectedItems=portlet.getSelectedItems();selectedItems.forEach(function(item){actions.push(docModel.getToggleHiddenObjectAction(item.dsid,item,false));});});var callback=docModel.getDatasetsUpdateCallback();docModel.controller.cmdMgr.execute({execute:function(){this.submit(actions,callback,onlyDefExtras);},urInfo:{callback:callback}});}});}function updateDatasetsCollapsed(datasetCollapsedStatusArray,panel){$ARR.forEach(datasetCollapsedStatusArray,function(item){var dsid=item.dsid,dsInfo=panel.settings.dataset(dsid);dsInfo.isCollapsed=!!item.isCollapsed;});}function submitDatasetsCollapsed(datasetCollapsedStatusArray,panel){updateDatasetsCollapsed(datasetCollapsedStatusArray,panel);panel.saveSettings();}function removeDataset(datasetPanel,did){return function(){var model=datasetPanel.model,controller=model&&model.controller,actions=[{act:"removeDataset",did:did,disablePU:true,skipCleanup:true}],callback=controller.getRefreshCallback();if(datasetPanel.getDatasetCount()===2){updateDatasetsCollapsed($HASH.keyarray(model.datasets).filter(function(dsid){return dsid!==did;}).map(function(dsid){return{dsid:dsid,collapsed:false};}),datasetPanel);actions=actions.concat(datasetPanel.settings.getSaveActions());}controller.cmdMgr.execute({execute:function(){this.submit(actions,callback,{style:{params:{treesToRender:3}}});},urInfo:{callback:callback}});};}function replaceOneTierCube(dsPanel,docModel,dataset,dsid,mode){var connProxy=getConnectivityProxy(),onError=mstrmojo.onetier.vi.prefs.handleErrorMessage,isRepublish=dataset.dsm===mode,message,getPollingStataus=function getPollingStatus(data,callback){connProxy.getPollingStatus({id:data.id},{success:function success(res){switch(res.status){case 1:case 2:mstrApp.getRootController().showOrHideProgressBar(mstrmojo.desc(13568,"Download from server"),false);if(res.status===2){if(callback.failure){callback.failure(res.data);}}else{connProxy.refreshNativeDialogMenu();callback.success(res.data);}break;case 4:mstrApp.getRootController().showOrHideProgressBar(mstrmojo.desc(13568,"Download from server"),false);return ;default:mstrApp.getRootController().updateProgressBar({pct:res.pct,msg:res.msg,requestID:data.id,canCancel:res.status===0});getPollingStataus(res,callback);}},failure:function failure(){mstrApp.getRootController().showOrHideProgressBar("Download from server",false);}});},replaceCube=function(){connProxy.loadCube({objectID:dsid,addDatasetToDocument:false,dda:mode===DSM.DIRECT_ACCESS},{success:function(res){mstrApp.getRootController().showOrHideProgressBar("Download from server",true);getPollingStataus({id:res.id},{success:function(){getManifest(dsPanel,docModel,function(units){getWorkingSet(docModel,dataset.did,function(workingset){var workingSetObjects=generateWorkingSetObjects(workingset),members=[],member;workingSetObjects.forEach(function(wso){if(mstrmojo.array.find(units,"did",wso.did)!==-1){member={tgtid:wso.did,tgtt:wso.t,srcid:wso.did,srct:wso.t};if(wso.cont_did&&wso.cont_tp){member.cont_did=wso.cont_did;member.cont_tp=wso.cont_tp;}members.push(member);}});getApplyReconciliationFunction(dsPanel,docModel,false,{isOneTierCubeImport:true,source:{did:dsid,units:units},target:{did:workingset.did,units:workingSetObjects},onBack:mstrmojo.emptyFn})(members,false);});},dsid);}});}});};connProxy.getCubeInfo({cubeIds:dsid},{success:function(cubeInfo){if(mode===DSM.IN_MEMORY){if(cubeInfo.hsf){mstrmojo.alert(mstrmojo.desc(14171,"You can not download the data because a security filter has been defined for you in this project."));}else{if(cubeInfo.acld){mstrmojo.alert(mstrmojo.desc(14172,"You can not download the data because you do not have access to all the objects in the selected Intelligent cube."));}else{if(cubeInfo.dda){message=isRepublish?mstrmojo.desc(14079,"Data Access Mode for the corresponding Intelligent Cube on the MicroStrategy Server has changed from In-Memory to Connect Live. Due to this change, you will not be able to continue in In-Memory mode. Do you want to switch to Live Connection?"):mstrmojo.desc(14080,"Data Access Mode for the corresponding Intelligent Cube on the MicroStrategy Server has changed from In-Memory to Connect Live. Due to this change, you will not be able to switch to In-Memory mode.");mstrmojo.confirm(message,{confirmBtn:{fn:function(){mode=DSM.DIRECT_ACCESS;replaceCube();}}});}else{var getSizeLabel=function(sizeInKB){return"{"+(sizeInKB>=1048576?(sizeInKB/1048576).toFixed(2)+"GB":(Math.round((sizeInKB||0)*100/1024)/100).toFixed(2)+"MB")+"}";},maxFileSize=cubeInfo.maxcs*1024,cubeSize=cubeInfo.cs,bigCube=cubeSize>maxFileSize;if(bigCube){mstrmojo.alert(mstrmojo.desc(14081,"The size of the Intelligent Cube #  is more than the download limit ## set by the administrator. Therefore, you can only Connect Live to the selected Intelligent Cube.").replace("##",getSizeLabel(maxFileSize)).replace("#",getSizeLabel(cubeSize)));}else{replaceCube();}}}}}else{replaceCube();}},failure:function(res){onError(res);}});}function disconnectDataset(dataset,dsid,model,ignoreExecution,callback){if(mstrApp.isSingleTier&&dataset.hcs){var message=dataset.dsm===DSM.DIRECT_ACCESS?"You are using Live connection to an Intelligent Cube residing on a MicroStrategy Server. In order to continue, you need to first convert the cube to a local cube. Do you want to continue?":"You are using an Intelligent Cube from a MicroStrategy Server. In order to continue, you need to first convert the cube to a local cube. Do you want to continue?";mstrmojo.confirm(message,{confirmBtn:{fn:function(){model.getDataService().submitUpdates({act:"disconnectDataset",dsid:dsid,dsm:DSM.IN_MEMORY,ignoreExecution:ignoreExecution},$FUNC.wrapMethods(callback,{failure:mstrApp.onerror}),{style:{params:{treesToRender:0}}});}}});}}function getDataAccessModelSubMenu(dsPanel,dataset,dsid,model){function toggleDatasetServeMode(mode){var docModel=dsPanel.model,executeToggleServeMode=function(){if(mode===dataset.dsm){return ;}if(dataset.hcs){replaceOneTierCube(dsPanel,docModel,dataset,dsid,mode);}else{function executeCommand(){model.controller.cmdMgr.execute({execute:function(){this.submit({act:"toggleDatasetServeMode",dsid:dsid,dsm:mode},model.controller.getRefreshCallback(),{style:{params:{treesToRender:3}}});},urInfo:{callback:model.controller.getRefreshCallback()}});}if(mstrApp.isSingleTier&&!(mstrApp.supportFeature(mstrmojo.vi.enums.EnumFeatures.SUPPORT_LIVEMODE)&&mstrApp.getWSLiveMode())){checkCredentials(dsPanel,dsid,docModel,{callback:{success:executeCommand}});}else{executeCommand();}}};return function(){model.warnForEditStandaloneDS(dataset,executeToggleServeMode);};}return function DataAccessModelSubMenu(){var cfg=new mstrmojo.ui.menus.MenuConfig();cfg.addMenuItem(mstrmojo.desc(11921,"In-Memory"),dataset.dsm===DSM.IN_MEMORY?"on":"",toggleDatasetServeMode(DSM.IN_MEMORY));cfg.addMenuItem(mstrmojo.desc(12726,"Connect Live"),dataset.dsm===DSM.DIRECT_ACCESS?"on":"",toggleDatasetServeMode(DSM.DIRECT_ACCESS));cfg.hasToggleItem=true;return cfg;};}function datasetSaveAs(params,callback,datasetPanel){var action={act:"datasetSaveAs",managed:params.managed,nonDelta:true,dsID:params.dsID,rptName:params.rptName,rptDesc:params.rptDesc,saveAsOverwrite:params.saveAsOverwrite};if(!params.managed){action.folderID=params.folderID;}datasetPanel.model.controller.submitUndoRedoUpdates([action],{},$FUNC.wrapMethods(datasetPanel.model.getDatasetsUpdateCallback(),callback),{config:{showProgress:true,hideProgress:true,progressStateText:[mstrmojo.desc(8445,"Loading")],silent:true}},{disablePU:true,treesToRender:mstrmojo.DocDataService.EnumTreesToRender.DEFN,callback:datasetPanel.model.getDatasetsUpdateCallback(),extras:mstrmojo.DocDataService.REQUEST_ONLY_DEFINITION});}function getShowDatasetSaveasEditorFunc(datasetPanel,dsid){var id="mstrIVE_DS_SAVER";return function ShowDatasetSaveasEditor(){var editor=mstrmojo.all[id];if(!dsid){return ;}if(!editor){editor=new mstrmojo.SaveAsEditor({id:id,folderLinksContextId:32,showCompletePath:false,saveParams:{},saveAs:function(overwrite){var panel=this.contPanel;this.name=panel.name.value;this.desc=panel.desc.value;if(!this.name){mstrmojo.alert(mstrmojo.desc(3380,"Please enter valid name"));return ;}var params=this.saveParams||{};params.managed=false;params.folderID=this.ob.currentFolder.did;params.rptName=this.name||"";params.rptDesc=this.desc||"";params.saveAsOverwrite=!!overwrite;var saveAsCB=this.saveAsCallback();saveAsCB.failure=function(res){var ec=res.code,p=this.parent;if(ec==="-2147217373"||ec==="-2147216857"){$WARN(mstrmojo.desc(7986,"The ## '###' already exists. Do you want to replace the existing one?").replace("##",p.typeDesc||"Object").replace("###",p.name),{confirmBtn:{fn:function(){p.saveAs(true);}}},{title:mstrmojo.desc(3179,"Confirm Overwrite")});}else{if(ec==="-2147202302"){mstrmojo.alert(mstrmojo.desc(11642,"Cannot save report ## to overwrite report ###, because report #### is also used by the document.").replace("##",datasetPanel.data[dsid].name).replace("###",p.name).replace("####",p.name),null,mstrmojo.desc(11643,"Dataset Overwrite Error"));}else{mstrmojo.alert(mstrmojo.desc(7985,"Error while saving: ")+res.message);}}};saveAsCB.complete=$FUNC.wrapMethods(saveAsCB.complete,function(){mstrApp.hideWait();});saveAsCB.parent=this;datasetSaveAs(params,saveAsCB,datasetPanel);mstrApp.showWait({message:mstrmojo.desc(10492,"Saving...")});editor.close();}});editor.render();}editor.saveParams.dsID=dsid;editor.open();};}function addShowTableRowCountMenuItem(menuConfig,docModel,dataset){var tablesInfo=dataset.tables.map(function(table){var metricRef=table.mxRefs[$ARR.find(table.mxRefs,"rm",true)],metric=metricRef&&dataset.mx[$ARR.find(dataset.mx,"did",metricRef.did)];return $HASH.copy(table,{rowCountMetric:metric});}).filter(function(tableInfo){return tableInfo.rowCountMetric&&tableInfo.rowCountMetric.hide;});if(!tablesInfo.length){return ;}var subMenuConfig=new mstrmojo.ui.menus.MenuConfig();tablesInfo.forEach(function(tableInfo){subMenuConfig.addMenuItem(tableInfo.n,"",function(){var actions=[docModel.getToggleHiddenObjectAction(dataset.did,tableInfo.rowCountMetric,false)];var callback=docModel.getDatasetsUpdateCallback();docModel.controller.cmdMgr.execute({execute:function(){this.submit(actions,callback,onlyDefExtras);},urInfo:{callback:callback}});});});menuConfig.addSubMenuItem(mstrmojo.desc(13228,"Show Row Count"),"",null,function(){return subMenuConfig;});}function getVisibleDatasets(){var result=[];$ARR.forEach(this.contents.children,function(item){if(item.visible){result.push(item);}});return result;}function getRefreshDatasetFunc(datasetPanel,did){return function(){var docModel=datasetPanel.model;docModel.getDataService().submitUpdates([{act:"refreshReport",dsID:did}],docModel.controller.getRefreshCallback());};}function getAdvRefreshDatasetFunc(datasetPanel,dsid,dataset){return function(){var model=datasetPanel.model;function showDataImport(missingCredentialsData){datasetPanel.showDataImport({AnalysisId:model.mid,ReportId:dsid,CubeName:dataset.name,CubeDesc:dataset.dsc,isManagedCube:dataset.mngd,StatusCode:2,missingCredentialsData:missingCredentialsData,needDefn:true});}function checkCredentials(){model.getDataService().checkMissingCredentials({dsid:dsid},{success:function(res){window.setTimeout(function(){if(res.success){showDataImport();}else{showDataImport(res);}},0);},failure:function(res){mstrmojo.alert(res);}});}function hasTableError(ds){if(ds&&ds.tables){return ds.tables.some(function(table){return table.dbRole;});}return false;}if(mstrApp.isSingleTier&&!(mstrApp.supportFeature(mstrmojo.vi.enums.EnumFeatures.SUPPORT_LIVEMODE)&&mstrApp.getWSLiveMode())){checkCredentials();}else{if(!mstrApp.isSingleTier&&hasTableError(dataset)){var dsCopy=$HASH.clone(dataset),datasets=$DIHELPER.standardizeDBRolesFormat({dsid:dsCopy});showDataImport({datasets:datasets});}else{showDataImport();}}};}function updateUseTableView(){var dsoSettings=this.settings;this.set("useTableView",!!(dsoSettings&&dsoSettings.useTableView));}function checkAllDatasetsExpandedOrCollapsed(menuFlag){var dsoSettings=this.settings,hasSingleDataset=(this.contents.children||[]).length===1;if(menuFlag){if(hasSingleDataset){var singleChild=this.contents.children[0],view=singleChild.tableView||singleChild.mdxView;return view&&view.setting.hasCollapsedChildNodes(false,false);}else{return(this.contents.children||[]).some(function(child){var dsInfo=dsoSettings.dataset(child.did);return dsInfo.getCollapsed()===false;});}}else{return(this.contents.children||[]).some(function(child){var dsInfo=dsoSettings.dataset(child.did),view=child.tableView||child.mdxView;if(dsInfo.getCollapsed()===true){return true;}else{return view&&view.setting&&view.setting.hasCollapsedChildNodes(true,true);}});}}function getCreateDatesetSkippableError(){return[mstrApp.isWorkstation?$ERRCODE.UICMD_DEFAULT_ERROR:$ERRCODE.DOCDATA_PREPARE_TASK_REPORT_INCOMP];}function showNewDataTooltip(dontShow,newDataLink){if(!mstrApp.isOpenExisting&&!mstrApp.isVisBuilder&&this.model.isnew&&!dontShow&&newDataLink){var linkPos=$DOM.position(newDataLink.domNode);this.openPopup({scriptClass:"mstrmojo.Popup",autoCloses:true,locksHover:true,cssClass:"mstrmojo-VIDocDatasetObjects mstrmojo-Tooltip vi-regular vi-tooltip-C A-center",titleNodeCssClass:"mstrmojo-Tooltip-arrow",contentNodeCssClass:"mstrmojo-Tooltip-contentWrapper",children:[{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(15623,"To get started, click here to add your data.")},{scriptClass:"mstrmojo.CheckBox",label:mstrmojo.desc(14851,"Don’t show me again"),postcheckedChange:function oncheckedChange(){if(mstrApp.isWorkstation){var proxy=new mstrmojo.onetier.vi.prefs.DesktopConnectivityProxy(),pref={feature_flag:{}};pref.feature_flag[KEY_DONT_SHOW_AGAIN]=true;proxy.savePreferences(pref);}else{var localStorage=mstrmojo.global.localStore;localStorage.setItem(KEY_DONT_SHOW_AGAIN,this.checked,-1);}}}],updatePopupConfig:function updatePopupConfig(config){var popupConfig=this.popupConfig;if(!popupConfig){popupConfig=this.popupConfig=this.addDisposable(new mstrmojo.ui.PopupConfig({isHostedWithin:false}));}popupConfig.position=config.position;}},{position:{x:linkPos.x+linkPos.w+15,y:linkPos.y-4}});}}mstrmojo.vi.ui.DocDatasetObjects=mstrmojo.declare(mstrmojo.vi.ui.DatasetObjects,[mstrmojo.util.ui._HostsSplitter,mstrmojo.vi.ui.toolbars._HasToolbar,mstrmojo._HasPopup],{scriptClass:"mstrmojo.vi.ui.DocDatasetObjects",cssClass:"mstrmojo-VIDocDatasetObjects",datasetUnitListScriptClass:"mstrmojo.vi.ui.DocDatasetUnitList",settings:null,onLogout:function(sessionState){var controller=mstrApp.rootCtrl,dataProvider=controller.dataProvider,dpSession=dataProvider&&dataProvider.sessionState;if(!sessionState||(dpSession&&dpSession===sessionState)){controller.set("dataProvider",null);}},init:function init(props){this._super(props);this.model.attachEventListener("updateUseTableView",this.id,function(){updateUseTableView.call(this);});updateUseTableView.call(this);},onsettingsChange:function(){updateUseTableView.call(this);},onAppStateChange:function onAppStateChange(evt){this._super(evt);if(this.visible&&mstrmojo.vi.VisualInsightApp.APP_STATES.PRESENTATION&evt.valueWas&&!mstrApp.isAppStatePresentation()){this.refresh();}},getLinksForEmptyData:function getLinksForEmptyData(){var model=this.model,fnGetTooltipConfig=function fnGetTooltipConfig(tooltip){return{useRichTooltip:true,updateTooltipConfig:function updateTooltipConfig(){var popup=this.parent.parent._lastOpened,isPopupVisible=popup&&popup.visible,targetPosition=$DOM.position(this.domNode);this.richTooltip=(isPopupVisible&&this.alias==="newDataLink")?null:{content:tooltip,cssClass:"vi-regular vi-tooltip-C A-center",left:targetPosition.x+targetPosition.w+10,top:targetPosition.y-4};}};},linkNewReport=$NWB(mstrmojo.desc(15398,"Existing Objects"),function(){this.model.controller.createDataset();}.bind(this),false,fnGetTooltipConfig(mstrmojo.desc(15399,"Create a new dataset using attributes and metrics available on any one of your connected environments."))),linkExistDataset=$NWB(mstrmojo.desc(15343,"Existing Dataset"),function(){this.model.controller.addDataset();}.bind(this),false,fnGetTooltipConfig(mstrmojo.desc(15400,"Select a dataset from any one of your connected environments. Includes existing reports and cubes."))),linkImport=$NWB(mstrmojo.desc(15396,"New Data"),function(){this.model.controller.importFile();}.bind(this),false,$HASH.copy({alias:"newDataLink"},fnGetTooltipConfig(mstrmojo.desc(15401,"Import data from your local machine, such as excel or csv files, or connect to a database.")))),children=[];if(model.allowImportData()){children.push(linkImport);children.push({scriptClass:"mstrmojo.Box",cssClass:"button-splitter"});}if(model.allowManageDocumentDataset()&&!(mstrApp&&mstrApp.isWorkstation&&mstrApp.isVisBuilder)){children.push(linkExistDataset);}if(model.allowNewOrEditRolapDS()&&(model.isSchemaDefined()||mstrApp.isWorkstation)){children.push(linkNewReport);}var longestTextBtn={text:""};children.forEach(function(button){var text=button.text;if(text&&(text.length>longestTextBtn.text.length)){longestTextBtn=button;}});longestTextBtn.cssClass+=" longest";if(children.length>0){children.unshift({scriptClass:"mstrmojo.Label",text:mstrmojo.desc(11780,"Add Data")});}return children;},getDatasetTableView:function getDatasetTableView(dataset,dsid){var me=this,dsoSettings=this.settings;return mstrmojo.mixin({setting:dsoSettings.dataset(dsid),onTableCollapsedChange:function(tableId,isCollapsed){this._super();if(!me.isSearching){this.setting.table(tableId).isCollapsed=isCollapsed;me.saveSettings();}}},this._super(dataset,dsid));},getDatasetMDXView:function getDatasetMDXView(dataset,dsid){var me=this,tableId=dataset.tables&&dataset.tables[0]&&dataset.tables[0].did;return mstrmojo.mixin({setting:this.settings.dataset(dsid).table&&this.settings.dataset(dsid).table(tableId),onNodeCollapsedChange:function(node){this._super();if(!me.isSearching){node.setting.isCollapsed=node.isCollapsed;me.saveSettings();}}},this._super(dataset,dsid));},getDatasetPortlet:function getDatasetPortlet(dataset,dsid,panel,panelId){var me=this,model=me.model,panelConfig=this._super(dataset,dsid,panel,panelId),isFromProject=dataset.st===768,isReportCube=dataset.st===776,isEmmaDataCube=dataset.st===779,acg=dataset.acg,canUseExecute=acg&&(acg&$ACG.DssAccessRightUseFlag)&&(acg&$ACG.DssAccessRightExecuteFlag),setting=this.settings&&this.settings.dataset(dsid);$HASH.copy({isCollapsed:setting?!!(setting.getCollapsed()):false,onCollapsedChange:function onCollapsedChange(){submitDatasetsCollapsed([{dsid:dsid,isCollapsed:this.isCollapsed}],panel);},onclick:function(evt){var tgt=evt.getTarget(),pp=this;if(mstrmojo.dom.contains(pp.titleBar.leftToolNode,tgt,true,pp.domNode)){me.updateScrollbars();if(!me.isSearching){submitDatasetsCollapsed([{dsid:pp.did,isCollapsed:pp.isCollapsed}],panel);}}},addMenuItems:function addMenuItems(cfg){var isCustConn=false;cfg.hostId=this.id;cfg.isHostedWithin=false;cfg.supportsScroll=true;cfg.maxHeight=$DOM.getMaxScrollHeight();var isHadoopLiveDS4Local=(mstrApp.getWSLiveMode&&!mstrApp.getWSLiveMode())&&model.hasHadoopSource(dataset)&&!model.isLiveDataset(dataset);function executeEditDatasetCommand(){var controller=model.controller,confirmEdit=function(okFn){mstrmojo.confirm(mstrmojo.desc(16016,"Updating this dataset may take some time. Do you want to update it anyway?"),{confirmBtn:{t:mstrmojo.desc(505,"Update"),fn:okFn},cancelBtn:{t:mstrmojo.desc(2140,"Cancel"),fn:mstrmojo.emptyFn}},{title:mstrmojo.desc(13850,"Update Dataset")});},rolapDatasetEditorCfg={dataset:$HASH.clone(dataset),docModel:model,title:mstrmojo.desc(3034,"Edit Dataset")+" - "+dataset.name,okBtnText:mstrmojo.desc(13850,"Update Dataset"),onOk:function(actions){var editor=this,refreshCallBack=$FUNC.wrapMethods(controller.getRefreshCallback(),{failure:function(res,xhr){this.canceled(xhr.id);}});if(actions.length){var updateDataset=function(){controller.cmdMgr.execute({execute:function(){this.submit(actions,$FUNC.wrapMethods(refreshCallBack,{success:function(){editor.close();}}),$HASH.copy({skipUICmdMgrOnFailure:getCreateDatesetSkippableError()},EXTTRAS_REQUEST_DEFN_DATA));},urInfo:{callback:refreshCallBack}});};if(editor.dataset.dsm===DSM.DIRECT_ACCESS&&editor.modifiedItems.del.length===0){updateDataset();}else{confirmEdit(updateDataset);}}}},emmaCubeDatasetEditorCfg={isEdit:true,isNewAnalysis:false,isManagedCube:dataset.mngd,AnalysisId:model.mid,ReportId:dsid,CubeName:dataset.name,CubeDesc:dataset.dsc,StatusCode:1,needDefn:true};if(!dataset.mngd){var keepChangesLocalWebButton=$NWB(mstrmojo.desc(13364,"Keep Changes Local"),function(){var oldDatasets=model.datasets,convertDatasetActions={act:"convertDatasetToManaged",dsID:dsid};if(isEmmaDataCube){executeDynamic.call(me,function(){var cmd=controller.cmdMgr.getInterimCmd();cmd.urInfo.callback=controller.model.getDatasetsUpdateCallback();cmd.submitInterim(convertDatasetActions,{success:function(res){var newManagedDataset=null,newDatasetId=null;$HASH.forEach(res.datasets,function(datasetItem,datasetId){if(!oldDatasets[datasetId]){newManagedDataset=datasetItem;newManagedDataset.did=newDatasetId=datasetId;return false;}});me.showDataImport({isEdit:true,isNewAnalysis:false,isManagedCube:newManagedDataset.mngd,AnalysisId:model.mid,ReportId:newDatasetId,CubeName:newManagedDataset.name,CubeDesc:newManagedDataset.dsc,StatusCode:1,callback:function(datasets){var cmdMgr=me.model.cmdMgr(),interimCmd=cmdMgr.getInterimCmd();if(datasets){var refreshCallback=me.model.controller.getRefreshCallback();interimCmd.urInfo.callback=refreshCallback;interimCmd.resetCmdMgrOnComplete();interimCmd.submit([],refreshCallback,EXTTRAS_REQUEST_DEFN_DATA,cmdMgr.CMD_PHASE.LAST);}else{var urInfo=interimCmd.urInfo;urInfo.callback={success:mstrmojo.emptyFn};urInfo.treesToRender=0;interimCmd.cancel();}}});}});});}else{panel.openDatasetEditor($HASH.copy(rolapDatasetEditorCfg,{modifiedItems:{convert:convertDatasetActions,add:[],del:[],fs:{add:[],del:[]},filter:null}}));}},true);var writeAccess=dataset.acg&$ACG.DssAccessRightWriteFlag;var executeAccess=dataset.acg&$ACG.DssAccessRightExecuteFlag;if(!(writeAccess&&executeAccess)){$WARN(mstrmojo.desc(16029,"You do not have execute or write access to this stand-alone dataset. You can only make changes local to this dossier by duplicating and embedding the dataset in this dossier."),{},{cssClass:"mstrmojo-warning-ConfirmEditDataset",buttons:[$NWB(mstrmojo.desc(3034,"Edit Dataset"),mstrmojo.emptyFn,true,{enabled:false}),$NWB(mstrmojo.desc(2140,"Cancel"),mstrmojo.emptyFn),keepChangesLocalWebButton]});}else{$WARN(mstrmojo.desc(16030,"Editing this dataset will immediately affect other documents and dossiers that share the dataset. Do you want to edit the stand-alone dataset or keep your changes local by duplicating and embedding the dataset in this dossier?"),{},{cssClass:"mstrmojo-warning-ConfirmEditDataset",buttons:[$NWB(mstrmojo.desc(3034,"Edit Dataset"),function(){if(isEmmaDataCube){me.showDataImport(emmaCubeDatasetEditorCfg);}else{var editCfg=$HASH.copy(rolapDatasetEditorCfg);editCfg.onOk=function(actions){if(actions.length){var editor=this;confirmEdit(function(){var refreshCallBack=$FUNC.wrapMethods(controller.getRefreshCallback(),{failure:function(res,xhr){this.canceled(xhr.id);}});controller.cmdMgr.execute({execute:function(){this.submit(actions,$FUNC.wrapMethods(refreshCallBack,{success:function(){editor.close();}}),{skipUICmdMgrOnFailure:getCreateDatesetSkippableError(),style:{params:{treesToRender:3}}});},urInfo:{callback:refreshCallBack}});});}};panel.openDatasetEditor(editCfg);}}),$NWB(mstrmojo.desc(2140,"Cancel"),mstrmojo.emptyFn),keepChangesLocalWebButton]});}}else{if(isEmmaDataCube){me.showDataImport(emmaCubeDatasetEditorCfg);}else{panel.openDatasetEditor(rolapDatasetEditorCfg);}}}var copyable=dataset.copyable==="true"||dataset.copyable===undefined;if(!(model.isRADataset(dataset)&&(!isEmmaDataCube||mstrApp.isSingleTier))&&!isReportCube&&dataset.rt!==8&&isDownLoadDatasetEditable.call(me,dataset)&&!(isFromProject&&!model.allowModifyReportList())&&!isCustConn&&((isEmmaDataCube&&model.hasPrivilegesForAllTables(dataset.tables))||(!isEmmaDataCube&&((!dataset.idd&&!dataset.mngd&&model.allowManageDocumentDataset())||(!dataset.idd&&dataset.mngd&&model.allowNewOrEditRolapDS())||(dataset.idd&&model.allowNewOrEditDummyDS()))))&&!mstrApp.isInVFConfigMode&&!model.isSparkDataset(dataset)&&!isHadoopLiveDS4Local){var funcCall,tlpText;if(copyable){funcCall="addMenuItem";tlpText="";}else{funcCall="addDisabledMenuItem";tlpText=mstrmojo.desc(16119,"Editing the dataset is not available for this dossier as the data has been limited for your specific user.");}cfg[funcCall]({n:mstrmojo.desc(11923,"Edit Dataset..."),ttp:tlpText},"",function(){var hasSaleForce=false;if(mstrApp.isSingleTier&&!(mstrApp.supportFeature(mstrmojo.vi.enums.EnumFeatures.SUPPORT_LIVEMODE)&&mstrApp.getWSLiveMode())){$ARR.forEach(dataset.tables,function(table){if(table.xdaType===$DICONST.xdaType.salesforce){hasSaleForce=true;return false;}});if(hasSaleForce){executeEditDatasetCommand();}else{checkCredentials(panel,dsid,model,{callback:{success:executeEditDatasetCommand}});}}else{executeEditDatasetCommand();}});}if(dataset.dsm===DSM.IN_MEMORY&&!model.isMDXDataset(dataset)&&!(mstrApp.isAppStatePause&&mstrApp.isAppStatePause())){if(!dataset.tables||dataset.tables.length===1){cfg.addMenuItem(mstrmojo.desc(13537,"Show Data..."),"shwd",function(){mstrmojo.vi.ui.ViewDataDialog.openDS(model,dataset,dsid);});}else{cfg.addPopupMenuItem(mstrmojo.desc(11476,"Show Data"),"",function(){var subMenuCfg=new mstrmojo.ui.menus.MenuConfig(),tables=dataset.tables;tables.forEach(function(tb,ix){subMenuCfg.addMenuItem(tb.n,"",function(){mstrmojo.vi.ui.ViewDataDialog.openDSTable(model,dataset,dsid,ix);});});return subMenuCfg;});}}if(!mstrApp.isInVFConfigMode){if(model.allowManageDocumentDataset()){cfg.addSubMenuItem(mstrmojo.desc(4571,"Join Behavior"),"",this.id,function(){return setJoinBehavior(model,dataset);});cfg.addSeparator();}if(!model.isDataImportRemoteDataSource(dataset)||mstrApp.isSingleTier){if(dataset.hcs){if(dataset.idd!==true){cfg.addMenuItem(mstrmojo.desc(773,"Refresh"),"",function(){replaceOneTierCube(panel,panel.model,dataset,dsid,dataset.dsm);});}}else{if((dataset.rt===1&&model.allowReExecuteRegularReport())||(dataset.rt===8&&model.allowReExecuteViewReport())){cfg.addMenuItem(mstrmojo.desc(15209,"Refresh Dataset"),"",function(){mstrmojo.confirm(mstrmojo.desc(16015,"Refreshing this dataset may take some time. Do you want to update it anyway?"),{confirmBtn:{t:mstrmojo.desc(505,"Update"),fn:getRefreshDatasetFunc(panel,dataset.did)},cancelBtn:{t:mstrmojo.desc(2140,"Cancel"),fn:mstrmojo.emptyFn}},{title:mstrmojo.desc(15209,"Refresh Dataset")});});}else{if(isReportCube&&model.allowManageDocumentDataset()&&model.allowReExecuteCubeReport()&&!dataset.localbin&&canUseExecute){cfg.addMenuItem(mstrmojo.desc(13610,"Republish Cube..."),"",function(){mstrmojo.confirm(mstrmojo.desc(13956,"Publishing time depends on your dataset. Are you sure you want to republish?"),{confirmBtn:{t:mstrmojo.desc(13953,"Republish"),fn:getRefreshDatasetFunc(panel,dataset.did)},cancelBtn:{t:mstrmojo.desc(2140,"Cancel"),fn:mstrmojo.emptyFn}},{title:mstrmojo.desc(2914,"Warning")});});}else{if(isEmmaDataCube&&dataset.sda!==SDA.SupportDDAOnly&&dataset.dsm!==DSM.DIRECT_ACCESS&&model.allowManageDocumentDataset()&&model.allowReExecuteCubeReport()&&model.hasPrivilegesForAllTables(dataset.tables)&&!model.isSparkDataset(dataset)&&canUseExecute){cfg.addMenuItem(mstrmojo.desc(13610,"Republish Cube..."),"",getAdvRefreshDatasetFunc(panel,dsid,dataset));}}}}}}if(dataset.sda===SDA.SupportDDAOrInMemory&&dataset.rt===7&&model.allowManageDocumentDataset()&&dataset.acg&$ACG.DssAccessRightWriteFlag&&!model.isSparkDataset(dataset)&&mstrmojo.resolveFeature($FEATURES.WEB_IMPORT_DATABASE)){cfg.addSubMenuItem(mstrmojo.desc(11922,"Data Access Mode"),"",this.id,getDataAccessModelSubMenu(panel,dataset,dsid,model));}if((allowMultipleWorkingsets()||me.getDatasetCount()>1)&&model.allowManageDocumentDataset()&&!(this.mdxView&&this.mdxView.docModel.isRADataset(this.dataset))){if(mstrApp.isInVFConfigMode){cfg.addNonInteractiveMenuItem(mstrmojo.desc(11484,"Replace Dataset with"),"",true);}else{cfg.addSubMenuItem(mstrmojo.desc(11484,"Replace Dataset with"),"",this.id,getReplaceDatasetMenuHandler(panel));}}cfg.addSeparator();if(isEmmaDataCube&&this.useTableView){addShowTableRowCountMenuItem(cfg,model,dataset);}if(!mstrApp.isInVFConfigMode&&mstrmojo.resolveFeature($FEATURES.INSERT_NEW_METRIC)){cfg.addMenuItem(mstrmojo.desc(13624,"Create Metric..."),"",insertNewMetric.call(this,dataset,model));if(!mstrApp.isInVFConfigMode&&!(model.isMDXDataset(dataset)&&model.isDDADataset(dataset))){cfg.addMenuItem(mstrmojo.desc(13625,"Create Attribute..."),"",insertNewDerivedAttr.call(this,this.did,me.data));}}cfg.addSeparator();if(!mstrApp.isSingleTier&&!dataset.idd&&model.allowSaveDataset()&&model.allowWebExecuteCubeReport()){if(((dataset.att||[]).length+(dataset.mx||[]).length)>0){var funcCall,tlpText;if(copyable){funcCall="addMenuItem";tlpText="";}else{funcCall="addDisabledMenuItem";tlpText=mstrmojo.desc(16120,"Saving the dataset is not available for this dossier as the data has been limited for your specific user.");}cfg[funcCall]({n:mstrmojo.desc(13239,"Save Dataset..."),ttp:tlpText},"",getShowDatasetSaveasEditorFunc(panel,this.did));}}if(dataset.mngd&&model.allowManageDocumentDataset()){if(((dataset.att||[]).length+(dataset.mx||[]).length)>0){if(!(mstrApp.isSingleTier&&dataset.hcs&&!dataset.idd)){cfg.addMenuItem(mstrmojo.desc(1388,"Rename"),"rnm",function(){this.ctxt.titleBar.editTitle();},this);}}}if(model.allowManageDocumentDataset()){if(mstrApp.isInVFConfigMode){cfg.addNonInteractiveMenuItem(mstrmojo.desc(629,"Delete"),"",true);}else{cfg.addMenuItem(mstrmojo.desc(629,"Delete"),"",removeDataset(this.parent.parent,this.did));}}if(panel.gridSource===this.did){cfg.addToolbarBtn(mstrmojo.desc(11647,"This is the primary dataset."),"default-set",mstrmojo.emptyFn);}if(dataset.unpublished){cfg.addToolbarBtn(mstrmojo.desc(15803,"This cube is not published"),"unpublished",mstrmojo.emptyFn);}var highlight=$DUMU.getHighlightElementHandler;cfg.addPopupHandlers(this.id,highlight(true,this.titlebarNode),highlight(false,this.titlebarNode));if(isEmmaDataCube&&model.allowManageDocumentDataset()&&model.hasPrivilegesForAllTables(dataset.tables)&&!model.isSparkDataset(dataset)){var tables=dataset.tables;if(tables&&tables.length>1&&!(mstrApp.isSingleTier&&dataset.dsm===DSM.DIRECT_ACCESS)){cfg.addSubMenuItem(mstrmojo.desc(11924,"Delete Table"),"","",function(){var subMenuCfg=new mstrmojo.ui.menus.MenuConfig();tables.forEach(function(tb){subMenuCfg.addMenuItem(tb.n,"",function(){var deleteEMMATable=function(){model.warnForEditStandaloneDS(dataset,function(){model.getDataService().submitUpdates({act:"deleteEMMATable",dsid:dsid,tbid:tb.did},$FUNC.override({success:function(res){this._super.call(model,res);model.controller.cmdMgr.reset();}},model.controller.getRefreshCallback()));});};if(mstrApp.isSingleTier&&dataset.hcs){disconnectDataset(dataset,dsid,model,true,{success:function(){deleteEMMATable();}});}else{deleteEMMATable();}});});return subMenuCfg;});}}return cfg;}},panelConfig);return panelConfig;},getDatasetTitleBarCfg:function(datasetPortlet){var cfg=this._super(datasetPortlet),me=this,dataset=datasetPortlet.dataset;$HASH.copy({editTitleOnDoubleClick:me.model.allowManageDocumentDataset()&&!!dataset.mngd&&((dataset.att||[]).length+(dataset.mx||[]).length)>0,useRichTooltip:true,titleEdited:function titleEdited(titleText,textChanged,oldText){if(textChanged){var fnCancel=function(){datasetPortlet.titleBar.set("title",oldText);},fnOk=function(){me.model.renameDataset(datasetPortlet.did,titleText.trim(),$FUNC.wrapMethods(me.model.getDatasetsUpdateCallback()),{failure:function(err){mstrApp.onerror(err);datasetPortlet.titleBar.set("title",oldText);}});};var duplicateDatasetName=false;$HASH.forEach(me.model.datasets,function(v){if(v.name===titleText.trim()){duplicateDatasetName=true;return false;}});if(duplicateDatasetName){$WARN(mstrmojo.desc(13365,"Another dataset with same name exists. Do you want to keep this name?"),{},{buttons:[$NWB(mstrmojo.desc(1442,"OK"),function(){$DUMU.validateName(titleText,fnOk,fnCancel);},true),$NWB(mstrmojo.desc(2140,"Cancel"),function(){fnCancel();})]});}else{$DUMU.validateName(titleText,fnOk,fnCancel);}}},updateTooltipConfig:function updateTooltipConfig(evt){var position=$DOM.position(this.domNode);this.richTooltip={content:this.getTooltipContent(),posType:mstrmojo.tooltip.POS_TOPLEFT,cssClass:"vi-regular vi-tooltip-C",top:position.y-2,left:position.x+position.w+6};},shouldShowTooltip:function(evt,win){return true;},getTooltipContent:function getTooltipContent(){dataset=this.parent.dataset;var datasetName=dataset.name,datasetType,datasetStreamType='<span class="dsc">#####</span>',content='<div class="name">@@@@@</div>',datasetTypeMap={1:mstrmojo.desc(16230,"Standard Report"),7:{"true":mstrmojo.desc(16232,"OLAP Cube"),"false":mstrmojo.desc(16233,"Super Cube")},8:mstrmojo.desc(16231,"Cube Report")},typeMap=datasetTypeMap[dataset.rt];datasetType=(typeMap||{})[!!dataset.xdaType];datasetType=datasetType||typeMap;if(mstrApp.isSingleTier){if(!dataset.hcs&&!dataset.connInfo){if(dataset.dsm==2){content=content.replace("@@@@@","@@@@@ "+datasetStreamType.replace("#####",mstrmojo.desc(13575,"(Live)")));}}else{if(!!dataset.hcs&&!!dataset.connInfo){if(dataset.dsm==2&&(dataset.sdsm==1||dataset.sdsm==2)){content=content.replace("@@@@@","@@@@@ "+datasetStreamType.replace("#####",mstrmojo.desc(16235,"(Live to Server)")));}}}}else{if(dataset.dsm===2){content=content.replace("@@@@@","@@@@@ "+datasetStreamType.replace("#####",mstrmojo.desc(13575,"(Live)")));}}if(datasetType){if(mstrApp.isAppStatePause()&&dataset.unpublished){content+='<div class="dsc unpublished">'+mstrmojo.desc(16234,"This ##### is unpublished.")+"</div>";}else{content+='<div class="dsc">'+mstrmojo.desc(16229,"Dataset type")+": #####</div>";}content=content.replace("#####",datasetType);}content=content.replace("@@@@@",mstrmojo.string.encodeHtmlString(datasetName));return content;},},cfg);return cfg;},saveSettings:function(){if(this.settings){this.settings.save();this.generateToolbar();}},ongridSourceChange:function(){this._super();var me=this,updateToolbar=function(){$HASH.forEach(me.data,function(ds,did){var portlet=me.getDatasetPanel(did);if(portlet){portlet.generateToolbar();}});};if(this.visible){updateToolbar();}else{if(!this.updateToolbarHandle){this.updateToolbarHandle=this.attachEventListener("showPanel",this.id,function(){me.updateToolbarHandle.clear();delete me.updateToolbarHandle;updateToolbar();});}}},handleNode:null,unit:null,gridSource:null,postBuildRendering:function postBuildRendering(){var handleNode=this.handleNode;handleNode.style.display="block";this.registerSplitter(handleNode);var ret=this._super();var importDataBox=this.importDataBox,newDataLink=importDataBox&&importDataBox.newDataLink;if(mstrApp.isWorkstation&&!(mstrApp.getWSLiveMode&&mstrApp.getWSLiveMode())){var proxy=new mstrmojo.onetier.vi.prefs.DesktopConnectivityProxy(),me=this;proxy.getSavedPreferences({success:function(res){var feature_flag=res.feature_flag||{},dontShowAgain=feature_flag[KEY_DONT_SHOW_AGAIN];showNewDataTooltip.call(me,dontShowAgain,newDataLink);}});}else{var localStorage=mstrmojo.global.localStore;showNewDataTooltip.call(this,localStorage.getItem(KEY_DONT_SHOW_AGAIN),newDataLink);}return ret;},unrender:function unrender(ignoreDom){this.closePopup();this._super(ignoreDom);},setDimensions:function setDimensions(h,w){this._super(h,w);var handleNode=this.handleNode,handleStyle=handleNode&&handleNode.style;if(handleStyle){handleStyle.top=0;handleStyle.left=w;handleStyle.height=h;handleStyle.width="6px";}},getSplitterInfo:function getSplitterInfo(){return{min:120,max:Math.max(parseInt(this.parent&&this.parent.width,10)/2,330)};},postCreate:function postCreate(){var min=this.getSplitterInfo().min,halfWindowWidth=$DOM.windowDim().w/2;if(parseInt(this.width,10)<min){this.set("width",min);}if((halfWindowWidth>=min&&parseInt(this.width,10)>halfWindowWidth)||parseInt(this.width,10)>2000){this.set("width","174px");}},splitterMoved:function splitterMoved(position){var prop="width",value=parseInt(this[prop],10)+position;this.set(prop,value+"px");this.parent.doLayout();this.getPanelSaver().saveProperty("size",value);},passToolbarCfg:function passToolbarCfg(cfg){var existingToolbarCfg=this.titleBar.toolbarCfg;if(existingToolbarCfg){existingToolbarCfg.destroy();}this.titleBar.set("toolbarCfg",cfg);},updateToolbar:function updateToolbar(cfg){var isOneTierApp=mstrApp.isSingleTier;var id=this.id,me=this,datasets=this.contents.children,visibleDatasets=getVisibleDatasets.call(this),addDatasetLabel=isOneTierApp?mstrmojo.desc(14305,"Add New Data"):mstrmojo.desc(11780,"Add Data");cfg.hostId=this.id;cfg.isHostedWithin=false;cfg.supportsScroll=true;cfg.maxHeight=$DOM.getMaxScrollHeight();if(!me.model.hasMDXRADataset(me.model.datasets)){if((mstrApp.isWorkstation&&me.model.allowImportData())||me.model.allowManageDocumentDataset()){if(mstrApp.isInVFConfigMode){cfg.addNonInteractiveMenuItem(addDatasetLabel,"",true);}else{cfg.addPopupMenuItem(addDatasetLabel,id,getAddDatasetMenu(me),"");}}}if((allowMultipleWorkingsets()||me.getDatasetCount()>1)&&me.model.allowManageDocumentDataset()&&!me.model.hasMDXRADataset()){cfg[(!mstrApp.isInVFConfigMode&&me.getDatasetCount()>0)?"addSubMenuItem":"addDisabledMenuItem"](mstrmojo.desc(11485,"Replace All Datasets"),"",this.id,getReplaceDatasetMenuHandler(me,true));}cfg.addSeparator();if(hasHiddenObjects(me.model)){cfg.addEditorMenuItem(mstrmojo.desc(11612,"Show Hidden Objects"),this.id,function(){return showHiddenObjects(me.model);});}cfg.addSeparator();var hasMultiTableDatasets=$HASH.valarray(me.data).some(function(dataset){return dataset.tables&&dataset.tables.length>1;});var hasMultiMDXNodes=$HASH.valarray(me.data).some(function(dataset){if(me.model.isMDXDataset(dataset)){var table=dataset.tables[0];return(table.dimensions&&table.dimensions.length>0)||(table.metricFolder&&table.metricFolder.folders&&table.metricFolder.folders.length>0);}return false;});if(hasMultiTableDatasets){cfg.addSeparator();cfg.addRadioMenuGroup(!!me.settings.useTableView,function(v){var dsoSettings=me.settings;dsoSettings.useTableView=v;me.model.raiseEvent({name:"updateUseTableView",useTableView:v});me.saveSettings();},[{value:false,text:mstrmojo.desc(11925,"Flat View")},{value:true,text:mstrmojo.desc(11926,"Table View")}],"",null,true);}if(datasets&&(datasets.length>1||(hasMultiTableDatasets&&me.settings.useTableView)||hasMultiMDXNodes)){cfg.addSeparator();var enableExpandAll=true,enableCollapseAll=true;if(visibleDatasets.length<datasets.length){enableExpandAll=false;enableCollapseAll=false;}else{enableExpandAll=checkAllDatasetsExpandedOrCollapsed.call(me,false);enableCollapseAll=checkAllDatasetsExpandedOrCollapsed.call(me,true);}if(!enableExpandAll){cfg.addDisabledMenuItem(mstrmojo.desc(11816,"Expand All"),"expand-all");}else{cfg.addMenuItem(mstrmojo.desc(11816,"Expand All"),"expand-all",function(){me.toggleAllNodesCollapsed(false,true);});}if(!enableCollapseAll){cfg.addDisabledMenuItem(mstrmojo.desc(11817,"Collapse All"),"collapse-all");}else{cfg.addMenuItem(mstrmojo.desc(11817,"Collapse All"),"collapse-all",function(){me.toggleAllNodesCollapsed(true,true);});}}cfg.addSeparator();cfg.addMenuItem(mstrmojo.desc(1143,"Help"),"help",function(){mstrApp.showHelpTopic("datasets_panel.htm");});return cfg;},getShowDatasetPicker:function(config){var me=this;return function(){var editor=getDatasetPicker($HASH.copy(config,{id:"mstrIVE_DS",multiSelect:true,onOk:function(){executeDynamic.call(me,function(){me.model.addDataset(editor.selectedItems);});}}));editor.open();};},openDatasetEditor:function(props){var docModel=props.docModel,controller=docModel.controller,me=this,datasets=docModel.datasets,config=$HASH.copy(props,{onOk:function(actions){var editor=this,refreshCallBack=$FUNC.wrapMethods(controller.getRefreshCallback(),{failure:function(res,xhr){this.canceled(xhr.id);}});if(actions.length){controller.cmdMgr.execute({execute:function(){this.submit(actions,$FUNC.wrapMethods(refreshCallBack,{success:function(){editor.close();}}),{skipUICmdMgrOnFailure:getCreateDatesetSkippableError(),style:{params:{treesToRender:3}}});},urInfo:{callback:refreshCallBack}});}},closeOnSubmit:false,hasLTSDataset:docModel.hasLTSDataset(datasets),derivedMetricCount:docModel.getDerivedMetricCount(props.dataset)});this.model.controller.rootCtrl.loadDataProvider(function(dataProvider){config.dataProvider=dataProvider;var editor=new mstrmojo.vi.ui.DatasetEditor(config);me.datasetEditorId=editor.id;editor.open();});},onDatasetFilterChange:function(datasetId){if(datasetId&&this.settings.dataset(datasetId).isCollapsed){submitDatasetsCollapsed([{dsid:datasetId,isCollapsed:false}],this);}this.generateToolbar();this.updateScrollbars();},showDataImport:function showDataImport(config){config.hasNonRADataset=this.model.hasNonRADataset();var di;if(this.dataImportId){di=mstrmojo.all[this.dataImportId];}if(!di){di=mstrmojo.insert(mstrmojo.DI.DIContainer);}this.dataImportId=di.id;var me=this,openDI=function(){$HASH.copy(config,di.dataImportParams);di.open();};var cleanUp=function(){var dataToClear=config&&config.missingCredentialsData,ids={},helper=function(obj,collection){if(!obj||collection[obj.id]){return ;}if(obj.id&&obj.destroy){collection[obj.id]=true;}if(obj.constructor===Array){for(var i=0;i<obj.length;i++){helper(obj[i],collection);}}else{if(typeof obj==="object"){var property;for(property in obj){if(obj.hasOwnProperty(property)){helper(obj[property],collection);}}}}};helper(dataToClear,ids);var id;for(id in ids){if(ids.hasOwnProperty(id)){var mstrObj=mstrmojo.all[id];if(mstrObj&&mstrObj.destroy){mstrObj.destroy();}}}};if(config.callback){di.dataImportCallback=function(datasets){config.callback(datasets);cleanUp();};openDI();}else{di.dataImportCallback=function(datasets){var newStandAloneDS=[],cmdMgr=me.model.cmdMgr(),interimCmd=cmdMgr.getInterimCmd();if(datasets){newStandAloneDS=(datasets||[]).filter(function(ds){return !me.model.datasets[ds.did]&&!ds.mngd;});if(newStandAloneDS.length){me.model.addDataset(newStandAloneDS,{success:function(){interimCmd.completeSubmit();}});}else{var refreshCallback=me.model.controller.getRefreshCallback(),extras=config.needDefn?EXTTRAS_REQUEST_DEFN_DATA:null;interimCmd.urInfo.callback=refreshCallback;interimCmd.resetCmdMgrOnComplete();interimCmd.submit(me.model.getOpenDatasetPanelAction(),refreshCallback,extras,cmdMgr.CMD_PHASE.LAST);}}else{var urInfo=interimCmd.urInfo;urInfo.callback={success:mstrmojo.emptyFn};urInfo.treesToRender=0;interimCmd.cancel();}cleanUp();};executeDynamic.call(me,openDI);}}});}());