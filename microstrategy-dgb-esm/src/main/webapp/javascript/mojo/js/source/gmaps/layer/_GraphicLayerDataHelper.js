(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.string","mstrmojo.form","mstrmojo.gmaps.MapEnums","mstrmojo.gmaps.MapUtils","mstrmojo.elementHelper");var $ARR=mstrmojo.array,$STR=mstrmojo.string,$GMAPS=mstrmojo.gmaps,$MUTIL=$GMAPS.MapUtils,ENUM_GRAPHIC_TYPE=$GMAPS.EnumGraphicType,ENUM_THRESHOLD_TYPE=$GMAPS.EnumThresholdType,ENUM_DRILL_LINK_ANSWER_TYPE=$GMAPS.EnumDrillLinkAnswerType,$EH=mstrmojo.elementHelper;var HYPERLINK_ACTION=4;var REPORT_SCOPE="2";var DSSTYPE_DOC_DEFINITION=55,DSSTYPE_RPT_DEFINITION=3,DSSSUB_TYPE_RW=14081,DSSSUB_TYPE_REPORT_GRAPH=769;var EVENT_RUN_RW_DOCUMENT=2048001,EVENT_RUN_DOCUMENT=32001,EVENT_RUN_REPORT=4001;var VIEWMODE_GRID=1,VIEWMODE_GRAPH=2;function buildLinkXml(linkInfo,columnIndex){var xml,answers=linkInfo.ans;var fnAddXmlAttr=function(name,value){return" "+name+'="'+value+'"';},fnAddXmlAttrEncoded=function(name,value){return" "+name+'="'+$STR.encodeXMLAttribute(value)+'"';},fnAppendElementIdToXML=function(id){xml+="<e"+fnAddXmlAttrEncoded("ei",id)+fnAddXmlAttr("emt","1")+"/>";};xml="<hl"+fnAddXmlAttr("mid",mstrApp.getMsgID())+fnAddXmlAttr("srct",this.getExecutionScope())+fnAddXmlAttr("aopam",linkInfo.daMode)+">";if(answers!==null){xml+="<prms>";var geoAttribute=this.primaryModel.getRowTitles().getTitle(columnIndex),elementList=geoAttribute&&geoAttribute.title.es,selectedElementIds=[],i,j,answersLength=answers.length;$ARR.forEach(this.selectedGraphics,function(graphic){var attributes=graphic.attributes,geoIndices=attributes.geoIndices;if(geoIndices){$ARR.forEach(geoIndices,function(idx){selectedElementIds.push(elementList[idx].id);});}else{selectedElementIds.push(elementList[attributes.geoIndex].id);}});for(i=0;i<answersLength;i++){var answer=answers[i],pid=answer.pid,aty=answer.m,statValues=answer.values,statDisplayNames=answer.dispNames;xml+="<prm"+fnAddXmlAttr("id",pid)+fnAddXmlAttr("am",aty);if(answer.po&&answer.po.did){xml+=fnAddXmlAttr("orid",answer.po.did)+fnAddXmlAttr("ortp",answer.po.t);}xml+=">";switch(aty){case ENUM_DRILL_LINK_ANSWER_TYPE.DO_NOT_ANSWER:case ENUM_DRILL_LINK_ANSWER_TYPE.CLOSE:case ENUM_DRILL_LINK_ANSWER_TYPE.USE_DEFAULT_ANSWER:case ENUM_DRILL_LINK_ANSWER_TYPE.SAME_PROMPT:break;case ENUM_DRILL_LINK_ANSWER_TYPE.STATIC:if(statValues!==null){xml+='<pa ia="1"><es>';for(j=0;j<statValues.length;j++){xml+="<e"+fnAddXmlAttr("ei",statValues[j])+fnAddXmlAttrEncoded("disp_n",statDisplayNames[j])+fnAddXmlAttr("emt","1")+"/>";}xml+="</es></pa>";}break;case ENUM_DRILL_LINK_ANSWER_TYPE.DYNAMIC:case ENUM_DRILL_LINK_ANSWER_TYPE.DYNAMIC_OR_SAME_PROMPT:xml+='<pa ia="1">';xml+="<es "+fnAddXmlAttr("dispForms","")+">";$ARR.forEach(selectedElementIds,fnAppendElementIdToXML);xml+="</es></pa>";break;case ENUM_DRILL_LINK_ANSWER_TYPE.ALL_VALID_UNITS:xml+='<pa ia="1"><attGroups><attGroup>';xml+="<a"+fnAddXmlAttr("id",geoAttribute.getUnitId())+fnAddXmlAttrEncoded("n",geoAttribute.getName())+">";xml+="<es "+fnAddXmlAttr("dispForms","")+">";$ARR.forEach(selectedElementIds,fnAppendElementIdToXML);xml+="</es></a>";xml+="</attGroup></attGroups></pa>";break;case ENUM_DRILL_LINK_ANSWER_TYPE.CURRENT_UNIT:if(selectedElementIds&&selectedElementIds.length>0){xml+='<pa ia="1">';xml+="<a"+fnAddXmlAttr("id",geoAttribute.getUnitId())+fnAddXmlAttrEncoded("n",geoAttribute.getName())+"><es "+fnAddXmlAttr("dispForms",geoAttribute.getFormId())+"><e"+fnAddXmlAttrEncoded("ei",selectedElementIds[0])+fnAddXmlAttr("emt","1")+"/></es></a>";xml+="</pa>";}break;}xml+="</prm>";}xml+="</prms>";}xml+="</hl>";return xml;}mstrmojo.gmaps.layer._GraphicLayerDataHelper=mstrmojo.provide("mstrmojo.gmaps.layer._GraphicLayerDataHelper",{viewCache:null,getLayerModel:function getLayerModel(){return this.primaryModel;},getData:function getData(){return this.data;},getDropZones:function getDropZones(){return this.dropZones;},getDataRows:function getDataRows(){var data=this.getData();if(data&&data.gts){return data.gts.row;}},getDataCols:function getDataCols(){var data=this.getData();if(data&&data.gts){return data.gts.col;}},getDataRowHeaders:function getDataRowHeaders(){var data=this.getData(),ghs=data&&data.ghs;if(ghs&&ghs.rhs){return ghs.rhs.items;}},getDataColHeaders:function getDataColHeaders(){var data=this.getData(),ghs=data&&data.ghs;if(ghs&&ghs.chs){return ghs.chs.items;}},getDataColTitles:function getDataColTitles(){var model=this.getLayerModel();return model&&model.getColTitles();},getDataThresholds:function getDataThresholds(){var data=this.getData();return data&&data.gsi&&data.gsi.thresholds;},getElementValue:function getElementValue(row,col){var rows=this.getDataRows(),rowHeaders=this.getDataRowHeaders(),rowHeader=rowHeaders[row].items[col];if(rows&&rowHeader){return $MUTIL.trimString($STR.decodeHtmlString(rows[col].es[rowHeader.idx].n));}},getExecutionScope:function(){if($MUTIL.isExpress()){return REPORT_SCOPE;}return microstrategy.EXECUTION_SCOPE;},getMetricCount:function getMetricCount(){var data=this.getData(),gsi=data&&data.gsi;if(!!gsi&&!!gsi.mx){return gsi.mx.length;}},hasMetrics:function hasMetrics(){var count=this.getMetricCount();return !!count&&count>0;},showMetric:function showMetric(){var col=this.getDataCols();return col&&(col.length===1&&col[0].otp===-1);},retrieveDataRows:function retrieveDataRows(sliceInfo){var i,k,geoElementIndices,geoElementCount,longGeoElementIndices,pos,longPos,secondaryFieldValue,geoSfPos,geoElemIdx,longGeoElemIdx,elementDataRows,idString,rowHeader,cellHeader,longCellHeader,sfEleVal,dataRows=[],rowHeaders=this.getDataRowHeaders(),numRows=rowHeaders.length,generatedGeoElementIndices={};if(sliceInfo){geoElementIndices=sliceInfo.elementIndex;geoElementCount=geoElementIndices.length;longGeoElementIndices=sliceInfo.longElementIndex;pos=parseInt(sliceInfo.pos[0],10);longPos=parseInt(sliceInfo.pos[1],10);secondaryFieldValue=(typeof sliceInfo.sfv==="string")?sliceInfo.sfv.toLowerCase():sliceInfo.sfv;geoSfPos=this.geoSecondaryRolePosition;for(i=0;i<geoElementCount;i++){if(generatedGeoElementIndices.hasOwnProperty(geoElementIndices[i])){continue;}generatedGeoElementIndices[geoElementIndices[i]]=geoElementIndices[i];geoElemIdx=parseInt(geoElementIndices[i],10);longGeoElemIdx=parseInt(longGeoElementIndices[i],10);elementDataRows=[];idString=geoElemIdx+"#"+longGeoElemIdx;if(!this.viewCache){this.viewCache={};}if(this.viewCache[pos]===undefined||this.viewCache[pos]===null){this.viewCache[pos]={};}if(this.viewCache[pos]&&this.viewCache[pos][idString]){elementDataRows=this.viewCache[pos][idString];}else{for(k=0;k<numRows;k++){rowHeader=rowHeaders[k].items;cellHeader=rowHeader[pos];longCellHeader=rowHeader[longPos];if(cellHeader&&cellHeader.idx===geoElemIdx&&longCellHeader&&longCellHeader.idx===longGeoElemIdx){sfEleVal=this.getElementValue(k,geoSfPos);sfEleVal=(typeof sfEleVal==="string")?sfEleVal.toLowerCase():sfEleVal;if(secondaryFieldValue!==undefined&&secondaryFieldValue!==sfEleVal){continue;}elementDataRows.push(k);}}this.viewCache[pos][idString]=elementDataRows;}dataRows=dataRows.concat(elementDataRows);}}return dataRows;},getAttributeName:function(index){var attr,form,fn,an,gsiAttrs,data=this.getData(),disFtp=data.lnm,gtsAttrs=this.getDataRows()||[];attr=gtsAttrs[index];if(attr){if($MUTIL.isExpress()){return attr.n;}form=attr.fs&&attr.fs[0];fn=(form&&form.n)||"";if(disFtp===2){return fn;}gsiAttrs=(data.gsi.rows||[]).concat(data.gsi.cols||[]);$ARR.forEach(gsiAttrs,function(item){if(item.did===attr.id){an=item.n;return false;}});if(an===undefined){an=attr.dn||attr.n;}if(disFtp===1){return fn?an+" "+fn:an;}return an;}return"";},justMetricId:function justMetricId(id){if(!id){return ;}var extractedId=id,result;if(id.indexOf("CD:")===0){result=id.match(/(CD:=?)([0-9a-zA-Z]*)/);if(result){extractedId=result[2];}}else{if(id.indexOf("i")===0){result=id.match(/(i=?)([0-9a-zA-Z]*)(?=;)/);if(result){extractedId=result[2];}else{result=id.split(";");if(result&&result.length>0){extractedId=result[result.length-1];}}}}return extractedId;},getGraphicsDataRowIndices:function getGraphicsDataRowIndices(graphics){var dataRowIdxArr=[],me=this;if(!$ARR.isArray(graphics)||graphics.length<1){return dataRowIdxArr;}if(this.graphicType!==ENUM_GRAPHIC_TYPE.Area){$ARR.forEach(graphics,function(graphic){if(graphic){dataRowIdxArr=dataRowIdxArr.concat(graphic.getDataRowIndices());}});}else{$ARR.forEach(graphics,function(graphic){var attributes=graphic&&graphic.attributes;if(attributes){dataRowIdxArr=dataRowIdxArr.concat(me.retrieveDataRows({pos:attributes.columnIndices,elementIndex:[attributes.geoIndex],longElementIndex:[attributes.geoIndex],setViewDataFlag:false,applyControl:false,sfv:attributes.sfv}));}});}return dataRowIdxArr;},getThresholdInfo:function getThresholdInfo(rowIndex,metricIdx,dataModel){if(!this.applyThreshold||!this.primaryModel){return ;}var model=dataModel?dataModel:this.getLayerModel(),cell=model&&model.getMetricValue(rowIndex,metricIdx),data=cell&&cell.data||this.getData();if(!data||!cell){return ;}if(data.th&&data.fc){return this._getThresholdInfoFromWebJson(cell);}else{return this._getThresholdInfoFromServerJson(metricIdx,cell);}},_getThresholdInfoFromWebJson:function _getThresholdInfoFromWebJson(cell){if(!cell||!cell.value){return ;}var thresholdInfo={},type=thresholdInfo.type=this.getThresholdType(cell);switch(type){case ENUM_THRESHOLD_TYPE.Image:this.ImageThreshold=true;thresholdInfo.url=cell.getThresholdValue();break;case ENUM_THRESHOLD_TYPE.Url:thresholdInfo.url=cell.getThresholdValue();break;case ENUM_THRESHOLD_TYPE.Text:case ENUM_THRESHOLD_TYPE.QuickSymbol:thresholdInfo.colorStr=cell.getThresholdValue();thresholdInfo.text=this.getQuickSymbol(cell.getValue());break;default:thresholdInfo.colorStr=cell.getFillColor();break;}return thresholdInfo;},_getThresholdInfoFromServerJson:function _getThresholdInfoFromServerJson(metricIdx,cell){if(!cell){return ;}var cellValue=cell.value,thresholds=this.getDataThresholds(),metricId=this.findMetricId(metricIdx),result,colorArray,threshold,type;if(!thresholds||!cellValue||!cellValue.hasOwnProperty("ti")||!$MUTIL.checkDefined(metricId)){return ;}colorArray=thresholds[metricId];if(!colorArray){return ;}threshold=colorArray[cellValue.ti];if(!threshold){return ;}result={};type=cell.getThresholdType();switch(type){case ENUM_THRESHOLD_TYPE.Image:this.ImageThreshold=true;result.url=threshold.rtxt;break;case ENUM_THRESHOLD_TYPE.Url:result.url=threshold.rtxt;break;case ENUM_THRESHOLD_TYPE.Text:case ENUM_THRESHOLD_TYPE.QuickSymbol:if(threshold.fmt&&threshold.fmt.fc){result.colorStr=threshold.fmt.fc;}result.text=this.getQuickSymbol(cell.value.v);break;default:if(threshold.fmt&&threshold.fmt.bc){result.colorStr=threshold.fmt.bc;}break;}result.type=this.getThresholdType(cell,threshold);return result;},getThresholdType:function getThresholdType(cell,threshold){if(!cell){return ;}var rawType=cell.getThresholdType(),type;if(rawType===ENUM_THRESHOLD_TYPE.Image||rawType===ENUM_THRESHOLD_TYPE.Url){type=ENUM_THRESHOLD_TYPE.Url;}else{if(rawType===ENUM_THRESHOLD_TYPE.Text||rawType===ENUM_THRESHOLD_TYPE.QuickSymbol){type=ENUM_THRESHOLD_TYPE.Text;}else{if(threshold&&threshold.fmt&&threshold.fmt.bc){type=ENUM_THRESHOLD_TYPE.Default;}else{type=rawType;}}}return type;},getQuickSymbol:function getQuickSymbol(text){var result;switch(text){case"&#9679;":case'<font face="Wingdings">\u006c</font>':result="\u25CF";break;case"&#9632;":case'<font face="Wingdings">\u006e</font>':result="\u25a0";break;case"&#9830;":case'<font face="Wingdings">\u0074</font>':result="\u2666";break;case"&#9670;":case'<font face="Wingdings">\u0075</font>':result="\u25C6";break;case"&#10070;":case'<font face="Wingdings">\u0053</font>':result="\u2756";break;case"&#9784;":case'<font face="Wingdings">\u005D</font>':result="\u2638";break;case"&#10047;":case'<font face="Wingdings">\u007C</font>':result="\u273F";break;case"&#8984;":case'<font face="Wingdings">\u007a</font>':result="\u2318";break;case"&#10003;":case'<font face="Wingdings">\u0009</font>':result="\u2713";break;case"&#10007;":case'<font face="Wingdings">\u000a</font>':result="\u2717";break;case"&#8680;":case'<font face="Wingdings">\u00e8</font>':result="\u21E8";break;case"&#8679;":case'<font face="Wingdings">\u00e9</font>':result="\u21E7";break;case"&#8681;":case'<font face="Wingdings">\u00ea</font>':result="\u21E9";break;default:result=text;}return decodeURI(result);},findMetricId:function findMetricId(metricIdx){var colTitles=this.getDataColTitles(),colCount=colTitles&&colTitles.size(),col,metric,metricId,es,i;if(!colCount){return ;}for(i=0;i<colCount;i++){col=colTitles.getTitle(i);if(col&&col.getUnitDssType()===-1){es=col.getHeaderValues();metric=es&&es[metricIdx];if(!!metric){metricId=this.justMetricId(metric.id);}break;}}return metricId;},findAttrIdx:function findAttrIdx(attrId){var rows=this.getDataRows();return $ARR.find($ARR.ensureArray(rows),"id",attrId);},findAttrIdxs:function findAttrIdxs(attrId){var rows=$ARR.ensureArray(this.getDataRows()),len=rows.length,idxs=[],i,row;for(i=0;i<len;i++){row=rows[i];if(row&&row.id===attrId){idxs.push(i);}}return idxs;},findMetricIdx:function findMetricIdx(cols,selectedMetricId){if(!$ARR.isArray(cols)||!selectedMetricId){return -1;}var col,es,i,il,j,jl,metricIdx;for(i=0,il=cols.length;i<il;i++){col=cols[i];if(!col||col.otp!==-1){continue;}es=col.es;jl=es&&es.length;if(!$MUTIL.checkDefined(es)||!$MUTIL.checkDefined(jl)){continue;}for(j=0;j<jl;j++){if(selectedMetricId===this.justMetricId(es[j].id)){metricIdx=j;break;}}}return metricIdx;},stripNumberFormat:function stripNumberFormat(numString){var mapConfig=this.map&&this.map.getMapConfig(),commonConfig=mapConfig&&mapConfig.common,newString=numString.replace(commonConfig.currencySymbol,""),oldString,resultString;do{oldString=newString;newString=newString.replace(commonConfig.groupingSeparator,"");}while(oldString!=newString);resultString=newString.replace(commonConfig.decimalSeparator,".");return resultString;},isDrillable:function isDrillable(){if(this.data.eg!==undefined||this.primaryModel.getTotalRows()===0){return false;}var columnIndex=this.getGeoColumnIndex(),geoAttribute=this.primaryModel.getRowTitles().getTitle(columnIndex),actionType=geoAttribute&&geoAttribute.getActionType();if(actionType===undefined||isNaN(actionType)){return false;}return(actionType&HYPERLINK_ACTION)>0;},performDrill:function performDrill(columnIndex){if(!this.isDrillable()){return ;}var geoAttribute=this.primaryModel.getRowTitles().getTitle(columnIndex),linkDetails=geoAttribute.getLinkMap()[0],linkArray=linkDetails.links,linkIndex=linkDetails.di,linkInfo=linkArray[linkIndex];if(linkInfo){this[!linkInfo.url?"execDynamiclLink":"execUrlLink"](linkDetails,linkInfo,columnIndex);}},execDynamiclLink:function execDynamiclLink(linkDetails,linkInfo,columnIndex){var xml=buildLinkXml.call(this,linkInfo,columnIndex),isOpenInNewWindow=linkDetails.onw;if($MUTIL.isExpress()){this.execDynamiclLinkOIVM(linkInfo,xml,isOpenInNewWindow);}else{this.execDynamiclLinkIM(linkInfo,xml,isOpenInNewWindow);}},execDynamiclLinkOIVM:function execDynamiclLinkOIVM(linkInfo,answerXml,isOpenInNewWindow){var target=linkInfo.target,tp=target&&target.t,params,oid=target.did;switch(parseInt(tp,10)){case DSSTYPE_DOC_DEFINITION:if(parseInt(target.st,10)===DSSSUB_TYPE_RW){params={evt:EVENT_RUN_RW_DOCUMENT,objectID:oid};}else{params={evt:EVENT_RUN_DOCUMENT,documentID:oid};}break;case DSSTYPE_RPT_DEFINITION:params={evt:EVENT_RUN_REPORT,reportID:oid,reportViewMode:target.st===DSSSUB_TYPE_REPORT_GRAPH?VIEWMODE_GRAPH:VIEWMODE_GRID};}if(params){if(answerXml){params.linkAnswers=answerXml;}this.linkDrill(params,linkInfo,isOpenInNewWindow);}},linkDrill:function linkDrill(params,linkInfo,isOpenInNewWindow){mstrmojo.form.send(params,null,"POST",isOpenInNewWindow?"_blank":null);},execDynamiclLinkIM:function execDynamiclLinkIM(linkInfo,xml,isOpenInNewWindow){try{var argNames=null,argValues=[linkInfo.target.did],event=null;if(linkInfo.target.t===DSSTYPE_RPT_DEFINITION){event=mstrUpdateManager.RUN_REPORT;argNames=["1001"];if(xml){argNames.push("4222");argValues.push(xml);}argNames.push("4115");argValues.push(microstrategy.getReportViewMode(linkInfo.target.st));}else{if(linkInfo.target.t===DSSTYPE_DOC_DEFINITION){if(linkInfo.target.st===DSSSUB_TYPE_RW){event=mstrUpdateManager.RUN_RW_DOCUMENT;argNames=["2048001"];if(xml){argNames.push("2048140");argValues.push(xml);}}else{event=mstrUpdateManager.RUN_DOCUMENT;argNames=["1001"];if(xml){argNames.push("32351");argValues.push(xml);}}}}var updateManager=microstrategy.updateManager,oldUseIframeSetting=updateManager.useIframe,oldNWSetting=updateManager.newWindow;updateManager.useIframe=false;updateManager.newWindow=isOpenInNewWindow;if(updateManager.hasChangesToSubmit()){updateManager.add([updateManager.createActionObject(null,mstrUpdateManager.APPLY_CHANGES,mstrUpdateManager.applyChangesBeanPath,[],[],[])]);}updateManager.add([updateManager.createActionObject(this.elem,event,"",argNames,argValues,[])]);updateManager.flushAndSubmitChanges();updateManager.acknowledgeRequest();updateManager.newWindow=oldNWSetting;updateManager.useIframe=oldUseIframeSetting;}catch(err){microstrategy.errors.log(err);}},execUrlLink:function execUrlLink(linkDetails,linkInfo){var oForm=mstrmojo.form.createDynamicForm(linkInfo.url);if(linkDetails.onw){oForm.target="_blank";}oForm.submit();},getElementIdWithoutAttributeID:function getElementIdWithoutAttributeID(elementID){var i,pres=$EH.getIdPresentation(elementID),newElementID="",pos=0;switch(pres){case"terse":case"terseLong":for(i=0;i<elementID.length;i++){if(elementID.charAt(i)===";"){pos++;}if(pos===1){continue;}newElementID+=elementID.charAt(i);}return newElementID;case"old":for(i=0;i<elementID.length;i++){if(elementID.charAt(i)===":"){pos++;continue;}if(pos===0){continue;}newElementID+=elementID.charAt(i);}return newElementID;case"oldLong":for(i=0;i<elementID.length;i++){if(elementID.charAt(i)===":"){pos++;}if(pos===1){continue;}newElementID+=elementID.charAt(i);}return newElementID;}return elementID;},isGridDataEmpty:function isGridDataEmpty(){return !this.data||this.data.eg!==undefined||!this.map||this.map.excludeData;}});}());