(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.Container","mstrmojo.Button","mstrmojo.vi._MonitorsAppState");var $ARR=mstrmojo.array;var MODE_OFF=1,MODE_CANCEL=2,MODE_PRE_SELECT=4,MODE_SELECT=8,MODE_SELECTION_MADE=16,MODE_SELECTION_COMPETE=32;function getBtnConfig(title,mode,isHot,alias,visibleFlags,enabledFlags){return mstrmojo.Button.newWebButton(title,function(evt){this.parent.set("_targetMode",mode);evt.cancel();},isHot,{alias:alias,flgVis:visibleFlags,flgEnabled:enabledFlags||undefined});}mstrmojo.vi.ui.TargetSelector=mstrmojo.declare(mstrmojo.Container,[mstrmojo.vi._MonitorsAppState],{scriptClass:"mstrmojo.vi.ui.TargetSelector",markupString:'<div id="{@id}" class="mstrmojo-TargetSelector {@cssClass}" style="{@cssText}"><div></div></div>',markupSlots:{containerNode:function(){return this.domNode.firstChild;}},init:function init(props){this._super(props);if(!this.hostId){throw new Error("You must pass the hostId when instantiating mstrmojo.vi.ui.TargetSelector.");}if(!this.srcId){this.srcId=this.hostId;}this.hostBox=mstrmojo.all[this.hostId];this.srcBox=mstrmojo.all[this.srcId];this._targetMode=MODE_OFF;},onAppStateChange:function onAppStateChange(evt){var appState=mstrmojo.vi.VisualInsightApp.APP_STATES,selectionMode=appState.SELECTOR_TARGETING,selectBtn=this.btnSelect;if(evt.valueWas&selectionMode||evt.value&selectionMode){selectBtn.set("enabled",!mstrApp.isAppStateSelection());}},hostId:null,srcId:null,markupMethods:{onvisibleChange:mstrmojo.Widget.visibleMarkupMethod,onhostIdChange:function(){this.hostBox=mstrmojo.all[this.hostId];},onsrcIdChange:function(){this.srcBox=mstrmojo.all[this.srcId];},on_targetModeChange:function(){var mode=this._targetMode,hostBox=this.hostBox,srcBox=this.srcBox,id=this.id,docModel=srcBox.model,viPanel=docModel.getVizContentPanel(),isComplete=mode===MODE_SELECTION_COMPETE,onComplete=function(){this.preChangeTargetSelectionMode(false,docModel);viPanel.exitTargetSelectionMode(isComplete,this.restoreChildren.bind(this));}.bind(this);this.children.forEach(function(btn){btn.set("visible",(btn.flgVis&mode)>0);btn.set("enabled",(!btn.flgEnabled||(btn.flgEnabled&mode)>0));btn.refresh();});this.set("visible",mode!==MODE_OFF);if(isComplete||mode===MODE_CANCEL){onComplete();if(!isComplete){this.set("_targetMode",this._cancelMode);this.cancel(hostBox);}this.exitTargetSelectionMode(hostBox);}else{if(mode===MODE_SELECT){this.preChangeTargetSelectionMode(true,docModel);viPanel.enterTargetSelectionMode(function(keys,isComplete){var selectMode=isComplete?MODE_OFF:MODE_SELECT;if(!isComplete&&hostBox.isSelectionDirty(keys,isComplete)){selectMode=MODE_SELECTION_MADE;}mstrmojo.all[id].set("_targetMode",selectMode);if(isComplete){hostBox.setTargets(keys);}},this.srcId,hostBox.getTargetKeys(),this.enterTargetSelectionMode.bind(this),onComplete);}}var APP_STATES=mstrmojo.vi.VisualInsightApp.APP_STATES,isAppPauseMode=mstrApp.isAppStatePause&&mstrApp.isAppStatePause();mstrApp.set("appState",mode===MODE_SELECT||mode===MODE_SELECTION_MADE?(isAppPauseMode?APP_STATES.SELECTOR_TARGETING|APP_STATES.PAUSE:APP_STATES.SELECTOR_TARGETING):(isAppPauseMode?APP_STATES.PAUSE:APP_STATES.DEFAULT));}},ignoreLayout:true,setSourceByKey:function(key){var viPanel=this.srcBox.model.getVizContentPanel(),children=(viPanel&&viPanel.children)||[],idx=$ARR.find(children,"k",key),source=(idx>-1)?children[idx]:null;if(source){this.set("srcId",source.id);}},preChangeTargetSelectionMode:function preChangeTargetSelectionMode(enter,docModel){var panelSelector=docModel.getVizContentPanel().parent.selector,docView=docModel.controller.view,layoutSelector=docView.layoutViewer.docLayout.selector;layoutSelector.set("isMasked",enter);panelSelector.set("isMasked",enter);},enterTargetSelectionMode:function enterTargetSelectionMode(child){var srcId=this.srcId,srcDefn=mstrmojo.all[srcId].defn;child.setMaskClass(srcId);child.set("enabled",child.validateTarget&&child.validateTarget(srcDefn));},exitTargetSelectionMode:function exitTargetSelectionMode(hostBox){hostBox.close();},restoreChildren:function restoreChildren(child){child.set("enabled",true);child.clearMaskClass();},cancel:function cancel(hostBox){if(hostBox){hostBox.cancel();}},enterPreSelectMode:function enterPreSelectMode(){this._cancelMode=MODE_PRE_SELECT;this.set("_targetMode",MODE_PRE_SELECT);},enterSelectMode:function enterSelectMode(){this._cancelMode=MODE_OFF;this.set("_targetMode",MODE_SELECT);},enterOffMode:function enterOffMode(){this._cancelMode=MODE_OFF;this.set("_targetMode",MODE_OFF);},children:[getBtnConfig(mstrmojo.desc(4799,"Select Target"),MODE_SELECT,true,"btnSelect",MODE_PRE_SELECT),getBtnConfig(mstrmojo.desc(221,"Cancel"),MODE_CANCEL,false,"btnCancel",MODE_SELECT+MODE_SELECTION_MADE),getBtnConfig(mstrmojo.desc(134,"Apply"),MODE_SELECTION_COMPETE,true,"btnApply",MODE_SELECT+MODE_SELECTION_MADE,MODE_SELECTION_MADE)]});}());