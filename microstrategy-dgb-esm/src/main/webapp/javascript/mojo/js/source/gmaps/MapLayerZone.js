(function(){mstrmojo.requiresCls("mstrmojo.dom","mstrmojo.css","mstrmojo.Widget","mstrmojo.Container","mstrmojo.ListBase","mstrmojo._IsList","mstrmojo.gmaps.MapUtils","mstrmojo.gmaps.MapEnums","mstrmojo.ui.menus.MenuConfig","mstrmojo.ui.menus.EditorConfig","mstrmojo.ui.menus._HasMenuPopup","mstrmojo.vi.ui._IsDropTarget","mstrmojo.vi.ui.DatasetUnitMenuUtils","mstrmojo.vi.models.EnumDragSources","mstrmojo.vi.ui.VisualizationEditorUnitList");var $MOJO=mstrmojo,$WIDGET=$MOJO.Widget,$DOM=$MOJO.dom,$CSS=$MOJO.css,$ARR=$MOJO.array,$HASH=$MOJO.hash,emptyFn=$MOJO.emptyFn,$GMAPS=$MOJO.gmaps,$MUTIL=$GMAPS.MapUtils,$EnumDragSources=$MOJO.vi.models.EnumDragSources,$EnumPropertyType=$GMAPS.EnumPropertyType,$DU=$MOJO.vi.ui.DatasetUnitMenuUtils,ENUM_TARGET=mstrmojo.vi.models.DropZonesModel.ENUM_TARGET_POSITION,TARGET_ABOVE=ENUM_TARGET.ABOVE,TARGET_MIDDLE=ENUM_TARGET.ON,TARGET_BELOW=ENUM_TARGET.BELOW,VI_EDITOR_UNIT_LIST_CLS="mstrmojo-VIVizEditor-Menu";var TARGET_BORDERS={};TARGET_BORDERS[TARGET_ABOVE]="Top";TARGET_BORDERS[TARGET_MIDDLE]="";TARGET_BORDERS[TARGET_BELOW]="Bottom";var highlightTargets=[];var $MULTIPLE_LAYER_DND_ENABLED=false;function getLayerCapsuleContainerCfg(){return{scriptClass:"mstrmojo.gmaps.MapLayerItemContainer",items:[],alias:"layerList"};}function getAddBtnCfg(){return{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(531,"Add"),alias:"addBtn",cssClass:"link-btn",onclick:function(){this.parent.onaddLayer();}};}function addRenameMenuItem(cfg,selectedItem,items,editableLabelNode){var me=this;cfg.addMenuItem(mstrmojo.desc(1388,"Rename"),"xt",function(){if(!editableLabelNode){return ;}$DU.renameItem(editableLabelNode,selectedItem,function(renameWidget){var newName=renameWidget.text.trim(),fnRename=function(){var parent=me.parent;if(parent){parent.onrenameLayer(selectedItem,newName);}},fnRevert=function(){renameWidget.set("text",selectedItem.n);},hasConflict=items.some(function(u){return u.n===newName;});if(hasConflict){mstrmojo.warn(mstrmojo.desc(11664,'"##" already exists in the map. Do you want to proceed?').replace("##",newName),{confirmBtn:{fn:fnRename},cancelBtn:{fn:fnRevert}});}else{fnRename();}},{allowEmptyText:false,cssClass:editableLabelNode.className});});}function addRemoveMenuItem(cfg,items){var me=this;cfg.addMenuItem(mstrmojo.desc(190,"Remove"),"xt",function(){me.onremoveItems(items);});}function openMenu(selectedItems,el,position){var menuCfg=new mstrmojo.ui.menus.MenuConfig({menuCssClass:VI_EDITOR_UNIT_LIST_CLS,hostId:this.id,position:position,hostElement:this.itemsContainerNode,isHostedWithin:false}),items=this.items,editableLabelNode=this.getLabelNode(el);if(selectedItems&&selectedItems.length===1){addRenameMenuItem.call(this,menuCfg,selectedItems[0],items,editableLabelNode);}if(items&&items.length>1){addRemoveMenuItem.call(this,menuCfg,selectedItems);}this.openPopup(menuCfg.newInstance());}function highlightItem(itemNode,isHighlight){if(isHighlight){$CSS.addClass(itemNode,"select");if(itemNode.children&&itemNode.children[0]){$CSS.addClass(itemNode.children[0],"select");}}else{$CSS.removeClass(itemNode,"select");if(itemNode.children&&itemNode.children[0]){$CSS.removeClass(itemNode.children[0],"select");}}}mstrmojo.gmaps.MapLayerItemContainer=mstrmojo.declare(mstrmojo.vi.ui.VisualizationEditorUnitList,null,{scriptClass:"mstrmojo.gmaps.MapLayerItemContainer",cssClass:"MapLayerItemContainer",icnCss:"MapLayerItemContainer-container",multiSelect:$MULTIPLE_LAYER_DND_ENABLED,zoomLevelSub:null,getItemMarkup:function getItemMarkup(item){var markup=this._super(item);markup=markup.replace("zone","{@zoneCls}");return markup;},getItemProps:function(item,idx){var props=this._super(item,idx);props.zoneCls="zone eye";return props;},enableSetLayerVisibility:function(){var me=this,mapViewer=$HASH.walk("parent.vis.mapViewer",this);$ARR.forEach(this.items,function(item){me.refreshNodeStatus(item.k);});var baseLayer=mapViewer&&mapViewer.baseLayer;if(baseLayer){me.zoomLevelSub=baseLayer.attachEventListener("zoomLevelChanged",me.id,function(){$ARR.forEach(me.items,function(item){me.refreshNodeStatus(item.k);});});}},postBuildRendering:function(){var parent=this.parent,layerMapping=$HASH.walk("parent.vis.mapViewer.graphicLayerMapping",this);if(parent){this.zonesModel=parent.zonesModel;this.selectedIndices=parent.selectedIndices;this._shiftStartIndex=parent._shiftStartIndex;this.updateSelectedItems();this.showContextMenu();}if(layerMapping&&Object.keys(layerMapping).length>0){this.enableSetLayerVisibility();}},updateSelectedItems:function updateSelectedItems(forceSelect){var selectedIndices=this.selectedIndices,itemNodes=this.itemsContainerNode.children,selectedItems=this.getSelectedItems(),parent=this.parent,selectedItem,i;if(!parent||!selectedIndices||Object.keys(selectedIndices).length<1||!itemNodes||itemNodes.length<1||!$ARR.isArray(selectedItems)){return ;}for(i in itemNodes){highlightItem(itemNodes[i],!!selectedIndices[i]);}this.cacheSelectedInfo();if(!!forceSelect){selectedItem=this.selectedItem||selectedItems[0];parent.onselectLayer(selectedItem);}},getItemDisplayName:function(item){return item.n;},onItemContextMenu:function onItemContextMenu(item,evt){var parent=this.parent,vis=parent&&parent.vis,editingLayerKey=vis&&vis.getEditingGridKey();if(item&&(item.k===editingLayerKey)){this._super(item,evt);}else{if(item&&vis){vis.layerZoneCxtMnInfo={item:item,source:parent.source,mousePos:$DOM.getMousePosition(evt.e,evt.hWin)};this.closePopup();this.handleSelect(evt);}}},showContextMenu:function showContextMenu(){var parent=this.parent,vis=parent&&parent.vis,zoneCtxMnInfo=vis&&vis.layerZoneCxtMnInfo,layerItem,target;if(zoneCtxMnInfo&&(zoneCtxMnInfo.source===parent.source)){layerItem=zoneCtxMnInfo.item;target=this.domNode.querySelector('div.item.unit[idx="'+layerItem._renderIdx+'"]');this.showItemMenu(layerItem,target,zoneCtxMnInfo.mousePos);delete vis.layerZoneCxtMnInfo;}},showItemMenu:function showItemMenu(item,el,position){openMenu.call(this,[item],el,position);},showMultiSelectionMenu:function showMultiSelectionMenu(items,el,position){openMenu.call(this,items,el,position);},isInEditingMode:function isInEditingMode(){var nodes=this.domNode.querySelectorAll("div.mstrmojo-EditableLabel.editable");if(nodes.length>0){nodes[0].blur();return true;}return false;},isLayerVisible:function(layerKey){var mapViewer=this.parent.vis.mapViewer,graphicLayer=mapViewer.getGraphicLayer(layerKey);return graphicLayer&&graphicLayer.isVisible();},canShowLayer:function(layerKey){var mapViewer=this.parent.vis.mapViewer,graphicLayer=mapViewer.getGraphicLayer(layerKey);return graphicLayer&&graphicLayer.isLayerInZoomRange();},refreshNodeStatus:function refreshNodeStatus(layerKey){var showCls="state-show",hideCls="state-hide",invisibleCls="state-invisible",isVisible=this.isLayerVisible(layerKey),isZoomedThrough=this.canShowLayer(layerKey),display=isVisible&&isZoomedThrough,eye,me=this;$ARR.forEach(this.items,function(item){if(item.k==layerKey){var itemNode=me._getItemNode(item._renderIdx);eye=me.getZoneNode(itemNode);}});if(display){$CSS.removeClass(eye,hideCls);$CSS.removeClass(eye,invisibleCls);$CSS.addClass(eye,showCls);}else{$CSS.removeClass(eye,showCls);$CSS.addClass(eye,hideCls);$CSS.toggleClass(eye,invisibleCls,!isZoomedThrough);}},onclick:function onclick(evt){if(this.handleSetLayerVisibility(evt)){return ;}this.handleSelect(evt);},handleSetLayerVisibility:function handleSetLayerVisibility(evt){var target=evt.getTarget(),name=target.className;if(name.indexOf("eye")!==-1){if(name.indexOf("state-invisible")===-1){var item=this.getItemFromTarget(target),layerKey=item.k;if(this.canShowLayer(layerKey)){var vis=this.parent&&this.parent.vis,isLayerVisible=this.isLayerVisible(layerKey);isLayerVisible=!isLayerVisible;if(vis){var value=isLayerVisible?"0":"1";vis.writeProperties($EnumPropertyType.isHidden,value,layerKey);}}}return true;}return false;},handleSelect:function handleSelect(evt){try{var target=evt.getTarget(),name=target.className,selectedIndicesCache={};if(name.indexOf("editable")!==-1){return ;}if(this.isInEditingMode()){return ;}$HASH.copy(this.selectedIndices,selectedIndicesCache);var item=this.getItemFromTarget(target);if(item){evt.cancel();this.doItemSelect(item,evt||{});}if(this.selectedIndices&&Object.keys(this.selectedIndices).length<1){this.selectedIndices=selectedIndicesCache;}else{this.updateSelectedItems(true);}}catch(ex){mstrApp.onerror(ex);}},cacheSelectedInfo:function cacheSelectedInfo(){var parent=this.parent,vis=parent&&parent.vis;if(vis){vis.layerZoneCacheInfo={selectedIndices:this.selectedIndices,_shiftStartIndex:this._shiftStartIndex};}},onmouseover:emptyFn,onmouseout:emptyFn,onremoveItems:function onremoveItems(items){var parent=this.parent;if(parent){parent.onremoveLayers(items);}},onclearSelections:function onclearSelections(){try{var itemList=this.itemsContainerNode.childNodes,className,i,il;for(i=0,il=itemList.length;i<il;i++){className=itemList[i].children[0].className;itemList[i].children[0].className=className.replace(/(?:^|\s)select(?!\S)/g,"");}}catch(ex){mstrApp.onerror(ex);}},getDragData:function getDragData(context){var info=this._super(context),me=this;info.src=$EnumDragSources.VIZ_LAYER;info.onRemove=function(items){me.onremoveItems(items);};return info;},ondragover:function ondragover(context){var me=this,target=context.tgt,tgtNode=me.getItemNodeFromTarget(target.node)||target.node,tgtData=context.tgtData,existingTgtNode=tgtData&&tgtData.node,dropPos,targetEdge,dragData,dropInfo,src,avatarCssClass;if(!tgtData||existingTgtNode!==tgtNode){tgtData=context.tgtData={item:me.items[parseInt(tgtNode.getAttribute("idx"),10)],node:tgtNode,pos:$DOM.position(tgtNode,true)};if(existingTgtNode){this.clearBorderClasses(existingTgtNode);}}this.clearBorderClasses(tgtNode);dropPos=this.getTargetEdgeAndIndex(tgtData.pos,target.e,context,tgtNode);targetEdge=dropPos&&dropPos.edge;dragData=this.getContextDragData(context);dropInfo=dropPos&&$HASH.copy(dropPos,this.getAllowDropInfo(dragData.items,dropPos.idx,dropPos.edge));if(dropInfo&&dropInfo.allowedItems.length){if(dragData.setAvatarClass){src=dragData.src;avatarCssClass="";if(src===$EnumDragSources.VIZ_LAYER&&(targetEdge===TARGET_ABOVE||targetEdge===TARGET_BELOW)){avatarCssClass="move";$CSS.addClass(tgtNode,"dragIn"+TARGET_BORDERS[targetEdge]);highlightTargets.push(tgtNode);}dragData.setAvatarClass(avatarCssClass);}}else{if(dragData.setInvalidAvatarClass){dragData.setInvalidAvatarClass();}}},ondrop:function ondrop(context){if(!context||!context.tgtData){return ;}var target=context.tgt,dragData=context.getCtxtDragData(),dropPos=this.getTargetEdgeAndIndex(context.tgtData.pos,target.e,context,this.getItemNodeFromTarget(target.node)||target.node),targetEdge=dropPos&&dropPos.edge,dropInfo=dropPos&&$HASH.copy(dropPos,this.getAllowDropInfo(dragData.items,dropPos.idx,targetEdge)),parent=this.parent,items=dropInfo&&dropInfo.allowedItems,toIdx;this._super(context);if(items&&items.length>0){toIdx=(targetEdge===TARGET_BELOW)?dropPos.idx+1:dropPos.idx;this.updateSelectedItems();if(parent){parent.onLayerDropped($ARR.map(items,function(item){return item&&item._renderIdx;}),toIdx);}}},getAllowDropInfo:function getAllowDropInfo(dragItems,idx,edge){return{allowedItems:dragItems.concat(),removeReplaced:edge===ENUM_TARGET.ON&&$ARR.find(dragItems,"k",this.items[idx].k)===-1};},isDragValid:function isDragValid(context){var e=context.src.e;return(!(e.ctrlKey||e.shiftKey||e.metaKey)||this._super(context)||false);},createAvatar:function createAvatar(srcNode,context){var avatar=document.createElement("div"),ctxtDragData=context.getCtxtDragData(),items=ctxtDragData.items,avatarMarkupArr=['<div class="',srcNode.parentNode.className,'">'],me=this;avatar.className=mstrApp.getThemeClassName();items.forEach(function(item){var itemName=me.getItemDisplayName(item),itemCSS="MapLayerZoneItem item unit isAvatar";avatarMarkupArr.push('<div class="'+itemCSS+'"><div class="outer-wrap"><div class="inner-wrap"><span class="txt">'+itemName+'</span><div class="icon"></div></div></div></div>');});avatarMarkupArr.push("</div>");avatar.innerHTML=avatarMarkupArr.join("");return avatar;},allowDrop:function allowDrop(context){var dragData=context.getCtxtDragData();return dragData&&(dragData.src===$EnumDragSources.VIZ_LAYER);},getDropAvatarIcon:function getDropAvatarIcon(){return"pivot";},destroy:function destroy(){var baseLayer=$HASH.walk("parent.vis.mapViewer.baseLayer",this),zoomLevelSub=this.zoomLevelSub;if(baseLayer&&zoomLevelSub){baseLayer.detachEventListener(this.zoomLevelSub);}delete this.zoomLevelSub;this._super();}});mstrmojo.gmaps.MapLayerZone=mstrmojo.declare(mstrmojo.Container,[mstrmojo.ui.menus._HasMenuPopup],{scriptClass:"mstrmojo.gmaps.MapLayerZone",markupString:'<div id="{@id}" class="mstrmojo-ui-MapLayerZone {@cssClass}" style="{@cssText}"></div>',markupSlots:{containerNode:function(){return this.domNode;}},markupMethods:{onvisibleChange:$WIDGET.visibleMarkupMethod,onenabledChange:mstrmojo.Container.enabledMarkupMethod,onheightChange:$WIDGET.heightMarkupMethod,onwidthChange:$WIDGET.widthMarkupMethod},ignoreLayout:false,items:null,shouldPropagateEnabled:true,selectedItemIdx:null,selectedIndices:null,vis:null,source:undefined,zonesModel:null,children:[getLayerCapsuleContainerCfg(),getAddBtnCfg()],init:function init(props){this._super(props);this.items=this.items||[];var vis=this.vis;if(vis){this.zonesModel=vis.zonesModel;this._loadSelectionInfo(vis.layerZoneCacheInfo);}this.onitemsChange();},_loadSelectionInfo:function _loadSelectionInfo(layerZoneCacheInfo){var selectedItemIdx=this.selectedItemIdx,selectedIndices,_shiftStartIndex;if($MULTIPLE_LAYER_DND_ENABLED){$HASH.copy(layerZoneCacheInfo,this);selectedIndices=this.selectedIndices=this.selectedIndices||{};_shiftStartIndex=this._shiftStartIndex;if(!$MUTIL.checkVal(_shiftStartIndex)||_shiftStartIndex===-1){this._shiftStartIndex=parseInt(selectedItemIdx);}}else{selectedIndices=this.selectedIndices={};}selectedIndices[selectedItemIdx]=true;},onitemsChange:function onitemsChange(){this.layerList.set("items",this.items);},getSelectedItem:function getSelectedItem(){return this.layerList.selectedItem;},selectItemByField:function selectItemByField(fieldName,fieldValue){this.layerList.singleSelect($ARR.find(this.layerList.items,fieldName,fieldValue));},onselectLayer:function onselectLayer(layerItem){var vis=this.vis;if(vis&&layerItem&&layerItem.k){vis.writeProperties($EnumPropertyType.editingLayerIdx,layerItem._renderIdx);if(vis.excludeData){vis.refresh();}}},onaddLayer:function onaddLayer(){var vis=this.vis;if(vis){vis.addMapLayer();}},onremoveLayers:function onremoveLayers(items){var vis=this.vis;if(vis){vis.removeMapLayers($ARR.map($ARR.ensureArray(items),function(item){return item&&item.k;}));}},onLayerDropped:function onLayerDropped(fromIdxArr,toIdx){var vis=this.vis;if(vis){vis.layerDroppedCallback(fromIdxArr,toIdx);}},onrenameLayer:function onrenameLayer(item,newName){var vis=this.vis;if(vis&&item&&item.k){vis.renameGraphicLayerCallback(item.k,newName);}},destroy:function destroy(){delete this.vis;this._super();}});}());