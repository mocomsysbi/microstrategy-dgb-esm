(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.hash","mstrmojo.vi.ui.rw._HasVisSelections");mstrmojo.requiresClsP("mstrmojo.vi.ui.rw","_HasVisSelections","SelectionType");var $MOJO=mstrmojo,$ARRAY=$MOJO.array,$HASH=$MOJO.hash;var SELECTOR_ACTION=2;function getAttIndexFromId(attId){var attIndex=-1;var attrs=this.modelData.gts.row||[],len=attrs.length,i;for(i=0;i<len;i++){if(attrs[i].id===attId){attIndex=i;}}return attIndex;}mstrmojo.heatmap.vi._SupportHeatmapBrushesAndHighlights=mstrmojo.provide("mstrmojo.heatmap.vi._SupportHeatmapBrushesAndHighlights",{_mixinName:"mstrmojo.heatmap.vi._SupportHeatmapBrushesAndHighlights",prepareSelectedNodesInfo:function(contextMenu){if(contextMenu==true){this.clearCxtMnuSelection();}else{this.clearSelections();}var me=this,ar=this.attSpan,rhs=this.modelData.ghs.rhs.items,attrs=this.modelData.gts.row,info=[],entities=contextMenu===true?this.contextMenuSelection:this.previousSelected,metricIdentifier={};$ARRAY.forEach(entities,function(e){var level=e.level,index=(e.index===undefined)?e.indices[0]:e.index,rowHeaderData=rhs[index].items,rowHeaderLen=(rowHeaderData&&rowHeaderData.length)||0,attr,idx,attrEle,formSeen,i,j,infoUnit=[],combinedElement,uniqFormNames;metricIdentifier={};for(i=e.entityChildren?level:0;i<=level;i++){attr=attrs[i];metricIdentifier[attr.id]=[];formSeen=[];uniqFormNames=[];combinedElement={n:attr.n,tid:attr.id};for(j=0;j<rowHeaderLen;j++){if(!rowHeaderData[j]||rowHeaderData[j].tui!==i){continue;}idx=rowHeaderData[j].idx;if(idx===-1){continue;}attrEle=attr.es[idx];if(formSeen.indexOf(attrEle)===-1){uniqFormNames.push(attrEle.n);formSeen.push(attrEle);if(combinedElement.eid===undefined){combinedElement.eid=attrEle.id;}}}combinedElement.v=uniqFormNames.join(":");if(i===level){combinedElement.level=e.level;metricIdentifier[attr.id].push({id:combinedElement.eid,n:combinedElement.v,level:combinedElement.level});}else{metricIdentifier[attr.id].push({id:combinedElement.eid,n:combinedElement.v});}infoUnit.push(combinedElement);}info.push(infoUnit);if(level<attrs.length-1){if(contextMenu==true){me.addContextMenuAttributeSelection(attr.id,combinedElement.eid,combinedElement.v);}else{me.addAttributeSelection(attr.id,combinedElement.eid,combinedElement.v);}}else{if(contextMenu==true){me.addContextMenuMetricValueSelection(metricIdentifier);}else{me.addMetricValueSelection(metricIdentifier);}}});return info;},highlight:function(selType,data){if(this._super){this._super.apply(this,arguments);}if(this.noHighlightAfterKeepOnlyExcludeDrill){return ;}var dataUnit,hash,attId,attElems,attElemName,attElemId,attIndex,selectedAtts,entitiesToHighlight=[];function getEntities(selAtts,entities){var root=this.root,entityChildren=root&&root.entityChildren,attrs=this.modelData.gts.row||[],attrElemObj,attrElemName,attrElemId,level,attrCount=attrs.length,tempEntities=[],me=this;if(!entities){entities=[];}if(!$HASH.isEmpty(selAtts)){tempEntities.push(root);for(level=0;level<attrCount;level++){attrElemObj=selAtts[level];attrElemName=attrElemObj&&attrElemObj.eNm;attrElemId=attrElemObj&&attrElemObj.eId;var toDeleteElemIndices=[];$ARRAY.forEach(tempEntities,function(entity,index){entityChildren=entity.entityChildren||[];var hasChildMatched=false;$ARRAY.forEach(entityChildren,function(cEntity){if(cEntity.level===level&&((!attrElemName&&selAtts.maxIndex>level)||me.model.compareElementsId(cEntity.id,attrElemId))){tempEntities.push(cEntity);hasChildMatched=true;}});if(!hasChildMatched&&attrElemName){toDeleteElemIndices.push(index);}});$ARRAY.forEach(toDeleteElemIndices,function(toDeleteElemIndex,index){tempEntities.splice(toDeleteElemIndex-index,1);});if(level===0){tempEntities.splice(0,1);}var len=tempEntities.length,i,tp=0;for(i=0;i<len;i++){if(tempEntities[i].level===level){tp=i;break;}}if(tp>0){tempEntities.splice(0,tp);}}}return entities.concat(tempEntities);}if(this.isEmpty()){return ;}var tt=function(attElem){attElemName+=attElem.n+" ";};for(hash in data){var isValid=true;if(!data.hasOwnProperty(hash)){continue;}dataUnit=data[hash];selectedAtts={};for(attId in dataUnit){if(!dataUnit.hasOwnProperty(attId)){continue;}attIndex=getAttIndexFromId.call(this,attId);if(attIndex<0){isValid=false;break;}if(!selectedAtts.hasOwnProperty("maxIndex")){selectedAtts.maxIndex=0;}attElems=dataUnit[attId]||[];attElemName="";$ARRAY.forEach(attElems,tt);attElemName=attElemName.substring(0,attElemName.length-1);attElemId=attElems.length>0?attElems[0].id:"";selectedAtts[attIndex]={eNm:attElemName,eId:attElemId};selectedAtts.maxIndex=Math.max(attIndex,selectedAtts.maxIndex);}if(isValid){entitiesToHighlight=getEntities.call(this,selectedAtts,entitiesToHighlight);}}this.removeAllSelections();this.previousSelected=entitiesToHighlight;this.refreshHighlights();},singleUnitSelect:function singleUnitSelect(){var doAttributeSelection=this.getSelections().length>0||this.clearSelectionsFlag;if(this.clearSelectionsFlag){delete this.clearSelectionsFlag;}if(doAttributeSelection){var findUnitIdWithSC=function(){var scm=this.model.scm,scmKeys=Object.keys(scm||{}),unitId=(scmKeys&&scmKeys[0])||"",gts=this.model.data.gts,row=gts.row,col=gts.col;$ARRAY.forEach(row.concat(col),function(unit){if(scmKeys.indexOf(unit.id)!==-1){unitId=unit.id;return false;}});return unitId;};var findUnitIdsWithSC=function(){var scm=this.model.scm,scmKeys=Object.keys(scm||{}),unitIds=[],gts=this.model.data.gts,row=gts.row,col=gts.col;$ARRAY.forEach(row.concat(col),function(unit){if(scmKeys.indexOf(unit.id)!==-1){unitIds.push(unit.id);}});return unitIds;};var prepareCell=function(){var selectionInfo={};selectionInfo.tid=findUnitIdWithSC.call(this);selectionInfo.tids=findUnitIdsWithSC.call(this);selectionInfo.eid="";selectionInfo.isClearAll=false;selectionInfo.anchor=this.domNode;selectionInfo.at=SELECTOR_ACTION;selectionInfo.selections=this.getSelections();selectionInfo.selectionType=this.getSelectionType();return selectionInfo;};var selctionInfo=prepareCell.call(this);this.performAction([selctionInfo]);}},clearSelections:function(){this.clearSelectionsFlag=true;if(this._super){this._super();}},clearCxtMnuSelection:function clearCxtMnuSelection(){if(this._super){this._super();}}});}());