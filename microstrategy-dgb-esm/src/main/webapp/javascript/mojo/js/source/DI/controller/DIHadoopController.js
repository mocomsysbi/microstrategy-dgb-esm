(function(){mstrmojo.requiresCls("mstrmojo.Obj","mstrmojo.array","mstrmojo.hash","mstrmojo.warehouse.EnumDatabaseType","mstrmojo.warehouse.dbroles.DBRoleEditor","mstrmojo.DI.DIHadoopModel","mstrmojo.DI.DIHelpers","mstrmojo.DI.controller.DIHadoopWHController","mstrmojo.warehouse.obj.DBRole","mstrmojo.qb.DataService");mstrmojo.requiresDescs(12773,12774,12815,12816,12817,14950,14951,16148);var $A=mstrmojo.array;var $H=mstrmojo.hash;var $DIHELPER=mstrmojo.DI.DIHelpers;var $ENUM_DATABASE_TYPE=mstrmojo.warehouse.EnumDatabaseType;var HGOSDBROLEID="AFAD9E7E8D7E4DA0AEED8FD5AADFC99C",EMPTYCONNSTR=";MSTR_CUSTOM=true;";function parseURLFiles(res){var fls=res.mi.ftree.fl;var size=0,fl,i;if(fls!==undefined){for(i=0;i<fls.length;i++){fl=fls[i];size+=fl.sz;}}return size;}mstrmojo.DI.controller.DIHadoopController=mstrmojo.declare(mstrmojo.Obj,null,{scriptClass:"mstrmojo.DI.controller.DIHadoopController",dbRoleID:HGOSDBROLEID,hadoopConnURL:"",dbRole:"",saveDBRole:function saveDBRole(dbRole,editorNode){var controller=mstrApp.getRootController(),$this=this;editorNode.set("visible",false);editorNode.close();controller.getDataService().saveDBRole({success:function success(res){$this.dbRoleID=res.dbr.did;$this.hadoopConnURL=mstrmojo.DI.DIHadoopModel.prototype.populateURLPath(dbRole);controller.model.raiseEvent({name:"HadoopDBRoleSaved"});},fail:function fail(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}},{dbroleinfo:JSON.stringify(dbRole)});},loadBDEDBRole:function(tid){if(mstrApp.placeholder!=="DIApp"&&mstrApp.placeholder!=="mainDIApp"){return ;}var $this=this,DB_Role=new mstrmojo.DI.DIHadoopDBRole(),controller=mstrApp.getRootController(),model=controller.getModel(),source=model&&model.getImportSource(tid),srcDBRoleID=$H.walk("sourceInfo.dbRoleId",source);controller=mstrApp.getRootController();DB_Role.mdDBRole.did=HGOSDBROLEID;DB_Role.populate(function(db_role){var connStr=db_role.mdDBRole.connstr;function process(){if(connStr===""||connStr===EMPTYCONNSTR){$this.renderDBRoleEditor(DB_Role);$this.dbRoleID=HGOSDBROLEID;$this.dbRole=DB_Role;}else{$A.forEach(connStr.split(";"),function(x){var arr=x.split("=");db_role[arr[0].trim().toLowerCase()]=arr[1];});$this.hadoopConnURL=mstrmojo.DI.DIHadoopModel.prototype.populateURLPath(db_role);$this.dbRoleID=HGOSDBROLEID;$this.dbRole=DB_Role;controller.model.raiseEvent({name:"BDEDBRoleLoaded"});}}if(srcDBRoleID&&srcDBRoleID!==HGOSDBROLEID){mstrmojo.warn(mstrmojo.desc(16148,"The current being used Hadoop Gateway connection is out of date and click ‘OK’ to use the upgraded connection to browse Hadoop HDFS. The original connection info will be overridden once the dataset is updated."),{confirmBtn:{t:mstrmojo.desc(1442,"OK"),fn:function(){process();}},cancelBtn:{cfg:{visible:false}}});}else{process();}});},populateDBRole:function populateDBRole(dbRoleID,callback){var controller=mstrApp.getRootController();controller.model.populateDBRole(dbRoleID,callback);},doRenderDBRoleEditor:function(dbRole,gateways){var $this=this;var rootController=mstrApp.getRootController();var hgcontroller=rootController.getHadoopGatewayController();var zIndex=rootController.dialogController.getNextZIndex();var arr,scrollable=!mstrApp.isSingleTier&&mstrApp.isWorkstation&&!mstrApp.isPopup;this.launchingApp=mstrApp;window.mstrApp=new mstrmojo.qb.QBApp();mstrApp.sessionState=this.launchingApp.sessionState;mstrApp.msgID=mstrApp.messageID;mstrApp.docID=mstrApp.messageID;mstrApp.placeholder="QBApp";mstrApp.isSingleTier=this.launchingApp.isSingleTier;mstrApp.diParams=this.launchingApp.diParams;mstrApp.isWorkstation=this.launchingApp.isWorkstation;mstrApp.serverProxy=this.launchingApp.serverProxy;mstrApp.isPopup=this.launchingApp.isPopup;delete mstrApp.messageID;delete this.launchingApp.dbType;delete this.launchingApp.supportDBObjects;mstrApp.sessionManager=this.launchingApp.sessionManager;mstrApp.enableAutomaticSessionRecovery=this.launchingApp.enableAutomaticSessionRecovery;mstrApp.maxSessionIdleTime=this.launchingApp.maxSessionIdleTime;mstrApp.timeBeforeSessionTimeoutWarning=this.launchingApp.timeBeforeSessionTimeoutWarning;mstrApp.enableWarningSessionTimeout=this.launchingApp.enableWarningSessionTimeout;mstrApp.projectName=this.launchingApp.projectName;mstrApp.serverName=this.launchingApp.serverName;mstrApp.serverPort=this.launchingApp.serverPort;mstrApp.authMode=this.launchingApp.authMode;mstrApp.name=this.launchingApp.name;mstrApp.persistTaskParams=this.launchingApp.persistTaskParams;mstrApp.hideProgress=this.launchingApp.hideProgress;mstrApp.taskQueue=this.launchingApp.taskQueue;mstrApp.diRootCtrl=rootController;var controller=mstrApp.rootController=new mstrmojo.DI.controller.DIHadoopWHController();controller.showDialog=function(type,config){rootController.showDialog(type,config);};controller.getHadoopGatewayController=function(){return hgcontroller;};controller.getHadoopController=function(){return $this;};controller.dataService=mstrmojo.qb.DataService;var model=controller.model=new mstrmojo.DI.DIHadoopModel();model.dbRoleEditorCfg={hideLogin:true,hidePwd:true,hideShareLink:true,hideShareConnection:true,showShareLink:!!dbRole,hideDSNOption:true,hideDriverCheck:true,dbIdFilter:[42]};model.loadDBObjects({success:function success(){var dbrEditor=new mstrmojo.warehouse.dbroles.DBRoleEditor({zIndex:zIndex,cssClass:$DIHELPER.getEnvObj().isWS()?"mstrmojo-rootview-hadoop mstrmojo-wh-DBRoleEditor":"mstrmojo-wh-DBRoleEditor",scrollable:scrollable,isHadoopGateWay:true});dbrEditor.config=model.dbRoleEditorCfg;dbrEditor.callback={close:function(){if(mstrmojo.all.QBuilderModel){mstrmojo.all.QBuilderModel.destroy();}if(mstrmojo.all.QBuilderPage){mstrmojo.all.QBuilderPage.destroy();}mstrApp.getRootController().destroy();var qbApp=window.mstrApp;window.mstrApp=$this.launchingApp;mstrApp.sessionState=qbApp.sessionState;mstrApp.msgID=qbApp.messageID;mstrApp.docID=qbApp.messageID;if(qbApp.dbRoleID){mstrApp.getRootController().hadoopController.dbRoleID=qbApp.dbRoleID;mstrApp.getRootController().hadoopController.hadoopConnURL=qbApp.hadoopConnURL;mstrApp.getRootController().model.raiseEvent({name:"HadoopDBRoleSaved"});}qbApp.destroy();}};if(!dbRole){dbRole=new mstrmojo.warehouse.obj.DBRole({mdl:model});}dbrEditor.listOptions={};arr=dbrEditor.listOptions[14956]=[];$A.forEach(gateways,function(item){arr.push({v:item.hgosName,data:item});});if(!arr.length){arr.push({v:""});}dbrEditor.labelClickFn={};dbrEditor.labelClickFn[14906]=function(){hgcontroller.showGatewayListDialog();};if(gateways){for(var i=0;i<gateways.length;i++){var temp=gateways[i];var addr=gateways[i].config.hostAddr;var port=gateways[i].config.tcpPort;if(gateways[i].config.hostAddr==dbRole.BDEIP&&gateways[i].config.tcpPort==dbRole.BDEPORT){dbrEditor.oldIndex=i;if(gateways[i].config.sparkConfig.props){dbrEditor.AuthMode=gateways[i].config.sparkConfig.props.AuthMode;}else{dbrEditor.AuthMode=0;}break;}}}dbrEditor.dbrole=dbRole;dbrEditor.disableTest=true;dbrEditor.open();$this.dbrEditor=dbrEditor;}});},updateDBRoleEditor:function(){var controller=mstrApp.getRootController(),editor=this.dbrEditor;var list=editor.children[0].children[2].children[4].dbp_hg.children[1];var index=list.selectedIndex;var items=[];controller.getHadoopGatewayController().listGateways({success:function(res){var items=res&&res[0].entity;var arr=[];$A.forEach(items,function(item){arr.push({v:item.hgosName,data:item,n:item.hgosName});});if(!arr.length){arr.push({v:""});}list.set("items",arr);list.set("selectedIndex",index);},failure:function(){}});},renderDBRoleEditor:function(dbrole){this.doRenderDBRoleEditor(dbrole);},hadoopBrowserFunction:function(node){this.browseHadoop(node.data.address,node.data.browser,node);},browseHadoop:function browseHadoop(urlPath,browser,node){var controller=mstrApp.getRootController(),params={},$browser=browser,$node=node;if(urlPath===""){controller.displayError(mstrmojo.desc(12773,"Please enter a valid network path."),false);return ;}if(urlPath.substring(0,1)==="\\"){urlPath=urlPath.replace(/\\\\/g,"file://");urlPath=urlPath.replace(/\\/g,"/");}params.urlPath=urlPath;params.dbRoleID=this.dbRoleID;var callback={success:function(res){if(res.mi.ftree===""){$browser.set("fileList",[]);}$browser.set("fileList",controller.parseURLFolders(res));if($node){$node.data.isMouseOver=true;if(res.mi.ftree===""){$node.totalSize=0;}else{var files=res.mi.ftree.fl;if(files){$node.totalSize=mstrmojo.DI.DIHelpers.getRoundSize(parseURLFiles(res));}else{$node.totalSize="---";}}}},failure:function(res){$browser.set("fileList",[]);controller.displayError(mstrmojo.desc(12816,"Uh-Oh, Error fetching the list of files for the given network path: ####").replace("####",res.message),false);}};controller.dataService.getOAuthSourceReports(callback,params);},browseHadoopForFolderSize:function browseHadoopForFolderSize(urlPath,itemNode){var controller=mstrApp.getRootController(),params={},$this=itemNode,$browser=itemNode.tree.parent;if(urlPath===""){controller.displayError(mstrmojo.desc(12773,"Please enter a valid network path."),false);return ;}if(urlPath.substring(0,1)==="\\"){urlPath=urlPath.replace(/\\\\/g,"file://");urlPath=urlPath.replace(/\\/g,"/");}params.urlPath=urlPath;params.dbRoleID=this.dbRoleID;var callback={success:function(res){if(res.mi.ftree===""){$this.totalSize=0;}else{var files=res.mi.ftree.fl;if(files){$this.totalSize=mstrmojo.DI.DIHelpers.getRoundSize(parseURLFiles(res));}else{$this.totalSize="---";}}$browser.setFileListForNode(controller.parseURLFolders(res),itemNode);$this.set("richTooltip",{cssClass:"vi-regular vi-tooltip-V",refNode:$this.textNode,posType:mstrmojo.tooltip.POS_BOTTOMLEFT,top:-5,content:mstrmojo.desc(12817,"Name: #### Size: @@@@").replace("####",$this.text).replace("@@@@",$this.totalSize)});},failure:function(){}};controller.dataService.getHadoopFolderSize(callback,params);}});}());