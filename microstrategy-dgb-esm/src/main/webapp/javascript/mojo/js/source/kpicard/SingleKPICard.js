(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo._HasLayout","mstrmojo.tooltip","mstrmojo.css","mstrmojo.VisUtility","mstrmojo.num","mstrmojo.kpicard.KPICardEnum","mstrmojo.array","mstrmojo.hash","mstrmojo.dom");var $MOJO=mstrmojo,$DOM=mstrmojo.dom,$ARR=mstrmojo.array,$HASH=mstrmojo.hash,$CSS=$MOJO.css,$VISUTIL=$MOJO.VisUtility,MIN_FONT_SIZE=11;var SINGLE_METRIC_DISPLAY_MODE=$MOJO.kpicard.SINGLE_METRIC_DISPLAY_MODE,$BADGE_MODE=$MOJO.kpicard.BADGE_MODE,$KPI_PROPERTIES=$MOJO.kpicard.KPI_PROPERTIES,$DISPLAY_MODE=mstrmojo.kpicard.DISPLAY_MODE,$TEXT_SIZE_TYPE=mstrmojo.kpicard.TEXT_SIZE_TYPE,$CAN_SET_FONT_PARTS=mstrmojo.kpicard.CAN_SET_FONT_PARTS,$ENUM_PROPERTY_NAMES=mstrmojo.models.FormatModel.ENUM_PROPERTY_NAMES,FONT_ICON="vi_icons",ITALIC_SUFFIX="1",STYLE_NAME=["only-metric","metric-with-timeline","only-metric","metric-with-timeline"],KPICARD_ATTACHED_EVENTS=["click","contextmenu","mouseover","mouseout"],$SELECTION_BORDER_COLOR=$MOJO.kpicard.SELECTION_BORDER_COLOR;function fillText(node,text){if(typeof node.innerText!=="undefined"){node.innerText=text;}else{node.textContent=text;}}function rectPointIntersection(rect,x,y){var left=rect.x,right=left+rect.w,top=rect.y,bottom=top+rect.h;return x<=right&&x>=left&&y<=bottom&&y>=top;}function getNodeText(node){if(typeof node.innerText!=="undefined"){return node.innerText;}else{return node.textContent;}}function getSizeByType(tmp,containerSize){var size;if(tmp==="none"){return ;}if(tmp.indexOf("px")>0){size=parseFloat(tmp);}else{size=containerSize*parseFloat(tmp)/100;}return size;}function getContainerSize(div,type,kpiCardWidth,kpiCardHeight){div.style.width="";var computedStyle=$CSS.getComputedStyle(div),containerSize=(type==="width"||type==="maxWidth")?parseFloat(kpiCardWidth):parseFloat(kpiCardHeight);return getSizeByType(computedStyle[type],containerSize-2);}function getFontStyle(div,fontSize){var computedStyle=$CSS.getComputedStyle(div),fontStyle={};fontStyle.fontFamily=computedStyle.fontFamily;fontStyle.fontStyle=computedStyle.fontStyle;fontStyle.fontSize=fontSize+"px";fontStyle.fontWeight=computedStyle.fontWeight;fontStyle.lineHeight=1;fontStyle.bonus=parseInt(computedStyle.paddingLeft)+parseInt(computedStyle.paddingRight);return fontStyle;}function getCurrTextSize(div,fontSize){var text=div.innerText,fontStyle=getFontStyle(div,fontSize),result=$VISUTIL.measureTextSize(text+ITALIC_SUFFIX,fontStyle,fontStyle.bonus);return result;}function alignCenter(containerNode,div){if(containerNode.className.indexOf("only-metric")>-1){$CSS.addClass(div,"align-center");}}mstrmojo.kpicard.SingleKPICard=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasLayout],{scriptClass:"mstrmojo.kpicard.SingleKPICard",cssClass:"single-kpicard-container",layoutConfig:{w:{containerNode:"100%",leftPadding:"0px",rightPadding:"0px"},xt:true},responsiveMode:SINGLE_METRIC_DISPLAY_MODE.HORIZONTAL,dataModel:null,selected:false,useAsMenuData:false,onHover:false,colorThresholdIdx:null,borderColor:"",markupString:'<div class="{@cssClass}" style="{@cssText}" mstrAttach:'+KPICARD_ATTACHED_EVENTS.join(",")+'><div class="metric-name label"></div><div class="metric-value label">{@en@dataModel.metricValue}</div><div class="previous-metric label">{@en@dataModel.prevMetricInfo}</div><div class="compare-to-previous label"></div><div class="chart"></div><div class="selection-fill"><div class="hover-fill"></div></div></div>',markupSlots:{containerNode:function(){return this.domNode;},metricNameNode:function(){return this.domNode.childNodes[0];},metricValueNode:function(){return this.domNode.childNodes[1];},prevMetricNode:function(){return this.domNode.childNodes[2];},compareNode:function(){return this.domNode.childNodes[3];},chartNode:function(){return this.domNode.childNodes[4];},selectionFillNode:function(){return this.domNode.childNodes[5];},hoverFillNode:function(){return this.domNode.childNodes[5].firstChild;},tooltipNode:function(){return[];}},init:function init(p){this._super(p);this.colorThresholdIdx=-1;this.selected=false;},preBuildRendering:function preBuildRendering(){var cssText=this.cssText||"",left=this.left,top=this.top,marginTop=this.cardMarginTop,marginLeft=this.cardMarginLeft;if(left){cssText+="left:"+left+";";}if(top){cssText+="top:"+top+";";}if(marginTop){cssText+="margin-top:"+marginTop+";";}if(marginLeft){cssText+="margin-left:"+marginLeft+";";}this.cssText=cssText;return(this._super)?this._super():true;},postBuildRendering:function postBuildRendering(){this._super();var width=parseFloat(this.width);var height=parseFloat(this.height);if(width/height<1){this.responsiveMode=SINGLE_METRIC_DISPLAY_MODE.VERTICAL;$CSS.toggleClass(this.containerNode,"vertical",true);$CSS.toggleClass(this.containerNode,"horizontal",false);}else{this.responsiveMode=SINGLE_METRIC_DISPLAY_MODE.HORIZONTAL;$CSS.toggleClass(this.containerNode,"vertical",false);$CSS.toggleClass(this.containerNode,"horizontal",true);}$CSS.toggleClass(this.containerNode,STYLE_NAME[this.dataModel.KPITemplateMode],true);this.updateStyle();this.applyDefaultFontColor();this.renderByFont();if(this.dataModel.prevMetricInfo){this.drawChart();}},applyDefaultFontColor:function applyDefaultFontColor(){var host=this.getHost(),defaultFontColorLabels=[this.metricNameNode,this.metricValueNode,this.prevMetricNode],defaultFontColor=host.getDefaultFontColor();$ARR.forEach(defaultFontColorLabels,function(node){node.style.color=defaultFontColor;});},getHost:function(){return $HASH.walk("parent.parent",this);},updateStyle:function(){var host=this.getHost();var kpiStyle=host.getFormatPropertyValue($KPI_PROPERTIES.KPI_STYLE);var kpiStyleConfig=host.getSpecificKPIStyle(kpiStyle);var color=mstrmojo.color.hex2rgb(kpiStyleConfig.bgColor);color.push(kpiStyleConfig.bgOpacity);this.containerNode.style.backgroundColor="rgba("+color.join(",")+")";var chartOption=this.dataModel.chartOption;var chart=this.chartInstance;if(chartOption){chartOption.series[0].itemStyle=host.getItemStyle(this);}if(chart){chart.setOption(chartOption);}},updateNodeFontStyle:function updateNodeFontStyle(node,partName){var host=this.getHost();var font=host.getFormatPropertyValue($KPI_PROPERTIES.NEW_FONT);var isFixed=host.getFormatPropertyValue($KPI_PROPERTIES.TEXT_SIZE_TYPE)===$TEXT_SIZE_TYPE.FIXED;var props=font[partName];var setFontFamily=function(ff){node.style.fontFamily="'"+ff+"'";};var setFontWeight=function(fw){node.style.fontWeight=fw?"bold":"normal";};var setFontItalic=function(fit){node.style.fontStyle=fit?"italic":"normal";};var setFontDecoration=function(fun,fst){var decoration="";decoration+=fun?"underline":"";decoration+=fst?" line-through":"";node.style.textDecoration=decoration;};var setFontSize=function(fsz){node.style.fontSize=fsz;};var setFontColor=function(fc){node.style.color=fc;};setFontFamily(props[$ENUM_PROPERTY_NAMES.FONT_FAMILY]);setFontWeight(props[$ENUM_PROPERTY_NAMES.FONT_WEIGHT]);setFontItalic(props[$ENUM_PROPERTY_NAMES.FONT_STYLE]);setFontDecoration(props[$ENUM_PROPERTY_NAMES.UNDERLINE],props[$ENUM_PROPERTY_NAMES.LINE_THROUGH]);if(isFixed){setFontSize(props[$ENUM_PROPERTY_NAMES.FONT_SIZE]);}setFontColor(props[$ENUM_PROPERTY_NAMES.COLOR]);if(partName===$CAN_SET_FONT_PARTS.PRIMARY_VALUE){host.applyColorThresholds(this);}},renderByFont:function renderByFont(partArr){var host=this.getHost();var showMetricName=host.getFormatPropertyValue($KPI_PROPERTIES.SHOW_METRIC_NAME);var allUpdate=partArr===undefined;if(allUpdate||partArr.indexOf($CAN_SET_FONT_PARTS.LABEL)>-1){this.renderMetricName(showMetricName);}if(allUpdate||partArr.indexOf($CAN_SET_FONT_PARTS.PRIMARY_VALUE)>-1){this.renderMetricValue();}if(this.dataModel.prevMetricInfo){if(allUpdate||partArr.indexOf($CAN_SET_FONT_PARTS.PREVIOUS_VALUE)>-1){this.renderPrevMetricInfo();}if(allUpdate||partArr.indexOf($CAN_SET_FONT_PARTS.TREND_IDENTITY)>-1){this.renderCompareNode();}}},setTitleByWidth:function setTitleByWidth(node,textWidth,kpiCardWidth,kpiCardHeight,unifyTextSize){var width=getContainerSize(node,"width",kpiCardWidth,kpiCardHeight);if(textWidth>width){node.title=getNodeText(node);if(node===this.prevMetricNode){this.fitPrevStringToContainer(unifyTextSize);}}},resetNodeTextSize:function resetNodeTextSize(node,unifyChecked,unifyTextSize,unifySteps,state){var currSize,height,actualFontSize;if(node===this.prevMetricNode){actualFontSize=parseFloat(node.style.fontSize)+unifySteps;}else{actualFontSize=parseFloat(node.style.fontSize)+(state==="plus"?1:(state==="minus"?-1:unifySteps));}var host=this.getHost();var isStackMode=host.getFormatPropertyValue($KPI_PROPERTIES.DISPLAY_MODE)===$DISPLAY_MODE.STACKED;if(unifyChecked&&!isStackMode){actualFontSize=unifyTextSize+unifySteps;}actualFontSize=Math.max(actualFontSize,MIN_FONT_SIZE);if(parseFloat(node.style.fontSize)<actualFontSize){currSize=getCurrTextSize(node,actualFontSize);this.setTitleByWidth(node,currSize.width,this.width,this.height,actualFontSize);node.style.width=currSize.width+"px";height=getContainerSize(node,"height",this.width,this.height);node.style.lineHeight=node.style.height=Math.ceil(currSize.height)*1.5+"px";}node.style.fontSize=actualFontSize+"px";},unifyBadgeTextSize:function unifyBadgeTextSize(unifyChecked,unifySteps,state){var host=this.getHost(),node=this.compareNode,currSize,fs=getFontStyle(node,parseFloat(node.style.fontSize)),actualFontSize=parseFloat(node.style.fontSize)+(state==="plus"?1:(state==="minus"?-1:unifySteps));var isStackMode=host.getFormatPropertyValue($KPI_PROPERTIES.DISPLAY_MODE)===$DISPLAY_MODE.STACKED;if(unifyChecked&&!isStackMode){actualFontSize=host.unifyBadgeSize+unifySteps;}actualFontSize=Math.max(actualFontSize,MIN_FONT_SIZE);if(fs.fontFamily===FONT_ICON){node.style.fontSize=actualFontSize+"px";node.style.width=actualFontSize+8+"px";}else{currSize=getCurrTextSize(node,actualFontSize);node.style.fontSize=actualFontSize+"px";this.setTitleByWidth(node,currSize.width,this.width,this.height);node.style.width=currSize.width+"px";}this.setCompareNodeHeight();},applyUnifySteps:function applyUnifySteps(state,partArr){var me=this;var host=this.getHost();var dataModel=this.dataModel;var badgeMode=dataModel.badgeMode;var font=host.getFormatPropertyValue($KPI_PROPERTIES.NEW_FONT);var textSizeType=host.getFormatPropertyValue($KPI_PROPERTIES.TEXT_SIZE_TYPE);if(textSizeType===$TEXT_SIZE_TYPE.FIXED){return ;}var unifyChecked=textSizeType===$TEXT_SIZE_TYPE.UNIFIED;var updateObj={};if(partArr){$ARR.forEach(partArr,function(part){updateObj[part]=font[part];});}else{updateObj=font;}$HASH.forEach(updateObj,function(props,partName){var unifySteps=Number(props[$KPI_PROPERTIES.UNIFY_STEPS]);if(partName===$CAN_SET_FONT_PARTS.LABEL){me.resetNodeTextSize(me.metricNameNode,unifyChecked,host.unifyMetricNameSize,unifySteps,state);}if(partName===$CAN_SET_FONT_PARTS.PRIMARY_VALUE){me.resetNodeTextSize(me.metricValueNode,unifyChecked,host.unifyMetricValueSize,unifySteps,state);}if(host.unifyPrevMetricSize){if(partName===$CAN_SET_FONT_PARTS.PREVIOUS_VALUE){me.resetNodeTextSize(me.prevMetricNode,unifyChecked,host.unifyPrevMetricSize,unifySteps,state);}if(partName===$CAN_SET_FONT_PARTS.TREND_IDENTITY&&badgeMode!==$BADGE_MODE.NONE){me.unifyBadgeTextSize(unifyChecked,unifySteps,state);}}});},setCompareNodeHeight:function setBadgeHeight(){var compareNode=this.compareNode,compareToPrevString=this.dataModel.compareToPrevString,fs=getFontStyle(compareNode,parseFloat(compareNode.style.fontSize)),badgeHeight=$VISUTIL.measureTextHeight(compareToPrevString,fs);if(fs.fontFamily===FONT_ICON){compareNode.style.height=compareNode.style.width;compareNode.style.lineHeight=compareNode.style.fontSize;}else{compareNode.style.height=(badgeHeight+8)+"px";compareNode.style.lineHeight=badgeHeight+"px";}},renderCompareNode:function renderCompareNode(){var compareNode=this.compareNode;var dataModel=this.dataModel;var badgeMode=dataModel.badgeMode;if(badgeMode===$BADGE_MODE.NONE){compareNode.style.display="none";}else{compareNode.style.display="block";this.applyCmpNodeBgClr();this.updateNodeFontStyle(compareNode,$CAN_SET_FONT_PARTS.TREND_IDENTITY);if(badgeMode===$BADGE_MODE.PERCENTAGE&&dataModel.prevMetricRawValue===0&&dataModel.metricRawValue!==0){compareNode.style.fontFamily="vi_icons";}fillText(compareNode,dataModel.compareToPrevString);this.fitTextToContainer(compareNode);this.setCompareNodeHeight();}},applyCmpNodeBgClr:function applyCmpNodeBgClr(){this.compareNode.style.backgroundColor=this.dataModel.cmpBgClr;},renderMetricValue:function renderMetricValue(){this.updateNodeFontStyle(this.metricValueNode,$CAN_SET_FONT_PARTS.PRIMARY_VALUE);this.fitTextToContainer(this.metricValueNode);alignCenter(this.containerNode,this.metricValueNode);},renderMetricName:function renderMetricName(checked){var metricNameNode=this.metricNameNode,text;if(this.dataModel.categoryElemName){text=this.dataModel.categoryElemName;if(checked==="true"){text=this.dataModel.metricName+" - "+text;}}else{text=this.dataModel.metricName;}this.updateNodeFontStyle(metricNameNode,$CAN_SET_FONT_PARTS.LABEL);fillText(metricNameNode,text);this.fitTextToContainer(metricNameNode);alignCenter(this.containerNode,this.metricNameNode);},renderPrevMetricInfo:function resetPrevMetricInfo(){if(this.dataModel.prevMetricFmtValue){var host=this.getHost();this.dataModel.prevMetricInfo=host.getPrevMetricInfoString(this.dataModel.prevMetricFmtValue);}var prevMetricNode=this.prevMetricNode;this.updateNodeFontStyle(prevMetricNode,$CAN_SET_FONT_PARTS.PREVIOUS_VALUE);fillText(prevMetricNode,this.dataModel.prevMetricInfo);this.fitTextToContainer(prevMetricNode);},drawChart:function drawChart(){this.chartNode.style.width=getContainerSize(this.chartNode,"width",this.width,this.height)+"px";this.chartNode.style.height=getContainerSize(this.chartNode,"height",this.width,this.height)+"px";var host=this.getHost(),myChart=window.echarts.init(this.chartNode);myChart.setOption(this.dataModel.chartOption);myChart.on("globalout",function(){host.hideTooltip();});this.chartInstance=myChart;},fitPrevStringToContainer:function fitPrevStringToContainer(fontSize){var div=this.prevMetricNode,containerWidth=getContainerSize(div,"width",this.width,this.height),fontStyle=getFontStyle(div,fontSize),prevLabel=this.parent.parent.getFormatPropertyValue($KPI_PROPERTIES.PREVIOUS_METRIC_NAME),suffix="...: "+this.dataModel.prevMetricFmtValue,tmpStringWidth,tmpString;div.style.fontSize=fontSize+"px";if(prevLabel===""){div.innerText=this.dataModel.prevMetricFmtValue;}else{tmpString=prevLabel[0]+suffix;tmpStringWidth=$VISUTIL.measureTextWidth(tmpString+ITALIC_SUFFIX,fontStyle,fontStyle.bonus);if(tmpStringWidth>=containerWidth){div.innerText=this.dataModel.prevMetricFmtValue;}else{for(var i=2;i<prevLabel.length;i++){tmpString=prevLabel.substring(0,i)+suffix;tmpStringWidth=$VISUTIL.measureTextWidth(tmpString+ITALIC_SUFFIX,fontStyle,fontStyle.bonus);if(tmpStringWidth>=containerWidth){tmpString=prevLabel.substring(0,i-1)+suffix;break;}}div.innerText=tmpString;}}div.title=this.dataModel.prevMetricInfo;},fitTextToContainer:function fitTextToContainer(div){var fontSize=MIN_FONT_SIZE,containerWidth,containerHeight,text=div.innerText,currSize,fixed,maxWidth;fixed=this.getHost().getFormatPropertyValue($KPI_PROPERTIES.TEXT_SIZE_TYPE)===$TEXT_SIZE_TYPE.FIXED;if(fixed){fontSize=parseInt(div.style.fontSize);}div.style.width="";div.style.height="";div.style.lineHeight="";div.style.fontSize="";div.style.left="";div.style.transform="";div.title="";containerWidth=getContainerSize(div,"width",this.width,this.height);containerHeight=getContainerSize(div,"height",this.width,this.height);currSize=getCurrTextSize(div,fontSize);if(text&&text!==""){if(div===this.prevMetricNode&&(currSize.width>containerWidth)){this.fitPrevStringToContainer(fontSize);}else{if(!fixed){var step=1,low=fontSize,middle;while(currSize.width<containerWidth&&currSize.height<containerHeight){low=fontSize;fontSize=MIN_FONT_SIZE+Math.pow(2,step++);currSize=getCurrTextSize(div,fontSize);}while(low<fontSize){middle=Math.floor((low+fontSize)/2);currSize=getCurrTextSize(div,middle);if(currSize.width<containerWidth&&currSize.height<containerHeight){low=middle+1;}else{fontSize=middle-1;}}fontSize=Math.max(low-1,MIN_FONT_SIZE);}div.style.fontSize=fontSize+"px";if(div.style.fontFamily===FONT_ICON){div.style.width=fontSize+8+"px";}else{currSize=getCurrTextSize(div,fontSize);if(currSize.width>containerWidth){maxWidth=getContainerSize(div,"maxWidth",this.width,this.height);if(currSize.width<=maxWidth){div.style.width=currSize.width+"px";}else{div.style.width=maxWidth+"px";div.title=text;}}else{div.style.width=currSize.width+"px";}}}}div.style.lineHeight=div.style.height=Math.ceil(currSize.height)*1.5+"px";},applyColorThreshold:function applyColorThreshold(idx,colorThreshold){var colorThresholdIdx=this.colorThresholdIdx,dataModel=this.dataModel,metricValue=dataModel&&dataModel.metricRawValue,max=colorThreshold.max,min=colorThreshold.min,color=colorThreshold.color,isInRange=false;if(colorThresholdIdx!==-1||isNaN(metricValue)){return ;}if(!isNaN(max)&&!isNaN(min)){isInRange=metricValue>=min&&metricValue<=max;}else{if(!isNaN(max)){isInRange=metricValue<=max;}else{if(!isNaN(min)){isInRange=metricValue>=min;}else{isInRange=true;}}}if(isInRange){this.colorThresholdIdx=idx;this.metricValueNode.style.color=color;}},clearColorThreshold:function clearColorThreshold(){var host=this.getHost(),defaultFontColor=host.getDefaultPrimaryValueColor();this.colorThresholdIdx=-1;this.metricValueNode.style.color=defaultFontColor;},onclick:function onclick(evt){var widget=$MOJO.all[this.widgetId];if(widget){widget.clickFromSingleKPICard=true;widget.handleLMCSelection(evt,this);}},getSize:function getSize(){var containerNode=this.containerNode;if(!containerNode){return null;}return{x:containerNode.offsetLeft,y:containerNode.offsetTop,w:containerNode.offsetWidth,h:containerNode.offsetHeight};},oncontextmenu:function oncontextmenu(evt){var widget=$MOJO.all[this.widgetId];if(widget){widget.handleRMCEvent(evt,this);}},updateHighlight:function updateHighlight(){$CSS.toggleClass(this.containerNode,"right-selected",false);$CSS.toggleClass(this.selectionFillNode,"active",this.selected);if(this.useAsMenuData){$CSS.toggleClass(this.containerNode,"right-selected",true);this.applyBorderColorToCard($SELECTION_BORDER_COLOR);}else{if(this.selected){this.applyBorderColorToCard($SELECTION_BORDER_COLOR);}else{this.applyBorderColorToCard(this.borderColor);}}},onmouseover:function onmouseover(){var widget=$MOJO.all[this.widgetId],prevHover=this.onHover;this.onHover=!!widget&&!widget.onLassoSelection;if(prevHover!==this.onHover){$CSS.toggleClass(this.hoverFillNode,"active",this.onHover);}},onmouseout:function onmouseout(evt){var prevHover=this.onHover,host=this.getHost(),auto=host.getFormatPropertyValue($KPI_PROPERTIES.AUTO_PLAY);this.onHover=false;if(prevHover!==this.onHover){$CSS.toggleClass(this.hoverFillNode,"active",this.onHover);}if(!auto){$DOM.stopPropogation(evt.hWin,evt.e);}},mobileHideToolTip:function mobileHideToolTip(){var chart=this.chartInstance,host=this.getHost();if(chart){chart.dispatchAction({type:"showTip",x:-100,y:-100});host.hideTooltip();}},mobileShowToolTip:function mobileShowToolTip(x,y){var chart=this.chartInstance,host=this.getHost(),chartSize=this.getChartSize(),intersection=rectPointIntersection(chartSize,x,y),cardPos=$DOM.position(this.domNode);if(chart&&intersection){host.updateTooltipPos(x+cardPos.x,y+cardPos.y);chart.dispatchAction({type:"showTip",x:x-chartSize.x,y:y-chartSize.y});return true;}return false;},getChartSize:function getChartSize(){var chartNode=this.chartNode;if(!chartNode){return null;}return{x:chartNode.offsetLeft,y:chartNode.offsetTop,w:chartNode.offsetWidth,h:chartNode.offsetHeight};},updateBorderColor:function updateBorderColor(borderColor){this.borderColor=borderColor;if(!this.selected&&!this.useAsMenuData){this.applyBorderColorToCard(this.borderColor);}},applyBorderColorToCard:function applyBorderColorToCard(borderColor){var containerNode=this.containerNode,containerNodeStyle=containerNode&&containerNode.style;if(!containerNodeStyle){return ;}containerNodeStyle.borderColor=borderColor;}});}());