(function(){mstrmojo.requiresCls("mstrmojo.Base","mstrmojo.gmaps.MapUtils","mstrmojo.gmaps.layer.BaseLayer");var $MUTIL=mstrmojo.gmaps.MapUtils,EVENTS={"extent-change":"extent-change","zoom-start":"zoom-start","zoom-end":"zoom-end"},ZOOM_FACTOR=200,RATIO=0.1;function _getBaseImgRawSize(){var img=this.img;if(img){return{width:parseInt(img.naturalWidth),height:parseInt(img.naturalHeight)};}}function _getContainerSize(){var container=document.getElementById(this.containerId);if(container){return{width:parseFloat(container.style.width),height:parseFloat(container.style.height)};}}function _getBaseImgRect(){var img=this.img;if(img){return{left:parseFloat(img.style.left),top:parseFloat(img.style.top),width:parseFloat(img.style.width),height:parseFloat(img.style.height)};}}function _getScreenCenter(){var containerSize=_getContainerSize.call(this);if(containerSize){return{x:containerSize.width/2,y:containerSize.height/2};}}mstrmojo.gmaps.basemap.ImageMap=mstrmojo.declare(mstrmojo.Base,null,{scriptClass:"mstrmojo.gmaps.basemap.ImageMap",mapOptions:null,img:null,containerId:null,_eventMap:null,_zoomStep:0.1,init:function init(props){if(!props){return ;}this._super(props);var container=document.getElementById(props.containerId),img=this.img=$MUTIL.createNormalNode("img");img.style.position="absolute";$MUTIL.appendNode(container,img);this._eventMap={};},on:function on(evtName,callback){var _eventMap=this._eventMap,img=this.img,me=this;if(!_eventMap||!img||!evtName){return ;}switch(evtName){case"load":return img.addEventListener(evtName,function(){var img=me.img,naturalWidth=img.naturalWidth,naturalHeight=img.naturalHeight;img.style.left=img.style.top=0;img.style.width=naturalWidth+"px";img.style.height=naturalHeight+"px";me._zoomStep=ZOOM_FACTOR/Math.max(naturalWidth,naturalHeight);callback();});case"error":return img.addEventListener(evtName,callback);default:_eventMap[evtName]=callback;return{name:evtName,remove:function(){var _eventMap=me._event;if(_eventMap){delete _eventMap.evtName;}}};}},trigger:function trigger(evtName){var _eventMap=this._eventMap;if(evtName&&_eventMap[evtName]){_eventMap[evtName]();}if(evtName===EVENTS["extent-change"]){this.show();}},show:function show(){var img=this.img;if(img){img.style.display="block";}},hide:function hide(){var img=this.img;if(img){img.style.display="none";}},setExtent:function setExtent(bounds){if(!this.img){return ;}var img=this.img,containerRect=_getContainerSize.call(this),mapWidth=containerRect.width,mapHeight=containerRect.height,imgRawWidth=img.naturalWidth,imgRawHeight=img.naturalHeight,rawBounds=bounds?{top:bounds.latSouth-RATIO*mapHeight,bottom:bounds.latNorth+RATIO*mapHeight,left:bounds.lngWest-RATIO*mapWidth,right:bounds.lngEast+RATIO*mapWidth}:{top:0,bottom:imgRawHeight,left:0,right:imgRawWidth},boundW=rawBounds.right-rawBounds.left,boundH=rawBounds.bottom-rawBounds.top,xScale=mapWidth/boundW,yScale=mapHeight/boundH,zoom=this.zoom=Math.min(xScale,yScale),offset,left,top;if(xScale<yScale){offset=(mapHeight-boundH*zoom)/2;left=-mapWidth*rawBounds.left/boundW;top=-(zoom*rawBounds.top-offset);}else{offset=(mapWidth-boundW*zoom)/2;top=-mapHeight*rawBounds.top/boundH;left=-(zoom*rawBounds.left-offset);}$MUTIL.setCssStyles(img,{width:(imgRawWidth*zoom)+"px",height:(imgRawHeight*zoom)+"px",left:left+"px",top:top+"px"});this.trigger(EVENTS["extent-change"]);},setStyle:function setStyle(style){var img=this.img;if(img&&style){$MUTIL.setNodeAttributes(img,{src:style});this.style=style;}},panBy:function panBy(offset){var img=this.img,style=img&&img.style;if(style&&offset){style.left=(parseFloat(style.left)+offset.x)+"px";style.top=(parseFloat(style.top)+offset.y)+"px";this.trigger(EVENTS["extent-change"]);}},setZoom:function setZoom(level,around){var rawSize=_getBaseImgRawSize.call(this),img=this.img,containerRect=_getContainerSize.call(this),rawPos;if(level<=0||!img||!containerRect){return ;}this.trigger(EVENTS["zoom-start"]);if(!around){around={x:containerRect.width/2,y:containerRect.height/2};}rawPos=this.toRaw(around);$MUTIL.setCssStyles(img,{left:(around.x-rawPos.x*level)+"px",top:(around.y-rawPos.y*level)+"px",height:(rawSize.height*level)+"px",width:(rawSize.width*level)+"px"});this.zoom=level;this.trigger(EVENTS["zoom-end"]);this.trigger(EVENTS["extent-change"]);},getZoom:function getZoom(){return this.zoom;},setCenter:function setCenter(rawPoint){var newCenter=this.toScreen(rawPoint),oldCenter=_getScreenCenter.call(this),oldRect=_getBaseImgRect.call(this),img=this.img;if(img&&newCenter&&oldCenter&&oldRect){$MUTIL.setCssStyles(img,{left:(oldRect.left+oldCenter.x-newCenter.x)+"px",top:(oldRect.top+oldCenter.y-newCenter.y)+"px"});}},getCenter:function getCenter(){return this.toRaw(_getScreenCenter.call(this));},toScreen:function toScreen(point){var imgBox=_getBaseImgRect.call(this),rawImgBox=_getBaseImgRawSize.call(this),zoom;if(!imgBox||!point||!$MUTIL.checkVal(point.x)||!$MUTIL.checkVal(point.y)){$MUTIL.log("Catch invalid point");return ;}zoom=imgBox.width/rawImgBox.width;return{x:point.x*zoom+imgBox.left,y:point.y*zoom+imgBox.top};},toRaw:function toRaw(pixel){var imgBox=_getBaseImgRect.call(this),rawSize=_getBaseImgRawSize.call(this),zoom;if(!imgBox||!pixel||!$MUTIL.checkVal(pixel.x)||!$MUTIL.checkVal(pixel.y)){$MUTIL.log("Catch invalid map/point/projection");return ;}zoom=imgBox.width/rawSize.width;return{x:(pixel.x-imgBox.left)/zoom,y:(pixel.y-imgBox.top)/zoom};},destroy:function destroy(){this._eventMap=null;this.img=null;}});})();