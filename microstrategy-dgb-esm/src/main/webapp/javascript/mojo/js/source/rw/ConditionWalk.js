(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.dom","mstrmojo.expr","mstrmojo.hash","mstrmojo.Container","mstrmojo._HasLayout","mstrmojo._HasPopup","mstrmojo.ui.ColumnWalk","mstrmojo.Button","mstrmojo.mstr.EnumNodeDimty","mstrmojo.ConditionModel","mstrmojo.rw.ConditionWalkProvider");var $WIDGET=mstrmojo.Widget,$ARR=mstrmojo.array,$DOM=mstrmojo.dom,$HASH=mstrmojo.hash,DMT=mstrmojo.mstr.EnumNodeDimty,setTip=mstrmojo.rw.ConditionWalkProvider.setTip,$EXPR=mstrmojo.expr,$EXPRTYPE=$EXPR.ET;var TIP_STATE_0=mstrmojo.desc(11899,"Select a dataset object.");var DEFAULT_DIMTY_TYPES=$ARR.hash([DMT.NodeDimtyOutputLevel]);function attachModel(){var model=this.model;if(model){if(!model.attachEventListener){$HASH.make(model,mstrmojo.ConditionModel,{});}model.attachEventListener("edit",this.id,"onmodeledit");}}function detachModel(me,m){if(m&&m.detachEventListener){m.detachEventListener("edit",me.id,"onmodeledit");}}function _getAttributeForms(did,dss){var dataSets=dss,attributeSet=[],temp=[],forms=[],isDA=false;$HASH.forEach(dataSets,function(dataset){attributeSet=attributeSet.concat(dataset.att.filter(function(attribute){return attribute.did===did;}));});isDA=attributeSet[0]&&attributeSet[0].da;attributeSet.forEach(function(attribute){temp=temp.concat(attribute.fs||[]);});temp.forEach(function(form){if((form.obf||isDA)&&forms.filter(function(fm){return fm.did===form.fid;}).length===0){forms.push({did:form.fid,dtp:mstrmojo.expr.mapBaseFormTypeToDataType(form.bftp),n:form.fnm,t:form.t,isbf:form.isbf});}});return forms;}function _isMdxDM(mdid,dss){var mxSet,datasets=dss,ds,res=false;if(typeof microstrategy!=="undefined"){datasets=datasets||microstrategy.bones.rwb_viewer.datasetInfos;}$HASH.forEach(datasets,function(dataset){mxSet=dataset.mx;$HASH.forEach(mxSet,function(mx){if(mx.did===mdid){ds=dataset;res=mx.um||mx.rdm;return false;}});return !ds;});return res&&ds&&ds.isMDX;}mstrmojo.rw.ConditionWalk=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasLayout,mstrmojo._HasPopup],{scriptClass:"mstrmojo.rw.ConditionWalk",markupString:'<div class="mstrmojo-rw-ConditionWalk" mstrAttach:click><div class="condition mstrmojo-ConditionNode"><div class="mstrmojo-cond-contents"></div></div><div class="walk"></div><div class="apply"></div></div>',markupSlots:{conditionNode:function(){return this.domNode.firstChild;},walkNode:function(){return this.domNode.children[1];},applyNode:function(){return this.domNode.lastChild;}},markupMethods:{onvisibleChange:function onvisibleChange(){$WIDGET.visibleMarkupMethod.call(this);if(this.visible){this.initWalk();}},onheightChange:$WIDGET.heightMarkupMethod,onwidthChange:$WIDGET.widthMarkupMethod},layoutConfig:{h:{conditionNode:"auto",walkNode:"100%",applyNode:"auto"},xt:true},editor:undefined,columnWalk:undefined,tip:undefined,walkProvider:null,objectBrowsingEnabled:true,postCreate:function postCreate(){if(this._super){this._super();}if(!this.walkProvider){this.walkProvider=mstrmojo.insert(mstrmojo.rw.ConditionWalkProvider);}},initWalk:function initWalk(){var columnWalk=this.columnWalk,walkProvider=this.walkProvider;setTip.call(this,TIP_STATE_0);columnWalk.removeTrailingContainer(-1);columnWalk.addNextColumn(walkProvider.getTargetNodeProps());columnWalk.target.updateColumnContainer();this.updateOkBtn();},updateBrowseElementsParams:function(params,attribute){params.attributeID=attribute.did;params.otp=attribute.t||12;var editor=this.editor,fn=editor&&editor.onUpdateBrowseElementsParams;if(fn){fn.call(editor,params,attribute);}},children:[{scriptClass:"mstrmojo.ui.ColumnWalk",alias:"columnWalk",slot:"walkNode",height:"333px",width:"750px"},{alias:"cancelBtn",slot:"applyNode",scriptClass:"mstrmojo.Button",cssClass:"cancelBtn",title:mstrmojo.desc(2399,"Cancel"),ignoreLayout:true,onclick:function(){var p=this.parent;if(p.close){p.close();}}},{alias:"okBtn",slot:"applyNode",scriptClass:"mstrmojo.Button",cssClass:"okBtn",title:mstrmojo.desc(2397,"OK"),onclick:function(){var p=this.parent;if(p.onOK){p.onOK();}}},{scriptClass:"mstrmojo.Label",alias:"tip",slot:"applyNode",cssClass:"tip",text:TIP_STATE_0,ignoreLayout:true}],eb:{scriptClass:"mstrmojo.Editor",cssClass:$DOM.isIE7?"mstrmojo-ElementsEditorIE7":"mstrmojo-ElementsEditor",title:mstrmojo.desc(6149,"Select Elements"),help:"element_browser_dialog_box.htm",children:[{scriptClass:"mstrmojo.ElementsBrowser",alias:"browser",onUpdateBrowseElementsParams:function(params){var walk=this.parent.opener;walk.updateBrowseElementsParams(params,walk.model.a);}},{scriptClass:"mstrmojo.HBox",cssClass:"mstrmojo-Editor-buttonBox",slot:"buttonNode",children:[{scriptClass:"mstrmojo.Button",alias:"ok",text:mstrmojo.desc(1442,"OK"),cssClass:"mstrmojo-WebButton hot",cssText:"width: 66px;",onclick:function(){var editor=this.parent.parent,o=editor&&editor.opener;if(o){o.onEBSelect();o.closePopup();}}},{scriptClass:"mstrmojo.Button",alias:"ok",text:mstrmojo.desc(221,"Cancel"),cssClass:"mstrmojo-WebButton",cssText:"min-width: 66px; margin-left: 11px;",onclick:function(){var editor=this.parent.parent,o=editor&&editor.opener;if(o){o.closePopup();}}}]}]},ob:{scriptClass:"mstrmojo.Editor",title:mstrmojo.desc(5298,"Select an Object"),help:"Select_Objects_dialog_box_.htm",children:[{scriptClass:"mstrmojo.ObjectBrowser",alias:"browser",fishEyeVisible:false,upButtonVisible:true,scrollableIncFetch:true,showCompletePath:false,closeable:false,closeOnSelect:false,browsableTypes:"3,4,8,10,12,256",includeObjectDesc:true,quickSearch:true,minSearchLength:1}]},_set_model:function _set_model(n,v){var vWas=this.model,chg=(v!==vWas);if(chg){detachModel.call(this,vWas);v.dimtyTypes=this.dimtyTypes||DEFAULT_DIMTY_TYPES;this.model=v;attachModel.call(this,v);if(this.hasRendered&&this.visible){this.columnWalk.target.updateColumnContainer();}}return chg;},onmodeledit:function onmodeledit(evt){var editedBox=evt.prop,isColumn0=editedBox==="c0"||editedBox==="c1",provider=this.columnWalk[isColumn0?"c0":editedBox];if(isColumn0){provider.c1Selected=editedBox==="c1";}provider.updateColumnContainer();provider.c1Selected=false;this.updateOkBtn();},browse:function bws(childWidget){var prn=this.parent.editorNode,pos=function(el,pr){var pl=mstrmojo.dom.position(el,true),pt=mstrmojo.dom.position(pr,true);return{x:pl.x+pl.w,y:pt.y};},columnWalk=this.columnWalk,walkProvider=this.walkProvider;switch(childWidget&&childWidget.alias){case"target":case"dmy":walkProvider.browseObjs(this,childWidget,pos(childWidget.alias==="target"?columnWalk.target.domNode:this.dmyNode,prn));break;case"c0":case"c1":walkProvider.browseObjs(this,childWidget,pos(columnWalk.c0.domNode,prn));break;case"es":walkProvider.browseEs(this,childWidget,pos(columnWalk.es.domNode,prn));break;}},onOBSelect:function(item){var ob=this.ob.browser,op=ob.target;this.closePopup();var targets=this.targets,f=op.itemIdField,ts=targets||[],idx=$ARR.find(targets,f,item[f]);if(idx===-1){ts.push(item);this.targets=ts;this.targetsLastMod=new Date();this.raiseEvent({name:"updateTargets",targets:this.targets});}op.setSelectedItems([item],op.multiSelect);if(op.onObjBrowsed){op.onObjBrowsed(item);}},onEBSelect:function(){var eb=this.eb.browser,es=this.columnWalk.es.es;es.set("selectedIndices",{});var items=es.items,itemsToAdd=[];$ARR.forEach(eb.selectedItems||[],function(item){if($ARR.find(es.items,"v",item.v)<0){itemsToAdd.push(item);}});var pos=es.insertUnlistedValuesAt||0;if(pos<0){pos=items.length;}es.set("items",items.slice(0,pos).concat(itemsToAdd).concat(items.slice(pos)));es.setSelectedItems(eb.selectedItems,false);},destroy:function destroy(ignoreDom){var walkProvider=this.walkProvider;if(walkProvider&&walkProvider.destroy){this.walkProvider.destroy();}this._super(ignoreDom);},updateOkBtn:function updateOkBtn(){var valid=true,model=this.model,i,count=model&&$EXPR.fnCstCount(model.fn,model.fnt);if(!model){return ;}switch(model.et){case $EXPRTYPE.AQ:case $EXPRTYPE.AL:case $EXPRTYPE.MQ:for(i=0;i<count;i++){valid=valid&&!this["invalid"+i];}break;}valid=valid&&!!model.completed;this.okBtn.set("visible",valid);this.raiseEvent({name:"conditionWalkUpdateOkBtn",valid:valid});}});mstrmojo.rw.ConditionWalk.getAttForms=_getAttributeForms;mstrmojo.rw.ConditionWalk.isMdxDM=_isMdxDM;}());