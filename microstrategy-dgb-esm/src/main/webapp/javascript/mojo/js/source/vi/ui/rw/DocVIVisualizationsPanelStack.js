(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.css","mstrmojo._HasLayout","mstrmojo._HasBuilder","mstrmojo._IsPanelStack","mstrmojo._IsSelectorTarget","mstrmojo.string","mstrmojo.vi._MonitorsAppState","mstrmojo.vi.ui.rw._IsPanelStack","mstrmojo.vi.ui.rw.DockedPanelSelector","mstrmojo.vi.ui.rw._SavesChildPositions","mstrmojo.vi.ui.tabs.PanelTabStrip","mstrmojo.vi.controllers.EnumLayoutSelectorPosition","mstrmojo.vi.controllers.EnumPanelManipulationType","mstrmojo.vi.controllers.EnumEvents","mstrmojo.vi.ui.rw._HasBufferSlice","mstrmojo.array");mstrmojo.requiresDescs(4780);var $ARR=mstrmojo.array,$CSS=mstrmojo.css,$STR=mstrmojo.string,OLD_LT_BG_CLR="#d6d6d6",DT_BG_CLR="#323335",LAYOUT_SELECTOR_POSITION=mstrmojo.vi.controllers.EnumLayoutSelectorPosition,PANEL_MANIPULATION_TYPE=mstrmojo.vi.controllers.EnumPanelManipulationType,EVENTS=mstrmojo.vi.controllers.EnumEvents;function onContentPanelVisibleChange(evt){var model=this.model,selectorPosition=model.tsp,isVisible=evt.visible,selector=this.selector,hasRendered=selector.hasRendered;var slot=(selectorPosition===LAYOUT_SELECTOR_POSITION.LEFT||!isVisible)?"":(selectorPosition!==LAYOUT_SELECTOR_POSITION.TOP?"bottom":"top");if(hasRendered||slot){this.removeChildren(selector);}selector.slot=slot+"SelectorNode";selector.set("alignPosition",selectorPosition);if(hasRendered||slot){this.addChildren([selector]);}if(model.getCurrentLayoutKey()===model.getLayoutKeyByUnitKey(this.k)){this.doLayout();}}function updateSelectorPosition(){var selector=this.selector,model=this.model,selectorPosition=model.tsp,hasRendered=selector.hasRendered;var slot=selectorPosition===LAYOUT_SELECTOR_POSITION.LEFT||!mstrApp.rootCtrl.view.isCPVisible?"":(selectorPosition!==LAYOUT_SELECTOR_POSITION.TOP?"bottom":"top");if(hasRendered||slot){this.removeChildren(selector);}selector.slot=slot+"SelectorNode";selector.set("alignPosition",selectorPosition);if(hasRendered||slot){this.addChildren([selector]);}if(model.getCurrentLayoutKey()===model.getLayoutKeyByUnitKey(this.k)){this.doLayout();}}mstrmojo.vi.ui.rw.DocVIVisualizationsPanelStack=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasLayout,mstrmojo._HasBuilder,mstrmojo._IsPanelStack,mstrmojo.vi.ui.rw._IsPanelStack,mstrmojo.vi._MonitorsAppState,mstrmojo._IsSelectorTarget,mstrmojo.vi.ui.rw._SavesChildPositions,mstrmojo.vi.ui.rw._HasBufferSlice],{scriptClass:"mstrmojo.vi.ui.rw.DocVIVisualizationsPanelStack",markupString:'<div id="{@id}" class="mstrmojo-VIVizPanel {@cssClass}" style="{@cssText}"><div class="mstrmojo-VIVizPanel-top-selector"></div><div class="mstrmojo-VIVizPanel-content"></div><div class="mstrmojo-VIVizPanel-selector"></div><div class="mstrmojo-VIDND-mask"></div></div>',markupSlots:{topSelectorNode:function(){return this.domNode.firstChild;},containerNode:function(){return this.domNode.childNodes[1];},bottomSelectorNode:function(){return this.domNode.childNodes[2];},maskNode:function(){return this.domNode.lastChild;}},markupMethods:{onvisibleChange:mstrmojo.Widget.visibleMarkupMethod},layoutConfig:{h:{topSelectorNode:"auto",containerNode:"100%",bottomSelectorNode:"auto"},w:{topSelectorNode:"100%",containerNode:"100%",bottomSelectorNode:"100%"},xt:true},getLayoutOffsets:function getLayoutOffsets(){return{h:2,w:2};},panels:null,model:null,selector:null,init:function init(props){this._super(props);var model=this.model;model.attachEventListener("tspChange",this.id,updateSelectorPosition);if(mstrApp.supportFeature(mstrmojo.vi.enums.EnumFeatures.SUPPORT_TOC_UPDATEPOISITION)){mstrApp.rootCtrl.view.attachEventListener(EVENTS.CONTENTS_PANEL_VISIBILITY_CHANGE,this.id,onContentPanelVisibleChange);}updateSelectorPosition.call(this);},children:[{scriptClass:"mstrmojo.vi.ui.tabs.PanelTabStrip",alias:"selector"}],postBuildRendering:function postBuildRendering(){this._super();var parent=this.parent,formats=parent&&parent.defn&&parent.defn.fmts,gdColor=formats&&formats.fx&&formats.fx.gd,bgColor=formats&&formats["background-color"];if(gdColor&&gdColor.sc){var gradient=$CSS.buildGradient(gdColor.t,gdColor.sc,gdColor.ec);gradient&&(this.domNode.style[gradient.n]=gradient.v);}else{if(bgColor&&!(bgColor===OLD_LT_BG_CLR||bgColor===DT_BG_CLR)){this.domNode.style.backgroundColor=bgColor;}}},addChildren:function addChildren(children,idx,silent,skipPanelSelector){var firstChild=children[0];if(firstChild&&firstChild.hasOwnProperty("k")){this.panels=(this.panels||[]).concat(children);if(!skipPanelSelector){this.notifyPanelSelector();}}return this._super(children,idx,silent);},removeChildren:function removeChildren(c,silent){if(c){var removedPanelKeys=[].concat(c).map(function(child){return child.k;});this.panels=(this.panels||[]).filter(function(panel){return removedPanelKeys.indexOf(panel.k)===-1;});}this._super(c,silent);},_set_children:function setCh(n,v,silent){if(v!==this.children){var selector=this.selector;if(selector){v.push(selector);}}return this._super(n,v,silent);},onAppStateChange:function onAppStateChange(evt){var appStates=mstrmojo.vi.VisualInsightApp.APP_STATES,presentationMode=appStates.PRESENTATION,pauseMode=appStates.PAUSE;if(evt.value&presentationMode||evt.valueWas&presentationMode){updateSelectorPosition.call(this);}var isPause=evt.value&pauseMode,wasPause=evt.valueWas&pauseMode;if(isPause&&!wasPause){this.defn.set("disableSelectionApply",true);}if(wasPause&&!isPause){this.defn.set("disableSelectionApply",false);}},hasDisabledSelectionApply:function hasDisabledSelectionApply(){var defn=this.defn||this.node.defn;return !!defn.disableSelectionApply;},notifyPanelSelector:function notifyPanelSelector(silent){this.selector.setTabs(this.panels,this.selectedKey);if(!silent){this.doLayout();}},selectPanelDeferred:function(update,key,hasLoader,skipServerCall){if(key!==this.selectedKey){this._super(update,key,hasLoader,skipServerCall);}},onpanelSelected:function onpanelSelected(){this.notifyPanelSelector();this.getSelectedPanel().buildBoxLayout();},removePanel:function removePanel(panel){var panels=this.panels,deleteIdx=panels.indexOf(panel),deletedPanel=panels[deleteIdx],res;panels.splice(deleteIdx,1);res=this.removeChildren(deletedPanel);return res;},removePanelsByIndex:function removePanel(index){var panels=this.panels,me=this,deleteIdx=[].concat(index),deletedPanel=[],res;$ARR.forEach(deleteIdx,function(item){deletedPanel.push(panels[item]);});deleteIdx.sort(function(a,b){return b-a;});$ARR.forEach(deleteIdx,function(item){panels.splice(item,1);});$ARR.forEach(deletedPanel,function(item){me.removeChildren(item);item.selected=false;});},changePanelPosition:function changePanelPosition(panelToMove,from,to,childIdx,selectedIdx){var children=this.children,panels=this.panels;panels.splice(from,1);children.splice(childIdx,1);panels.splice(to,0,panelToMove);children.splice(childIdx+to-from,0,panelToMove);this.selectedIdx=selectedIdx;this.notifyPanelSelector();},sortPanels:function sortPanels(selectedIdx){var children=this.children||[],panels=this.panels||[];panels.sort(function(a,b){return a.defn.chdidx-b.defn.chdidx;});$ARR.forEach(panels,function(panel){var index=children.indexOf(panel);children.splice(index,1);});$ARR.forEach(panels,function(panel){children.push(panel);});this.selectedIdx=selectedIdx;this.notifyPanelSelector();},deletePanel:function deletePanel(panel){var model=this.model,stack=this;model.raiseEvent({name:EVENTS.MANIPULATE_PANEL,type:PANEL_MANIPULATION_TYPE.DELETE,panelKeys:[panel.k],panelStackKey:stack.k,layoutKey:model.getLayoutKeyByUnitKey(stack.k)});},movePanel:function movePanel(fromIdx,toIdx){var model=this.model,stack=this,panel=stack.panels[fromIdx];model.raiseEvent({name:EVENTS.MANIPULATE_PANEL,type:PANEL_MANIPULATION_TYPE.MOVE,panelKey:panel.k,panelKeys:[panel.k],panelStackKey:stack.k,layoutKey:model.getLayoutKeyByUnitKey(stack.k),fromIdx:fromIdx,toIdx:toIdx});},renamePanel:function renamePanel(panel,title){var model=this.model,stack=this;model.raiseEvent({name:EVENTS.MANIPULATE_PANEL,type:PANEL_MANIPULATION_TYPE.RENAME,panelKey:panel.k,panelStackKey:stack.k,layoutKey:model.getLayoutKeyByUnitKey(stack.k),newTitle:title,oldTitle:panel.title});},addPanel:function addPanel(){var model=this.model,stack=this;model.raiseEvent({name:EVENTS.MANIPULATE_PANEL,type:PANEL_MANIPULATION_TYPE.NEW,panelStackKey:stack.k,layoutKey:model.getLayoutKeyByUnitKey(stack.k)});},duplicatePanel:function duplicatePanel(panel){var model=this.model,stack=this;model.raiseEvent({name:EVENTS.MANIPULATE_PANEL,type:PANEL_MANIPULATION_TYPE.DUPLICATE,panelKey:panel.k,panelStackKey:stack.k,layoutKey:model.getLayoutKeyByUnitKey(stack.k)});},getUIState:function getUIState(){var state={},panel=this.getSelectedPanel();state.pk=panel.k;state.boxState=panel.getBoxState();state.viUnitKey=this.model.getSelectedViUnit()&&this.model.getSelectedViUnit().k;return state;},restoreUIState:function restoreUIState(state){var panel=this.getSelectedPanel(),pk=state.pk;if(pk&&panel.k!==pk){this.selectPanel(pk,null,true);panel=this.getSelectedPanel();}var selectedUnitKey=state.viUnitKey;if(selectedUnitKey){var unit=panel.getUnitByKey(selectedUnitKey);if(unit){this.model.selectVIUnit(unit.id,true);}}var boxState=state.boxState;if(boxState!==panel.getBoxState()){panel.restoreBoxState(boxState);}}});}());