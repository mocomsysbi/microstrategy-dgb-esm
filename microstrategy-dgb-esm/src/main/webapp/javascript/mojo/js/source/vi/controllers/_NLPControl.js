(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.func","mstrmojo.vi.viz.KnownVisualizations","mstrmojo.hash","mstrmojo.mstr.EnumDataType","mstrmojo.fe.FilterUtils","mstrmojo.vi.ui.DatasetUnitMenuUtils","mstrmojo.DocDataService","mstrmojo.UUID");var $WRAP=mstrmojo.func.wrapMethods,$A=mstrmojo.array,$HASH=mstrmojo.hash,$ENUM_DT=mstrmojo.mstr.EnumDataType,$GET_EXPR_XML=mstrmojo.fe.FilterUtils.getExprXml,$DU=mstrmojo.vi.ui.DatasetUnitMenuUtils;function getSortActionForSmartViz(sorts,nodeKey,toViz){var style=toViz.s||"",item=sorts[0],unitId=item.did,zoneId=item.zoneId,isMetric=item.t===4,fid=isMetric?"":item.fid,isAsc=item.isAsc!==undefined?item.isAsc:false;var AXIS_MAP,axis;if(style===""||style==="VIHeatMapVisualizationStyle"){return{act:"updateTemplate",keyContext:nodeKey,actions:[{act:"sort",sorts:[[{key:item.t+"!"+unitId+"!"+(isMetric?"":fid)+"!"+(isMetric?"":"21")+"!!1",isAsc:isAsc}]],nodeKey:nodeKey,subTotalsPos:[0],stt:-1}]};}else{if(style==="GraphMatrixVisualizationStyle"){var sortGMAction={act:"sortGM",nodeKey:nodeKey,subActions:[]};if(isMetric){AXIS_MAP={4:2,3:1};axis=AXIS_MAP[zoneId];if(!axis){return null;}sortGMAction.subActions.push({sortIndex:0,sortType:1,objType:4,objID:unitId,ascending:isAsc,axisIndex:axis,subtotalsPosition:0,eIds:[{n:"Cost",id:"CD:"+unitId,oid:unitId,otp:4,at:12,prop:{"VLDB Select":[{n:"Metric Join Type",dt:3,v:"1"}]},cds:true,tid:"",gvsRI:0,gvsCI:0,axis:axis}],formId:null,actionId:26});}else{AXIS_MAP={4:1,3:2};axis=AXIS_MAP[zoneId];if(!axis){return null;}sortGMAction.subActions.push({sortIndex:0,sortType:3,objType:12,objID:unitId,ascending:isAsc,axisIndex:axis,subtotalsPosition:0,eIds:null,formId:fid,actionId:26});}return sortGMAction;}}}function getThresholdForSmartViz(item,key){return{act:"threshold",nodeKey:key,thresholds:[{fmt:{FormattingPatterns:{FillColor:2434508,FillStyle:0}},ceil:10},{fmt:{FormattingPatterns:{FillColor:4934627,FillStyle:0}},flr:10,ceil:30},{fmt:{FormattingPatterns:{FillColor:8224233,FillStyle:0}},flr:30,ceil:50},{fmt:{FormattingPatterns:{FillColor:7984249,FillStyle:0}},flr:50,ceil:70},{fmt:{FormattingPatterns:{FillColor:5749335,FillStyle:0}},flr:70,ceil:90},{fmt:{FormattingPatterns:{FillColor:2924588,FillStyle:0}},flr:90}],thresholdType:1,basedOnId:item.did,did:item.did,objType:4};}function getMapThresholdForSmartViz(item,key){return{act:"threshold",nodeKey:key,thresholds:[{fmt:{FormattingPatterns:{FillColor:6176253,FillStyle:0}},ceil:33},{fmt:{FormattingPatterns:{FillColor:2404607,FillStyle:0}},flr:33,ceil:67},{fmt:{FormattingPatterns:{FillColor:9818658,FillStyle:0}},flr:67,ceil:100}],thresholdType:1,basedOnId:item.did,did:item.did,objType:4};}function getDrivedMetricFormulaForSmartViz(item){var FN_MAP={Max:"8107C31FDD9911D3B98100C04F2233EA",Min:"8107C31EDD9911D3B98100C04F2233EA",Avg:"8107C31DDD9911D3B98100C04F2233EA",Count:"8107C31CDD9911D3B98100C04F2233EA",Sum:"8107C31BDD9911D3B98100C04F2233EA"};var fn=item.fn,n=item.n;return'<tknstrm ><items><tkn v="&amp;" tp="38" lv="4"></tkn><tkn v="'+fn+'" tp="280" lv="4"><oi did="'+FN_MAP[fn]+'" t="11" st="2816" n="'+fn+'"></oi></tkn><tkn v="&lt;"></tkn><tkn v="UseLookupForAttributes"></tkn><tkn v="="></tkn><tkn v="False"></tkn><tkn v="&gt;"></tkn><tkn v="(" tp="40" lv="4"></tkn><tkn v="'+n+'" tp="266" lv="4"><oi did="'+item.did+'" t="'+item.t+'" st="'+item.st+'" n="'+n+'"></oi></tkn><tkn v=")" tp="41" lv="4"></tkn><tkn v="" tp="-1" lv="4"></tkn></items></tknstrm>';}mstrmojo.vi.controllers._NLPControl=mstrmojo.provide("mstrmojo.vi.controllers._NLPControl",{_mixinName:"mstrmojo.vi.controllers._NLPControl",getClearTemplateDropZoneActions:function getClearTemplateDropZoneActions(vizBox){var actions=[],xtabModel=vizBox.boxContent.model,controller=this,docModel=this.model,xtab=xtabModel.xtab,key=xtab.k,zonesModel=xtab.zonesModel,clearActions=zonesModel.getClearAllUnitsActions(),unTemplateActions=zonesModel.getClearAllUnitsUnTemplateActions(),visId=xtab.id,data=xtab.gridData||xtab.model.data||xtab.node.data,limitExpression=data.vlexpr,clearViewFilterCallback=$WRAP({success:function(){var visualization=mstrmojo.all[visId];if(visualization._viSelections){visualization.clearSelections();visualization.endSelections();}}},controller._getXtabCallback(xtab),{success:function success(){mstrmojo.all[visId].raiseEvent({name:"regenerateToolbar"});}}),otherActions=xtabModel.getKeepOnlyActionsForAssociatedNodes([],clearViewFilterCallback);if(clearActions.length>0){actions.push(docModel.getDataService().getUpdateTemplateAction(key,clearActions));}if(limitExpression){otherActions.actions.push(controller.dataService().getUpdateTemplateAction(xtab.k,xtabModel.getRemoveMetricLimitsAction(limitExpression)));}if(unTemplateActions&&unTemplateActions.length>0){otherActions.actions=otherActions.actions.concat(unTemplateActions);}if(otherActions.actions.length>0){actions=actions.concat(otherActions.actions);}return actions;},createSmartViz:function createSmartViz(vizInfo,datasetId,filters,sorts,title,useCurrentSelectedViz){var vizbox,docModel=this.model,controller=docModel.controller,items=vizInfo.objects,toViz=vizInfo.style,actions=[],me=this,needToCreateDM=false;items.forEach(function(item){if(item.isDM){needToCreateDM=true;}});var funcToCreateSmartViz=function(interim){var xtab=vizbox.boxContent,xtabModel=xtab.model,key=xtab.k,zonesModel=xtab.zonesModel,data=xtab.gridData||xtab.model.data||xtab.node.data;if(!useCurrentSelectedViz){docModel.getCurrentLayoutDef().units[key]={};data=xtab.gridData=xtab.model.data=xtab.node.data={k:key,wid:1,gsi:{rows:[],cols:[],mx:[],sorts:[[],[]],fmts:{rh:{},ch:{},va:{}},prop:{rows:{},cols:{},ln:"0"}}};}if(useCurrentSelectedViz){actions=actions.concat(this.getClearTemplateDropZoneActions(vizbox));}var layerKeys,changeVizActions=[],visName=data.visName,style=toViz.s||"",widgetType=toViz.wtp||0,ENUM_VIZ_STYLES=mstrmojo.vi.viz.EnumVizStyles,ENUM_DROZONES=mstrmojo.vi.viz.EnumDSSDropZones,isCurrentMapViz=visName===ENUM_VIZ_STYLES.ESRI_MAP||visName===ENUM_VIZ_STYLES.GOOGLE_MAP||visName===ENUM_VIZ_STYLES.MAPBOX,isChangeToMapViz=style===ENUM_VIZ_STYLES.ESRI_MAP||style===ENUM_VIZ_STYLES.GOOGLE_MAP||style===ENUM_VIZ_STYLES.MAPBOX,KNOWN_VIZ=mstrmojo.vi.viz.KnownVisualizations,visDefinition=KNOWN_VIZ.getDefinition(style),visTransition=controller.visTransitionFactory.newVisualizationTransition(style||"Grid",{vis:xtab,newVizInfo:{s:style,dz:toViz.dz}});if(isCurrentMapViz){layerKeys=docModel.getMapLayerKeys(xtab);changeVizActions=docModel.getExtraActionsForChangeMapViz(xtab,layerKeys,changeVizActions);}if(style!==""&&visDefinition.id!==KNOWN_VIZ.UNKNOWN){changeVizActions.push({act:"updateTemplate",keyContext:key,actions:[{act:"createDefaultDropZones",nodeKey:key,treeType:xtab.defn.tt,datasetId:data.datasetId,datasetType:3,widgetType:widgetType,partialUpdate:{nodes:[key]}}]});}var transitionData=visTransition?visTransition.transitionDropZones([],toViz.vt):{wp:""},widgetProps=vizInfo.widgetProps||transitionData.wp,widgetName=transitionData.wgtName,widgetClassName=docModel.getWidgetClassNameByStyle(style,widgetType),extraFormatting=widgetName?({FormattingAppearance:{Name:widgetName}}):undefined;changeVizActions.push(docModel.getUnitChangeVizAction(style,widgetClassName,xtab.parent,widgetProps,extraFormatting));changeVizActions.push({act:"changeGridDisplayMode",nodeKey:key,displayMode:style===ENUM_VIZ_STYLES.GRAPH_MATRIX?2:1});actions=actions.concat(changeVizActions);var newFmtUnits=[],addUnitActions=[],dataSourceId,metricDataSourceId,isTemplateDropZone=function isTemplateDropZone(zoneId){return zoneId===-1||zoneId===1||zoneId===2;};items.reverse().forEach(function(item){var isMetric=item.t===4,zoneId=item.zoneId?item.zoneId:(isMetric?-1:1),dsId=item.datasetId||datasetId,isTemplate=isTemplateDropZone(zoneId);if(!isMetric){dataSourceId=dataSourceId||dsId;}else{metricDataSourceId=metricDataSourceId||dsId;}if(isTemplate){addUnitActions.push(xtabModel.getAddTemplateUnitAction(item,item.datasetId,zoneId,0));}else{addUnitActions=addUnitActions.concat(zonesModel.getAddDropZoneUnitsActions({id:zoneId},[item],0,{datasetId:dsId})||[]);if(zoneId===7&&isMetric){addUnitActions.push(style==="GoogleMapVisualizationStyle"?getMapThresholdForSmartViz(item,key):getThresholdForSmartViz(item,key));}var ac=zonesModel.getAddDropZoneUnitsActions({id:zoneId},[item],0,{datasetId:dsId})||[],grpAction=ac&&ac[0];if(zoneId===ENUM_DROZONES.ColorBy&&!isMetric&&style==="VIHeatMapVisualizationStyle"){if(grpAction&&grpAction.zoneId){grpAction.zoneId=ENUM_DROZONES.Grouping;addUnitActions.push(grpAction);}}if(zoneId===ENUM_DROZONES.AdditionalMetrics&&isMetric&&style==="MapboxVisualizationStyle"){if(grpAction&&grpAction.zoneId){grpAction.zoneId=ENUM_DROZONES.ColorBy;addUnitActions.push(grpAction);}addUnitActions.push(getMapThresholdForSmartViz(item,key));}if(item.lat&&item.lng&&isChangeToMapViz){addUnitActions.push({act:"addForm",unitId:item.did,attFormId:item.lat,unitPos:1});addUnitActions=addUnitActions.concat(zonesModel.getAddDropZoneUnitsActions({id:17},[{did:item.lat,t:21}],0,{datasetId:dsId}));addUnitActions.push({act:"addForm",unitId:item.did,attFormId:item.lng,unitPos:1});addUnitActions=addUnitActions.concat(zonesModel.getAddDropZoneUnitsActions({id:18},[{did:item.lng,t:21}],0,{datasetId:dsId}));}}if(isMetric){newFmtUnits.push(item);}},xtabModel);if(newFmtUnits.length){addUnitActions.push(xtabModel.getValuesDefaultFormatGridZoneAction(newFmtUnits,true));}actions.push(docModel.getDataService().getUpdateTemplateAction(key,addUnitActions));dataSourceId=metricDataSourceId||dataSourceId;if(dataSourceId){actions.push({act:"editNode",nodeKey:key,datasetId:dataSourceId});}var mockFilterModelManipulation=function(res){filters=filters||[];if(filters.length<=0){return ;}var filterModel=mstrmojo.insert(res);var limitMdxUnitIdsHashTable=xtab.parent.getLimitMdxUnitIdsHashTable(res);filterModel.limitExpr={et:14,fn:19,nds:[]};filterModel.expr={et:14,fn:19,nds:[]};var templateNode;$A.forEach(filters,function(item){if(["top","bottom","greater","less","equal"].indexOf(item.fn)>-1){templateNode={m:{did:item.did,dsid:item.dsid||filterModel.dsid,title:item.n,st:item.st||1024,n:item.n,t:item.t||4,um:false},mdxUnitId:item.did};}var conditionalObject={fn:0,fnt:0,et:0,m:null,cs:[{v:0,dtp:$ENUM_DT.DataTypeNumeric}]};var conditions={top:[13,2,10],bottom:[2,2,10],greater:[8,1,10],less:[9,1,10],equal:[6,1,10]};var setConditionalObj=function setConditionalObj(item){var condition=item.fn;if(condition==="in"){return null;}var newObj=$HASH.copy(conditionalObject);var con=conditions[condition];newObj.fn=con[0];newObj.fnt=con[1];newObj.et=con[2];newObj.cs[0].v=item.v;if(condition==="top"||condition==="bottom"){var additionalCS={v:1,dtp:$ENUM_DT.DataTypeNumeric};newObj.cs.unshift(additionalCS);}return newObj;};var reqObj=setConditionalObj(item);if(reqObj){filterModel.limitExpr.nds.push($HASH.copy(templateNode,reqObj));}});var currentLimitMdxUnitIdsHashTb=xtab.parent.getLimitMdxUnitIdsHashTable(filterModel),limitMdxUnitIdsToRemove=[];$HASH.forEach(limitMdxUnitIdsHashTable,function(item,key){if(!currentLimitMdxUnitIdsHashTb[key]){limitMdxUnitIdsToRemove=limitMdxUnitIdsToRemove.concat({did:key,t:4});}});var params={expr:$GET_EXPR_XML(filterModel.expr),limitExp:$GET_EXPR_XML(filterModel.limitExpr),nodeKey:xtab.k,limitMdxToRemove:limitMdxUnitIdsToRemove};var actionFilter={act:"saveViewFilter",messageID:filterModel.messageID,nodeKey:params.nodeKey,expr:params.expr};var actionLimit={act:"saveViewFilterLimit",messageID:filterModel.messageID,nodeKey:params.nodeKey,limitExp:params.limitExp,limitToRemove:params.limitMdxToRemove||[]};actions.push(actionFilter);actions.push(actionLimit);};docModel.getViewFilter({nodeKey:key,msgID:docModel.mid},{success:mockFilterModelManipulation});if(sorts&&sorts.length>0){sorts.forEach(function(sort){var obj=items.filter(function(item){return item.did===sort.did;})[0];sort.zoneId=obj?obj.zoneId:0;});var sortActions=getSortActionForSmartViz(sorts,key,toViz);if(sortActions){actions.push(sortActions);}}if(title){actions.push({act:"format",unitKey:key,unitType:522,formatType:1,format:{FormattingView:{Title:title}}});}var getUpdateCallback=function getUpdateCallback(){var boxKey=xtab.parent.k;return{success:function(){docModel.getPanel().getUnitByKey(boxKey).selectVIUnit(true);}};};var callbacks=$WRAP({success:function success(res){var currentLayoutKey=this.getCurrentLayoutKey(),panel=this.getPanel(),panelKey=panel.k;this.refreshDefinition(key,this.getRawLayoutUnitDefn(key,res.defn));this.updateDataCache(res.data,this.getTargetDefn([key]));if(this.getLayoutDataCache(currentLayoutKey)[panel.id]){var tree=$A.filterOne(this.data.layouts,function(l){return(l.k===currentLayoutKey);});this.updateDataCache({layouts:[tree]},this.getTargetDefn(panelKey));}if(res.data){res.data.layouts.some(function(layout){var isCurrentLayout=layout.k===currentLayoutKey;if(isCurrentLayout){this.controller.view.updateXtabStyles(currentLayoutKey,layout.xtabStyles);}return isCurrentLayout;},this);}this.selectVIUnit(panel.rebuildChild(panel.getUnitByKey(key)).id,true);}.bind(docModel)},controller._getXtabCallback(xtab),{success:function(res){docModel.partialUpdate(res.data,docModel.getUnitDefinitions(key));}},getUpdateCallback());if(!interim){controller.submitUndoRedoUpdates(actions,null,callbacks,mstrmojo.DocDataService.REQUEST_DEFN_DATA);}else{var update=docModel.getDataService().newUpdateWithoutCmd({actions:actions,callback:callbacks,extras:mstrmojo.DocDataService.REQUEST_DEFN_DATA});update.cmd=docModel.cmdMgr().getInterimCmd();update.submit();}};vizbox=docModel.getSelectedViUnit();if(useCurrentSelectedViz&&!needToCreateDM){funcToCreateSmartViz.call(this);}else{docModel.execute({execute:function execute(){var dataService=docModel.getDataService(),update=dataService.newUpdate(this),panelKey=docModel.getPanel().k;if(!useCurrentSelectedViz){vizbox=docModel.addVisualizationDeferred(update,panelKey);}update.extras={params:{suppressData:true}};update.callback.success=mstrmojo.emptyFn;if(needToCreateDM){var createDMActions=[],uid=mstrmojo.UUID.create();items.forEach(function(item){if(item.isDM){var addDerivedMetricAction={act:"addDerivedMetricToDataset",dsid:item.datasetId||datasetId,formula:getDrivedMetricFormulaForSmartViz(item),isTokenStream:true,name:item.dmName,newObjectIds:[uid]};createDMActions.push(addDerivedMetricAction);return false;}});update.addActions(createDMActions);update.extras={};update.addExtras(mstrmojo.DocDataService.REQUEST_ONLY_DATASETS);update.addCallbacks({success:function(res){docModel.als=res.als;docModel.updateDatasets(res.datasets,res.datasetsSettings);var newlyAddedDM=$DU.getUnitFromDataset(docModel.datasets,uid,4);var fnUpdateToken=function(item){if(item.isDM){item.isDM=undefined;item.dmName=undefined;item.st=undefined;$HASH.copy($HASH.clone(newlyAddedDM),item);}};items.forEach(fnUpdateToken);(filters||[]).forEach(fnUpdateToken);(sorts||[]).forEach(fnUpdateToken);}});}update.addCallbacks({success:function(){funcToCreateSmartViz.call(me,true);}});this.submitUpdate(update,docModel.cmdMgr().CMD_PHASE.FIRST);},urInfo:{treesToRender:3,disablePU:true,callback:controller.getRefreshCallback()}});}}});}());