(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.CheckBox","mstrmojo.StackContainer","mstrmojo.FileUploadBox","mstrmojo.DataGrid","mstrmojo.DI.DIHelpers","mstrmojo.fe.FilterEditor","mstrmojo.vi.ui.editors.FilterEditor","mstrmojo.fe.FilterUtils","mstrmojo.ui.menus.Menu","mstrmojo.ui.menus.MenuConfig","mstrmojo.qb.QBAlertDialog","mstrmojo.ui.DIPublishSimpleTree","mstrmojo.WidgetTree","mstrmojo.AS.DIAppSchemaRepublishTreeNode","mstrmojo.onetier.vi.ui.DBCredentialEditor","mstrmojo.AS.DIPublishAppSchemaSheetsMatchEditor","mstrmojo.AS.DIAppSchemaRepublishOAuthButton");mstrmojo.requiresDescs(187,221,773,1088,1302,2461,9117,9118,12085,12393,12394,12395,12396,12397,12398,12399,12400,12401,12402,12491,12751,12814,12837,13048,13049,13050,13051,13052,13053,13054,13055,13056,13057,13099,1825,13275,13276,13277,12949,13942,13943,13959,13960,13969,13970,13971,13972,14215,6098,14767,15212);var constants=mstrmojo.DI.DIConstants,MAX_FILE_SIZE=4*1024*1024,$A=mstrmojo.array,$H=mstrmojo.hash,$CSS=mstrmojo.css,$DOM=mstrmojo.dom,$DESC=mstrmojo.desc,$DIHelper=mstrmojo.DI.DIHelpers,EVENT_CAN_SAVE_SCHEDULE="canSaveSchedule",EVENT_CAN_START_REFRESH="canStartRefresh",tableStatusCls={"0":"tablestatus-col status waiting","1":"tablestatus-col status waiting","2":"tablestatus-col status waiting","3":"tablestatus-col status finished","4":"tablestatus-col status warning","5":"tablestatus-col status waiting","6":"tablestatus-col status warning"};function getPolicyTooltipHtml(){return'<div class="tooltip-container"><div class="div-upper"><div class="top-title">'+mstrmojo.desc(11411,"Sample Data")+'</div><div class="upper-title"><div class="inner-title">'+mstrmojo.desc(15101,"Existing data")+'</div><div class="inner-title right">'+mstrmojo.desc(8616,"New data")+'</div></div><div class="wide short existing-new"></div></div><div class="div-lower"><div class="top-title">'+mstrmojo.desc(15102,"Different Refresh Policies and Results")+'</div><div class="right-content"><div class="inner-title padding-top">'+mstrmojo.desc(9117,"Replace existing data")+'</div><div class="narrow short replace"></div><div class="inner-title">'+mstrmojo.desc(9118,"Update existing data and add new data")+'</div><div class="narrow tall update-addnew"></div><div class="inner-title">'+mstrmojo.desc(12397,"Update existing data")+'</div><div class="narrow short update"></div/><div class="inner-title">'+mstrmojo.desc(12398,"Add new data")+'</div><div class="narrow tall addnew"></div></div></div></div>';}function getOAuthInfo(sourceType,dbRoleId,accountId){var controller=mstrApp.getRootController(),model=controller.getModel();var callback={success:function(res){model.externalSources[sourceType].isLogin=true;model.externalSources[sourceType].hasFetchedOAuthInfo=true;model.externalSources[sourceType].userDisplayName=res.mi.sinf.un;model.externalSources[sourceType].userEmail=res.mi.sinf.ea;model.raiseEvent({name:"OAuthInfoUpdate"});},failure:function(res){mstrmojo.alert("Fetching OAuth information failed.");}};var requestParam={dbRoleID:dbRoleId,sourceAccountID:accountId};if(sourceType===constants.sourceType.googleBigQuery){requestParam.flags=constants.sourcesInfoFlags.getGAnalyticsAccount|constants.sourcesInfoFlags.getTokensInfo|constants.sourcesInfoFlags.getUserName;}if(!model.externalSources[sourceType].isFetchingInfo){controller.dataService.getOAuthSourceReports(callback,requestParam);}model.externalSources[sourceType].isFetchingInfo=true;}mstrmojo.AS.DIAppSchemaTableStatusList=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasPopup],{scriptClass:"mstrmojo.AS.DIAppSchemaTableStatusList",bHasRefreshCheckbox:true,bHasRefreshPolicy:true,title:null,importFileFunc:mstrmojo.func.emptyFn,forceFullPublish:true,operationMode:null,cubeID:null,items:null,hasIRR:false,markupString:'<div id="{@id}" class="mstrmojo-di-tablestatuslist mstrmojo-di-appschema-tablestatuslist {@cssClass}" style="{@cssText}"><div></div><div></div></div>',markupSlots:{titleNode:function(){return this.domNode.children[0];},listNode:function(){return this.domNode.children[1];}},markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";}},preBuildRendering:function(){var model=this.model;if(model){mstrmojo.hash.forEach(model.importSources,function(value){var index=model.appSchemaTables&&mstrmojo.array.find(model.appSchemaTables,"mstrEmmaTableId",value.key),physcialTables=model.appSchemaTables&&model.appSchemaTables[index],subItems=[];if(physcialTables&&physcialTables.tableGroups){physcialTables.tableGroups.forEach(function(tableGroup){tableGroup.forEach(function(table){subItems.push({n:table.name,id:table.id,isLeaf:true,dataSourceType:table.dataSourceType});});});}value.items=subItems;});}this.update();model.attachEventListener("PublishStatusUpdate",this.id,"updateStatus");model.attachEventListener("OAuthInfoUpdate",this.id,"OAuthInfoUpdate");if(this._super){this._super();}},updateStatus:function(evt){var me=this;if(evt&&evt.name){this.set("updateStarted",true);}if(evt&&evt.reset){this.set("updateStarted",false);window.setTimeout(function(){me.checkCanRefresh();},0);}},OAuthInfoUpdate:function(evt){this.list.render();},update:function(evt){var model=this.model,items=[];if(evt&&evt.name){this.set("updateStarted",true);}try{var pipeline=[];if(model&&model.appSchemaTables){pipeline=model.appSchemaTables.pipelineInfos;}else{if(this.items.pipelineInfos){pipeline=this.items.pipelineInfos;}}pipeline.forEach(function(pipeline){var emmaTableId=pipeline.mstrEmmaTableId,emmaTableName=pipeline.mstrEmmaTableName,dataSourceType,subItems=[],checked=true;pipeline.tableGroups.forEach(function(tableGroup){var ids=[],names=[],extra={},fileAvailable,oAuthInfoMissing,tableId,pipelineId,fileId,fileName;tableGroup.forEach(function(table){ids.push(table.id);names.push(table.name);dataSourceType=table.dataSourceType;fileAvailable=table.fileAvailable;oAuthInfoMissing=table.oAuthInfoMissing;pipelineId=pipeline.id;tableId=table.id;fileId=table.dataSource&&table.dataSource.fileId;fileName=table.dataSource&&table.dataSource.fileName;dbRoleId=table.dataSource.dbRoleId;accountId=table.dataSource.accountId;});ids=ids.join("/");names=names.join("/");subItems.push({id:ids,n:names,dataSourceType:dataSourceType,isLeaf:true,extra:extra,fileAvailable:fileAvailable,oAuthInfoMissing:oAuthInfoMissing,pipelineId:pipelineId,tableId:tableId,fileId:fileId,fileName:fileName,dbRoleId:dbRoleId,accountId:accountId});});var emmaTable=model.importSources[emmaTableId];if(emmaTable){emmaTable.id=emmaTableId;emmaTable.name=emmaTableName;emmaTable.dataSourceType=dataSourceType;emmaTable.items=subItems;emmaTable.checked=checked;}else{if(emmaTableId){model.importSources[emmaTableId]={id:emmaTableId,name:emmaTableName,dataSourceType:dataSourceType,items:subItems,checked:checked,tableID:emmaTableId};}}});mstrmojo.hash.forEach(model.importSources,function(table){items.push(table);});this.set("items",items);}catch(err){console.log(err);mstrmojo.alert("Error! No data received for publish!");}if(model){mstrmojo.hash.forEach(model.importSources,function(value){if(value.checked===undefined){value.checked=true;}});}},getFileUploader:function(tableID){var model=this.model;var r=null;if(model&&model.importSources[tableID]){r=model.importSources[tableID].fileUploader;}return r;},checkCanRefresh:function(){var rootController=mstrApp.getRootController&&mstrApp.getRootController(),model=this.model,operationMode=model.operationMode,allTableIds=model.getAllTableID(),canRefresh=true,cnt=0;if(operationMode===constants.operationMode.refresh){$A.forEach(allTableIds,function(id){var source=model.getImportSource(id);if(source.checked){cnt++;switch(source.dataSourceType){case constants.dataSourceType.FILE_LOCAL:$A.forEach(source.items,function(item){if(item.fileAvailable!==true&&item.hasSelectFile!==true&&item.hasUsedCache!==true){canRefresh=false;return false;}});break;case constants.dataSourceType.DROPBOX:case constants.dataSourceType.GOOGLE_ANALYTICS:case constants.dataSourceType.GOOGLE_BIGQUERY:case constants.dataSourceType.GOOGLE_DRIVE:case constants.dataSourceType.SALESFORCE:var sourceType=$DIHelper.convertDataSourceType2SourceType(source.dataSourceType);$A.forEach(source.items,function(item){if(!model.externalSources[sourceType].isLogin){canRefresh=false;return false;}});break;default:break;}}});if(0===cnt||(!model.checked&&!canRefresh)){canRefresh=false;}}if(operationMode===constants.operationMode.edit){$A.forEach(allTableIds,function(id){var source=model.getImportSource(id),needUpload=false;if(source.type===constants.sourceType.file){if(source.subtype===constants.sourceSubtype.clipboard||source.subtype===constants.sourceSubtype.localFile){if(!model.isCubePublished||!model.rawDataExistsInAE){needUpload=!source.hasRefreshedData;}else{needUpload=!source.isAll&&source.executeAction===constants.tableStatsExecutionAction.forceExecution&&!source.hasRefreshedData;}if(needUpload&&!source.hasSelectFile){canRefresh=false;}}}});}if(rootController){rootController.raiseModelEvent({name:EVENT_CAN_START_REFRESH,value:canRefresh});}return canRefresh;},checkCanChange:function(){var model=this.model,operationMode=model.operationMode,allTableIds=model.getAllTableID(),canChange=false;if(operationMode===constants.operationMode.refresh){canChange=true;}if(operationMode===constants.operationMode.edit){if(!model.isCubePublished||!model.rawDataExistsInAE){canChange=false;}else{$A.forEach(allTableIds,function(id){var source=model.getImportSource(id),enabled;enabled=source.hasRefreshedData&&(!source.forceRepublish||!source.schemaChanged);if(enabled){canChange=true;}});}}return canChange;},children:[{slot:"titleNode",scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-di-tablestatuslist-title",bindings:{text:"this.parent.title",visible:"this.parent.title"}},{slot:"listNode",alias:"list",scriptClass:"mstrmojo.DataGrid",lockHeader:true,bindings:{items:"this.parent.items",forceFullPublish:"this.parent.forceFullPublish",updateStarted:"this.parent.updateStarted",cssClass:function(){if(this.parent.model.operationMode===constants.operationMode.create){return"mstrmojo-di-tablestatuslist-list create";}if(this.parent.model.operationMode===constants.operationMode.refresh){return"mstrmojo-di-tablestatuslist-list refresh";}else{return"mstrmojo-di-tablestatuslist-list edit";}},},columns:[],listSelector:null,resizableColumns:true,onitemsChange:function(){if(this._super){this._super();}var bHasRefreshCheckbox=this.parent.bHasRefreshCheckbox,bHasRefreshPolicy=this.parent.bHasRefreshPolicy,columns=[],colWidthConfig={refreshBox:"28",refreshPolicy:"256"};if(bHasRefreshCheckbox){columns.push({headerWidget:{scriptClass:"mstrmojo.TristateCheckBox",cssClass:"tristate tablestatus-header refresh",grayed:false,checked:false,eventSubs:null,tooltipOpenDelay:0,useRichTooltip:true,updateTooltipConfig:function(){var pos;if(this.tooltipContent){pos=$DOM.position(this.domNode);this.set("richTooltip",{keepArrowXPos:true,cssClass:"vi-regular vi-tooltip-V",top:Math.max(pos.y-3,0),left:Math.max(pos.x-7,0),posType:mstrmojo.tooltip.POS_BOTTOMLEFT,content:this.tooltipContent});}},preBuildRendering:function(){this.evts=[];if(!this.eventSubs){var evtConfig={},listConfig=evtConfig[this.id]={};listConfig.scheduleCheckedChange=this.updateStatus;listConfig.refreshCheckedChange=this.updateStatus;listConfig.PublishStatusUpdate=this.updatePublishStatus;if(mstrApp.rootController){this.eventSubs=mstrApp.getRootController().attachDataChangeListeners(evtConfig);}}this.updateStatus();},onUnRender:function onUnRender(){if(this.eventSubs){if(mstrApp.getRootController){mstrApp.getRootController().detachDataChangeListeners(this.eventSubs);}this.eventSubs=null;}if(this._super){this._super();}},updatePublishStatus:function updatePublishStatus(evt){if(evt&&evt.name){this.set("enabled",false);}if(evt&&evt.reset){this.set("enabled",this.origEnabled);}},updateStatus:function updateStatus(){if(!this.visible){return ;}var dataWidget=this,totalItemsNum=0,checkedItemsNum=0,grayed,checked,enabled=true,modelChecked=false,model=dataWidget.dataGrid.parent.model,operationMode=model.operationMode;if(operationMode===constants.operationMode.create||operationMode===constants.operationMode.edit){dataWidget.dataGrid.parent.checkCanRefresh();this.set("visible",false);return ;}$A.forEach(dataWidget.dataGrid.items,function(item){if(!item.isAll){if(item.checked){checkedItemsNum++;}totalItemsNum++;}});if(!checkedItemsNum){grayed=false;checked=false;}else{if(checkedItemsNum<totalItemsNum){grayed=true;checked=true;}else{grayed=false;checked=true;modelChecked=true;}}if(operationMode===constants.operationMode.refresh){enabled=!dataWidget.dataGrid.forceFullPublish;if(!enabled){this.set("tooltipContent",mstrmojo.desc(13960,"Cube doesnot exist in memory so all tables must be republished."));}}model.checked=modelChecked;this.set("grayed",grayed);this.set("checked",checked);this.set("enabled",enabled);this.set("origEnabled",enabled);if(operationMode===constants.operationMode.refresh){dataWidget.dataGrid.parent.checkCanRefresh();}},onclick:function(){if(this.grayed){this.set("grayed",!this.grayed);}else{this.set("checked",!this.checked);}var dataWidget=this,operationMode=dataWidget.dataGrid.parent.model.operationMode,changeList=[],refreshTypes=[],isChecked=this.checked,hasIRRInstance=dataWidget.dataGrid.parent.hasIRR,rootController=mstrApp.getRootController&&mstrApp.getRootController(),model=dataWidget.dataGrid.parent.model,baseReportID=model.cubeID,items=dataWidget.dataGrid.items;model.checked=!this.grayed&&this.checked;if(operationMode===constants.operationMode.refresh||operationMode===constants.operationMode.subscribe){$A.forEach(items,function(item){if(!item.isAll&&item.checked!==isChecked){if(isChecked&&operationMode===constants.operationMode.subscribe&&!item.canSubscribe()){return true;}if(operationMode===constants.operationMode.refresh&&item.forceRepublish){dataWidget.set("grayed, true");return true;}changeList.push(item.tableID);refreshTypes.push(item.refreshType.toString());item.checked=isChecked;}});if(changeList.length>0){if(rootController){rootController.raiseModelEvent({name:"allCheckedChange"});}}if(operationMode===constants.operationMode.refresh){dataWidget.dataGrid.parent.checkCanRefresh();}}}},colWidth:colWidthConfig.refreshBox,dataWidget:{scriptClass:"mstrmojo.StackContainer",cssClass:"tablestatus-col refreshBox",colWidth:colWidthConfig.refreshBox,children:[{scriptClass:"mstrmojo.CheckBox",cssClass:"refreshCheckbox",cssDisplay:"table",colWidth:colWidthConfig.refreshBox,visible:false,text:"",tooltipOpenDelay:0,useRichTooltip:true,preBuildRendering:function(){var dataGrid=this.parent.dataGrid,model=dataGrid.parent.model,data=this.parent.data,subs;this.update();this.subEvts=[];subs=model.attachEventListener("allCheckedChange",this.id,"updateCheck");this.subEvts.push(subs);if(!data.isAll){}this.subEvts.push(model.attachEventListener("PublishStatusUpdate",this.id,"updatePublishStatus"),model.attachEventListener("refreshCheckedChange",this.id,"update"));},onUnRender:function(){var dataGrid=this.parent.dataGrid,data=this.parent.data,model=dataGrid.parent.model;$A.forEach(this.subEvts,function(subs){model.detachEventListener(subs);});if(this.dataEvt){data.detachEventListener(this.dataEvt);}},updatePublishStatus:function(evt){if(evt&&evt.name){this.set("enabled",false);}if(evt&&evt.reset){this.set("enabled",this.origEnabled);}},updateTooltipConfig:function(){var pos;if(this.tooltipContent){pos=$DOM.position(this.domNode);this.set("richTooltip",{keepArrowXPos:true,cssClass:"vi-regular vi-tooltip-V",top:Math.max(pos.y-3,0),left:Math.max(pos.x-7,0),posType:mstrmojo.tooltip.POS_BOTTOMLEFT,content:this.tooltipContent});}},update:function(){var dataWidget=this.parent,data=this.parent.data,operationMode=dataWidget.dataGrid.parent.model.operationMode,enabled=true,checked=false;if(data.isAll){return false;}if(operationMode===constants.operationMode.refresh){enabled=!dataWidget.dataGrid.forceFullPublish&&!data.forceRepublish;checked=dataWidget.dataGrid.forceFullPublish||dataWidget.data.checked===true||data.forceRepublish;if(!enabled){if(dataWidget.dataGrid.forceFullPublish){this.set("tooltipContent",mstrmojo.desc(13960,"Cube doesnot exist in memory so all tables must be republished."));}else{if(data.forceRepublish){this.set("tooltipContent",mstrmojo.desc(13969,"The edit operations require the following table to be refreshed."));}}}}else{if(operationMode===constants.operationMode.subscribe){enabled=dataWidget.data.canSubscribe();checked=dataWidget.data.checked;if(!enabled){this.set("tooltipContent",mstrmojo.desc(13056,"No scheduling support for local files"));}}}this.set("enabled",enabled);this.set("origEnabled",enabled);this.set("checked",checked);},updateCheck:function(){var data=this.parent.data;this.set("checked",!!data.checked);},oncheckedChange:function(){var dataWidget=this.parent,model=dataWidget.dataGrid.parent.model,rootController=mstrApp.getRootController&&mstrApp.getRootController(),tableID,refreshType,baseReportID=model.cubeID,data=dataWidget.data,callback,isChecked=this.checked,hasIRRInstance=dataWidget.dataGrid.parent.hasIRR,operationMode=model.operationMode;if(data.checked===isChecked){if(model.operationMode===constants.operationMode.refresh){if(rootController){rootController.raiseModelEvent({name:"refreshCheckedChange",data:data});}}return ;}if(!data.isAll){if(isChecked&&operationMode===constants.operationMode.subscribe&&!data.canSubscribe()){return ;}data.checked=isChecked;model.importSources[data.id].checked=isChecked;}if(model.operationMode===constants.operationMode.refresh){if(rootController){rootController.raiseModelEvent({name:"refreshCheckedChange",data:data});}}}},{scriptClass:"mstrmojo.Label",cssClass:"refreshBox-status",visible:false,preBuildRendering:function(){var model=this.parent.dataGrid.parent.model;this.update();this.subEvt=model.attachEventListener("PublishStatusUpdate",this.id,"update");},onUnRender:function(){var model=this.parent.dataGrid.parent.model;if(this.subEvt){model.detachEventListener(this.subEvt);}},update:function(evt){var data=this.parent.data,updateStarted=this.parent.dataGrid.parent.updateStarted,status=data&&data.status,title="",cls="tablestatus-col status";if(String(status)==="4"||String(status)==="6"){title=data.errmsg||"";}if(tableStatusCls[status]){cls=tableStatusCls[status];}else{if(updateStarted){cls=tableStatusCls[0];}}if(evt&&evt.completed&&!evt.error){cls=tableStatusCls[3];}this.set("title",title);this.set("cssClass",cls);if(this.domNode){this.domNode.className=cls;}}}],preBuildRendering:function(){var model=this.dataGrid.parent.model;this.update();this.subEvt=model.attachEventListener("PublishStatusUpdate",this.id,"update");},onUnRender:function(){var model=this.dataGrid.parent.model;if(this.subEvt){model.detachEventListener(this.subEvt);}},update:function(evt){var selected=null,operationMode=this.dataGrid.parent.model.operationMode,updateStarted=this.dataGrid.parent.updateStarted,data=this.data;if(evt&&evt.reset){updateStarted=false;}if(data.isAll){selected=null;}else{selected=this.children[0];if(operationMode!==constants.operationMode.subscribe&&data.checked){if((updateStarted&&data.published)||operationMode!==constants.operationMode.refresh){selected=this.children[1];}}}this.set("selected",selected);}}});}columns.push({headerText:mstrmojo.desc(12949,"Data Source"),headerCss:"tablestatus-header label",dataWidget:{scriptClass:"mstrmojo.Box",cssClass:"tablestatus-col tableNameBox cf",preBuildRendering:function(){var model=this.dataGrid.parent.model,operationMode=model.operationMode;if(operationMode===constants.operationMode.refresh){model.attachEventListener("refreshCheckedChange",this.id,"update");}if(operationMode===constants.operationMode.subscribe){if(!this.data.isAll&&!this.data.canSubscribe()){this.children[0].set("enabled",false);}}this.update();},update:function(){var data=this.data,checked=data.checked,model=this.dataGrid.parent.model,hasSelectFile=true,hasUsedCache=false,widget=this.children[0],node=widget&&widget.domNode,visible=false;$A.forEach(data.items,function(item){if(item.hasSelectFile!==true){hasSelectFile=false;}if(item.hasUsedCache===true){hasUsedCache=true;}});if(model.operationMode===constants.operationMode.refresh){visible=checked;}if(model.operationMode===constants.operationMode.edit){if(!model.isCubePublished||!model.rawDataExistsInAE){visible=!data.hasRefreshedData;}else{visible=!data.isAll&&data.executeAction===constants.tableStatsExecutionAction.forceExecution&&!data.hasRefreshedData;}}if(node){$CSS.toggleClass(node,"selected",checked);$CSS.toggleClass(node,"hasSelectFile",hasSelectFile||hasUsedCache||!visible);}else{if(checked){$CSS.addWidgetCssClass(widget,"selected");}else{$CSS.removeWidgetCssClass(widget,"selected");}if(hasSelectFile||!visible){$CSS.addWidgetCssClass(widget,"hasSelectFile");}else{$CSS.removeWidgetCssClass(widget,"hasSelectFile");}}this.children[1].set("visible",visible);},children:[{scriptClass:"mstrmojo.WidgetTree",bindings:{items:function(){var data=this.parent.data,v="",isLeaf=!(data.items&&data.items.length>0);if(data.sourceInfo){v=data.sourceInfo.dbTableName||data.sourceInfo.name;}else{v=data.name;}var items=this.streamlinePipelineStructure();return[{n:v,isLeaf:isLeaf,items:items}];}},needDisplayPipeline:true,streamlinePipelineStructure:function(){var data=this.parent.data,tree=this,filesMap={},remainingNodes=[];$A.forEach(data.items,function(itemObj,index,arr){if(arr.length===1){remainingNodes.push(itemObj);tree.needDisplayPipeline=false;return false;}else{if(arr.length>1){remainingNodes.push(itemObj);}}});this.cssClass+=this.needDisplayPipeline?"":" hidePipeline";$H.forEach(filesMap,function(fileObj){fileObj.n=fileObj.n.join(";");});if(!this.needDisplayPipeline){$A.forEach(remainingNodes,function(node){node.n=node.fileName?node.fileName+" - "+node.n:node.n;});}return remainingNodes.concat($H.valarray(filesMap));},itemIdField:"id",cssClass:"mstrmojo-DIPublishSimpleTree",itemDisplayField:"n",itemFunction:function ifn(item,idx,w){var tree=w.tree||w,republishTreeNodeCls="dataset-table",len=item.items.length;republishTreeNodeCls+=(len>1?" multipleTable":"");return new mstrmojo.TreeNode({idx:idx,data:item,state:1,parent:w,tree:tree,multiSelect:w.multiSelect,text:item[w.itemDisplayField],cssClass:"leaf",textCssClass:tree.item2textCss(item),items:item[w.itemChildrenField],itemIdField:w.itemIdField,itemDisplayField:w.itemDisplayField,itemIconField:w.itemIconField,itemChildrenField:w.itemChildrenField,itemFunction:function(item,idx,w){republishTreeNodeCls+=(idx===len-1?" last":"");return new mstrmojo.AS.DIAppSchemaRepublishTreeNode({idx:idx,data:item,parent:w,cssClass:republishTreeNodeCls,iconClass:item.dataSourceType,injectEvts:function(){var datasourceWidget=this.parent.parent.parent,dataGrid=datasourceWidget.dataGrid;if(dataGrid.parent.model.operationMode!==constants.operationMode.refresh){return ;}var rootCtrl=mstrApp.getRootController(),model=rootCtrl.model;model.attachEventListener("onLocalFileStatusUpdate",this.id,"onLocalFileStatusUpdate");},getItemActionBtn:function(){var cfg,datasourceWidget=this.parent.parent.parent,dataGrid=datasourceWidget.dataGrid;if(dataGrid.parent.model.operationMode!==constants.operationMode.refresh){return null;}switch(item.dataSourceType){case constants.dataSourceType.FILE_LOCAL:cfg={browseLabel:"",fileFieldName:"file",scriptClass:"mstrmojo.FileUploadBox",accept:".xls,.xlsx,.csv,.txt,.tsv,.prn,.json,.sas7bdat",onvalueChange:function(evt){if(evt.value===-1){return ;}var rootCtrl=mstrApp.getRootController(),data=this.parent.data,hasFile=(this.value!==""),allHaveFiles=true;this.inputNode.value=(hasFile?this.value:data.n);this.parent.tableNode.firstChild.innerText=(hasFile?this.value:data.n);if(hasFile||(!hasFile&&data.fileAvailable)){$CSS.addClass(this.buttonNode,"mstrmojo-FileUploadBox-FileSelected-button");}else{$CSS.removeClass(this.buttonNode,"mstrmojo-FileUploadBox-FileSelected-button");}$H.copy({hasSelectFile:hasFile,fileUploader:hasFile?this:null,needUploadFile:hasFile},data);datasourceWidget.update();dataGrid.parent.checkCanRefresh();rootCtrl.raiseModelEvent({name:"onLocalFileStatusUpdate",fileId:data.fileId,datasourceWidgetIndex:datasourceWidget.idx,sourceTableIndex:this.parent.idx,pickedFileName:this.value,data:data});$A.forEach(datasourceWidget.data.items,function(item){if(!item.hasSelectFile&&!item.fileAvailable){allHaveFiles=false;return false;}});datasourceWidget.data.checked=allHaveFiles||datasourceWidget.dataGrid.forceFullPublish||datasourceWidget.data.forceRepublish;rootCtrl.raiseModelEvent({name:"refreshCheckedChange",data:datasourceWidget.data});},submit:function(params,callback,config){callback.success();},postBuildRendering:function(){this._super&&this._super();item.fileAvailable&&$CSS.addClass(this.buttonNode,"mstrmojo-FileUploadBox-FileSelected-button");}};break;case constants.dataSourceType.FILE_URL:cfg={browseLabel:"",scriptClass:"mstrmojo.Label",text:""};break;case constants.dataSourceType.DROPBOX:case constants.dataSourceType.GOOGLE_ANALYTICS:case constants.dataSourceType.GOOGLE_BIGQUERY:case constants.dataSourceType.GOOGLE_DRIVE:case constants.dataSourceType.SALESFORCE:var sourceType=$DIHelper.convertDataSourceType2SourceType(item.dataSourceType),externalSources=mstrApp.getRootController().getModel().externalSources[sourceType],isLogin=!!externalSources.isLogin,hasFetchedOAuthInfo=!!externalSources.hasFetchedOAuthInfo;if(!item.oAuthInfoMissing&&!hasFetchedOAuthInfo){getOAuthInfo(sourceType,item.dbRoleId,item.accountId);}cfg={scriptClass:"mstrmojo.AS.DIAppSchemaRepublishOAuthButton",cssClass:"mstrmojo-di-appschema-republish-oauth-button",sourceType:sourceType,isLogin:isLogin,tableId:item.tableId,pipelineId:item.pipelineId};break;default:break;}return cfg;},getMenuBtn:function(){var cfg,datasourceWidget=this.parent.parent.parent,dataGrid=datasourceWidget.dataGrid;if(dataGrid.parent.model.operationMode!==constants.operationMode.refresh){return null;}switch(item.dataSourceType){case constants.dataSourceType.FILE_LOCAL:cfg={scriptClass:"mstrmojo.Button",text:"",cssClass:"mstrmojo-buttonMenu",onclick:function(){var statusList=dataGrid.parent,menuBtn=this,data=datasourceWidget.data,sourceTableData=this.parent.data,uploadBoxNode=menuBtn.domNode.parentNode.previousSibling,tableNode=uploadBoxNode.previousSibling,fileField=uploadBoxNode.firstChild.firstChild.childNodes[1].childNodes[1],rootCtrl=mstrApp.getRootController();var menuCfg=new mstrmojo.ui.menus.MenuConfig();menuCfg.hostElement=statusList.domNode;menuCfg.isHostedWithin=false;menuCfg.position=$DOM.position(menuBtn.domNode,true);var useCachedFile=function useCachedFile(itemContext){var data=menuBtn.parent.data;fileField.value=null;data.fileUploader&&data.fileUploader.set("value","");data.fileUploader=null;$H.copy({hasSelectFile:false,hasUsedCache:true,needUploadFile:false},data);tableNode.firstChild.innerText=menuBtn.parent.data.n;datasourceWidget.update();dataGrid.parent.checkCanRefresh();rootCtrl.raiseModelEvent({name:"onLocalFileStatusUpdate",fileId:data.fileId,datasourceWidgetIndex:datasourceWidget.idx,sourceTableIndex:menuBtn.parent.idx,pickedFileName:"",data:data});};var uploadNewFile=function uploadNewFile(itemContext){fileField.click();};if(sourceTableData.hasSelectFile&&item.fileAvailable){menuCfg.addMenuItem("Use cached file","",useCachedFile);}else{menuCfg.addDisabledMenuItem("Use cached file","");}menuCfg.addMenuItem("Upload new file","",uploadNewFile);statusList.openPopup(menuCfg.newInstance());}};break;case constants.dataSourceType.FILE_URL:case constants.dataSourceType.DROPBOX:case constants.dataSourceType.GOOGLE_ANALYTICS:case constants.dataSourceType.GOOGLE_BIGQUERY:case constants.dataSourceType.GOOGLE_DRIVE:case constants.dataSourceType.SALESFORCE:cfg={browseLabel:"",scriptClass:"mstrmojo.Label",text:""};break;default:break;}return cfg;},onLocalFileStatusUpdate:function(evt){var data=this.data;if(data.dataSourceType===constants.dataSourceType.FILE_LOCAL){var datasourceWidget=this.parent.parent.parent,dataGrid=datasourceWidget.dataGrid,fileId=evt.fileId,datasourceWidgetIndex=evt.datasourceWidgetIndex,sourceTableIndex=evt.sourceTableIndex,fileUploader=evt.data.fileUploader,pickedFileName=evt.pickedFileName,currentDatasourceWidgetIndex=datasourceWidget.idx,currentSourceTableIndex=this.idx,uploadBoxNode=this.buttonNode.firstChild,uploadFormNode=uploadBoxNode.firstChild,uploadButtonNode=uploadFormNode.children[1];if(fileId===data.fileId&&datasourceWidget.data.checked===true){if(currentDatasourceWidgetIndex!==datasourceWidgetIndex||currentSourceTableIndex!==sourceTableIndex){if(data.fileUploader){uploadButtonNode.lastChild.value=null;data.fileUploader.set("value",-1);}$H.copy({hasSelectFile:pickedFileName===""?false:true,fileUploader:null,needUploadFile:false,hasUsedCache:evt.data.hasUsedCache},data);uploadFormNode.firstChild.value="";this.tableNode.firstChild.innerText=pickedFileName||data.n;if(pickedFileName!==""||(evt.data.fileAvailable)){$CSS.addClass(uploadButtonNode.firstChild,"mstrmojo-FileUploadBox-FileSelected-button");}else{$CSS.removeClass(uploadButtonNode.firstChild,"mstrmojo-FileUploadBox-FileSelected-button");}}dataGrid.parent.checkCanRefresh();}}}});},listSelector:w.listSelector});}},{scriptClass:"mstrmojo.StackContainer",renderMode:"notonShow",markupMethods:mstrmojo.hash.copy({onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";}},mstrmojo.StackContainer.prototype.markupMethods),cssClass:"tableNameBox-stack",visible:false,children:[{scriptClass:"mstrmojo.Button",cssClass:"tableNameBox-stack-edit",visible:false,text:mstrmojo.desc(1088,"Edit"),onclick:function(){}},{scriptClass:"mstrmojo.FileUploadBox",cssClass:"mstrmojo-di-button mstrmojo-WebButton",visible:false,uploadTaskId:"importFile",action:mstrConfig.taskURL,fileFieldName:"myFile",initValue:false,browseLabel:mstrmojo.desc(1825,"Browse"),accept:".xls,.xlsx,.csv,.txt,.tsv,.prn,.json,.sas7bdat",onvalueChange:function(){var data=this.parent.parent.data,hasFile=(this.value!==""),dataGrid=this.parent.parent.dataGrid;data.hasSelectFile=hasFile;data.fileUploader=this;if(hasFile){data.checked=true;model.importSources[data.id].checked=true;}this.parent.parent.update();if(hasFile){this.parent.parent.children[0].set("text",this.getFileName());}else{this.parent.parent.children[0].resetText();}dataGrid.parent.checkCanRefresh();},getFileName:function(){var ret;if(mstrmojo.dom.supports(mstrmojo.dom.htmlFeatures.FILE_READER)&&this.fileNode.files){ret=this.fileNode.files.length>0&&this.fileNode.files[0].name;}else{ret=this.value;}return ret;},getFileSize:function(){var ret=0;if(mstrmojo.dom.supports(mstrmojo.dom.htmlFeatures.FILE_READER)&&this.fileNode.files){ret=this.fileNode.files.length>0&&this.fileNode.files[0].size;}else{try{var oas=new ActiveXObject("Scripting.FileSystemObject");var file=oas.getFile(this.fileNode.value);if(file){ret=file.Size;}}catch(e){}}return ret;},submit:function(ps,callbacks,config){function handleFileLoadError(retRes){var res={code:0,message:mstrmojo.desc(12814,"Cannot read file content")};if(callbacks.failure){callbacks.failure(retRes||res);}if(callbacks.complete){callbacks.complete();}}function uploadChunk(){var end,blob;ps.fileName=filename;ps.index++;end=Math.min(file.size,start+MAX_FILE_SIZE);blob=file.slice(start,end);if(ps.index===ps.numberOfChunks){mstrApp.upload(callbacks,ps,blob,config);}else{mstrApp.upload({success:function(){start=start+MAX_FILE_SIZE;uploadChunk();},failure:function(res){handleFileLoadError(res);}},ps,blob,config);}}var r=true;var file,filename,numOfChunks,start;if(this.onsubmit){r=this.onsubmit();}if(r){ps=ps||{};ps.fileFieldName=this.fileFieldName;ps.taskId=this.uploadTaskId;ps.jsonp=this.jsonp.replace("{@id}",this.id);if(mstrmojo.dom.supports(mstrmojo.dom.htmlFeatures.FILE_READER)){config=mstrmojo.hash.copy(config,{async:true});file=this.fileNode.files[0];filename=file.name;if(this.params){ps=this.params;}if(file.size>MAX_FILE_SIZE){numOfChunks=Math.ceil(file.size/MAX_FILE_SIZE);start=0;ps.index=0;ps.numberOfChunks=numOfChunks;ps.chunkSize=MAX_FILE_SIZE;ps.fileName=this.fileNode.files[0].name;ps.fileSize=file.size;ps.fileType="application/octet-stream";mstrApp.showProgress(config);mstrApp.upload({success:function(){uploadChunk();},failure:function(res){handleFileLoadError(res);}},ps,null,config);}else{ps.fileName=this.fileNode.files[0].name;mstrApp.upload(callbacks,ps,file.slice(0,file.size),config);}}else{ps.taskEnv="jsonp2";ps.fileName=this.value;var h=[],p;for(p in ps){h.push('<input type="hidden" name="'+p+'" value="'+mstrmojo.string.encodeHtmlString(ps[p])+'"/>');}if(this.params){ps=this.params;for(p in ps){h.push('<input type="hidden" name="'+p+'" value="'+mstrmojo.string.encodeHtmlString(ps[p])+'"/>');}}this.paramsNode.innerHTML=h.join("");if(callbacks){this.onSuccess=callbacks.success;this.onFailed=callbacks.failure;}this.formNode.submit();}this.set("status","loading");}}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton",visible:false,text:mstrmojo.desc(14287,"Input Credentials"),}],preBuildRendering:function(){var source=this.parent.data,model=this.parent.dataGrid.parent.model,selected=null;switch(source.type){case constants.sourceType.file:if(source.subtype===constants.sourceSubtype.clipboard){selected=this.children[2];}else{if(source.subtype===constants.sourceSubtype.localFile){if(mstrApp.isSingleTier){selected=this.children[2];}else{selected=this.children[1];}}}break;default:selected=null;if(mstrApp.isSingleTier&&model.missingCredentialsData){var that=this;mstrmojo.array.forEach(model.missingCredentialsData.datasets[0].tables,function(table){if(table.did===source.tableID){if(table.dbRole){source.dbRole=table.dbRole;}selected=that.children[3];}});}break;}if(selected){this.set("selected",selected);}this.subEvt=model.attachEventListener("PublishStatusUpdate",this.id,"update");if(this._super){this._super();}},onUnRender:function(){var model=this.parent.dataGrid.parent.model;if(this.subEvt){model.detachEventListener(this.subEvt);}},update:function(evt){if(evt&&evt.name&&this.selected){this.selected.set("enabled",false);}if(evt&&evt.reset&&this.selected){this.selected.set("enabled",true);this.parent.update();}if(evt&&evt.reset&&evt.errors){switch(evt.errors[this.parent.data.tableID]){case constants.backendError.noExternalSession:case constants.backendError.databaseCredentialsNotAvailable:this.selected=this.children[3];this.selected.set("visible",true);this.parent.update();break;case constants.backendError.switchingFileType:if(this.selected){this.selected.set("enabled",true);this.parent.update();}break;}}}}]}});if(bHasRefreshPolicy){var pulldownWidget={popupZIndex:9999,popupToBody:true,isHostedWithin:false,colWidth:"230",visible:false,items:[],tooltipOpenDelay:0,useRichTooltip:true,updateTooltipConfig:function(){var pos;if(this.tooltipContent){pos=$DOM.position(this.domNode);this.set("richTooltip",{keepArrowXPos:true,cssClass:"vi-regular vi-tooltip-V",top:Math.max(pos.y-3,0),left:Math.max(pos.x,0),posType:mstrmojo.tooltip.POS_BOTTOMLEFT,content:this.tooltipContent});}},postCreate:function postCreate(){var data=this.parent.data,dataWidget=this.parent,enabled=true,operationMode=this.parent.dataGrid.parent.model.operationMode,items=[{n:$DESC(9117,"Replace existing data"),dssid:constants.cubeRefreshType.replaceTable},{n:$DESC(9118,"Update existing data and add new data"),dssid:constants.cubeRefreshType.upsert},{n:$DESC(12397,"Update existing data"),dssid:constants.cubeRefreshType.update},{n:$DESC(12398,"Add new data"),dssid:constants.cubeRefreshType.add}];if(data.isAll){if(operationMode===constants.operationMode.subscribe){data.model.set("refreshType",constants.cubeRefreshType.replaceTable);}items.push({n:"",dssid:constants.cubeRefreshType.dummy});this.parent.set("visible",false);}else{if(operationMode===constants.operationMode.edit){if(dataWidget.dataGrid.forceFullPublish){enabled=false;}else{enabled=(!data.forceRepublish||!data.schemaChanged)&&data.hasRefreshedData;}this.set("enabled",enabled);if(!enabled){this.set("tooltipContent",mstrmojo.desc(13970,'The edit operations require the refresh policy to be "Replace existing data".'));}}if(operationMode===constants.operationMode.refresh){enabled=!dataWidget.dataGrid.forceFullPublish&&(!data.forceRepublish||!data.schemaChanged);this.set("enabled",enabled);if(!this.enabled){if(dataWidget.dataGrid.forceFullPublish){this.set("tooltipContent",mstrmojo.desc(13971,'Cube doesnot exist in memory so the refresh policy has to be "Replace existing data".'));}else{this.set("tooltipContent",mstrmojo.desc(13972,'The edit operations require the refresh policy to be "Replace existing data".'));}}}if(operationMode===constants.operationMode.subscribe){data.refreshType=constants.cubeRefreshType.replaceTable;enabled=data.canSubscribe();this.set("enabled",enabled);if(!enabled){this.set("tooltipContent",mstrmojo.desc(13056,"No scheduling support for local files"));}}}this.set("origEnabled",this.enabled);this.set("items",items);var value=this.parent.data.isAll?this.parent.data.model.refreshType:this.parent.data.refreshType;this.initValue(value);},updateStatus:function updateStatus(){var dataWidget=this.parent,data=dataWidget.data,refreshType=null,oldRefreshType=data.model.refreshType,isSame=true;$A.forEach(dataWidget.dataGrid.items,function(item){if(!item.isAll){if(item.refreshType!==refreshType){if(refreshType===null){refreshType=item.refreshType;}else{isSame=false;return false;}}}return true;});if(!isSame){refreshType=constants.cubeRefreshType.dummy;}if(refreshType!==null&&refreshType!==oldRefreshType){data.model.set("refreshType",refreshType);}},updatePublishStatus:function(evt){if(evt&&evt.name){this.set("enabled",false);}if(evt&&evt.reset){this.set("enabled",this.origEnabled);}},preBuildRendering:function preBuildRendering(){var evtConfig,listConfig;if(this._super){this._super();}if(!this.parent.data.isAll){if(!this.eventSubs){evtConfig={};listConfig=evtConfig[this.id]={};listConfig.PublishStatusUpdate=this.updatePublishStatus;}return ;}if(!this.eventSubs){evtConfig={};listConfig=evtConfig[this.id]={};listConfig.scheduleRefreshTypeChange=this.updateStatus;listConfig.PublishStatusUpdate=this.updatePublishStatus;}this.updateStatus();},onUnRender:function onUnRender(){if(this.eventSubs){this.eventSubs=null;}if(this._super){this._super();}},updateRefreshType:function(refreshType){var tableID,callback,data=this.parent.data,oldRefreshType,dataWidget=this.parent,changeList=[],refreshTypes=[],hasIRRInstance=dataWidget.dataGrid.parent.hasIRR,operationMode=dataWidget.dataGrid.parent.model.operationMode;if(data.isAll){oldRefreshType=data.model.refreshType;if(refreshType===oldRefreshType){return ;}data.model.refreshType=refreshType;if(refreshType===constants.cubeRefreshType.dummy){return ;}$A.forEach(dataWidget.dataGrid.items,function(item){if(!item.isAll&&item.refreshType!==refreshType){if(item.checked){changeList.push(item.tableID);refreshTypes.push(refreshType.toString());}item.set("refreshType",refreshType);}});return ;}oldRefreshType=data.refreshType;if(refreshType===oldRefreshType){return ;}data.refreshType=refreshType;if(!(hasIRRInstance&&data.checked&&oldRefreshType!==refreshType)){return ;}tableID=data.tableID;}};if($DIHelper.isWS()&&($DIHelper.getOperationMode()===constants.operationMode.refresh||$DIHelper.getOperationMode()===constants.operationMode.subscribe)){$H.copy({scriptClass:"mstrmojo.ui.Pulldown",onSelectedItemChange:function(newItem){this.updateRefreshType(newItem.dssid);},initValue:function(value){var idx=$A.find(this.items,"dssid",value);this.set("selectedIndex",(idx<0)?0:idx);}},pulldownWidget);}else{$H.copy({scriptClass:"mstrmojo.Pulldown",onvalueChange:function(){var idx=$A.find(this.items,this.itemIdField,this.value);if(idx<0){this.selectedIndex=0;}var refreshType=this.items[this.selectedIndex].dssid;this.updateRefreshType(refreshType);},initValue:function(value){this.set("value",value);},premousedown:function premousedown(evt){if(this.enabled){mstrmojo.Pulldown.prototype.premousedown.call(this,evt);}}},pulldownWidget);}var policyColumn={headerWidget:{scriptClass:"mstrmojo.Box",cssClass:"tablestatus-header pulldown",children:[{scriptClass:"mstrmojo.Label",cssClass:"refresh-policy-label",text:mstrmojo.desc(13053,"Refresh Policy")},{scriptClass:"mstrmojo.Image",alias:"tooltipImage",cssClass:"refresh-policy-icon",useRichTooltip:true,tooltipOpenDelay:0,updateTooltipConfig:function(){var position=mstrmojo.dom.position(this.domNode);this.richTooltip={cssClass:"vi-regular vi-taller vi-tooltip-A vi-tooltip-leftcenter",posType:mstrmojo.tooltip.POS_TOPLEFT,content:getPolicyTooltipHtml(),top:position.y+25,left:position.x-95,enableHover:true};},bindings:{visible:function(){return $DIHelper.isWS()&&(this.parent.dataGrid.parent.model.operationMode===constants.operationMode.refresh||this.parent.dataGrid.parent.model.operationMode===constants.operationMode.subscribe);}}}]},colWidth:colWidthConfig.refreshPolicy,dataWidget:{scriptClass:"mstrmojo.StackContainer",cssClass:"tablestatus-col stack pulldown",colWidth:"65",children:[pulldownWidget,{scriptClass:"mstrmojo.Label",colWidth:"100",visible:false,bindings:{text:function(){var v="";var type=this.parent.data.xdaType;switch(type){case constants.xdaType.excel:case constants.xdaType.text:v=mstrmojo.desc(13056,"No scheduling support for local files");break;}return v;}}}],preBuildRendering:function(){this.set("selected",this.children[0]);if(this._super){this._super();}}}};columns.push(policyColumn);}if(this.hasRendered){this.unrender();this.columns=columns;this.render();}else{this.columns=columns;}}}]});mstrmojo.AS.DIAppSchemaTableStatusList.OneTierFiles=function(file){var component=mstrmojo.all[mstrmojo.AS.DIAppSchemaTableStatusList.selectedUploader];component.replaceOneTierFile(file);};}());