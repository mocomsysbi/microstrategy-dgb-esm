(function(){mstrmojo.requiresCls("mstrmojo.DocSelector","mstrmojo.TextBoxDocSelector","mstrmojo.array","mstrmojo.string","mstrmojo.elementHelper","mstrmojo.mstr.EnumDSSXMLObjectTypes");var $ARR=mstrmojo.array,$S=mstrmojo.string,_EH=mstrmojo.elementHelper,$DATA_PARAMS=mstrmojo.DocSelector.DATAPARAMS,$OBJECT_TYPE=mstrmojo.mstr.EnumDSSXMLObjectTypes,ELEM_ALL_ID=_EH.ELEM_ALL_ID;var NO_SEL_AS_EMPTY=0,NO_SEL_AS_UNSET=1,NO_SEL_AS_ALL=2;var UNIT_CONDITION=1,SUBTOTAL=3;var $ALL_ELEM=_EH.ELEM_ALL;mstrmojo.SearchBoxDocSelector=mstrmojo.declare(mstrmojo.TextBoxDocSelector,null,{scriptClass:"mstrmojo.SearchBoxDocSelector",filterElemALL:false,_buildEvent:function _buildEvent(rEvt,widget){var elementIDs=[],elementCount,ces=[],defn=this.defn;$ARR.forEach(widget.items,function(item){item.n=mstrmojo.string.multiReplace(item.n,{";":"\\;"});elementIDs.push(item.v+";"+$S.decodeHtmlString(item.n));ces.push(item);});elementCount=elementIDs.length;if(!elementCount){elementIDs.push(ELEM_ALL_ID);}if(elementIDs.length>0||!defn.nsb||defn.nsb===NO_SEL_AS_EMPTY){rEvt.eid=elementIDs.join(mstrmojo.elementHelper.ELEM_SEPARATOR);}else{if(defn.nsb===NO_SEL_AS_UNSET||!defn.showall){rEvt.unset=true;}else{if(defn.nsb===NO_SEL_AS_ALL){rEvt.eid=ELEM_ALL_ID;ces=[$ALL_ELEM];}}}if(mstrApp.isAppStatePause&&mstrApp.isAppStatePause()){var docModel=this.model,node=this.node,layoutDefn=docModel.getCurrentLayoutDef(),units=layoutDefn&&layoutDefn.units,ctlKey=this.k;if(units[ctlKey]){units[ctlKey].cesChange=true;}node.data.elms=node.data.ces=ces;node.data[$DATA_PARAMS.CESREADY]=true;docModel.setDataReady(this.k,this.id,$DATA_PARAMS.CESREADY,true,"ces",ces);docModel.setDataReady(this.k,this.id,"elms",ces);}if(defn.sec){if(defn.multi){this.parent.set("count",_EH.buildElemsCountStrByNum(elementCount,0));}else{this.parent.set("count",_EH.buildElemsCountStrByNum(0,0));}}},updateWidget:function updateWidget(selectorContainer){var selectorWidget=this._super(selectorContainer),node=selectorContainer.node,defn=node.defn,data=node.data,elements=data.elms;if(elements&&!defn.sos){selectorWidget.candidates=this.setupCandidates(defn,elements);}if(defn.srcid){var ca=[],i,ces=$ARR.filter(data.ces,function(item){return item.v!=="u;";});if(ces&&ces.constructor===Array){if(defn.dfm===UNIT_CONDITION){for(i=0;i<ces.length;i++){if(ces[i].t!==SUBTOTAL){ca.push(ces[i]);}}}else{ca=ces.concat();}}if(!defn.sos){var new_ca=[];$ARR.forEach(ca,function(item){if($ARR.find(selectorWidget.candidates.items,"v",item.v)>-1){new_ca.push(item);}});ca=new_ca;}selectorWidget.items=ca;}return selectorWidget;},getCekEvtListener:function getCekEvtListener(selectorContainer,selectorControl){return function(evt){selectorContainer.handleActionInSyncPhase(function(){selectorControl.set("items",evt.value);});};},getWidgetConfig:function getWidgetConfig(selectorContainer,selectorStyle,defn,elements){var fmts=selectorContainer.getFormats(),data=selectorContainer.node.data,cfg=this._super(selectorContainer,selectorStyle,defn,elements),suggestCount=100,isVI=mstrApp.isVI,hitEnterToTest=isVI&&(selectorContainer.isRecursiveAttributeSelector()||selectorContainer.node.defn.iase===false),me=this,tooltip=hitEnterToTest?{posType:mstrmojo.tooltip.POS_TOPLEFT,cssClass:"vi-regular pulldown",contentNodeCssClass:"srch htEnter",content:mstrmojo.desc(15764,"Hit Enter to search")}:{posType:mstrmojo.tooltip.POS_TOPLEFT,cssClass:"vi-regular pulldown",contentNodeCssClass:"srch",onclick:function(){var searchbox=me.content,srch=searchbox.getSearchPattern(),meId=me.id;me.model.changeFilterStyle(me,me.style,me.multi,false);this.set("allowOtherTooltips",false);searchbox.hideTooltip();if(mstrApp.isWaiting()){var waitbox=mstrApp.getWaitBox();var waitboxListener=waitbox.attachEventListener("visibleChange",waitbox.id,function(evt){if(evt.value===false){mstrmojo.all[meId].content.showInfoTooltip(srch);waitboxListener.clear();}});}},content:'<div class="auto">'+mstrmojo.desc(15910,"Searching...")+'</div><div class="separator"><div class="wait">'+mstrmojo.desc(15911,"Tired of waiting?")+'</div><div class="actn">'+mstrmojo.desc(15912,"Disable Instant Search")+"</div></div>"};cfg={scriptClass:cfg.scriptClass,cssText:fmts.height?"height: "+fmts.height:"",emptyText:mstrmojo.desc(4325,"Search")+" "+(defn.ttl||""),richTooltip:isVI?tooltip:null,items:defn.srcid?(data.ces?data.ces.concat():[]):[],REQUEST_THRESHOLD:(mstrApp&&mstrApp.SEARCH_REQUEST_THRESHOLD)||55,suggestCount:(mstrApp&&mstrApp.SEARCH_SUGGESTION_LENGTH)||suggestCount,hitEnterToTest:hitEnterToTest,stifleIntermediateSearch:true,srcid:defn.srcid||"",srct:defn.srct||$OBJECT_TYPE.Attribute,dsrc:defn.dsrc||"",useClientForm:defn.srct===$OBJECT_TYPE.Consolidation,onitemsChange:function(){if(!selectorContainer._inSyncPhase){selectorContainer.showInfoWin();selectorContainer.selectorControlChange(this);}}};if(elements&&!defn.sos){cfg.candidates=this.setupCandidates(defn,elements);}else{cfg.useKeyDelay=true;cfg.noCache=true;}if(!defn.multi){cfg.maxObjectCount=1;}return cfg;},isSelectAll:function isSelectAll(){var widget=this.children&&this.children[0];return widget===undefined?true:(!widget.items||widget.items.length===0);},isFilterNothing:function isFilterNothing(){return this.isSelectAll();},setupCandidates:function setupCandidates(defn,elements){var items=defn.srcid?elements:[];if(this.filterElemALL){items=$ARR.filter(items,function(it){return it.v!=="u;";});}return{isComplete:true,items:items};},isValidSelection:function isValidSel(){var data=this.node.data,model=this.model;if(model.isSelWarnFlagOn(this.k)&&data.ces&&data.ces.length===0){return data.elms.length!==0;}return true;}});}());