(function(){mstrmojo.requiresCls("mstrmojo.vi.ui.PanelPortlet","mstrmojo.vi.ui.rw.selectors._HasFilterContextMenu","mstrmojo.vi._MonitorsAppState","mstrmojo.vi._MonitorsLayoutMode","mstrmojo.util.ui._HostsSplitter","mstrmojo.ui.menus.EditorConfig","mstrmojo.ui.CheckList","mstrmojo.ui.ScrollableContainer","mstrmojo.Label","mstrmojo.ToolSeparator","mstrmojo.vi.ui.InteractiveUnitList","mstrmojo.array","mstrmojo.hash","mstrmojo.dom","mstrmojo.boxmodel","mstrmojo.css","mstrmojo.expr","mstrmojo.vi.models.VIComponentMap","mstrmojo.ME._MetricEditorHelper","mstrmojo.DocDataService","mstrmojo.DocSelector","mstrmojo.vi.ui.rw.VisFilterDisplayPanel","mstrmojo._HasPopup");var $ARR=mstrmojo.array,$HASH=mstrmojo.hash,$CSS=mstrmojo.css,$DOM=mstrmojo.dom,$EXPR=mstrmojo.expr,$BFTP=$EXPR.BFTP,$STYLES=mstrmojo.DocSelector.STYLES,$DATA_PARAMS=mstrmojo.DocSelector.DATAPARAMS,$EH=mstrmojo.elementHelper,$RW=mstrmojo.vi.ui.rw,$VI_TYPES=mstrmojo.vi.models.VIComponentMap.TYPES,VisFilterDisplayPanel=$RW.VisFilterDisplayPanel,ITEM_SEP="\u001E",TP_METRIC=4,TP_ATTRIBUTE=12,TP_CONSOLIDATION=47,STP_CUSTOM_GROUP=257,SUBTYPE_REPORT_CUBE=776,SUBTYPE_REPORT_EMMA_CUBE=779,CTL_ELEMENT_SOURCE_DOCUMENT=1,DOUBLE_CLICK_INTERVAL=250,TOPN_DEFAULT_QT=1,TOPN_DEFAULT_N=10,MIN_HEIGHT=74,VIS_MIN_HEIGHT=85,URL_VISFILTERIMG=mstrmojo.getJsRoot()+"mojo/css/images/VisualizationFilter_icon.svg",CSSCLS_VISFILTER="VisFilter",CSS_EXPANDED="expanded",CSS_CURSOR_DEFAULT="default",CSS_CURSOR_NS_RESIZE="ns-resize",visFilterDisplayPanel;function dragWithin(context){var epos=context.tgt.pos,ex=epos.x,ey=epos.y,dim=context.src.data.parentDim,dimx1=dim.x,dimx2=dimx1+dim.w,dimy1=dim.y,dimy2=dimy1+dim.h;return ex>=dimx1&&ex<=dimx2&&ey>=dimy1&&ey<=dimy2;}function getTopRankSubMenuEditor(){var fnGetDisplayUnits=function(datasets,type){var units=[];Object.keys(datasets).forEach(function(datasetKey){var ds=datasets[datasetKey];units=units.concat((ds[type]||[]).filter(function(dsUnit){var i=$ARR.find(units,"did",dsUnit.did);if(i>-1){if(units[i].hide&&!dsUnit.hide){units[i].hide=false;}return false;}return true;}).map(function(dsUnit){var newUnit=mstrmojo.hash.clone(dsUnit);newUnit.dsc="("+ds.name+")";return newUnit;}));});return units;},selector=this.selector,docModel=selector.model,srcId=selector.defn.srcid,datasets=docModel.datasets,allAttrs=fnGetDisplayUnits(datasets,["att"]),allMetrics=fnGetDisplayUnits(datasets,["mx"]),fnGetCandidateItems=function(datasets){var units=[],visited={};Object.keys(datasets).forEach(function(dsId){var dataset=datasets[dsId],attrs=dataset.att||[],mx=dataset.mx||[];if($ARR.find(attrs,"did",srcId)>=0){var elms=attrs.filter(function(attr){return attr.formType===$BFTP.NUMBER&&attr.did!==srcId&&!attr.hide&&!visited[attr.did];}).map(function(unit){unit.dsc=dataset.name;return unit;}).concat(mx.filter(function(metric){return !metric.hide&&!visited[metric.did];}).map(function(unit){unit.dsc=dataset.name;return unit;}));units=units.concat(elms);elms.forEach(function(el){visited[el.did]=true;});}});return units;},attr=$ARR.filterOne(allAttrs,function(unit){return unit.did===srcId;}),items=fnGetCandidateItems(datasets||{}),fnGetDuplicateItemNames=function(items){var visited={},duplicates={};(items||[]).forEach(function(item){if(item.n&&visited[item.n]){duplicates[item.n]=true;}visited[item.n]=true;});return duplicates;},dupNames=fnGetDuplicateItemNames(items);return new mstrmojo.ui.menus.EditorConfig({cssClass:"topRank",okVisible:false,cancelVisible:false,contents:[{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(11503,"Ranked By:")},{scriptClass:"mstrmojo.ui.ScrollableContainer",children:[{scriptClass:"mstrmojo.vi.ui.InteractiveUnitList",draggable:false,CLS_HAS_MENU:"",items:items,hasTooltipContent:function(item){return mstrmojo.vi.ui.InteractiveUnitList.prototype.hasTooltipContent.apply(this,arguments)||dupNames[item.n];},getItemTooltip:function(item,itemNode){var richTooltip=mstrmojo.vi.ui.InteractiveUnitList.prototype.getItemTooltip.apply(this,arguments);if(richTooltip){var position=$DOM.position(itemNode);$HASH.copy({cssClass:"vi-regular vi-tooltip-C",content:item.n+" ("+item.dsc+")",posType:mstrmojo.tooltip.POS_TOPLEFT,top:position.y,left:position.x+position.w+6},richTooltip);}return richTooltip;},listHooks:{select:function select(el,item){var primaryDSId=docModel.findDatasetIdFromUnit(attr.did),fnGetNewName=function(an,mn){var baseName=mn+" by "+an,newName=baseName,map=$ARR.hash(allMetrics.map(function(m){return m.n;})),cnt=1;while(map[newName]){newName=baseName+" ("+(cnt++)+")";}return newName;},newName=fnGetNewName(attr.n,item.n),dataService=docModel.getDataService(),getTokenStreamXML=function(metric,attr){var tks=[],funcToken={oi:{did:"8107C31BDD9911D3B98100C04F2233EA",t:11,st:2826,n:"Sum"},v:"Sum"},getDelimiterToken=function(delimiter){return{tp:2,lv:1,v:delimiter};},getItemToken=function(item){var cfg={v:mstrmojo.ME.MetricToken.brackets(item.n),lv:1,oi:{did:item.did,t:item.t,n:item.n}};if(item.st){cfg.oi.st=item.st;}return cfg;};tks=[funcToken,getDelimiterToken("("),getItemToken(metric),getDelimiterToken(")"),getDelimiterToken("{"),getItemToken(attr),getDelimiterToken("}")];return mstrmojo.ME._MetricEditorHelper.getTokenStreamXML({tks:{items:tks}});},actions=[dataService.getAddDerivedMetricToDatasetAction({dsid:primaryDSId,formula:getTokenStreamXML(item,attr),isTokenStream:true,name:newName,Ids:["$GUID_1"],afb:true,sfb:true}),dataService.getEditDocUnitPropAction({dsid:primaryDSId,unitId:"$GUID_1",unitType:TP_METRIC,prop:2,value:"1"})];docModel.datasetsSettings.unitOpr(newName,"isDeleteWithFilter",true);docModel.datasetsSettings.unitOpr(newName,"completeHide",true);actions=actions.concat(docModel.datasetsSettings.getSaveActions());dataService.submitUpdates(actions,mstrmojo.func.wrapMethods(docModel.getDatasetsUpdateCallback(),{success:function(res){var units=fnGetDisplayUnits(res.datasets,["mx"]).filter(function(m){return $ARR.find(allMetrics,"did",m.did)===-1;}).map(function(element){element.isTopRank=true;element.qt=TOPN_DEFAULT_QT;element.cs=TOPN_DEFAULT_N;return element;});docModel.addFilterStackSelectors(units,selector.fmts["z-index"]+1,null,true);}}));this.hideTooltip();this.parent.parent.closeAllMenus();return true;}}}]}]});}var getDatasetArrayItems=function(datasets){var units=[];(Object.keys(datasets)||[]).forEach(function(datasetKey){var ds=datasets[datasetKey];if(ds&&ds.st!==SUBTYPE_REPORT_CUBE&&ds.st!==SUBTYPE_REPORT_EMMA_CUBE){units=units.concat({n:ds.name,did:datasetKey});}});return units;};function getFilterDatasetMenuEditor(){var selector=this.selector,docModel=selector.model,selectorTargetsDataset=(selector.defn.dsTks||"").split(ITEM_SEP),datasets=docModel.datasets,datasetArrayItems=getDatasetArrayItems(datasets)||[],selectedIndices={};selectorTargetsDataset.forEach(function(did){var idx=$ARR.find(datasetArrayItems,"did",did);if(idx>=0){selectedIndices[idx]=true;}});var dsTargetList=new mstrmojo.ui.CheckList({cssClass:"selectors",items:datasetArrayItems,selectedIndices:selectedIndices});return new mstrmojo.ui.menus.EditorConfig({data:{},cssClass:"filterDataset",contents:[dsTargetList],fnOk:function(){var actions=[],model=selector.model,dataService=model.getDataService(),selItems=dsTargetList.getSelectedItems()||[],keyContext=selector.defn.ck;if(!selItems.length){mstrmojo.alert(mstrmojo.desc(13765,"Please choose at least one dataset as target."));return false;}actions.push(dataService.getClearCtrlTargetAction(keyContext));actions.push(dataService.getClearCtrlTargetDatasetAction(keyContext));if(selItems.length>0){selItems.forEach(function(item){actions.push(dataService.getAddCtrlTargetDatasetAction(keyContext,item.did));});actions.push(dataService.getChangeControlElementSource(keyContext,CTL_ELEMENT_SOURCE_DOCUMENT));model.submitDataDefnUpdate(actions,mstrmojo.func.wrapMethods(docModel.controller.getRefreshCallback(),docModel.controller.resumeVIPanelSelection()));}}});}function getTitle(){var title=this.baseTitle,count=this.count;if(count&&count.length){title+=" ("+count+")";}return title;}function getSummaryText(){var selector=this.selector,defn=selector&&selector.defn,widget=selector.children&&selector.children[0],elements=widget.items,style=selector.style,include=selector.include;if(style!==$STYLES.VISUALIZATION&&(!defn||defn.srct!==TP_ATTRIBUTE)){return"";}if(style===$STYLES.ATTR_QUAL||style===$STYLES.VISUALIZATION||(style===$STYLES.CHECKBOX&&selector.isRecursiveAttributeSelector())){return widget.getSummaryText();}var ces=style===$STYLES.SEARCH_BOX?Object.keys(elements):Object.keys(selector.selIdx),elementLength=ces.length;if(!!selector.unset||ces.indexOf(String($ARR.find(elements,"v",$EH.ELEM_ALL_ID)))>-1){return"";}if(!elementLength){return mstrmojo.desc(2057,"None");}if(style===$STYLES.SCROLLER&&(ces[ces.length-1]-ces[0])===(elementLength-1)){var prefix=include?"":mstrmojo.desc(1099,"Not")+" ";return prefix+(elementLength===1?elements[ces[0]].n:(elements[ces[0]].n+" - "+elements[ces[elementLength-1]].n));}var _rtn=ces.map(function(idx){return elements[idx].n;}).join(", ");if(!defn.include){_rtn=mstrmojo.desc(1099,"Not")+" "+_rtn;}return _rtn;}function getSummaryChildren(text){var me=this;text=text||"";return[{scriptClass:"mstrmojo.Label",alias:"summaryBar",cssClass:"subtitle",title:text,text:text,slot:"summaryNode",onclick:function(){me.clickToCollapse();}}];}function refreshSummaryBar(selector){var filterPortlet=selector.parent;if(filterPortlet.isCollapsed){var summary=getSummaryText.call(filterPortlet),bar=filterPortlet.summaryBar;bar.set("text",summary);bar.set("title",summary);}}function existSameNameObj(selector){var sameTypeObjCollection=[],srcId=selector.defn.srcid,srcType=selector.defn.srct===4?"mx":"att";mstrmojo.hash.forEach(selector.model.datasets,function(dataset){var arr=dataset[srcType];sameTypeObjCollection=sameTypeObjCollection.concat(arr);});var srcObj=$ARR.filterOne(sameTypeObjCollection,function(item){return item.did===srcId;});return !!$ARR.filterOne(sameTypeObjCollection,function(item){return srcObj&&item.n===srcObj.n&&item.did!==srcObj.did&&item.t===srcObj.t;});}function findItemSrcDataset(selector){var srcType=selector.defn.srct===4?"mx":"att",srcId=selector.defn.srcid,srcDataset=[];mstrmojo.hash.forEach(selector.model.datasets,function(dataset){var arr=dataset[srcType];var idx=$ARR.find(arr,"did",srcId);if(idx!==-1){srcDataset.push(dataset.name);}});return srcDataset;}function etraDNDEffect(titleBarNode,domNode){var tId;$DOM.attachEvent(titleBarNode,"mousedown",function(){tId=window.setTimeout(function(){$CSS.addClass(domNode,"showFPBorder");},300);});$DOM.attachEvent(titleBarNode,"mouseup",function(){window.clearTimeout(tId);$CSS.removeClass(domNode,"showFPBorder");});}var __DraggableFP=mstrmojo.mixin({scriptClass:"__DraggableFP",avatarCssClass:"mstrmojo-filterportlet-avatar",selfAvatarCssClass:"mstrmojo-filterportlet-selfAvatar",getDragData:function getDragData(context){var id=this.id,me=this;return{item:this.selector,idx:this.selector.defn.fmts["z-index"],src:mstrmojo.vi.models.EnumDragSources.FILTERS,dim:$DOM.position(this.domNode),parentDim:$DOM.position(this.parent.domNode),setAvatarClass:function setAvatarClass(cls){var portlet=mstrmojo.all[id],avatar=dragWithin(context)?context._selfAvatar:context._avatarNode;if(avatar){var classes=[(avatar===context._selfAvatar?portlet.selfAvatarCssClass:portlet.avatarCssClass),"hasOwnAvatar",cls];avatar.className=classes.join(" ");}},onRemove:function(portlet){delete me.domNode;var docModel=portlet.model;if(me.isVisFilter()){docModel.deleteVisFilterStackSelectors(portlet);}else{var ignoreTargetData=!!(portlet.isFilterNothing&&portlet.isFilterNothing());docModel.deleteFilterStackSelectors([portlet.defn],ignoreTargetData);}}};},isDragValid:function isDragValid(context){return $DOM.contains(this.titlebarNode,context.src.node);},ondragstart:function ondragstart(context){this._super(context);this.domNode.style.display="none";},ondragmove:function ondragmove(context){if(dragWithin(context)){var data=context.src.data,dim=data&&data.dim,pdim=data&&data.parentDim;this.avatar=context._selfAvatar;this.positionAvatar({x:(dim.x-pdim.x),y:(context.tgt.pos.y-pdim.y)});context._avatarNode.style.display="none";context._selfAvatar.style.display="block";return true;}this.avatar=context._avatarNode;context._avatarNode.style.display="block";context._selfAvatar.style.display="none";return this._super(context);},wasDropped:function(){delete this.selector.node.defn.iifp;this.parent.removeChildren(this);this.destroy();},ondragend:function ondragend(context){var domNode=this.domNode;if(domNode){$CSS.removeClass(domNode,"showFPBorder");domNode.style.display="block";}this.avatar=context._avatarNode;this._super(context);if(context._selfAvatar){var parent=this.parent;if(parent){parent.domNode.firstChild.removeChild(context._selfAvatar);}delete context._selfAvatar;}},createAvatar:function createAvatar(el,context){var avatar;if(!context._avatarNode){avatar=context._avatarNode=document.createElement("div");avatar.appendChild(this.titlebarNode.cloneNode(true));avatar.style.margin="20px 0 0 20px";avatar.style.display="none";avatar.className=this.avatarCssClass;}if(!context._selfAvatar){if(this.domNode.className.indexOf("showFPBorder")===-1){$CSS.addClass(this.domNode,"showFPBorder");}avatar=context._selfAvatar=document.createElement("div");avatar.className=this.selfAvatarCssClass;avatar.appendChild(this.domNode.cloneNode(true));var icon=document.createElement("div");icon.className="icon";avatar.appendChild(icon);avatar.style.position="absolute";avatar.style.opacity=0.75;this.parent.domNode.firstChild.appendChild(avatar);}return context._avatarNode;}},mstrmojo.mixin(mstrmojo._HasOwnAvatar,{}));function changeCursorStyleForVisFilter(){if(!this.isVisFilter()){return ;}var i,domNode=this.domNode,labelNodes=domNode.querySelectorAll(".mstrmojo-EditableLabel, .mstrmojo-Label"),rightTbNode=domNode.querySelector(".right-toolbar");domNode.style.cursor="pointer";for(i=0;i<labelNodes.length;i++){labelNodes[i].style.cursor="pointer";}if(rightTbNode){rightTbNode.style.cursor=CSS_CURSOR_DEFAULT;}}mstrmojo.vi.ui.rw.FilterPortlet=mstrmojo.declare(mstrmojo.vi.ui.PanelPortlet,[__DraggableFP,mstrmojo.vi.ui.rw.selectors._HasFilterContextMenu,mstrmojo.vi._MonitorsAppState,mstrmojo.vi._MonitorsLayoutMode,mstrmojo.util.ui._HostsSplitter,mstrmojo._HasPopup],{scriptClass:"mstrmojo.vi.ui.rw.FilterPortlet",markupString:'<div id="{@id}" class="mstrmojo-VIPanel {@cssClass}" style="{@cssText}" mstrAttach:mouseover,mouseout,click><div class="mstrmojo-VIPanel-titlebar"></div><div class="mstrmojo-VIPanel-content"></div><div class="mstrmojo-summary-Label"></div><div class="mstrmojo-VIDND-mask"></div><div class="mstrmojo-VIPanel-handle splitter v"></div></div>',markupSlots:{titlebarNode:function(){return this.domNode.firstChild;},containerNode:function(){return this.domNode.childNodes[1];},summaryNode:function(){return this.domNode.childNodes[2];},maskNode:function(){return this.domNode.childNodes[3];},handleNode:function(){return this.domNode.lastChild;}},layoutConfig:{h:{titlebarNode:"20px",containerNode:"100%",handleNode:"4px"},w:{titlebarNode:"all",containerNode:"all"},xt:true},canCollapse:true,showTitleBarContextMenu:true,srcId:"",selector:null,summaryBar:null,init:function init(props){this._super(props);if(!!mstrApp.isWSStyling){this.layoutConfig={h:{titlebarNode:"26px",containerNode:"100%",handleNode:"1px"},w:{titlebarNode:"all",containerNode:"all",handleNode:"all"},xt:true};}if(this.isVisFilter()||$HASH.walk("selector.node.data.disabled",this)){this.isCollapsed=true;this.set("isCollapsed",true);this.titleBar.set("isCollapsed",true);}},getLayoutOffsets:function(){return(!!mstrApp.isWSStyling)?{h:0,w:mstrApp.isWorkstation&&$DOM.isMac()?16:18}:this._super();},postBuildRendering:function postBuildRendering(){var handleNode=this.handleNode;$CSS.addClass(handleNode,"showSplitter "+mstrApp.getThemeClassName());$CSS.removeClass(handleNode,"v");$CSS.addClass(handleNode,"h");handleNode.style.cursor=this.isCollapsed?CSS_CURSOR_DEFAULT:CSS_CURSOR_NS_RESIZE;if(this.isCollapsed){this.unRegisterSplitter(this.handleNode);}else{this.registerSplitter(this.handleNode);}var titleBar=this.titleBar,label=titleBar.lblTitle,fnLabelOnclick=label.onclick;label.onclick=function(evt){var timeout=this._timeoutClick,me=this;if(!timeout){this._timeoutClick=window.setTimeout(function(){fnLabelOnclick.call(label,evt);titleBar.btnCollapse.onclick(evt);delete me._timeoutClick;},DOUBLE_CLICK_INTERVAL);}};if(this.isVisFilter()){titleBar.btnCollapse.src=URL_VISFILTERIMG;$CSS.addClass(this.titlebarNode,CSSCLS_VISFILTER);this.domNode.style["padding-right"]="13px";label.onTextEditComplete=function(textChanged,oldText){var newText=this.text,filterPortlet=this.parent.parent,selector=filterPortlet.selector,filterKey=selector.k,docModel=selector.model;if(textChanged){docModel.renameRWUnitTitle(newText,oldText,filterKey,{success:function(appliedTitle){filterPortlet.set("baseTitle",appliedTitle);},failure:function(err){mstrmojo.err(err);filterPortlet.set("baseTitle",oldText);}});}};}etraDNDEffect(this.titlebarNode,this.domNode);if(this.isCollapsed&&!this.summaryBar&&!this.selector.isInvalid){this.addChildren(getSummaryChildren.call(this,getSummaryText.call(this)));}this.height=Math.max(parseInt(this.height,0),MIN_HEIGHT)+"px";if((mstrApp.isAppStatePresentation&&mstrApp.isAppStatePresentation())||(mstrApp.isLayoutModePreview&&mstrApp.isLayoutModePreview())){this.draggable=false;}var ret=this._super();changeCursorStyleForVisFilter.call(this);return ret;},onAppStateChange:function onAppStateChange(evt){var appStates=mstrmojo.vi.VisualInsightApp.APP_STATES,presentationMode=appStates.PRESENTATION,isPresentationOn=evt.value&presentationMode,isPause=mstrApp.isAppStatePause(),wasPause=!!(evt.valueWas&appStates.PAUSE);if(isPresentationOn||(evt.valueWas&presentationMode)){this.draggable=!(isPresentationOn||mstrApp.isLayoutModePreview());this.generateToolbar();}if(isPause&&!wasPause){var selector=this.selector,data=selector&&selector.node&&selector.node.data;if(data&&data[$DATA_PARAMS.DISABLED]){this.isCollapsed=true;this.set("isCollapsed",true);this.titleBar.set("isCollapsed",true);}}},onLayoutModeChange:function onLayoutModeChange(evt){var isPreviewOn=mstrApp.isLayoutPreview(evt.value);if(isPreviewOn||mstrApp.isLayoutPreview(evt.valueWas)){this.draggable=!(mstrApp.isAppStatePresentation()||isPreviewOn);this.generateToolbar();}},getFormats:function getFormats(){var fmts=this.selector.getFormats();delete fmts.left;delete fmts.top;return fmts;},getTitleBarCfg:function getTitleBarCfg(){var cfg=this._super(),selector=this.selector,me=this;cfg.isCollapsed=this.isCollapsed;this.baseTitle=cfg.title;this.title=cfg.title=getTitle.call(this);cfg.useRichTooltip=true;cfg.updateTooltipConfig=function updateTooltipConfig(evt){if(selector&&selector.isInvalid){var domNode=me.domNode;this.richTooltip={posType:mstrmojo.tooltip.POS_TOPLEFT,content:this.getTooltipContent(evt),refNode:domNode,top:3,left:domNode&&(domNode.getBoundingClientRect().width+5),cssClass:"vi-regular vi-tooltip-C"};}else{return this.constructor.prototype.updateTooltipConfig.call(this,evt);}};cfg.shouldShowTooltip=function shouldShowTooltip(evt,win){this._showTooltipForSameNameObj=existSameNameObj(selector);return this.constructor.prototype.shouldShowTooltip.call(this,evt,win)||this._showTooltipForSameNameObj||selector.isInvalid;};cfg.getTooltipContent=function getTooltipContent(evt){if(selector&&selector.isInvalid){return selector.getInvalidTooltip();}return this.constructor.prototype.getTooltipContent.call(this,evt)+(this._showTooltipForSameNameObj?"("+mstrmojo.string.encodeHtmlString(findItemSrcDataset(selector).join(","))+")":"");};cfg.getTitleChildrenLayoutOffsets=function getTitleChildrenLayoutOffsets(){return{h:2,w:3};};cfg.layoutConfig={w:{leftToolNode:"18px",textNode:"100%",rightToolNode:"22px"},h:{leftToolNode:"100%",textNode:"100%",rightToolNode:"100%"},xt:true};if(selector.isInvalid){cfg.canCollapse=false;}return cfg;},onisCollapsedChange:function onisCollapsedChange(){if(this.isVisFilter()){this.isCollapsed=true;this.clickToCollapse();return ;}var portlet=this,portletKey=portlet.k,selector=this.selector,model=selector.model,isCollapsed=this.isCollapsed,ds=isCollapsed?1:0;selector.defn.set("ds",ds);selector.set("visible",!isCollapsed);this.handleNode.style.cursor=this.isCollapsed?CSS_CURSOR_DEFAULT:CSS_CURSOR_NS_RESIZE;if(this.isCollapsed){this.unRegisterSplitter(this.handleNode);}else{this.registerSplitter(this.handleNode);}if(!this._onCollapseAll){var filterPanel=model.getVIComponent($VI_TYPES.FILTER_PANEL),updateFilterPanelScrollBars=function(){filterPanel.raiseEvent({name:"filterPanelUpdated"});};model.execute({execute:function(){this.submit(model.getUnitFormatAction(selector,1,{FormattingView:{WindowState:ds}}),{success:function(){if(!isCollapsed&&!portlet.isVisFilter()){selector.expandOrEditToFetchElements();}updateFilterPanelScrollBars();}},$HASH.copy(mstrmojo.DocDataService.REQUEST_ONLY_DEFINITION,{resolveOnly:true}));},urInfo:{callback:{success:function(res){model.updateDefnCache(res.defn,[portletKey]);filterPanel.rebuildChild(filterPanel.children.filter(function(child){return child.k===portletKey;})[0]);updateFilterPanelScrollBars();}},treesToRender:1}});}var summaryBar=this.summaryBar;if(isCollapsed&&!selector.isInvalid){var summaryText=getSummaryText.call(this);if(!summaryBar){this.addChildren(getSummaryChildren.call(this,summaryText));}else{summaryBar.set("text",summaryText);summaryBar.set("title",summaryText);summaryBar.render();}}else{if(summaryBar){summaryBar.unrender();this.removeChildren(summaryBar);}}},oncountChange:function oncountChange(){this.set("title",getTitle.call(this));},onbaseTitleChange:function onbaseTitleChange(){this.set("title",getTitle.call(this));},clearFilters:function clearFilters(){var selector=this.selector;if(selector){selector.clearSelector();refreshSummaryBar(selector);}},updateSummaryBar:function updateSummaryBar(selections){var selector=this.selector,visSelectorBox=selector&&selector.content;if(visSelectorBox&&selector.style===$STYLES.VISUALIZATION){visSelectorBox.updateSummaryText(selections);refreshSummaryBar(selector);}},refreshFilterSummaryBar:function refreshFilterSummaryBar(){var selector=this.selector;if(selector){refreshSummaryBar(selector);}},getSplitterInfo:function getSplitterInfo(){return{min:VIS_MIN_HEIGHT};},splitterMoved:function splitterMoved(position){var value=parseInt(this.height,10)+position+"px",oldHeight,selector=this.selector,model=selector.model,handleNode=this.handleNode,me=this,filterPanel=me.parent,fnSetHeright=function(h){var portlet=me;if(!portlet.parent){(filterPanel.children||[]).forEach(function(item){if(item.k===portlet.k){portlet=item;}});}oldHeight=portlet.height;portlet.set("height",h);handleNode.style.top="";portlet.doLayout();selector.getFilterPanel().updateScrollbars();};fnSetHeright(value);var action=model.getUnitFormatAction(selector,1,{FormattingSize:{Height:mstrmojo.boxmodel.px2Inches(model.getZoomProps(),value)}}),callback={success:function(res){model.updateDefnCache(res.defn,[selector.k]);}},extras={style:{params:{treesToRender:1}}};model.execute({execute:function(){this.submit(action,callback,extras);},urInfo:{undo:function(){fnSetHeright(oldHeight);},redo:function(){fnSetHeright(oldHeight);},callback:callback,extras:extras}});},setSlotDimensions:function setSlotDimensions(slot,h,w){if(slot!=="containerNode"){this._super(slot,h,w);}},doLayout:function doLayout(){this._super();var domNode=this.domNode;if(domNode){domNode.style.height="auto";}},addMenuItems:function addMenuItems(cfg){var me=this,selector=me.selector,isInvalid=selector&&selector.isInvalid,deleteCallBackfn=function deleteCallBackfn(){var docModel=selector.model;if(me.isVisFilter()){me.closeVisSelectorPanel();docModel.deleteVisFilterStackSelectors(selector);}else{var ignoreTargetData=!!(selector.isFilterNothing&&selector.isFilterNothing());docModel.deleteFilterStackSelectors([selector.defn],ignoreTargetData);}};cfg.isHostedWithin=false;cfg.hostId=this.id;cfg.supportsScroll=true;cfg.maxHeight=$DOM.getMaxScrollHeight();if(isInvalid){cfg.addMenuItem(mstrmojo.desc(629,"Delete"),"Delete",deleteCallBackfn);return ;}this.addModeMenuItems(cfg,selector,function(){refreshSummaryBar(selector);});cfg.addSeparator();this.addShowAllMenuItem(cfg,selector);cfg.addSeparator();var ctrlKey=selector.ckey,filterPanel=selector.getFilterPanel(),portletId=this.id,isPresentationMode=mstrApp.isAppStatePresentation(),selectorId=selector.defn.srcid,model=selector.model,isFromMDXCube=model.isFromMDXCube(selectorId),isFromSolr=model.isFromSolrCube(selectorId);this.addClearFilterMenuItem(cfg,selector,function(){filterPanel.clearSingleBuffSlice(ctrlKey);refreshSummaryBar(selector);});cfg.addSeparator();this.addQualMenuItems(cfg,selector);if(!isPresentationMode){if(selector.isAttributeSelector()&&!isFromMDXCube&&!isFromSolr){cfg.addEditorMenuItem(mstrmojo.desc(13628,"Filter by Rank"),portletId,getTopRankSubMenuEditor);}cfg.addSeparator();this.addSetDisplayFormsMenuItem(cfg,selector);cfg.addSeparator();if(!isFromSolr){this.addFilterStyleMenuItem(cfg,selector);}this.addMultiSelectMenuItem(cfg,selector);this.addAutoSearchMenuItem(cfg,selector);cfg.addSeparator();}if(selector.supportsSetTarget()&&!isFromSolr){this.addMenuItemIfSelectTargetsValid(cfg,selector,mstrmojo.desc(11572,"Select other filters within the Filter panel."));cfg.addSeparator();}if(!isPresentationMode&&selector.style===mstrmojo.DocSelector.STYLES.VISUALIZATION){this.addConfigVisSelectorMenu(cfg,selector);cfg.addSeparator();}if(!isPresentationMode){this.addReplaceWithMenuItem(cfg,selector);cfg.addSeparator();if(me.isVisFilter()){cfg.addMenuItem(mstrmojo.desc(1388,"Rename"),"rnm",function(){me.titleBar.lblTitle.set("isEditing",true);});}cfg.addMenuItem(mstrmojo.desc(629,"Delete"),"Delete",deleteCallBackfn);}var menus=cfg.menus,len=menus.length,i,low=-1,high=len;if(menus&&len>1){for(i=0;i<len;i++){if(menus[i].cls!=="seperator"){break;}low=i;}for(i=len-1;i>=0;i--){if(menus[i].cls!=="separator"){break;}high=i;}cfg.menus=menus.slice(low+1,high);}},getTargetInfo:function getTargetInfo(){var selector=this.selector,model=selector.model;var targetItems=selector.getFilterPanel().getFilterDefinitions().filter(function(defn){return(defn.ckey!==selector.ckey)&&((defn.srct===TP_ATTRIBUTE&&defn.style!==$STYLES.ATTR_QUAL)||defn.srct===TP_CONSOLIDATION||defn.srct===STP_CUSTOM_GROUP);}).map(function(defn){return{n:defn.ttl,id:defn.ckey,st:defn.style,src:model.getObjectInfo(defn.srcid)};});return{keys:(selector.defn.tks||"").split(ITEM_SEP).filter(function(key){return targetItems.some(function(item){return item.id===key;});}),items:targetItems};},isVisFilter:function isVisFilter(){return this.selector.style===$STYLES.VISUALIZATION;},clickToCollapse:function clickToCollapse(){if(!this.isVisFilter()){return ;}var stack=this.parent&&this.parent.parent,model=stack&&stack.model,nodeKey=this.k,me=this,selector=this.selector;if(mstrApp.isAppStatePause&&mstrApp.isAppStatePause()){if(mstrApp.isInVFConfigMode){return ;}var container=model.addVisFilterContainer(),oldSelectedUnit=model.getSelectedViUnit(),vizBox;model.oldSelectedVizBoxId=oldSelectedUnit.id;mstrApp.isInVFConfigMode=true;mstrApp.restoreVFKey=nodeKey;vizBox=model.insertVizBox(nodeKey,container,{});model.controller.rootCtrl.initPanelStautsInConfigMode();model.selectVIUnit(vizBox.id,true,{isAddAction:true});mstrApp.getRootController().enterVizFilterConfigMode(selector.parent.baseTitle,true);return ;}if(model){me.openVizSelectorPanel(nodeKey,model);}},openVizSelectorPanel:function openVizSelectorPanel(nodeKey,model){if(!nodeKey||!model||visFilterDisplayPanel){return ;}var selector=this.selector;mstrApp.isInVFInteractMode=true;visFilterDisplayPanel=new VisFilterDisplayPanel({nodeKey:nodeKey,model:model,filterPortlet:this,include:selector.include});$CSS.addClass(this.domNode,CSS_EXPANDED);this.openPopup(visFilterDisplayPanel);model.cachePrevSelectedUnitId();},updateVizSelectorPanel:function updateVizSelectorPanel(){var node=this.selector&&this.selector.node;if(visFilterDisplayPanel&&node){visFilterDisplayPanel.updateVis(node);}},updateVisFilterTitle:function updateVisFilterTitle(){if(visFilterDisplayPanel){visFilterDisplayPanel.updateTitleBar();}},closeVisSelectorPanel:function closeVisSelectorPanel(){if(visFilterDisplayPanel){visFilterDisplayPanel.cancelSelections();}},resetVisFilterState:function resetVisFilterState(){$CSS.removeClass(this.domNode,CSS_EXPANDED);visFilterDisplayPanel=null;mstrApp.isInVFInteractMode=false;delete this._lastOpened;},updateForScroll:function updateForScroll(){if(mstrApp.isInVFInteractMode&&visFilterDisplayPanel){visFilterDisplayPanel.updateFormats();}},destroy:function destroy(){if(visFilterDisplayPanel){visFilterDisplayPanel.cancelSelections();}if(this._super){this._super();}}});}());