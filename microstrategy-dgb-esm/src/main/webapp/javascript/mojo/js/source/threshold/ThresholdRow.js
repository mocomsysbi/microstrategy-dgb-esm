(function(){mstrmojo.requiresCls("mstrmojo.Box","mstrmojo.Label","mstrmojo.hash","mstrmojo.array","mstrmojo.ui.Checkbox","mstrmojo.css","mstrmojo.string","mstrmojo.threshold.ThresholdExprTree","mstrmojo.ui.menus._HasMenuPopup","mstrmojo.models.FormatModel.getFormatUpdate","mstrmojo.vi.ui.DatasetUnitMenuUtils","mstrmojo.threshold.ThresholdModel.REPLACE_SYMBOL","mstrmojo.vi.util.NumberFormatUtility");mstrmojo.requiresDescs(2869,3397,5893,7978,7979,13788,13789,13790,13894,14599,14600,14601,14611);var $HASH=mstrmojo.hash,$ARR=mstrmojo.array,$CSS=mstrmojo.css,$STR=mstrmojo.string,$DECODE_FORMAT=mstrmojo.models.FormatModel.decodeValue,REPLACE_SYMBOL=mstrmojo.threshold.ThresholdModel.REPLACE_SYMBOL,$DU=mstrmojo.vi.ui.DatasetUnitMenuUtils,TYPE_ATTRIBUTE=12,ENUM_NUMBER_FORMAT_KEYS_OBJ=mstrmojo.models.FormatModel.ENUM_NUMBER_FORMAT_KEYS_OBJ,$NUMFORMATUTIL=mstrmojo.vi.util.NumberFormatUtility;function applyTo(value){this.threshold.scope=value;}function setPreviewContent(replaceType,replaceText,objectType,nf){var previewNode=this.previewNode;switch(replaceType){case 10:var symbol=$ARR.filterOne(REPLACE_SYMBOL,function(s){return s.v===replaceText;});if(symbol){previewNode.innerHTML=symbol.n;}break;case 4:$CSS.addClass(previewNode,"hasImage");previewNode.innerHTML='<img class="replaceImg" src="'+$STR.encodeHtmlString(replaceText)+'" />';break;default:var previewText=$STR.encodeHtmlString(replaceText)||(objectType===TYPE_ATTRIBUTE?mstrmojo.desc(14611,"Sample"):"1234.567");if(!!nf){previewText=$NUMFORMATUTIL.applyFormatToNumber(nf,previewText);}previewNode.innerHTML=previewText;}}function setPreviewFormat(format,style){style.fontFamily="'"+(format.ff||"").replace(/\'/g,"")+"'";style.fontSize=parseInt(format.fsz,10)+"pt";style.fontWeight=format.fw?"bold":"normal";style.textDecoration=(format.fun?"underline":"")+" "+(format.fst?"line-through":"");style.fontStyle=format.fit?"italic":"";style.color=format.fc;var gradient;if(!!format.bc&&!!format.bc.c1){gradient=$CSS.buildGradient(format.bc.or,format.bc.c1,format.bc.c2);if(gradient&&gradient.n){style[gradient.n]=gradient.v;}}else{if(!!format.gdc){gradient=$CSS.buildGradient(format.gda===90?0:1,format.bc,format.gdc);if(gradient&&gradient.n){style[gradient.n]=gradient.v;}}else{style.backgroundColor=format.bc;}}style.textAlign=format.alh;style.verticalAlign=format.alv;style.wordWrap=format.atw;style.direction=format.atd;var bts=format.bts;style.border=format.borderStyle||(bts?$DECODE_FORMAT("bts",bts):"1px dotted");style.borderColor=format.borderColor||format.btc||"#e1e1e1";}mstrmojo.threshold.ThresholdRow=mstrmojo.declare(mstrmojo.Box,[mstrmojo.ui.menus._HasMenuPopup],{scriptClass:"mstrmojo.threshold.ThresholdRow",markupString:'<div id="{@id}" class="mstrmojo-thresholdRow cf {@cssClass}" style="{@cssText}" mstrAttach:click><div class="draggable-icon"></div><div class="container"></div><div class="previewWrap"><div class="preview"></div></div><div class="menu"></div><div class="delete"></div></div>',markupSlots:{containerNode:function containerNode(){return this.domNode.children[1];},draggableNode:function draggableNode(){return this.domNode.firstChild;},previewNode:function containerNode(){return this.domNode.children[2].firstChild;},menuNode:function containerNode(){return this.domNode.children[3];},deleteNode:function deleteNode(){return this.domNode.children[4];}},threshold:undefined,idx:undefined,editor:undefined,model:undefined,lblIndex:undefined,chkBox:undefined,exprTree:undefined,postBuildRendering:function postBuildRendering(){this.destroyChildren(false);var threshold=this.threshold,model=this.model,style=this.previewNode.style,format=$HASH.copy(threshold.fmt,$HASH.clone(model.getGridValueFormat())),expr=threshold.expr;setPreviewContent.call(this,threshold.rtp,threshold.rtxt,model.objectType,format.nfs);if(format){setPreviewFormat(format,style);}this.destroyChildren(false);this.addChildren([{scriptClass:"mstrmojo.Label",alias:"lblIndex",text:this.idx+1},{scriptClass:"mstrmojo.threshold.ThresholdExprTree",alias:"exprTree",editor:this.editor,model:this.model,items:[expr]}]);model.attachEventListener("selectedThresholdsChange",this.id,"onselectedThresholdsChange");return this._super();},onselectedThresholdsChange:function onselectedThresholdsChange(){},onclick:function onclick(event){var editor=this.editor,target=event.getTarget(),me=this,model=this.model,isAttribute=editor.objectType===TYPE_ATTRIBUTE;if(target===this.deleteNode){this.removeFromModel();}else{if(target===this.menuNode){var menuCfg=new mstrmojo.ui.menus.MenuConfig();menuCfg.hostId=this.id;menuCfg.hostElement=this.menuNode;menuCfg.isHostedWithin=false;menuCfg.addSubMenuItem(mstrmojo.desc(13788,"Apply to"),"",editor.id,function(){var cfg=new mstrmojo.ui.menus.MenuConfig();cfg.addRadioMenuGroup(me.threshold.scope||1,applyTo,[{value:1,text:isAttribute?mstrmojo.desc(14599,"Element Rows Only"):mstrmojo.desc(13789,"Metric Only")},{value:2,text:isAttribute?mstrmojo.desc(14600,"Subtotal Rows Only"):mstrmojo.desc(13790,"Subtotals Only")},{value:3,text:isAttribute?mstrmojo.desc(14601,"Elements and Subtotals"):mstrmojo.desc(13894,"Metric and Subtotals")}],"",me,true);return cfg;});menuCfg.addMenuItem(mstrmojo.desc(2869,"Formatting"),"",function(){editor.openPropertyPanel(me);});if(model.showNumberFormat()){menuCfg.addEditorMenuItem(mstrmojo.desc(13237,"Number Format"),"",function(){var submitNumberFormatAction=function(numberFormat){$HASH.forEach(numberFormat,function(v,k){if(!me.threshold.fmt){me.threshold.fmt={};}me.threshold.fmt[k]=v;});me.model.raiseEvent($HASH.copy(me.model,{name:"modelEdit"}));};return $DU.getNumberFormatEditor(me,me.threshold.fmt||{},function(data){var modFormat={};modFormat[ENUM_NUMBER_FORMAT_KEYS_OBJ.CATEGORY]=data.category||-3;modFormat[ENUM_NUMBER_FORMAT_KEYS_OBJ.CURRENCY_POSITION]=data.currencyPosition||0;modFormat[ENUM_NUMBER_FORMAT_KEYS_OBJ.CURRENCY_SYMBOL]=data.currencySymbol||"$";modFormat[ENUM_NUMBER_FORMAT_KEYS_OBJ.DECIMAL_PLACES]=data.decimalPlaces||2;modFormat[ENUM_NUMBER_FORMAT_KEYS_OBJ.FORMAT]=data.format||"";modFormat[ENUM_NUMBER_FORMAT_KEYS_OBJ.NEGATIVE_NUMBERS]=data.negativeNumbers||3;modFormat[ENUM_NUMBER_FORMAT_KEYS_OBJ.THOUSAND_SEPARATOR]=data.thousandSeparator||0;submitNumberFormatAction(modFormat);});});}menuCfg.addMenuItem(mstrmojo.desc(3397,"Duplicate"),"",function(){model.duplicateThreshold(me.idx);});if(this.idx!==0){menuCfg.addMenuItem(mstrmojo.desc(7978,"Move Up"),"",function(){model.moveThreshold(me.idx,me.idx-1);});}else{menuCfg.addNonInteractiveMenuItem(mstrmojo.desc(7978,"Move Up"),"",true);}if(this.idx!==model.thresholds[model.metricId].length-1){menuCfg.addMenuItem(mstrmojo.desc(7979,"Move Down"),"",function(){model.moveThreshold(me.idx,me.idx+1);});}else{menuCfg.addNonInteractiveMenuItem(mstrmojo.desc(7979,"Move Down"),"",true);}menuCfg.addMenuItem(mstrmojo.desc(5893,"New Condition"),"",function(){me.exprTree.newCondition(null);});this.openPopup(menuCfg.newInstance());}else{if(target===this.previewNode||target===this.previewNode.firstChild){editor.openPropertyPanel(this);}}}},removeFromModel:function removeFromModel(){this.model.deleteThreshold(this.threshold);},onpropertyModelChange:function onpropertyModelChange(evt){$HASH.copy(evt.threshold,$HASH.clear(this.threshold));this.refresh();}});}());