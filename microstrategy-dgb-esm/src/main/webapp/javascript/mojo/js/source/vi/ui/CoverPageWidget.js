(function(){mstrmojo.requiresCls("mstrmojo.Box","mstrmojo.array","mstrmojo.css","mstrmojo.url","mstrmojo.vi._MonitorsAppState","mstrmojo.vi.controllers.EnumEvents","mstrmojo.vi.ui.editors.CoverPageEditor","mstrmojo.vi.ui.rw.selectors._HasWarningMessage");mstrmojo.requiresDescs(15016,15017,15018,15019,15020);var ARRAY=mstrmojo.array,CSS=mstrmojo.css,URL=mstrmojo.url,EVENTS=mstrmojo.vi.controllers.EnumEvents;var COVER_IMAGE_WIDTH=80,COVER_IMAGE_HEIGHT=45;function allowManipulation(){return !(mstrApp.isAppStatePresentation()||mstrApp.isLayoutModePreview()||mstrApp.isAppStateSelection());}mstrmojo.vi.ui.CoverPageWidget=mstrmojo.declare(mstrmojo.Box,[mstrmojo.vi.ui.rw.selectors._HasWarningMessage,mstrmojo.vi._MonitorsAppState],{scriptClass:"mstrmojo.vi.ui.CoverPageWidget",markupString:'<div id="{@id}" class="mstrmojo-Box {@cssClass}" style="{@cssText}"><div class="image-and-btn"><img class="mstrmojo-coverpage-image" src="{@absImgUrl}" height="45px" mstrAttach:error,load><div class="mstrmojo-coverpage-default"></div><div class="mstrmojo-coverpage-btn" mstrAttach:click><span>{@btnText}</span></div></div><div class="extraInfo"><span>{@extraInfo}</span></div></div>',markupSlots:{containerNode:function(){return this.domNode;},imgAndBtnNode:function(){return this.domNode.firstChild;},imgNode:function(){return this.domNode.firstChild.firstChild;},defaultImgNode:function(){return this.domNode.firstChild.children[1];},buttonImgNode:function(){return this.domNode.firstChild.children[2];},extraInfoNode:function(){return this.domNode.children[1];}},cssClass:"mstrmojo-coverpage",imageUrl:"",absImgUrl:"",extraInfo:"",lastModifiedTime:null,chapterAndPageCnt:{chapter:0,page:0},btnText:mstrmojo.desc(15020,"Change Cover"),intervalID:null,modelId:null,coverPageEditor:null,onclick:function(){if(!allowManipulation()){return ;}if(!this.coverPageEditor){this.coverPageEditor=this.addDisposable((new mstrmojo.vi.ui.editors.CoverPageEditor({id:"coverPageEditor",originURL:this.imageUrl,helpText:null,onSave:function onSave(newURL,changed,isAccessible){if(changed){var me=this;mstrmojo.all[this.modelId].raiseEvent({name:EVENTS.CHANGE_COVER_IMAGE,url:newURL,originUrl:this.imageUrl,callback:function(url){me.set("imageUrl",url);if(!isAccessible){window.setTimeout(function(){me.showWarning({refNode:me.containerNode,position:2,invalid:true,errorMsg:mstrmojo.desc(15021,"Sorry, this image cannot be loaded, either because the URL is not valid, or there is no internet connection. Please enter a valid URL, and make sure the internet is connected."),errorCode:null,highlight:false,lasting:4000});},0);}}});}}.bind(this),afterSave:function afterSave(){this.close();},afterCancel:function afterCancel(){this.close();}})));}this.coverPageEditor.originURL=this.imageUrl;this.coverPageEditor.open();},onerror:function(){if(this.imageUrl){CSS.toggleClass(this.imgAndBtnNode,"error",true);}else{CSS.toggleClass(this.imgAndBtnNode,"default",true);}},onload:function(){CSS.toggleClass(this.imgAndBtnNode,"default",false);CSS.toggleClass(this.imgAndBtnNode,"error",false);var imgNode=this.imgNode,imgWidth=imgNode.naturalWidth,imgHeight=imgNode.naturalHeight;if((imgWidth/imgHeight)>(COVER_IMAGE_WIDTH/COVER_IMAGE_HEIGHT)){imgNode.width=COVER_IMAGE_WIDTH;imgNode.height=(COVER_IMAGE_WIDTH/imgWidth)*imgHeight;}else{imgNode.height=COVER_IMAGE_HEIGHT;imgNode.width=(COVER_IMAGE_HEIGHT/imgHeight)*imgWidth;}imgNode.style.padding=(COVER_IMAGE_HEIGHT-imgNode.height)/2+"px "+(COVER_IMAGE_WIDTH-imgNode.width)/2+"px";},onRender:function(){CSS.toggleClass(this.buttonImgNode,"disabled",!allowManipulation());if(this._super){return this._super();}},init:function init(props){this._super(props);var me=this;if(this.lastModifiedTime){this.intervalID=window.setInterval(function(){me.onlastModifiedTimeChange();},5000);}this.bindWarningHandler(this);},onimageUrlChange:function onimageUrlChange(){if(mstrApp&&mstrApp.getWSLiveMode&&mstrApp.getWSLiveMode()&&this.imageUrl.indexOf(";base64,")===-1){this.absImgUrl=encodeURI(decodeURIComponent(URL.getAbsoluteURL(this.imageUrl,window.FormWrapper.getDossierServerURL())));}else{this.absImgUrl=encodeURI(decodeURIComponent(this.imageUrl));}this.refresh();},destroy:function destroy(){if(this.intervalID){window.clearInterval(this.intervalID);}this._super();},onlastModifiedTimeChange:function onlastModifiedTimeChange(){if(!!this.lastModifiedTime){var currentDate=new Date(),currentTime=currentDate.getTime(),timeElapsed=currentTime-this.lastModifiedTime,me=this;if(timeElapsed<0){return ;}window.clearInterval(me.intervalID);if(timeElapsed<1000){me.set("extraInfo","Just saved");me.intervalID=window.setInterval(function(){me.onlastModifiedTimeChange();},5000);return ;}var timeInfo=[{value:null,name:"years",suffix:"year",suffixPlural:"years"},{value:null,name:"months",suffix:"month",suffixPlural:"months"},{value:null,name:"days",suffix:"day",suffixPlural:"days"},{value:null,name:"hours",suffix:"hour",suffixPlural:"hours",interval:3600000},{value:null,name:"minutes",suffix:"min",suffixPlural:"min",interval:60000},{value:null,name:"seconds",suffix:"s",suffixPlural:"s",interval:5000}];timeElapsed=Math.floor(timeElapsed/1000);timeInfo[5].value=timeElapsed%60;timeElapsed=Math.floor(timeElapsed/60);timeInfo[4].value=timeElapsed%60;timeElapsed=Math.floor(timeElapsed/60);timeInfo[3].value=timeElapsed%60;timeElapsed=Math.floor(timeElapsed/24);timeInfo[2].value=timeElapsed;timeInfo[1].value=Math.floor(timeElapsed/30.5)%12;timeInfo[0].value=Math.floor(timeElapsed/365);ARRAY.forEach(timeInfo,function(item){if(!!item.value){me.set("extraInfo","Saved: "+item.value+(item.value===1?item.suffix:item.suffixPlural)+" ago");var interval=item.interval;if(interval){me.intervalID=window.setInterval(function(){me.onlastModifiedTimeChange();},interval);}return false;}});}},onchapterAndPageCntChange:function onchapterAndPageCntChange(){var cnt=this.chapterAndPageCnt,chapterStr=(cnt.chapter>1)?mstrmojo.desc(15016,"## Chapters").replace("##",cnt.chapter):mstrmojo.desc(15017,"## Chapter").replace("##",cnt.chapter),pageStr=(cnt.page>1)?mstrmojo.desc(15018,"## Pages").replace("##",cnt.page):mstrmojo.desc(15019,"## Page").replace("##",cnt.page);this.set("extraInfo",chapterStr+"<br>"+pageStr);},onextraInfoChange:function ontimeStampInfoChange(){if(this.extraInfoNode){this.extraInfoNode.innerHTML="<span>"+this.extraInfo+"</span>";}},onAppStateChange:function(evt){if(this._super){this._super(evt);}CSS.toggleClass(this.buttonImgNode,"disabled",!allowManipulation());}});}());