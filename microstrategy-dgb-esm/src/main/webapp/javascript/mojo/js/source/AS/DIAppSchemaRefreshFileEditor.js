(function(){mstrmojo.requiresCls("mstrmojo.Editor","mstrmojo.Button","mstrmojo.dom","mstrmojo.Label","mstrmojo.tooltip","mstrmojo.CheckBox","mstrmojo.TextBox","mstrmojo.SREditor","mstrmojo.DI.DIHelpers","mstrmojo.locales","mstrmojo.date","mstrmojo.css","mstrmojo.string","mstrmojo.AS.DIAppSchemaService","mstrmojo.AS.DIAppSchemaRepublishOAuthButton");var $A=mstrmojo.array,$H=mstrmojo.hash,$DIHelper=mstrmojo.DI.DIHelpers,$S=mstrmojo.string,constants=mstrmojo.DI.DIConstants,$CSS=mstrmojo.css,MAX_FILE_SIZE=4*1024*1024,$OAUTHENUM=[constants.sourceType.dropbox,constants.sourceType.googleAnalytics,constants.sourceType.googleBigQuery,constants.sourceType.googleDrive,constants.sourceType.salesforce];mstrmojo.AS.DIAppSchemaRefreshFileEditor=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.AS.DIAppSchemaRefreshFileEditor",cssClass:"mstrmojo-di-scheduleEMMA workstation mstrmojo-di-appschema-refresh-file-editor",title:"Update Tables",onClose:function(){mstrApp.getRootController().model.detachEventListener(this.OAuthInfoUpdateListener);},sourceData:null,postData:null,callback:mstrmojo.emptyFn,OAuthInfoUpdateListener:null,preBuildRendering:function(){this.OAuthInfoUpdateListener=mstrApp.getRootController().getModel().attachEventListener("OAuthInfoUpdate",this.id,"OAuthInfoUpdate");if(this._super){this._super();}},OAuthInfoUpdate:function(evt){this.localFileList.render();this.checkCanFinish();},checkCanFinish:function(){var fileData=this.sourceData.fileData,model=mstrApp.getRootController().getModel(),enabled=true,OAuthTableCount=0;$A.forEach(fileData,function(item){sourceType=$DIHelper.convertDataSourceType2SourceType(item.sourceType);if(item.isOAuth){OAuthTableCount++;if(!model.externalSources[sourceType].isLogin){enabled=false;}}});if((fileData.length-OAuthTableCount)!==$H.valarray(this.postData).length){enabled=false;}this.okButton.set("enabled",enabled);},children:[{scriptClass:"mstrmojo.Label",text:"Tables below need to be updated."},{scriptClass:"mstrmojo.DataGrid",alias:"localFileList",resizableColumns:false,cssClass:"mstrmojo-di-tablestatuslist mstrmojo-di-appschema-tablestatuslist",columns:[{headerText:"Final Table",headerCss:"",dataField:"name",dataFunction:function(item,index,grid){var cls=["icon"];if(item.isSubNode===true){cls.push("subNode");}else{if(item.isDerivedTable===true){cls.push("derivedTableIcon");}else{cls.push("tableIcon");}}cls=cls.join(" ");return'<div class="'+cls+'"></div>&nbsp;<div style="width: 200px; text-overflow: ellipsis; overflow: hidden; display: inline-block; white-space: nowrap">'+item.name+"</div>";}},{headerCss:"",dataField:"button",colWidth:100,dataWidgetBuilder:function(data){if(!data.isSubNode){return false;}else{var cfg;var sourceType=mstrmojo.DI.DIHelpers.convertDataSourceType2SourceType(data.sourceType);if($OAUTHENUM.indexOf(sourceType)>-1){var externalSources=mstrApp.getRootController().getModel().externalSources[sourceType],isLogin=!!externalSources.isLogin;data.isOAuth=true;cfg={scriptClass:"mstrmojo.AS.DIAppSchemaRepublishOAuthButton",cssClass:"mstrmojo-di-appschema-republish-oauth-button",sourceType:sourceType,isLogin:isLogin,tableId:data.tableId,pipelineId:data.pipelineId};}else{cfg={browseLabel:"",fileFieldName:"file",scriptClass:"mstrmojo.FileUploadBox",accept:".xls,.xlsx,.csv,.txt,.tsv,.prn,.json,.sas7bdat",onvalueChange:function(){var editor=this.parent.parent.parent;this.inputNode.value=this.value;editor.postData[data.tableId]=this;$CSS.addClass(this.buttonNode,"mstrmojo-FileUploadBox-FileSelected-button");editor.checkCanFinish();}};}return cfg;}}}]},{slot:"buttonNode",alias:"cancelButton",scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton",text:mstrmojo.desc(221,"Cancel"),onclick:function(){var editor=this.parent;editor.close();}},{slot:"buttonNode",alias:"okButton",scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton",text:"Finish",enabled:false,onclick:function(){var editor=this.parent,counter=0,sourceData=editor.sourceData,updatedFiles=[];editor.postData=$H.valarray(editor.postData);if(editor.postData.length>0){$A.forEach(editor.postData,function(fileUploader,index,self){var fileObj=sourceData.fileData[index];mstrmojo.AS.DIAppSchemaService.uploadFile(fileUploader.fileNode,{uploadingId:fileObj.fileId,tableId:fileObj.tableId,pipelineId:fileObj.pipelineId,sheetIndex:fileObj.sheetIndex,workspaceId:mstrAppSchema.workspaceId,mode:constants.operationMode.edit},function(uploadingId){counter++;if(counter===editor.postData.length){var updatedFiles=[];$A.forEach(editor.postData,function(obj){updatedFiles.push(obj.data);});$A.forEach(editor.sourceData.fileData,function(item){if(item.isOAuth){updatedFiles.push(item);}});editor.callback(updatedFiles);}});});}else{$A.forEach(editor.sourceData.fileData,function(item){if(item.isOAuth){updatedFiles.push(item);}});editor.callback(updatedFiles);}editor.close();}}]});})();