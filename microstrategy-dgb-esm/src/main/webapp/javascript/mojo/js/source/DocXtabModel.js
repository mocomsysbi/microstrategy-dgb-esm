(function(){mstrmojo.requiresCls("mstrmojo.XtabModel","mstrmojo.array","mstrmojo.func","mstrmojo.hash","mstrmojo.elementHelper");var MX="Metrics",SELECTOR_ACTION=2,$ARR=mstrmojo.array,$HASH=mstrmojo.hash,$EH=mstrmojo.elementHelper,ITEM_SEPARATOR="\u001E";var ROWS=1,COLUMNS=2,SUBTOTAL_POSITION_RESERVED=0,SUBTOTAL_POSITION_FIRST=2,SUBTOTAL_POSITION_LAST=3;function resolveCGBToTKS(cgbMap){if(!cgbMap){return false;}var scm=this.scm,i,id,curSelector,cgb,targetKey,updatedTks=false;for(id in scm){curSelector=scm[id];cgb=curSelector.cgb;for(i in cgb){targetKey=cgbMap[cgb[i]];if(targetKey){if(!curSelector.tks){curSelector.tks=targetKey;updatedTks=true;}else{if(curSelector.tks&&(curSelector.tks.indexOf(targetKey)<0)){curSelector.tks+=ITEM_SEPARATOR+targetKey;updatedTks=true;}}}}}return updatedTks;}function createSelectorMap(){var data=this.data,gridTitles=data.gts;if(!gridTitles){return ;}var map;$ARR.forEach([gridTitles.row,gridTitles.col],function(axis){$ARR.forEach(axis,function(unit){if(unit.sc){map=map||{};map[unit.id||MX]=unit.sc;if(unit.fid){map[unit.id+"_"+unit.fid]=unit.sc;}}});});this.scm=map;resolveCGBToTKS.call(this,this.docModel.getCGBMap());}function submitToDataService(methodName,args){var dataService=this.getDataService();dataService[methodName].apply(dataService,args);}function normalizedFormElementId(elementId,presentation,elementName){var pres=presentation||$EH.getIdPresentation(elementId),es,attId;switch(pres){case"terse":case"terseLong":elementId=elementId.replace(/\\;/g,"*ESCAPESEMICOLON*");es=elementId.split(";");return(es[0]+";"+es[1]+(elementName?";"+elementName:"")).replace(/\*ESCAPESEMICOLON\*/g,"\\;");case"old":var extraValues="",index=2;elementId=elementId.replace(/\*:/g,"*COLON*").replace(/\\/g,"\\\\").replace(/;/g,"\\;");es=elementId.split(":");while(es[index]){extraValues+=":"+es[index];index++;}return("h"+es[1]+extraValues+";"+es[0]+(elementName?";"+elementName:"")).replace(/\*COLON\*/g,"\\:");case"oldLong":var currentIndex=0,arity,formSize,vals=[],idOrder=[],i,j,nf,nextField=function nextField(){if(currentIndex<0){return null;}var isEscaped=false,nextIndex=-1,currChar,__result=null;for(i=currentIndex;i<elementId.length;i++){currChar=elementId.charAt(i);if(currChar==="*"&&!isEscaped){isEscaped=true;}else{if(currChar===":"&&!isEscaped){nextIndex=i;break;}else{isEscaped=false;}}}if(nextIndex===-1){__result=elementId.substring(currentIndex);currentIndex=-1;}else{__result=elementId.substring(currentIndex,nextIndex);currentIndex=nextIndex+1;}return __result;};nf=nextField();if(nf!=="BB"&&nf!=="BF"){return elementId;}attId=nextField();if(nf==="BF"){attId=nextField();}arity=parseInt(nextField(),10);formSize=parseInt(nextField(),10);for(j=0;j<formSize;j++){idOrder[j]=parseInt(nextField(),10);nextField();}for(j=0;j<formSize;j++){var val=nextField();if(idOrder[j]<arity&&idOrder[j]>=0){vals[idOrder[j]]=val.replace(/\\/g,"\\\\").replace(/\*:/g,"\\:").replace(/;/g,"\\;");}}return"h"+vals.join(":")+";"+attId+(elementName?";"+elementName:"");}return elementId;}mstrmojo.DocXtabModel=mstrmojo.declare(mstrmojo.XtabModel,null,{scriptClass:"mstrmojo.DocXtabModel",docModel:null,init:function init(props){this._super(props);var me=this;this.docModel.attachEventListener("CGBMapChange",this.id,function(evt){if(me.xtab.onCBGMapChange){me.xtab.onCGBMapChange(evt);}});},ondataChange:function ondataChange(){createSelectorMap.call(this);},getMessageId:function getMessageId(){return this.docModel.mid;},getDataService:function getDataService(){return this.docModel.getDataService();},getAction:function getAction(cells,domNode,isReselect){var cell=cells[0],actionType=cell&&cell.at;var action;if(actionType){if((actionType&SELECTOR_ACTION)>0){var titleInfo=this.getCellTitleInfo(cell),title=titleInfo&&titleInfo.title,titleId=title&&title.id,selectorControlMap=this.scm;this.sti={titleId:titleId||MX};var sc=(titleId&&selectorControlMap[titleId])||selectorControlMap[MX],getEid=function(){var eids=[];$ARR.forEach(cells,function(item){if(item._e&&item._e.id){eids.push(item._e.id);}});return eids.join(ITEM_SEPARATOR);};if(sc){var xtab=this.xtab,shouldDeselectCurrentCell=(xtab.allowToggleSelections&&sc.all&&isReselect),selectAllElements=(titleInfo.isSrcTitle||shouldDeselectCurrentCell);this.sti.deselectCurrent=shouldDeselectCurrentCell;action={h:"onGridSelector",a:{type:mstrmojo.EnumRWUnitType.GRID,anchor:domNode,ck:sc.ck,tks:sc.tks,eid:selectAllElements?"OA:(All)":getEid(),ctlKey:sc.ckey,sliceId:xtab.sid,isUConDS:sc.isUConDS,ifw:sc.ifw}};}}}if(!action){action=this._super(cells);}if(action&&action.a){action.a.sliceId=this.xtab.sid;}return action;},getDownloadAction:function getDownloadAction(rowPosition,maxRows,colPosition,maxCols,widgetID,rowMode,memo,evt){var action=this._super(rowPosition,maxRows,colPosition,maxCols,widgetID,memo,rowMode);action.sliceId=this.xtab.sid;if(evt&&evt.name==="TransactionUpdates"){if(action.partialUpdate){if(action.partialUpdate.selectors){action.partialUpdate.selectors.push(evt.ctlKey);}else{action.partialUpdate.selectors=[evt.ctlKey];}}else{action.partialUpdate={selectors:[evt.ctlKey]};}}return action;},getDrillAction:function getDrillAction(cells,drillToPath){var action=this._super(cells,drillToPath),titleInfo=this.getCellTitleInfo(cells[0]);if(action&&action.isWithin){action.attrObj=titleInfo.title;}action.srcMsgId=this.docModel.mid;return action;},sort:function sort(params,callback){var view=this.xtab;params.stp=params.stp||this.getSubTotalsPos();params.subTotalsPos=params.stp;params.nodeKey=view.k;params.treeType=view.treeType||1;if(view.gridData.ctlTPKeys){params.selectors=view.gridData.ctlTPKeys.split(ITEM_SEPARATOR);}submitToDataService.call(this,"sortGrid",[params,callback]);},getAdvSortData:function getAdvSortData(params,callback){submitToDataService.call(this,"getAdvSortData",[params,callback]);},pivot:function pivot(params,callback){submitToDataService.call(this,"pivot",[params,callback]);},removeUnit:function removeUnit(params,callback){submitToDataService.call(this,"removeUnit",[params,callback]);},getTotalsAction:function getTotalsAction(cell,subtotalType,clearSubtotalType){var action=this.getPivotAction(cell);action.act="showTotals";action.subtotalType=subtotalType;action.clearSubtotalType=clearSubtotalType;return action;},getRemoveAxisTotalsAction:function getRemoveAxisTotalsAction(subtotalType,axis){return{act:"removeAxisTotals",axis:axis,subtotalType:subtotalType};},showTotals:function showTotals(params,callback){submitToDataService.call(this,"showTotals",[params,callback]);},drillGrid:function drillGrid(params,callback){submitToDataService.call(this,"drillGrid",[params,callback]);},downloadGridData:function downloadGridData(params,callback){submitToDataService.call(this,"downloadGridData",[params,callback]);},loadLayout:function loadLayout(res){this.docModel.loadLayout(res);},resizeXtabColumn:function resizeXtabColumn(params,callback){submitToDataService.call(this,"resizeXtabColumn",[params,callback]);},submitTemplateActions:function submitTemplateActions(key,actions,callback){submitToDataService.call(this,"submitTemplateUpdates",[key,actions,callback]);},getDerivedMetricAction:function getDerivedMetricAction(cell,cmd){return{did:cell._e.oid,um:cell.um,alias:cell._e.n,n:cell._e.n,v:cell.um?cell.formula:cell._e.v,mix:cell.mix,cmd:cmd,model:this};},getAddTemplateUnitAction:function getAddTemplateUnitAction(item,dsid,axis,idx){var unitType=item.t,gsi=this.data.gsi,rtn={act:"addUnit",unitId:item.did,unitType:unitType,unitPos:++idx,dsId:dsid,isFirst:!gsi||(gsi.cols.length===0&&gsi.rows.length===0)};if(unitType!==4||!gsi||!gsi.mx.length){rtn.axis=axis;}return rtn;},getRemoveTemplateUnitAction:function getRemoveTemplateUnitAction(unit){return{act:"removeUnit",unitId:unit.did||unit.id,unitType:unit.t||4,is_disableonly:1};},getRenameTemplateUnitAction:function getRenameTemplateUnitAction(unitId,unitType,newName,isDymamicAlias){var params={act:"renameUnit",id:unitId,type:unitType,name:newName};if(isDymamicAlias){params.isDynamicAlias=true;}return params;},doesNameExistOnTemplate:function doesNameExistOnTemplate(view,unitId,unitType,newName){var gsi=view.node.data.gsi,isMetric=unitType===4,units=isMetric?gsi.mx:gsi.rows.concat(gsi.cols);return units.some(function(unit){return unit.did!==unitId&&(isMetric||unit.t===unitType)&&unit.n===newName;});},getPivotUnitAction:function getPivotUnitAction(axis,idx,id,type,originAxis,originIdx){idx++;var oriAxis=parseInt(originAxis,10),oriIdx=parseInt(originIdx,10);return $HASH.copy(isNaN(oriAxis)||isNaN(oriIdx)?{}:{originAxis:oriAxis,originUnitPos:++oriIdx},{act:"pivot",unitId:String(id||""),unitType:type||"",axis:axis,unitPos:idx});},getShowTotalsUnitAction:function getShowTotalsUnitAction(id,type,subtotalType,clearSubtotalType){return{act:"showTotals",unitId:String(id||""),unitType:type||"",subtotalType:subtotalType,clearSubtotalType:clearSubtotalType};},getMoveSubTotalAction:function getMoveSubTotalAction(data,positions,nodeKey,isSwap){var gridSorts=(this.xtab.gridInfo&&this.xtab.gridInfo.sorts)||[],currentAxis=data&&data.axis,currentSorts;function getSorts(axis,sorts){var axisSort=[];if(sorts.length>=axis){if(isSwap){axisSort=axis===ROWS?sorts[COLUMNS-1]:sorts[ROWS-1];}else{axisSort=sorts[axis-1];}}function hasDummyKey(key,axis){return key.indexOf("0!00000000000000000000000000000000!!!!"+axis)>-1;}function hasAxisSorting(sort,axis){return !!(sort&&sort.length&&sort[0].key&&!hasDummyKey(sort[0].key,axis));}var hasSorts=hasAxisSorting(axisSort,axis),escapedSorts;if(hasSorts){escapedSorts=$HASH.clone(sorts);escapedSorts.forEach(function(sort,index){if(!hasAxisSorting(sort,index+1)){escapedSorts[index]=null;return ;}escapedSorts[index]=sort=$ARR.filter(sort,function(obj){return !hasDummyKey(obj.key,axis);});(sort||[]).forEach(function(item){var key=item.key;if(key){item.key=key.replace(/;/g,"\\;").replace(/\u001e/g,";");if(isSwap){key=item.key;if(key.indexOf("!!1")>=0){item.key=key.replace(/!!1/g,"!!2");}else{item.key=key.replace(/!!2/g,"!!1");}}}});});if(isSwap){escapedSorts=escapedSorts.reverse();}}return hasSorts?escapedSorts:[];}function isHierarchicalSorting(axis,sorts){if(!sorts||sorts.length<axis){return false;}var axisSorting=sorts[axis-1];if(!axisSorting||axisSorting.length!==1){return false;}var DssXmlSortMetricHierarchical="!5",sortKey=axisSorting[0].key;return sortKey&&sortKey.slice(-2)===DssXmlSortMetricHierarchical;}function getAction(key,curSort,subtotalPosition,curAxis,stt){return{act:"moveSubTotal",nodeKey:key,sorts:curSort,subTotalsPos:subtotalPosition,stt:stt||-1,axis:curAxis};}function getDefaultAction(){var griddata=this.data,gts=griddata&&griddata.gts,rowSubPos=gts&&gts.rowSubPos||SUBTOTAL_POSITION_RESERVED,colSubPos=gts&&gts.colSubPos||SUBTOTAL_POSITION_RESERVED,subtotalPositions=[rowSubPos,colSubPos];if((!currentAxis||currentAxis===ROWS)&&rowSubPos===SUBTOTAL_POSITION_RESERVED){var row=gts&&gts.row||[],hasRowSubtotalActive=false;$ARR.forEach(row,function(item){if(item.ast&&item.ast.length>0){hasRowSubtotalActive=true;return false;}});if(!hasRowSubtotalActive||griddata&&griddata.gsi&&griddata.gsi.hidesb){subtotalPositions[ROWS-1]=SUBTOTAL_POSITION_FIRST;currentSorts=getSorts(ROWS,gridSorts);return getAction(nodeKey,currentSorts,subtotalPositions,ROWS);}}return null;}if(!positions){return getDefaultAction.call(this);}else{currentSorts=getSorts(currentAxis,gridSorts);return getAction(nodeKey,currentSorts,positions,currentAxis,isHierarchicalSorting(currentAxis,currentSorts)&&data.hst?data.hst:-1);}return null;},getSortGridAction:function getSortGridAction(subTotalsPos,sortKey,axis,isAsc){return{sortKey:sortKey,subTotalsPos:subTotalsPos,axis:axis,isAsc:isAsc};},getColumnResizeAction:function getColumnResizeAction(unitId,unitType,width,depth,isEC){return{act:"changeXtabColumnWidth",unitId:unitId,unitType:unitType,width:width||0,depth:depth||1,ec:isEC};},getNormalizedFormElementId:function getNormalizedFormElementId(elementId,elementName){return normalizedFormElementId(elementId,null,elementName);},compareNormalizedElementsId:function compareNormalizedElementsId(e1,e2){if(e1===e2){return true;}else{if(this.docModel.populateAttributeIdLinkInfo){this.docModel.populateAttributeIdLinkInfo();}if($EH.isAttributeIdsLinked($EH.getAttributeId(e1),$EH.getAttributeId(e2),this.docModel.als&&this.docModel.als.idLinks||{})){return $EH.getElementValue(e1)===$EH.getElementValue(e2);}}return false;},compareElementsId:function compareElementsId(e1,e2){if(!this.docModel.als){return this.compareElementsIdInSingleGrid(e1,e2);}var px=$EH.getIdPresentation(e1),py=$EH.getIdPresentation(e2),ele1=normalizedFormElementId(e1,px),ele2=normalizedFormElementId(e2,py);return this.compareNormalizedElementsId(ele1,ele2);},compareElementsIdInSingleGrid:function compareElementsIdInSingleGrid(e1,e2){var px=$EH.getIdPresentation(e1),py=$EH.getIdPresentation(e2);if(px!==py||px==="oldLong"||px==="terseLong"){return normalizedFormElementId(e1,px)===normalizedFormElementId(e2,py);}return e1===e2;},getLinkedAttributes:function getLinkedAttributes(attId){var idLinks;if(this.docModel.populateAttributeIdLinkInfo){this.docModel.populateAttributeIdLinkInfo();}idLinks=this.docModel.als&&this.docModel.als.idLinks||{};return idLinks[attId];},getCellDataUnion:function getCellDataUnion(cell){var model=this,isMetric=cell.hasOwnProperty("mix"),data=[],d,updateSelectorObjects=function updateSelectorObjects(headerInfo){var titleInfo=model.getCellTitleInfo(headerInfo),title=titleInfo.title,titleId=title&&title.id;if(titleId){d={};if(headerInfo.stt){d.isSubtotal=true;}data.push($HASH.copy(d,{tid:titleId,eid:headerInfo._e&&headerInfo._e.id,v:headerInfo.v||headerInfo._e&&headerInfo._e.n}));}};if(cell){if(!isMetric){updateSelectorObjects(cell);}else{$ARR.forEach([cell._lp,cell._tp],function(currentParent){var parent=currentParent;while(parent&&parent!==parent._p){updateSelectorObjects(parent);parent=parent._p;}});}}return data;},getObjectInfo:function getObjectInfo(objectId){var objectInfo;$ARR.forEach((this.data.gsi.cols||[]).concat(this.data.gsi.rows||[]),function(unit){if(unit.did===objectId){objectInfo=unit;}});return objectInfo;},supportsViewFilterActions:function supportsViewFilterActions(objectId){if(this.data&&this.data.gsi){var objectInfo=this.getObjectInfo(objectId);return objectInfo&&!objectInfo.de&&(objectInfo.t!==1)&&(objectInfo.t!==47||objectInfo.st===12033);}return false;},getSelectorControlMapInfo:function getSelectorControlMapInfo(){var res=[],gsi=this.data.gsi,all=[],ix;if(this.scm){$HASH.forEach(gsi,function(v){if(v instanceof Array){all=all.concat(v);}});$HASH.forEach(this.scm,function(v,k){ix=$ARR.find(all,"did",k);if(ix!==-1){res.push({did:k,n:all[ix].n,sc:v});}});}return res;},getShowDefinedSubtotalsAction:function(){return{act:"showDefinedSubtotals"};}});}());