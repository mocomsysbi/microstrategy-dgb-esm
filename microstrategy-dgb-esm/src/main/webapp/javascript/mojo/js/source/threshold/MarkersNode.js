(function(){mstrmojo.requiresCls("mstrmojo.color","mstrmojo.dom","mstrmojo.css","mstrmojo._HasOwnAvatar","mstrmojo.Container","mstrmojo.threshold.ThresholdModel","mstrmojo.threshold.ColorMarker");var $COLOR=mstrmojo.color,$DOM=mstrmojo.dom,$CSS=mstrmojo.css;function getRelativePosition(context){var colorSlider=this.parent,colorSliderWidth=colorSlider.width,left=Math.min(Math.max(context.last.x-$DOM.position(this.domNode).x,0),colorSliderWidth-1);return left/colorSliderWidth;}mstrmojo.threshold.MarkersNode=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasOwnAvatar],{scriptClass:"mstrmojo.threshold.MarkersNode",cssClass:"markers",markupString:'<div id="{@id}" class="{@cssClass}" style="{@cssText}"  mstrAttach:click,mousedown,mouseover,mouseout></div>',markupSlots:{containerNode:function containerNode(){return this.domNode;}},dropZone:true,draggable:true,avatarCssClass:"marker-drag-avatar",addMarker:function addMaker(x){this.parent.parent.switchToCustomScheme();var slider=this.parent,thresholdModel=slider.parent.model,w=$DOM.position(this.containerNode).w,palette=slider.getPalette(),cmp=x/w,indexAddedAfter=slider.addMarkerToMap(cmp),totalColors=palette.length,marker=new mstrmojo.threshold.ColorMarker();marker.updateCompValue(cmp);marker.updateRealValue(thresholdModel.getRealValue(cmp,slider.selectedOption,slider.minValue(),slider.maxValue()));marker.set("index",indexAddedAfter);this.addChildren([marker]);if(totalColors===(indexAddedAfter+1)){indexAddedAfter--;}if(this.selectedIndex!==undefined&&this.selectedIndex>-1&&this.selectedIndex<this.children.length){this.children[this.selectedIndex].unselect();}this.selectedIndex=marker.index;var nextColor=palette[indexAddedAfter+1],previousColor=indexAddedAfter===-1?nextColor:palette[indexAddedAfter];palette.splice(indexAddedAfter+1,0,$COLOR.findMidColorHex(previousColor,nextColor));slider.update();this.children[this.selectedIndex].select();},remove:function deleteMarker(i){if(i<0||i>=this.children.length){return ;}this.children[i].unselect();this.children.splice(i,1);this.domNode.removeChild(this.domNode.children[i]);},onclick:function onclick(event){if(this.parent.sliderMode===mstrmojo.threshold.ThresholdModel.SLIDER_MODE.COLOR_BASED&&event.getTarget()===this.domNode){var pos=$DOM.position(this.containerNode),x=event.e.clientX-pos.x;this.addMarker(x);}},premousedown:function premousedown(){this.parent.unselectAll();},createAvatar:function createAvatar(node,context){var i;for(i=0;i<this.children.length;i++){if(this.children[i].id===node.id){context.tgtNode=this.children[i];context.i=i;}}var avatar=node.cloneNode(true),splitter=document.createElement("div");$CSS.addClass(splitter,"bar");avatar.appendChild(splitter);return avatar;},positionAvatar:function positionAvatar(pos){var avatar=this.avatar,avs=avatar.style,restrictedToAxis=this.restrictedToAxis,domPos=$DOM.position(this.domNode),top=domPos.y;if(avatar){if(restrictedToAxis!=="y"){var xPos=pos.x;if(xPos<domPos.x){xPos=domPos.x;}if(xPos>domPos.x+domPos.w){xPos=domPos.x+domPos.w-1;}avs.left=xPos-2+"px";}if(restrictedToAxis!=="x"){avs.top=top+"px";}}},getMarkerComps:function getMarkerComps(sortingFn){if(!this.children){return undefined;}var compValues=this.children.map(function(child){return child.compValue;});return !!sortingFn?compValues.sort(sortingFn):compValues;},getMarkerRealValues:function getMarkerRealValues(sortingFn){if(!this.children){return undefined;}var realVals=this.children.map(function(child){return child.realValue;});return !!sortingFn?realVals.sort(sortingFn):realVals;},setMarkerRealValues:function setMarkerRealValues(realValueCallback,sliderSelectedOption,sliderMin,sliderMax){if(!this.children){return ;}this.children.forEach(function(child,index){child.updateRealValue(realValueCallback(child.compValue,sliderSelectedOption,sliderMin,sliderMax));});},isDragValid:function isDragValid(context){return context.src.node!==this.domNode;},ondragstart:function ondragstart(context){this._super(context);var comp=this.parent.getComp();this.selectedIndex=context.i;comp.splice(context.i,1);},ondragmove:function ondragmove(context){this._super(context);var colorSlider=this.parent,comp=colorSlider.getComp(),thresholdModel=colorSlider.parent.model,relativePos=getRelativePosition.call(this,context),currentMarker=this.children[context.i],deltaDist=context.tgt.pos.x-context.src.pos.x,isMovingLeft=deltaDist<0,isMovingRight=deltaDist>0;if((currentMarker.compValue===0&&isMovingLeft)||(currentMarker.compValue===1&&isMovingRight)){return ;}currentMarker.updateCompValue(relativePos);currentMarker.updateRealValue(thresholdModel.getRealValue(relativePos,colorSlider.selectedOption,colorSlider.minValue(),colorSlider.maxValue()));colorSlider.editableBubble.showBubble(relativePos,currentMarker.realValue);},ondragend:function ondragend(context){var colorSlider=this.parent;comp=colorSlider.getComp(),currentMarker=this.children[context.i],newIndex=currentMarker.index,crossedIndices=this.children.filter(function(child){return(child.index>currentMarker.index&&child.compValue<currentMarker.compValue)||(child.index<currentMarker.index&&child.compValue>currentMarker.compValue);}).map(function(c){return c.index;});if(crossedIndices.length>0){var firstIdx=crossedIndices[0],lastIdx=crossedIndices[crossedIndices.length-1];newIndex=(currentMarker.index>firstIdx)?firstIdx:lastIdx;}comp.splice(newIndex,0,currentMarker.compValue);this.remove(currentMarker.index);colorSlider.update();this.children[newIndex].select();this._super(context);},onmouseover:function onmouseover(evt){if(this.parent.sliderMode===mstrmojo.threshold.ThresholdModel.SLIDER_MODE.COLOR_BASED&&!this._cursorAvatar){var doc=document,domNode=this.domNode,cursorAvatar=this._cursorAvatar=doc.createElement("div"),mouseMoveHandler=this._mouseMoveHandler=function(e){var target=$DOM.eventTarget(self,e),mousePos=$DOM.getMousePosition(e,self),cursorStyle=cursorAvatar.style;cursorStyle.top=mousePos.y+12+"px";cursorStyle.left=mousePos.x+12+"px";cursorStyle.display=(target===domNode&&mstrApp.isInteractive())?"block":"none";};doc.body.appendChild(cursorAvatar);$CSS.addClass(cursorAvatar,"mstrmojo-SimpleThresholdEditor add-cursor");$DOM.attachEvent(domNode,"mousemove",mouseMoveHandler);}if(this._super){return this._super(evt);}},onmouseout:function onmouseout(evt){if(this.parent.sliderMode===mstrmojo.threshold.ThresholdModel.SLIDER_MODE.COLOR_BASED){$DOM.detachEvent(this.domNode,"mousemove",this._mouseMoveHandler);var cursorAvatar=this._cursorAvatar;cursorAvatar.parentNode.removeChild(cursorAvatar);delete this._cursorAvatar;delete this._mouseMoveHandler;}if(this._super){return this._super(evt);}}});}());