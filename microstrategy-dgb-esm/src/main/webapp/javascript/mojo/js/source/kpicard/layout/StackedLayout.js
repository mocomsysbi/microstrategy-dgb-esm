(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo._HasLayout","mstrmojo.css","mstrmojo.dom","mstrmojo.array","mstrmojo.kpicard.layout._LayoutCommon","mstrmojo.kpicard.KPICardEnum");var $KPI_PROPERTIES=mstrmojo.kpicard.KPI_PROPERTIES,$CSS=mstrmojo.css,$DOM=mstrmojo.dom,$ARR=mstrmojo.array,CTRL_BAR_ID="_stacked-ctrl-bar_id",LAYOUT_STYLE_SMALL="small",LAYOUT_STYLE_MIDDLE="middle",LAYOUT_STYLE_LARGE="large",DOT_WIDTH=30;function updateCurrentSlideProperty(layoutor,currentSlide){var widget=layoutor.parent,elemId;if(!widget||widget.isStackedAutoPlay()){return ;}if(layoutor.urFlag){layoutor.urFlag=false;return ;}elemId=layoutor.findCardElemIdByIdx(currentSlide);if(!elemId){return ;}widget.writeProperties($KPI_PROPERTIES.CURRENT_SLIDE_ELEMENT,elemId);}function syncAutoPlayWithMobile(layoutor,nextSlide){var widget=layoutor.parent;if(!widget||!widget.isInStackedMode()){return ;}widget.syncStackAutoPlayMobile(nextSlide);}function toggleCssClass(ctrlBar,width,height){var layoutStyle;if(width<150||height<100){layoutStyle=LAYOUT_STYLE_SMALL;}else{if(width>300&&height>300){layoutStyle=LAYOUT_STYLE_LARGE;}else{layoutStyle=LAYOUT_STYLE_MIDDLE;}}$CSS.removeClass(ctrlBar,[LAYOUT_STYLE_SMALL,LAYOUT_STYLE_MIDDLE,LAYOUT_STYLE_LARGE]);$CSS.addClass(ctrlBar,layoutStyle);return layoutStyle;}function getTextProp(node){return node.innerText!==undefined?"innerText":"textContent";}function isAllowedKeyCodes(keyCode){return(keyCode>=48&&keyCode<=57)||(keyCode>=96&&keyCode<=105)||keyCode===8||keyCode===46||keyCode===37||keyCode===39;}mstrmojo.kpicard.layout.StackedLayout=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasLayout,mstrmojo.kpicard.layout._LayoutCommon],{scriptClass:"mstrmojo.kpicard.layout.StackedLayout",cssClass:"stacked-kpi-container",enableAutoPlay:true,autoPlayInterval:3000,inSlideEditingMode:false,layoutConfig:{w:{containerNode:"100%"},xt:true},markupString:'<div id="{@id}" class="{@cssClass}" style="{@cssText}" ></div>',markupSlots:{containerNode:function(){return this.domNode;}},urFlag:false,getSlickNodePath:function getSlickNodePath(){return'div[id="'+this.parent.id+'"] .stacked-kpi-container';},postBuildRendering:function postBuildRendering(){var layoutor=this,width=parseInt(this.width),height=parseInt(this.height),initialSlide=0,cardNum,slickProps,usingDots;this._super();this.createSingleKPIs();cardNum=this.singleKPIModels.length;if(cardNum>1&&jQuery){if(!this.enableAutoPlay){initialSlide=this.findCardIdxByElemId(this.initialElemId);}slickProps={autoplay:this.enableAutoPlay,autoplaySpeed:this.autoPlayInterval,draggable:false,initialSlide:initialSlide};usingDots=Math.floor(width/DOT_WIDTH)>=cardNum;if(mstrApp.isDisplayOnMobile===true){slickProps.arrows=false;slickProps.dots=false;}else{if(usingDots){slickProps.arrows=false;slickProps.dots=true;}else{this.createCtrlBar(initialSlide,cardNum,width,height);slickProps.prevArrow=this.ctrlBar.firstChild;slickProps.nextArrow=this.ctrlBar.lastChild;}}jQuery(this.getSlickNodePath()).slick(slickProps);if(!mstrApp.isDisplayOnMobile){jQuery(this.getSlickNodePath()).on("afterChange",function(event,slick,currentSlide){updateCurrentSlideProperty(layoutor,currentSlide);if(!usingDots){layoutor.updateCtrlBar(currentSlide);}});}else{jQuery(this.getSlickNodePath()).on("beforeChange",function(event,slick,currentSlide,nextSlide){syncAutoPlayWithMobile(layoutor,nextSlide);});}}},createCtrlBar:function createCtrlBar(initialSlide,cardNum,width,height){var domNode=this.domNode,hostId=this.parent.id,hostNode=domNode&&domNode.parentNode,uniqueId=hostId+CTRL_BAR_ID,ctrlBar=document.getElementById(uniqueId),htmlStr;if(!ctrlBar){ctrlBar=document.createElement("div");ctrlBar.setAttribute("id",uniqueId);$CSS.addClass(ctrlBar,"stacked-ctrl-bar");htmlStr='<div class="prev-button"></div><div class="text currIndex" contenteditable="true">'+initialSlide+'</div><div class="text divider">/</div><div class="text totalPages">'+cardNum+'</div><div class="next-button"></div>';ctrlBar.innerHTML=htmlStr;if(hostNode){hostNode.appendChild(ctrlBar);}}this.layoutStyle=toggleCssClass(ctrlBar,width,height);this.ctrlBar=ctrlBar;this.currIdxNode=ctrlBar.childNodes[1];this.attachEvent4CtrlBar();this.updateCtrlBar(initialSlide);},attachEvent4CtrlBar:function attachEvent4CtrlBar(){var layoutId=this.id,currIdxNode=this.currIdxNode;$ARR.forEach(["click","blur","keydown","keyup"],function(eventName){$DOM.attachMarkupEvent(layoutId,currIdxNode,eventName);});},onclick:function(evt){var target=evt.getTarget(),currIdxNode=this.currIdxNode;if(target===currIdxNode){target.focus();this.inSlideEditingMode=true;}},onblur:function onblur(){this.submitSlickIndexChange();},onkeydown:function onkeyup(evt){var hWin=evt.hWin,e=evt.e||hWin.event,keyCode=e.keyCode,shiftKey=e.shiftKey;if(shiftKey||!isAllowedKeyCodes(keyCode)){evt.preventDefault();}},onkeyup:function onkeyup(evt){var hWin=evt.hWin,e=evt.e||hWin.event,keyCode=e.keyCode,currIdxNode=this.currIdxNode;this.adjustSlickIndex();if(keyCode===13){currIdxNode.blur();}},clearBlurTimer:function clearBlurTimer(){if(this.triggerBlurTimer){clearTimeout(this.triggerBlurTimer);this.triggerBlurTimer=null;}},adjustSlickIndex:function adjustSlickIndex(){var currIdxNode=this.currIdxNode,newIndex=currIdxNode[getTextProp(currIdxNode)]+"",maxVal,maxLength;maxVal=this.singleKPIModels.length;maxLength=(maxVal+"").length;if(newIndex.length>maxLength){currIdxNode[getTextProp(currIdxNode)]=parseInt(newIndex.substring(0,maxLength));}},submitSlickIndexChange:function submitSlickIndexChange(){if(!this.inSlideEditingMode){return ;}this.inSlideEditingMode=false;var currIdxNode=this.currIdxNode,newIndex=currIdxNode[getTextProp(currIdxNode)],maxVal=this.singleKPIModels.length;if(newIndex>=1&&newIndex<=maxVal){this.manualSlickGoto(newIndex-1);}else{currIdxNode[getTextProp(currIdxNode)]=this.getCurrentSlickSlideIndex()+1;}},updateCtrlBar:function updateCtrlBar(currentSlide){if(!this.ctrlBar||this.inSlideEditingMode){return ;}var ctrlBar=this.ctrlBar,currIdxNode=this.currIdxNode,ctrlBarWidth;if(currIdxNode&&this.layoutStyle!==LAYOUT_STYLE_SMALL){currIdxNode[getTextProp(currIdxNode)]=currentSlide+1;}ctrlBarWidth=ctrlBar.offsetWidth||120;ctrlBar.style.left=(parseInt(this.width)-ctrlBarWidth)/2+"px";},toggleSlick:function toggleSlick(play){if(this.singleKPIModels.length>1&&jQuery){jQuery(this.getSlickNodePath()).slick(play?"slickPlay":"slickPause");}},manualSlickNext:function manualSlickNext(){jQuery(this.getSlickNodePath()).slick("slickNext");},manualSlickPrev:function manualSlickPrev(){jQuery(this.getSlickNodePath()).slick("slickPrev");},manualSlickGoto:function manualSlickGoto(index,noAnimation){jQuery(this.getSlickNodePath()).slick("slickGoTo",index,!!noAnimation);},getCurrentSlickSlideIndex:function getCurrentSlickSlideIndex(){return jQuery(this.getSlickNodePath()).slick("slickCurrentSlide");}});}());