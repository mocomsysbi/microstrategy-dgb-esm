(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.css","mstrmojo.Container","mstrmojo._HasLayout","mstrmojo.ui._HasScroller","mstrmojo.vi.ui.toolbars.Toolbar","mstrmojo.ui.menus.ToolbarConfig","mstrmojo.ui.menus.MenuConfig","mstrmojo.Popup","mstrmojo._HasPopup","mstrmojo.HBox","mstrmojo.Label","mstrmojo.Pulldown","mstrmojo.tooltip","mstrmojo.Button","mstrmojo.gmaps.MapEnums","mstrmojo.gmaps.MapUtils","mstrmojo.gmaps.MapSearchWidget","mstrmojo.gmaps.MapLayerControlList","mstrmojo.gmaps.layer.LassoLayer");mstrmojo.requiresDescs(1158,8218,10372,1442,221,10979,10980,10981,9879,9876,9881);var $MOJO=mstrmojo,$DOM=$MOJO.dom,$ARR=$MOJO.array,$CSS=$MOJO.css,$TOOLTIP=$MOJO.tooltip,$GMAPS=$MOJO.gmaps,$MUTIL=$GMAPS.MapUtils,LassoLayer=$GMAPS.layer.LassoLayer,$EnumPropertyType=$GMAPS.EnumPropertyType,$EnumGraphicType=$GMAPS.EnumGraphicType,$EnumToolbarButtonType=$GMAPS.EnumToolbarButtonType,$EnumToolbarState=$GMAPS.EnumToolbarState,MapSearchWidget=$GMAPS.MapSearchWidget,MapLayerControlList=$GMAPS.MapLayerControlList;var TOOLBAR_HEIGHT="30px",MIN_SEARCH_BAR_WIDTH=96,MAX_SEARCH_BAR_WIDTH=200;mstrmojo.gmaps.MapToolbar=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasLayout,mstrmojo.ui._HasScroller,mstrmojo._HasPopup],{scriptClass:"mstrmojo.gmaps.MapToolbar",markupString:'<div id="{@id}-toolbarwrapper" class="toolbarBoxWrapper mstrMapToolBarBox" mstrAttach:scroll><div class="map-toolbar-selection map-toolbar-item"></div><div class="map-toolbar-edtInfoWin map-toolbar-item"></div><div class="map-toolbar-searchbar map-toolbar-item" mstrAttach:mousedown></div><div class="map-toolbar-layerCtrl map-toolbar-item"></div><div class="map-toolbar-styleCtrl map-toolbar-item"></div></div>',markupSlots:{selectionBarNode:function(){return this.domNode.firstChild;},edtInfoWinNode:function(){return this.domNode.childNodes[1];},searchBarNode:function(){return this.domNode.childNodes[2];},layerCtrlNode:function(){return this.domNode.childNodes[3];},styleCtrlNode:function(){return this.domNode.lastChild;}},markupMethods:{onheightChange:mstrmojo.Widget.heightMarkupMethod,onwidthChange:mstrmojo.Widget.widthMarkupMethod},layoutConfig:{h:{selectionBarNode:TOOLBAR_HEIGHT,edtInfoWinNode:TOOLBAR_HEIGHT,layerCtrlNode:TOOLBAR_HEIGHT,styleCtrlNode:TOOLBAR_HEIGHT},w:{selectionBarNode:"auto",edtInfoWinNode:"auto",searchBarNode:MAX_SEARCH_BAR_WIDTH+"px",layerCtrlNode:"auto",styleCtrlNode:"auto"}},BTNCOUNT:13,TOOLBAR_HEIGHT:"30px",mapStyleData:null,lassoLayer:null,parent:null,map:null,init:function init(props){this._super(props);this.initComponents();},initComponents:function initComponents(){var map=this.map;this.initSelectionBar();this.initInfoWinEdtBtn();this.initSearchBar();if(map&&!map.isInFilterPanel()){this.initLayerCtrl();}this.initMapStyleCtrl();},setVisibility:function setVisibility(isVisible){if(this.domNode&&$MUTIL.checkDefined(this.domNode.style)){this.domNode.style.display=(!!isVisible)?"block":"none";}},postBuildRendering:function postBuildRendering(){this._super();var toolBarDiv=this.map&&this.map.toolBarDiv;if(!!toolBarDiv&&!!this.domNode){toolBarDiv.appendChild(this.domNode);this.set("height",TOOLBAR_HEIGHT);}this.refreshMapStyleCtrl();},update:function update(){this.refreshMapStyleCtrl();this.refreshSearchBar();},preRefresh:function preRefresh(){var searchBar=this.searchBar;return searchBar&&searchBar.isFocus();},resize:function resize(){var toolBarDiv=this.map&&this.map.toolBarDiv,domNode=this.domNode;if(!!toolBarDiv&&!toolBarDiv.contains(domNode)){toolBarDiv.appendChild(domNode);}this.refreshSearchBar();},inSelectionState:function inSelectionState(){var state=parseInt(this.state,10);return state===$EnumToolbarState.SINGLE_SELECT||state===$EnumToolbarState.RECTANGLE_SELECT||state===$EnumToolbarState.FREE_SELECT||state===$EnumToolbarState.CIRCLE_SELECT;},onstateChange:function onstateChange(){var mapViewer=this.parent,state=parseInt(this.state,10),selectionBar=this.selectionBar,layerSelectorList=this.layerCtrl&&this.layerCtrl.layerSelectorList,rectSelect,circleSelect,freeSelect,clearSelect;if(!mapViewer||!selectionBar){return ;}rectSelect=selectionBar.rectSelect;if(rectSelect){rectSelect.set("enabled",state===$EnumToolbarState.NORMAL||state===$EnumToolbarState.RECTANGLE_SELECT);rectSelect.set("selected",state===$EnumToolbarState.RECTANGLE_SELECT);}circleSelect=selectionBar.circleSelect;if(circleSelect){circleSelect.set("enabled",state===$EnumToolbarState.NORMAL||state===$EnumToolbarState.CIRCLE_SELECT);circleSelect.set("selected",state===$EnumToolbarState.CIRCLE_SELECT);}freeSelect=selectionBar.freeSelect;if(freeSelect){freeSelect.set("enabled",state===$EnumToolbarState.NORMAL||state===$EnumToolbarState.FREE_SELECT);freeSelect.set("selected",state===$EnumToolbarState.FREE_SELECT);}clearSelect=selectionBar.clearAll;if(clearSelect){clearSelect.set("enabled",state===$EnumToolbarState.NORMAL||state===$EnumToolbarState.CLEAR_ALL);clearSelect.set("selected",state===$EnumToolbarState.CLEAR_ALL);}if(layerSelectorList){layerSelectorList.set("enabled",state===$EnumToolbarState.NORMAL||state===$EnumToolbarState.LAYERS_SELECT);layerSelectorList.set("selected",state===$EnumToolbarState.LAYERS_SELECT);}mapViewer.set("enablePopup",state===$EnumToolbarState.NORMAL);},initSelectionBar:function initSelectionBar(){var me=this,selectionBar=mstrmojo.insert({alias:"selectionBar",scriptClass:"mstrmojo.HBox",slot:"selectionBarNode",buttonCount:me.BTNCOUNT,defaultButtonCount:me.BTNCOUNT,state:$EnumToolbarState.NORMAL,barLength:520,children:[me.getSelectionBtn("rectSelect","mstrtbMapRectangleSearch",mstrmojo.desc(10979,"Rectangular selection tool"),$EnumToolbarButtonType.RECTANGLE_SELECT,$EnumToolbarState.RECTANGLE_SELECT),me.getSelectionBtn("circleSelect","mstrtbMapCircleSelectButton",mstrmojo.desc(10980,"Circular selection tool"),$EnumToolbarButtonType.CIRCLE_SELECT,$EnumToolbarState.CIRCLE_SELECT),me.getSelectionBtn("freeSelect","mstrtbMapFreeSelectButton",mstrmojo.desc(10981,"Freeform selection tool"),$EnumToolbarButtonType.FREE_SELECT,$EnumToolbarState.FREE_SELECT),me.getClearSelectionBtn()]});this.addChildren(selectionBar);},getSelectionBtn:function getSelectionBtn(alias,iconClass,tooltipContent,toolbarButtonType,toolbarState){var me=this;return{alias:alias,scriptClass:"mstrmojo.Button",iconClass:iconClass,tooltipContent:tooltipContent,updateTooltipConfig:me.updateButtonTooltipConfig,useRichTooltip:true,enabled:true,toolbarButtonType:toolbarButtonType,onclick:function onclick(){me.onClickSelectionBar(this,toolbarState);}};},getClearSelectionBtn:function getClearSelectionBtn(){var me=this;return{alias:"clearAll",scriptClass:"mstrmojo.Pulldown",popupToBody:true,cssClass:"mstrtbMapClearAll",height:TOOLBAR_HEIGHT,tooltipContent:mstrmojo.desc(9879,"Remove selections"),updateTooltipConfig:me.updateButtonTooltipConfig,useRichTooltip:true,enabled:true,toolbarButtonType:$EnumToolbarButtonType.CLEAR_ALL,onmousedown:function onmousedown(){var mapViewer=me.parent;if(mapViewer&&mapViewer.hideInfoWindow instanceof Function){mapViewer.hideInfoWindow();}this.set("selected",!this.selected);me.set("state",this.selected?$EnumToolbarState.CLEAR_ALL:$EnumToolbarState.NORMAL);},popupRef:me.createClearSelectionPopupRef(mstrmojo.desc(9876,"Are you sure you wish to remove all selections?"),mstrmojo.desc(1442,"OK"),function(){var map=me.map;if(!!map&&map.clearSelections instanceof Function){var mapViewer=map.mapViewer;map.clearSelections(true);map.endSelections();map.handleTemplateUnitSelections();if(mapViewer){mapViewer.highlightAllLayers();}}me.set("state",$EnumToolbarState.NORMAL);})};},onClickSelectionBar:function onClickSelectionBar(selectionBtn,toolbarState){var mapViewer=this.parent,selectionBar=this.selectionBar;if(!mapViewer||!selectionBar){return ;}if(!selectionBtn.selected){this.set("state",toolbarState);mapViewer.set("enablePopup",false);mapViewer.set("infoWindowVisible",false);this.appendLassoLayer();}else{this.resetSelectionState();}if(mapViewer.hideInfoWindow instanceof Function){mapViewer.hideInfoWindow();}window.clearTimeout(this.timer);},initInfoWinEdtBtn:function initInfoWinEdtBtn(){var me=this,map=this.map,infoWinEdtBtn;if(!map||$MUTIL.isVI()){return ;}infoWinEdtBtn=mstrmojo.insert({alias:"edtInfoWin",slot:"edtInfoWinNode",scriptClass:"mstrmojo.Button",iconClass:"mstrtbMapCustomizeInfoWindow",cssDisplay:"table",tooltipContent:mstrmojo.desc(8218,"Edit custom infoWindow"),updateTooltipConfig:this.updateButtonTooltipConfig,useRichTooltip:true,toolbarButtonType:$EnumToolbarButtonType.EDIT_INFO_WINDOW,onclick:function onclick(){var mapViewer=me.parent;if(!!mapViewer&&mapViewer.hideInfoWindow instanceof Function){mapViewer.hideInfoWindow();}me.openPopup(me.getInfoWinEdtPopupRef());}});this.addChildren(infoWinEdtBtn);},getInfoWinEdtPopupRef:function getInfoWinEdtPopupRef(){var me=this;return{scriptClass:"mstrmojo.Editor",contentNodeCssClass:"mstrmojo-balloon",alias:"infoWinEditor",title:mstrmojo.desc(8218,"Edit custom infoWindow"),left:"100px",top:"100px",width:"200px",locksHover:true,onOpen:function(){var openerDom=this.opener.domNode,position=$DOM.position(openerDom),top=position.y+50,left=position.x+100,gridSelector=this.gridSelectorHBox.gridSelector;this.set("top",top+"px");this.set("left",left+"px");this.editorNode.style.width="300px";this.editorNode.style.zIndex=9999;gridSelector.previousSelection=gridSelector.items[0];},children:[{alias:"gridSelectorHBox",scriptClass:"mstrmojo.HBox",halign:"left",cssText:"margin:3px",children:[{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(10372,"Select a Grid: "),align:"left"},{alias:"gridSelector",scriptClass:"mstrmojo.SelectBox",bindings:{items:function(){return me.getLayerCtrlList(true);}},size:1,selectedIndex:0,previousSelection:null,cssText:"white-space: nowrap; width: 200px",onchange:function onchange(){if(!this.selectedItem){return ;}var mapViewer=this.parent.parent.opener.parent,layerKey=this.selectedItem.id,layer=mapViewer.getGraphicLayer(layerKey);if(this.previousSelection){this.previousSelection.htmlVal=this.parent.parent.desc.value;}this.parent.parent.desc.set("value",layer.getInfoWindowHTML());this.previousSelection=this.selectedItem;}}]},{scriptClass:"mstrmojo.TextArea",cssClass:"mstrmojo-SaveAsEditor-descInput",alias:"desc",bindings:{value:function(){if(!this.parent.opener){return"";}else{var mapViewer=this.parent.opener.parent,defaultLayer=mapViewer&&mapViewer.getGraphicLayerByIdx(0);return defaultLayer.getInfoWindowHTML();}}},maxLength:1024,cols:80,rows:7},{scriptClass:"mstrmojo.HBox",slot:"buttonNode",cssClass:"mstrmojo-Editor-buttonBar",children:[{scriptClass:"mstrmojo.HTMLButton",alias:"ok",text:mstrmojo.desc(1442,"OK"),cssClass:"mstrmojo-Editor-button",onclick:function(){var gridSelector=this.parent.parent.gridSelectorHBox.gridSelector,items=gridSelector.items,mapViewer=this.parent.parent.opener.parent,map=mapViewer&&mapViewer.parent,undoConfig={},redoConfig={};if(!map){return ;}gridSelector.previousSelection.htmlVal=this.parent.parent.desc.value;$ARR.forEach(items,function(item){var key=item&&item.id,layer,oldHTML,newHTML;if(key){layer=mapViewer.getGraphicLayer(key);oldHTML=layer.getInfoWindowHTML();newHTML=item.htmlVal;if($MUTIL.checkDefined(newHTML)&&newHTML!==oldHTML){undoConfig[key]={value:oldHTML};redoConfig[key]={value:item.htmlVal};}}});this.parent.parent.close();map.saveGraphicLayerInfoHTML(undoConfig,redoConfig);}},{scriptClass:"mstrmojo.HTMLButton",alias:"cancel",text:mstrmojo.desc(221,"Cancel"),cssClass:"mstrmojo-Editor-button",onclick:function(){this.parent.parent.close();}}]},{alias:"editInfoWindowTriangle",scriptClass:"mstrmojo.Label",cssClass:"editInfoWindowTriangle"}]};},initSearchBar:function initSearchBar(){var me=this;this.addChildren(new MapSearchWidget({slot:"searchBarNode",alias:"searchBar",suggestionSource:me.getBaseLayer()}));},refreshSearchBar:function refreshSearchBar(){if(this.searchBar){this.searchBar.suggestionSource=this.getBaseLayer();}var searchBarNode=this.searchBarNode,getPaddingWidth=function(elem){if(!elem){return 0;}var compStyle=$CSS.getComputedStyle(elem);return parseInt(compStyle.paddingLeft,10)+parseInt(compStyle.paddingRight,10);},searchBarPaddingWidth=getPaddingWidth(searchBarNode),toolbarPaddingWidth=getPaddingWidth(this.domNode),mapWidth=this.map.getWidth(),selectionBarWidth=this.selectionBarNode.offsetWidth,layerCtrlWidth=this.layerCtrlNode.offsetWidth,styelCtrlWidth=this.styleCtrlNode.offsetWidth,searchBarWidth=searchBarNode.offsetWidth,remainWidth=mapWidth-(selectionBarWidth+layerCtrlWidth+styelCtrlWidth)-toolbarPaddingWidth,searchBarRemainWidth=remainWidth-searchBarPaddingWidth,searchBarStyle=searchBarNode.style;if(searchBarWidth>remainWidth){searchBarStyle.width=Math.max(MIN_SEARCH_BAR_WIDTH,searchBarRemainWidth)+"px";}else{searchBarStyle.width=Math.min(MAX_SEARCH_BAR_WIDTH,searchBarRemainWidth)+"px";}},initLayerCtrl:function initLayerCtrl(){var me=this,map=this.map,maxHeight;if(!!map){maxHeight=((parseInt(map.height)-parseInt(TOOLBAR_HEIGHT))*0.9)+"px";}this.addChildren(mstrmojo.insert({alias:"layerCtrl",slot:"layerCtrlNode",scriptClass:"mstrmojo.HBox",height:TOOLBAR_HEIGHT,children:[{alias:"layerSelectorList",scriptClass:"mstrmojo.Pulldown",popupToBody:true,cssClass:"mstrtbMapGridSelector",height:TOOLBAR_HEIGHT,tooltipContent:mstrmojo.desc(9881,"Multiple grids"),updateTooltipConfig:me.updateButtonTooltipConfig,enabled:true,toolbarButtonType:$EnumToolbarButtonType.LAYERS_SELECT,layerCtrlList:null,onmousedown:function onmousedown(){var mapViewer=me.parent,layerCtrlList=this.layerCtrlList;if(mapViewer&&(mapViewer.hideInfoWindow instanceof Function)){mapViewer.hideInfoWindow();}this.set("selected",!this.selected);if(layerCtrlList&&layerCtrlList.destroy instanceof Function){layerCtrlList.destroy();}delete this.layerCtrlList;this.closePopup();this.layerCtrlList=new MapLayerControlList({sourceToolbar:me,maxHeight:maxHeight});this.openPopup(this.layerCtrlList);}}]}));},initMapStyleCtrl:function initMapStyleCtrl(){this.addChildren(mstrmojo.insert({alias:"mapStyleCtrl",slot:"styleCtrlNode",scriptClass:"mstrmojo.vi.ui.toolbars.Toolbar",height:TOOLBAR_HEIGHT}));},refreshMapStyleCtrl:function refreshMapStyleCtrl(){var mapStyleCtrl=this.mapStyleCtrl,toolbarCfg=new mstrmojo.ui.menus.ToolbarConfig(),styleMenuCfg=this._getMapStyleMenuConfig(),oldToolbarCfg;if(!mapStyleCtrl){return ;}oldToolbarCfg=mapStyleCtrl.toolbarCfg;if(oldToolbarCfg){mapStyleCtrl.toolbarCfg=null;if(oldToolbarCfg.destroy instanceof Function){oldToolbarCfg.destroy();}}if(!!styleMenuCfg){toolbarCfg.addDisposable(styleMenuCfg);toolbarCfg.addMenuToolbarBtn(mstrmojo.desc(4157,"STYLES"),"mapStyleSelectVBox",styleMenuCfg);}mapStyleCtrl.set("toolbarCfg",toolbarCfg);mapStyleCtrl.render();},_getMapStyleMenuConfig:function _getMapStyleMenuConfig(){var menuCfg=new mstrmojo.ui.menus.MenuConfig(),mapStyleData=this._getMapStyleData(),me=this,fnCustomMarkup=function(selected){return function(){var cls="{@cls}"+(selected?" selected":"");return'<div class="'+cls+'" idx="{@idx}"><div class="label">{@en@n}</div><div class="state">'+mstrmojo.desc(514,"Selected")+"</div></div>";};},fnGetHandler=function(value){return function(){var map=me.map;if($MUTIL.checkDefined(value)&&$MUTIL.checkHasFunction(map,"writeProperties")){map.writeProperties($EnumPropertyType.mapStyle,value);}};},mapStyle,mapStyleValue,mapStyleName,i,il;if(!mapStyleData||!$ARR.isArray(mapStyleData)||mapStyleData.length<1){return ;}menuCfg.menuCssClass=this.getStyleCssClassName("mapStylesMenu");menuCfg.isHostedWithin=false;for(i=0,il=mapStyleData.length;i<il;i++){mapStyle=mapStyleData[i];mapStyleValue=mapStyle.v;mapStyleName=mapStyle.n;menuCfg.addCustomMenuItem(mapStyleName,"CSS"+mapStyle.type+(mapStyle.id||i),fnGetHandler(mapStyleValue),fnCustomMarkup(mapStyle.selected));}return menuCfg;},_getMapStyleData:function _getMapStyleData(){var baseLayer=this.getBaseLayer();if(baseLayer&&baseLayer.getMapStyleData instanceof Function){return baseLayer.getMapStyleData();}},getBaseLayer:function getBaseLayer(){return this.parent&&this.parent.baseLayer;},appendLassoLayer:function appendLassoLayer(){this.lassoLayer=new LassoLayer({parent:this.parent,selectionType:this.state});},removeLassoLayer:function removeLassoLayer(){var lassoLayer=this.lassoLayer;if(lassoLayer&&lassoLayer.destroy instanceof Function){lassoLayer.destroy();}delete this.lassoLayer;},updateButtonTooltipConfig:function updateButtonTooltipConfig(){var position=$DOM.position(this.domNode);this.richTooltip={content:this.tooltipContent,cssClass:"vi-regular vi-tooltip-A",posType:$TOOLTIP.POS_TOPLEFT,top:position.y+position.h+3,left:position.x};},createClearSelectionPopupRef:function createClearSelectionPopupRef(message,okBtnText,okCallbackFunc,cancelCallbackFunc){var me=this;return{alias:"messagePopup",scriptClass:"mstrmojo.Popup",cssClass:"messagePopupWindow",slot:"popupNode",locksHover:false,autoCloses:false,children:[{alias:"popupLabel",scriptClass:"mstrmojo.Label",cssClass:"messageLabel",text:message},{alias:"popupVBox",scriptClass:"mstrmojo.HBox",children:[{alias:"okButton",scriptClass:"mstrmojo.Button",cssClass:$MUTIL.isVI()?"messageBoxOkButton mstrmojo-WebButton hot":"messageBoxOkButton-nonVI",text:okBtnText,bindings:{popup:"this.parent.parent"},onclick:function onclick(){okCallbackFunc.call(this);this.popup.close();}},{alias:"cancelButton",scriptClass:"mstrmojo.Button",cssClass:$MUTIL.isVI()?"messageBoxCancelButton mstrmojo-WebButton":"messageBoxCancelButton-nonVI",text:mstrmojo.desc(221,"Cancel"),bindings:{popup:"this.parent.parent"},onclick:function onclick(){if(cancelCallbackFunc){cancelCallbackFunc.call(this);}else{me.set("state",$EnumToolbarState.NORMAL);}this.popup.close();}}]}]};},getStyleCssClassName:function getStyleCssClassName(baseClassName){var themeClassName=$MUTIL.getThemeClass();if($MUTIL.checkDefined(themeClassName)){baseClassName+=themeClassName;}return baseClassName;},getLayerCtrlList:function getLayerCtrlList(noMetric){var items=[],mapViewer=this.parent,layerIdxMappingArr=this.map&&this.map.layerIdxMappingArr,layerKey,graphicLayer,layerItem,k,kl;if(!mapViewer||!$ARR.isArray(layerIdxMappingArr)||layerIdxMappingArr.length<1){console.log("getLayerCtrlList(): no graphic layer found");return items;}for(k=0,kl=layerIdxMappingArr.length;k<kl;k++){layerKey=layerIdxMappingArr[k];graphicLayer=mapViewer.getGraphicLayer(layerKey);if(graphicLayer){layerItem={v:k,id:layerKey,n:graphicLayer.getLayerName(),metrics:[],isVisible:graphicLayer.isVisible(),getLayerKey:function(){return this.id;}};items.push(layerItem);}}if(noMetric!==true){this.addMetricsToLayerItems(items);}return items;},addMetricsToLayerItems:function addMetricsToLayerItems(layerItems){if($MUTIL.isVI()||!$ARR.isArray(layerItems)){return ;}var mapViewer=this.parent,_findMetrics=function(graphicLayer){var data=graphicLayer.getData(),layerKey=graphicLayer.key,cols=data.eg===undefined&&graphicLayer.getDataColTitles(),metrics=[],metricsString=mstrmojo.desc(1158,"Metrics"),col,es,metricItem,i,il,j,jl;if(!cols||cols.length<1){return metrics;}for(i=0,il=cols.size();i<il;i++){col=cols.getTitle(i);if(col.getName()==metricsString){es=col.getHeaderValues();for(j=0,jl=es.length;j<jl;j++){metricItem={v:j,n:es[j].n,id:es[j].id,layerKey:layerKey};metrics.push(metricItem);}break;}}return metrics;},layerKey,graphicLayer;$ARR.forEach(layerItems,function(item){layerKey=item&&item.getLayerKey();graphicLayer=mapViewer.getGraphicLayer(layerKey);if(graphicLayer&&graphicLayer.graphicType!==$EnumGraphicType.Density){item.metrics=_findMetrics(graphicLayer);}});},onselectedMetricIdxChange:function onselectedMetricIdxChange(layerKey,metricIndex,metricId){var graphicLayer=this.getGraphicLayer(layerKey),mapViewer=this.parent;if(graphicLayer){graphicLayer.handleMetricSelectionChange(metricIndex,metricId);}if(mapViewer){mapViewer.highlightAllLayers();}},getLayerSelectedMetricIdx:function getLayerSelectedMetricIdx(layerKey){var layer=this.getGraphicLayer(layerKey);if(layer&&layer.getSelectedMetricIdx instanceof Function){return layer.getSelectedMetricIdx();}},getGraphicLayer:function getGraphicLayer(layerKey){var mapViewer=this.parent;if(mapViewer&&mapViewer.getGraphicLayer instanceof Function){return mapViewer.getGraphicLayer(layerKey);}},setLayerVisibility:function setLayerVisibility(layerKey,isVisible){var value=isVisible?"0":"1",map=this.map;if(map&&layerKey){map.writeProperties($EnumPropertyType.isHidden,value,layerKey);}},submitLayerVisibleChanges:function submitLayerVisibleChanges(undoConfig,redoConfig){var map=this.map;if(map){map.saveGraphicLayerVisibleInfo(undoConfig,redoConfig);}},resetSelectionState:function resetSelectionState(){var mapViewer=this.parent;if(!mapViewer){return ;}this.set("state",$EnumToolbarState.NORMAL);mapViewer.set("enablePopup",true);mapViewer.set("infoWindowVisible",true);this.removeLassoLayer();},destroy:function destroy(){delete this.parent;delete this.map;this._super();}});})();