(function(){mstrmojo.requiresCls("mstrmojo.vi.ui.HierarchyCheckList","mstrmojo.EnumSelectionType","mstrmojo.ui.PopupButton","mstrmojo.hash","mstrmojo.array","mstrmojo.css","mstrmojo.func","mstrmojo.dom","mstrmojo.tooltip","mstrmojo._HasTooltip","mstrmojo.fe.FilterUtils","mstrmojo.vi.ui.rw.selectors._CanSearchOnServer");mstrmojo.requiresDescs(3474,2119,2461,493);var $ARR=mstrmojo.array,$CSS=mstrmojo.css,$HASH=mstrmojo.hash,$DOM=mstrmojo.dom,$FU=mstrmojo.fe.FilterUtils,$SELECTION_TYPE=mstrmojo.EnumSelectionType;var SEARCH_ICON_WIDTH=28,MIN_SEARCH_PULLDOWN_WIDTH=70,MIN_FOOTER_INLINE_WIDTH=196;function getItemAncestors(item,itemField){var ancestors=[],parentItem=item.parent;itemField=itemField||"n";while(parentItem){if(!parentItem.hid&&parentItem[itemField]){ancestors.push(parentItem[itemField]);}parentItem=parentItem.parent;}return ancestors;}mstrmojo.vi.ui.rw.selectors.HierarchyCheckList=mstrmojo.declare(mstrmojo.vi.ui.HierarchyCheckList,[mstrmojo.vi.ui.rw.selectors._CanSearchOnServer],{scriptClass:"mstrmojo.vi.ui.rw.selectors.HierarchyCheckList",markupString:'<div id="{@id}" class="mstrmojo-ui-CheckList hierarchy {@cssClass}" style="{@cssText}" mstrAttach:click,contextmenu><div class="header"><span class="search-bar"><span class="ph"></span></span><span class="level-bar"><span class="ph"></span></span></div><div class="scroll-container"><div class="{@icnCss}" style="{@icnCssText}">{@itemsHtml}</div></div><div class="footer"><div class="all-bar"><span class="allBtn select">'+mstrmojo.desc(3474,"Select All")+'</span><span class="allBtn clear">'+mstrmojo.desc(2119,"Clear All")+"</span></div></div></div>",markupSlots:{headerNode:function headerNode(){return this.domNode.firstChild;},footerNode:function footerNode(){return this.domNode.lastChild;},searchboxNode:function searchboxNode(){return this.domNode.firstChild.firstChild.firstChild;},levelBtnNode:function levelBtnNode(){return this.domNode.firstChild.lastChild.firstChild;},scrollboxNode:function scrollboxNode(){return this.domNode.children[1];},itemsContainerNode:function itemsContainerNode(){return this.domNode.children[1].firstChild;},tooltipNode:function tooltipNode(){return this.domNode.children[1].firstChild;}},useRichTooltip:true,init:function init(props){this._super(props);if($DOM.isEdge){$CSS.addWidgetCssClass(this,"edge");}},postBuildRendering:function postBuildRendering(){var levelBtn=this.levelBtn;if(!levelBtn){var levelConfig=this.getLevelPopupConfig(),Clazz=$HASH.walk(levelConfig.scriptClass,window);delete levelConfig.scriptClass;levelBtn=this.levelBtn=new Clazz(levelConfig);this.addDisposable(levelBtn);}levelBtn.placeholder=this.levelBtnNode;levelBtn.render();return this._super();},unrender:function unrender(ignoreDom){var levelBtn=this.levelBtn;if(levelBtn){levelBtn.unrender(ignoreDom);}return this._super(ignoreDom);},onclick:function onclick(evt){var target=evt.getTarget();if($CSS.hasClass(target,"allBtn")){this.doAllSelect($CSS.hasClass(target,"select"));evt.cancel();}else{this._super(evt);}},onSelectionChange:function onSelectionChange(type,isSelected,item,level){this._super(type,isSelected,item,level);this.onchange();},doExpandCollapse:function doExpandCollapse(itemNode,item){var me=this,isExpanding=!item.epd,scrollTop=this.scrollNode.scrollTop,delegateSuccess=false;if(this.delegateExpandCollapse){delegateSuccess=this.delegateExpandCollapse({elementId:item.v,isExpand:isExpanding},{success:function(res){me.scrollNode.scrollTop=scrollTop;}});}if(!delegateSuccess){this._super(itemNode,item);}},searchLevel:-1,searchItems:[],updateItems:function updateItems(items,itemRelations){this._super(items,itemRelations);this.clearSearch();},isHiearachyDisplay:function isHiearachyDisplay(){return !this.isOnSearch();},showTooltip:function showTooltip(evt,win){var target=evt.target||$DOM.eventTarget(evt.hWin,evt.e),item=this.getItemFromTarget(target);if(item&&!this.isHiearachyDisplay()){var itemNode=this.getItemNodeFromTarget(target),itemDivPos=$DOM.position(itemNode);this.tooltipOpenDelay=mstrmojo._HasTooltip.TOOLTIP_OPEN_DELAY;this.richTooltip={cssClass:"vi-regular vi-tooltip-A",content:getItemAncestors(item).reverse().join(" > "),refNode:itemNode,top:itemDivPos.h,left:10};this._super(evt,win);}},getSourceDefn:function getSourceDefn(){var selector=this.docSelector;return selector&&selector.node&&selector.node.defn;},getDataService:function getDataService(){var selector=this.docSelector;return selector&&selector.model&&selector.model.getDataService();},onSearchSuccess:function onSearchSuccess(items,config){var displayItems=[];items.forEach(function(item){var curItem=this.getItemByValue(item.v);if(!item.hid){displayItems.push(item);}$HASH.copy({lv:item.lv||0,dhid:!curItem||curItem.dhid,pid:item.pid?item.pid+";"+config.attributeId:item.pi>-1?items[item.pi].v:""},item);delete item.hcd;delete item.hid;delete item.epd;delete item.pi;},this);this.searchItems=this.searchItems.concat(items);this.addItems(items);displayItems=displayItems.map(function(item){return this.getItemByValue(item.v);},this);this._super(displayItems,config);},widgetResized:function widgetResized(){var searchBox=this.searchbox,footerNode=this.footerNode;this._super();if(searchBox&&searchBox.hasRendered){searchBox.onwidthChange();}if(footerNode){$CSS.toggleClass(footerNode,"multi",parseInt(this.width)<MIN_FOOTER_INLINE_WIDTH);this.updateScrollbars();}},getSearchbarCfg:function getSearchbarCfg(){return $HASH.copy({scriptClass:"SearchWidget2",hasFilter:true,useRichTooltip:true,showTooltip:function showTooltip(e,win){var selectedNode=this.filter.selectedNode,target=$DOM.eventTarget(win,e);if(target===selectedNode&&target.scrollWidth>target.clientWidth){this.richTooltip={cssClass:"vi-regular vi-tooltip-A",content:selectedNode.innerText,refNode:selectedNode,top:$DOM.position(selectedNode).h+6};this.constructor.prototype.showTooltip.call(this,e,win);}},onwidthChange:function(evt){var selectedNode=this.filter.selectedNode,maxWidth=Math.max(Math.min(this.domNode.clientWidth,this.domNode.parentNode.clientWidth)*0.7-SEARCH_ICON_WIDTH,MIN_SEARCH_PULLDOWN_WIDTH);selectedNode.style.width="";if(selectedNode.scrollWidth>maxWidth){selectedNode.style.width=maxWidth+"px";}},onfilterItemSelected:function(item,selectedNode){var widget=this.parent,oldLevel=widget.searchLevel,newLevel=item.v;widget.searchLevel=newLevel;widget.expressionXML=newLevel>=0?$FU.getExprXml(widget.getLevelExpression(newLevel)):"";if(this.hasRendered){this.onwidthChange();}},postCreateChildren:function(){this.filter.isHostedWithin=false;},preBuildRendering:function(){var widget=this.parent,levels=widget.getLevelItems(true),searchLevel=widget.searchLevel;this.filterSelectedIndex=0;this.set("filterItems",levels);this.set("filterSelectedIndex",Math.max($ARR.find(levels,"v",searchLevel),0));},postBuildRendering:function(){this.constructor.prototype.postBuildRendering.call(this);this.onwidthChange();}},this._super());},renderFilteredItems:function renderFilteredItems(start){$CSS.toggleClass(this.footerNode,"hidden",true);this._super(start);},renderOriginalItems:function renderOriginalItems(){$CSS.toggleClass(this.footerNode,"hidden",false);this._super();},clearSearchItems:function clearSearchItems(){this.searchItems=[];this._super();}});}());