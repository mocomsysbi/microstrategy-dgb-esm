(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.hash","mstrmojo.func","mstrmojo.vi.models.DocXtabModel","mstrmojo.EnumRWUnitType");var $ARRAY=mstrmojo.array,$HASH=mstrmojo.hash;var MX="Metrics",SELECTOR_ACTION=2,ITEM_SEPARATOR="\u001E",UNIT_SEPARATOR="\u001F";mstrmojo.vi.models.DocVisModel=mstrmojo.declare(mstrmojo.vi.models.DocXtabModel,null,{scriptClass:"mstrmojo.vi.models.DocVisModel",getHMSelecAttrElemIdsInfo:function(cells){var cell=cells[0],titleId=cell.tid,titleIds=cell.tids,selections=cell.selections,selsByAtr={},retIds=[],selectorControlMap=this.scm,sc=(titleId&&selectorControlMap&&selectorControlMap[titleId]);$ARRAY.forEach(selections,function(selection){var seleLen=(selection&&selection.length)||0,validSel=seleLen>0?selection[seleLen-1]:{},tid=validSel.tid;if(selectorControlMap[tid]){if(!selsByAtr[tid]){selsByAtr[tid]=[];}selsByAtr[tid].push(validSel.eid);}});$HASH.forEach(selsByAtr,function(eids){retIds.push(eids.join(ITEM_SEPARATOR));});if(sc&&sc.showall&&retIds.length===0){$ARRAY.forEach(titleIds,function(tid){retIds.push("OA:(All)");selsByAtr[tid]=[];});}return{eids:retIds.join(UNIT_SEPARATOR),tids:Object.keys(selsByAtr)};},getSelectedAttributeElementIdStr:function(cells){var cell=cells[0],titleId=cell.tid,elementIdStr,selections=cell.selections,scSels=[],eids=[];$ARRAY.forEach(selections||[],function(selection){scSels=scSels.concat($ARRAY.filter(selection,function(item){return item.tid===titleId;}));});scSels=$ARRAY.distinct(scSels,"eid");(scSels||[]).forEach(function(item){eids.push(item.eid);});elementIdStr=eids.join(ITEM_SEPARATOR);var selectorControlMap=this.scm,sc=(titleId&&selectorControlMap[titleId]);if(sc&&sc.showall&&eids.length===0){elementIdStr="OA:(All)";}return elementIdStr;},getHMAction:function getHMAction(cells){var cell=cells[0],actionType=cell&&cell.at,domNode=cell.anchor,selections=cell.selections,selectorControlMap=this.scm,scItems=[],cks=[],ckeys=[],tks=[],ckResult,ckeysResult,tk1,elementIdStr,selsInfo,action;selsInfo=this.getHMSelecAttrElemIdsInfo(cells);elementIdStr=selsInfo.eids;if(selections.length!==0&&elementIdStr===""){return null;}if(actionType&&((actionType&SELECTOR_ACTION)>0)&&selectorControlMap){$ARRAY.forEach(selsInfo.tids,function(tid){var scItem=selectorControlMap[tid];if(scItem){scItems.push(scItem);cks.push(scItem.ck);ckeys.push(scItem.ckey);tks.push(scItem.tks);}});ckResult=cks.join(UNIT_SEPARATOR);ckeysResult=ckeys.join(UNIT_SEPARATOR);tk1=tks.join(ITEM_SEPARATOR);if(scItems.length&&elementIdStr!==""){action={h:"onGridSelector",a:{type:mstrmojo.EnumRWUnitType.GRID,anchor:domNode,ck:ckResult,tks:tk1,eid:elementIdStr,ctlKey:ckeysResult,sliceId:this.xtab.sid,isUConDS:scItems[0].isUConDS,isDocVis:true}};}}return action;},getDrillWithinActionsForAssociatedNodes:function getDrillWithinActionsForAssociatedNodes(config,fromUnit,callback,xtab){var me=this,docModel=this.docModel,actions=[docModel.getDataService().getDrillGridAction(this.getDrillAction(this.xtab.k,fromUnit,config))],visualization=!!xtab?xtab:this.xtab,associatedNodes=!mstrApp.isInVFConfigMode?(visualization.getAssociatedNodes&&visualization.getAssociatedNodes()||[]):[];callback=mstrmojo.func.wrapMethods(callback,{success:function success(){$ARRAY.forEach(associatedNodes,function(node){var unit=docModel.getPanel().getUnitByKey(node.k);if(unit&&unit.boxContent){unit.boxContent.raiseEvent({name:"regenerateToolbar"});}});}});$ARRAY.forEach(associatedNodes,function(node){actions.push(docModel.getDataService().getDrillGridAction(me.getDrillAction(node.k,fromUnit,config)));});return{actions:actions,callback:callback};},getDrillAction:function getDrillAction(nodeKey,selections,config){function getDrillElements(selections){var res=[];for(var i=0,len=selections.length;i<len;i++){var sel=selections[i];for(var j=0,uLen=sel.length;j<uLen;j++){var unit=sel[j];if(mstrApp.useBinaryFormat){res.push(unit.axis+"A"+(unit.ui+1)+"A"+unit.o);}else{res.push(unit.axis+"A"+(unit.ui+1)+"A"+unit.o);}}}return(mstrApp.useBinaryFormat)?res:res.join(",");}return{srcMsgId:this.data.mid,sliceId:this.xtab.sid,nodeKey:nodeKey,retainParent:config.retainParent||"",isWithin:config.drillPath.within,drillPathKey:config.drillPath.k,drillPathIndex:config.drillPath.dpi,drillElements:getDrillElements(selections)};},getAction:function getAction(cells){var cell=cells[0],actionType=cell&&cell.at,domNode=cell.anchor,titleId=cell.tid,elementIdStr,action,selections=cell.selections;elementIdStr=this.getSelectedAttributeElementIdStr(cells);if(selections.length!==0&&elementIdStr===""){return null;}if(actionType&&((actionType&SELECTOR_ACTION)>0)){var selectorControlMap=this.scm;var sc=(titleId&&selectorControlMap[titleId])||selectorControlMap[MX];if(sc&&elementIdStr!==""){action={h:"onGridSelector",a:{type:mstrmojo.EnumRWUnitType.GRID,anchor:domNode,ck:sc.ck,tks:sc.tks,eid:elementIdStr,ctlKey:sc.ckey,sliceId:this.xtab.sid,isUConDS:sc.isUConDS,isDocVis:true}};}}return action;}});}());