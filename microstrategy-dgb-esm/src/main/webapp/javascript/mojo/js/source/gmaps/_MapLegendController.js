(function(){mstrmojo.requiresCls("mstrmojo.num","mstrmojo.array","mstrmojo.VisUtility","mstrmojo.gmaps.MapLegendContainer","mstrmojo.gmaps.MapLegendEnums","mstrmojo.gmaps.MapUtils","mstrmojo.gmaps.MapEnums");var $MOJO=mstrmojo,$NUM=$MOJO.num,$ARR=$MOJO.array,$UTILS=$MOJO.VisUtility,$GMAPS=$MOJO.gmaps,$MUTIL=$GMAPS.MapUtils,$MAP_PROPERTY=$GMAPS.EnumPropertyType,$MAP_MIN_SIZE_TYPE=$GMAPS.EnumMinSizeType,LEGEND_CON=$GMAPS.MapLegendContainer;function getFormatString(data,idx){var nf=data.nf||[],len=nf.length,nfs;if(idx>=0&&idx<len){nfs=$UTILS.getNumberFormat(data,idx);return nfs.replace(/'/g,'"');}return"";}function prepareLegendColorByMetricsData(layer){var colorById=layer.dropZones&&layer.dropZones.colorBy,data=layer.data,gsi=data&&data.gsi,mx=gsi&&gsi.mx,thresholds=gsi&&gsi.thresholds,colorByMetric=null,mxIdx=null,layerFmts=layer.getLayerFmts(),colorByThresholds,fstThreshold,rankMode,fs,colorByElements,isImageType,url;if(colorById&&thresholds){$ARR.forEach(mx,function(obj,i){if(obj.did===colorById){colorByMetric=obj;mxIdx=i;}});if(colorByMetric){colorByThresholds=thresholds[colorById];fstThreshold=colorByThresholds&&colorByThresholds[0];if(!fstThreshold){return null;}isImageType=fstThreshold.rtp===4;if(fstThreshold&&(isImageType||(fstThreshold.fmt&&fstThreshold.fmt.bc))){rankMode=$UTILS.getRankMode(colorByThresholds);fs=$UTILS.getColorByFormatStr(getFormatString(data,mxIdx),rankMode);colorByElements=$UTILS.getColorByItems(colorByThresholds,rankMode,colorByMetric.max,colorByMetric.min,colorByMetric.cnt,fs);if(isImageType){$ARR.forEach(colorByElements,function(element,i){if(colorByThresholds[i]){url=$MUTIL.convertImageUrl(colorByThresholds[i].rtxt);element.image="url("+url+")";}});}else{$ARR.forEach(colorByElements,function(element){element.opacity=layerFmts.fillOpacity;});}return{item:$UTILS.getColorByTitle(colorByMetric.n,rankMode),elements:colorByElements};}}}return null;}function calLegendSizeByDataForProportionalMode(data,sizeByMetricIdx){var i,dataLength,cols,colLength,value,rawValue,min,rawMin,max,rawMax;dataLength=data&&data.length;if(dataLength===undefined){return{min:undefined,max:undefined};}min=undefined;max=undefined;for(i=0;i<dataLength;i+=1){cols=data[i].items||[];colLength=cols.length;if(sizeByMetricIdx<colLength&&sizeByMetricIdx>=0){rawValue=cols[sizeByMetricIdx];if(rawValue!==undefined){rawValue=parseFloat(rawValue.rv);if(!isNaN(rawValue)){value=Math.abs(rawValue);if(min===undefined||min>value){min=value;rawMin=rawValue;}if(max===undefined||max<value){max=value;rawMax=rawValue;}}}}}return{min:rawMin,max:rawMax};}function prepareLegendSizeByData(layer){var sizeById=layer.dropZones&&layer.dropZones.sizeBy,data=layer.data,gsi=data&&data.gsi,mx=gsi&&gsi.mx,thresholds=gsi&&gsi.thresholds,sizeByMetric=null,mxIdx=null,sfs,sizeByElements,gvs=data&&data.gvs,isProportional,proportionalRange;if(sizeById&&thresholds){$ARR.forEach(mx,function(obj,i){if(obj.did===sizeById){sizeByMetric=obj;mxIdx=i;}});if(sizeByMetric){isProportional=parseInt(layer.getLayerProp($MAP_PROPERTY.MIN_SIZE_TYPE))===$MAP_MIN_SIZE_TYPE.PROPORTIONAL;sfs=getFormatString(data,mxIdx);sizeByElements=[];if(isProportional&&sizeByMetric.min<0){proportionalRange=calLegendSizeByDataForProportionalMode(gvs.items,mxIdx);if(proportionalRange.min===undefined||proportionalRange.max===undefined){return null;}sizeByElements.push($NUM.formatByMask(sfs,proportionalRange.max));sizeByElements.push($NUM.formatByMask(sfs,proportionalRange.min));}else{sizeByElements.push($NUM.formatByMask(sfs,sizeByMetric.max));sizeByElements.push($NUM.formatByMask(sfs,sizeByMetric.min));}return{item:sizeByMetric.n,elements:sizeByElements};}}return null;}function initLegendData(layer){layer.colorByInfo=layer.isColorByAttr?layer.legendColorByElements:prepareLegendColorByMetricsData(layer);layer.sizeByInfo=prepareLegendSizeByData(layer);}function preInitLegend(layer){var map=this;if(map.hasColorByOrSizeBy(layer.key)){initLegendData(layer);return true;}return false;}mstrmojo.gmaps._MapLegendController=mstrmojo.provide("mstrmojo.gmaps._MapLegendController",{_mixinName:"mstrmojo.gmaps._MapLegendController",legendCon:null,legendSlots:{},initializeLegendCon:function initializeLegendCon(){var lgdCon,map=this,lph=map.legendPlaceholder;if(!!map.legendCon){return ;}lgdCon=this.legendCon=new LEGEND_CON({placeholder:lph});lgdCon.render();lgdCon.domNode.id="map-legend-container-docked-node";lgdCon.initializeLgdCon(map);lgdCon.calDefaultDockedPositions();},createSingleLegend:function createSingleLegend(layerKey){var lgdCon,layer=this.getGraphicLayer(layerKey);if(!this.legendCon){this.initializeLegendCon();}lgdCon=this.legendCon;if(!preInitLegend.call(this,layer)){return false;}lgdCon.createSingleMapLegend(layerKey,layer.getLegendShowProperty());return true;},isLegendExist:function isLegendExist(layerKey){var lgdCon=this.legendCon;if(!lgdCon){return false;}return lgdCon.isLegendExist(layerKey);},switchLegend:function switchLegend(display,layerKey){var lgdCon=this.legendCon;if(!lgdCon){return ;}if(display){lgdCon.showSingleLegend(layerKey);}else{if(display===false){lgdCon.hideSingleLegend(layerKey);}}},refreshLegendNodes:function refreshLegendNodes(){if(!this.legendCon){return ;}this.legendCon.refreshMapLegendNodes();},resizeLegendByWidget:function resizeLegendByWidget(){if(!this.legendCon){return ;}this.legendCon.handleWidgetResize();},resetLegendColorByData:function resetLegendColorByData(layerKey){if(!this.legendCon){return ;}var layer=this.getGraphicLayer(layerKey);layer.colorByInfo=layer.isColorByAttr?layer.legendColorByElements:prepareLegendColorByMetricsData(layer);this.legendCon.resetLegendColorByData(layerKey,layer.colorByInfo);},resetLegendSizeByData:function resetLegendSizeByData(layerKey){if(!this.legendCon){return ;}var layer=this.getGraphicLayer(layerKey);layer.sizeByInfo=prepareLegendSizeByData(layer);this.legendCon.resetLegendSizeByData(layerKey,layer.sizeByInfo);},refreshLegendColorByData:function refreshLegendColorByData(layerKey){if(!this.legendCon){return ;}var layer=this.getGraphicLayer(layerKey);this.legendCon.resetLegendColorByData(layerKey,layer.colorByInfo);},destroyLegend:function destroyLegend(layerKey){if(!this.legendCon){return ;}this.legendCon.destroyLegend(layerKey);},destroyLegendCon:function destroyLegendCon(){if(!this.legendCon){return ;}this.legendCon.destroyLegendCon();this.legendCon=null;},updateLegendTitle:function updateLegendTitle(layerKey,lgdTitle){if(!this.legendCon){return ;}this.legendCon.updateLegendTitle(layerKey,lgdTitle);},handleLegendOnLayerVisibleChange:function handleLegendOnLayerVisibleChange(layerKey){if(!this.legendCon){return ;}this.legendCon.handleLayerVisibleChange(layerKey);},handleLegendConSizePropChange:function handleLegendConSizePropChange(legendSizeProp){if(!this.legendCon){return ;}this.legendCon.handleLegendConSizePropChange(legendSizeProp);},removeLegendBySwitchProp:function removeLegendBySwitchProp(layerKey){if(!this.legendCon){return ;}this.legendCon.removeLegendBySwitchProp(layerKey);},resetLegendContainerHeight:function resetLegendContainerHeight(){if(!this.legendCon){return ;}this.legendCon.resetLegendConHeight();},getLegendConSizeProp:function getLegendConSizeProp(){if(!this.legendCon){return undefined;}return this.legendCon.getLegendConSizeProp();},handleLegendCollapsePropChange:function handleLegendCollapsePropChange(layerKey,collapse){if(!this.legendCon){return ;}this.legendCon.handleLegendCollapsePropChange(layerKey,collapse);}});}());