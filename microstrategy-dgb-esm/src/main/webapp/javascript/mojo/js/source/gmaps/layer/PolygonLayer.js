(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.gmaps.MapEnums","mstrmojo.gmaps.MapUtils","mstrmojo.gmaps.layer.GraphicLayer","mstrmojo.PerformanceLogOutput","mstrmojo.gm.GMUtility");var $MOJO=mstrmojo,$EMPTY_FUNC=$MOJO.emptyFn,$ARR=$MOJO.array,$GMAPS=$MOJO.gmaps,$MUTIL=$GMAPS.MapUtils,$EnumGeographicRole=$GMAPS.EnumGeographicRole,$EnumThreholdType=$GMAPS.EnumThresholdType,$PerfLog=mstrmojo.PerformanceLogOutput,$GM=$MOJO.gm,$GMU=$GM.GMUtility,$EnumPropertyType=$GMAPS.EnumPropertyType;mstrmojo.gmaps.layer.PolygonLayer=mstrmojo.declare(mstrmojo.gmaps.layer.GraphicLayer,null,{scriptClass:"mstrmojo.gmaps.layer.PolygonLayer",_features:null,_returnedQuery:0,init:function init(props){if(!props){return ;}this._super(props);var baseMapType=this.getBaseMapType();if(!baseMapType){$MUTIL.log("no base layer found");}},initGraphics:function initGraphics(){var shapeId=this.getLayerProp($EnumPropertyType.shapeFile),colorAttrIdx=this.getColorAttrIdx();this.findMappableAttributes(shapeId);if(!this.dataValidate()){this.updateMapExtent();$MUTIL.log("Unsupported NDE format.");return false;}if(this.isColorByAttr===true&&colorAttrIdx>=0){this.initColorMap();}return true;},initColorMap:function initColorMap(){var dTable={},rowHeaders=this.getDataRowHeaders(),rows=this.getDataRows(),rowIndex,rowGeoHeader,name,geoPosition=this.geoPosition,rowIndexArr=[],colorAttrIdx=this.getColorAttrIdx(),rowHeadersLength=rowHeaders.length,rowHeader,rowHeaderItems,row,rowElems,rowElem;if(colorAttrIdx<0||geoPosition<0){return ;}for(rowIndex=rowHeadersLength-1;rowIndex>=0;rowIndex-=1){rowHeader=rowHeaders[rowIndex];rowHeaderItems=rowHeader.items;rowGeoHeader=rowHeaderItems[geoPosition];row=rows[geoPosition];rowElems=row.es;rowElem=rowElems[rowGeoHeader.idx];name=rowElem.n;name=$MUTIL.trimString(name);name=name.toLowerCase?name.toLowerCase():name;if(!!dTable[name]){continue;}dTable[name]=rowIndex;rowIndexArr.push(rowIndex);}this.generateColorMap(rowIndexArr,colorAttrIdx);this.processLegendColorByInfo();},buildLayerContent:function buildLayerContent(features,geoPosition,mappedValue,toRefresh){$PerfLog.endTimer("timerid_callback_initShapeInfo");$PerfLog.visPrint("create shape info start");var timerid=$PerfLog.startTimer({functionName:"PolygonLayer.buildLayerContent: ",purpose:"create Polygon Layer, update Map Extent"});var shapeInfoArr=this.shapeInfoArr=this.initShapeInfo(features,geoPosition,mappedValue,toRefresh);if(!this.infoTemplate){this.infoTemplate=this.populateInfoTemplate();}this.buildGraphics(shapeInfoArr);this.updateMapExtent();$PerfLog.endTimer(timerid);$PerfLog.visPrint("create Polygon Layer, updateMapExtent end");},initShapeInfo:function initShapeInfo(features,geoPosition,mappedValue,toRefresh){var dataLookup=this.createLookup(geoPosition),shapeInfoArr=[],methodToGetSingleShapeInfo=toRefresh?"getSingleShapeInfoFromCache":"getSingleShapeInfo";if(!$ARR.isArray(features)||features.length<1){$MUTIL.log("Returned featureSet is empty.");return ;}$MUTIL.log("featureSet size="+features.length);if(!dataLookup){return ;}$ARR.forEach(features,function(shapeItem){var shapeInfo=this[methodToGetSingleShapeInfo](shapeItem,dataLookup,geoPosition,mappedValue);if(shapeInfo){shapeInfoArr.push(shapeInfo);}else{if(shapeInfo===false){return false;}}},this);delete this._shapeInfoArrCache;return shapeInfoArr;},getSingleShapeInfoFromCache:function getSingleShapeInfoFromCache(shapeItem,dataLookup,geoPosition){if(shapeItem){var attributes=this.populateGraphicAttributes(this.data,dataLookup,geoPosition,shapeItem.geoName,shapeItem.sfv)||{};this.populateGeoIdAndBBoxInfo(shapeItem,attributes);return{geoData:shapeItem.geoData,screenData:shapeItem.screenData,attributes:this.wrapOutfieldsAttrs(shapeItem.outFieldsAttrs,attributes),lat:shapeItem.lat,lng:shapeItem.lng,type:shapeItem.type};}},populateGeoIdAndBBoxInfo:function populateGeoIdAndBBoxInfo(feature,attributes){attributes.geoId=feature.id;attributes.bbox=feature.bbox;},createLookup:$EMPTY_FUNC,onIncrementalQueryFeaturesComplete:$EMPTY_FUNC,populateColorInfo:function populateColorInfo(shapeInfoAttributes){var colorAttrIdx=this.getColorAttrIdx();if(colorAttrIdx>=0){this.generateColorInfo(shapeInfoAttributes,colorAttrIdx);}},populateGraphicAttributes:function populateGraphicAttributes(data,dataLookup,geoPosition,geoName,secondaryFieldName){if(!data||!dataLookup||!(dataLookup instanceof Object)||!$MUTIL.checkDefined(geoName)||!$MUTIL.checkDefined(geoPosition)){return ;}var attributes={},col=data.gts&&data.gts.col,items=data.gvs&&data.gvs.items,originGeoName=geoName,location,rowIndex,dataRow,rowHeaders,rowCell,rowCellTitle,rowCellValue,threshold,thresholdType,i,il;attributes.geoName=geoName;geoName=(geoName.toLowerCase)?geoName.toLowerCase():geoName;location=dataLookup[geoName];if(location===undefined){return ;}rowIndex=location.rowIndex;attributes.rowIndices=[rowIndex];attributes.geoIndex=location.geoIndex;attributes.columnIndices=[geoPosition,geoPosition];attributes.dataLabelText=location.dlText||originGeoName;attributes.originGeoName=location.originGeoName;if(rowIndex===undefined){$MUTIL.log("Missing..."+geoName);return ;}attributes=this.formatAttribute(attributes,rowIndex);if(!!col&&col.length===1&&col[0].otp===-1){dataRow=items[rowIndex].items;rowHeaders=col[0].es;for(i=0,il=dataRow.length;i<il;i++){rowCell=dataRow[i];rowCellTitle=rowHeaders[i].n;rowCellValue=dataRow[i].v;thresholdType=dataRow[i].ty;if(!thresholdType||thresholdType===$EnumThreholdType.Number){attributes[$MUTIL.replaceSpace(rowCellTitle)]=rowCellValue;}else{attributes[$MUTIL.replaceSpace(rowCellTitle)]=dataRow[i].rv;}}}if(this.isColorByAttr===true){this.populateColorInfo(attributes);}threshold=this.getThresholdInfo(rowIndex,this.colorMetricIdx);if(!!threshold){attributes.threshold=threshold;}if(secondaryFieldName){attributes.sfv=secondaryFieldName;}else{if(location.sfv){attributes.sfv=location.sfv;}}return attributes;},getCoordinateArr:function getCoordinateArr(arr,coorArr){var i,il;if($ARR.isArray(arr)&&$ARR.isArray(arr[0])&&$ARR.isArray(arr[0][0])){for(i=0,il=arr.length;i<il;i++){getCoordinateArr(arr[i],coorArr);}}else{if($ARR.isArray(arr)&&$ARR.isArray(arr[0])){coorArr.push(arr);}else{if($ARR.isArray(arr)){coorArr.push([arr]);}}}},getGeoColumnIndex:function getGeoColumnIndex(){return $MUTIL.checkVal(this.geoPosition)?this.geoPosition:-1;},findMappableAttributes:function findMappableAttributes(shapeId){var geoPosition=-1,geoAttributeId=this.dropZones&&this.dropZones.geoAttribute,rowAttributes=this.getDataRows(),numAttributes,attribute,i;if(!rowAttributes){this.geoPosition=geoPosition;return ;}numAttributes=rowAttributes.length;for(i=0;i<numAttributes;i++){attribute=rowAttributes[i];if(this.isGeoAttribute(geoAttributeId,attribute)&&geoPosition<0&&this.verifyGeoRole(attribute)){geoPosition=i;}}if(geoPosition<0){for(i=0;i<numAttributes;i++){attribute=rowAttributes[i];if(geoAttributeId===attribute.id&&!!shapeId&&this.verifyGeoRole(attribute,true)){geoPosition=i;}}}if(geoPosition<0){$MUTIL.log("No Mappable attributes present on the report.");}this.geoPosition=geoPosition;},verifyGeoRole:function verifyGeoRole(attribute,skipNone){var _rtn=false,forms=attribute.fs,form,geoRole,i,il;if(!forms||forms.length<1){return _rtn;}for(i=0,il=forms.length;i<il;i++){form=forms[i];if(!!form&&$MUTIL.checkDefined(form.fgr)){geoRole=form.fgr.toString();}if((skipNone||geoRole!==$EnumGeographicRole.EnumGeographicRoleNone)&&geoRole!==$EnumGeographicRole.EnumGeographicRoleLatitiude&&geoRole!==$EnumGeographicRole.EnumGeographicRoleLongitude){_rtn=true;break;}}return _rtn;},formatAttribute:function formatAttribute(attributes,rowIndex){var rowTitles=this.getDataRows(),rowHeaders=this.getDataRowHeaders(),rowHeaderItems=rowHeaders&&rowHeaders[rowIndex].items,attrTitle,k,kl=rowHeaderItems.length,rowCell,rowCellTitle,rowCellValue;for(k=0;k<kl;k++){rowCell=rowHeaderItems[k];rowCellTitle=rowTitles[k].n;rowCellValue=$MUTIL.trimString(rowTitles[k].es[rowCell.idx].n);attrTitle=$MUTIL.replaceSpace(rowCellTitle);if(!attributes[attrTitle]){attributes[attrTitle]=rowCellValue;}}return attributes;},getGeoExtent:function getGeoExtent(){if(!this.geoExtent){this.geoExtent=this._calGeoExtent(!this.isGeoDataLayer());}return this._super();},_calGeoExtent:function _calGeoExtent(isNotGeo){var graphics=this.graphics,geoExtent,graphic,pGeoExtent,i,il;if(!graphics||!$ARR.isArray(graphics)){return ;}for(i=0,il=graphics.length;i<il;i++){graphic=graphics[i];pGeoExtent=graphic&&graphic.getGeoExtent(isNotGeo);if(!pGeoExtent){continue;}if(!geoExtent){geoExtent=pGeoExtent;}else{geoExtent.union(pGeoExtent);}}return geoExtent;},wrapOutfieldsAttrs:function wrapOutfieldsAttrs(srcAttrs,tgtAttrs){return tgtAttrs;},_cacheShapeInfo:function _cacheShapeInfo(graphics){var me=this,_shapeInfoArrCache=this._shapeInfoArrCache=[];$ARR.forEach(graphics,function(graphic){if(!graphic){return ;}var attributes=graphic.attributes;if(attributes){_shapeInfoArrCache.push({id:attributes.geoId,geoName:attributes.geoName,sfv:attributes.sfv,bbox:attributes.bbox,geoData:graphic.geoData,screenData:graphic.screenData,lat:graphic.lat,lng:graphic.lng,type:graphic.type,outFieldsAttrs:me.wrapOutfieldsAttrs(attributes,{})});}});},generateColorData:function generateColorData(graphics,colorData,cmSelColorData,hoverColorData){var me=this;$ARR.forEach(graphics,function(graphic){var attributes=graphic.attributes,colorInfo=me.model.docModel.getColorBy(attributes.colorByAttributeIds,attributes.colorByElementIds),colorValue=$GMU.decodeColor(colorInfo.color);attributes.color.value=colorValue;colorData.push([attributes.geoId,colorValue]);cmSelColorData.push([attributes.geoId,$MUTIL.fillColorAjustForCMSelection(colorValue)]);hoverColorData.push([attributes.geoId,$MUTIL.fillColorAjustForHover(colorValue)]);});},generateOpacityData:function generateOpacityData(graphics,opacities,opacityData){var me=this;$ARR.forEach(graphics,function(graphic){var attributes=graphic.attributes,opacity=me.getAttrColorByOpacity(attributes.colorByAttributeIds,attributes.colorByElementIds,opacities)/100;attributes.color.opacity=opacity;opacityData.push([attributes.geoId,opacity]);});},unrender:function unrender(){this._cacheShapeInfo(this.graphics);this._super();},destroy:function destroy(){this._features=null;this._super();}});}());