(function(){mstrmojo.requiresCls("mstrmojo.vi.controllers.DocumentControllerBase","mstrmojo.DI.DIConstants","mstrmojo.vi.ui.DocumentView","mstrmojo.vi.ui.VizGallery","mstrmojo.vi.ui.TableOfContents","mstrmojo.vi.models.DocModel","mstrmojo.vi.models.VIComponentMap","mstrmojo.vi.controllers._PanelControl","mstrmojo.vi.controllers._LayoutControl","mstrmojo.vi.controllers.EnumEvents","mstrmojo.vi.controllers.EnumPanelManipulationType","mstrmojo.vi.controllers.EnumLayoutManipulationType","mstrmojo.vi.controllers.EnumLayoutSelectorPosition","mstrmojo.ME.DerivedAttributeIDE","mstrmojo.hash","mstrmojo.func","mstrmojo.UUID","mstrmojo.vi.ui.DatasetEditor","mstrmojo.vi.controllers.UICmdMgr","mstrmojo.vi.ui.editors.ConfirmSaveEditor","mstrmojo.vi.ui.DatasetUnitMenuUtils","mstrmojo.vi.ui.editors.DerivedElementsEditor","mstrmojo.Label","mstrmojo.TextBox","mstrmojo.Button","mstrmojo.vi.models.DEConsolidation","mstrmojo.vi.ui.editors.RenameDEEditor","mstrmojo.vi.ui.editors.CalculatedMemberEditor","mstrmojo.expr","mstrmojo.models.FormatModel","mstrmojo.dom","mstrmojo.DocDataService","mstrmojo.vi.ui.ToggleViewBar","mstrmojo.vi.ui.editors.nlp.NLPEditor","mstrmojo.vi.controllers._NLPControl","mstrmojo.vi.enums.EnumFeatures","mstrmojo.mstr.EnumFunction","mstrmojo.mstr.ElementsDataHelper","mstrmojo.string");mstrmojo.requiresClsP("mstrmojo.vi.factories","VisualizationTransitionFactory");mstrmojo.requiresDescs(221,1388,5414,5415,5421,5422,11812,13157,14719);var $VI=mstrmojo.vi,$FUNC=mstrmojo.func,$HASH=mstrmojo.hash,$ARR=mstrmojo.array,$FOREACHARRAY=mstrmojo.array.forEach,$UUID=mstrmojo.UUID,$DESC=mstrmojo.desc,$NWB=mstrmojo.Button.newWebButton,E=mstrmojo.expr,$DU=mstrmojo.vi.ui.DatasetUnitMenuUtils,$DDS=mstrmojo.DocDataService,$DOM=mstrmojo.dom,$FORMAT_MODEL=mstrmojo.models.FormatModel,EVENTS=mstrmojo.vi.controllers.EnumEvents,PANEL_MANIPULATION_TYPE=mstrmojo.vi.controllers.EnumPanelManipulationType,LAYOUT_MANIPULATION_TYPE=mstrmojo.vi.controllers.EnumLayoutManipulationType,LAYOUT_SELECTOR_POSITION=mstrmojo.vi.controllers.EnumLayoutSelectorPosition,$VI_MODELS=$VI.models,VI_TYPES=mstrmojo.vi.models.VIComponentMap.TYPES,$HIDSEC=mstrmojo.vi.enums.EnumHiddenSections,FEATURES=mstrmojo.vi.enums.EnumFeatures,$FN_TP=mstrmojo.mstr.EnumFunction,SUPPRESS_DATA=mstrmojo.DocDataService.SUPPRESS_DATA;var EXP_PDF=3,EXP_EXCEL=4,SECOND_TO_MILLISECOND=1000;var TP_ATTRIBUTE=12,STP_RECURSIVE_ATTRIBUTE=3076;var WS_ALERT_TYPE_EXISTING_OBJECT=2;var SAVE_WAIT_BOX_CONFIG={config:{waitBoxCfg:{message:mstrmojo.desc(10492,"Saving..."),cssClass:"saving-in-progress"}}};function getRefreshMsgCallback(){var modelId=this.model.id;return{success:function success(res){mstrmojo.all[modelId].mid=res.mid;}};}function openRenameDEEditor(w,view,action){var RENAME_DE_EDITOR_ID="mstrmojo-renameDerivedElement",editor=mstrmojo.all[RENAME_DE_EDITOR_ID]||mstrmojo.insert({scriptClass:"mstrmojo.vi.ui.editors.RenameDEEditor",id:RENAME_DE_EDITOR_ID,title:(action.funcVal===-1)?$DESC(5414,"Create Group "):$DESC(5415,"Create Calculation")});editor.view=view;editor.action=action;editor.controller=w;editor.open();editor.set("title",(action.act.indexOf("edit")>=0)?$DESC(1388,"Rename"):(action.funcVal===-1)?$DESC(5187,"Group"):$DESC(5188,"Calculation"));editor.children[0].name.set("value",action.deName);}function openCalculatedMemberEditor(w,view,action){var ADD_PTHR_CALC_EDITOR_ID="mstrmojo-CalculatedMemberEditor",editor=mstrmojo.all[ADD_PTHR_CALC_EDITOR_ID]||mstrmojo.insert({scriptClass:"mstrmojo.vi.ui.editors.CalculatedMemberEditor",id:ADD_PTHR_CALC_EDITOR_ID});editor.view=view;editor.action=action;editor.controller=w;editor.open();}function saveBoxLayoutAndExecuteFn(fn,args,extra){var controllerId=this.id,docModel=this.model,waitBoxCfg=$HASH.walk("config.waitBoxCfg",extra),update;if(mstrApp.isAppStatePause&&mstrApp.isAppStatePause()){extra=$HASH.copy(extra,$HASH.copy(SUPPRESS_DATA,{preserveUndo:true}));update=docModel.getDataService().newUpdateWithoutCmd({extras:extra});docModel.applyBufferedSelections(update);}extra=$HASH.copy(extra,{params:{rapidExec:false,suppressData:true},message:(waitBoxCfg&&waitBoxCfg.message)||mstrmojo.desc(97,"Executing...")});this.view.layoutViewer.saveBoxLayout(undefined,undefined,{success:function success(){fn.apply(mstrmojo.all[controllerId],args);}.bind(this)},update,extra);if(mstrApp.isAppStatePause&&mstrApp.isAppStatePause()){update.submit();}}function unlinkBeforeEditingDA(model,srcAttrId,attrForms,cb){var me=this,srcForms=[],tgtAttributes=[],tgtForms=[],ITEM_SEPARATOR="\u001E",unlinkCb=$FUNC.wrapMethods({success:function(res){model.als=res.als;}},model.controller.getRefreshCallback());$ARR.forEach(attrForms,function(fm){var links=model.als&&model.als.links[srcAttrId+" "+fm.fid];$ARR.forEach(links,function(al){srcForms.push(fm.fid);var tgt=al.split(" ");tgtAttributes.push(tgt[0]);tgtForms.push(tgt[1]);});});if(srcForms.length>0){var tgtAttrId=tgtAttributes[0],tgtAttrName=null,srcAttrName=null;$HASH.forEach(model.datasets,function(ds){$ARR.forEach(ds.att,function(item){if(item.did===tgtAttrId){tgtAttrName=item.n;}else{if(item.did===srcAttrId){srcAttrName=item.n;}}if(tgtAttrName&&srcAttrName){return false;}});if(tgtAttrName&&srcAttrName){return false;}});new mstrmojo.Editor({params:null,cssClass:"mstrmojo-ConfirmEditLink-Editor",title:$DESC(11812,"Notification"),onPreClose:function onPreClose(){cb.canceled();this.hideTooltip();return true;},children:[{scriptClass:"mstrmojo.HBox",cssClass:"mstrmojo-Warning-Box",children:[{scriptClass:"mstrmojo.Box",cssClass:"icon"},{scriptClass:"mstrmojo.Label",text:$DESC(13157,"## and ### are linked. You need to unlink these attributes to make changes to ##.").replace("###",tgtAttrName).replace(/##/g,srcAttrName),cssClass:"message"}]},{scriptClass:"mstrmojo.HBox",slot:"buttonNode",cssClass:"mstrmojo-Editor-buttonBar",children:[{scriptClass:"mstrmojo.Box"},$NWB(mstrmojo.desc(13156,"Unlink and Edit"),function(){var editor=this.parent.parent,act={act:"applyAttributeLinking",srcAttrId:srcAttrId,srcFormId:srcForms.join(ITEM_SEPARATOR),tgtAttrId:tgtAttributes.join(ITEM_SEPARATOR),tgtFormId:tgtForms.join(ITEM_SEPARATOR),unlink:true};me.cmdMgr.execute({execute:function(){this.submit(act,$FUNC.wrapMethods(unlinkCb,cb),{style:{params:{treesToRender:3}}});},urInfo:{callback:unlinkCb}});editor.close();},true,{width:"100px"}),$NWB(mstrmojo.desc(221,"Cancel"),function(){cb.canceled();this.parent.parent.close();})]}]}).render();}else{cb.success();}}function newDSPanelForAttrEditor(docModel,ignoreMetric){var me=this,fnFilter=function(items){var act=me.daIDE.action,editId=act.did,dataset=this.dataset.set,hasCGorConsolidation=$DU.hasCGorCon(dataset);items=$ARR.filter(items,function(itm){var isCGorConsolidation=$DU.isCGorCon(itm,dataset),isNDE=(itm.t===47&&itm.st===12033);return itm.did!==editId&&!itm.um&&!itm.rdm&&!isCGorConsolidation&&!isNDE;});if(ignoreMetric||hasCGorConsolidation||docModel.isMDXDataset(dataset)){items=$ARR.filter(items,function(itm){return itm.t!==4;});}return items;},dsFnFilter=function(datasets){var filteredDatasets={};$HASH.forEach(datasets,function(dataset,id){dataset.isMDX=docModel.isMDXDataset(dataset);dataset.isDDA=docModel.isDDADataset(dataset);dataset.isSpark=docModel.isSparkDataset(dataset);if(!(dataset.isMDX&&dataset.isDDA)){filteredDatasets[id]=dataset;}});return filteredDatasets;},filterNodeCfg=ignoreMetric?{att:false,mx:false}:undefined;return $HASH.copy({doubleClickItemHandler:function(item){me.daIDE.onObjectInsert(item);}},docModel.getDatasetsPanel("190px",fnFilter,dsFnFilter,filterNodeCfg));}function refreshDocument(docCtrl,callback){docCtrl.model.getDataService().refresh({styleName:"JsonRWDStyle"},$FUNC.wrapMethods(docCtrl.getRefreshCallback(),callback));}function refreshDocumentWithSessionState(docCtrl,callback){docCtrl.model.getDataService().refresh({styleName:"JsonRWDStyle",sessionState:mstrApp?mstrApp.sessionState:""},$FUNC.wrapMethods(callback,docCtrl.getRefreshCallback()));}function hasDataSource(model){return !!Object.keys(model.datasets||{}).length;}function syncRequestForOneTier(){if(mstrApp.isSingleTier){var formWrapper=window.FormWrapper;if(formWrapper){formWrapper.serverRequest("syncRequests","","","");}}}mstrmojo.vi.controllers.DocumentController=mstrmojo.declare(mstrmojo.vi.controllers.DocumentControllerBase,[mstrmojo.vi.controllers._PanelControl,mstrmojo.vi.controllers._LayoutControl,mstrmojo.vi.controllers._NLPControl],{scriptClass:"mstrmojo.vi.controllers.DocumentController",datasetsPanel:null,tocPanel:null,galleryPanel:null,refStartTime:0,remTimeForRef:0,autoRefReqSent:false,autoRefReqId:undefined,start:function start(documentData){this._super(documentData);var rootCtrl=this.rootCtrl;var model=this.model;var view=this.view;var linkbar=rootCtrl.view.linkbar;if(linkbar){rootCtrl.view.attachEventListener(EVENTS.DO_LAYOUT,linkbar.id,function(){rootCtrl.view.doLayout();});linkbar.set("docId",model.oid);linkbar.showLinkBar(model.isnew);}var tabPosProperty=$FORMAT_MODEL.ENUM_PROPERTY_NAMES.LAYOUT_TAB_POSITION,tabPosUndefined=model[tabPosProperty]===undefined;if(tabPosUndefined){var newTabsPos=(model.isnew&&mstrApp.isWSStyling)?LAYOUT_SELECTOR_POSITION.LEFT:LAYOUT_SELECTOR_POSITION.BOTTOM;model[tabPosProperty]=newTabsPos;}var isCPVisible=model.defn.root.tocv;if(isCPVisible===undefined){isCPVisible=true;}if(!!mstrApp.isWSStyling){var defnRoot=model.defn.root,tocw=defnRoot.tocw,tocWidth="174px";if(tocw){var width=parseInt(tocw,10);if(width<=mstrmojo.vi.ui.TableOfContents.MAX_WIDTH&&width>=mstrmojo.vi.ui.TableOfContents.MIN_WIDTH){tocWidth=tocw;}}this.tocPanel=new mstrmojo.vi.ui.TableOfContents({width:tocWidth,visible:isCPVisible,data:model.getTocData(),getPanelSaver:function(){return $VI_MODELS.PanelFormatSaver.getPanelSaver(model,{size:{set:"FormattingAnalysis",name:"TOCWidth",convert:true}});},model:model});rootCtrl.view.attachEventListener(EVENTS.CONTENTS_PANEL_VISIBILITY_CHANGE,this.id,function(evt){this.tocPanel.onContentPanelVisibilityChange(evt);});model.attachEventListener(EVENTS.UPDATE_TOC,this.id,function(){this.tocPanel.set("data",model.getTocData());});this.addDisposable(this.tocPanel);rootCtrl.setTocPanel(this.tocPanel);}this.datasetsPanel=model.getDocDatasetsPanel();rootCtrl.setDatasetObjectsPanel(this.datasetsPanel);var layoutXml=documentData.defn.root.layoutXML,galleryOpen=layoutXml?!!layoutXml.go:true;this.galleryPanel=new $VI.ui.VizGallery({width:"170px",model:model,visible:galleryOpen&&mstrApp.allowWebDashboardDesign()});rootCtrl.setGalleryView(this.galleryPanel);if(!!mstrApp.isWSStyling){model.attachEventListener("panelDisplaying",this.id,function(evt){this.tocPanel.set("displayPageInfo",{layoutKey:evt.layoutKey,panelKey:evt.panelKey});});model.attachEventListener(EVENTS.CHANGE_COVER_IMAGE,this.id,function(evt){this.changeCoverPage(evt);});model.ondefnChange();}rootCtrl.view.setIsCPVisible(isCPVisible,true);rootCtrl.setDocumentView(view);if(documentData.pvpe==="1"){mstrmojo.alert(mstrmojo.desc(15534,"Your personal view displays only a subset of your changes as the source dossier definition has been modified. Please contact your administrator for more information."));}var isVIPaneHidden=mstrApp.isSectionHidden($HIDSEC.VIPANE);if((isVIPaneHidden||mstrApp.isSectionHidden($HIDSEC.EDITOR))&&this.getViPanel("editPanel")){this.getViPanel("editPanel").setOpenStatus(false,true,undefined);}if((isVIPaneHidden||mstrApp.isSectionHidden($HIDSEC.PROPERTIES))&&this.getViPanel("propertiesPanel")){this.getViPanel("propertiesPanel").setOpenStatus(false,true,undefined);}if((isVIPaneHidden||mstrApp.isSectionHidden($HIDSEC.FILTER))&&this.getViPanel("filterPanel")){this.getViPanel("filterPanel").setOpenStatus(false,true,undefined);}if(mstrApp!==undefined&&window.mstrLocalStorage!==undefined){mstrLocalStorage.addScreenshot(mstrApp.getLastMsgRecoveryInfo(),view.domNode);}model.attachEventListener("layoutSelected",view.id,"layoutSelected");model.attachEventListener("selectPage",view.id,"selectPage");model.attachEventListener("updateDatasets",this.id,function(){view.set("hasDataSource",hasDataSource(model));});model.attachEventListener(EVENTS.MANIPULATE_LAYOUT,this.id,function(evt){this.manipulateLayout(evt);});model.attachEventListener(EVENTS.MANIPULATE_PANEL,this.id,function(evt){this.manipulatePanel(evt);});this.addDisposable([this.datasetsPanel,this.galleryPanel]);if(mstrApp!==undefined&&window.mstrLocalStorage!==undefined){mstrLocalStorage.addScreenshot(mstrApp.getLastMsgRecoveryInfo(),view.domNode);}if(mstrmojo.resolveFeature(FEATURES.SUPPORT_NLP)&&model.buildWordBase){model.buildWordBase(true);}},convertToDoc:function convertToDoc(){this.model.updateWidgetsProps();saveBoxLayoutAndExecuteFn.call(this,this._super,[true]);},save:function save(params,target){this.model.updateWidgetsProps();syncRequestForOneTier();saveBoxLayoutAndExecuteFn.call(this,this._super,[].concat(params||{}).concat(target||[]),SAVE_WAIT_BOX_CONFIG);},savePromptOption:function(){var me=this;this.popPromptOption(function fnCallback(){me.dSave(undefined,undefined,true);});},printPDF:function prntPDF(gridKey){var model=this.model,callbackFn=function callbackFn(){var currentStateId=model.getDataService().stid||0,lastSavedStateId=model.lastSavedStid||0;if(currentStateId-lastSavedStateId===1){model.lastSavedStid=currentStateId;}};saveBoxLayoutAndExecuteFn.call(this,$FUNC.composite([this._super,callbackFn]),[gridKey]);},print:function print(gridKey){if($DOM.isChrome||($DOM.isSafari&&$DOM.isMac())){var me=this;this.rootCtrl.togglePrintPreview(true);var funcMatchMedia=window.matchMedia;if(funcMatchMedia){var mediaQueryList=funcMatchMedia("print");function handleAfterPrint(mql){var afterPrint=function(){me.rootCtrl.togglePrintPreview(false);mediaQueryList.removeListener(handleAfterPrint);};if(!mql.matches){afterPrint();}}mediaQueryList.addListener(handleAfterPrint);}window.setTimeout(function(){window.print();},1300);}else{this.printPDF(gridKey);}},dSave:function dSave(saveCB,widget,popPromptOption){var docCtrl=this,_super=this._super,docModel=docCtrl.model,fnSave=function(){docModel.getDataService().submitUpdates({},{submission:function(){mstrApp.showWait({message:mstrmojo.desc(10492,"Saving..."),cssClass:"saving-in-progress",showCancel:true});},complete:function complete(){mstrApp.hideWait();},success:function(){_super.call(docCtrl,saveCB,widget,popPromptOption);docModel.set("lastModifiedTime",(new Date()).getTime());docModel.raiseEvent({name:EVENTS.LAST_MODIFIED_CHANGE,timeStamp:docModel.lastModifiedTime});}},$HASH.copy(SAVE_WAIT_BOX_CONFIG,{params:{taskId:"getObjectInfo",objectIDs:docCtrl.model.oid,objectTypes:"55"}}));};this.model.updateWidgetsProps();syncRequestForOneTier();saveBoxLayoutAndExecuteFn.call(this,mstrApp.isSingleTier?this._super:fnSave,undefined,SAVE_WAIT_BOX_CONFIG);},openDME:function(opener,config,fnOk){var me=this,model=me.model,fnFilter=function filterDatasetsUnits(items){return mstrmojo.array.filter(items,function(item){return item.st!==E.STP.CONS&&item.st!==E.STP.CUSTOMGROUP&&item.did!==config.metricId;});},metricId=config.metricId||(config.action.refOi&&config.action.refOi.did),metricIDE=new mstrmojo.ME.DerivedMetricIDE({datasetsObjects:mstrmojo.hash.copy({visible:false},model.getDatasetsPanel("190px",fnFilter)),zIndex:5,disableConditionMetric:!mstrApp.supportFeature(FEATURES.SUPPORT_CONDITION_METRIC)||model.isFromLiveMDXCube(metricId)});config.onApplyMetricCallback=fnOk;config.datasets=model.datasets;metricIDE.open(opener,config);metricIDE.datasetsObjects.refresh();this.addDisposable([metricIDE]);},openDAE:function openDAE(view,config,fnWait,onAttribute){var m=this.model,derivedAttrIDE=this.daIDE=new mstrmojo.ME.DerivedAttributeIDE({datasetsObjects:newDSPanelForAttrEditor.call(this,m),zIndex:5}),me=this,submitAction=function(params,cb){var cfg=derivedAttrIDE.action,fnPreCreate=cfg.did?cfg.preupdate:cfg.precreate,callbacks=m.controller.getRefreshCallback();params=fnPreCreate?fnPreCreate(params):params;me.submitUndoRedoUpdates(params,null,$FUNC.wrapMethods(cb,callbacks),$HASH.copy(cfg.extras,$DDS.REQUEST_DEFN_DATA));};$HASH.copy({cmd:"editNew",fnWait:fnWait,msgID:m.mid,oncreate:submitAction,onupdate:submitAction},config);if(onAttribute){config.funccat=mstrmojo.ME.DerivedAttributeIDE.getDefaultFunctionCategory(onAttribute);var dfm=onAttribute.fs&&onAttribute.fs[0];if(dfm){config.refOi={n:onAttribute.n+"@"+dfm.fnm,did:onAttribute.did+"@"+dfm.fid};}}derivedAttrIDE.action=config;derivedAttrIDE.view=view;if(config.did){unlinkBeforeEditingDA.call(this,m,config.did,config.forms,{success:function success(){derivedAttrIDE.open(view,{editorId:config.id});},failure:function failure(){derivedAttrIDE.destroy();},canceled:function canceled(){derivedAttrIDE.destroy();}});}else{derivedAttrIDE.open(view,{editorId:config.id});}this.addDisposable([derivedAttrIDE]);},openDynamicLinkEditor:function openDynamicLinkEditor(view,config,fnWait,onAttribute){var m=this.model,dynamicLinkIDE=this.daIDE=new mstrmojo.ME.DerivedAttributeIDE({datasetsObjects:newDSPanelForAttrEditor.call(this,m,true),zIndex:5,hasFunctionBrowser:false,onObjectInsert:function(items){mstrmojo.all.mstrDLE.onObjectInsert(items);}}),me=this,submitAction=function(params,cb){var cfg=dynamicLinkIDE.action,fnPreCreate=cfg.did?cfg.preupdate:cfg.precreate,callbacks=m.controller.getRefreshCallback();params=fnPreCreate?fnPreCreate(params):params;me.submitUndoRedoUpdates(params,null,$FUNC.wrapMethods(cb,callbacks),cfg.extras);};$HASH.copy({cmd:"editNew",fnWait:fnWait,msgID:m.mid,oncreate:submitAction,onupdate:submitAction},config);if(onAttribute){config.refOi=onAttribute;config.n=onAttribute.n+mstrmojo.desc(14719,"(Link)");}dynamicLinkIDE.action=config;dynamicLinkIDE.view=view;if(config.did){unlinkBeforeEditingDA.call(this,m,config.did,config.forms,{success:function success(){dynamicLinkIDE.open(view,{editorId:"mstrDLE"});},failure:function failure(){dynamicLinkIDE.destroy();},canceled:function canceled(){dynamicLinkIDE.destroy();}});}else{dynamicLinkIDE.open(view,{editorId:"mstrDLE"});}this.addDisposable([dynamicLinkIDE]);},resumeVIPanelSelection:function resumeVIPanelSelection(callback){function getPanelContainer(layout){var panelContainers=mstrmojo.array.filter(layout.children,function(child){return child instanceof mstrmojo.vi.ui.BoxPanelContainer;});return panelContainers&&panelContainers[0];}function getTabList(controller){var curLayout=controller.view&&controller.view.getSelectedLayoutWidget(),panel=curLayout&&getPanelContainer(curLayout);return panel&&panel.tabList;}var me=this,tabList=getTabList(this),preSelection=tabList&&tabList.selectedIndex;return $FUNC.wrapMethods({success:function(){var tabLst=getTabList(me);if(tabLst){tabLst.singleSelect(preSelection);}}},callback);},addChapter:function addChapter(){var view=this.rootCtrl.view;if(!view.isCPVisible){view.setIsCPVisible(true);}this.model.raiseEvent({name:EVENTS.MANIPULATE_LAYOUT,type:LAYOUT_MANIPULATION_TYPE.NEW});},addPage:function addPage(){var model=this.model,layoutKey=model.getCurrentLayoutKey(),stack=model.getVIComponent(VI_TYPES.VIZ_CONTENT,layoutKey),panelStackKey=stack.k;if(!!mstrApp.isWSStyling){var view=this.rootCtrl.view;if(!view.isCPVisible){view.setIsCPVisible(true);}}model.raiseEvent({name:EVENTS.MANIPULATE_PANEL,type:PANEL_MANIPULATION_TYPE.NEW,panelStackKey:panelStackKey,layoutKey:layoutKey});},openNLP:function openNLP(){var isOtherEditorOpen=function(){var elements=document.getElementsByClassName("mstrmojo-Editor-curtain"),isOpen=false;$ARR.forEach(elements,function(element){isOpen=(element.style.display==="block");return !isOpen;});return isOpen;};if(!mstrApp.isAppStateDefault()||mstrApp.isLayoutModePreview()||mstrApp.isVFEditingMode||mstrApp.isInVFConfigMode||mstrApp.isInVFInteractMode||isOtherEditorOpen()){return ;}var docModel=this.model,docControl=this;var nlpEditor=this.questionEditor;if(!nlpEditor){this.questionEditor=nlpEditor=this.addDisposable(mstrmojo.insert({scriptClass:"mstrmojo.vi.ui.editors.nlp.NLPEditor",model:docModel,docControl:docControl,top:"60px"}));this.addDisposable(nlpEditor);}nlpEditor.open();},insertVisualization:function insertVisualization(){var model=this.model,vizContentPanel=model.getVizContentPanel();vizContentPanel.restoreAnyMaxedVizBox();model.addVisualization();},insertFilter:function insertFilter(){var model=this.model,vizContentPanel=model.getVizContentPanel();vizContentPanel.restoreAnyMaxedVizBox();model.insertNewFilter();},getViPanel:function getViPanel(type){return this.view.getViPanel(type);},openViPanel:function openViPanel(type,callback,skipServerRequest){this.view.openViPanel(type,callback,skipServerRequest);},selectViPanel:function selectViPanel(type){this.view.selectViPanel(type);},insertText:function insertText(){this.model.insertNewText();},insertHtml:function insertHtml(){this.model.insertNewHtmlContainer();},clearAllUnits:function clearAllUnits(){this.model.getSelectedViUnit().getZonesModel();},insertImage:function insertImage(){this.model.insertNewImage();},refresh:function refresh(){refreshDocument(this,getRefreshMsgCallback.call(this));},refreshWithData:function refreshWithData(response){var model=this.model,layoutsDefn=model.defn.layouts;response.defn.layouts.forEach(function(layout){var layoutKey=layout.k;if($ARR.find(layoutsDefn,"k",layoutKey)===-1){model.replaceLayout(layoutKey,response,true);}});model.cbkey=response.cbkey;model.dsc=response.dsc;model.mid=response.mid;model.objInfo=response.objInfo;model.pfid=response.pfid;model.dataService=null;model.getDataService();this.getRefreshCallback().success(response);},toggleAutoRefresh:function(){this[(!!this.isAutoRefreshStarted()?"stop":"start")+"AutoRefresh"]();},startAutoRefresh:function startAutoRefresh(){var model=this.model,rf=model.rf,me=this;if(rf>0){if(this.autoRefreshHandler){this.stopAutoRefresh();}this.refStartTime=new Date();this.autoRefreshHandler=setTimeout(function(){refreshDocumentWithSessionState(me,$FUNC.wrapMethods(getRefreshMsgCallback.call(me),{success:function success(){if(model.clearDisposables){model.clearDisposables();}if(me.autoRefreshHandler){me.startAutoRefresh();}},submission:function submission(requestId){me.autoRefReqId=requestId;me.autoRefReqSent=true;},complete:function complete(){me.autoRefReqId=undefined;me.autoRefReqSent=false;me.remTimeForRef=0;}}));},((this.remTimeForRef!==0)?this.remTimeForRef:rf)*SECOND_TO_MILLISECOND);}},pauseAutoRefresh:function pauseAutoRefresh(){if(this.autoRefreshHandler){clearTimeout(this.autoRefreshHandler);this.remTimeForRef=this.model.rf-(new Date().getTime()-this.refStartTime.getTime())/SECOND_TO_MILLISECOND;}},showSaveToEnvDialog:function showSaveToEnvDialog(callbackSuccess,callbackFailed,config){var controller=this;mstrmojo.warn(mstrmojo.desc(15390,"To add existing objects from an application, the dossier needs to be saved in an environment at first. Do you want to continue?"),{confirmBtn:{t:this.model.isnew?mstrmojo.desc(118,"Save"):mstrmojo.desc(3167,"Save As"),fn:function confirm(){var uuid,hasConfig=config&&config.isParam;if(hasConfig){uuid=$UUID.create();controller._datasetEditorConfig={id:uuid,config:config};}window.FormWrapper.saveAsDossier(hasConfig?callbackFailed:callbackSuccess,callbackFailed,uuid||"");}},cancelBtn:{t:mstrmojo.desc(221,"Cancel"),fn:function cancel(){if(config&&config.onCancel){config.onCancel();}}}});},addDataset:function addDataset(config){if(mstrApp.isWorkstation){var formWrapper=window.FormWrapper;if(!formWrapper.hasAnyActiveEnvironment()){if(config&&config.onCancel){config.onCancel();}formWrapper.presentNoEnvironmentAlert(WS_ALERT_TYPE_EXISTING_OBJECT);return ;}if(!(mstrApp.supportFeature(FEATURES.SUPPORT_LIVEMODE)&&mstrApp.getWSLiveMode())){this.showSaveToEnvDialog("addDataset","onCreateDatasetFailed",config);return ;}var configCache=this._datasetEditorConfig;if(typeof config==="string"&&configCache&&configCache.id===config){config=configCache.config;}var uuid;if(config&&config.isParam){uuid=$UUID.create();this._datasetEditorConfig={id:uuid,config:config};}formWrapper.showInsertExistingDatasets("onAddDatasetSuccess","onCreateDatasetFailed","onAddDatasetError",uuid||"");}else{var controller=this,dataService=controller&&controller.datasetsPanel,showDatasetPicker=dataService&&dataService.getShowDatasetPicker(config);if(showDatasetPicker){showDatasetPicker();}}},onAddDatasetError:function onAddDatasetError(){var dataService=this.dataService();dataService.submitUpdates({act:"undo",stid:dataService.stid,killJob:true},null,{style:{params:{treesToRender:3},name:"RWIVEMojoStyle"}});},onAddDatasetSuccess:function onAddDatasetSuccess(response){var configCache=this._datasetEditorConfig;var config=response.config,dsId=response.dsId;if(typeof config==="string"&&configCache&&configCache.id===config){configCache.config.onOk(dsId);this._datasetEditorConfig=null;}},createDataset:function createDataset(config){var controller=this,model=controller.model,datasetPanel=controller&&controller.datasetsPanel,configCache=this._datasetEditorConfig;if(typeof config==="string"&&configCache&&configCache.id===config){config=configCache.config;this._datasetEditorConfig=null;}if(mstrApp.isWorkstation){var formWrapper=window.FormWrapper;if(!formWrapper.hasAnyActiveEnvironment()){if(config&&config.onCancel){config.onCancel();}formWrapper.presentNoEnvironmentAlert(WS_ALERT_TYPE_EXISTING_OBJECT);return ;}if(!(mstrApp.supportFeature(FEATURES.SUPPORT_LIVEMODE)&&mstrApp.getWSLiveMode())){this.showSaveToEnvDialog("createDataset","onCreateDatasetFailed",config);return ;}}if(datasetPanel){datasetPanel.openDatasetEditor($HASH.copy(config,{title:mstrmojo.desc(15395,"Add Existing Objects"),okBtnText:mstrmojo.desc(4447,"Add"),docModel:model,replaceDataset:!!config&&!config.n}));}},onCreateDatasetFailed:function onCreateDatasetFailed(config){var configCache=this._datasetEditorConfig;if(typeof config==="string"&&configCache&&configCache.id===config){configCache.config.onCancel();this._datasetEditorConfig=null;}},importFile:function importFile(){var controller=this.model&&this.model.controller,model=this.model,dataService=controller&&controller.datasetsPanel,ds=[];$HASH.forEach(model.datasets,function(dataset){if(dataset.st===779&&model.hasPrivilegesForAllTables(dataset.tables)){ds.push(dataset);}});if(dataService&&dataService.showDataImport){dataService.showDataImport({isEdit:false,datasets:ds,AnalysisId:this.model.mid,needDefn:true});}},inputConnectionDetails:function inputConnectionDetails(existingConnection){var docController=this;if(existingConnection&&Object.keys(existingConnection).length>0){this.model.existingServerConnection=existingConnection;}else{existingConnection=this.model.existingServerConnection;}this.model.operation="inputConnectionDetails";var resumeDashboardExecution=function(){if(docController.model.operation==="inputConnectionDetails"){docController.model.operation="none";}mstrApp.serverRequest({taskId:"resumeDashboardExecution",checkCS:true},{success:function success(res){if(res&&res.statusOnly!==true){mstrApp.start(res);}}},{doNotHold:true});};var changeConnectionString=function(dataProvider){if(existingConnection&&dataProvider&&dataProvider.currentProject&&dataProvider.currentProject.project.id===existingConnection.datasets[0].connInfo.pid){mstrApp.serverRequest({taskId:"changeConnString",ws:dataProvider.currentProject.webServer.connection.id,isn:dataProvider.currentProject.iServer.name,isp:dataProvider.currentProject.iServer.port,pn:dataProvider.currentProject.project.name,pid:dataProvider.currentProject.project.id},{success:function success(){resumeDashboardExecution();},failure:function failure(){mstrmojo.error({shortDesc:mstrmojo.desc(14397,"Something went wrong when changing the connection string.")});}},{doNotHold:true});}else{if(existingConnection&&dataProvider&&dataProvider.currentProject.project.id!==existingConnection.datasets[0].connInfo.pid){mstrmojo.error({shortDesc:"We cannot find the dataset(s) in the logged in server. Please try a different server or edit the connection by going to preferences."});}else{}}};this.rootCtrl.loadDataProvider(changeConnectionString);},inputCredentials:function inputCredentials(documentModel){var controller=this.model&&this.model.controller,dataService=controller&&controller.datasetsPanel;if(dataService&&dataService.showDataImport){dataService.showDataImport({documentModel:documentModel,StatusCode:4,callback:function(){mstrApp.serverRequest({taskId:"resumeDashboardExecution"},{success:function success(res){if(res&&res.statusOnly!==true){mstrApp.start(res);}}},{doNotHold:true});}});}},saveBeforeClosing:function saveBeforeClosing(saveCB,target){var me=this,m=me.model,isNew=m&&m.isnew,isRWReadonly=m&&m.isRWReadonly,fnDirectRun=function(){if(saveCB&&saveCB.success){saveCB.success();}if(saveCB&&saveCB.complete){saveCB.complete();}};if(this.isDocChanged()&&mstrmojo.resolveFeature("save-analysis")){if(!m.copyable){mstrmojo.confirm('<div class="warning-dialog-subject">Do you want to close this dossier?</div><div class="warning-dialog-description">Because the data has been limited for your specific user, no changes will be saved after closing the dossier.</div>',{confirmBtn:{t:$DESC(2177,"Close"),fn:function(){fnDirectRun();}},cancelBtn:{t:$DESC(221,"Cancel")}},{allowHTML:true,cssClass:"copyable-warning-on-close-editor",help:"Security_Filter_Create.htm"});}else{var fnDestroy=function(){this.close();this.destroy();},cse=new mstrmojo.vi.ui.editors.ConfirmSaveEditor({onSave:function(){if(isNew||isRWReadonly){me.save(null,target);}else{me.dSave(saveCB);}fnDestroy.call(this);},onDonotSave:function(){fnDirectRun();fnDestroy.call(this);},onCancel:function(){fnDestroy.call(this);}});cse.open();}}else{fnDirectRun();}},openDEEditor:function openDEEditor(grid,params){var me=this,DE_EDITOR_ID="mstrmojo-derivedElements",editor=mstrmojo.all[DE_EDITOR_ID]||mstrmojo.insert({scriptClass:"mstrmojo.vi.ui.editors.DerivedElementsEditor",id:DE_EDITOR_ID}),deObj=params.deObj,deItemLists=deObj&&deObj.des,fromDS=params.fromDatasetPanel,attId=params.attId||(deObj&&deObj.attId),dId=(params&&params.dsId)||(deObj&&deObj.dsId),mId=me.model.mid,docModel=fromDS?grid.docModel:grid.model.docModel,objInfo=docModel.getObjectInfo(attId),deModel,elemId,SELECTED_LIST_TYPE=1,browseFormedElemsMap={},builder=new mstrmojo.XMLBuilder(),xmlBuild=function(builder){builder.addChild("exp").addChild("nd").addAttribute("et",E.ET.ANDOR).addAttribute("fn",E.FN.AND).addChild("nds").addChild("nd").addAttribute("et",E.ET.AE).addAttribute("fn",E.FN.IN_LIST).addChild("a").addAttribute("did",attId).closeElement().addChild("es");$FOREACHARRAY(deItemLists,function(deItemList){if(deItemList.t===SELECTED_LIST_TYPE){$FOREACHARRAY(deItemList.es,function(e){builder.addChild("e").addAttribute("v",e.v).addAttribute("n",e.n).closeElement();});}});builder.closeElement().closeElement().closeElement().closeElement().closeElement();},editorOpenCallBack=function(){if(params.elemId){elemId=params.elemId;delete params.elemId;}deModel=new mstrmojo.vi.models.DEConsolidation(params);deModel.xtab=fromDS?null:grid;deModel.docModel=docModel;deModel.controller=me;deModel.fromDS=fromDS;deModel.isRA=objInfo&&objInfo.t===TP_ATTRIBUTE&&objInfo.st===STP_RECURSIVE_ATTRIBUTE;editor.browseConfig={attributeID:attId,datasetID:dId,messageID:mId};editor.set("model",deModel);editor.open();if(elemId||!params.deObj){editor.editItem(elemId);}};if(!deItemLists||deItemLists.length===0||!deItemLists.some(function(deItemList){return deItemList.t===SELECTED_LIST_TYPE;})){editorOpenCallBack();return ;}me.ifDataHelper=new mstrmojo.mstr.ElementsDataHelper({browseConfig:{styleName:"MojoAttributeStyle",attributeID:attId,datasetID:dId,messageID:mId,useBrowseForm:1}});xmlBuild(builder);me.ifDataHelper.browseConfig.expressionXML=builder.toString();me.ifDataHelper.getItems(1,{success:function(res){$FOREACHARRAY(res.items,function(item){browseFormedElemsMap[item.v]=item.n;});$FOREACHARRAY(deItemLists,function(deItemList){if(deItemList.t===SELECTED_LIST_TYPE){$FOREACHARRAY(deItemList.es,function(e){e.n=browseFormedElemsMap[e.v]||e.n;});}});editorOpenCallBack(res);},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}},{});},onAddQuickDE:function onAddQuickDE(view,action){if(action.funcVal===$FN_TP.FunctionApplySimple){openCalculatedMemberEditor(this,view,action);}else{openRenameDEEditor(this,view,action,"addQuickDE");}},onEditQuickDEList:function editQuickDEList(view,action){var me=this;openRenameDEEditor(me,view,action,"editQuickDEList");},onEditQuickDECalculation:function onEditQuickDECalculation(view,action){var me=this;openRenameDEEditor(me,view,action,"editQuickDECalculation");},onSetDEHierachyOptions:function onToggleOthersDE(view,action){this.submitDEAction(view,action);},editQuickDECalculation:function editQuickDECalculation(view,action){this.submitDEAction(view,action);},editQuickDECalculationNumberFormat:function editQuickDECalculationNumberFormat(view,action){this.submitDEAction(view,action);},removeQuickDE:function removeQuickDE(view,action){this.submitDEAction(view,action);},submitDEAction:function submitDEAction(view,templateAction){this._addNodeKeyToAction(view,templateAction);var me=this,action=this.dataService().getUpdateTemplateAction(view.k,templateAction),model=this.model;model.addUpdateObjects(action,{id:templateAction.oId,type:47,flag:mstrmojo.DocDataService.PARTIAL_UPDATE_FLAGS.DATA_CHANGE});var deferredSubmitFunc=function(hookVFUnset){var _action=[action];return function(){if(hookVFUnset){_action=me.model.wrapUnsetVisualizationFilterAction(_action);}me.submitUndoRedoUpdates(_action,{},$FUNC.wrapMethods(model.getRebuildCallback(),model.getDatasetsUpdateCallback(),model.getUpdateHiddenLayoutsCallback()),$DDS.REQUEST_DEFN_DATA);};};model.checkAndNotifyVFChangeOnGroupUpdate({actions:action},deferredSubmitFunc(true),deferredSubmitFunc(false));},addDSFromDatabase:mstrmojo.emptyFn,addDSFromFreeform:mstrmojo.emptyFn,close:function close(){var closeFn=this._super.bind(this);mstrApp.onNavigateOut(null,closeFn);},openCubeBrowser:function openCubeBrowser(callback){mstrApp.rootCtrl.openCubeBrowser(callback);},browseObjectsOnServer:function(){var me=this.datasetsPanel;var controller=this;function callback(){if(mstrApp.browseAllObjects===false){mstrmojo.alert(mstrmojo.desc(14332,"You do not have the privileges to browse the objects in this project."));}else{me.set("allObjectBrowserOpened",true);}controller.model.operation="none";}this.model.operation="browseAllObjects";var dsPanel=mstrApp.rootCtrl.datasetsPanel;dsPanel.model.controller.rootCtrl.loadDataProvider(function(dataProvider){dsPanel.objectBrowser.set("dataProvider",dataProvider);callback();});},uploadImageToServer:function(params,callback){var dataService=this.dataService();dataService.uploadImageToServer(params,callback);},addNamedDataset:function addNamedDataset(dataset){var me=this,objectId=dataset.objectId,objectType=dataset.objectType,model=this.model,action;if(!dataset.objectId){return ;}action={act:"addDataset",did:objectId,t:objectType,g:$HASH.keyarray(me.datasetsPanel.data).length===1?1:0,disablePU:true};model.getDataService().submitUpdates(action,me.getRefreshCallback(),{style:{params:{treesToRender:1}}});},changeCoverPage:function(evt){var url=evt.url,originUrl=evt.originUrl,model=this.model,updateModelUrl=function(url){model.objInfo=$HASH.copy({icp:url},model.objInfo);},updateCoverPage=evt.callback,callback={success:function(){updateCoverPage(url);updateModelUrl(url);}};var action={act:"changeCoverPage",url:url};model.execute({execute:function execute(){this.submit(action,callback,mstrmojo.DocDataService.SUPPRESS_DATA);},urInfo:{undo:function(){updateCoverPage(originUrl);updateModelUrl(originUrl);},redo:function(){updateCoverPage(url);updateModelUrl(url);},extras:{params:{suppressData:true}}}});}});}());