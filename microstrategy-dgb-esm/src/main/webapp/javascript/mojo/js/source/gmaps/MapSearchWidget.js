(function(){mstrmojo.requiresCls("mstrmojo.Box","mstrmojo.Label","mstrmojo.ui.List","mstrmojo.ui.PopupConfig","mstrmojo.array","mstrmojo.css","mstrmojo.dom","mstrmojo.hash","mstrmojo.Popup","mstrmojo.VisUtility");var $A=mstrmojo.array,$C=mstrmojo.css,$DOM=mstrmojo.dom,$HASH=mstrmojo.hash,$VISUTIL=mstrmojo.VisUtility,PATTERN_MIN_LENGTH=2,SEARCHLIST_BOTTOM_PADDING=5,CANDIDATE_POPUP_THICK=40;function createSuggestion(suggestionBlocks,popup){var i,len,data,menuItems=[],titleCls;for(i=0,len=suggestionBlocks.length;i<len;i++){data=suggestionBlocks[i];titleCls=data.label?"displayMenuTitle"+(data.isCloud?" geo":""):"hideMenuTitle";menuItems.push({scriptClass:"mstrmojo.Box",cssClass:"suggestionBlock",children:[{scriptClass:"mstrmojo.Label",allowHTML:true,text:"<div>"+data.label+(data.isCloud?"":" ("+data.items.length+")")+"</div>",cssClass:"layerLabel "+titleCls},{scriptClass:"mstrmojo.ui.List",cssClass:"searchSuggestion "+(data.label?"sub":"top"),alias:"list",items:data.items,onchange:function(){if(!popup.opener){return ;}var q=popup.opener.suggestionSource;if(q&&q.onSuggestionItemSelected&&this.selectedItem){q.onSuggestionItemSelected(this.selectedItem);if(popup.opener&&popup.opener.search){popup.opener.search.inputNode.value=this.selectedItem.n;}popup.close();}}}]});}return{scriptClass:"mstrmojo.Box",alias:"suggestion",cssClass:"suggestionList",children:menuItems};}function totalItemCount(suggestionBlocks){var count=0;$A.forEach(suggestionBlocks,function(v){count+=v.items?v.items.length:0;});return count;}function getItemOfIndex(itemsBlock,itemsBlockProp,idx,itemFunc){var item,curIdx=idx,items;$A.forEach(itemsBlock,function(itemBlock){if(itemsBlockProp){items=itemBlock[itemsBlockProp]&&itemBlock[itemsBlockProp].items;}else{items=itemBlock.items;}if(!items){return true;}if(curIdx>=0&&curIdx<items.length){if(itemFunc){itemFunc.call(itemBlock,curIdx);}item=items[curIdx];return false;}else{curIdx-=items.length;}});return item;}function updateBlockScroll(blockNode,selectedNode){if(!blockNode||!selectedNode){return ;}var blockRect=blockNode.getBoundingClientRect(),itemRect=selectedNode.getBoundingClientRect(),offsetUp=itemRect.top-blockRect.top,offsetDown=itemRect.top+itemRect.height-blockRect.top-blockRect.height;if(offsetDown>0){blockNode.scrollTop+=offsetDown;}else{if(offsetUp<0){blockNode.scrollTop+=offsetUp;}}}function setSelectCSSOnItem(idx){var chds=this.suggestion.children,curIdx=idx,me=this;if(this.selectedNode){$C.removeClass(this.selectedNode,"selected");}getItemOfIndex(chds,"list",curIdx,function(idx){me.selectedNode=this.list._getItemNode(idx);$C.addClass(me.selectedNode,"selected");updateBlockScroll(this.list.domNode,me.selectedNode);updateBlockScroll(this.parent.domNode,this.domNode);});}mstrmojo.gmaps.MapSearchWidget=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasPopup],{scriptClass:"mstrmojo.gmaps.MapSearchWidget",markupString:'<div id="{@id}" class="mstrmojo-SearchWidget-WithSuggestion {@cssClass}"><div class="searchbox" mstrAttach:keydown></div><div class="suggestion"></div></div>',markupSlots:{searchNode:function(){return this.domNode.firstChild;},popupNode:function(){return this.domNode.lastChild;}},suggestionResults:null,popupOpenConfig:null,suggestionSource:null,displayResults:function(items){this.set("suggestionResults",items);this.adjustPopupSize(items);this.openPopup("popupRef",this.popupOpenConfig);this.updatePopupPosition();},clearResults:function(){this.set("suggestionResults",null);this.closePopup();},adjustPopupSize:function adjustPopupSize(suggestionItems){var map=this.parent&&this.parent.map;if(map){var maxWidth=Math.floor((2/3)*map.getWidth()),style=$C.getComputedStyle(this.domNode);$HASH.copy({cssText:"max-width: "+maxWidth+"px"},this.popupRef);if(style){var fs={fontFamily:style.fontFamily,fontSize:style.fontSize,fontStyle:style.fontStyle,fontWeight:style.fontWeight,fontVariant:style.fontVariant};$A.forEach(suggestionItems,function(suggestionItem){$A.forEach(suggestionItem.items,function(item){var text=item.n,textWidth=$VISUTIL.measureTextWidth(text,fs,1),totalWidth=textWidth+CANDIDATE_POPUP_THICK;if(totalWidth>maxWidth){$HASH.copy({title:item.n},item);}});});}}},updatePopupPosition:function updatePopupPosition(){var map=this.parent&&this.parent.map,target=this.domNode&&this.domNode.getElementsByClassName("suggestionList")[0],mapDom=map&&map.domNode,targetRect,mapRect;if(target&&mapDom){targetRect=target.getBoundingClientRect();mapRect=mapDom.getBoundingClientRect();target.style["max-height"]=(mapRect.height-(targetRect.top-mapRect.top)-SEARCHLIST_BOTTOM_PADDING)+"px";}},popupRef:{scriptClass:"mstrmojo.Popup",slot:"popupNode",autoCloses:false,autoClose:false,locksHover:true,closeOnClick:true,currentIdx:-1,onOpen:function onOpen(){var popupNode;this.destroyChildren();this.currentIdx=-1;this.addChildren(createSuggestion(this.opener.suggestionResults,this));this.refresh();setSelectCSSOnItem.call(this,0);},selectNext:function selectNext(){var sr=this.opener.suggestionResults,totalCount=totalItemCount(sr),currentIdx=this.currentIdx;currentIdx=++currentIdx%totalCount;setSelectCSSOnItem.call(this,currentIdx);this.currentIdx=currentIdx;return getItemOfIndex(sr,null,currentIdx).n;},selectPrevious:function selectPrevious(){var sr=this.opener.suggestionResults,totalCount=totalItemCount(sr),currentIdx=this.currentIdx;currentIdx=(totalCount+currentIdx-1)%totalCount;setSelectCSSOnItem.call(this,currentIdx);this.currentIdx=currentIdx;return getItemOfIndex(sr,null,currentIdx).n;}},onkeydown:function onkeydown(evt){var hWin=evt.hWin,e=evt.e||hWin.event,k=e.keyCode;if(k===38||k===40){this.search.quickSearch=false;$DOM.stopPropogation(hWin,e);}else{var popup=this.popupRef,chds=popup.suggestion&&popup.suggestion.children,curIdx=popup.currentIdx;if(k===13&&chds){curIdx=curIdx<0?0:curIdx;getItemOfIndex(chds,"list",curIdx,function(idx){this.list.select(idx);});this.closePopup();this.search.quickSearch=false;}else{this.search.quickSearch=true;}}},children:[{scriptClass:"mstrmojo.SearchWidget",alias:"search",slot:"searchNode",quickSearch:true,placeholderText:mstrmojo.desc(12666,"Search..."),showClearNode:false,onsearch:function onsearch(){var pattern=this.getSearchPattern(),p=this.parent,q=p.suggestionSource;if(this.quickSearch&&pattern.length>=PATTERN_MIN_LENGTH&&q&&q.getSearchSuggestions){q.getSearchSuggestions(pattern,function(items){if(items&&items.length>0){p.displayResults(items);}else{p.clearResults();}});}},onEnter:function onEnter(evt){this.onsearch(this.getSearchPattern());this.quickSearch=true;this.setClearIcon();},onArrowUp:function onKeyUp(){var popup=this.parent.popupRef,n;if(popup.visible){n=popup.selectPrevious();if(n){this.inputNode.value=n;this.quickSearch=true;this.setClearIcon();}}},onArrowDown:function onKeyDown(){var popup=this.parent.popupRef,n;if(popup.visible){n=popup.selectNext();if(n){this.inputNode.value=n;this.quickSearch=true;this.setClearIcon();}}},onclear:function onclear(){this.parent.clearResults();}}],isFocus:function isFocus(){var search=this.search;return !!search&&search.isFocus;},unrender:function unrender(ignoreDom){var pr=this.popupRef;if(this.popupToBody&&pr.hasRendered){pr.unrender(false);}if(this._super){this._super(ignoreDom);}},destroy:function destroy(ignoreDom){delete this.suggestionSource;this._super(ignoreDom);}});}());