(function(){mstrmojo.requiresCls("mstrmojo.dom","mstrmojo.hash","mstrmojo.array","mstrmojo.VisUtility","mstrmojo.gmaps.MapUtils","mstrmojo.gmaps.MapEnums");var $MOJO=mstrmojo,$ARR=$MOJO.array,$DOM=$MOJO.dom,$HASH=$MOJO.hash,$VU=$MOJO.VisUtility,$GMAPS=$MOJO.gmaps,$MUTIL=$GMAPS.MapUtils,$EnumBaseMapType=$GMAPS.EnumBaseMapType;var EVENT_SENSITIVITY=2;var PINCHSTART="pinchstart",PINCHEND="pinchend",INIT_SCALE=1,SCALE_SENSITIVITY=0.5;function isValidClick(evt,startPos){if(evt&&startPos&&$MUTIL.checkVal(evt.clientX)&&$MUTIL.checkVal(evt.clientY)&&$MUTIL.checkVal(startPos.x)&&$MUTIL.checkVal(startPos.y)){return Math.abs(evt.clientX-startPos.x)<=EVENT_SENSITIVITY&&Math.abs(evt.clientY-startPos.y)<=EVENT_SENSITIVITY;}}function getPositionFromHammerEvt(evt){var center=evt&&evt.center,clientRect=$MUTIL.getBoundingRect(this.graphicLayerDiv);if(center&&clientRect){return{x:center.x-clientRect.left,y:center.y-clientRect.top};}}function selectGraphics(graphics,fn){$ARR.forEach(graphics,function(graphic){var allSubGraphics=graphic.getGraphicsForSelection();$ARR.forEach(allSubGraphics,function(subGraphic){var geometry=subGraphic.geometry;if(geometry){fn.call(geometry,subGraphic.isSelected());}});});}mstrmojo.gmaps._CustomMapInteractivity=mstrmojo.provide("mstrmojo.gmaps._CustomMapInteractivity",{_mixinName:"mstrmojo.gmaps._CustomMapInteractivity",dragStartPos:null,mouseDownPos:null,isMouseMove:null,isMouseDown:null,cssTransform:null,prevGraphicsHovered:null,_hammer:null,addEventListeners:function addEventListeners(){var node_=this.graphicLayerDiv;if(!node_){return ;}$DOM.attachEvent(node_,"mousedown",this.handleMouseDownEvt.bind(this));$DOM.attachEvent(node_,"mouseup",this.handleMouseUpEvt.bind(this));$DOM.attachEvent(node_,"mousemove",this.handleMouseMoveEvt.bind(this));$DOM.attachEvent(node_,"mouseleave",this.handleMouseLeaveEvt.bind(this));$DOM.attachEvent(node_,"dblclick",this.handleDoubleClickEvt.bind(this));$DOM.attachEvent(node_,"contextmenu",this.handleContextMenuEvt.bind(this));$VU.addWheelListener(node_,this.handleMouseWheelEvt.bind(this));if($DOM.supportsTouches){this.addTouchEventListeners(node_);}},removeEventListeners:function removeEventListeners(){var node_=this.graphicLayerDiv;if(!node_){return ;}$DOM.detachEvent(node_,"mousedown",this.handleMouseDownEvt);$DOM.detachEvent(node_,"mouseup",this.handleMouseUpEvt);$DOM.detachEvent(node_,"mousemove",this.handleMouseMoveEvt);$DOM.detachEvent(node_,"mouseleave",this.handleMouseLeaveEvt);$DOM.detachEvent(node_,"dblclick",this.handleDoubleClickEvt);$DOM.detachEvent(node_,"contextmenu",this.handleContextMenuEvt);if($DOM.supportsTouches){this.removeTouchEventListeners(node_);}},addTouchEventListeners:function addTouchEventListeners(node_){var _hammer=this._hammer=new Hammer.Manager(node_),doubletap=new Hammer.Tap({event:"doubletap",taps:2}),pinch=new Hammer.Pinch({threshold:0});_hammer.add([doubletap,pinch]);_hammer.on("doubletap",this.handleDoubleTapEvt.bind(this));_hammer.on(PINCHSTART+" "+PINCHEND,this.handlePinchEvt.bind(this));$DOM.attachEvent(node_,"touchstart",this.handleMouseDownEvt.bind(this));$DOM.attachEvent(node_,"touchend",this.handleMouseUpEvt.bind(this));$DOM.attachEvent(node_,"touchmove",this.handleMouseMoveEvt.bind(this));},removeTouchEventListeners:function removeTouchEventListeners(node_){var _hammer=this._hammer;if(_hammer){_hammer.off("doubletap",this.handleDoubleTapEvt);_hammer.off(PINCHSTART+" "+PINCHEND,this.handlePinchEvt);}$DOM.detachEvent(node_,"touchstart",this.handleMouseDownEvt.bind(this));$DOM.detachEvent(node_,"touchend",this.handleMouseUpEvt.bind(this));$DOM.detachEvent(node_,"touchmove",this.handleMouseMoveEvt.bind(this));},handleMouseDownEvt:function handleMouseDownEvt(evt){if($MUTIL.checkHasFunction(evt,"preventDefault")){evt.preventDefault();}evt=$MUTIL.getEvent(evt);if(this.mouseDownPos||this.enablePopup!==true||!evt||!$MUTIL.checkVal(evt.clientX)||!$MUTIL.checkVal(evt.clientY)){return ;}this.mouseDownPos={x:evt.clientX,y:evt.clientY};if(!$MUTIL.isRMClick(evt)){this.isMouseDown=true;}},handleMouseUpEvt:function handleMouseUpEvt(evt){evt=$MUTIL.getEvent(evt);var mouseDownPos=this.mouseDownPos,isRMC=$MUTIL.isRMClick(evt);if(this.isMouseMove){this._panEnd();}if(mouseDownPos&&isValidClick(evt,mouseDownPos)&&!isRMC){this.handleMouseClickEvt(evt,this.getGraphicsFromPoint(evt));this.highlightAllLayers();}this.stopMouseEvents();},stopMouseEvents:function stopMouseEvents(){this.dragStartPos=null;this.mouseDownPos=null;this.isMouseDown=false;this.isMouseMove=false;},handleMouseMoveEvt:function handleMouseMoveEvt(evt){if(this.enablePopup!==true||!evt){return ;}if($MUTIL.checkHasFunction(evt,"preventDefault")){evt.preventDefault();}var touches=evt.touches,multiTouch=touches&&touches.length>1,singleTouch=touches&&touches.length===1;evt=$MUTIL.getEvent(evt);if(this.isMouseDown===true||singleTouch){if(!multiTouch){var dragStartPos=this.dragStartPos,curPos={x:evt.clientX,y:evt.clientY};if(dragStartPos&&!isValidClick(evt,dragStartPos)){this.panHandler({x:curPos.x-dragStartPos.x,y:curPos.y-dragStartPos.y},dragStartPos,curPos);}this.isMouseMove=true;this.dragStartPos=curPos;}}else{this.handleGraphicsHover(evt);}},handleMouseLeaveEvt:function handleMouseLeaveEvt(evt){if(this.isMouseDown===true){this.handleMouseUpEvt();}this.hideTooltip(true);this.handleGraphicsHover(evt);},handleDoubleClickEvt:function handleDoubleClickEvt(evt){if(this.enablePopup!==true){return ;}var baseLayer=this.baseLayer;if(baseLayer){baseLayer.handleMouseWheel({position:$MUTIL.getEvtCoordInsideNode(evt,this.graphicLayerDiv),zoomDelta:1});}},handleMouseWheelEvt:function handleMouseWheelEvt(evt){if(this.enablePopup!==true||!evt){return ;}var baseLayer=this.baseLayer,zoomDelta=evt.deltaY>0?-1:1;if(baseLayer){baseLayer.handleMouseWheel({position:$MUTIL.getEvtCoordInsideNode(evt.originalEvent,this.graphicLayerDiv),zoomDelta:zoomDelta});}evt.preventDefault();},handleDoubleTapEvt:function handleDoubleTapEvt(evt){var baseLayer=this.baseLayer;if(this.enablePopup!==true||!baseLayer){return ;}baseLayer.handleMouseWheel({position:getPositionFromHammerEvt.call(this,evt),zoomDelta:1});},handlePinchEvt:function handlePinchEvt(evt){if(this.enablePopup!==true||!evt){return ;}switch(evt.type){case PINCHSTART:this._handlePinchStartEvt(evt);break;case PINCHEND:this._handlePinchEndEvt(evt);break;}},_handlePinchStartEvt:function _handlePinchStartEvt(evt){this._pinchCenter=getPositionFromHammerEvt.call(this,evt);this.stopMouseEvents();},_handlePinchEndEvt:function _handlePinchEndEvt(evt){var baseLayer=this.baseLayer,scale=evt.scale,zoomDelta=parseInt((scale-INIT_SCALE)/SCALE_SENSITIVITY);if(baseLayer){baseLayer.handleMouseWheel({position:this._pinchCenter,zoomDelta:zoomDelta});}delete this._pinchCenter;},panHandler:function panHandler(offset,startPos,endPos){var baseLayer=this.baseLayer;if(!baseLayer){return ;}this.updateCssTransform(offset);baseLayer.panBy(offset,startPos,endPos);this.panAllGraphicLayers();this.hideTooltip();},_panEnd:function _panEnd(){switch(this.getBaseMapType()){case $EnumBaseMapType.Esri:this.updateCoordForAllGraphicLayers();break;case $EnumBaseMapType.Google:setTimeout(this.updateCoordForAllGraphicLayers.bind(this),20);break;}this._cachePreCssTransform();},panAllGraphicLayers:function panAllGraphicLayers(){var cssTransform=this.cssTransform;this.forEachGraphicLayer(function(graphicLayer){if(graphicLayer){graphicLayer.panBy(cssTransform);}},null,true);},_cachePreCssTransform:function _cachePreCssTransform(){var cssTransform=this.cssTransform;this.forEachGraphicLayer(function(graphicLayer){graphicLayer.preCssTransform=$HASH.clone(cssTransform);},null,true);},updateCssTransform:function updateCssTransform(offset){var cssTransform=this.cssTransform=this.cssTransform||{},x,y;if(!!offset&&$MUTIL.checkVal(offset.x)&&$MUTIL.checkVal(offset.y)){x=(!$MUTIL.checkVal(cssTransform.x))?0:cssTransform.x;y=(!$MUTIL.checkVal(cssTransform.y))?0:cssTransform.y;this.cssTransform={x:x+offset.x,y:y+offset.y};}},resetCssTransform:function resetCssTransform(){this.cssTransform=null;this.forEachGraphicLayer(function(graphicLayer){graphicLayer.resetCssTransform();},null,true);},handleGraphicsHover:function handleGraphicsHover(evt){var graphics=[],targetGraphicLayer;this.forEachGraphicLayer(function(graphicLayer){graphics=graphicLayer.getGraphicsFromPoint(evt);if(graphics&&graphics.length>0){targetGraphicLayer=graphicLayer;return false;}},true);this.setGraphicsHovered(graphics);this.setTooltip(targetGraphicLayer,graphics,{x:evt.clientX,y:evt.clientY});},setGraphicsHovered:function setGraphicsHovered(graphics){var prevGraphicsHovered=this.prevGraphicsHovered;if(!$ARR.isArray(graphics)||(graphics.length<1&&$ARR.isArray(prevGraphicsHovered)&&prevGraphicsHovered.length<1)){return ;}$ARR.forEach(prevGraphicsHovered,function(graphic){if(graphic&&$ARR.indexOf(graphics,graphic)===-1){graphic.setHover(false);}});$ARR.forEach(graphics,function(graphic){if(graphic&&$ARR.indexOf(prevGraphicsHovered,graphic)===-1){graphic.setHover(true);}});this.prevGraphicsHovered=graphics;},getGraphicsFromPoint:function getGraphicsFromPoint(evt){var graphics;this.forEachGraphicLayer(function(graphicLayer){graphics=graphicLayer&&graphicLayer.getGraphicsFromPoint(evt);if(graphics&&graphics.length>0){return false;}},true);return graphics;},setTooltip:function setTooltip(graphicLayer,graphics,pos){if(graphicLayer){this.showTooltip(graphicLayer,graphics,pos);}else{this.hideTooltip(true);}},showTooltip:function showTooltip(graphicLayer,graphics,pos){if(graphicLayer){graphicLayer.showTooltip(graphics,pos);}},highlightAllLayers:function highlightAllLayers(){var isThereAnyHighlight=false,mapViewer=this;if(mapViewer){mapViewer.forEachGraphicLayer(function(graphicLayer){if(graphicLayer&&((graphicLayer.selectedGraphics&&graphicLayer.selectedGraphics.length>0)||(graphicLayer.contextMenuSelection&&graphicLayer.contextMenuSelection.length>0))){isThereAnyHighlight=true;}});if(isThereAnyHighlight){mapViewer.forEachGraphicLayer(function(graphicLayer){if(graphicLayer){selectGraphics(graphicLayer.graphics,function(){if($MUTIL.checkHasFunction(this,"setUnSelection")){this.setUnSelection();}});selectGraphics(graphicLayer.selectedGraphics,function(){if($MUTIL.checkHasFunction(this,"setSelection")){this.setSelection(true);}});selectGraphics(graphicLayer.contextMenuSelection,function(isSelected){if($MUTIL.checkHasFunction(this,"setContextMenuSelection")){this.setContextMenuSelection(isSelected,true);}});}});}else{mapViewer.forEachGraphicLayer(function(graphicLayer){if(graphicLayer){selectGraphics(graphicLayer.graphics,function(){if($MUTIL.checkHasFunction(this,"setSelection")){this.setSelection(false);}});}});}}}});}());