(function(){mstrmojo.requiresCls("mstrmojo.qb.MissingColumnWarning","mstrmojo.css","mstrmojo.ui.Checkbox","mstrmojo.Editor","mstrmojo.ui.List","mstrmojo.Image","mstrmojo.DI.DIHelpers","mstrmojo.DI.DIConstants");mstrmojo.requiresDescs(122,212,218,219,221,1761,3415,3610,6724,8708,9161,11581,12598,12609,12771,13164,13447,11581,14058,14059,15209,15213,15214,15215,15216,15217,15218,15219,15220,15221,15222,15223,15224,15225,15226);var $A=mstrmojo.array,$CSS=mstrmojo.css,$DOM=mstrmojo.dom,$DIHelpers=mstrmojo.DI.DIHelpers,constants=mstrmojo.DI.DIConstants;var $DESC_WARNING_100=mstrmojo.desc(15213,"Missing columns were detected in new data."),$DESC_WARNING_010=mstrmojo.desc(15214,"Mismatched datatypes were detected between new data and current data."),$DESC_WARNING_110=mstrmojo.desc(15215,"Missing columns were detected in new data, and mismatched datatypes were detected between new data and current data."),$DESC_WARNING_011=mstrmojo.desc(15216,"Refreshing dataset failed."),$DESC_MSG_MISSING_COLUMNS=mstrmojo.desc(15217,"The above columns are missing in new data. The dataset schema or model will be updated when refresh the dataset with new data."),$DESC_MSG_MISMATCH_DATATYPES=mstrmojo.desc(15218,'When refreshing dataset, if you choose the refresh policy as "Replace Existing Data", the current datatype will be replaced with new one. If you choose another refresh policies, the current datatype will be converted to the new one.'),$DESC_MSG_MISSING_TABLES=mstrmojo.desc(15219,"###: Table missing. You could choose to edit dataset if your goal is to replace a table with another one completely."),$DESC_INSTRUCTION_OK_CANCEL=mstrmojo.desc(15220,"Refresh a dataset with ### may cause errors in Dossiers that use them. Do you want to continue? See more details below."),$DESC_INSTRUCTION_CANCEL=mstrmojo.desc(15221,"Refresh a dataset with ### may cause errors in the Dossiers that use them, and refreshing dataset failed because incorrect data was uploaded. See more details below."),$DESC_INSTRUCTION_MISSING_TABLES=mstrmojo.desc(15222,"Refreshing dataset failed because incorrect data was uploaded. See more details below."),$DESC_MISMATCH_DATATYPE_COMMENT=mstrmojo.desc(15223,"### (Dataset Datatype: ***)");function warningConfig(){return{"100":$DESC_WARNING_100,"010":$DESC_WARNING_010,"001":$DESC_WARNING_011,"110":$DESC_WARNING_110,"011":$DESC_WARNING_011,"101":$DESC_WARNING_011,"111":$DESC_WARNING_011};}function descMsgConfig(){return{column:$DESC_MSG_MISSING_COLUMNS,datatype:$DESC_MSG_MISMATCH_DATATYPES,table:$DESC_MSG_MISSING_TABLES};}mstrmojo.DI.ui.dialogs.DIMissingColumnsList=mstrmojo.declare(mstrmojo.ui.List,null,{scriptClass:"mstrmojo.DI.ui.dialogs.DIMissingColumnsList",getItemMarkup:function getItemMarkup(){var markup='<div class="MissingColumnList-item {@cls} cf"><div class="MissingColumnList-item-icon tp{@tp}"></div><div class="MissingColumnList-item-text" itemtooltipn="{@n}">{@n}</div><div class="MissingColumnList-item-text2" itemtooltipname="{@name}">{@name}</div><div class="MissingColumnList-item-text3" itemtooltipcomment="{@comment}">{@comment}</div></div>';return markup;},useRichTooltip:true,showTooltip:function showTooltip(e,win){var me=this,tn=$DOM.findAncestorByAttr($DOM.eventTarget(win,e),"itemtooltipn",true,this.domNode),tname=$DOM.findAncestorByAttr($DOM.eventTarget(win,e),"itemtooltipname",true,this.domNode),tcomment=$DOM.findAncestorByAttr($DOM.eventTarget(win,e),"itemtooltipcomment",true,this.domNode),t=tn?tn:(tname?tname:tcomment),content=t&&mstrmojo.string.encodeHtmlString(t.value);if(!me.hasOpenTooltip&&content){var position=$DOM.position(t.node),tCssCls="vi-regular vi-tooltip-V missing-cloumns-tooltip",tLeft=Math.max(position.x,0),tPosType=mstrmojo.tooltip.POS_BOTTOMLEFT;if(tname){tCssCls+=" V-center";tLeft=Math.max(position.x+position.w/2,0);tPosType=mstrmojo.tooltip.POS_BOTTOMCENTER;}else{if(tcomment){tCssCls+=" right-column";}}me.richTooltip={cssClass:tCssCls,content:content,top:Math.max(position.y,0),left:tLeft,posType:tPosType,enableHover:true};this._super(e,win);}},getItemProps:function getItemProps(item,idx){var model=mstrApp.getRootController().getModel(),props=this._super(item,idx),source=model.getImportSource(item.tableId);props.tp=item.tp||"";if(item.tableName){props.name=mstrmojo.string.encodeHtmlString(item.tableName);}else{if(source&&source.sourceInfo){props.name=mstrmojo.string.encodeHtmlString(source.sourceInfo.name);}else{props.name="";}}if(item.isHeader){props.name=mstrmojo.string.encodeHtmlString(item.name);props.addCls("header");}props.comment=item.comment||"";return props;}});function refreshErrStyle(dialog){$CSS.addClass(dialog.warningTitle.domNode,"warningContent");$CSS.addClass(dialog.warningLabel.domNode,"warningContent");$CSS.addClass(dialog.collapseButton.domNode,"left-float");$CSS.addClass(dialog.domNode,"resize");dialog.set("title",mstrmojo.desc(15209,"Refresh Dataset"));dialog.btnHbox.okButton.set("text",mstrmojo.desc(212,"Continue"));$CSS.removeClass(dialog.btnHbox.okButton.domNode,"hot");}mstrmojo.DI.ui.dialogs.DIMissingColumnsDialog=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.DI.ui.dialogs.DIMissingColumnsDialog",cssClass:"mstrmojo-MissingColumnWarning",warning:mstrmojo.desc(12598,"The following previously uploaded columns are missing"),details:mstrmojo.desc(13164,"If you publish without these columns, existing reports, documents and analyses based on this cube might be affected. Tables with all missing columns will not be republished. Do you still want to continue?"),showDetails:false,useRichTooltip:false,children:[{scriptClass:"mstrmojo.Image",cssClass:"cf mstrmojo-MissingColumnWarning-image",alias:"errorIcon"},{scriptClass:"mstrmojo.Label",cssClass:"cf mstrmojo-MissingColumnWarning-title warning-title",alias:"warningTitle"},{scriptClass:"mstrmojo.Label",cssClass:"cf mstrmojo-MissingColumnWarning-title",alias:"warningLabel"},{scriptClass:"mstrmojo.ui.Checkbox",cssClass:"mstrmojo-details-toggle",alias:"detailsToggler",oncheckedChange:function(){this.parent.set("showDetails",this.checked);}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-MissingColumnWarning-collapsed",alias:"collapseButton",text:mstrmojo.desc(14058,"Show Details"),onclick:function(){this.parent.set("showDetails",!this.parent.showDetails);}},{scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-MissingColumnWarning-collapsedBox",alias:"colllapsedBox",visible:false,children:[{scriptClass:"mstrmojo.DI.ui.dialogs.DIMissingColumnsList",cssClass:"mstrmojo-MissingColumnWarning-list",alias:"list"},{scriptClass:"mstrmojo.Box",alias:"detailMsgBox"}]}],buttons:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton hot",text:mstrmojo.desc(8708,"OK"),alias:"okButton",onclick:function(){var editor=this.parent.parent,ret=true;if(editor.onOK){ret=editor.onOK();}if(ret){editor.close();}}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton",text:mstrmojo.desc(221,"Cancel"),alias:"cancelButton",onclick:function(){var editor=this.parent.parent,ret=true;if(editor.onCancel){ret=editor.onCancel();}if(ret){editor.close();}}}],onshowDetailsChange:function(){this.colllapsedBox.set("visible",this.showDetails);this.positionDialog();this.collapseButton.set("text",this.showDetails?mstrmojo.desc(14059,"Hide Details"):mstrmojo.desc(14058,"Show Details"));this.detailsToggler.set("checked",this.showDetails);},onOpen:function(){var items=[{isHeader:true,n:mstrmojo.desc(122,"Columns"),name:mstrmojo.desc(1761,"Tables"),comment:mstrmojo.desc(6724,"Comment")}];var model=mstrApp.getRootController().getModel(),results=this.results,detailMsg=[],detailMsgChildren=[],warningIdx=["0","0","0"],warning,instruction,missingTables=[],missingColumnsTables=[],mismatchDataTypeTables=[],okBtn=this.btnHbox.okButton,cancelBtn=this.btnHbox.cancelButton;this.set("title",mstrApp.isCloudPro?mstrmojo.desc(9161,"Oops!"):mstrmojo.desc(3610));this.set("showDetails",false);if(!results){return ;}okBtn.set("visible",true);cancelBtn.set("visible",true);cancelBtn.set("text",mstrmojo.desc(221,"Cancel"));$CSS.removeClass(cancelBtn.domNode,"hot");this.colllapsedBox.list.set("visible",false);$CSS.removeClass(this.colllapsedBox.detailMsgBox.domNode,"margin-left-90");if(results.hasError){detailMsg.push("<ul>");warning=mstrmojo.desc(14302,"We encountered some errors while republishing the cube.");var msg=[];$A.forEach(results.errorTableTbids,function(tbid){var source=model.getImportSource(tbid),name=source&&source.sourceInfo&&mstrmojo.string.htmlAngles(source.sourceInfo.name),message=(results.errorTableErrMsg&&results.errorTableErrMsg[tbid])?results.errorTableErrMsg[tbid]:$DIHelpers.getBackendErrorStr(results.errorTableErrCode[tbid],source.type);detailMsg.push("<li>");detailMsg.push(name+"<br>"+message);msg.push(name+": "+message);detailMsg.push("</li>");});detailMsg.push("</ul>");this.warningTitle.set("text",$DESC_WARNING_011);this.warningLabel.set("text","");$CSS.addClass(this.colllapsedBox.detailMsgBox.domNode,"margin-left-90");refreshErrStyle(this);if(results.errorTableTbids.length){detailMsgChildren.push(new mstrmojo.Label({allowHTML:true,cssClass:"mstrmojo-MissingColumnWarning-detailMsg",text:msg.join("<br>")}));if(detailMsgChildren.length>0){this.colllapsedBox.detailMsgBox.removeChildren();this.colllapsedBox.detailMsgBox.addChildren(detailMsgChildren);this.colllapsedBox.detailMsgBox.set("visible",true);}this.colllapsedBox.set("visible",false);}cancelBtn.set("text",mstrmojo.desc(8708,"OK"));$CSS.addClass(cancelBtn.domNode,"hot");okBtn.set("visible",false);var me=this;window.setTimeout(function(){me.positionDialog();});return ;}$A.forEach(results.missingTableTbids,function(tbid){var source=model.getImportSource(tbid),name=source&&source.sourceInfo&&source.sourceInfo.name;missingTables.push(name);});$A.forEach(results.missingColumnTbids,function(tbid){var source=model.getImportSource(tbid),name=source&&source.sourceInfo&&source.sourceInfo.name,cols=results.missingColumns[tbid];missingColumnsTables.push(name);$A.forEach(cols,function(col){items.push({n:mstrmojo.string.encodeHtmlString(col.n),tableId:tbid,comment:mstrmojo.desc(13447,"Missing Columns")});});});var mismatchDatatype=$DESC_MISMATCH_DATATYPE_COMMENT;$A.forEach(results.mismatchedDatatypeTbids,function(tbid){var source=model.getImportSource(tbid),name=source&&source.sourceInfo&&source.sourceInfo.name,cols=results.mismatchedDatatypeColumns[tbid];mismatchDataTypeTables.push(name);$A.forEach(cols,function(col){items.push({n:mstrmojo.string.encodeHtmlString(col.n),tableId:tbid,comment:mismatchDatatype.replace("###",$DIHelpers.getDataTypeString(col.src.ddt)).replace("***",$DIHelpers.getDataTypeString(col.ddt))});});});if(missingColumnsTables.length>0){warningIdx[0]="1";detailMsg.push(descMsgConfig().column);instruction=$DESC_INSTRUCTION_OK_CANCEL.replace("###",mstrmojo.desc(15224,"missing columns"));}if(mismatchDataTypeTables.length>0){warningIdx[1]="1";detailMsg.push(descMsgConfig().datatype);instruction=$DESC_INSTRUCTION_OK_CANCEL.replace("###",mstrmojo.desc(15225,"mismatched datatypes"));if(missingColumnsTables.length>0){instruction=$DESC_INSTRUCTION_OK_CANCEL.replace("###",mstrmojo.desc(15226,"missing columns and mismatched datatypes"));}}if(missingTables.length>0){warningIdx[2]="1";detailMsg.push(descMsgConfig().table.replace("###",missingTables.join(", ")));if(missingColumnsTables.length>0||mismatchDataTypeTables.length>0){if(missingColumnsTables.length>0&&mismatchDataTypeTables.length===0){instruction=$DESC_INSTRUCTION_CANCEL.replace("###",mstrmojo.desc(15224,"missing columns"));}else{if(missingColumnsTables.length===0&&mismatchDataTypeTables.length>0){instruction=$DESC_INSTRUCTION_CANCEL.replace("###",mstrmojo.desc(15225,"mismatched datatypes"));}else{instruction=$DESC_INSTRUCTION_CANCEL.replace("###",mstrmojo.desc(15226,"missing columns and mismatched datatypes"));}}}else{instruction=$DESC_INSTRUCTION_MISSING_TABLES;}okBtn.set("visible",false);cancelBtn.set("text",mstrmojo.desc(8708,"OK"));$CSS.addClass(cancelBtn.domNode,"hot");}var warningIdxStr=warningIdx.join("");warning=warningConfig()[warningIdxStr];refreshErrStyle(this);this.warningTitle.set("text",warning);this.warningLabel.set("text",instruction);this.detailsToggler.set("checked",false);if(items.length>1){this.colllapsedBox.list.set("items",items);this.colllapsedBox.list.set("visible",true);}else{this.colllapsedBox.list.set("items",null);this.colllapsedBox.list.set("visible",false);}$A.forEach(detailMsg,function(msg){detailMsgChildren.push(new mstrmojo.Label({cssClass:"mstrmojo-MissingColumnWarning-detailMsg",text:msg}));});if(detailMsgChildren.length>0){this.colllapsedBox.detailMsgBox.removeChildren();this.colllapsedBox.detailMsgBox.addChildren(detailMsgChildren);}this.colllapsedBox.set("visible",false);var me=this;window.setTimeout(function(){me.positionDialog();});},onOK:function(){var controller=mstrApp.getRootController();controller.handleRepublishError(this.results);return true;},onCancel:function(){mstrApp.getRootController().cancelRepublishError(this.results);return true;}});}());