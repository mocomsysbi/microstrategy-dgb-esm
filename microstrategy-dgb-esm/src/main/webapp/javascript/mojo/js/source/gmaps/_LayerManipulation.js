(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.func","mstrmojo.vi.viz.MapHelper","mstrmojo.gmaps.MapEnums","mstrmojo.gmaps.MapUtils");var $VIZ=mstrmojo.vi.viz,$ARR=mstrmojo.array,$FUNC=mstrmojo.func,$MH=$VIZ.MapHelper,$GMAPS=mstrmojo.gmaps,$UTIL=$GMAPS.MapUtils,$EnumPropertyType=$GMAPS.EnumPropertyType;mstrmojo.gmaps._LayerManipulation=mstrmojo.provide("mstrmojo.gmaps._LayerManipulation",{_mixinName:"mstrmojo.gmaps._LayerManipulation",_isUndo:null,addMapLayer:function addMapLayer(){this.submitMapUpdates(this.getUpdatesInfoForAddLayer(),false);},removeMapLayers:function removeMapLayers(layerKeyArr){var layerIdxMappingArr=this.layerIdxMappingArr;if(!$ARR.isArray(layerKeyArr)||!$ARR.isArray(layerIdxMappingArr)){return ;}if(layerKeyArr.length<layerIdxMappingArr.length){this.submitMapUpdates(this.getUpdatesInfoForRemoveMultiLayers(layerKeyArr),true);}else{this.reset();}},getResetMapUpdatesInfo:function getResetMapUpdatesInfo(){var removeUpdateInfo=this.getUpdatesInfoForRemoveAllLayers(),updatesInfo;this.layerCount=0;updatesInfo=this.wrapUpdatesInfo(this.getUpdatesInfoForAddLayer(),removeUpdateInfo)||{};updatesInfo.treesToRender=3;return updatesInfo;},getUpdatesInfoForRemoveAllLayers:function getUpdatesInfoForRemoveAllLayers(){return this.getUpdatesInfoForRemoveMultiLayers(this.layerIdxMappingArr);},getUpdatesInfoForRemoveMultiLayers:function getUpdatesInfoForRemoveMultiLayers(layerKeyArr){var updatesInfo={},layerKeys=$ARR.isArray(layerKeyArr)&&layerKeyArr.slice();$ARR.forEach(layerKeys,function(layerKey){updatesInfo=this.wrapUpdatesInfo(this.getUpdatesInfoForRemoveLayer(layerKey),updatesInfo);},this);return updatesInfo;},getUpdatesInfoForAddLayer:function getUpdatesInfoForAddLayer(extraActions){var actions=$ARR.isArray(extraActions)?extraActions:[],hostId=this.id,docModel=this.getDocModel(),defaultVP=this.createDefaultVp(),prevEditingIdx=this.getEditingLayerIdx(),postEditingIdx=defaultVP[$EnumPropertyType.layerIdx],addLayerParams,urInfo,newKey;this.updateEditingLayerIdx(postEditingIdx);newKey=docModel.addMapLayerActions(this,actions,$MH.getXmlFromJson(defaultVP),defaultVP[$EnumPropertyType.layerName]);addLayerParams={layerKey:newKey,editingIdx:postEditingIdx};this.syncLayerProperties(defaultVP,addLayerParams);urInfo=this._getUndoRedoInfoForAddLayer(newKey,prevEditingIdx,addLayerParams);return{actions:actions,requestCallback:{success:function(res){var host=mstrmojo.all[hostId];docModel.updateDefnCache(res.defn,[newKey]);docModel.updateDataCache(res.data,docModel.getTargetDefn(newKey));host.addLayerCallback(addLayerParams,res);host.layerCount++;}},urInfo:urInfo,treesToRender:3};},getUpdatesInfoForRemoveLayer:function getUpdatesInfoForRemoveLayer(layerKey){var actions=[],docModel=this.getDocModel(),clearVisAsFilterActions=docModel&&docModel.clearVisAsFilterActionForMapLayer(this.parent,this.fnGetWidget(layerKey),true),zonesModel=this.zonesModel,urInfo,clearUnitsActions;if(clearVisAsFilterActions&&clearVisAsFilterActions.actions){actions=actions.concat(clearVisAsFilterActions.actions);}urInfo=this._getUndoRedoInfoForRemoveLayer(layerKey,clearVisAsFilterActions);urInfo.redo();if(this.isPrimaryKey(layerKey)){if(zonesModel){clearUnitsActions=zonesModel.getClearAllUnitsActions(layerKey);actions.push(zonesModel.getUpdateTemplateAction(clearUnitsActions,layerKey));}}else{docModel.removeMapLayerActions(this,layerKey,actions);}return{actions:actions,urInfo:urInfo};},_getUndoRedoInfoForAddLayer:function _getUndoRedoInfoForAddLayer(newKey,prevEditingIdx,addLayerParams){var hostId=this.id,docModel=this.getDocModel();if(!docModel){return{};}return{undo:function(){var layerDefn=docModel.getLayoutUnitDefn(newKey),host=mstrmojo.all[hostId];layerDefn._isDeleted=true;host.removeLayerCallback(newKey,prevEditingIdx);host._isUndo=true;return true;},redo:function(){var layerDefn=docModel.getLayoutUnitDefn(newKey),host=mstrmojo.all[hostId];delete layerDefn._isDeleted;host._isUndo=false;return false;},callback:{success:function(res){var host=mstrmojo.all[hostId];if(!host._isUndo){host.addLayerCallback(addLayerParams,res);}}},treesToRender:2};},_getUndoRedoInfoForRemoveLayer:function _getUndoRedoInfoForRemoveLayer(layerKey,otherActions){var hostId=this.id,docModel=this.getDocModel(),isPrimaryKey=this.isPrimaryKey(layerKey);if(!docModel){return{};}return{undo:function(){var host=mstrmojo.all[hostId];if(isPrimaryKey){host.updateProperties($EnumPropertyType.isRemoved,"0",layerKey);}else{var layerDefn=docModel.getLayoutUnitDefn(layerKey);delete layerDefn._isDeleted;}host._isUndo=true;return false;},redo:function(){var host=mstrmojo.all[hostId];if(isPrimaryKey){host.updateProperties($EnumPropertyType.isRemoved,"1",layerKey);}else{var layerDefn=docModel.getLayoutUnitDefn(layerKey);layerDefn._isDeleted=true;}host.removeLayerCallback(layerKey);host._isUndo=false;return true;},callback:this.getUndoRedoCallbackForRemoveLayer(layerKey,otherActions),treesToRender:2};},getUndoRedoCallbackForRemoveLayer:function getUndoRedoCallbackForRemoveLayer(layerKey,otherActions){var hostId=this.id,addLayerParams={layerKey:layerKey,editingIdx:this.getEditingLayerIdx()},cb={success:function(res){var host=mstrmojo.all[hostId];if(host._isUndo){host.addLayerCallback(addLayerParams,res);}}};this.syncLayerProperties(this.getProperties(layerKey),addLayerParams);if(otherActions&&$ARR.isArray(otherActions.actions)&&otherActions.actions.length>0&&otherActions.callback){cb=$FUNC.wrapMethods(cb,otherActions.callback);}return cb;},addLayerCallback:function addLayerCallback(addLayerParams,res){if(!addLayerParams){return ;}var xtab,data,docModel=this.getDocModel(),layerKey=addLayerParams.layerKey,docBuilder=this.builder,modelData=this.model.data,sdp=modelData&&modelData.sdp;if(!this.isPrimaryKey(layerKey)&&docModel&&res){docModel.updatePrimaryScdpMap(this.k,layerKey,true);data=docModel.getMapLayerDataByLayerKey(layerKey);if(sdp){sdp[layerKey]=data;}if(docBuilder&&data){xtab=this.createSdpXtab(layerKey,docModel,data,this.getVisName(data));this.syncPropsForSdpXtab(xtab);}}this.addGraphicLayerCallback(addLayerParams);},removeLayerCallback:function removeLayerCallback(layerKey,editingIdx){if(!this.isPrimaryKey(layerKey)){var xtab=this.fnGetWidget(layerKey),modelData=this.model.data,docModel=this.getDocModel(),sdp=modelData&&modelData.sdp;if(sdp){delete sdp[layerKey];}docModel.updatePrimaryScdpMap(this.k,layerKey,false);this.unRegisterSdpInDocModel([layerKey]);if(xtab&&xtab.destroy){xtab.destroy();}}this.removeGraphicLayerCallback(layerKey,editingIdx);},handleZoomThroughLayerChange:function handleZoomThroughLayerChange(){if(this.isMapbox()&&$UTIL.checkHasFunction(this,"onLayerZoomRangeChange")){this.onLayerZoomRangeChange();}},addGraphicLayerCallback:function addGraphicLayerCallback(addLayerParams){var newKey=addLayerParams.layerKey,insertIdx=addLayerParams[$EnumPropertyType.layerIdx],gridData=this.getGridData(newKey),mapViewer=this.mapViewer,layerIdxMappingArr=this.layerIdxMappingArr;if(!gridData||!mapViewer||!layerIdxMappingArr){return ;}$UTIL.showWait();layerIdxMappingArr.splice(insertIdx,0,newKey);this.updateGraphicLayerOrder(insertIdx);this.updateEditingLayerIdx(addLayerParams.editingIdx);this.syncLayerProperties(addLayerParams,this.getProperties(newKey));mapViewer.addGraphicLayer(gridData);this.handleZoomThroughLayerChange();mapViewer.highlightAllLayers();this.layerZoneCacheInfo=null;this.findSelectorControl();this.refreshDzPropPanels();$UTIL.hideWait();},removeGraphicLayerCallback:function removeGraphicLayerCallback(layerKey,editingIdx){if(!layerKey){return ;}var mapViewer=this.mapViewer,layerIdxMappingArr=this.layerIdxMappingArr,layerIdx=$ARR.indexOf(layerIdxMappingArr,layerKey),widgetIdMapping=this.widgetIdMapping;if(!mapViewer||!layerIdxMappingArr||layerIdx<0){return ;}$UTIL.showWait();layerIdxMappingArr.splice(layerIdx,1);this.updateGraphicLayerOrder(layerIdx);if($UTIL.checkVal(editingIdx)){this.updateEditingLayerIdx(editingIdx);}else{this.resetEditingLayerIdx(layerIdx);}mapViewer.removeGraphicLayer(layerKey);if(widgetIdMapping){delete widgetIdMapping[layerKey];}this.handleZoomThroughLayerChange();mapViewer.highlightAllLayers();this.findSelectorControl();this.layerZoneCacheInfo=null;this.refreshDzPropPanels();this.raiseEvent({name:"toggleCtrlOverlay",visible:this.isEmpty()||this.excludeData,controls:this.getVisEmptyMsgControls()});this.applyBackground();$UTIL.hideWait();},renameGraphicLayerCallback:function renameGraphicLayerCallback(layerKey,newName){if(!!layerKey&&!!newName){this.writeProperties($EnumPropertyType.layerName,newName,layerKey);}},layerDroppedCallback:function layerDroppedCallback(fromIdxArr,toIdx){var layerIdxMappingArr=this.layerIdxMappingArr,editingLayerIdx=this.getEditingLayerIdx(),undoConfig={edtIdx:editingLayerIdx,idxMap:layerIdxMappingArr.slice(0)},redoConfig={},editingLayerKey,newEditingLayerIdx,startIdx;toIdx=parseInt(toIdx);if(!this.k||isNaN(editingLayerIdx)||!$ARR.isArray(fromIdxArr)||isNaN(toIdx)||!layerIdxMappingArr||!$ARR.isArray(layerIdxMappingArr)||(fromIdxArr.length===1&&fromIdxArr[0]===toIdx)){return ;}startIdx=Math.min(Math.min.apply(Math.min,fromIdxArr),toIdx);editingLayerKey=this.reorderLayerItems(fromIdxArr,toIdx);newEditingLayerIdx=$ARR.indexOf(layerIdxMappingArr,editingLayerKey);redoConfig.edtIdx=newEditingLayerIdx;redoConfig.idxMap=layerIdxMappingArr.slice(0);redoConfig.startIdx=undoConfig.startIdx=startIdx;this.saveGraphicLayerOrder(undoConfig,redoConfig);},reorderLayerItems:function reorderLayerItems(fromIdxArr,toIdx){var layerIdxMappingArr=this.layerIdxMappingArr,fromItemArr=[],placeholder="#",i;if(!$ARR.isArray(fromIdxArr)||!$ARR.isArray(layerIdxMappingArr)){return ;}this.layerZoneCacheInfo=null;$ARR.forEach(fromIdxArr,function(fromIdx){fromItemArr.push(layerIdxMappingArr[fromIdx]);layerIdxMappingArr[fromIdx]=placeholder;});$ARR.insert(layerIdxMappingArr,toIdx,fromItemArr);for(i=layerIdxMappingArr.length-1;i>=0;i--){if(layerIdxMappingArr[i]===placeholder){layerIdxMappingArr.splice(i,1);}}return fromItemArr[0];},updateGraphicLayerOrder:function updateGraphicLayerOrder(startIdx){var layerIdxMappingArr=this.layerIdxMappingArr,mapViewer=this.mapViewer,propName=$EnumPropertyType.layerIdx,key,i,il;startIdx=parseInt(startIdx);if(!mapViewer||!layerIdxMappingArr||!$ARR.isArray(layerIdxMappingArr)||isNaN(startIdx)){return ;}for(i=startIdx,il=layerIdxMappingArr.length;i<il;i++){key=layerIdxMappingArr[i];if(!!key){this.updateProperties(propName,i,key);}}mapViewer.reorderGraphicLayers(layerIdxMappingArr.slice(startIdx));}});}());