(function(){mstrmojo.requiresCls("mstrmojo.ui.PopupButton","mstrmojo.vi.ui.rw.selectors._IsLevelList","mstrmojo.ui.ButtonBar","mstrmojo.ui.PopupWidget","mstrmojo.vi.ui.rw.selectors.SearchableCheckList","mstrmojo.Box","mstrmojo.Widget","mstrmojo.Button.newWebButton","mstrmojo.css");var $WIDGET=mstrmojo.Widget,$NWB=mstrmojo.Button.newWebButton,$DOM=mstrmojo.dom,$CSS=mstrmojo.css;var EXPAND_ITEM="expand";function deferredRefresh(){var model=this.docSelector.model;if(model&&!this.refreshListener){this.refreshListener=model.attachEventListener("panelDisplaying",this.id,function(evt){this.refresh();model.detachEventListener(this.refreshListener);});}}function assignNodeWidths(btnBar){var widgetWidth=this.domNode.offsetWidth,itemNodes=Array.prototype.slice.call(btnBar.itemsContainerNode.childNodes),selectedItemIdx=0,selectedNode=itemNodes[selectedItemIdx],allItemIdx=1,expandItemIdx=itemNodes.length-1,expandNode=itemNodes[expandItemIdx],lastVisibleNodeIdx=expandItemIdx-1;if(widgetWidth===0){deferredRefresh.call(this);return ;}if(expandItemIdx===allItemIdx+1){expandNode.style.display="none";}var getNodeWidth=function(node){var nodeWidth=node.offsetWidth;return nodeWidth>0?Math.max(nodeWidth+6,50):0;},widths=itemNodes.map(function(node){return getNodeWidth(node);}),totalWidth=widths.reduce(mstrmojo.array.fnReduceNumber);if(totalWidth>widgetWidth+widths[expandItemIdx]){while(totalWidth>widgetWidth){if(lastVisibleNodeIdx===allItemIdx){selectedNode.title=selectedNode.innerHTML;selectedNode.innerHTML="";totalWidth-=widths[selectedItemIdx];totalWidth+=widths[selectedItemIdx]=getNodeWidth(selectedNode);break;}else{itemNodes[lastVisibleNodeIdx].style.display="none";totalWidth-=widths[lastVisibleNodeIdx];lastVisibleNodeIdx--;}}}else{expandNode.style.display="none";totalWidth-=widths[expandItemIdx];}this.set("hiddenLevel",btnBar.items[lastVisibleNodeIdx+1].v);itemNodes.forEach(function(node,idx){node.style.width=(widths[idx]/totalWidth)*widgetWidth+"px";});}function updateLevelPulldown(evt){var widget=this.parent.parent,startLevel=parseInt(this.hiddenLevel,10)||0;this.set("items",widget.getLevels(this.levels).filter(function(levelItem){return levelItem.v>=startLevel;}));this.selectItemByField("v",startLevel);}mstrmojo.vi.ui.rw.selectors.LevelPopupList=mstrmojo.declare(mstrmojo.ui.PopupButton,[mstrmojo.vi.ui.rw.selectors._IsLevelList],{scriptClass:"mstrmojo.vi.ui.rw.selectors.LevelPopupList",markupString:'<div id="{@id}" style="{@cssText}" class="mstrmojo-vi-sel-LevelPopupList {@cssClass}"><div class="level-control"></div><div class="level-container"></div></div>',markupSlots:{controlNode:function controlNode(){return this.domNode.firstChild;},containerNode:function containerNode(){return this.domNode.lastChild;}},markupMethods:{onvisibleChange:$WIDGET.visibleMarkupMethod,onheightChange:$WIDGET.heightMarkupMethod,onwidthChange:$WIDGET.widthMarkupMethod,onapplyEnabledChange:function(){var popup=this.getPopupWidget(),applyEnabled=this.applyEnabled;if(popup.hasRendered){$CSS.toggleClass(popup.domNode,"noApply",!applyEnabled);}else{$CSS[(applyEnabled?"remove":"add")+"WidgetCssClass"](popup,"noApply");}}},isHostedWithin:false,anchorSlot:"controlNode",hiddenLevel:EXPAND_ITEM,children:[{scriptClass:"mstrmojo.ui.ButtonBar",slot:"controlNode",alias:"levelList",multiSelect:false,showIcon:false,selectionPolicy:"reselect",bindings:{levels:"this.parent.levels"},onlevelsChange:function(evt){this.set("items",this.parent.getLevels(evt.value));},postselectionChange:function(evt){var itemIdx=evt.added&&evt.added[0],item=this.items[itemIdx];if(item){var widget=this.parent,popup=widget.getPopupWidget(),level=item.v,isExpandItem=level===EXPAND_ITEM;if(!isExpandItem){widget.set("level",level);}widget.openPopupWidget(isExpandItem);if(popup.visible){var itemNode=this._getItemNode(itemIdx),offsetLeft=itemNode.offsetLeft,offsetDelta=(itemNode.offsetWidth-popup.domNode.offsetWidth)/2;if(itemIdx===0){offsetLeft+=Math.max(offsetDelta,0);}else{if(itemIdx>=this.items.length-2){offsetLeft+=offsetDelta+Math.min(offsetDelta,0);}else{offsetLeft+=offsetDelta;}}popup.offsetLeft=offsetLeft;popup.domNode.style.left=offsetLeft+"px";}}}},{scriptClass:"mstrmojo.ui.PopupWidget",alias:"popupList",visible:false,autoCloses:false,adjustCornersForPopupOverflow:function adjustCornersForPopupOverflow(){var adjusted=mstrmojo._IsPopup.adjustCornersForPopupOverflow.call(this);this.adjustCheckListForPopupOverflow(adjusted);this.domNode.style.left=this.offsetLeft+"px";return adjusted;},adjustCheckListForPopupOverflow:function adjustCheckListForPopupOverflow(adjusted){var domNode=this.domNode,curPos,curY,checklist=this.checklist,scrollNode=checklist&&(checklist.scrollNode||checklist.scrollboxNode);if(adjusted&&scrollNode){curPos=$DOM.position(domNode);curY=curPos.y;if(curY+curPos.h>$DOM.position(document.body).h){var domNodeHeight=domNode.offsetHeight,scrollNodeHeight=scrollNode&&scrollNode.offsetHeight;scrollNode.style.maxHeight=$DOM.getMaxScrollHeight()-(domNodeHeight-scrollNodeHeight)+"px";checklist.updateScrollbars();}}},shouldPropagateLockHover:function(){return false;},children:[{scriptClass:"mstrmojo.ui.Pulldown",alias:"levelPulldown",isHostedWithin:false,visible:false,bindings:{levels:"this.parent.parent.levels",hiddenLevel:"this.parent.parent.hiddenLevel"},onlevelsChange:updateLevelPulldown,onhiddenLevelChange:updateLevelPulldown,onvisibleChange:function(evt){var selectedItem=this.getSelectedItem();if(evt.value&&selectedItem){this.parent.parent.set("level",selectedItem.v);}},onitemSelected:function(item){this.parent.parent.set("level",item.v);}},{scriptClass:"mstrmojo.vi.ui.rw.selectors.SearchableCheckList",alias:"checklist",bindings:{level:"this.parent.parent.level"}},{scriptClass:"mstrmojo.Box",alias:"buttons",children:[$NWB(mstrmojo.desc(134,"Apply"),function(){var widget=this.parent.parent.parent;if(widget.applyEnabled){widget.handleSelectionSubmit(true);widget.closePopup();}},true),$NWB(mstrmojo.desc(221,"Cancel"),function(){var widget=this.parent.parent.parent;widget.handleSelectionSubmit(false);widget.closePopup();},false)]}]}],getPopupWidget:function getPopupWidget(){return this.popupList;},getCheckList:function getCheckList(){return this.getPopupWidget().checklist;},getLevels:function getLevels(levels){var levelItems=this._super(levels);levelItems[0].cls="iconRA-selItem";levelItems.push({v:EXPAND_ITEM,cls:"iconRA-epdItem"});return levelItems;},preBuildRendering:function preBuildRendering(){var popup=this.getPopupWidget(),itemCssText=this.labelCssText;this._super();if(popup.cssText.indexOf(itemCssText)===-1){popup.cssText+=itemCssText;}},postBuildRendering:function postBuildRendering(){this._super();this.closePopup();assignNodeWidths.call(this,this.levelList);},openPopupWidget:function openPopupWidget(isExpandLevel){var popup=this.getPopupWidget(),checklist=this.getCheckList();if(!popup.visible){popup.levelPulldown.set("visible",isExpandLevel);this.openPopup(popup);$CSS.toggleClass(checklist.domNode,"strikeout",!this.include);checklist.updateScrollbars();}else{this.closePopup();}}});}());