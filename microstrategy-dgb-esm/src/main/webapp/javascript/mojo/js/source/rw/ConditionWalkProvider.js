(function(){mstrmojo.requiresCls("mstrmojo.Obj","mstrmojo.css","mstrmojo.AjaxCall","mstrmojo.hash","mstrmojo.array","mstrmojo.expr","mstrmojo.Label","mstrmojo.ListBase","mstrmojo.ui.CheckList","mstrmojo.ui.ColumnContainer","mstrmojo.rw.ConditionWalkProviderBase","mstrmojo.elementHelper");var $CSS=mstrmojo.css,$HASH=mstrmojo.hash,$ARR=mstrmojo.array,$EXPR=mstrmojo.expr,$EXPRTYPE=$EXPR.ET,ET2TGT=$EXPR.ET2TGT,FN=$EXPR.FN,FN_MRP=$EXPR.FN_MRP,D2FD=$EXPR.DTP2FN_DTP,$META_TP=mstrmojo.meta.TP,TP=$EXPR.TP,STP=$EXPR.STP,$EH=mstrmojo.elementHelper,CWPB=mstrmojo.rw.ConditionWalkProviderBase;var ET2STEPS={};ET2STEPS[$EXPRTYPE.AQ]={target:1,fm:1,fn:1,c0:1,c1:1};ET2STEPS[$EXPRTYPE.AL]={target:1,fm:1,fn:1,c0:1};ET2STEPS[$EXPRTYPE.AE]={target:1,fm:1,es:1};ET2STEPS[$EXPRTYPE.AC]={target:1,fm:1,fm2:1,fm3:1,fn:1,c0:1,c1:1};ET2STEPS[$EXPRTYPE.MQ]={target:1,fn:1,c0:1,c1:1,dmy:1};ET2STEPS[$EXPRTYPE.MC]=ET2STEPS[$EXPRTYPE.MQ];ET2STEPS["*"]={target:1};var ET2FNS={};ET2FNS[$EXPRTYPE.MQ]={key:"metricFns",def:$EXPR.METRIC_FNS};ET2FNS[$EXPRTYPE.MC]={key:"metricFns",def:$EXPR.METRIC_FNS};ET2FNS[$EXPRTYPE.AQ]={key:"formFns",def:$EXPR.FORM_FNS};ET2FNS[$EXPRTYPE.AL]={key:"formFns",def:$EXPR.FORM_FNS};ET2FNS[$EXPRTYPE.AC]={key:"formFns",def:$EXPR.FORM_FNS};ET2FNS[$EXPRTYPE.AE]={key:"elemFns",def:$EXPR.ELEM_FNS};var TIP_STAGE_1=mstrmojo.desc(14084,"Select a filter option or a qualification."),TIP_STAGE_1_WS=mstrmojo.desc(15007,"Choose to select in list or qualify on an attribute form."),TIP_STAGE_2=mstrmojo.desc(14085,"Select one or more elements."),TIP_STAGE_2_WS=mstrmojo.desc(15009,"Select element(s)."),TIP_STAGE_3=mstrmojo.desc(14086,"Select an operator."),TIP_STAGE_4=mstrmojo.desc(14087,"Enter a value or select an attribute from the list."),TIP_STAGE_4_WS=mstrmojo.desc(15010,"Enter a specific value or select an attribute form as variable."),TIP_STAGE_5=mstrmojo.desc(14088,"Select an attribute form. When done, click ## button.").replace("##",'"âˆš"'),TIP_STAGE_6=mstrmojo.desc(14089,"Select a condition."),TIP_STAGE_6_WS=mstrmojo.desc(15011,"Select an operator."),TIP_STAGE_7=mstrmojo.desc(14090,"Enter a value or select a metric from the list."),TIP_STAGE_7_WS=mstrmojo.desc(15012,"Enter a specific value or select a metric as variable.");var FORM_SELECTION_NOT_AE=0,FORM_SELECTION_AE=1;var fnUpdateColumnContainer=mstrmojo.ui.ColumnContainer.prototype.updateColumnContainer;var DUMMY_TP="dummy",ERROR_ITEM={did:"idErr",v:"idErr",n:mstrmojo.desc(7929,"Error loading data."),t:DUMMY_TP,css:"unselectable"},WAIT_ITEM={did:"idWait",v:"idWait",n:mstrmojo.desc(2901,"Loading..."),t:DUMMY_TP,css:"unselectable"},SELECT_ITEM={did:"idSelect",v:"idSelect",n:mstrmojo.desc(547,"Select"),t:DUMMY_TP,css:"unselectable"},QUALIFICATION_ITEM={did:"idWait",v:"idQualification",n:mstrmojo.desc(5225,"Qualification"),t:DUMMY_TP,css:"unselectable"},QUALIFICATION_ITEM_WS={did:"idWait",v:"idQualification",n:mstrmojo.desc(15008,"Qualify on"),t:DUMMY_TP,css:"unselectable"};var onWalkChange=CWPB.onWalkChange,replaceItem=CWPB.replaceItem,getChildJSON=CWPB.getChildJSON,walkChildPostCreateFn=CWPB.walkChildPostCreateFn,updateList=CWPB.updateList,fnItem=CWPB.fnItem,isComparisonAllowed=CWPB.isComparisonAllowed,cstJson=CWPB.cstJson,fmJson=CWPB.fmJson,updateListMulti=CWPB.updateListMulti,updateListMultiData=CWPB.updateListMultiData;function initDmys(me){return me.targets?$ARR.filter(me.targets,function(item){return item[$META_TP]===$EXPR.TP.ATTR;}):[];}function setTip(tip){this.tip.set("text",tip);}var TGT_PPT_STP=[$EXPR.STP.PROMPT,$EXPR.STP.PROMPT_OBJECTS,$EXPR.STP.PROMPT_ELEMENTS,$EXPR.STP.PROMPT_EXPRESSION,$EXPR.STP.PROMPT_EXPRESSION_DRAFT];var allowedTargetTypes=CWPB.allowedTargetTypes;mstrmojo.rw.ConditionWalkProvider=mstrmojo.declare(mstrmojo.rw.ConditionWalkProviderBase,null,{scriptClass:"mstrmojo.rw.ConditionWalkProvider",browseEs:function browseEs(me,ch,p){me.openPopup("eb",{zIndex:me.parent.zIndex+10,left:Math.round(p.x)+"px",top:Math.round(p.y)+"px"});var eb=me.eb.browser,m=me.model,aid=m&&m.a&&m.a.did;if(!aid){return ;}eb.set("attributeID",aid);eb.set("selectedItems",m.es?$HASH.clone(m.es):[]);eb.initBrowser();},browseObjs:function browseObjs(me,ch,p){me.openPopup("ob",{zIndex:me.parent.zIndex+10,left:Math.round(p.x)+"px",top:Math.round(p.y)+"px"});var ob=me.ob.browser;ob.target=ch;var tps;switch(ch.alias){case"dmy":tps=[$EXPR.TP.ATTR,$EXPR.TP.DIM];break;case"c0":case"c1":var model=me.model,expressionType=model&&model.et,fm=model&&model.fm,dtp=fm&&fm.dtp||(model.m?$EXPR.DTP.DECIMAL:$EXPR.DTP.UNKNOWN);tps=(expressionType===$EXPRTYPE.MQ||expressionType===$EXPRTYPE.MC)?[$EXPR.TP.METRIC,$EXPR.DTP2PROMPT_STP[dtp]]:[$EXPR.TP.ATTR,$EXPR.DTP2PROMPT_STP[dtp]];break;default:tps=allowedTargetTypes(me.ets);tps=tps?$HASH.keyarray(tps,true):[$EXPR.TP.ATTR,$EXPR.TP.METRIC,$EXPR.STP.REPORT_GRID,$EXPR.STP.REPORT_GRAPH,$EXPR.STP.REPORT_ENGINE,$EXPR.STP.REPORT_TEXT,$EXPR.STP.REPORT_DATAMART,$EXPR.STP.REPORT_BASE,$EXPR.STP.REPORT_GRIDGRAPH,$EXPR.STP.REPORT_NONINTERACTIVE,$EXPR.STP.FILTER].concat(TGT_PPT_STP);}tps[tps.length]=$EXPR.TP.FOLDER;ob.browse({rootFolderType:model&&(model.et===$EXPRTYPE.MQ||model.et===$EXPRTYPE.MC)?5:26,folderLinksContextId:33,onSelectCB:[me,"onOBSelect"],browsableTypes:tps.join(",")});},getFm2NodeProps:function getFm2NodeProps(){return{alias:"fm2",children:[fmJson({alias:"fm2",fmPost:2})],updateColumnContainer:function updateColumnContainer(){var conditionWalk=this.parent.parent;if(this.domNode){$CSS.addClass(this.domNode,"lastStage");}this.fm2.update();setTip.call(conditionWalk,TIP_STAGE_5);fnUpdateColumnContainer.call(this);}};},getC0NodeProps:function getC0NodeProps(){var me=this;return{alias:"c0",c1Selected:false,children:[{scriptClass:"mstrmojo.Label",cssClass:"baseOn",text:mstrmojo.desc(527,"Value")},cstJson({alias:"c0",cstIndex:0}),{scriptClass:"mstrmojo.Label",alias:"btwn",cssClass:"btwn",text:mstrmojo.desc(308,"and"),visible:false},cstJson({alias:"c1",cstIndex:1,visible:false}),{alias:"browseLink",scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-walkstep-browse",text:mstrmojo.desc(7926,"Browse..."),onclick:function(){this.parent.parent.parent.browse(this.parent.c0);},visible:false}],updateColumnContainer:function updateColumnContainer(){this.c0.update();var columnWalk=this.parent,conditionWalk=columnWalk.parent,model=columnWalk.parent.model,fn=model&&model.fn,showBtwn=fn===FN.BETWEEN||fn===FN.NOT_BETWEEN||fn===FN_MRP.BETWEEN||fn===FN_MRP.BETWEEN_DESCENDING,showFm2=fn===FN.EQUAL||fn===FN.NOT_EQUAL||fn===FN.GREATER||fn===FN.GREATER_EQUAL||fn===FN.LESS||fn===FN.LESS_EQUAL,idx=this.idx,next=this.next;this.browseLink.set("visible",conditionWalk.objectBrowsingEnabled&&isComparisonAllowed(model,conditionWalk.ets));this.btwn.set("visible",showBtwn);this.c1.set("visible",showBtwn);if(showBtwn){this.c1.update();}else{model.edit("c1",{v:null,dtp:null,skipET:true},true);}if(model.a2&&showFm2){if(!(next&&next.fm2)){columnWalk.insertAndRemoveTrailing(idx,me.getFm2NodeProps());}}else{columnWalk.removeTrailingContainer(idx);}var tip4=mstrApp.isWSStyling?TIP_STAGE_4_WS:TIP_STAGE_4,tip7=mstrApp.isWSStyling?TIP_STAGE_7_WS:TIP_STAGE_7;setTip.call(conditionWalk,model.a?tip4:model.m?tip7:"");if((!model.a)&&model.m&&this.domNode){$CSS.addClass(this.domNode,"lastStage");}fnUpdateColumnContainer.call(this);}};},getFnNodeProps:function getFnNodeProps(){var me=this;return{alias:"fn",children:[{scriptClass:"mstrmojo.Label",cssClass:"baseOn",text:mstrApp.isWSStyling?mstrmojo.desc(15006,"Operator"):mstrmojo.desc(9579,"Condition")},fmJson({alias:"fn",allowUnlistedValues:false,update:function(){var conditionWalk=this.parent.parent.parent,m=conditionWalk.model||{},et=m.et,dtp,show=false,fns,sel;switch(et){case $EXPRTYPE.AE:show=!!m.a;break;case $EXPRTYPE.AQ:case $EXPRTYPE.AC:case $EXPRTYPE.AL:show=!!(m.fm&&m.fm.did);dtp=show?m.fm.dtp:null;break;case $EXPRTYPE.MQ:case $EXPRTYPE.MC:show=!!m.m;dtp=show?$EXPR.METRIC_DTP:null;break;}if(show){var fndtp=D2FD[dtp];if((this.lastEt!==et)||(this.lastFnDtp!==fndtp)){this.lastEt=et;this.lastFnDtp=fndtp;var lookin=et?ET2FNS[et]:null,k=lookin&&lookin.key;fns=(k&&conditionWalk[k])||lookin.def||[];if(typeof (fns)==="object"){fns=fns[fndtp]||fns["*"];}}sel=fnItem(m.fn,m.fnt||1);}updateList(this,show,fns,sel);this.parent.updateScrollbars();}})],updateColumnContainer:function updateColumnContainer(){this.fn.update();var columnWalk=this.parent,conditionWalk=columnWalk.parent,model=conditionWalk.model,fn=model&&model.fn,next=this.next,isFnNull=fn===FN.IS_NULL||fn===FN.IS_NOT_NULL;if(fn&&isFnNull){columnWalk.removeTrailingContainer(this.idx);}else{if(fn&&!(next&&next.c0)){columnWalk.insertAndRemoveTrailing(this.idx,me.getC0NodeProps());}}var tip6=mstrApp.isWSStyling?TIP_STAGE_6_WS:TIP_STAGE_6;setTip.call(conditionWalk,model.a?TIP_STAGE_3:model.m?tip6:"");next=this.next;if(next){next.updateColumnContainer();}}};},getEsNodeProps:function getEsNodeProps(){var children=[{scriptClass:"mstrmojo.ui.CheckList",alias:"es",itemIdField:"v",allowUnlistedValues:true,insertUnlistedValuesAt:0,selectionPolicy:"toggle",postCreate:function pces(){walkChildPostCreateFn.apply(this,[]);this.ajx=mstrmojo.insert({parent:this,scriptClass:"mstrmojo.AjaxCall",isTask:true,params:{taskId:"browseElements",attributeID:null,styleName:"MojoAttributeStyle",blockBegin:1,blockCount:mstrApp.elementsBlockCount||30},onsuccess:function(){var p=this.parent,rs=this.response;if((rs&&rs.did)!==p.lastAttrId){return ;}var its=(rs&&rs.es)?$ARR.filter(rs.es,function(el){return !$EH.isNullElem(el.v);}):[],sel=p.parent.parent.parent.model&&p.parent.parent.parent.model.es,findMissingItem=function(array,items){var lenA=array&&array.length||0,lenB=items&&items.length||0,rel=[],i,j;for(i=0;i<lenB;i++){for(j=0;j<lenA;j++){if(items[i].n===array[j].n){break;}}if(j===lenA){rel.push(items[i]);}}return rel;},adjustSelItems=function(oldSel,its,prop){var newsel=[],nit;$ARR.forEach(oldSel,function(sel){nit=$ARR.filterOne(its,function(ait){return sel[prop]&&ait[prop]&&sel[prop]===ait[prop];});if(nit){newsel.push(nit);}});return newsel.length===oldSel.length?newsel:oldSel;};sel=sel&&adjustSelItems(sel,its,"v");if(p.allowUnlistedValues){var dif=findMissingItem(its,sel);its=(p.insertUnlistedValuesAt===0)?dif.concat(its):its.concat(dif);}updateListMultiData(p,its,sel,null);p.parent.updateScrollbars();},onerr:function(){replaceItem(this.parent,WAIT_ITEM,[ERROR_ITEM]);}});},onselectionChange:function onselectionChange(evt){mstrmojo.ListBase.prototype.onselectionChange.call(this,evt);onWalkChange.call(this,evt);},update:function udes(){var conditionWalk=this.parent.parent.parent,model=conditionWalk.model,a=model&&model.a,show=!!a&&!a.ilk,es,sel,idxs,len,i,ajx;if(show){if(this.lastAttrId!==a.did){this.lastAttrId=a.did;es=model.es;len=es&&es.length;es=len?es.concat():[];es.push(WAIT_ITEM);if(len){idxs=[];for(i=1;i<=len;i++){idxs[i]=i;}}ajx=this.ajx;conditionWalk.updateBrowseElementsParams(ajx.params,a);}else{sel=model.es;}}updateListMulti(this,show,es,sel,idxs);if(show&&ajx){if(conditionWalk.getElements){var list=this;conditionWalk.getElements(a,{success:function(res){updateListMultiData(list,res.es||[],conditionWalk.model&&conditionWalk.model.es,null);list.parent.updateScrollbars();},failure:function(){replaceItem(list,WAIT_ITEM,[ERROR_ITEM]);}});}else{ajx.send();}}},setupScrollNodes:function setupScrollNodes(){this.scrollNode=null;}}];if(!mstrApp.isSingleTier){children.splice(0,0,{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-walkstep-browse",text:mstrmojo.desc(7928,"Browse elements..."),onclick:function onclick(){this.parent.parent.parent.browse(this.parent.es);}});}return{alias:"es",children:children,updateList:function(items){updateListMulti(this.es,true,items,this.parent.parent.model.es,null);this.updateScrollbars();},updateColumnContainer:function updateColumnContainer(){var conditionWalk=this.parent.parent;if(this.domNode){$CSS.addClass(this.domNode,"lastStage");}this.es.update();setTip.call(conditionWalk,mstrApp.isWSStyling?TIP_STAGE_2_WS:TIP_STAGE_2);}};},getFmNodeProps:function getFmNodeProps(){var me=this;return{alias:"fm",children:[fmJson({alias:"fm",fmPost:"",filter:false,isFirstFm:true})],updateColumnContainer:function updateColumnContainer(){this.fm.update();var columnWalk=this.parent,conditionWalk=columnWalk.parent,model=conditionWalk.model,fm=model&&model.fm,idx=this.idx,a=model&&model.a,disableElementsBrowsing=conditionWalk.disableElementsBrowsing,disEB=a&&disableElementsBrowsing&&disableElementsBrowsing(a);var oldType=(model.etWas&&model.etWas===$EXPRTYPE.AE)?FORM_SELECTION_AE:FORM_SELECTION_NOT_AE,newType=FORM_SELECTION_NOT_AE;if(model.et===$EXPRTYPE.AE&&!disEB){newType=FORM_SELECTION_AE;}if(oldType!==newType||newType===FORM_SELECTION_NOT_AE){columnWalk.removeTrailingContainer(idx);if(newType===FORM_SELECTION_NOT_AE&&fm){columnWalk.addNextColumn(me.getFnNodeProps());}else{if(newType===FORM_SELECTION_AE){columnWalk.addNextColumn(me.getEsNodeProps());}}}setTip.call(conditionWalk,mstrApp.isWSStyling?TIP_STAGE_1_WS:TIP_STAGE_1);fnUpdateColumnContainer.call(this);}};},getTargetNodeProps:function getTargetNodeProps(){var me=this;return{alias:"target",target:null,browseLink:null,children:[{scriptClass:"mstrmojo.Label",cssClass:"baseOn",text:mstrmojo.desc(11859,"Based On")},getChildJSON({alias:"target",insertUnlistedValuesAt:0,makeObservable:true,hideIfEmpty:true,postCreate:function(){this._super();this.parent.parent.parent.attachEventListener("updateTargets",this.id,function(){this.update();});},onObjBrowsed:function(item){if(item.st===STP.FILTER||item.t===TP.REPORT||item.t===TP.PROMPT){this.parent.parent.parent.onOK();}},update:function update(){var conditionWalk=this.parent.parent.parent,model=conditionWalk.model,targetsLastMod=conditionWalk.targetsLastMod,et=model&&model.et;if(this.lastModel!==model||this.targetsLastMod!==targetsLastMod){this.lastModel=model;this.targetsLastMod=targetsLastMod;var tgs=conditionWalk.targets,ets=conditionWalk.ets;if(ets&&tgs&&tgs.length){var ok=allowedTargetTypes(conditionWalk.ets);tgs=$ARR.filter(tgs,function(item){return ok[item[$META_TP]];});}var t=model&&model[ET2TGT[et]];updateList(this,true,$EXPR.getSortedObjectsByTypeGroup(tgs),t);this.parent.updateScrollbars();}}}),{alias:"browseLink",scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-walkstep-browse",text:mstrmojo.desc(7926,"Browse..."),onclick:function(){this.parent.parent.parent.browse(this.parent.target);}}],updateColumnContainer:function updateColumnContainer(){this.target.update();var columnWalk=this.parent,conditionWalk=columnWalk.parent,model=conditionWalk.model,et=model&&model.et,idx=this.idx,next=this.next;this.browseLink.set("visible",conditionWalk.objectBrowsingEnabled);if(et){switch(et){case $EXPRTYPE.AQ:case $EXPRTYPE.AL:case $EXPRTYPE.AC:case $EXPRTYPE.AE:if(model.a&&!(next&&next.fm)){this.parent.insertAndRemoveTrailing(idx,me.getFmNodeProps());}break;case $EXPRTYPE.MQ:case $EXPRTYPE.MC:if(model.m&&!(next&&next.fn)){this.parent.insertAndRemoveTrailing(idx,me.getFnNodeProps());}break;case $EXPRTYPE.R:case $EXPRTYPE.F:case $EXPRTYPE.XML:this.parent.removeTrailingContainer(idx);break;}}next=this.next;if(next){next.updateColumnContainer();}}};}});var CWP=mstrmojo.rw.ConditionWalkProvider;CWP.setTip=setTip;}());