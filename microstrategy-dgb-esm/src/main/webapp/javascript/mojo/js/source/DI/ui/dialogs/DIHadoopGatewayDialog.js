(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.array","mstrmojo.css","mstrmojo.Label","mstrmojo.Button","mstrmojo.Editor","mstrmojo.DI.DIHelpers");mstrmojo.requiresDescs(7778,14937,14938,14939,7778,14940,4453,14966,12309,12310,14961,14942,12313,14943,2707,7776,14944,14945,14946,14941,702,629,221,118,14936,14956,14957,14958,14963,15852,15853);var $HASH=mstrmojo.hash,$ARR=mstrmojo.array,$C=mstrmojo.css,$H=mstrmojo.DI.DIHelpers;var $MODE_LOCAL=0,$MODE_STANDALONE=1,$MODE_YARN=2,$ANTHMODE_ANONYMOUS=0,$ANTHMODE_KERBEROS=1;var $MODE_ITEMS=[{did:$MODE_LOCAL,n:mstrmojo.desc(14937,"Local")},{did:$MODE_STANDALONE,n:mstrmojo.desc(14938,"Standalone")},{did:$MODE_YARN,n:mstrmojo.desc(14939,"Yarn")}];var $AUTHMODE_ITEMS=[{did:$ANTHMODE_ANONYMOUS,n:mstrmojo.desc(7778,"Anonymous")},{did:$ANTHMODE_KERBEROS,n:mstrmojo.desc(14940,"Shared Kerberos")}];function nameValid(name){var copyName;copyName=name.trim().split("");for(var i=0;i<copyName.length;i++){if(copyName[i]==="#"||copyName[i]==="?"||copyName[i]==="/"||copyName[i]===";"||copyName[i]==="."||copyName[i]==="+"||copyName[i]==="%"||copyName[i]==="&"||copyName[i]==="="){return false;}}return true;}function emptyValid(str){var trimStr=str;if(!mstrmojo.num.isNumeric(str)){trimStr=trimStr.trim();}if(trimStr===null||trimStr===""){return true;}else{return false;}}function isIP(ip){var ValidIpAddressRegex=/^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$/;return ValidIpAddressRegex.test(ip);}function isHostname(hostname){var ValidHostnameRegex=/^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])$/;return ValidHostnameRegex.test(hostname);}function enCode(str){return encodeURI(str);}function optionValid(str){if(str===undefined||str===null){return true;}else{var optionArr=str.split("\n");for(var i=0;i<optionArr.length;i++){if(optionArr[i].trim()!==""){var mid=(optionArr[i].trim()).split("=");if(mid.length!==2){mstrmojo.alert("Invalid input for Optional field. Please enter the Optional in format:\nkey1=value1\nkey2=value2\n...");return false;}}}}return true;}function combineData(dirtydata,finaldata){var non_option=["AuthMode","Mode","spark.executor.cores","spark.driver.memory","spark.executor.memory","spark.master","spark.yarn.jar"],obj;for(obj in finaldata.sparkConfig.props){if(non_option.indexOf(obj)<0){finaldata.sparkConfig.props[obj]=undefined;}}for(var i in dirtydata){if(i!=="sparkConfig"){finaldata[i]=dirtydata[i];}}for(var j in dirtydata.sparkConfig.props){finaldata.sparkConfig.props[j]=dirtydata.sparkConfig.props[j];}if(finaldata.sparkConfig.props.hasOwnProperty("spark.yarn.jar")){finaldata.sparkConfig.props["spark.master"]="yarn-client";}return finaldata;}function cfgValidityCheck(cfg){var mode=cfg.sparkConfig.props.Mode;var inputValid=true;if(cfg.name===undefined||emptyValid(cfg.name)){mstrmojo.alert("The Name cannot be empty");return false;}if(!nameValid(cfg.name)){mstrmojo.alert("There are illegal character in name");return false;}if(cfg.namenodeAddr===undefined||emptyValid(cfg.namenodeAddr)){mstrmojo.alert("The Hadoop Name Node cannot be empty");return false;}if(cfg.hdfsRpcPort===undefined||emptyValid(cfg.hdfsRpcPort)){mstrmojo.alert("The HDFS Port cannot be empty");return false;}if(cfg.hdfsRpcPort!==undefined&&!mstrmojo.num.isNumeric(cfg.hdfsRpcPort)){mstrmojo.alert("The HDFS Port must be a number");return false;}if(cfg.hdfsHttpPort===undefined||emptyValid(cfg.hdfsHttpPort)){mstrmojo.alert("The WebHDFS Port cannot be empty");return false;}if(cfg.hdfsHttpPort!==undefined&&!mstrmojo.num.isNumeric(cfg.hdfsHttpPort)){mstrmojo.alert("The WebHDFS Port must be a number");return false;}if(cfg.hostAddr===undefined||emptyValid(cfg.hostAddr)){mstrmojo.alert("The Host Port cannot be empty");return false;}if(cfg.tcpPort===undefined||emptyValid(cfg.tcpPort)){mstrmojo.alert("The Port cannot be empty");return false;}if(cfg.tcpPort!==undefined&&!mstrmojo.num.isNumeric(cfg.tcpPort)){mstrmojo.alert("The Port  must be a number");return false;}return true;}function addLabeledControl(label,ctrl){var editor=this,box,cfg;cfg={scriptClass:"mstrmojo.Box",cssClass:"ctrl-box cf",children:[{scriptClass:"mstrmojo.Label",cssClass:"ctrl-label",text:label},ctrl]};box=editor.addChildren([cfg])[0];return box.children[1];}function addSection(text,onclick){var editor=this,box,cfg;cfg=[{scriptClass:"mstrmojo.Label",cssClass:"section-header",text:text,onclick:onclick||mstrmojo.emptyFn},{scriptClass:"mstrmojo.Box",cssClass:"section-box"}];box=editor.addChildren(cfg)[1];return box;}mstrmojo.DI.ui.dialogs.DIHadoopGatewayDialog=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.DI.ui.dialogs.DIHadoopGatewayDialog",cssClass:"mstrmojo-di-ui-dialogs-DIHadoopGatewayDialog",title:mstrmojo.desc(14956,"Hadoop Gateway"),afterSave:mstrmojo.emptyFn,data:null,option:null,postBuildRendering:function(){if(this._super){this._super();}if($H.isServerBasedWS()){$C.addClass(this.containerNode,"scrollable");}},onClose:function(){this.afterSave();},onOpen:function(){var editor=this,data,dirtyData,isNew=!editor.data,box,list,modeList;var serialize={"spark.serialize":"org.apache.spark.serializer.KryoSerializer"};data=editor.data=editor.data||{config:{sparkConfig:{props:{}}}};dirtyData=editor.dirtyData={remoteDir:data&&data.config&&data.config.remoteDir||"/opt"};editor.set("isNew",isNew);dirtyData.sparkConfig={props:{}};addLabeledControl.call(editor,mstrmojo.desc(4453,"Name:"),{scriptClass:"mstrmojo.TextBox",enabled:isNew,value:data&&data.config.name||"",onvalueChange:function(){dirtyData.name=this.value;}});box=addSection.call(editor,mstrmojo.desc(14961,"Hadoop Properties"));addLabeledControl.call(box,mstrmojo.desc(14966,"Hadoop NameNode:"),{scriptClass:"mstrmojo.TextBox",value:data&&data.config.namenodeAddr||"",onvalueChange:function(){dirtyData.namenodeAddr=this.value;}});box.addChildren([{scriptClass:"mstrmojo.Box",cssClass:"ctrl-box cf",children:[{scriptClass:"mstrmojo.Label",cssClass:"ctrl-label",text:"&nbsp;",allowHTML:true},{scriptClass:"mstrmojo.CheckBox",label:mstrmojo.desc(15110,"Use HTTPS"),checked:data&&data.config.supportHttpsURL||false,oncheckedChange:function(){dirtyData.supportHttpsURL=this.checked;}}]}]);addLabeledControl.call(box,mstrmojo.desc(12309,"HDFS Port:"),{scriptClass:"mstrmojo.TextBox",value:data&&data.config.hdfsRpcPort||"",onvalueChange:function(){dirtyData.hdfsRpcPort=this.value;}});addLabeledControl.call(box,mstrmojo.desc(12310,"WebHDFS Port:"),{scriptClass:"mstrmojo.TextBox",value:data&&data.config.hdfsHttpPort||"",onvalueChange:function(){dirtyData.hdfsHttpPort=this.value;}});box=addSection.call(editor,mstrmojo.desc(14941,"Gateway Properties"));addLabeledControl.call(box,mstrmojo.desc(14942,"Host:"),{scriptClass:"mstrmojo.TextBox",enabled:isNew,value:data&&data.config.hostAddr||"",onvalueChange:function(){dirtyData.hostAddr=this.value;}});addLabeledControl.call(box,mstrmojo.desc(12313,"Port:"),{scriptClass:"mstrmojo.TextBox",enabled:isNew,value:data&&data.config.tcpPort||"",onvalueChange:function(){dirtyData.tcpPort=this.value;}});addLabeledControl.call(box,mstrmojo.desc(2307,"Path:"),{scriptClass:"mstrmojo.TextBox",enabled:isNew,value:data&&data.config.remoteDir||"/opt",onvalueChange:function(){dirtyData.remoteDir=this.value;}});box=addSection.call(editor,mstrmojo.desc(14943,"Spark Properties"));list=addLabeledControl.call(box,mstrmojo.desc(2707,"Mode:"),{scriptClass:"mstrmojo.ui.Pulldown",isHostedWithin:false,items:$MODE_ITEMS,enabled:isNew,postselectedIndexChange:function(evt){var box=this.parent.parent,children=box.children,newValue=evt.value,oldValue=evt.valueWas,item=this.items[newValue];if(newValue!==oldValue){if(children.length>=4){box.removeChildren(children[3]);box.removeChildren(children[2]);box.removeChildren(children[1]);}if(children.length>=3){box.removeChildren(children[2]);box.removeChildren(children[1]);}switch(item&&item.did){case $MODE_LOCAL:dirtyData.sparkConfig={props:{}};dirtyData.sparkConfig.props.AuthMode=0;dirtyData.sparkConfig.props.Mode=0;addLabeledControl.call(box,mstrmojo.desc(7776,"Authentication Mode:"),{scriptClass:"mstrmojo.TextBox",value:mstrmojo.desc(7778,"Anonymous"),enabled:false});if(data.config.sparkConfig.props&&data.config.sparkConfig.props["spark.master"]){var threadNumStr=data.config.sparkConfig.props["spark.master"];var threadNum=threadNumStr.substring(6,threadNumStr.length-1);if(threadNum==="*"){threadNum="";}}addLabeledControl.call(box,mstrmojo.desc(14944,"Thread Number:"),{scriptClass:"mstrmojo.TextBox",value:threadNum,onvalueChange:function(){if(this.value.trim()){var threadNum="local["+this.value+"]";dirtyData.sparkConfig.props["spark.master"]=threadNum;}else{var threadNumDefault="local[*]";dirtyData.sparkConfig.props["spark.master"]=threadNumDefault;}}});break;case $MODE_STANDALONE:dirtyData.sparkConfig={props:{}};dirtyData.sparkConfig.props.AuthMode=0;dirtyData.sparkConfig.props.Mode=1;dirtyData.sparkConfig.props["spark.serializer"]="org.apache.spark.serializer.KryoSerializer";addLabeledControl.call(box,mstrmojo.desc(7776,"Authentication Mode:"),{scriptClass:"mstrmojo.TextBox",value:mstrmojo.desc(7778,"Anonymous"),enabled:false});addLabeledControl.call(box,mstrmojo.desc(14945,"Master:"),{scriptClass:"mstrmojo.TextBox",value:data&&data.config.sparkConfig.props["spark.master"]||"",onvalueChange:function(){dirtyData.sparkConfig.props["spark.master"]=this.value;}});break;case $MODE_YARN:dirtyData.sparkConfig={props:{}};dirtyData.sparkConfig.props.Mode=2;dirtyData.sparkConfig.props["spark.serializer"]="org.apache.spark.serializer.KryoSerializer";modeList=addLabeledControl.call(box,mstrmojo.desc(7776,"Authentication Mode:"),{isHostedWithin:false,scriptClass:"mstrmojo.ui.Pulldown",items:$AUTHMODE_ITEMS,postselectedIndexChange:function(evt){var modeItem=this.items[evt.value];dirtyData.sparkConfig.props.AuthMode=modeItem.did;}});addLabeledControl.call(box,mstrmojo.desc(15640,"Path of spark assembly JAR:"),{scriptClass:"mstrmojo.TextBox",value:data&&data.config.sparkConfig.props["spark.yarn.jar"]||"",onvalueChange:function(){dirtyData.sparkConfig.props["spark.yarn.jar"]=this.value;}});if(isNew){modeList.set("selectedIndex",0);}break;}}}});if(data.config.sparkConfig.props.Mode==="0"){list.set("selectedIndex",0);}else{if(data.config.sparkConfig.props.Mode==="1"){list.set("selectedIndex",1);}else{if(data.config.sparkConfig.props.Mode==="2"){list.set("selectedIndex",2);if(data.config.sparkConfig.props.AuthMode==="0"){modeList.set("selectedIndex",0);}else{if(data.config.sparkConfig.props.AuthMode==="1"){modeList.set("selectedIndex",1);}else{modeList.set("selectedIndex",0);}}}else{list.set("selectedIndex",0);}}}box=editor.addChildren([{scriptClass:"mstrmojo.ui.Checkbox",cssClass:"advanced-toggle",alias:"advancedToggler",oncheckedChange:function(){var editor=this.parent,children=editor.children,idx,box;idx=$ARR.find(children,"id",this.id);box=children[idx+2];if(box){box.set("visible",!box.visible);}}},{scriptClass:"mstrmojo.Label",cssClass:"section-header-advanced",text:mstrmojo.desc(702,"Advanced"),onclick:function(){var toggle=this.parent.advancedToggler;toggle.set("checked",!toggle.checked);}},{scriptClass:"mstrmojo.Box",cssClass:"section-box"}])[2];box.set("visible",false);addLabeledControl.call(box,mstrmojo.desc(14947,"Memory of driver:"),{scriptClass:"mstrmojo.TextBox",value:data&&data.config.sparkConfig.props["spark.driver.memory"]||"",onvalueChange:function(){dirtyData.sparkConfig.props["spark.driver.memory"]=this.value;}});addLabeledControl.call(box,mstrmojo.desc(14948,"Memory of executor:"),{scriptClass:"mstrmojo.TextBox",value:data&&data.config.sparkConfig.props["spark.executor.memory"]||"",onvalueChange:function(){dirtyData.sparkConfig.props["spark.executor.memory"]=this.value;}});addLabeledControl.call(box,mstrmojo.desc(14963,"Cores of executor:"),{scriptClass:"mstrmojo.TextBox",value:data&&data.config.sparkConfig.props["spark.executor.cores"]||"",onvalueChange:function(){dirtyData.sparkConfig.props["spark.executor.cores"]=this.value;}});addLabeledControl.call(box,mstrmojo.desc(14949,"Optional:"),{scriptClass:"mstrmojo.TextArea",alias:"option",onvalueChange:function(){this.parent.parent.parent.option=this.value;},bindings:{value:function(){var str="";var obj=data.config.sparkConfig.props;if(obj){for(var i in obj){if(i!=="AuthMode"&&i!=="spark.driver.memory"&&i!=="spark.executor.memory"&&i!=="spark.executor.cores"&&i!=="spark.master"&&i!=="Mode"&&i!=="spark.serializer"&&i!=="spark.yarn.jar"){str+=i+" = "+obj[i]+"\n";}}}return str;}}});editor.addChildren([{slot:"buttonNode",scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-Button mstrmojo-WebButton mstrmojo-Editor-button delete hot",text:mstrmojo.desc(629,"Delete"),visible:!isNew,onclick:function(){var dialog=this.parent;var msg=mstrmojo.desc(14957,"Do you want to undeploy and delete it?\nThe Hadoop Gateway will be undeployed first, and deleted from the list.");mstrmojo.confirm(msg,{confirmBtn:{fn:function(){var cfg=$HASH.copy(dialog.dirtyData,dialog.data.config);mstrApp.getRootController().getHadoopGatewayController().deleteGateway(cfg,{success:function(){dialog.close();}});}}});}},{slot:"buttonNode",scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-Button mstrmojo-WebButton mstrmojo-Editor-button cancel",text:mstrmojo.desc(221,"Cancel"),onclick:function(){var editor=this.parent;editor.close();}},{slot:"buttonNode",scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-Button mstrmojo-WebButton mstrmojo-Editor-button save",text:mstrmojo.desc(118,"Save"),onclick:function(){var hgController=mstrApp.getRootController().getHadoopGatewayController(),dialog=this.parent,cfg,editor;var callbackEdit={success:function(){editor.close();dialog.close();}};var callbackNew={success:function(){dialog.close();}};cfg=combineData(dialog.dirtyData,dialog.data.config);cfg.sshPort=22;if(cfgValidityCheck(cfg)&&optionValid(dialog.option)){if(dialog.option){var optionArr=dialog.option.split("\n");for(var i=0;i<optionArr.length;i++){if(optionArr[i].trim()!==""){var mid=(optionArr[i].trim()).split("=");var midA=mid[0].trim();dialog.dirtyData.sparkConfig.props[midA]=mid[1].trim();}}cfg=combineData(dialog.dirtyData,dialog.data.config);}if(isNew){hgController.createGateway(cfg,callbackNew);}else{cfg=combineData(dialog.dirtyData,dialog.data.config);var msg=mstrmojo.desc(null,"Your changes have been saved. Click Yes to redeploy Hadoop Gateway for the changes to take effect. Or click No to redeploy later.");mstrmojo.confirm(msg,{confirmBtn:{fn:function(){hgController.confirmAuthentication(function(user,password){editor=this;dirtyData.user=user;dirtyData.passwd=password;cfg=combineData(dialog.dirtyData,dialog.data.config);hgController.updateGateway(cfg,callbackNew);hgController.updateSparkConfig(cfg,callbackEdit);});}},cancelBtn:{fn:function(){hgController.updateGateway(cfg,callbackNew);}}});}}}},{slot:"buttonNode",scriptClass:"mstrmojo.Button",cssClass:isNew?"mstrmojo-Button mstrmojo-WebButton mstrmojo-Editor-button deploy hot":"mstrmojo-Button mstrmojo-WebButton mstrmojo-Editor-button deploy",text:mstrmojo.desc(14936,"Deploy"),visible:isNew,onclick:function(){var hgController=mstrApp.getRootController().getHadoopGatewayController(),dialog=this.parent,data=dialog.data,dirtyData=dialog.dirtyData,cfg,editor;var callbackNone={success:function(){}};cfg=combineData(dialog.dirtyData,data.config);cfg.sshPort=22;function doDeploy(){var callback={success:function(){hgController.installGateway(cfg,{success:function(){editor.close();dialog.close();}});}};if(isNew){hgController.createGateway(cfg,callback);hgController.updateSparkConfig(cfg,callbackNone);}else{hgController.updateGateway(cfg,callback);}}if(cfgValidityCheck(cfg)&&optionValid(dialog.option)){if(dialog.option){var optionArr=dialog.option.split("\n");for(var i=0;i<optionArr.length;i++){if(optionArr[i].trim()!==""){var mid=(optionArr[i].trim()).split("=");var midA=mid[0].trim();dialog.dirtyData.sparkConfig.props[midA]=mid[1].trim();}}cfg=combineData(dialog.dirtyData,dialog.data.config);}hgController.confirmAuthentication(function(user,password){editor=this;dirtyData.user=user;dirtyData.passwd=password;cfg=$HASH.copy(dirtyData,dialog.data.config);doDeploy();});}}}]);}});}());