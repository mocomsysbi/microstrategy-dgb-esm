(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.DI.DIConstants","mstrmojo.List","mstrmojo.Label","mstrmojo.DI.DIHelpers","mstrmojo.TextArea","mstrmojo.Widget","mstrmojo.dom","mstrmojo.DI.DIDragFiles");mstrmojo.requiresDescs(12512,12741,16210,12745,13030);function isValidProtocol(urlText){urlText=urlText.toLowerCase();urlText=urlText.replace(/\s+/g," ");return(urlText.indexOf("file://")===0)||(urlText.indexOf("ftp://")===0)||(urlText.indexOf("http://")===0)||(urlText.indexOf("https://")===0)||(urlText.indexOf("hdfs://")===0);}function isURLSupported(urlText){var support={protocolDisabled:false,protocol:""};urlText.toLowerCase();urlText.replace(/\s+/g," ");return support;}function getCurrentSource(){var m=this.model;var source;if(this.currentSource){source=this.currentSource;}else{source=m.currentSource;}return source;}var constants=mstrmojo.DI.DIConstants;var extractFileName=mstrmojo.DI.DIHelpers.extractFileNameFromHadoopURL;var extractFileExtension=mstrmojo.DI.DIHelpers.extractFileExtensionFromHadoopURL;function isNonRecognizedExtension(extension){return !/csv|txt|avro|parquet|parq|orc|json/.test(extension&&extension.toLowerCase());}function extensionCheck(page,callback){if(page.tooltip!=null&&page.tooltip.close){page.tooltip.close();}var extensions=mstrmojo.array.filter(constants.fileTypes,function(item,index){return item.visible!==false;});var dragzone=page.getDropZone();var noExtUrls=[];mstrmojo.array.forEach(dragzone.urls,function(url){if(dragzone.isFolder(url)||!/.+\..+/.test(extractFileName(url))||isNonRecognizedExtension(extractFileExtension(url))){noExtUrls.push(url);}});if(noExtUrls.length===0){callback();return ;}mstrmojo.insert({scriptClass:"mstrmojo.Dialog",id:"extensionCheck",title:mstrmojo.desc(15146,"Confirm File Type")+'<div class="mstrmojo-Button di-title-btn mstrmojo-di-close"><div class="mstrmojo-Button-text ">&nbsp;</div></div><div class="mstrmojo-Button di-title-btn mstrmojo-di-help"><div class="mstrmojo-Button-text ">&nbsp;</div></div>',btnAlignment:"right",cssClass:"mojo-di-filetype mstrmojo-Dialog  modal",buttons:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton hot",text:mstrmojo.desc(1442,"OK"),postBuildRendering:function(){this.domNode.focus();},onclick:function(evt){page.getDropZone().fileTypeMap=this.parent.parent.content.getFileType();mstrmojo.tooltip.close();mstrmojo.all.extensionCheck.destroy();callback();}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton",text:mstrmojo.desc(2140,"Cancel"),onclick:function(evt){mstrmojo.tooltip.close();mstrmojo.all.extensionCheck.destroy();}}],children:[{scriptClass:"mstrmojo.Label",cssText:"text-align:left",text:mstrmojo.desc(15137,"Please confirm file types for following files or folders. The files or folder without appropriate types will not be imported.")},{scriptClass:"mstrmojo.Container",alias:"content",markupString:'<div><table class="fileExtensionTable"><thead><tr><th>'+mstrmojo.desc(12545,"Files")+"</th><th>"+mstrmojo.desc(15138,"File Type")+"</th></tr></thead><tbody></tbody></table></div>",markupSlots:{tbody:function(){return this.domNode.firstChild.children[1];}},postBuildRendering:function(){var str="";var tr,td,select,isFolder;this.parent.titleNode.querySelector(".di-title-btn.mstrmojo-di-close").onclick=this.parent.buttons[1].onclick;var setOptoins=function(select){mstrmojo.array.forEach(extensions,function(item){var op=document.createElement("option");op.innerHTML=item.n;op.value=item.v||item.n;select.appendChild(op);});return select;};tr=document.createElement("tr");var dropdown=(function($this){var td=document.createElement("td");var select=document.createElement("select");select.onchange=function(){mstrmojo.array.forEach($this.tbody.querySelectorAll("select"),function(item){item.value=this.value;},this);};td.appendChild(setOptoins(select));return{td:td,select:select};})(this);var checkall=(function($this,select){var td=document.createElement("td");var checkall=document.createElement("input");checkall.type="checkbox";checkall.checked=true;checkall.onclick=function(){if(this.checked){select.disabled=false;var selects=$this.tbody.querySelectorAll("select");for(var i=1;i<selects.length;i++){selects[i].value=select.value;}}else{select.disabled=true;}};td.appendChild(checkall);var lab=document.createElement("label");lab.innerHTML=mstrmojo.desc(15144,"All Files");td.appendChild(lab);return{td:td,input:checkall};})(this,dropdown.select);tr.appendChild(checkall.td);tr.appendChild(dropdown.td);this.tbody.appendChild(tr);mstrmojo.array.forEach(noExtUrls,function(url){tr=document.createElement("tr");td=document.createElement("td");isFolder=dragzone.isFolder(url);td.innerHTML='<img border="0" class="'+(isFolder?"mstrmojo-di-tree-node-icon folder-closed":"mstrmojo-di-tree-node-icon text-doc")+'" src="../images/1ptrans.gif" />'+extractFileName(url);tr.appendChild(td);td=document.createElement("td");select=document.createElement("select");select.dataset.url=url;select.onchange=(function(checkbox){return function(){if(checkbox.checked){checkbox.checked=false;checkbox.onclick();}};})(checkall.input);td.appendChild(setOptoins(select));tr.appendChild(td);this.tbody.appendChild(tr);},this);return true;},getFileType:function(){var types=this.tbody.querySelectorAll("select[data-url]");var maps={};mstrmojo.array.forEach(types,function(type){maps[type.dataset.url]=type.value;});return maps;}}],postBuildRendering:function(){this.containerNode.style.borderTop="1px solid #DEDEDE";mstrmojo.Dialog.prototype.postBuildRendering.call(this);}}).render();}function doImport(action){var i,urlList=this.getDropZone(),tableID=this.tableID||null,urls=[],list=urlList.urls;mstrmojo.hash.copy(urlList.urls,urls);var controller=mstrApp.getRootController();var isPartition=false;if(tableID&&list&&list.length>1){var source=this.model&&this.model.getImportSource(tableID);if(source&&source.sourceInfo&&source.sourceInfo.url){var partition=source.sourceInfo.partition;if(partition&&partition.isPartition){isPartition=true;}}if(!isPartition){controller.displayError(mstrmojo.desc(12741,"You can upload only one file when refresh a table."));return ;}}var showPreview=true;var urlSupport,msg;if(typeof String.prototype.trim!=="function"){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"");};}for(i=0;i<urls.length;i++){var url=urls[i].trim();urls[i]=url.match(/.+\?hdfsURL=(.+)/);urls[i]=urls[i]?urls[i][1]:url;if(!isValidProtocol.call(this,url)){controller.displayError(mstrmojo.desc(12512,"We do not support the URL protocol you provided."),false);return ;}urlSupport=isURLSupported.call(this,url);if(urlSupport.protocolDisabled){msg=mstrmojo.desc(13030,"Unable to fetch data. Importing files using ## has been disabled by the administrator.").replace("##",urlSupport.protocol);controller.displayError(msg,false);return ;}}controller.importURLEMMA(urlList,urls,showPreview,!controller.model.hasEMMAReportInstance(),this.id,true,action);}function cancelAggFilter(tableID,callback){var dataService=mstrApp.getRootController().dataService;dataService.cancelAggFilter({success:function success(res,req){dataService.set("messageID",res.msgid);var importSources=mstrApp.getRootController().model.importSources,tableInfo=importSources&&importSources[req.params&&req.params.tbid];if(tableInfo&&tableInfo.sourceInfo){tableInfo.sourceInfo.hasAggFilter=0;}callback();}},{tbid:tableID});}mstrmojo.DI.DIHadoop=mstrmojo.declare(mstrmojo.DI.DIDragFiles,null,{scriptClass:"mstrmojo.DI.DIHadoop",cssClass:"mstrmojo-rootview-hadoop di-connector-panel",supportFolderDrag:true,sizeTooltip:true,folderSizeTooltip:true,controller:null,dbRoleSavedEvt:null,dbRoleLoadedEvt:null,tooltipOpenDelay:0,tooltips:'<div class="tooltip-content"><p>'+mstrmojo.desc(15142,"All files dragged inside need to conform to following filename extensions, including .csv, .txt, .avro, .parquet and .orc. Files without these extensions will need to confirm file types.")+"</p><p>"+mstrmojo.desc(15143,"All files inside a folder will be treated as having one kind of extension; sub-folders inside this folder will not be imported.")+'</p></div><div class="tooltip-close-btn mstrmojo-Button di-title-btn mstrmojo-di-close">&nbsp;</div>',createTitleWidget:function createTitleWidget(){var cfg={dbRoleName:"Hadoop Connection",cssClass:"di-hadoop-titleWidget",children:[{scriptClass:"mstrmojo.Label",cssClass:"di-connector-title-database"},{scriptClass:"mstrmojo.Label",cssClass:"di-connector-title",bindings:{text:"this.parent.dbRoleName"}},{scriptClass:"mstrmojo.Label",cssClass:"di-connector-title-refresh",onclick:function(){var controller=mstrApp.getRootController();controller.hadoopController.loadBDEDBRole();}},{scriptClass:"mstrmojo.Label",text:"(##)".replace("##",mstrmojo.desc(16210,"Change Connection")),cssClass:"di-connector-title-connection",bindings:{visible:function(){return mstrApp.diParams.useDatabaseInstanceManager?true:false;}},onclick:function(){var controller=mstrApp.getRootController(),dbRole=controller.hadoopController.dbRole;controller.hadoopController.renderDBRoleEditor(dbRole);}}]};return new mstrmojo.Box(cfg);},ondrop:function ondrop(evt){if(!this.droppable){return ;}var selectedNodes=evt.src.data,selectedNode,i,controller=mstrApp.getRootController(),list=this.urls;if(controller.model.isDirectDataAccess&&(controller.model.operationMode!==constants.operationMode.edit)&&(list.length+selectedNodes.length)>1){var msg=mstrmojo.desc(12745,"Live mode Cube with multiple files or folders from HDFS is not supported yet. Please keep only one file or folder and remove others.");controller.displayError(msg,false);return ;}if(this.parent.parent.parent.refreshMode){mstrmojo.array.forEach(this.children,function(item){this.removeURL(item.url);},this);selectedNode=selectedNodes[0];if(selectedNode){this.addURL(selectedNode.data.address,selectedNode.text,selectedNode.data.isFolder);}}else{for(i=0;i<selectedNodes.length;i++){selectedNode=selectedNodes[i];this.addURL(selectedNode.data.address,selectedNode.text,selectedNode.data.isFolder);}}mstrmojo.css.removeClass(this.dnDNode,"dragging");},browseFunction:function browseFunction(node){return mstrApp.getRootController().hadoopController.hadoopBrowserFunction(node);},refreshFunction:function refreshFunction(){mstrApp.getRootController().hadoopController.browseHadoop(this.rootUrl,this);},preBuildRendering:function preBuildRendering(){var contentPanel,objectListPanel,browser;if(this._super){this._super();}this.controller=mstrApp.getRootController();this.controller.hadoopController.loadBDEDBRole(this.tableID);contentPanel=this.mainPage.content;objectListPanel=contentPanel.objectListPanel;browser=objectListPanel.browser;contentPanel.urlList.set("ondrop",this.ondrop);browser.set("browseFunction",this.browseFunction);browser.set("refreshFunction",this.refreshFunction);browser.set("editFunction",this.editFunction);browser.set("supportFolderDrag",this.supportFolderDrag);browser.set("sourceObjectsInfo",this.sourceObjectsInfo);browser.set("autoSelectNode",this.autoSelectNode);browser.set("container",this);browser.set("sizeTooltip",this.sizeTooltip);browser.set("folderSizeTooltip",this.folderSizeTooltip);browser.set("filterType",this.filterType);browser.set("dblClickNodeFunction",function(node){if((node.data.isFolder&&this.supportFolderDrag)||!node.data.isFolder){contentPanel.urlList.ondrop({src:{data:[node]}});}});},postBuildRendering:function postBuildRendering(){if(this._super){this._super();}var label=(function($this){var label=document.createElement("label");label.innerHTML='<div class="mstrmojo-Label mstrmojo-Search-infoIcon mstrmojo-di-ui-dialogs-DIHierarchyAttributeDialog-mapsListHeader-infoIcon" style="display: inline-block;cursor:pointer;"></div>'+mstrmojo.desc(15145,"File Type Rules");label.style.cursor="pointer";$this.tooltip=new mstrmojo.Tooltip({updateScrollbars:function(){mstrmojo.Tooltip.prototype.updateScrollbars.call(this);var btn=this.contentNode.querySelector(".tooltip-close-btn");btn.id=Math.random();btn.onclick=function(){$this.tooltip.close();};}});label.onclick=function(e){if($this.tooltip.visible){$this.tooltip.close();}else{$this.tooltip.open({richTooltip:{cssClass:"vi-regular vi-tooltip-V mojo-theme-light fileTypeTooltip",content:$this.tooltips,posType:mstrmojo.tooltip.POS_BOTTOMLEFT,refNode:this,top:-10,left:-10}},{e:e});$this.tooltip.domNode.style.zIndex=$this.controller.dialogController.getNextZIndex();$this.tooltip.visible=true;}};return label;})(this);this.mainPage.content.urlList.domNode.appendChild(label);if(this.dbRoleSavedEvt){this.model.detachEventListener(this.dbRoleSavedEvt);}if(this.dbRoleLoadedEvt){this.model.detachEventListener(this.dbRoleLoadedEvt);}this.dbRoleSavedEvt=this.model.attachEventListener("HadoopDBRoleSaved",this.id,this.handleDBRoleSaved);this.dbRoleLoadedEvt=this.model.attachEventListener("BDEDBRoleLoaded",this.id,this.handleDBRoleLoaded);this.model.attachEventListener("windowSizeChanged",this.id,this.changeSize);this.controller.sourceSelected(false);if(window.localStorage){if(window.localStorage.getItem(constants.localStorageKey.HGOSFileTypeTooltipPop)==null){window.localStorage.setItem(constants.localStorageKey.HGOSFileTypeTooltipPop,new Date().getTime());setTimeout(function(){label.onclick();},500);}}this.resizeHandler=function(){if(resizeTimer){clearTimeout(resizeTimer);}var resizeTimer=setTimeout(function(){label.onclick();label.onclick();},500);};mstrmojo.dom.attachEvent(window,"resize",this.resizeHandler,true);},handleDBRoleSaved:function handleDBRoleSaved(){var controller=mstrApp.getRootController();controller.hadoopController.loadBDEDBRole();},handleDBRoleLoaded:function handleDBRoleLoaded(){if(this.controller.rootView.currentPage.id!==this.id){return ;}var hadoopController=this.controller.hadoopController;var dbRoleId=hadoopController.dbRoleID;if(dbRoleId){var rootURL=hadoopController.hadoopConnURL;this.setRootURL(rootURL);this.refreshBrowser();this.setFilesForRefreshData();var title=this.getTitleWidget();title.set("dbRoleName",hadoopController.dbRole.n);}else{hadoopController.renderDBRoleEditor();}},setFilesForRefreshData:function setFilesForRefreshData(){var tableId=this.tableID;var source=this.model&&this.model.getImportSource(tableId);if(source&&source.sourceInfo&&source.sourceInfo.url){var path=source.sourceInfo.url;var partition=source.sourceInfo.partition;var dropZone=this.getDropZone();if(partition&&partition.isPartition){var i;for(i=0;i<partition.tables.length;i++){dropZone.addURL(partition.tables[i].name,extractFileName(partition.tables[i].name),false);}}else{dropZone.addURL(path,extractFileName(source.sourceInfo.dbTableName),false,path);}}},onHelpButtonClick:function onHelpButtonClick(){return"importing_data_from_a_Hadoop_file_browser.htm";},onNextButtonClick:function onNextButtonClick(){extensionCheck(this,(function($this){return function(){var model=mstrApp.getRootController().getModel(),table=model.importSources[$this.tableID],action=$this.tableID?constants.actions.refreshData:constants.actions.importSource;if($this.tableID&&table.sourceInfo&&table.sourceInfo.hasAggFilter){mstrmojo.confirm(mstrmojo.desc(12720,"Previous changes made in aggregation will be discarded. Would you like to continue?"),{confirmBtn:{fn:function(){cancelAggFilter($this.tableID,function(){doImport.call($this,action);});}}});}else{doImport.call($this,action);}};})(this));},onFinishButtonClick:function(){extensionCheck(this,(function($this){return function(){doImport.call($this,constants.actions.savePublish);};})(this));},onBackButtonClick:function onBackButtonClick(){if(this.tooltip!=null&&this.tooltip.close){this.tooltip.close();}this.controller.showPage(constants.pageType.dataSelection);},setFilesObject:function setFilesObject(urls){var urlList=this.getDropZone();urlList.setURLsObject(urls);},destroy:function(skipCleanup){if(this.tooltip!=null&&this.tooltip.close){this.tooltip.close();}mstrmojo.Container.prototype.destroy.call(this,skipCleanup);mstrmojo.dom.detachEvent(window,"resize",this.resizeHandler,true);}});}());