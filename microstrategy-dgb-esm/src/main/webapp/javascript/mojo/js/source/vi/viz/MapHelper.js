(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.array","mstrmojo.vi.viz.EnumDSSDropZones","mstrmojo.vi.viz.DropZoneHelper","mstrmojo.gmaps.MapEnums","mstrmojo.gm.GMEnums","mstrmojo.VisEnum");var $MOJO=mstrmojo,$ARR=$MOJO.array,$EDZ=$MOJO.vi.viz.EnumDSSDropZones,$HASH=$MOJO.hash,$GMAPS=$MOJO.gmaps,$VIS_ENUM=mstrmojo.VisEnum,$Legend_Property=$VIS_ENUM.LegendPropertyTag,$Maps_Properties=$VIS_ENUM.MAPS_PROPERTIES,$EnumPropertyType=$GMAPS.EnumPropertyType,$EnumZoomBehavior=$GMAPS.EnumZoomBehavior,$EnumGraphicType=$GMAPS.EnumGraphicType,$EnumClusterMode=$GMAPS.EnumClusterMode,$EnumGeographicRole=$GMAPS.EnumGeographicRole,$EnumBaseMapType=$GMAPS.EnumBaseMapType,$EnumLanguageType=$GMAPS.EnumLanguageType,ENUM_LEGEND_MODE=$VIS_ENUM.EnumLegendMode,PRP_LEGEND_SLOT=mstrmojo.gm.EnumLegendSlot,ENUM_SINGLE_LEGEND_MODE=$VIS_ENUM.EnumSingleLegendMode,REG_SPLIT32=new RegExp(".{32}","g"),$MH;mstrmojo.vi.viz.MapHelper=mstrmojo.declare(mstrmojo.vi.viz.DropZoneHelper,null,{scriptClass:"mstrmojo.vi.viz.MapHelper",widget:null,data:null,vp:null,geoAttribute:null,latitude:null,longitude:null,slice:[],angle:null,colorBy:null,sizeBy:null,tooltip:null,markerType:null,useAttributeForm:null,supportAreaMap:true,defaultView:null,init:function init(props){this._super(props);this.tooltip=[];this.data=this.data||{};this.vp=this.data.vp||{};},setWidget:function setWidget(w){if(!w){return ;}var visMapBase=w.fnGetWidget(),key=w.k,vp=w.node&&w.node.data&&w.node.data.vp;this.widget=w;this.geoAttribute=getFirstUnitId(w,$EDZ.GeoAttribute);this.latitude=getFirstUnitId(w,$EDZ.Latitude);this.longitude=getFirstUnitId(w,$EDZ.Longitude);this.angle=getFirstUnitId(w,$EDZ.Angle);this.colorBy=getFirstUnitId(w,$EDZ.ColorBy);this.sizeBy=getFirstUnitId(w,$EDZ.SizeBy);this.tooltip=visMapBase.getDropZoneItems($EDZ.AdditionalMetrics,key).map(function(item){return item.id;});this.slice=visMapBase.getDropZoneItems($EDZ.SliceBy,key).map(function(item){return item.id;});if(vp){this.markerType=vp.mtp;this.useAttributeForm=vp[$EnumPropertyType.useAttributeForm];this.defaultView=vp.dv;}},getGeoUnit:function getGeoUnit(){return getFirstUnitInZone(this.widget,$EDZ.GeoAttribute);},getLatitudeUnit:function getLatitudeUnit(){return getFirstUnitInZone(this.widget,$EDZ.Latitude);},getLongitudeUnit:function getLongitudeUnit(){return getFirstUnitInZone(this.widget,$EDZ.Longitude);},getAngleUnit:function getAngleUnit(){return getFirstUnitInZone(this.widget,$EDZ.Angle);},getColorByUnit:function getColorByUnit(){return getFirstUnitInZone(this.widget,$EDZ.ColorBy);},getSizeByUnit:function getSizeByUnit(){return getFirstUnitInZone(this.widget,$EDZ.SizeBy);},getSliceByUnits:function getSliceByUnits(){var visMapBase=this.widget.fnGetWidget();return visMapBase.getDropZoneItems($EDZ.SliceBy,this.widget.k);},getTooltipUnits:function getTooltipUnits(){var visMapBase=this.widget.fnGetWidget();return visMapBase.getDropZoneItems($EDZ.AdditionalMetrics,this.widget.k);},setMapType:function(tp){this.vp.gtp=tp;},getMapType:function(){return this.vp.gtp;},getLayerName:function(){return this.vp.ln;},setShapeFile:function(id){this.vp.lid=id;},setUseAttributeForm:function setUseAttributeForm(af){this.useAttributeForm=af?$MH.USE_ATTRIBUTE_FORM:$MH.USE_ATTRIBUTE;},getGeoForm:function getGeoForm(item,fn){var fs=item&&item.fs,r=null;if(!fn){fn=function(){return true;};}if((item.otp===12||item.t===12)&&fs){$ARR.forEach(fs,function(f){if(fn(f)){r=f;return false;}});}return r;},getLatitudeForm:function getLatitudeForm(item){return this.getGeoForm(item,function(f){return $MH.isLatitude(f.fnm,f.fgr)&&f.obf;});},getLongitudeForm:function getLongitudeForm(item){return this.getGeoForm(item,function(f){return $MH.isLongitude(f.fnm,f.fgr)&&f.obf;});},getXml:function getXml(){var vp=this.vp,tooltip=this.tooltip,useAttributeForm=this.useAttributeForm;vp[$Legend_Property.LEGEND_MODE]=vp[$Legend_Property.LEGEND_MODE]||ENUM_LEGEND_MODE.RESTORED.toString();vp[$Legend_Property.LEGEND_POSITION]=vp[$Legend_Property.LEGEND_POSITION]||PRP_LEGEND_SLOT.RIGHT_MIDDLE.toString();vp[$Maps_Properties.SHOW_LEGEND]=vp[$Maps_Properties.SHOW_LEGEND]||"false";vp[$EnumPropertyType.collapseLegend]=vp[$EnumPropertyType.collapseLegend]||ENUM_SINGLE_LEGEND_MODE.RESTORE.toString();vp[$EnumPropertyType.legendSwitch]=vp[$EnumPropertyType.legendSwitch]||"false";vp[$EnumPropertyType.baseMapType]=vp[$EnumPropertyType.baseMapType]||$EnumBaseMapType.Reserved;vp[$EnumPropertyType.layerIdx]=vp[$EnumPropertyType.layerIdx]||0;vp[$EnumPropertyType.layerName]=vp[$EnumPropertyType.layerName]||mstrmojo.desc(14750,"Layer")+" 1";vp[$EnumPropertyType.isHidden]=vp[$EnumPropertyType.isHidden]||"0";vp[$EnumPropertyType.zoomSetting]=vp[$EnumPropertyType.zoomSetting]||$EnumZoomBehavior.Automatic;vp[$EnumPropertyType.clusterRadius]=50;vp[$EnumPropertyType.clusterMaxZoom]=22;vp[$EnumPropertyType.languageType]=$EnumLanguageType.English;vp[$EnumPropertyType.tooltipSwitch]=vp[$EnumPropertyType.tooltipSwitch]||"true";vp.ga=this.geoAttribute||"";vp.lat=this.latitude||"";vp.lng=this.longitude||"";vp.cmt=this.colorBy||"";vp.smt=this.sizeBy||"";if(useAttributeForm){vp[$EnumPropertyType.useAttributeForm]=useAttributeForm;}vp.tooltip="";if(tooltip){tooltip.forEach(function(item){vp.tooltip+=item;});}return $MH.getXmlFromJson(this.vp);},showColorByZone:function(vp){return $MH.canShowColorByZone(vp);},showSizeByZone:function(vp){return !!vp&&vp[$EnumPropertyType.graphicType]===$EnumGraphicType.Bubble;},showSliceZone:function(vp){return !!vp&&vp[$EnumPropertyType.graphicType]===$EnumGraphicType.Bubble;},showAngleZone:function(vp){return !!vp&&vp[$EnumPropertyType.graphicType]===$EnumGraphicType.Bubble||((vp[$EnumPropertyType.graphicType]===$EnumGraphicType.Marker)&&vp[$EnumPropertyType.clusterMode]===$EnumClusterMode.PIE);}});$MH=mstrmojo.vi.viz.MapHelper;$MH.zonesCfg=[{n:mstrmojo.desc(11661,"Geo Attribute"),id:$EDZ.GeoAttribute,prm:true,allowSingle:true,show:function(){return true;},v:function(vp){return _getItemIdFromProps(vp,$EnumPropertyType.geoAttribute);},onDel:function(vp){if(!!vp){vp[$EnumPropertyType.geoAttribute]="";vp[$EnumPropertyType.shapeFile]="";}},onAdd:function(vp,context){if(!!vp){vp[$EnumPropertyType.geoAttribute]=context.item.did;vp[$EnumPropertyType.useAttributeForm]=$MH.USE_ATTRIBUTE_FORM;vp[$EnumPropertyType.shapeFile]="";}}},{n:mstrmojo.desc(7696,"Latitude"),id:$EDZ.Latitude,prm:true,allowSingle:true,show:function(vp){if(!!vp){return(vp[$EnumPropertyType.graphicType]!==$EnumGraphicType.Area);}},v:function(vp){return _getItemIdFromProps(vp,$EnumPropertyType.latitude);},onDel:function(vp){if(!!vp){vp[$EnumPropertyType.latitude]="";}},onAdd:function(vp,context){var item=context.item;if(!!vp){vp[$EnumPropertyType.latitude]=item.did;vp[$EnumPropertyType.useAttributeForm]=item.t===21?$MH.USE_ATTRIBUTE_FORM:$MH.USE_ATTRIBUTE;}}},{n:mstrmojo.desc(7697,"Longitude"),id:$EDZ.Longitude,prm:true,allowSingle:true,show:function(vp){if(!!vp){return(vp[$EnumPropertyType.graphicType]!==$EnumGraphicType.Area);}},v:function(vp){return _getItemIdFromProps(vp,$EnumPropertyType.longitute);},onDel:function(vp){if(!!vp){vp[$EnumPropertyType.longitute]="";}},onAdd:function(vp,context){var item=context.item;if(!!vp&&!!item){vp[$EnumPropertyType.longitute]=item.did;vp[$EnumPropertyType.useAttributeForm]=item.t===21?$MH.USE_ATTRIBUTE_FORM:$MH.USE_ATTRIBUTE;}}},{n:mstrmojo.desc(6188,"Slice"),id:$EDZ.SliceBy,prm:true,allowSingle:false,show:function(vp){if(!!vp){return $MH.showSliceZone(vp);}},v:function(vp){if(!!vp){var ids=vp[$EnumPropertyType.slice];return ids&&ids.match(REG_SPLIT32);}},onDel:function(vp,context){var item=context&&context.item;if(!!vp&&item&&item.id&&vp[$EnumPropertyType.slice]){vp[$EnumPropertyType.slice]=vp[$EnumPropertyType.slice].replace(item.did,"");}},onAdd:function(vp,context){var slice=$EnumPropertyType.slice,item=context&&context.item;if(!!vp&&item){var ids=vp[slice]?vp[slice].match(REG_SPLIT32):[];ids.splice(context.idx,0,item.did);vp[slice]=ids.join("");}}},{n:mstrmojo.desc(14294,"Angle"),id:$EDZ.Angle,prm:true,allowSingle:true,show:function(vp){if(!!vp){return $MH.showAngleZone(vp);}},v:function(vp){return _getItemIdFromProps(vp,$EnumPropertyType.angle);},onDel:function(vp){if(!!vp){vp[$EnumPropertyType.angle]="";}},onAdd:function(vp,context){_addItemId2Props(vp,context,$EnumPropertyType.angle);}},{n:mstrmojo.desc(11662,"Color By"),id:$EDZ.ColorBy,prm:true,allowSingle:true,show:function(vp){return $MH.canShowColorByZone(vp);},v:function(vp){return _getItemIdFromProps(vp,$EnumPropertyType.colorby);},onDel:function(vp){if(!!vp){vp[$EnumPropertyType.colorby]="";}},onAdd:function(vp,context){_addItemId2Props(vp,context,$EnumPropertyType.colorby);}},{n:mstrmojo.desc(11663,"Size By"),id:$EDZ.SizeBy,prm:true,allowSingle:true,show:function(vp){if(!!vp){return $MH.canShowSizeByZone(vp);}},v:function(vp){return _getItemIdFromProps(vp,$EnumPropertyType.sizeby);},onDel:function(vp){if(!!vp){vp[$EnumPropertyType.sizeby]="";}},onAdd:function(vp,context){_addItemId2Props(vp,context,$EnumPropertyType.sizeby);}},{n:mstrmojo.desc(2962,"Tooltip"),id:$EDZ.AdditionalMetrics,prm:false,allowSingle:false,show:function(){return true;},v:function(vp){if(!!vp){var ids=vp[$EnumPropertyType.tooltip];return ids&&ids.match(REG_SPLIT32);}},onDel:function(vp,context){if(vp&&vp[$EnumPropertyType.tooltip]){vp[$EnumPropertyType.tooltip]=vp[$EnumPropertyType.tooltip].replace(context.item.did,"");}},onAdd:function(vp,context){var tooltip=$EnumPropertyType.tooltip;if(!!vp){var ids=vp[tooltip]?vp[tooltip].match(REG_SPLIT32):[];ids.splice(context.idx,0,context.item.did);vp[tooltip]=ids.join("");}}}];$MH.USE_ATTRIBUTE="0";$MH.USE_ATTRIBUTE_FORM="1";$MH.canShowColorByZone=function(vp){return !!vp&&(vp[$EnumPropertyType.graphicType]!==undefined)&&vp[$EnumPropertyType.graphicType]!==$EnumGraphicType.Density;};$MH.canShowSizeByZone=function(vp){return !!vp&&vp[$EnumPropertyType.graphicType]===$EnumGraphicType.Bubble;};$MH.showAngleZone=function(vp){if(!vp){return false;}return vp[$EnumPropertyType.graphicType]===$EnumGraphicType.Bubble||((vp[$EnumPropertyType.graphicType]===$EnumGraphicType.Marker)&&vp[$EnumPropertyType.clusterMode]===$EnumClusterMode.PIE);};$MH.showSliceZone=function(vp){return !!vp&&vp[$EnumPropertyType.graphicType]===$EnumGraphicType.Bubble;};$MH.supportImageThreshold=function(vp){return !!vp&&vp[$EnumPropertyType.graphicType]===$EnumGraphicType.Marker;};$MH.isLatitude=function isLatitude(n,gr){return gr===5||(n&&n.toLowerCase().indexOf("latitude")>-1);};$MH.isLongitude=function isLongitude(n,gr){return gr===6||(n&&n.toLowerCase().indexOf("longitude")>-1);};$MH.isAxisAttribute=function isAxisAttribute(attr){var fs=attr&&attr.fs,f;if(fs&&fs.length===1){f=fs[0];return !!f&&(f.fgr===5||f.fgr===6);}return false;};$MH.getXmlFromJson=function getXmlFromJson(vp){var xml=new mstrmojo.XMLBuilder();xml.addChild("widgetProps");xml.addChild("fmt");$HASH.forEach(vp,function(v,n){xml.addChild(n);xml.addAttribute("value",v);xml.closeElement();});xml.closeElement();xml.closeElement();return xml.toString();};$MH.isGeoRoleSupportArea=function isGeoRoleSupportArea(gr){gr=gr&&gr.toString();return gr===$EnumGeographicRole.EnumGeographicRoleCity||gr===$EnumGeographicRole.EnumGeographicRoleState||gr===$EnumGeographicRole.EnumGeographicRoleCountry||gr===$EnumGeographicRole.EnumGeographicRoleOther||gr===$EnumGeographicRole.EnumGeographicRoleZipCode||gr===$EnumGeographicRole.EnumGeographicRoleCounty;};$MH.zonesNeedSyncToTooltipZone=[$EDZ.GeoAttribute,$EDZ.SliceBy,$EDZ.Angle,$EDZ.SizeBy,$EDZ.ColorBy];$MH.shouldSyncItemToTooltipZone=function shouldSyncItemToTooltipZone(did,zoneId,tooltipItems){tooltipItems=$ARR.ensureArray(tooltipItems);return $MH.zonesNeedSyncToTooltipZone.indexOf(zoneId)>-1&&tooltipItems.indexOf(did)<0;};function getFirstUnitInZone(w,zoneId){var visMapBase=w.fnGetWidget(),key=w.k,items=visMapBase.getDropZoneItems(zoneId,key);return items[0];}function getFirstUnitId(w,zoneId,key){var item=getFirstUnitInZone(w,zoneId,key);return item?item.id:"";}function _getItemIdFromProps(vp,propertyName){if(!!vp){return vp[propertyName]?[vp[propertyName]]:[];}}function _addItemId2Props(vp,context,propertyName){var item=context.item;if(!!vp||!!item){vp[propertyName]=item.did;}return vp;}}());