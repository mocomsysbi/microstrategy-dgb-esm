(function(){mstrmojo.requiresCls("mstrmojo.dom","mstrmojo.css","mstrmojo.string","mstrmojo.Widget");var DEL_LIST=["(",")","{","}","-","+","*","/","<",">","=","|","~",","," ","\t","\n",";",'"'],DEL_MAP=null;function _isDelimiter(c){if(!DEL_MAP){DEL_MAP={};var i,len;for(i=0,len=DEL_LIST.length;i<len;i++){DEL_MAP[DEL_LIST[i]]=true;}}return DEL_MAP[c];}mstrmojo.qb.FFsqlToken=mstrmojo.declare(mstrmojo.Widget,null,{scriptClass:"mstrmojo.qb.FFsqlToken",data:null,markupString:'<span id={@id} class="mstrmojo-token {@cssClass}"></span>',active:false,dropZone:true,allowDrop:function allowDrop(ctxt){return this.dropZone;},ondrop:function(e){mstrmojo.all.FFsql.ondrop(e);},markupMethods:{ondataChange:function(){var d=this.data;if(d.v===","){this.domNode.innerHTML=mstrmojo.string.encodeHtmlString(String(d.v));}else{if(d.v=="\n"){this.domNode.innerHTML="<br>";}else{this.domNode.innerHTML=mstrmojo.string.encodeHtmlString(String(d.v));}}mstrmojo.css.toggleClass(this.domNode,["mstr"],this.isMstrO());mstrmojo.css.toggleClass(this.domNode,["sql"],this.isSql());mstrmojo.css.toggleClass(this.domNode,["invalid"],d.sta===-1);},onactiveChange:function(){mstrmojo.css.toggleClass(this.domNode,["active"],this.active);if(!this.active){var ff=mstrmojo.all.FFsql;if(!this.isMstrO()&&!this.isDelimiter()){var items=ff.candidates.items,data=this.data,value=data.v.toLowerCase();mstrmojo.array.forEach(items,function(item){if(value===item.n.toLowerCase()){data.oi=item;return false;}});}mstrmojo.css.toggleClass(this.domNode,["mstr"],this.isMstrO());var outOfBracket=this.isOutOfBracket(ff.items,this.data.did);mstrmojo.css.toggleClass(this.domNode,["sql"],this.isSql()&&outOfBracket);}}},isOutOfBracket:function(items,did){var stmArray=items.map(function(i){return i.v;}),stmArrayDid=items.map(function(i){return i.did;}),curIdx=stmArrayDid.indexOf(did),curStmArray=stmArray.slice(0,curIdx+1),stm=curStmArray.join(""),numOfPrev=stm.split("[").length-1,numOfPost=stm.split("]").length-1,outOfBracket=numOfPrev<=numOfPost;return outOfBracket;},isMstrO:function isMstrO(){var data=this.data;return(!!data.oi&&data.oi.sta!==2)||!!data.rfd;},isSql:function isSql(){return this.data.oi&&this.data.oi.sta===100;},length:function length(){return this.data.v.length;},isDelimiter:function isDelimiter(){return this.data.isDelimiter||(this.length()===1&&_isDelimiter(this.data.v));},split2Tokens:function split2Tokens(offset,ic){var d=this.data,s=d&&d.v,sb=s.substring(0,offset),sa=s.substring(offset);return[{v:sb,isNew:true,did:d.did},{v:sa,isNew:true,did:ic}];},mergeTo:function mergeTo(w){var d=this.data,s=d&&d.v,ws=w.data.v;return{v:s+ws,isNew:true};},setItemInfo:function setItemInfo(it){var d=this.data;d.v=it.n;d.oi=it;d.sta=1;d.isNew=true;this.set("data",d);this.paint();},spliceContent:function spliceContent(offset,length,istChar){var d=this.data,s=d&&d.v,sb=s.substring(0,offset);if(istChar&&istChar!=="'"&&istChar.charAt(0)==="'"){istChar=istChar.substr(1);}length=(length===null||length===undefined)?(s.length-offset):length;var sa=s.substring(offset+length),ns=sb+(istChar||"")+sa;d.v=ns;d.isNew=true;d.sta=1;delete d.oi;this.set("data",d);this.paint();}});mstrmojo.qb.FFsqlToken.isDelimiter=_isDelimiter;})();