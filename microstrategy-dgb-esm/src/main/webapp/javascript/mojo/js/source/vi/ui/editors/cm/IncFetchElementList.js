(function(){mstrmojo.requiresClsP("mstrmojo","dom","array","string","hash");mstrmojo.requiresCls("mstrmojo.ui.ScrollableList","mstrmojo.ui._IsIncFetchList","mstrmojo.mstr.ElementsDataHelper");mstrmojo.requiresDescs(15595,15105);var $DESC=mstrmojo.desc,$H=mstrmojo.hash,$DOM=mstrmojo.dom,$ARR=mstrmojo.array,$STR=mstrmojo.string,$ENC=$STR.encodeHtmlString,DELEMITER="\u001E";mstrmojo.vi.ui.editors.cm.IncFetchElementList=mstrmojo.declare(mstrmojo.ui.ScrollableList,[mstrmojo.ui._IsIncFetchList],{scriptClass:"mstrmojo.vi.ui.editors.cm.IncFetchElementList",cssClass:"mstrmojo-IncFetchElementList",useRichTooltip:true,lastestReqId:null,init:function init(props){var me=this;this._super(props);this.ifDataHelper=new mstrmojo.mstr.ElementsDataHelper({browseConfig:{styleName:"MojoAttributeStyle",blockCount:50,useBrowseForm:1},_retrieveItems:function(bb,callbacks){var reqId=(me.lastestReqId||0)+1;me.lastestReqId=reqId;mstrApp.modelFactory.newElementDataService().getElements(this.getBrowseConfig(bb),{success:function(res){if(me.lastestReqId!=reqId){return ;}if(callbacks&&callbacks.success){callbacks.success({items:res.es,totalSize:res.sz,bc:res.bc});}},failure:function(details){if(me.lastestReqId!=reqId){return ;}if(callbacks&&callbacks.failure){callbacks.failure(details);}},complete:function(res){if(me.lastestReqId!=reqId){return ;}if(callbacks&&callbacks.complete){callbacks.complete(res);}}});},getItems:function(bb,callbacks,config){callbacks=callbacks||{};var me=this,fnEmpty=mstrmojo.emptyFn,fnSuccess=callbacks.success||fnEmpty,fnFail=callbacks.failure||fnEmpty,fnComplete=callbacks.complete||fnEmpty;this._retrieveItems(bb,{success:function(res){me.blockBegin=bb;me.blockCount=res.bc||30;me.set("items",(me.concat?(me.items||[]).concat(res.items||[]):(res.items||[])));if(res.totalSize!==undefined){me.totalSize=res.totalSize;}fnSuccess(res);},failure:function(res){fnFail(res);},complete:function(res){fnComplete(res);}},config);},});},getItemMarkup:function getItemMarkup(item,idx){return this._super(item,idx).replace("{@en@n}",'<div class="item-content">{@html}</div><div class="btn">'+$DESC(15595,"Set Parent")+"</div>");},getItemProps:function getItemProps(item,idx){var props=this._super(item,idx),pattern=this.ifDataHelper&&this.ifDataHelper.browseConfig&&this.ifDataHelper.browseConfig.searchPattern,filterRegExp;props.html=props.n;if(pattern){filterRegExp=new RegExp($STR.regEscape(pattern),"ig");if(filterRegExp.test(props.html)){props.html=props.html.replace(filterRegExp,function(match){return DELEMITER+match+DELEMITER;});}}props.html=$ENC(props.html);if(pattern){while(props.html.indexOf(DELEMITER)!==-1){props.html=props.html.replace(DELEMITER,"<em>").replace(DELEMITER,"</em>");}}return props;},showTooltip:function showTooltip(evt,win){var target=evt.target||$DOM.eventTarget(evt.hWin,evt.e),item=this.getItemFromTarget(target),position;if(target.classList.contains("item-content")&&(target.scrollWidth>target.clientWidth||!target.textContent)){position=$DOM.position(target);this.richTooltip={areaId:item._renderIdx,cssClass:"vi-regular vi-tooltip-V",posType:mstrmojo.tooltip.POS_BOTTOMLEFT,content:target.textContent||("<b>Name: </b>"+$ENC(item.n)+"<br><b>ID: </b>"+$ENC(item.v)),top:position.y,left:position.x};this._super(evt,win);}},onclick:function onclick(evt){try{if(evt.getTarget().classList.contains("btn")){this._super(evt);}else{evt.cancel();}}catch(ex){mstrApp.onerror(ex);}},ontoBeSelectedItemChange:function ontoBeSelectedItemChange(evt){if(this.toBeSelectedItem!==this.selectedItem&&this.hasRendered){var tbSelectedIdx=$ARR.find(this.items,"v",this.toBeSelectedItem&&this.toBeSelectedItem.v),tbSelectedItem=this.items&&this.items[tbSelectedIdx];if(!(tbSelectedItem&&!isNaN(tbSelectedItem._renderIdx))){tbSelectedItem={};return ;}this.doItemSelect(tbSelectedItem,{e:{}});}},startBrowsing:function startBrowsing(browseConfig,pattern){this.itemsContainerNode.innerHTML="<div class='item message loading'><div class='item-content'>"+$DESC(15105,"Loading data...")+"</div></div>";this.set("isFetching",true);this.updateScrollbars();$H.copy(browseConfig,this.ifDataHelper.browseConfig);if(pattern){this.ifDataHelper.browseConfig.searchPattern=pattern;}else{delete this.ifDataHelper.browseConfig.searchPattern;}this.ifDataHelper.set("blockBegin",1);this.ifDataHelper.set("items",null);var me=this,setItems=function(res){me.inWaitPos=0;me.set("items",res.items);me.ifDataHelper.set("items",res.items);me.initScroll();if(!res.items||res.items.length===0){me.itemsContainerNode.innerHTML="<div class='item message'><div class='item-content'>"+res.message+"</div></div>";me.updateScrollbars();}},callback={success:function(res){if(!res.message){res.message=$DESC(13779,"No elements match your search");}setItems(res);if(res.items&&me._scroll){me._scroll();}},failure:function(res){setItems(res);},complete:function(res){me.set("isFetching",false);}};this.ifDataHelper.getItems(1,callback);},preNext:function prevNext(){if(!this.inWaitPos&&this.items&&this.items.length){this.itemsContainerNode.innerHTML+="<div class='item message loading'><div class='item-content'>"+$DESC(15105,"Loading data...")+"</div></div>";this.updateScrollbars();this.inWaitPos=this.items.length;}},postNext:function postNext(){if(this.inWaitPos>0){var me=this,waitItems=Array.apply(null,this.itemsContainerNode.getElementsByClassName("loading"));waitItems.forEach(function(item){me.itemsContainerNode.removeChild(item);});this.inWaitPos=0;this.updateScrollbars();}},postBuildRendering:function postBuildRendering(){this._super();var tbSelectedIdx=$ARR.find(this.items,"v",this.toBeSelectedItem&&this.toBeSelectedItem.v),tbSelectedItem=this.items&&this.items[tbSelectedIdx];if(tbSelectedItem&&!isNaN(tbSelectedItem._renderIdx)){this.doItemSelect(tbSelectedItem,{e:{}});}},addItems:function addItems(items){var tbSelectedIdx=$ARR.find(items,"v",this.toBeSelectedItem&&this.toBeSelectedItem.v);if(tbSelectedIdx!==-1){tbSelectedIdx+=this.items&&this.items.length||0;this.selectedIndices={};this.selectedIndices[tbSelectedIdx]=true;}this._super(items);}});}());