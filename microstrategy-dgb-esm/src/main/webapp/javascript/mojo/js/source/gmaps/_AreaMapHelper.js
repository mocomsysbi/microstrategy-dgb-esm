(function(){mstrmojo.requiresCls("mstrmojo.gmaps.MapEnums");var $Gmaps=mstrmojo.gmaps,$EnumGeographicRole=$Gmaps.EnumGeographicRole,$EnumBaseMapType=$Gmaps.EnumBaseMapType,$EnumPolygonSource=$Gmaps.EnumPolygonSource,SCOPE_MAPBOX_STATISTICAL="4-s";function isCustomShape(shape){return !!(shape&&shape.custom&&(shape.custom==="true"||shape.custom===true));}mstrmojo.gmaps._AreaMapHelper=mstrmojo.provide("mstrmojo.gmaps._AreaMapHelper",{_mixinName:"mstrmojo.gmaps._AreaMapHelper",getAvailableShapes:function getAvailableShapes(shapes,layers,geoRole,baseMapType){var availShapeArr=[],shape,i,il;if(!shapes||geoRole==undefined){return availShapeArr;}if(baseMapType===$EnumBaseMapType.Mapbox){return this.getShapesForMapbox(shapes,layers);}for(i=0,il=shapes.length;i<il;i++){shape=shapes[i];if(baseMapType!==$EnumBaseMapType.Esri&&!isCustomShape(shape)){continue;}if(this.isMapBoxShapeConfig(shape,layers)){continue;}if(geoRole===$EnumGeographicRole.EnumGeographicRoleNone||geoRole===$EnumGeographicRole.EnumGeographicRoleOther&&isCustomShape(shape)||geoRole==shape.roleId){availShapeArr.push(shape);}}return availShapeArr;},getShapesForMapbox:function getShapesForMapbox(shapes,layers){var availShapeArr=[],shape,i,il;for(i=0,il=shapes.length;i<il;i++){shape=shapes[i];if(this.isMapBoxShapeConfig(shape,layers)){shape.supportedGeoRoles=[shape.roleId];if(shape.roleId===$EnumGeographicRole.EnumGeographicRoleCity){shape.supportedGeoRoles.push($EnumGeographicRole.EnumGeographicRoleCounty);}availShapeArr.push(shape);}}return availShapeArr;},getPolygonSource:function getPolygonSource(grid,shapes,layers,baseMapType){var data=grid&&grid.data,props=data&&data.vp,shapeId=props&&props.lid,shape,geoRole;if(!props){return $EnumPolygonSource.Cloud;}if(!!shapeId){shape=this.getMatchingShape(shapes,shapeId,null);}else{geoRole=this.getShapeAttributeGeoRole(data,grid.dropZones.geoAttribute);shapes=this.getAvailableShapes(shapes,layers,geoRole,baseMapType);shape=this.getMatchingShape(shapes,null,geoRole);}if(!!shape){if(!shapeId){props.lid=shape.id;}if(isCustomShape(shape)){if(this.isMapBoxShapeConfig(shape,layers)){return $EnumPolygonSource.MapBoxPolygon;}return $EnumPolygonSource.Custom;}}return $EnumPolygonSource.Cloud;},isMapBoxShapeConfig:function isMapBoxShapeConfig(shape,layers){var i,layer,layersNumber=(layers&&layers.length)||0;for(i=0;i<layersNumber;i++){layer=layers[i];if(shape.layerId===layer.id){return parseInt(layer.scope)===parseInt($EnumBaseMapType.Mapbox);}}return false;},isMapboxStatisticalShape:function isMapboxStatisticalShape(shape,layers){var i,layer,layersNumber=(layers&&layers.length)||0;for(i=0;i<layersNumber;i++){layer=layers[i];if(shape&&shape.layerId===layer.id){return layer.scope===SCOPE_MAPBOX_STATISTICAL;}}return false;},getShapeAttributeGeoRole:function getShapeAttributeGeoRole(data,geoAttrID){var gts=data.gts,rows=gts&&gts.row,forms,geoRole,rowItem,i,il,j,jl,flagFound=false;if(!rows||!rows.length){return ;}il=rows.length;if(!!geoAttrID){for(i=0;i<il;i++){rowItem=rows[i];if(rowItem.id!==geoAttrID){continue;}forms=rowItem.fs;for(j=0,jl=forms.length;j<jl;j++){geoRole=forms[j].fgr;if(geoRole==undefined){continue;}geoRole=geoRole.toString();if(geoRole!==$EnumGeographicRole.EnumGeographicRoleNone&&geoRole!==$EnumGeographicRole.EnumGeographicRoleLatitiude&&geoRole!==$EnumGeographicRole.EnumGeographicRoleLongitude){flagFound=true;break;}}if(flagFound){break;}}}else{for(i=0;i<il;i++){rowItem=rows[i];forms=rowItem.fs;for(j=0,jl=forms.length;j<jl;j++){geoRole=forms[j].fgr;if(geoRole!==$EnumGeographicRole.EnumGeographicRoleNone&&geoRole!==$EnumGeographicRole.EnumGeographicRoleLatitiude&&geoRole!==$EnumGeographicRole.EnumGeographicRoleLongitude){break;}}}}return geoRole;},getMatchingShape:function getMatchingShape(shapes,shapeId,geoRole){var shape,firstCustomShape,firstDefaultShape,currShape,i,il;if(!shapes){return null;}if(geoRole===$EnumGeographicRole.EnumGeographicRoleNone){geoRole=null;}if(!!shapeId){for(i=0,il=shapes.length;i<il;i++){if(shapes[i].id==shapeId){shape=shapes[i];break;}}}else{if(!!geoRole){for(i=0,il=shapes.length;i<il;i++){currShape=shapes[i];if(isCustomShape(currShape)&&(currShape.roleId==geoRole||(currShape.supportedGeoRoles&&currShape.supportedGeoRoles.indexOf(geoRole)>-1))){if(!firstCustomShape){firstCustomShape=currShape;}if(!!currShape["default"]&&(currShape["default"]+"").toLowerCase()==="true"){shape=currShape;break;}}else{if(!firstDefaultShape&&currShape.roleId==geoRole&&!!currShape["default"]&&(currShape["default"]+"").toLowerCase()==="true"){firstDefaultShape=currShape;}}}if(!shape){if(!!firstCustomShape){shape=firstCustomShape;}else{if(!!firstDefaultShape){shape=firstDefaultShape;}}}}}return shape;},getShape4MapboxSecondGeoAttr:function getShape4MapboxSecondGeoAttr(shapes,layers,primaryShapeId,geoRole){var currShape,primaryShape,i,il,isPrimaryStats,isSecondaryStats;shapes=this.getAvailableShapes(shapes,layers,$EnumGeographicRole.EnumGeographicRoleOther,$EnumBaseMapType.Mapbox);il=(shapes&&shapes.length)||0;primaryShape=this.getMatchingShape(shapes,primaryShapeId,null);for(i=0;i<il;i++){currShape=shapes[i];if(currShape.roleId==geoRole||(currShape.supportedGeoRoles&&currShape.supportedGeoRoles.indexOf(geoRole)>-1)){if(geoRole==$EnumGeographicRole.EnumGeographicRoleCountry){return currShape;}isPrimaryStats=this.isMapboxStatisticalShape(primaryShape,layers);isSecondaryStats=this.isMapboxStatisticalShape(currShape,layers);if(isPrimaryStats===isSecondaryStats){return currShape;}}}return null;}});}());