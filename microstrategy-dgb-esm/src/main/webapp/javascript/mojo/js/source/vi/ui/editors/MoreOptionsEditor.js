(function(){mstrmojo.requiresCls("mstrmojo.Editor","mstrmojo.Button","mstrmojo.Label","mstrmojo.Box","mstrmojo.ui.CheckList","mstrmojo.DataGrid","mstrmojo.hash","mstrmojo.models.FormatModel","mstrmojo.ui.editors.controls.TwoColumnContainer","mstrmojo.ui.editors.controls.ValidationTextBox","mstrmojo.vi.ui.DatasetUnitMenuUtils","mstrmojo.func","mstrmojo.array","mstrmojo.dom");var $HASH=mstrmojo.hash,$ARRAY=mstrmojo.array,$CSS=mstrmojo.css,$NWB=mstrmojo.Button.newWebButton,$NPD=mstrmojo.ui.Pulldown.newPulldown,$GET_FORMAT_OBJ=mstrmojo.models.FormatModel.getFormatUpdate,$ENUM_FORMAT_PROPERTIES=mstrmojo.models.FormatModel.ENUM_PROPERTY_NAMES,$DU=mstrmojo.vi.ui.DatasetUnitMenuUtils,$EID,$DOM=mstrmojo.dom;var LOCK_ROW=1,LOCK_COL=2,LOCK_BOTH=3,CONTAINER_WIDTH="480px",VISFILTER="visfilter";var FORM_NAMES_ITEMS=[{n:mstrmojo.desc(6031,"Off"),v:"0"},{n:mstrmojo.desc(6030,"On"),v:"1"},{n:mstrmojo.desc(8504,"Form name only"),v:"2"},{n:mstrmojo.desc(8505,"Show attribute name once"),v:"3"},{n:mstrmojo.desc(4531,"Automatic"),v:"4"}],HIDE_NULL_ITEMS=[{n:mstrmojo.desc(13786,"Show both nulls and zeros"),v:"-1"},{n:mstrmojo.desc(13787," Hide both nulls and zeros"),v:"2"},{n:mstrmojo.desc(9845,"Hide nulls only"),v:"0"},{n:mstrmojo.desc(9846,"Hide zeros only"),v:"1"}],FILTER_DATA=[{n:mstrmojo.desc(13544,"Last selection only"),v:0},{n:mstrmojo.desc(13545,"Intersection of all selections"),v:1}],JOIN_METRIC_ITEMS=[{n:mstrmojo.desc(959,"Default"),v:"-1",title:mstrmojo.desc(959,"Default")},{n:mstrmojo.desc(9640,"Inner Join"),v:"0",title:mstrmojo.desc(9640,"Inner Join")},{n:mstrmojo.desc(9641,"Outer Join"),v:"1",title:mstrmojo.desc(9641,"Outer Join")}],JOIN_ATTRIBUTES_ITEMS=[{n:mstrmojo.desc(959,"Default"),v:"-1",title:mstrmojo.desc(959,"Default")},{n:mstrmojo.desc(13177,"Inner Join"),v:"0",title:mstrmojo.desc(13178,"Results displaying only those attribute elements that have metric value")},{n:mstrmojo.desc(13179,"Outer Join - Ignore Filter"),v:"2",title:mstrmojo.desc(13180,"Outer join to attribute's look up table without considering the filter on template")},{n:mstrmojo.desc(13181,"Outer Join - Preserve Filter"),v:"3",title:mstrmojo.desc(13182,"Outer join to attribute's look up table after considering the filter on template")}];var MAP_ATTRIBUTES_JOINTYPE={"-1":mstrmojo.desc(959,"Default"),"0":mstrmojo.desc(9640,"Inner Join"),"2":mstrmojo.desc(13179,"Outer Join - Ignore Filter"),"3":mstrmojo.desc(13181,"Outer Join - Preserve Filter")},MAP_METRIC_JOINTYPE={"-1":mstrmojo.desc(959,"Default"),"0":mstrmojo.desc(9640,"Inner Join"),"1":mstrmojo.desc(9641,"Outer Join")};var itemMarkup;var olm=false;function createTwoColumnContainer(col1Width,col2Width,children,props){var twoColumn={scriptClass:"mstrmojo.ui.editors.controls.TwoColumnContainer",col1Width:col1Width,col2Width:col2Width,children:children};return $HASH.copy(props,twoColumn);}function createLabel(text,slot,props){return $HASH.copy(props,{scriptClass:"mstrmojo.Label",slot:slot,text:text});}function createHeadersRow(subTitle,propSet){return[createLabel(subTitle,"col1Node",{cssClass:"subTitle"}),{scriptClass:"mstrmojo.ui.CheckList",orientation:"h",slot:"col2Node",preBuildRendering:function preBuildRendering(){var data=mstrmojo.all[$EID].data[propSet],items=this.items,selectedIndices=this.selectedIndices;if(data){$ARRAY.forEach(items,function(item,index){selectedIndices[index]=data[item.id]==="-1";});}var olm=mstrmojo.all[$EID].olm;if(!!olm&&propSet==="rows"){this.items[1].css="disabled";}else{this.items[1].css="";}},postselectionChange:function postselectionChange(evt){var items=this.items,changedArr=[evt.added,evt.removed];changedArr.forEach(function(changeditems,idx){if(changeditems&&changeditems.length>0){$GET_FORMAT_OBJ(propSet+items[changeditems[0]].id,idx===0?"-1":"0",mstrmojo.all[$EID].newData);}});},items:[{n:mstrmojo.desc(2969,"Show"),id:$ENUM_FORMAT_PROPERTIES.SHOW_HEADER},{n:mstrmojo.desc(1095,"Merge"),id:$ENUM_FORMAT_PROPERTIES.MERGE_HEADER,css:""},{n:mstrmojo.desc(2970,"Lock"),id:$ENUM_FORMAT_PROPERTIES.LOCK_HEADER}]}];}function restoreEditorID(){var eid=$EID.split("-"),len=eid.length;if(!mstrApp.isInVFConfigMode&&eid[len-1]===VISFILTER){eid.splice(eid.length-1,1);}else{if(mstrApp.isInVFConfigMode&&eid[len-1]!==VISFILTER){eid.splice(eid.length,1,VISFILTER);}}$EID=eid.join("-");}function closeEditor(submitChange){restoreEditorID();var editor=mstrmojo.all[$EID];if(submitChange){editor.update=editor.update.actions?editor.update:{actions:[]};editor.update.actions=editor.update.actions.concat(mstrmojo.hash.valarray(editor.joinActions));editor.update.callback=mstrmojo.func.wrapMethods(editor.update.callback,editor.host.parent.model.getRebuildCallback());if(editor.SelectionLimitSection&&editor.limitVal){editor.host.writeGlobalProperty("slctnLmt",editor.limitVal);}editor.submitAction(editor.newData,editor.update.actions,editor.update.callback,editor.update.extras);}editor.newData=editor.update={};editor.joinActions={};editor.close();}function openJoinMenu(btn){var data=btn.parent.data,editor=mstrmojo.all[$EID],nodeKey=editor.host.k,ctrl=editor.host.controller,menuCfg=new mstrmojo.ui.menus.MenuConfig();editor.joinActions=editor.joinActions||{};if(data.did==="AllAttr"){JOIN_ATTRIBUTES_ITEMS.forEach(function(item){menuCfg.addMenuItem(item.n,"",function(){btn.parent.jtValue.set("text",item.n);data.v=item.v;data.dv=item.n;editor.joinActions.AllAttr=ctrl.dataService().getSetAttributesJoinTypeAction(nodeKey,item.v);});});}else{JOIN_METRIC_ITEMS.forEach(function(item){menuCfg.addMenuItem(item.n,"",function(){btn.parent.jtValue.set("text",item.n);data.v=item.v;data.dv=item.n;editor.joinActions[data.did]=ctrl.dataService().getSetMetricJoinTypeAction(nodeKey,data.did,data.dt,data.t,item.v);});});}menuCfg.hostId=$EID;menuCfg.isHostedWithin=false;menuCfg.hostElement=btn.domNode;menuCfg.menuCssClass="joinbehavior";menuCfg.setAlignment(3,2);editor.openPopup(menuCfg.newInstance());}mstrmojo.vi.ui.editors.MoreOptionsEditor=mstrmojo.declare(mstrmojo.Editor,[mstrmojo.ui.menus._HasMenuPopup],{scriptClass:"mstrmojo.vi.ui.editors.MoreOptionsEditor",host:undefined,showHeadersSection:false,showSelectionLimitSection:false,data:undefined,lockHeadersCase:undefined,update:undefined,newData:undefined,joinActions:undefined,cssClass:"mstrmojo-MoreOptions-Editor",title:mstrmojo.desc(9126,"More options"),help:"more_options_dialog_box.htm",submitAction:mstrmojo.emptyFn,init:function init(props){this._super(props);if(mstrApp.isInVFConfigMode){this.children.splice(2,1);}$EID=this.id;this.newData=this.update={};this.joinActions={};this.onshowHeadersSectionChange(this.showHeadersSection);this.onshowSelectionLimitSectionChange(this.showSelectionLimitSection);},onOpen:function onOpen(){restoreEditorID();var host=this.host,data=host&&host.gridData,isOutLineMode=data&&data.olm&&!(data.rw&&data.rw.row.bc>0);this.olm=!!isOutLineMode;if(this.showSelectionLimitSection){var provider=this.SelectionLimitSection.children[1].children[1].provider;provider.curVal=host.readGlobalProperty("slctnLmt");this.limitVal=undefined;}this.refresh();},_set_lockHeadersCase:function _set_lockHeadersCase(n,v){this.lockHeadersCase=v;var data=this.data,lockHeadersCase=this.lockHeadersCase;if(!data){data=this.data={rows:{},cols:{}};}else{data.rows=data.rows||{};data.cols=data.cols||{};}data.rows.lhv=(lockHeadersCase===LOCK_BOTH||lockHeadersCase===LOCK_ROW)?"-1":"0";data.cols.lhv=(lockHeadersCase===LOCK_BOTH||lockHeadersCase===LOCK_COL)?"-1":"0";},onshowHeadersSectionChange:function onshowHeadersSectionChange(evt){var value=evt.value,hdsSec=this.headersSection;if(!value&&hdsSec){this._headersSecOrphan=hdsSec;this.removeChildren(hdsSec);}else{if(value&&!hdsSec){this.addChildren(this._headersSecOrphan,0);}}},onshowSelectionLimitSectionChange:function onshowSelectionLimitSectionChange(evt){var value=evt.value,lmSec=this.SelectionLimitSection;if(!value&&lmSec){this._selectionSecOrphan=lmSec;this.removeChildren(lmSec);}else{if(value&&!lmSec){this.addChildren(this._selectionSecOrphan,2);}}},children:[createTwoColumnContainer("26%","74%",[createLabel(mstrmojo.desc(2967,"Headers"),"col1Node",{cssClass:"title"}),createTwoColumnContainer("20%","80%",createHeadersRow(mstrmojo.desc(2968,"Rows"),"rows"),{slot:"col2Node"}),createTwoColumnContainer("20%","80%",createHeadersRow(mstrmojo.desc(122,"Columns"),"cols"),{slot:"col2Node"})],{alias:"headersSection",cssClass:"headers",width:CONTAINER_WIDTH}),createTwoColumnContainer("26%","74%",[createLabel(mstrmojo.desc(4083,"Display"),"col1Node",{cssClass:"title"}),{scriptClass:"mstrmojo.Box",slot:"col2Node",cssClass:"row1",children:[createLabel(mstrmojo.desc(8503,"Show attribute form names:"),"containerNode",null),$NPD(FORM_NAMES_ITEMS,function(newItem){$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.LONG_NAME,newItem.v,mstrmojo.all[$EID].newData);},0,{width:"151px",preBuildRendering:function preBuildRendering(){var idx=this.items.map(function(item){return item.v;}).indexOf(mstrmojo.all[$EID].data[$ENUM_FORMAT_PROPERTIES.LONG_NAME]);this.selectedIndex=Math.max(idx,0);}},true)]},{scriptClass:"mstrmojo.Box",slot:"col2Node",cssClass:"row2",children:[createLabel(mstrmojo.desc(13200,"Hide Null/Zero"),"containerNode",null),$NPD(HIDE_NULL_ITEMS,function(newItem){var v=newItem.v,showAllRows=v==="-1"?"-1":"0";if(v!=="-1"){$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.HIDE_NULL,v,mstrmojo.all[$EID].newData);}$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.SHOW_ALL_ROWS,showAllRows,mstrmojo.all[$EID].newData);},0,{width:"181px",preBuildRendering:function preBuildRendering(){var data=mstrmojo.all[$EID].data,idx=data[$ENUM_FORMAT_PROPERTIES.SHOW_ALL_ROWS]==="-1"?0:this.items.map(function(item){return item.v;}).indexOf(data[$ENUM_FORMAT_PROPERTIES.HIDE_NULL]);this.selectedIndex=Math.max(idx,0);}},true)]}],{alias:"viewSection",cssClass:"view",width:CONTAINER_WIDTH}),createTwoColumnContainer("26%","74%",[createLabel(mstrmojo.desc(13546,"Filtering"),"col1Node",{cssClass:"title"}),{scriptClass:"mstrmojo.Box",slot:"col2Node",cssClass:"row1",children:[createLabel(mstrmojo.desc(13547,"When this visualization is filtered by multiple other visualizations, filter by:"),"containerNode",{cssClass:"dropdownLabel"}),$NPD(FILTER_DATA,function(newItem){var editor=mstrmojo.all[$EID],host=editor.host;if(host.switchFilterType){editor.update=host.switchFilterType(newItem.v);}},0,{width:"181px",preBuildRendering:function preBuildRendering(){var host=mstrmojo.all[$EID].host;if(host.getFilterType){this.selectedIndex=host.getFilterType();}}},true)]}],{alias:"filteringSection",cssClass:"filtering",width:CONTAINER_WIDTH}),createTwoColumnContainer("26%","73%",[createLabel(mstrmojo.desc(16265,"Selection Data Limit"),"col1Node",{cssClass:"title"}),{scriptClass:"mstrmojo.Box",slot:"col2Node",cssClass:"row1",children:[createLabel(mstrmojo.desc(16264,"Set a limit for the maximum quantity of data points that a user can select on this visualization."),"containerNode",{cssClass:"stepperLabel"}),{scriptClass:"mstrmojo.ui.editors.controls.Stepper",width:"75px",preBuildRendering:function preBuildRendering(){$CSS.addWidgetCssClass(this,"selection");mstrmojo.ui.editors.controls.Stepper.prototype.preBuildRendering.call(this);},provider:new mstrmojo.NumStepperContentProvider({item:{interval:1},min:1,max:200000,onTraverse:function(){var editor=mstrmojo.all[$EID];editor.limitVal=this.item.value;}})},createLabel(mstrmojo.desc(16263,"(Max quantity should be no more than 200K.)"),"containerNode",{cssClass:"stepperLabel"})]}],{alias:"SelectionLimitSection",cssClass:"filtering",width:CONTAINER_WIDTH}),createTwoColumnContainer("26%","74%",[createLabel(mstrmojo.desc(4571,"Join Behavior"),"col1Node",{cssClass:"title"}),{scriptClass:"mstrmojo.DataGridWithTooltip",slot:"col2Node",cssClass:"jointype",banding:false,lockHeader:true,columns:[{headerText:mstrmojo.desc(5467,"Objects"),dataField:"n",headerCss:"objects-hd",tooltip:false,itemTooltipField:"tf",itemCSSField:"itemCss",colWidth:115,colHeight:24},{headerText:mstrmojo.desc(13176,"Join Type"),headerCss:"jointype-hd",dataWidget:{scriptClass:"mstrmojo.Box",cssClass:"jt-col",children:[{scriptClass:"mstrmojo.Label",cssClass:"jt-value",alias:"jtValue",bindings:{text:"this.parent.data.dv"}},{scriptClass:"mstrmojo.Button",cssClass:"jt-menu",alias:"jtBtn",onclick:function(){var editor=mstrmojo.all[$EID];openJoinMenu.call(editor,this);}}]}}],items:[],itemFunction:function(){var c=mstrmojo.DataGridWithTooltip.prototype.itemFunction.apply(this,arguments);c.themeClassName=!!mstrApp.isWSStyling?"":"mojo-theme-dark";return c;},preBuildRendering:function preBuildRendering(){var host=mstrmojo.all[$EID].host,docModel=host.model&&host.model.docModel,gridInfo=host.gridInfo||{},rows=gridInfo.rows||[],cols=gridInfo.cols||[],mx=gridInfo.mx||[],dmx=gridInfo.dmx||[],props=host.tmsProps,tmpValue=props.tpltProp&&props.tpltProp["VLDB Select"]&&props.tpltProp["VLDB Select"][0].v,items=[];tmpValue=(tmpValue&&tmpValue.length)?tmpValue:"-1";(rows.concat(cols)).some(function(item){if(item.t===12){items.push({did:"AllAttr",n:mstrmojo.desc(13185,"All Attributes"),v:tmpValue,dv:MAP_ATTRIBUTES_JOINTYPE[tmpValue],itemCss:"jt-allattr"});return true;}return false;});mx=$ARRAY.filter(mx,function(metric){var unit=$DU.getUnitFromDataset(docModel.datasets,metric.did,4),isSmartCalInBase=metric.isSmart&&metric.decomposable===2;return unit&&(!unit.um||metric.afb||!metric.isSmart||isSmartCalInBase);});var mxProp=[].concat(props.mxProp);dmx.forEach(function(dm){var dmp={};dmp[dm.did]=dm.prop;mxProp.push(dmp);});(mx||[]).forEach(function(metric){var mv={v:"-1"};(mxProp||[]).forEach(function(obj){if(obj[metric.did]){(obj[metric.did]["VLDB Select"]||[]).forEach(function(ps){if(ps.n==="Metric Join Type"){mv=ps;}});}});items.push({did:metric.did,n:metric.n,dt:mv.dt,t:4,v:mv.v,dv:MAP_METRIC_JOINTYPE[mv.v],itemCss:"jt-metric"});});this.items=items;mstrmojo.DataGridWithTooltip.prototype.preBuildRendering.apply(this,arguments);},postBuildRendering:function postBuildRendering(){mstrmojo.DataGridWithTooltip.prototype.postBuildRendering.apply(this,arguments);this.domNode.style.overflow="hidden";}}],{alias:"JoinBehaviorSection",cssClass:"joinbehavior",width:CONTAINER_WIDTH}),{alias:"buttonBar",scriptClass:"mstrmojo.Box",slot:"buttonNode",children:[$NWB(mstrmojo.desc(221,"Cancel"),function(){closeEditor(false);}),$NWB(mstrmojo.desc(118,"Save"),function(){closeEditor(true);},true)]}]});mstrmojo.DataGridWithTooltip=mstrmojo.declare(mstrmojo.DataGrid,[mstrmojo._HasTooltip],{scriptClass:"mstrmojo.DataGridWithTooltip",tooltip:"",useRichTooltip:true,itemFunction:function(item,idx,w){var c=new mstrmojo.DataRow({columns:w.columns,data:item,idx:idx,dataGrid:w,parent:w});w.dataTextCSSClass=c.dataTextCSSClass;return c;},updateTooltipConfig:function updateTooltipConfig(evt){var target=evt.target||$DOM.eventTarget(evt.hWin,evt.e),position=$DOM.position(target);this.richTooltip={posType:mstrmojo.tooltip.POS_BOTTOMRIGHT,content:this.getTooltipContent(evt),top:position.y+1.5*position.h,left:position.x,cssClass:"vi-regular vi-tooltip-D"};},getTooltipContent:function(evt){return mstrmojo.string.regEscape(evt.target.innerText);},showTooltip:function showTooltip(evt,win){if(evt.target.className===this.dataTextCSSClass){this._super(evt,win);}}});}());