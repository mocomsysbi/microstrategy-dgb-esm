(function(){mstrmojo.requiresCls("mstrmojo.Button","mstrmojo.HTMLButton","mstrmojo.Label","mstrmojo.TextBox","mstrmojo.TextArea","mstrmojo.Table","mstrmojo.HBox","mstrmojo.Editor","mstrmojo.ObjectBrowser","mstrmojo.NewFolderEditor","mstrmojo.DI.DIHelpers");var $FUNC=mstrmojo.func,$H=mstrmojo.DI.DIHelpers,$ARR=mstrmojo.array;function _makeChildren(){var nf={alias:"newFolder",scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-createfolder",text:mstrmojo.desc(3245,"Create New Folder"),onclick:function(){var e=this.parent.parent,config={zIndex:e.zIndex+10,navigateAfter:false,fId:e.ob.currentFolder.did,okFn:function(res,navigateAfter){e.ob.refreshContent();if(navigateAfter){e.ob.browseFolder(res.fid,e.newFolder);}}};if(e.ob.dataProvider){config.dp=e.ob.dataProvider;}e.openPopup("newFolder",config);},postCreate:function(){this.set("visible",false);}},ch=mstrmojo.hash.clone(mstrmojo.ObjectBrowser.prototype.children);ch.push(nf);return ch;}mstrmojo.SaveAsObjectBrowser=mstrmojo.declare(mstrmojo.ObjectBrowser,null,{scriptClass:"mstrmojo.SaveAsObjectBrowser",cssClass:"mstrmojo-SaveAs-OB",children:_makeChildren(),getRecents:function(popup){var me=this;popup.onClose=function(){if(me.recentFolders){this.removeChildren(this.recentLable);this.removeChildren(this.recentList);delete me.recentFolders;}};this.getDataProvider().loadRecentSaveAsFolders({success:function(res){if(me.recentFolders){popup.removeChildren(popup.recentLable);popup.removeChildren(popup.recentList);delete me.recentFolders;}if(res&&res!==""){me.recentFolders=me.getList(res.objects,popup);popup.addChildren(me.recentFolders);}},failure:function(res){mstrmojo.alert(res.message||res.getResponseHeader("X-MSTR-TaskFailureMsg"));},});},getList:function(items,popup){var me=this;return[{scriptClass:"mstrmojo.Label",alias:"recentLable",cssClass:"recentLabel",text:mstrmojo.desc(14354,"Recents")},{scriptClass:"mstrmojo.ui.List",alias:"recentList",items:items,cssClass:"recentList",onclick:function(evt){var item=this.getItemFromTarget(evt.getTarget());me.browseFolder(item.did,"");popup.close();}}];}});var saveAsCB={success:function(res){var p=this.parent;if(p.onObjectSaved){p.onObjectSaved({name:p.name,did:res.did,desc:p.desc});}mstrmojo.alert(mstrmojo.desc(7987,"The ## '###' has been saved successfully.").replace("##",p.typeDesc||"Object").replace("###",p.name),null,mstrmojo.desc(7984,"Object Saved"));p.ob.refreshContent();p.close();},failure:function(res){var ec=parseInt(res.getResponseHeader("X-MSTR-TaskErrorCode"),10)+4294967296,p=this.parent;if(ec===2147749923){mstrmojo.confirm(mstrmojo.desc(7986,"The ## '###' already exists. Do you want to replace the existing one?").replace("##",p&&p.typeDesc||"Object").replace("'###'",p&&p.name?'"'+p.name+'"':""),{confirmBtn:{fn:function(){p.saveAs(true);}}},{title:mstrmojo.desc(3179),zIndex:p&&p.zIndex+10});}else{mstrmojo.alert(mstrmojo.desc(7985,"Error while saving: ")+res.getResponseHeader("X-MSTR-TaskFailureMsg"));}}};mstrmojo.SaveAsEditor=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.SaveAsEditor",cssClass:"mstrmojo-SaveAsEditor",title:mstrmojo.desc(3167,"Save As"),sId:null,rootFolderID:null,rootFolderType:null,folderLinksContextId:null,browsableTypes:null,showCompletePath:true,desc:"",name:"",displaySaveLabel:true,searchVisible:true,upButtonVisible:true,children:[{scriptClass:"mstrmojo.SaveAsObjectBrowser",alias:"ob",closeable:false,closeOnSelect:false,fishEyeVisible:false,bindings:{showCompletePath:"this.parent.showCompletePath",rootFolderID:"this.parent.rootFolderID",rootFolderType:"this.parent.rootFolderType",folderLinksContextId:"this.parent.folderLinksContextId",browsableTypes:"this.parent.browsableTypes",displaySaveLabel:"this.parent.displaySaveLabel",searchVisible:"this.parent.searchVisible",upButtonVisible:"this.parent.upButtonVisible",sId:"this.parent.sId"},postCreate:function(){this.onSelectCB=[this.parent,"onOBSelect"];this.onBrowseFolder=[this.parent,"onOBBrowseFolder"];}},{scriptClass:"mstrmojo.Table",cssClass:"mstrmojo-Input-Panel",rows:2,cols:2,alias:"contPanel",children:[{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-Name-Label",slot:"0,0",text:mstrmojo.desc(2211,"Name:")},{scriptClass:"mstrmojo.TextBox",slot:"0,1",value:mstrmojo.desc(8116,"New Folder"),alias:"name",cssClass:"mstrmojo-SaveAsEditor-nameInput",bindings:{value:"this.parent.parent.name"}},{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-Desc-Label",slot:"1,0",text:mstrmojo.desc(1154,"Description:")},{scriptClass:"mstrmojo.TextArea",cssClass:"mstrmojo-SaveAsEditor-descInput",slot:"1,1",alias:"desc",bindings:{value:"this.parent.parent.desc"},rows:5}]},{scriptClass:"mstrmojo.HBox",alias:"buttonBox",slot:"buttonNode",cssClass:"mstrmojo-Editor-buttonBar",children:[{alias:"newFolder",scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-WebButton mstrmojo-createfolder",text:mstrmojo.desc(3245,"Create New Folder"),onclick:function(){var e=this.parent.parent,config={zIndex:e.zIndex+10,navigateAfter:false,fId:e.ob.currentFolder.did,okFn:function(res,navigateAfter){e.ob.refreshContent();if(navigateAfter){e.ob.browseFolder(res.fid,e.newFolder);}},cssClass:$H.getEnvObj().isAppSchema()?"workstation":undefined};if(e.ob.dataProvider){config.dp=e.ob.dataProvider;}e.openPopup("newFolder",config);},postCreate:function(){this.set("visible",mstrmojo.resolveFeature("create-folder")||$H.getEnvObj().isAppSchema());}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-WebButton hot okButton",alias:"ok",text:mstrmojo.desc(2400,"Save"),onclick:function(){this.parent.parent.saveAs();}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-WebButton",alias:"cancel",text:mstrmojo.desc(221,"Cancel"),onclick:function(){this.parent.parent.close();}}]}],newFolder:{scriptClass:"mstrmojo.NewFolderEditor"},onOpen:function(){this.ob.browse();},onOBBrowseFolder:mstrmojo.emptyFn,onOBSelect:function(item){this.set("name",item.n);},saveAsCallback:function saveAsCallback(){return saveAsCB;},saveAs:function(overwrite){var panel=this.contPanel;this.name=panel.name.value;this.desc=panel.desc.value;if(!this.name){mstrmojo.alert(mstrmojo.desc(3380,"Please enter valid name"));return ;}var params=this.saveParams||{};params.folderID=this.ob.currentFolder.did;params.description=this.desc||"";params.name=this.name||"";params.saveAsOverwrite=!!overwrite;var cb=this.saveAsCallback(),me=this,saveRecentFoldersCallback={success:function(){me.saveRecentFolders(me.ob.currentFolder.did);},failure:function(res){mstrmojo.alert(res.message||res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};cb.parent=this;if(!mstrApp.isSingleTier){cb=$FUNC.wrapMethods(cb,saveRecentFoldersCallback);}mstrmojo.xhr.request("POST",mstrConfig.taskURL,cb,params);},saveRecentFolders:function(recentFolderID){var recentFolders,recentFolderArray,index,me=this;me.ob.getDataProvider().loadRecentSaveAsFolders({success:function(res){recentFolderArray=[];$ARR.forEach(res.objects,function(object){recentFolderArray.push(object.did);});index=mstrmojo.array.indexOf(recentFolderArray,recentFolderID);if(index!==-1){recentFolderArray.splice(index,1);}recentFolderArray.unshift(recentFolderID);recentFolders=recentFolderArray.slice(0,3).join(",")+",";var params={taskId:"setPreference",prefs:"recentFolders\u001E"+recentFolders};var callback={success:function(){mstrConfig.recentFolders=recentFolders;},failure:function(res){mstrmojo.alert(res.message||res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};me.ob.getDataProvider().serverRequest(params,callback);},failure:function(res){mstrmojo.alert(res.message||res.getResponseHeader("X-MSTR-TaskFailureMsg"));}});}});mstrmojo.SaveAsEditor.SAVEAS_CALLBACK=saveAsCB;})();