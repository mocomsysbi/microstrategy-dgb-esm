(function(){mstrmojo.requiresCls("mstrmojo.css","mstrmojo.hash","mstrmojo.array","mstrmojo.UUID","mstrmojo.ui.menus.ToolbarConfig");var $HASH=mstrmojo.hash,$ARR=mstrmojo.array,$CSS=mstrmojo.css,$UUID=mstrmojo.UUID;function calculateGroupInfo(){var units=this.children,oldGroupInfo=this.groupInfo,groupInfo=(oldGroupInfo&&oldGroupInfo._isDeleted)?oldGroupInfo:{};delete groupInfo._isDeleted;units.forEach(function(unit){var groupId=unit.defn.gi;if(groupId&&groupId!==""){var group=groupInfo[groupId];if(!group){group=groupInfo[groupId]=[];}group.push(unit.k);}});return groupInfo;}mstrmojo.vi.ui._HasGroup=mstrmojo.provide("mstrmojo.vi.ui._HasGroup",{_mixinName:"mstrmojo.vi.ui._HasGroup",clearGroupSelection:function clearGroupSelection(){var tgtSelections=this._tgtSelections;if(tgtSelections){var me=this,keys=tgtSelections.getSelections();(keys||[]).forEach(function(key){me.getUnitByKey(key).toggleBoxSelection(false);me.setLastSelectionClass(null,key);tgtSelections.remove(key);});}},getGroupInfo:function getGroupInfo(){var groupInfo=this.groupInfo;if(!groupInfo||groupInfo._isDeleted){groupInfo=this.groupInfo=calculateGroupInfo.call(this);$HASH.forEach(groupInfo,function(group,groupId){if(group.length<2){delete groupInfo[groupId];}});}return groupInfo;},findGroupByKey:function findGroupByKey(lookupKey){var inGroupId=null;$HASH.forEach(this.getGroupInfo(),function(groupArr,groupId){$ARR.forEach(groupArr,function(key){if(lookupKey===key){inGroupId=groupId;return false;}});if(inGroupId){return false;}});return inGroupId;},getGroupContextMenuConfig:function getGroupContextMenuConfig(cfg,key){var tgtSelections=this._tgtSelections;if(tgtSelections){var id=this.id,groupInfo=this.groupInfo,groupId,i=1,inGroupId=this.findGroupByKey(key);var fnGetAddToGroup=function(groupId){return function(){groupInfo[groupId].push(key);tgtSelections.notify(true,{selectedGroupId:groupId});};},fnGetMoveToGroup=function(fromGroupId,toGroupId){return function(){var oldGroup=groupInfo[fromGroupId],fnUnSelectBox=function(key){var boxInOldGroup=mstrmojo.all[id].getUnitByKey(key);boxInOldGroup.toggleBoxSelection(false);boxInOldGroup.setGroupingStatus("");};oldGroup.splice(oldGroup.indexOf(key),1);if(oldGroup.length===1){fnUnSelectBox(oldGroup[0]);delete groupInfo[fromGroupId];}if(toGroupId){groupInfo[toGroupId].push(key);}else{fnUnSelectBox(key);}tgtSelections.notify(true,{selectedGroupId:toGroupId||fromGroupId});};};for(groupId in groupInfo){if(groupId===inGroupId){cfg.addMenuItem(mstrmojo.desc(15197,"Remove from Group ##").replace("##",i),"",fnGetMoveToGroup(groupId,null),null,0);}else{if(inGroupId){cfg.addMenuItem(mstrmojo.desc(15198,"Move to Group ##").replace("##",i),"",fnGetMoveToGroup(inGroupId,groupId));}else{cfg.addMenuItem(mstrmojo.desc(15199,"Add to Group ##").replace("##",i),"",fnGetAddToGroup(groupId));}}i++;}if(inGroupId){cfg.addMenuItem(mstrmojo.desc(12195,"Ungroup"),"",function(){tgtSelections.notify(true,{deleteGroupId:inGroupId});});}return cfg;}},groupSelection:function groupSelection(){var tgtSelections=this._tgtSelections;if(tgtSelections){tgtSelections.notify(true);}},addGroup:function addGroup(groupArr){var newGroupId=$UUID.create();this.groupInfo[newGroupId]=groupArr;return newGroupId;},selectGroup:function selectGroup(keys){var me=this;var tgtSelections=this._tgtSelections;if(tgtSelections){keys.forEach(function(key){tgtSelections.toggleSelection(key);var unit=me.getUnitByKey(key);unit.toggleBoxSelection(true);unit.setGroupingStatus("");});}},highlightGroup:function highlightGroup(groupId){var me=this,keys=this.getGroupInfo()[groupId];(keys||[]).forEach(function(key){var unit=me.getUnitByKey(key);unit.setGroupingStatus("highlight");});},disableGroup:function disableGroup(groupId){var me=this,keys=this.getGroupInfo()[groupId];var tgtSelections=this._tgtSelections;if(tgtSelections){(keys||[]).forEach(function(key){var unit=me.getUnitByKey(key);unit.setGroupingStatus("disabled");unit.toggleBoxSelection(false);tgtSelections.remove(key);});}},deleteGroup:function deleteGroup(groupId){var me=this,groupInfo=this.getGroupInfo(),keys=groupInfo[groupId];(keys||[]).forEach(function(key){var unit=me.getUnitByKey(key);unit.setGroupingStatus("");});delete groupInfo[groupId];},clearGroupInfo:function clearGroupInfo(){this.clearGroupSelection();var groupInfo=this.groupInfo;if(groupInfo){$HASH.forEach(groupInfo,function(group,groupId){groupInfo[groupId]=[];});groupInfo._isDeleted=true;}},toggleHasGroupCSS:function toggleHasGroupCSS(hasGroup){$CSS.toggleClass(this.domNode,"hasGroup",hasGroup);},submitGroupInfo:function submitGroupInfo(){var newGroupInfo=this.getGroupInfo(),oldGroupInfo=calculateGroupInfo.call(this),diffInfo={},undoInfo={};$HASH.forEach(newGroupInfo,function(group,groupId){group.forEach(function(key){var oldGroup=oldGroupInfo[groupId],oldIndex=oldGroup?oldGroup.indexOf(key):-1;if(oldIndex===-1){diffInfo[key]=groupId;undoInfo[key]="";}else{oldGroup.splice(oldIndex,1);}});});$HASH.forEach(oldGroupInfo,function(group,groupId){group.forEach(function(key){if(!diffInfo[key]){diffInfo[key]="";}undoInfo[key]=groupId;});});if(Object.keys(diffInfo).length>0){this.model.saveGroupInfo(diffInfo,undoInfo,this);}}});}());