(function(){mstrmojo.requiresClsP("mstrmojo","Box","HBox","Widget","Button","hash","dom","array","css","desc","tooltip","string");mstrmojo.requiresCls("mstrmojo.mstr.EnumDataType","mstrmojo.vi.ui.editors.HierarchyElementsListPanel","mstrmojo.ExpressionToolbar","mstrmojo.vi.ui.editors.cm.CalculatedMemberExpressionInputBox");mstrmojo.requiresDescs(945,15656,15597,15831,15832,15358,15833);var $DESC=mstrmojo.desc,$DT=mstrmojo.mstr.EnumDataType,$HASH=mstrmojo.hash,$DOM=mstrmojo.dom,$ARR=mstrmojo.array,$CSS=mstrmojo.css,$STR=mstrmojo.string;var CSS_CANNOT_SET_PARENT="xsp";mstrmojo.vi.ui.editors.CalculatedMemberPanel=mstrmojo.declare(mstrmojo.Box,null,{scriptClass:"mstrmojo.vi.ui.editors.CalculatedMemberPanel",cssClass:"mstrmojo-CalculatedMemberPanel",isNew:false,canChangeParent:true,enablePTO:false,parentElement:null,children:[{scriptClass:"mstrmojo.Box",alias:"rootVBox",children:[{scriptClass:"mstrmojo.HBox",alias:"definitionBox",cssClass:"definitionBox",children:[{scriptClass:"mstrmojo.vi.ui.editors.HierarchyElementsListPanel",alias:"listPanel",disableDrop:true,handleDblClick:function handleDblClick(src,evt){if(src.scriptClass==="mstrmojo.vi.ui.IncHierarchyList"){var target=evt.getTarget();if(!$CSS.hasClass(target,"raBtn")&&!$CSS.hasClass(target,"btn")){var item=src.getItemFromTarget(target);if(item&&!item.fetcher){var ib=this.parent.defnPanel.inputBox;ib.insertTokens([ib.createToken(item)]);}}}},handleSetParent:function handleSetParent(parentElement){this.parent.parent.parent.set("parentElement",$HASH.copyProps(["v","n"],parentElement));},getCurrentPE:function getCurrentPE(){return this.parent.parent.parent.parentElement;},getAttributeIdFromModel:function getAttributeIdFromModel(){return this.parent.parent.parent.getAttributeId();},getBrowseConfig:function getBrowseConfig(){return this.parent.parent.parent.getBrowseConfig();}},{scriptClass:"mstrmojo.Box",alias:"defnPanel",cssClass:"defn",children:[{scriptClass:"mstrmojo.HBox",cssClass:"mstrmojo-HBox deNameBox",alias:"deNameBox",bindings:{visible:function(){return this.parent.parent.parent.parent.isNew;}},children:[{scriptClass:"mstrmojo.TextBoxWithLabel",cssClass:"deNameTB",alias:"deNameTB",label:$DESC(945,"Name"),cssDisplay:"block"},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-WebHoverButton",alias:"ptoBtn",text:$DESC(15656,"Pass-through Options"),onclick:function(){var cmPanel=this.parent.parent.parent.parent.parent,editor=cmPanel.parent,ID="mstrPTO",pto=mstrmojo.all[ID]||mstrmojo.insert({scriptClass:"mstrmojo.PassThroughOptions",help:"create_derived_element_mdx_hierarchy_reports.htm",id:ID}),pos=$DOM.position(this.domNode,true),dataset=cmPanel.getDataset(),config={zIndex:editor.zIndex+10,left:Math.max(0,(pos.x-333+pos.w/2))+"px",top:pos.y+"px",dbt:dataset.tables[0].dbt,so_dft:dataset.so_dft,sim_dft:dataset.sim_dft,onOK:function(mptf){editor.mptf=mptf;}};if(editor.mptf){config.mptf=editor.mptf;}pto.open(editor,config);},bindings:{visiable:function(){return this.parent.parent.parent.parent.parent.enablePTO;}}}]},{scriptClass:"mstrmojo.Box",alias:"parentLabelBox",cssClass:"parentBox",children:[{scriptClass:"mstrmojo.Label",cssDisplay:"inline-block",text:$DESC(15597,"Parent:")},{scriptClass:"mstrmojo.Label",cssDisplay:"inline-block",alias:"parentLabel",useRichTooltip:true,text:"",bindings:{text:function(){var parentElement=this.parent.parent.parent.parent.parent.parentElement;return parentElement&&parentElement.n;}},updateTooltipConfig:function(){var target=this.domNode,position,item=this.parent.parent.parent.parent.parent.parentElement;if((target.scrollWidth>target.clientWidth||!target.textContent)&&(item&&item.v)){position=$DOM.position(this.domNode);this.richTooltip={cssClass:"vi-regular vi-tooltip-V",posType:mstrmojo.tooltip.POS_BOTTOMLEFT,content:target.textContent||("<b>Name: </b>"+$ENC(item.n)+"<br><b>ID: </b>"+$ENC(item.v)),top:position.y,left:position.x};}else{delete this.richTooltip;}}}]},{scriptClass:"mstrmojo.Label",alias:"parentHint",cssClass:"hint",bindings:{text:function(){var canChangeParent=this.parent.parent.parent.parent.canChangeParent;return canChangeParent?$DESC(15831,"Please change parent from Elements List"):$DESC(15832,"The parent could not be changed");}}},{scriptClass:"mstrmojo.Label",cssClass:"blue bold expr",text:$DESC(15358,"MDX Expression")},{scriptClass:"mstrmojo.ExpressionToolbar",onmouseup:function(evt){var el=$DOM.eventTarget(evt.hWin,evt.e),idx=el.getAttribute("idx")||-1;this.set("selectedIndex",idx);var inputBox=this.parent.inputBox,symbol=this.selectedItem,vs=symbol&&symbol.v.split(""),tokens=[];if(symbol&&$DOM.getButton(evt.hWin,evt.e)===$DOM.MOUSE_BUTTON.LEFT){switch(symbol.t){case 1:$ARR.forEach(vs,function insertSymbols(v){tokens.push({v:v,isDelimiter:true,isNew:true});},this);var lastTokenIdx=inputBox.insertTokens(tokens);if(vs.length===2){var idx=lastTokenIdx-Math.floor(tokens.length/2);inputBox._delaySetTextCaretPos(inputBox.itemsContainerNode.childNodes[idx],1);}break;case 3:inputBox.resetTokens();break;}}},},{scriptClass:"mstrmojo.vi.ui.editors.cm.CalculatedMemberExpressionInputBox",alias:"inputBox",postexpValidChange:function(){this.parent.parent.parent.applyBox.applyBtn.set("enabled",this.expValid);}}]}]},{scriptClass:"mstrmojo.HBox",alias:"applyBox",cssClass:"applyBox",bindings:{visible:function(){return !this.parent.parent.isNew;}},children:[{scriptClass:"mstrmojo.Widget",markupString:'<div class="apply-text">'+$STR.encodeHtmlString($DESC(15833,"Drag and drop elements to create a Calculated Member. Click # button to apply.")).replace("#",'"&#10003;"')+"</div>"},{scriptClass:"mstrmojo.Button",iconClass:"applyBtn",alias:"applyBtn",onclick:function(){if(this.enabled){var cmPanel=this.parent.parent.parent,expression=cmPanel.inputBox().getExpression(),pe=cmPanel.parentElement,items=[{dtp:$DT.DataTypeChar,v:expression,}],deEditor=cmPanel.parent;if(deEditor.commitEdit(items,false,pe)){cmPanel.set("visible",false);deEditor.toggleEdit(false);}}}},{scriptClass:"mstrmojo.Button",iconClass:"cancelBtn",alias:"cancelBtn",onclick:function(){var cmPanel=this.parent.parent.parent,deEditor=cmPanel.parent;cmPanel.set("visible",false);deEditor.toggleEdit(false);}}]}]}],resetDisplay:function resetDisplay(){this.listPanel().resetDisplay();this.set("canChangeParent",!this.isEssbaseSource());this.set("parentElement",this.canChangeParent?this.getPeInModel():this.listPanel().attribute);this.inputBox().resetDisplay(this.getCmExpressionInModel());if(this.isNew){this.deNameTB().set("value",this.getCmNameInModel());this.set("enablePTO",this.isEssbaseSource()||this.isMDXSource());}},oncanChangeParentChange:function oncanChangeParentChange(){if(this.hasRendered){$CSS.toggleClass(this.domNode,CSS_CANNOT_SET_PARENT,!this.canChangeParent);}this.parentHint().set("visible",this.canChangeParent);this.parentLabelBox().set("visible",this.canChangeParent);},listPanel:function(){return this.rootVBox.definitionBox.listPanel;},deNameTB:function(){return this.rootVBox.definitionBox.defnPanel.deNameBox.deNameTB;},parentHint:function(){return this.rootVBox.definitionBox.defnPanel.parentHint;},parentLabelBox:function(){return this.rootVBox.definitionBox.defnPanel.parentLabelBox;},inputBox:function(){return this.rootVBox.definitionBox.defnPanel.inputBox;},getDataset:function(){var oId=this.getAttributeId(),docModel=this.getDocModel(),datasetId=docModel&&docModel.findDatasetIdFromUnit(oId);if(datasetId){return docModel.datasets[datasetId];}},isMDXSource:function(){var docModel=this.getDocModel();return docModel&&docModel.isMSASDataset(this.getDataset());},isEssbaseSource:function(){var docModel=this.getDocModel();return docModel&&docModel.isEssbaseDataset(this.getDataset());},getBrowseConfig:function(){return{datasetID:this.getDataset().did,messageID:mstrApp.getMsgID()};},getPeInModel:mstrmojo.emptyFn,getCmNameInModel:mstrmojo.emptyFn,getCmExpressionInModel:mstrmojo.emptyFn,getDocModel:mstrmojo.emptyFn,getAttributeId:mstrmojo.emptyFn,});}());