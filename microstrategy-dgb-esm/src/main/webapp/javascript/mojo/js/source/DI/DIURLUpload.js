(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.Label","mstrmojo.Button","mstrmojo.TextBox","mstrmojo.RadioList","mstrmojo.ImageCheckBox","mstrmojo.DI.DIConstants","mstrmojo.DI.FileDragDropBox","mstrmojo.DI.DIHelpers","mstrmojo.DI.DIDragFiles","mstrmojo.DI.DIAuthenticationButton","mstrmojo.string");mstrmojo.requiresDescs(531,12444,12512,12691,12733,12734,12811,12812,13133,14767,15078,15084);var constants=mstrmojo.DI.DIConstants,$HELPER=mstrmojo.DI.DIHelpers,isOperationMode=$HELPER.isOperationMode,URL_UPLOAD=0,NETWORK_BROWSING=1,$ARR=mstrmojo.array,TABLE_NAME_TAG="TABLENAME=",GENERIC_TAG="GENERICPARA=",$DOM=mstrmojo.dom,CLIENTID_PREFIX="&userId=",$NWB=mstrmojo.Button.newWebButton,$S=mstrmojo.string,WS_CALLBACK="http://localhost?con=true",CE_READY="CE connector ready",$H=mstrmojo.hash;var SDK={ceil:"2.0.0.0",floor:undefined};function tableParse(obj){var urlObject,tableInfo,urlList=[];for(var i=0;i<obj.tableList.length;i++){urlObject=JSON.parse(JSON.stringify(obj));tableInfo=urlObject.tableList[i];for(var item in tableInfo){urlObject[item]=tableInfo[item];}delete urlObject.tableList;urlList[i]=TABLE_NAME_TAG+"{"+tableInfo.tableName+"};"+GENERIC_TAG+"{"+JSON.stringify(urlObject)+"};";}return urlList;}function getTableName(str){var start=TABLE_NAME_TAG.length;var end=str.indexOf(GENERIC_TAG)-1;return str.substring(start,end);}function modeSelect(props){if(props.isNewConnector){return constants.URLMode.NewConnector;}else{if(props.currentSource&&props.currentSource.sourceInfo.sdkUrl){return constants.URLMode.NewConnectorEdit;}else{if(props.isFromCloudElement||(props.currentSource&&props.currentSource.subtype===constants.sourceSubtype.cloudElement)){return constants.URLMode.CloudElement;}else{return constants.URLMode.NormalUrl;}}}}function dbName2SourceName(name){switch(name){case"Box":return"box";case"QuickBooks Online":return"quickbooks";case"Sugar CRM":return"sugarcrmv2";case"Microsoft Dynamics CRM":return"dynamicscrmadfs";case"Expensify":return"expensify";case"OneDrive":return"onedrivev2";case"Netsuite ERP 2016":return"netsuiteerpv2";case"Zoho CRM":return"zohocrm";case"SharePoint 2013":return"sharepoint";case"Zendesk":return"zendesk";case"Amazon S3":return"amazons3";case"Desk.com":return"desk";default:return null;}}function isValidProtocol(urlText){if(urlText.substring(0,10)===TABLE_NAME_TAG){return true;}urlText=urlText.toLowerCase();urlText=urlText.replace(/\s+/g," ");return(urlText.indexOf("file://")===0)||(urlText.indexOf("ftp://")===0)||(urlText.indexOf("http://")===0)||(urlText.indexOf("https://")===0)||(urlText.indexOf("hdfs://")===0);}function isURLSupported(urlText){var support={protocolDisabled:false,protocol:""};if(!mstrApp.diParams.EnableURLImport){support.protocolDisabled=true;support.protocol="url";}else{urlText.toLowerCase();urlText.replace(/\s+/g," ");if(!mstrApp.diParams.EnableFileImport&&(urlText.indexOf("file://")===0)){support.protocolDisabled=true;support.protocol+="file://";}if(!mstrApp.diParams.EnableFTPImport&&(urlText.indexOf("ftp://")===0)){support.protocolDisabled=true;support.protocol+="ftp://";}if(!mstrApp.diParams.EnableHttpImport&&(urlText.indexOf("http://")===0)){support.protocolDisabled=true;support.protocol+="http://";}if(!mstrApp.diParams.EnableHttpImport&&(urlText.indexOf("https://")===0)){support.protocolDisabled=true;support.protocol+="https://";}}return support;}function doImport(action){var i;var urls=[];var component;if(this.mode===URL_UPLOAD){mstrmojo.hash.copy(this.urlList.urls,urls);}else{mstrmojo.hash.copy(this.urlBrowse.getDropZone().urls,urls);}var controller=mstrApp.getRootController();var urlSupport,msg,url;if(typeof String.prototype.trim!=="function"){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"");};}if(this.mode===URL_UPLOAD){if(this.urlInput.value&&this.urlInput.value.length>0){urls.push(this.urlInput.value);}}for(i=0;i<urls.length;i++){url=urls[i].trim();urls[i]=url;if(!isValidProtocol.call(this,url)){controller.displayError(mstrmojo.desc(12512,"We do not support the URL protocol you provided."),false);return ;}urlSupport=isURLSupported.call(this,url);if(urlSupport.protocolDisabled){msg=mstrmojo.desc(12811,"Unable to fetch data. Importing files using #### has been disabled by the administrator.").replace("####",urlSupport.protocol);controller.displayError(msg,false);return ;}}if(this.mode===URL_UPLOAD){component=this.urlList;}else{component=this.urlBrowse.getDropZone();}controller.importURLEMMA(component,urls,true,!controller.model.hasEMMAReportInstance(),this.id,true,action,this.id);}function jointUrl(url,callBackUrl,clientIdStr,urlStr,isWS){var myReg=/\?/,index=myReg.test(url)?"&":"?",evnIndex=isWS?"env=WS":"",evtIndex=isWS?"":"?evt=3172",parameterIndex=!!urlStr?("&parameter="+urlStr):"";return url+index+evnIndex+"&callback="+callBackUrl+evtIndex+clientIdStr+parameterIndex;}function joinUrlForCE(baseURL,displayName,modelURL,isWS,isRepublish,isEdit,sourceName){var localSourceName=dbName2SourceName(displayName);var resURL=baseURL+"?sourceName="+(localSourceName?localSourceName:sourceName)+(isWS?"&env=WS":"")+"&tableSelect="+(isRepublish?"0":"1"),start,encodeURLStr;if(isEdit){start=modelURL.indexOf(GENERIC_TAG)+GENERIC_TAG.length+1;encodeURLStr=window.btoa(encodeURI(modelURL.substring(start,modelURL.length-2)));resURL=resURL+"&parameter="+encodeURLStr;}return resURL;}function mstrGdcFileCheck(isPost){if(!$HELPER.isWS()&&!isPost){console.log("Old version connector (Get).");}else{console.log("New version connector (Post).");}}mstrmojo.DI.DIURLUpload=mstrmojo.declare(mstrmojo.Container,null,{scriptClass:"mstrmojo.DI.DIURLUpload",cssClass:"mstrmojo-di-fu",markupString:'<div id="{@id}" class="mstrmojo-di-fileUpload {@cssClass}" ><div class="mstrmojo-di-URLUpload-networkBrowser"></div><div class="mstrmojo-di-URLUpload-label"></div><div class="mstrmojo-di-URLUpload-urlInput"></div><div class="mstrmojo-di-URLUpload-urlList"></div><div class="mstrmojo-di-URLUpload-info"></div></div>',markupSlots:{containerNode:function(){return this.domNode;},networkBrowserNode:function(){return this.domNode.children[0];},labelNode:function(){return this.domNode.children[1];},urlInputNode:function(){return this.domNode.children[2];},urlListNode:function(){return this.domNode.children[3];},infoNode:function(){return this.domNode.children[4];}},markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";}},oriFileExt:"",mode:URL_UPLOAD,singleURL:false,isRefreshPartition:false,isNewConnector:false,isNewConnectorEdit:false,responseHandler:null,workstationResponseEvt:null,afterOAuth:function(){var that=this;window.setTimeout(function(){if(that.popupWnd&&!that.popupWnd.closed){that.popupWnd.close();}that.popupWnd=null;},0);},fetchCEData:function(params,dbr){var me=this;if(me.workstationResponseEvt){mstrApp.getRootController().model.detachEventListener(me.workstationResponseEvt);}me.afterOAuth();$DOM.detachEvent(window,"message",me.responseHandler);me.responseHandler=null;if(me.parent){var obj;var index=params.indexOf("&");var str=params.substring(index+6,params.length);str=decodeURI(window.atob(str));obj=JSON.parse(str);mstrGdcFileCheck(obj.isPost);var list=tableParse(obj);for(var i=0;i<list.length;i++){me.urlList.addAuthURL(list[i],dbr);}me.onNextButtonClick();me.urlList.url=null;}},fetchData:function(params,dbr,verCmp){var me=this;if(me.workstationResponseEvt){mstrApp.getRootController().model.detachEventListener(me.workstationResponseEvt);}me.afterOAuth();$DOM.detachEvent(window,"message",me.responseHandler);me.responseHandler=null;if(me.parent){var obj,matched=true;var index=params.indexOf("&");var str=params.substring(index+6,params.length);me.parent.conParameter+=decodeURI(str);str=decodeURI(window.atob(str));obj=JSON.parse(str);mstrGdcFileCheck(obj.isPost);if(obj&&obj.versionNo){if(SDK.floor){matched=(verCmp(SDK.floor,obj.versionNo)!==1?true:false);}if(matched&&SDK.ceil){matched=(verCmp(SDK.ceil,obj.versionNo)===1?true:false);}}if(matched){var list=tableParse(obj);if(me.urlList.visible===false){me.urlList.set("visible",true);}for(var i=0;i<list.length;i++){me.urlList.addAuthURL(list[i],dbr);}me.onNextButtonClick();me.urlList.url=null;}else{mstrApp.getRootController().displayError(mstrmojo.desc(15084,"The Intelligence Server version and the SDK version are incompatible."),false);}}},matchAndUpdateTables:function(dbr,tableName,list,scheduleHandler){var me=this,changeFlag=false,currentTable,currentTableAfterSdk,currentTableOldVersion;if(tableName){currentTable=getTableName(tableName);}else{if(me.isRefreshPartition){currentTable=[];currentTableOldVersion=[];$H.forEach(me.urlList.urls,function(table){var name=getTableName(table);currentTable.push(name);currentTableOldVersion.push("{"+name+"}");});}else{currentTable="{"+me.urlInput.value+"}";currentTableOldVersion="{"+currentTable+"}";}}if(me.isRefreshPartition){me.urlList.urls=[];for(var i=0;i<list.length;i++){for(var j=0;j<currentTable.length;j++){if(currentTable[j]===getTableName(list[i])||currentTableOldVersion[j]===getTableName(list[i])){me.urlList.addAuthURL(list[i],dbr);}}}changeFlag=me.urlList.urls.length===currentTable.length;if(scheduleHandler){scheduleHandler();return ;}}else{for(var i=0;i<list.length;i++){if(list.length===1||currentTable===getTableName(list[i])||currentTableOldVersion===getTableName(list[i])){me.urlInput.value="";changeFlag=true;if(scheduleHandler){currentTableAfterSdk=list[i];}else{me.urlList.addAuthURL(list[i],dbr);}break;}}if(scheduleHandler){me.urlInput.value=currentTableAfterSdk;scheduleHandler();return ;}}return changeFlag;},EditData:function(params,dbr,tableName,scheduleHandler){var me=this;if(me.workstationResponseEvt){mstrApp.getRootController().model.detachEventListener(me.workstationResponseEvt);}me.afterOAuth();$DOM.detachEvent(window,"message",me.responseHandler);me.responseHandler=null;if(me.parent){var index=params.indexOf("&");var str=params.substring(index+6,params.length);me.parent.conParameter+=decodeURI(str);str=decodeURI(window.atob(str));var obj=JSON.parse(str);mstrGdcFileCheck(obj.isPost);var list=tableParse(obj);var changeFlag=me.matchAndUpdateTables(dbr,tableName,list,scheduleHandler);if(changeFlag){me.onNextButtonClick();}else{mstrApp.getRootController().displayError(mstrmojo.desc(15078,"Tablename ## cannot be found in the table list.".replace("##",me.isRefreshPartition?currentTable.join():currentTable)));}if(!$HELPER.isServerBasedWS()){mstrApp.getRootController().onCancelButtonClick(true);}me.urlList.url=null;}},detectCancel:function(cfm,doNotCloseParent){var me=this;var loop=setInterval(function(){if(me.popupWnd&&me.popupWnd.closed){cfm&&cfm.close();clearInterval(loop);if($HELPER.isWS()&&me.workstationResponseEvt){mstrApp.getRootController().model.detachEventListener(me.workstationResponseEvt);}else{$DOM.detachEvent(window,"message",me.responseHandler);}if(!doNotCloseParent){mstrApp.getRootController().onCancelButtonClick();}}},500);},init:function init(props){if(this._super){this._super(props);}var evtConfig={},cfg=evtConfig[this.id]={},controller=mstrApp.getRootController();var isSchedule=props.isSchedule,scheduleHandler,responseHandler;var me=this;var model=mstrApp.getRootController().getModel();var isRepublish=model.operationMode===constants.operationMode.refresh;var url;this.tableID=this.tableID?this.tableID:(props.currentSource&&props.currentSource.tableID);this.sourceInfo=this.sourceInfo?this.sourceInfo:props.currentSource;if(props.onFinishButtonClick){scheduleHandler=props.onFinishButtonClick.bind(this);}cfg.windowSizeChanged=this.adjustSize;controller.attachDataChangeListeners(evtConfig);var mode=modeSelect(props);if(mode!==constants.URLMode.NormalUrl){var clientIdStr="";var cfm=mstrmojo.alert(null,null,null,null,"mstrmojo-alert-hidden");if(!window.location.origin){window.location.origin=window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"");}if(me.workstationResponseEvt){model.detachEventListener(me.workstationResponseEvt);}var callbackStr=window.location.origin+window.location.pathname;if(mode===constants.URLMode.NewConnectorEdit){mstrApp.isNewConnectorEdit=true;me.isNewConnectorEdit=true;me.isNewConnector=true;mstrApp.newConDbroleId=props.currentSource.sourceInfo.dbRoleId;var parameter=props.currentSource.sourceInfo.url;var start=parameter.indexOf(GENERIC_TAG)+GENERIC_TAG.length+1;var urlStr=window.btoa(encodeURI(parameter.substring(start,parameter.length-2)));url=props.currentSource.sourceInfo.sdkUrl;var connURL;var dbr={did:mstrApp.newConDbroleId};if(props.currentSource.sourceInfo.clientId){clientIdStr=CLIENTID_PREFIX+window.btoa(encodeURI(props.currentSource.sourceInfo.clientId));}mstrApp.conUrl=url;if(isSchedule){this.sdkUrl=url;}if($HELPER.isWS()){connURL=jointUrl(url,WS_CALLBACK,clientIdStr,urlStr,true);me.workstationResponseEvt=mstrApp.getRootController().model.attachEventListener("getConnectorParameter",this.id,function(evt){cfm&&cfm.close();me.EditData(evt.data,dbr);});}else{connURL=jointUrl(url,callbackStr,clientIdStr,urlStr,false);responseHandler=function OAuthResponseHandler(evt){cfm&&cfm.close();if(isSchedule){me.EditData(evt.data,dbr,parameter,scheduleHandler);}else{me.EditData(evt.data,dbr,null,null);}};}me.popupWnd=$HELPER.openPopupWindow(me.popupWnd,"Authorization",connURL);if(!me.popupWnd){controller.displayError(mstrmojo.desc(12894,"Your browser has blocked the popup for this site. Please enable the popup for this site in order to continue and sign in."),false);}me.detectCancel(cfm);}else{if(mode===constants.URLMode.NewConnector){me.isNewConnector=true;url=mstrApp.conUrl.trim();var connURL;var dbr={did:mstrApp.newConDbroleId};var verCmp=function(fst,sec){var result;fst=fst.split(".");sec=sec.split(".");for(var i=0;i<fst.length;i++){var v1=parseInt(fst[i],10),v2=parseInt(sec[i],10);if(isNaN(v1)&&!isNaN(v2)){result=-1;break;}else{if(!isNaN(v1)&&isNaN(v2)){result=1;break;}else{if(isNaN(v1)&&isNaN(v2)){result=0;break;}else{if(!isNaN(v1)&&!isNaN(v2)){result=(v1-v2>0?1:(v1===v2?0:-1));if(0===result){continue;}break;}}}}}return result;};if(mstrApp.clientId){var clientIdStr=CLIENTID_PREFIX+window.btoa(encodeURI(mstrApp.clientId));}if($HELPER.isWS()){connURL=jointUrl(url,WS_CALLBACK,clientIdStr,null,true);me.workstationResponseEvt=model.attachEventListener("getConnectorParameter",this.id,function(evt){cfm&&cfm.close();me.fetchData(evt.data,dbr,verCmp);});}else{connURL=jointUrl(url,callbackStr,clientIdStr,null,false);responseHandler=function OAuthResponseHandler(evt){cfm&&cfm.close();me.fetchData(evt.data,dbr,verCmp);};}me.popupWnd=$HELPER.openPopupWindow(me.popupWnd,"Authorization",connURL);if(!me.popupWnd){controller.displayError(mstrmojo.desc(12894,"Your browser has blocked the popup for this site. Please enable the popup for this site in order to continue and sign in."),false);}me.detectCancel(cfm,true);}else{if(mode===constants.URLMode.CloudElement){var dbRoleInfo,idx,dbRole;var source=me.model.importSources[me.tableID];var dbRoleId=(source&&source.sourceInfo&&source.sourceInfo.dbRoleId)||(me.sourceInfo&&me.sourceInfo.did);var token,baseURL;if(model.operationMode===constants.operationMode.subscribe&&source.alternateSource){url=source.alternateSource.tableName;}else{url=source&&source.sourceInfo&&source.sourceInfo.url;}if(dbRoleId){idx=$ARR.find(me.model.cloudElementDBRoles,"did",dbRoleId);if(idx>-1){dbRoleInfo=me.model.cloudElementDBRoles[idx];}}dbRole={did:dbRoleId};var handleResponse=function(res){if(res.data===CE_READY){var response={token:token,callback:$HELPER.isWS()?WS_CALLBACK:callbackStr,baseURL:baseURL};$HELPER.sendResponse2Window(response,window.location.origin,me.popupWnd);}else{cfm&&cfm.close();if(model.operationMode===constants.operationMode.subscribe){var parameter=props.currentSource.sourceInfo.url;me.EditData(res.data,dbRole,parameter,scheduleHandler);return ;}if(!isRepublish){me.fetchCEData(res.data,dbRole);}else{me.afterOAuth();}}};if($HELPER.isWS()){me.workstationResponseEvt=model.attachEventListener("getConnectorParameter",this.id,function(evt){handleResponse(evt);});}responseHandler=function OAuthResponseHandler(evt){handleResponse(evt);};me.popupWnd=$HELPER.openPopupWindow(me.popupWnd,"Authorization","../html/CloudElementWaiting.html");if(!me.popupWnd){controller.displayError(mstrmojo.desc(12894,"Your browser has blocked the popup for this site. Please enable the popup for this site in order to continue and sign in."),false);}var getCloudElementTokenCallback={success:function(res){var displayName=me.sourceInfo.n||(dbRoleInfo&&dbRoleInfo.n);var sourceName=dbRoleInfo&&dbRoleInfo.des;token=res.token;baseURL=res.url;me.popupWnd.location=joinUrlForCE("../html/CloudElementWaiting.html",displayName,url,$HELPER.isWS(),isRepublish,me.tableID,sourceName);me.detectCancel(cfm,!me.tableID);},failure:function(res){cfm&&cfm.close();console.log("error happened when get token, detailed error message is"+JSON.stringify(res));}};mstrApp.getRootController().getDataService().getCloudElementToken(getCloudElementTokenCallback);}}}if($HELPER.isIE()){window.postMessagePassthrough=function(response,origin){responseHandler({origin:origin,data:response});};}if(me.responseHandler){$DOM.detachEvent(window,"message",me.responseHandler);}$DOM.attachEvent(window,"message",responseHandler);me.responseHandler=responseHandler;}},adjustSize:function adjustSize(evt){var width=parseInt(evt.size.w,10),height=parseInt(evt.size.h,10),children,cheight=parseInt(evt.size.layoutH),margin=width/2-340,leftPanelWidth;if(isNaN(width)){return ;}if(!isNaN(height)){this.domNode.style.height=height+"px";}children=this.urlInputNode.children;children[0].style.marginLeft=margin+"px";this.urlList.dnDNode.style.marginLeft=margin+"px";leftPanelWidth=Math.round(width*0.482);children[3].style.width=leftPanelWidth-22+"px";this.labelNode.firstChild.style.paddingTop=height*0.2+"px";var imgSize=this.label.getImageSize().h?parseInt(this.label.getImageSize().h)+5:99;this.urlList.domNode.style.height=cheight-height*0.2-imgSize-this.labelTitle.domNode.offsetHeight-this.urlInputNode.offsetHeight-2+"px";if(this.mode==URL_UPLOAD){this.urlList.size={w:children[2].offsetLeft-children[0].offsetLeft+children[2].offsetWidth+"px",h:this.urlList.domNode.style.height,urlpage:true};this.urlList.adjustSize(this.urlList.size);}this.urlBrowse.adjustSize(evt.size);},preBuildRendering:function preBuildRendering(){if(this._super){this._super();}this.urlBrowse.multiSelect=!this.singleURL;},onclick:function(evt){var src=mstrmojo.dom.eventTarget(evt.hWin,evt.e);var urlInput=this.urlInput;if(src!==urlInput.domNode){urlInput.blur();}},postBuildRendering:function(){mstrmojo.dom.attachMarkupEvent(this.id,this.containerNode,"click");if(this.mode===constants.URLMode.NormalUrl){this.getManagedAuthDBR(this.tableID);}if(this._super){return this._super();}},getManagedAuthDBR:function(tableID){var controller=mstrApp.getRootController();controller.getManagedAuthDBR(tableID);},onHelpButtonClick:function onHelpButtonClick(){return"Importing_data_from_URL.htm";},onNextButtonClick:function onNextButtonClick(){doImport.call(this,this.tableID?constants.actions.refreshData:constants.actions.importSource);},onFinishButtonClick:function(){doImport.call(this,constants.actions.savePublish);},onBackButtonClick:function onBackButtonClick(){var controller=mstrApp.getRootController();controller.showPage(constants.pageType.dataSelection);},updatePageConfig:function(config){var page=this,tableId,currentSource,urls=[],urlList=this.urlList,urlInput=this.urlInput,source,dbRoleId,idx,dbRole;if(config&&config.properties){mstrmojo.hash.forEach(config.properties,function(value,key){page.set(key,value);});}this.set("isRefreshPartition",this.isRefreshPartitionTable());if(this.isRefreshPartition){tableId=this.tableID;currentSource=this.model.importSources[tableId];$ARR.forEach(currentSource.sourceInfo.partition.tables,function(partitionTable){urls.push(partitionTable.name||"");});}source=this.model.importSources[this.tableID];dbRoleId=source&&source.sourceInfo&&source.sourceInfo.dbRoleId;if(dbRoleId){this.dbroles.updateSelectedItemById(dbRoleId);idx=$ARR.find(this.model.authDBRoles,"did",dbRoleId);if(idx>-1){dbRole=this.model.authDBRoles[idx];}}if(urls.length>1){urlInput.set("value","");if(urlList.visible===false){urlList.set("visible",true);}$ARR.forEach(urls,function(url){if(dbRole){urlList.addAuthURL(url,dbRole);}else{urlList.addURL(url);}});}else{if(this.isFromCloudElement){}else{urlInput.set("value",config.name);}}},setFilesObject:function(files){if(files.length>0){if(this.mode===URL_UPLOAD){var value=mstrmojo.string.trim(this.urlInput.value);var idx=mstrmojo.array.indexOf(files,value);if(idx>=0){files.splice(idx,1);this.urlList.setURLsObject(files);}else{this.urlInput.set("value","");this.urlList.setURLsObject(files);}}else{this.urlBrowse.setURLsObject(files);}}},onforceEnableChange:function(){mstrApp.getRootController().sourceSelected(this.forceEnable);},getOperationMode:function(){var r=this.model.operationMode;if(isOperationMode(this.operationMode)){r=this.operationMode;}return r;},enableImport:function enableImport(){var controller=mstrApp.getRootController();if(this.urlList.urls.length>0||(this.urlInput.value&&this.urlInput.value!==""&&this.mode===URL_UPLOAD)||this.forceEnable===true||(this.mode===NETWORK_BROWSING&&this.urlBrowse.getDropZone().urls.length>0)){controller.sourceSelected(true);}else{controller.sourceSelected(false);}},onmodeChange:function onmodeChange(){var i;var dzone=this.urlBrowse.getDropZone();this.btnAdd.updateVisibility();if(this.mode===URL_UPLOAD){this.urlList.urls=[];this.urlList.dbrs=[];this.urlList.removeChildren();for(i=0;i<dzone.urls.length;i++){if(dzone.dbrs.length&&i<dzone.dbrs.length&&dzone.dbrs[i]){this.urlList.addAuthURL(dzone.urls[i],dzone.dbrs[i]);}else{this.urlList.addURL(dzone.urls[i]);}}if(this.urlList.urls.length>0){if(this.urlList.visible===false){this.urlList.set("visible",true);}}this.urlList.adjustSize(this.urlList.size);}else{this.urlList.set("visible",false);this.urlBrowse.getDropZone().urls=[];this.urlBrowse.getDropZone().dbrs=[];this.urlBrowse.getDropZone().removeChildren();for(i=0;i<this.urlList.urls.length;i++){if(this.urlList.dbrs.length&&i<this.urlList.dbrs.length&&this.urlList.dbrs[i]){this.urlBrowse.getDropZone().addURL(this.urlList.urls[i],this.urlList.urls[i].substr(this.urlList.urls[i].lastIndexOf("/")+1),false,this.urlList.urls[i],this.urlList.dbrs[i]);}else{this.urlBrowse.getDropZone().addURL(this.urlList.urls[i],this.urlList.urls[i].substr(this.urlList.urls[i].lastIndexOf("/")+1));}}}this.enableImport();},getURLs:function getURLs(){var urls=[];if(this.mode===URL_UPLOAD){urls=this.urlList.urls.concat();if(this.urlInput.value.length>0){urls.push(this.urlInput.value);}}else{urls=this.urlBrowse.getDropZone().urls.concat();}$ARR.forEach(urls,function(url,i){urls[i]=url.trim();});return urls;},isRefreshPartitionTable:function isRefreshPartitionTable(){var mode=this.getOperationMode(),tableId,currentSource,partition,isRefresh=false;if(mode===constants.operationMode.edit){tableId=this.tableID;currentSource=this.model.importSources[tableId];partition=currentSource.sourceInfo.partition;isRefresh=!!partition&&partition.isPartition&&currentSource.xdaType===constants.xdaType.text;}return isRefresh;},children:[{slot:"networkBrowserNode",scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-fu-link",text:mstrmojo.desc(12733,"Network Browser"),alias:"urlRadioList",onclick:function(){if(this.parent.mode===URL_UPLOAD){this.parent.set("mode",NETWORK_BROWSING);this.set("text",mstrmojo.desc(14767,"Data from URL"));this.parent.urlList.dnDNode.style.cssText="";var browser=this.parent.urlBrowse.mainPage.content.objectListPanel.browser.domNode;browser.style.maxWidth=browser.offsetWidth+"px";}else{this.parent.set("mode",URL_UPLOAD);if(this.parent.currentSource&&this.parent.urlList.dnDNode){var dndNode=this.parent.urlList.dnDNode,urlInput=this.parent.urlInput.domNode,dbroles=this.parent.dbroles.domNode;dndNode.style.cssText="margin-left:"+urlInput.offsetLeft+"px !important; width:"+(dbroles.offsetLeft+dbroles.offsetWidth-urlInput.offsetLeft)+"px;";this.set("text",mstrmojo.desc(12733,"Network Browser"));}}},bindings:{text:function(){if(this.parent.mode===NETWORK_BROWSING){return mstrmojo.desc(14767,"Data from URL");}else{return mstrmojo.desc(12733,"Network Browser");}}}},{slot:"labelNode",scriptClass:"mstrmojo.Image",alias:"label",cssClass:"mstrmojo-di-fu-img",src:"../javascript/mojo/css/images/DI/crosstab.svg",bindings:{visible:function(){return this.parent.mode===URL_UPLOAD;}}},{slot:"labelNode",alias:"labelTitle",scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-di-fu-title",text:mstrmojo.desc(12691,"Data can be in crosstab or tabular format"),bindings:{visible:function(){return this.parent.mode===URL_UPLOAD;}}},{slot:"urlInputNode",scriptClass:"mstrmojo.TextBox",cssClass:"upload-url",alias:"urlInput",initValue:false,onvalueChange:function(){if(this._super){this._super();}this.parent.enableImport();},bindings:{visible:function(){return this.parent.mode===URL_UPLOAD;}},postBuildRendering:function(){this.emptyText=mstrmojo.desc(12812,"Supported URL format: #### ").replace("####",mstrmojo.DI.DIHelpers.getURLCaption());if(this._super){return this._super();}}},{slot:"infoNode",scriptClass:"mstrmojo.Label",cssDisplay:"inline-block",cssClass:"mstrmojo-di-fu-url-supported",bindings:{text:function(){return"Use original URL or update with a new URL to refresh this table.";},visible:function(){return this.parent.mode===URL_UPLOAD&&this.parent.getOperationMode()!==constants.operationMode.create;}},markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";this.parent.urlListNode.style.display=this.visible?"none":"block";},ontextChange:function(){this.innerText=this.text;}}},{slot:"infoNode",scriptClass:"mstrmojo.Label",cssDisplay:"inline-block",text:"",cssClass:"mstrmojo-di-fu-url-previously",bindings:{visible:function(){return this.text!==""&&!this.parent.isRefreshPartition&&this.parent.mode===URL_UPLOAD;}},postBuildRendering:function postBuildRendering(){if((isOperationMode(this.parent.operationMode)?this.parent.operationMode:this.parent.model.operationMode)!==constants.operationMode.create){this.set("text",mstrmojo.desc(13133,"Previously uploaded URL:"));}}},{slot:"infoNode",scriptClass:"mstrmojo.Label",cssDisplay:"inline-block",text:"",cssClass:"mstrmojo-di-fu-url-info",bindings:{visible:function(){return this.text!==""&&!this.parent.isRefreshPartition&&this.parent.mode===URL_UPLOAD;}},postBuildRendering:function postBuildRendering(){var m=this.parent.model;var tableId=this.parent.tableID;var source;if(this.currentSource){source=this.currentSource;}else{source=m.importSources[tableId];}if((isOperationMode(this.parent.operationMode)?this.parent.operationMode:this.parent.model.operationMode)!==constants.operationMode.create){var url=source.sourceInfo.url;if(url.length>90){this.set("text",url.substring(0,65)+"..."+url.substring(url.length-20));}else{this.set("text",url);}this.set("title",url);}}},{slot:"infoNode",scriptClass:"mstrmojo.Label",text:"",cssClass:"mstrmojo-di-url-browser-info",bindings:{visible:function(){return this.text!==""&&!this.parent.isRefreshPartition&&this.parent.mode===NETWORK_BROWSING;}},postBuildRendering:function postBuildRendering(){var m=this.parent.model;var tableId=this.parent.tableID;var source;if(this.currentSource){source=this.currentSource;}else{source=m.importSources[tableId];}if((isOperationMode(this.parent.operationMode)?this.parent.operationMode:this.parent.model.operationMode)!==constants.operationMode.create){var url=source.sourceInfo.url;if(url.length>75){this.set("text",mstrmojo.desc(13133,"Previously uploaded URL:")+" "+url.substring(0,50)+"..."+url.substring(url.length-20));}else{this.set("text",mstrmojo.desc(13133,"Previously uploaded URL:")+" "+url);}this.set("title",url);}}},{slot:"urlInputNode",scriptClass:"mstrmojo.DI.DIAuthenticationButton",cssClass:"mstrmojo-di-add-authentication",alias:"dbroles",bindings:{visible:function(){return this.parent.mode===URL_UPLOAD;}},markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"inline-block":"none";},onvalueChange:function(){if(this.textNode){this.textNode.innerHTML=$S.encodeHtmlString(this.value)||"";}}}},{slot:"urlInputNode",alias:"btnAdd",scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-add-url-button mstrmojo-di-button mstrmojo-WebButton",text:mstrmojo.desc(531,"Add"),onclick:function(){var url=this.parent.urlInput.value;var dbrole=this.parent.dbroles.getSelectedDBRole();if(url.length===0){return ;}if(this.parent.urlList.visible===false){this.parent.urlList.set("visible",true);}this.parent.urlList.addAuthURL(url,dbrole);this.parent.urlInput.set("value","");},updateVisibility:function(){var parent=this.parent;var operationMode=parent.getOperationMode();var visible=true;if(operationMode===constants.operationMode.create){visible=true;}else{visible=parent.isRefreshPartitionTable();}visible=(this.parent.mode===URL_UPLOAD&&visible&&!parent.singleURL);this.set("visible",visible);},postBuildRendering:function(){this.updateVisibility();},markupMethods:{ontextChange:function(){if(this.textNode.innerText){this.textNode.innerText=this.text;}else{this.textNode.innerHTML=$S.encodeHtmlString(this.text)||"";}},onvisibleChange:function(){this.domNode.style.display=this.visible?"inline-block":"none";}}},{slot:"urlInputNode",scriptClass:"mstrmojo.TextBox",alias:"urlBrowseInput",cssClass:"mstrmojo-di-url-browse-input",initValue:false,onvalueChange:function(){if(this._super){this._super();}this.parent.enableImport();},bindings:{visible:function(){return this.parent.mode===NETWORK_BROWSING;}},preBuildRendering:function(){if(this._super){this._super();}this.emptyText=mstrmojo.desc(12812,"Supported URL format: #### ").replace("####",mstrmojo.DI.DIHelpers.getURLCaption());}},{slot:"urlInputNode",alias:"urlBrowseAuthBtn",scriptClass:"mstrmojo.DI.DIAuthenticationButton",cssClass:"mstrmojo-di-browse-add-authentication",bindings:{visible:function(){return this.parent.mode===NETWORK_BROWSING;}},markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"inline-block":"none";},onvalueChange:function(){if(this.textNode){this.textNode.innerHTML=$S.encodeHtmlString(this.value)||"";}}}},{slot:"urlInputNode",scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-add-url-browse-button mstrmojo-di-button mstrmojo-WebButton",text:mstrmojo.desc(12734,"Enter"),onclick:function(){var parent=this.parent;var ob=parent.urlBrowse.getObjectBrowser();var dbrole=parent.urlBrowseAuthBtn.getSelectedDBRole();ob.clickedNode=ob.fileTree;if(dbrole&&dbrole.did!==-1){mstrApp.getRootController().browseURLPath(parent.urlBrowseInput.value,parent.urlBrowse,dbrole.did);}else{var callback=function(list,items){if((parent.mode===NETWORK_BROWSING)&&items.length&&parent.currentSource){list.fileTree.domNode.style.backgroundColor="transparent";list.fileTree.domNode.style.border="0";list.domNode.style.top="0px";list.domNode.style.marginTop="0px";}};mstrApp.getRootController().browseURLPath(parent.urlBrowseInput.value,parent.urlBrowse,null,callback);}},bindings:{visible:function(){return this.parent.mode===NETWORK_BROWSING;}},markupMethods:{ontextChange:function(){if(this.textNode.innerText){this.textNode.innerText=this.text;}else{this.textNode.innerHTML=this.textNode.innerHTML=$S.encodeHtmlString(this.text)||"";}},onvisibleChange:function(){this.domNode.style.display=this.visible?"inline-block":"none";}}},{slot:"urlListNode",scriptClass:"mstrmojo.DI.FileDragDropBox",alias:"urlList",text:"",draggable:false,fileUpload:false,cssClass:"mstrmojo-di-url-box",bindings:{visible:function(){var parent=this.parent,mode=parent.getOperationMode(),isVisible=this.urls.length>0&&parent.mode===URL_UPLOAD;isVisible=isVisible&&(mode===constants.operationMode.create||parent.isRefreshPartitionTable());return isVisible;}},getFilesCnt:function(){var cnt=0;if(this.parent.urlInput.value&&this.parent.urlInput.value!==""){cnt=this.urls?this.urls.length+1:1;}else{cnt=this.urls?this.urls.length:0;}return cnt;},getFileUrl:function(idx){var url="";if(idx<this.urls.length){url=mstrmojo.string.trim(this.urls[idx]);}else{if(this.parent.urlInput.value!==""){url=mstrmojo.string.trim(this.parent.urlInput.value);}}if(url.substring(0,10)==TABLE_NAME_TAG){return url;}var originlUrl=url;try{var url_decodeURIComponent=decodeURIComponent(url);url=url_decodeURIComponent===url?url:url_decodeURIComponent;var url_decodeURI=decodeURI(url);url=url_decodeURI===url?encodeURI(url):url;return url;}catch(err){return originlUrl;}},getFileUrlDBRole:function(idx){var dbroles=this.parent.dbroles,dbr;if(idx<this.urls.length){dbr=this.dbrs[idx];}else{dbr=dbroles.getSelectedDBRole();}if(dbr&&dbr.did===-1){return null;}return dbr&&dbr.did;},onurlsChange:function(){if(this._super){this._super();}this.parent.enableImport();if(this.updateItemsCount){this.updateItemsCount(this.getURLCnt());var cnt=this.getURLCnt();this.updateItemsCount(cnt);}}},{slot:"urlListNode",scriptClass:"mstrmojo.DI.DIDragFiles",alias:"urlBrowse",supportFolderDrag:false,bindings:{visible:function(){return(this.parent.mode===NETWORK_BROWSING);}},postBuildRendering:function(){var parent=this.parent,mode=parent.getOperationMode(),multiSelect=mode===constants.operationMode.create||parent.isRefreshPartitionTable();if(mstrmojo.DI.DIDragFiles.prototype.postBuildRendering){mstrmojo.DI.DIDragFiles.prototype.postBuildRendering.call(this);}this.set("multiSelect",multiSelect);this.mainPage.content.objectListPanel.browser.set("showBrowseText",true);},ondrop:function ondrop(evt){if(!this.droppable){return ;}var selectedNodes=evt.src.data,i;var list=this.parent.parent.parent;var dbrole=list.parent.urlBrowseAuthBtn.getSelectedDBRole();for(i=0;i<selectedNodes.length;i++){this.addURL(selectedNodes[i].data.address,selectedNodes[i].text,undefined,selectedNodes[i].data.address,dbrole);}mstrmojo.css.removeClass(this.dnDNode,"dragging");},browseFunction:function browseFunction(node){var dbrole=this.parent.parent.parent.parent.parent.urlBrowseAuthBtn.getSelectedDBRole();if(dbrole&&dbrole.did!==-1){mstrApp.getRootController().urlBrowserFunction(node,dbrole.did);}else{mstrApp.getRootController().urlBrowserFunction(node);}},setURLsObject:function setURLsObject(urls){var i,child,cnt;var toRemovedChild=[];var urlPanel=this.mainPage.content.urlList;for(i=0;urlPanel.children&&i<urlPanel.children.length;i++){child=urlPanel.children[i];toRemovedChild.push(child);}cnt=toRemovedChild.length;for(i=0;i<cnt;i++){urlPanel.removeChildren(toRemovedChild[i]);}urlPanel.urls=[];for(i=0;i<urls.length;i++){var url=decodeURI(urls[i].substr(urls[i].lastIndexOf("/")+1));urlPanel.addURL(null,url);}}}]});}());