(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.array","mstrmojo.gmaps.MapEnums","mstrmojo.mapbox.MapboxEnums","mstrmojo.gmaps.MapUtils","mstrmojo.gmaps.layer.mapbox.GraphicLayerViewer");var $MOJO=mstrmojo,$H=$MOJO.hash,$ARR=$MOJO.array,$GMAPS=$MOJO.gmaps,$MAPBOX=$MOJO.mapbox,$MUTILS=$GMAPS.MapUtils,$DLShOpt=$GMAPS.EnumDataLabelShowOption,ID_SUFFIX=$MAPBOX.ID_SUFFIX,NOFEATURE=$MAPBOX.FILTER.NOFEATURE;function convertStrokeDashArray(arr){if(!arr||arr.length<=0){return null;}else{if(arr.length===1){return arr.concat(arr);}}return arr;}mstrmojo.gmaps.layer.mapbox.PolygonLayerViewer=mstrmojo.declare(mstrmojo.gmaps.layer.mapbox.GraphicLayerViewer,null,{scriptClass:"mstrmojo.gmaps.layer.mapbox.PolygonLayerViewer",type:"fill",borderType:"line",labelTextAnchor:"center",shapeFmtNames:{fillColor:"fill-color",fillOpacity:"fill-opacity",strokeWidth:"line-width",strokeColor:"line-color",strokeStyle:"line-dasharray"},getData:function getData(graphics){var me=this,data={polyFilters:["in","id"],colorStops:[],opacityStops:[],seleColorStops:[],hoverColorStops:[],unSelectedColorStops:[],textStops:{},featureIdGraphicIdMap:{}},polyFilters=data.polyFilters,colorStops=data.colorStops,opacityStops=data.opacityStops,seleColorStops=data.seleColorStops,hoverColorStops=data.hoverColorStops,unSelectedColorStops=data.unSelectedColorStops,textStops=data.textStops,idsMap=data.featureIdGraphicIdMap,featureId;$ARR.forEach([$DLShOpt.SHOW_TEXT,$DLShOpt.SHOW_VALUE,$DLShOpt.SHOW_BOTH],function(key){textStops[key]=[];});$ARR.forEach(graphics,function(graphic){var attributes=graphic.attributes,properties=me.extractShapeProps(attributes);featureId=attributes.geoId;if(featureId){polyFilters.push(featureId);colorStops.push([featureId,properties.fillColor]);opacityStops.push([featureId,properties.fillOpacity]);seleColorStops.push([featureId,$MUTILS.fillColorAjustForCMSelection(properties.fillColor)]);hoverColorStops.push([featureId,$MUTILS.fillColorAjustForHover(properties.fillColor)]);unSelectedColorStops.push([featureId,properties.fillColor]);textStops[$DLShOpt.SHOW_TEXT].push([featureId,properties.labelText]);textStops[$DLShOpt.SHOW_VALUE].push([featureId,properties.labelValues]);textStops[$DLShOpt.SHOW_BOTH].push([featureId,properties.labelText+"\n"+properties.labelValues]);idsMap[featureId]=graphic.id;}});return data;},getMapID:function getMapID(){return $H.walk("parent.lookUpTable.TilesetName",this);},getPolygonLayerName:function getPolygonLayerName(){return $H.walk("parent.lookUpTable.PolyLayerName",this);},getDataLabelSourceLayer:function getDataLabelSourceLayer(){return $H.walk("parent.lookUpTable.PointLayerName",this);},getLabelTextOffset:function getLabelTextOffset(){return[0,0];},addSource:function addSource(){var map=this.getMapInstance(),mapId=this.getMapID(),sourceId=this.getSourceId();if(map&&mapId){if(map.getSource(sourceId)){map.removeSource(sourceId);}map.addSource(sourceId,{type:"vector",url:"mapbox://"+mapId});return true;}else{return false;}},addPolygonLayers:function addPolygonLayers(subId,filters,fillOptions,borderOptions){var map=this.getMapInstance(),id=this.getLayerId(),currentLayerId=id+subId,sourceId=this.getSourceId(),sourceLayerName=this.getPolygonLayerName();map.addLayer($H.copy(fillOptions,this.getLayerCtrlProps(currentLayerId,this.type,sourceId,filters,sourceLayerName)));this._layerIds.push(currentLayerId);if(borderOptions){currentLayerId=id+ID_SUFFIX.Border+subId;map.addLayer($H.copy(borderOptions,this.getLayerCtrlProps(currentLayerId,this.borderType,sourceId,filters,sourceLayerName)));this._layerIds.push(currentLayerId);}},getWorldViewFilter:function getWorldViewFilter(){return["in","worldview","all","US"];},getBaseFilters:function getBaseFilters(){return this.data.polyFilters;},getEmptyFilter:function getEmptyFilter(){return NOFEATURE;},getQualifiedFilter:function getQualifiedFilter(idListFilter){return idListFilter;},addLayers:function addLayers(){var map=this.getMapInstance();if(!map){return ;}this._layerIds=[];this.addPolygonLayers("",this.getBaseFilters(),this.getLayerOptions(),this.getLayerBorderOptions());this.addPolygonLayers(ID_SUFFIX.Unselected,NOFEATURE,this.getLayerOptionsUnselected());this.addPolygonLayers(ID_SUFFIX.Selection,NOFEATURE,this.getLayerOptionsSelection(),this.getLayerBorderOptionsSelection());this.addPolygonLayers(ID_SUFFIX.ContextMenu,NOFEATURE,this.getLayerOptionsContextMenu(),this.getLayerBorderOptionsContextMenu());this.addPolygonLayers(ID_SUFFIX.Hover,NOFEATURE,this.getLayerOptionsHover());this.addDataLabelLayer(map);},getStrokeClrFmtLayers:function getStrokeClrFmtLayers(){var id=this.getLayerId();return[id+ID_SUFFIX.Border];},getQueryLayers:function getQueryLayers(){var id=this.getLayerId();if(id){return this.validLayers([id+ID_SUFFIX.Hover,id+ID_SUFFIX.ContextMenu,id+ID_SUFFIX.Selection,id,id+ID_SUFFIX.Border+ID_SUFFIX.ContextMenu,id+ID_SUFFIX.Border+ID_SUFFIX.Selection,id+ID_SUFFIX.Border,id+ID_SUFFIX.Unselected]);}return[];},handleContextMenu:function handleContextMenu(graphics){var map=this.getMapInstance(),idList=this.getFeatureIDsFromGraphics(graphics),layerId=this.getLayerId(),filter;if(!map||!map.getLayer(layerId)){return ;}if(!idList){map.setFilter(layerId,this.getFilters4MainLayer(true));map.setFilter(layerId+ID_SUFFIX.Border,this.getFilters4MainLayer(true));map.setFilter(layerId+ID_SUFFIX.ContextMenu,this.getEmptyFilter());map.setFilter(layerId+ID_SUFFIX.Border+ID_SUFFIX.ContextMenu,this.getEmptyFilter());}},handleSelections:function handleSelections(idList){var map=this.getMapInstance(),layerId=this.getLayerId();if(!map||!map.getLayer(layerId)){return ;}if(!idList){map.setFilter(layerId,this.getFilters4MainLayer(true));map.setFilter(layerId+ID_SUFFIX.Border,this.getFilters4MainLayer(true));map.setFilter(layerId+ID_SUFFIX.Selection,this.getEmptyFilter());map.setFilter(layerId+ID_SUFFIX.Border+ID_SUFFIX.Selection,this.getEmptyFilter());map.setFilter(layerId+ID_SUFFIX.ContextMenu,this.getEmptyFilter());map.setFilter(layerId+ID_SUFFIX.Border+ID_SUFFIX.ContextMenu,this.getEmptyFilter());map.setFilter(layerId+ID_SUFFIX.Unselected,this.getEmptyFilter());}},handleHighlight:function handleHighlight(graphicsSel,graphicsCtx){var map=this.getMapInstance(),layerId=this.getLayerId(),idListSel=this.getFeatureIDsFromGraphics(graphicsSel),idListCtx=this.getFeatureIDsFromGraphics(graphicsCtx),idListAll=idListSel.concat(idListCtx),filter;if(!map||!map.getLayer(layerId)){return ;}map.setFilter(layerId,this.getEmptyFilter());map.setFilter(layerId+ID_SUFFIX.Border,this.getFilters4MainLayer(false,idListAll));filter=this.getQualifiedFilter(["in","id"].concat(idListSel));map.setFilter(layerId+ID_SUFFIX.Selection,filter);map.setFilter(layerId+ID_SUFFIX.Border+ID_SUFFIX.Selection,filter);filter=this.getQualifiedFilter(["in","id"].concat(idListCtx));map.setFilter(layerId+ID_SUFFIX.ContextMenu,filter);map.setFilter(layerId+ID_SUFFIX.Border+ID_SUFFIX.ContextMenu,filter);map.setFilter(layerId+ID_SUFFIX.Unselected,this.getFilters4MainLayer(false,idListAll));},getHoverLayerFromFeature:function getHoverLayerFromFeature(feature){var baseLayerId=this.getLayerId(),layerId=feature.layer.id;switch(layerId){case baseLayerId+ID_SUFFIX.Border+ID_SUFFIX.Selection:return baseLayerId+ID_SUFFIX.Selection;case baseLayerId+ID_SUFFIX.Border+ID_SUFFIX.ContextMenu:return baseLayerId+ID_SUFFIX.ContextMenu;case baseLayerId+ID_SUFFIX.Border:return baseLayerId;default:return layerId;}},highlightGraphics:function highlightGraphics(graphics){var map=this.getMapInstance(),layerId=this.getLayerId(),idList=this.getFeatureIDsFromGraphics(graphics);if(!map||!map.getLayer(layerId)||!idList||idList.length<1){return ;}this.handleSelections(idList);},getPaint:function getPaint(){var shapeFmtNames=this.shapeFmtNames,paint={};paint[shapeFmtNames.fillColor]=this.getFillColor();paint[shapeFmtNames.fillOpacity]=this.getFillOpacity();return paint;},getPaintHover:function getPaintHover(){var paint={},shapeFmtNames=this.shapeFmtNames;paint[shapeFmtNames.fillColor]=this.getFillColorHover();paint[shapeFmtNames.fillOpacity]=this.hoverOpacity;return paint;},getPaintContextMenu:function getPaintContextMenu(){var paint={},shapeFmtNames=this.shapeFmtNames;paint[shapeFmtNames.fillColor]=this.getFillColorCMSelection();paint[shapeFmtNames.fillOpacity]=this.fillOpacitySelection;return paint;},getPaintSelection:function getPaintSelection(){var paint={},shapeFmtNames=this.shapeFmtNames;paint[shapeFmtNames.fillColor]=this.getFillColor();paint[shapeFmtNames.fillOpacity]=this.fillOpacitySelection;return paint;},getLayerBorderOptions:function getLayerBorderOptions(){var fmts=this.getFmts(),shapeFmtNames=this.shapeFmtNames,paint={},strokeStyle=convertStrokeDashArray(fmts.strokeDashArray);paint[shapeFmtNames.strokeColor]=fmts.strokeColor;paint[shapeFmtNames.strokeWidth]=fmts.strokeWidth;if(strokeStyle){paint[shapeFmtNames.strokeStyle]=strokeStyle;}return{paint:paint};},getLayerBorderOptionsContextMenu:function getLayerBorderOptionsContextMenu(){var shapeFmtNames=this.shapeFmtNames,borderOptions=this.getLayerBorderOptions(),paint=borderOptions.paint;paint[shapeFmtNames.strokeColor]=this.getFillColor();return borderOptions;},getLayerBorderOptionsSelection:function getLayerBorderOptionsSelection(){var shapeFmtNames=this.shapeFmtNames,borderOptions=this.getLayerBorderOptions(),paint=borderOptions.paint;paint[shapeFmtNames.strokeColor]=this.strokeColorSelection;if(paint[shapeFmtNames.strokeWidth]<=0){paint[shapeFmtNames.strokeWidth]=1;}return borderOptions;},setShapeStrokeStyle:function setShapeStrokeStyle(newVal){var map=this.getMapInstance(),shapeFmtNames=this.shapeFmtNames,id=this.getLayerId(),strokeWidth=newVal&&newVal.shapeBorderWidth,strokeStyle=newVal&&newVal.shapeBorderLineDash;strokeStyle=convertStrokeDashArray(strokeStyle);$ARR.forEach(this.validLayers([id+ID_SUFFIX.Border,id+ID_SUFFIX.Border+ID_SUFFIX.ContextMenu,id+ID_SUFFIX.Border+ID_SUFFIX.Selection]),function(layer){if(layer===id+ID_SUFFIX.Border+ID_SUFFIX.Selection&&strokeWidth===0&&strokeStyle===null){map.setPaintProperty(layer,shapeFmtNames.strokeWidth,1);}else{map.setPaintProperty(layer,shapeFmtNames.strokeWidth,strokeWidth);}map.setPaintProperty(layer,shapeFmtNames.strokeStyle,strokeStyle);});},getLabelField:function getLabelField(showOption){return{property:"id",type:"categorical",stops:this.data.textStops[showOption]};},getGraphicIDsFromFeatureIDs:function getGraphicIDsFromFeatureIDs(features){var fid2gidMap=this.data.featureIdGraphicIdMap;return $ARR.map(features,function(feature){return fid2gidMap[feature&&feature.properties.id];});},getFeatureIDsFromGraphics:function getFeatureIDsFromGraphics(graphics){var fid,fid2gidMap=this.data.featureIdGraphicIdMap;return $ARR.map(graphics,function(graphic){for(fid in fid2gidMap){if(graphic&&fid2gidMap[fid]===graphic.id){return fid;}}});},setCMBorderColor:function setCMBorderColor(map,layerId,propStrokeName,propVal){map.setPaintProperty(layerId+ID_SUFFIX.Border+ID_SUFFIX.ContextMenu,propStrokeName,propVal);}});}());