(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.hash","mstrmojo.gmaps.MapUtils","mstrmojo.gmaps.layer.BaseLayer","mstrmojo.gmaps.basemap._CanLoadESRIMapScript","mstrmojo.PerformanceLogOutput");var $MOJO=mstrmojo,$ARR=$MOJO.array,$HASH=$MOJO.hash,$MUTIL=$MOJO.gmaps.MapUtils,TOKEN_MAX_LIFE_IN_MINUTES="20160",GRANT_TYPE_PARAM_VALUE="client_credentials",TOKEN_URL="https://www.arcgis.com/sharing/oauth2/token",$PerfLog=$MOJO.PerformanceLogOutput,EXPIRE_TIME=1209600,TOKEN_CACHE={},LATMIN=-19971868.880408604,LATMAX=19971868.8804085,LNGMIN=-20037507.067161843,LNGMAX=20037507.067161843,EVENTS={"extent-change":"extent-change","zoom-start":"zoom-start","zoom-end":"zoom-end",load:"update-end"},OOTB_DEFAULT_STYLE="Light Gray Map",TOPO_MAP_TITLE="Topographic Map";function getEsriSuggestionResults(suggestions){if(!suggestions||suggestions.length<1){return ;}var results=[];$ARR.forEach(suggestions,function(v){results.push({n:v.text,v:v.magicKey,cls:"geo",geo:v});});return{items:results};}mstrmojo.gmaps.basemap.EsriBaseLayer=mstrmojo.declare(mstrmojo.gmaps.layer.BaseLayer,[mstrmojo.gmaps.basemap._CanLoadESRIMapScript],{scriptClass:"mstrmojo.gmaps.basemap.EsriBaseLayer",isOnPremise:null,esriBaseLayers:null,mapStylesCache:null,styleTitleMap:{"World Street Map":mstrmojo.desc(13821,"Street"),"Light Gray Map":mstrmojo.desc(13822,"Light gray"),"Relief Map":mstrmojo.desc(13823,"Relief"),"Topographic Map":mstrmojo.desc(11852,"Topographic"),"Physical Map":mstrmojo.desc(13824,"Physical"),"Terrain Map":mstrmojo.desc(8102,"Terrain"),"Satellite View Map":mstrmojo.desc(8068,"Satellite")},_locatorService:null,typeForThumbnail:"_ESRI_",mapOptions:null,resetExtentConfig:null,init:function init(props){this._super(props);this.mapOptions={slider:!!this.showZoomBtns,minZoom:this.minZoom,maxZoom:this.maxZoom,zoom:this.defaultZoom,wrapAround180:true,smartNavigation:false};},processConfigInfo:function processConfigInfo(){this._super();var attributeMapping={},mapConfig=this.map&&this.map.getMapConfig(),esriConfig=mapConfig&&mapConfig.esri,pj,projects,at,i,il;if(!esriConfig){return ;}this.isOnPremise=(esriConfig.useESRICloud!=="1");projects=esriConfig.pjs;for(pj in projects){if(!pj){continue;}if(projects.hasOwnProperty(pj)&&!!projects[pj].at){for(i=0,il=projects[pj].at.length;i<il;i++){at=projects[pj].at[i];attributeMapping[at.id]=at;}}}this.attributeMapping=attributeMapping;},render:function render(){this.isSupport=this.checkSupport();if(this.isSupport!==true){console.log("Esri map is not supported");this.updateMapExtent();return ;}this._super();},initBaseMap:function initBaseMap(){var me=this,mapConfig=this.map&&this.map.getMapConfig(),config=mapConfig&&mapConfig.esri;if(!config){return ;}$MUTIL.showWait();this.setEsriConfig(config);if(mstrmojo.esriMapLib===undefined){mstrmojo.esriMapLib={};mstrmojo.esrimap.loadScriptListeners=[];this.loadExternalScript(this.loadBaseMap,mstrmojo.esrimap);}else{if(typeof (esri)!=="undefined"){this.loadBaseMap();}else{mstrmojo.esrimap.loadScriptListeners.push({caller:me,method:me.loadBaseMap});$MUTIL.hideWait();}}},loadBaseMap:function loadBaseMap(){try{var config=this.getConfig();this.checkGlobalProxy(config);this._super();$MUTIL.hideWait();if(!!this.isOnPremise){this.loadOnPremiseBaseMap(config);}else{this.loadCloudBaseMap(config);}}catch(e){this.handleNoInternet();$MUTIL.hideWait();}},loadOnPremiseBaseMap:function loadOnPremiseBaseMap(config){var bm=config&&this.getDefaultBmForOnPremise(config.bms),me=this,errorMsg,isBaseMapDynamic,baseMapUrl;if(!this.div_){return ;}if(!!bm){isBaseMapDynamic=(bm.isDyn=="1");baseMapUrl=bm.value;}else{baseMapUrl=null;isBaseMapDynamic=false;}if(!baseMapUrl||$MUTIL.trimString(baseMapUrl).length===0){errorMsg="The map visualization has not been configured properly. Please contact your administrator to resolve this issue.";this.displayError(errorMsg);return ;}$MUTIL.showWait();try{require(["esri/tasks/locator","dojo/_base/connect","esri/layers/layer","esri/geometry/Point","esri/geometry/webMercatorUtils","esri/geometry/screenUtils","esri/SpatialReference"],function(){me.mapOptions.extent=new esri.geometry.Extent(LNGMIN,LATMIN,LNGMAX,LATMAX,new esri.SpatialReference({wkid:102100}));me._baseMap=new esri.Map(me.div_.id,me.mapOptions);me.initOnPremiseBaseLayer(baseMapUrl,isBaseMapDynamic);});}catch(e){$MUTIL.log(e.stack);this.updateMapExtent();}finally{$MUTIL.hideWait();}},loadCloudBaseMap:function loadCloudBaseMap(config){try{this.createWebMap(config);}catch(e){$MUTIL.log(e.stack);this.updateMapExtent();}},createWebMap:function createWebMap(config){var me=this,wm=this.getDefaultWebMap(config.webmaps),tokenStr=config.token,isPublicWebMap=false,webmapId,token;if(!!wm){webmapId=wm.id;isPublicWebMap=wm.hasOwnProperty("isPublic")&&wm.isPublic;}if((!tokenStr||tokenStr.length===0)&&!isPublicWebMap){this._fetchTokenFromESRICloud();return ;}if(!webmapId){$MUTIL.log("No webmap id is specified in config file.");return ;}$MUTIL.showWait();token={server:"http://www.arcgis.com/sharing/rest",token:tokenStr,ssl:false,expires:EXPIRE_TIME};require(["esri/arcgis/utils","esri/IdentityManager","esri/tasks/locator","dojo/_base/connect","esri/layers/layer","esri/geometry/Point","esri/geometry/webMercatorUtils","esri/geometry/screenUtils","esri/SpatialReference"],function(arcgisUtils,identityManager){if(!isPublicWebMap){if(!mstrmojo.esrimap.esriTokens){mstrmojo.esrimap.esriTokens=[];}if(tokenStr&&mstrmojo.esrimap.esriTokens.indexOf(tokenStr)<0){identityManager.registerToken(token);mstrmojo.esrimap.esriTokens.push(tokenStr);}}if(mstrApp.isSingleTier){arcgisUtils.arcgisUrl=arcgisUtils.arcgisUrl.replace("file","http");}var mapDeferred=me.mapDeferred,mapDiv=me.div_;if(!mapDiv){$MUTIL.hideWait();return ;}if(!mapDeferred){mapDeferred=arcgisUtils.createMap(webmapId,mapDiv.id,{mapOptions:me.mapOptions,ignorePopups:true});me.mapDeferred=mapDeferred;}$PerfLog.endTimer("timerid_callback_mapDeferred.then");$PerfLog.visPrint("ESRI mapDeferred start");var timerid_mapDeferred=$PerfLog.startTimer({functionName:"EsriBaseLayer.mapDeferred.then: ",purpose:"create Map"});mapDeferred.then(function(response){$PerfLog.endTimer(timerid_mapDeferred);$PerfLog.visPrint("ESRI mapDeferred end");$PerfLog.startTimer({functionName:"EsriBaseLayer.mapDeferred.then: ",purpose:"time gap between mapDeferred completion and map response"},"timerid_callback_initCloudLayer");var map=response.map,operationalLayers=response.itemInfo.itemData.operationalLayers,baseMaplayers=response.itemInfo.itemData.baseMap.baseMapLayers,mapStyles=[],esriConfig=me.map&&me.map.getMapConfig().esri,esriBaseLayers=(baseMaplayers||[]).concat(operationalLayers||[]);if(!esriConfig){$MUTIL.hideWait();return ;}me.mapStylesCache=esriConfig.mapStylesCache;if(!me.mapStylesCache||!($ARR.isArray(me.mapStylesCache))){dojo.map(esriBaseLayers,function(layer){if(layer&&layer.layerObject&&(!layer.layerObject.type||layer.layerObject.type!=="Feature Layer")){if(!layer.title){layer.title=$HASH.walk("resourceInfo.documentInfo.Title",layer)||layer.id;}mapStyles.push(layer.title);}});me.mapStylesCache=mapStyles;esriConfig.mapStylesCache=mapStyles;}me.esriBaseLayers=esriBaseLayers;me._baseMap=map;me.buildLevelInfo4Layers();me.resetBaseLayerMaxZoom();if(map.loaded){$PerfLog.visPrint("init ESRI Base Layer start");var timerid_initESRIBaseLayer=$PerfLog.startTimer({functionName:"EsriBaseLayer.initCloudBaseLayer: ",purpose:"init ESRI Map Base Layer (setMapType, UpdateMapExtent)"});me.initCloudBaseLayer();$PerfLog.endTimer(timerid_initESRIBaseLayer);$PerfLog.visPrint("init ESRI Base Layer end");$PerfLog.startTimer({functionName:"EsriBaseLayer.initCloudBaseLayer: ",purpose:"time gap between initCloudBaseLayer completion and render Graphics"},"timerid_callback_handleExtentChange");}else{me.eventListenerArr.push(dojo.connect(map,"onLoad",function(){me.initCloudBaseLayer();me.eventListenerArr.push(dojo.connect(me.div_,"resize",map,function(){map.resize();}));}));}$MUTIL.hideWait();},function(){me.handleNoInternet();me.updateMapExtent();$MUTIL.hideWait();});});},buildLevelInfo4Layers:function buildLevelInfo4Layers(){var layers=this.esriBaseLayers,len=(layers&&layers.length)||0,layerLevels={},i,layer,lods;for(i=0;i<len;i++){layer=layers[i];lods=$HASH.walk("layerObject.tileInfo.lods",layer);if(lods&&lods.length>0){layerLevels[layer.title]=lods[lods.length-1].level;}}this.layerLevels=layerLevels;},resetBaseLayerMaxZoom:function resetBaseLayerMaxZoom(){var layerLevels=this.layerLevels,baseMap=this._baseMap,layers=this.esriBaseLayers,len=(layers&&layers.length)||0,i,layer,firstBaseLayerTitle,maxZoom;for(i=0;i<len;i++){layer=layers[i];if(layer.baseMapLayer&&(!firstBaseLayerTitle||layer.firstLayer)){firstBaseLayerTitle=layer.title;}}if(!firstBaseLayerTitle&&len>0){firstBaseLayerTitle=layers[0].title;}maxZoom=firstBaseLayerTitle&&layerLevels[firstBaseLayerTitle];if($MUTIL.checkVal(maxZoom)&&maxZoom<this.maxZoom){if(baseMap&&baseMap._params){baseMap._params.maxZoom=maxZoom;}this.maxZoom=maxZoom;}},autoSwitchStyles:function autoSwitchStyles(destStyle){var layerLevels=this.layerLevels||{},currStyle=this.mapStyle,displayStyle=this.displayStyle,zoomLevel=this.getZoom(),finalStyle;if(!currStyle){return ;}if(this.isOnPremise||!layerLevels[currStyle]){finalStyle=destStyle;}else{if(zoomLevel<=layerLevels[currStyle]){finalStyle=destStyle?destStyle:currStyle;}else{if(layerLevels[TOPO_MAP_TITLE]>=zoomLevel){finalStyle=TOPO_MAP_TITLE;}}}if(finalStyle&&(displayStyle!==finalStyle)){this.displayStyle=this.switchESRIStyles(finalStyle);}},initOnPremiseBaseLayer:function initOnPremiseBaseLayer(baseMapUrl,isBaseMapDynamic){var map=this._baseMap,me=this;if(!map||!baseMapUrl){return ;}this.baseLayer=isBaseMapDynamic?new esri.layers.ArcGISDynamicMapServiceLayer(baseMapUrl):new esri.layers.ArcGISTiledMapServiceLayer(baseMapUrl);map.addLayer(this.baseLayer);this.addEventListeners(EVENTS);this.eventListenerArr.push(dojo.connect(map,"onLoad",this,function(){me.updateMapExtent();}));},initCloudBaseLayer:function initCloudBaseLayer(){var props=this.map&&this.map.getProperties(),usedMapStyleName=props&&props.dv;this.setMapStyle(usedMapStyleName);this.addEventListeners(EVENTS);this.updateMapExtent();},setExtent:function setExtent(geoExtent,inResizing,noFit){if(!geoExtent){return ;}this._super(geoExtent);var extent=new esri.geometry.Extent({xmin:geoExtent.lngWest,ymin:geoExtent.latSouth,xmax:(geoExtent.lngEast<0&&geoExtent.lngWest>0)?geoExtent.lngEast+360:geoExtent.lngEast,ymax:geoExtent.latNorth,spatialReference:this.wgs84SP}),_baseMap=this._baseMap;if(inResizing&&this.checkExtentMinEqual(extent)){this.resetExtentConfig=geoExtent;}if(_baseMap&&_baseMap.setExtent instanceof Function){_baseMap.setExtent(extent,!noFit);}},checkExtentMinEqual:function(extent){var _baseMap=this._baseMap,currExtent=_baseMap.extent,newExtent,roundValue=function(v){return Math.round(1000000*v);};if($MUTIL.checkHasFunction(_baseMap,"_fixExtent")&&$MUTIL.checkHasFunction(_baseMap,"_convertGeometry")){newExtent=_baseMap._fixExtent(_baseMap._convertGeometry(_baseMap,extent),true);newExtent=newExtent&&newExtent.extent;}return !!(newExtent&&currExtent&&roundValue(currExtent.xmin)===roundValue(newExtent.xmin));},setCenter:function setCenter(geoPoint){if(!this._baseMap||!geoPoint||!geoPoint.lat||!geoPoint.lng){return ;}var center=new esri.geometry.Point(geoPoint.lng,geoPoint.lat);this._baseMap.centerAt(center);},centerAndZoom:function centerAndZoom(geoPoint,zoomLevel){if(this._baseMap&&geoPoint&&$MUTIL.checkVal(geoPoint.lat)&&$MUTIL.checkVal(geoPoint.lng)&&$MUTIL.checkVal(zoomLevel)){var center=new esri.geometry.Point(geoPoint.lng,geoPoint.lat);this._baseMap.centerAndZoom(center,parseInt(zoomLevel));}},canUpdateLayers:function canUpdateLayers(){var parent=this.parent;return !!(parent&&!parent.isMouseDown);},getMapStyles:function getMapStyles(){var styles=[],mapStyles=this.mapStylesCache,titleMap=this.styleTitleMap,title,i,il;if(this.isOnPremise!==true&&titleMap&&mapStyles&&$ARR.isArray(mapStyles)){titleMap=this.styleTitleMap;for(i=0,il=mapStyles.length;i<il;i++){title=mapStyles[i];styles.push({n:titleMap[title]?titleMap[title]:title,id:title});}}return styles;},isStyleExist:function isStyleExist(style){return $ARR.find(this.esriBaseLayers,"title",style)>=0;},getDefaultMapStyle:function getDefaultMapStyle(){var layers=this.esriBaseLayers;if(layers&&layers[1]&&(layers[1].title===OOTB_DEFAULT_STYLE)){return OOTB_DEFAULT_STYLE;}return layers&&layers[0]&&layers[0].title;},getDefaultStyleIdx:function getDefaultStyleIdx(){var layers=this.esriBaseLayers;if(layers&&layers[1]&&(layers[1].title===OOTB_DEFAULT_STYLE)){return 1;}return 0;},checkGlobalProxy:function checkGlobalProxy(config){var proxy,bm;if(this.isOnPremise){bm=config&&this.getDefaultBmForOnPremise(config.bms);}if(!!config&&!!config.proxyURLs&&config.proxyURLs.length>0){proxy=config.proxyURLs[0];esri.config.defaults.io.proxyUrl=proxy.value;esri.config.defaults.io.alwaysUseProxy=(proxy.alwaysUse==="true");}else{if(!!bm&&!!bm.proxyURL&&$MUTIL.trimString(bm.proxyURL).length>0){esri.config.defaults.io.proxyUrl=bm.proxyURL;esri.config.defaults.io.alwaysUseProxy=true;}else{if($MUTIL.isAsp()){esri.config.defaults.io.proxyUrl="../asp/esriproxy.ashx";}else{esri.config.defaults.io.proxyUrl="../jsp/esriproxy.jsp";}esri.config.defaults.io.alwaysUseProxy=false;}}},switchESRIStyles:function(destStyle){var layers=this.esriBaseLayers,_baseMap=this._baseMap,baseLayer=this.baseLayer,toggleVisibility=function(layer,visible){if(layer){layer.setVisibility(visible);layer.setOpacity(visible?1:0);}},layer,i,il;if(!_baseMap){return ;}for(i=0,il=layers.length;i<il;i++){layer=layers[i];if(layer.title===destStyle){baseLayer=layer.layerObject;}else{if(!layer.layerObject.type||layer.layerObject.type!=="Feature Layer"){toggleVisibility(layer.layerObject,false);}}}if(baseLayer){this.baseLayer=baseLayer;}else{if(layers[0]){this.baseLayer=layers[0].layerObject;destStyle=layers[0].title;}}toggleVisibility(this.baseLayer,true);return destStyle;},setMapStyle:function setMapStyle(dv){if(!dv||!this.isStyleExist(dv)){this.mapStyle=this.switchESRIStyles();this.displayStyle=this.mapStyle;}else{this.mapStyle=dv;this.autoSwitchStyles(dv);}this.updateMapToolbar();},getViewport:function(){var domNode=this.getNode();try{domNode=domNode&&domNode.firstChild.firstChild;return domNode&&domNode.style.clip||null;}catch(e){console.log("failed to get clip from esri container node");return this._super();}},handleExtentChange:function handleExtentChange(){this._super();var baseLayer=this.baseLayer;if(!baseLayer){return ;}if(!baseLayer.visible){baseLayer.setVisibility(true);}if(baseLayer.opacity!==1){baseLayer.setOpacity(1);}},panBy:function panBy(offset,startPos,endPos){var _baseMap=this._baseMap,navigationManager=_baseMap&&_baseMap.navigationManager,evt=$MUTIL.createMouseEvt("mousedown"),startScreenPoint,curScreenPoint;if(!navigationManager||!startPos||!endPos||!$MUTIL.checkVal(startPos.x)||!$MUTIL.checkVal(startPos.y)||!$MUTIL.checkVal(endPos.x)||!$MUTIL.checkVal(endPos.y)){return ;}startScreenPoint=new esri.geometry.ScreenPoint(startPos.x,startPos.y);curScreenPoint=new esri.geometry.ScreenPoint(endPos.x,endPos.y);evt.screenPoint=startScreenPoint;navigationManager._panInit(evt);navigationManager._panStart({screenPoint:startScreenPoint});navigationManager._pan({screenPoint:curScreenPoint});navigationManager._panEnd({screenPoint:curScreenPoint});},handleMouseWheel:function handleMouseWheel(params){var position=params&&params.position,_baseMap=this._baseMap,screenPoint;if(!position||!$MUTIL.checkVal(position.x)||!$MUTIL.checkVal(position.y)||!$MUTIL.checkVal(params.zoomDelta)||!_baseMap){console.log("EsriBaseLayer.handleMouseWheel(): invalid params.");return ;}screenPoint=new esri.geometry.ScreenPoint(position);_baseMap._extentUtil({numLevels:params.zoomDelta,screenAnchor:screenPoint,mapAnchor:_baseMap.toMap(screenPoint)});},getLngLatCenter:function getLngLatCenter(){var mapCenter=this._baseMap&&this._baseMap.extent.getCenter(),results;if(!mapCenter){return ;}results=esri.geometry.xyToLngLat(mapCenter.x,mapCenter.y);return !!results&&{lng:results[0],lat:results[1]};},getDefaultBmForOnPremise:function getDefaultBmForOnPremise(bms){var bm,i,il;if($ARR.isArray(bms)){for(i=0,il=bms.length;i<il;i++){if(!!bms[i].key&&bms[i].key==="default"){bm=bms[i];break;}}}return bm;},getDefaultWebMap:function getDefaultWebMap(webmaps){if(!webmaps){return ;}if(!!webmaps){for(var i in webmaps){if(!!webmaps[i]["default"]&&webmaps[i]["default"]==true){return webmaps[i];}}}return null;},_fetchTokenFromESRICloud:function _fetchTokenFromESRICloud(){var me=this,config=this.getConfig(),extraInfo=config.extrainfo,appId,appSecret,data,callback;if(!!extraInfo&&!!extraInfo.primaryId&&!!extraInfo.secondaryId){appId=extraInfo.primaryId;appSecret=extraInfo.secondaryId;data={client_id:encodeURIComponent(appId),client_secret:encodeURIComponent(appSecret),grant_type:encodeURIComponent(GRANT_TYPE_PARAM_VALUE),expiration:encodeURIComponent(TOKEN_MAX_LIFE_IN_MINUTES)};callback={success:function(result){if(!!result.error){me.displayError("Error retrieving token using the given AppID and AppSecret. "+result.error.message);me.updateMapExtent();return ;}var config=me.getConfig();if(!config){me.updateMapExtent();return ;}if(!TOKEN_CACHE[appId]){TOKEN_CACHE[appId]=config.token=result.access_token;me._cacheTheTokenInServer(appId,result);}else{config.token=TOKEN_CACHE[appId];}me.createWebMap(config);},failure:function(response){me.displayError("Error retrieving token using the given AppID and AppSecret. "+response);me.updateMapExtent();}};var xhr=new mstrmojo.SimpleXHR({isTask:false,async:true});mstrmojo.xhr.request("POST",TOKEN_URL,callback,data);}else{$MUTIL.log("ExtraInfo not present to fetch token from ESRI Cloud in client authentication mode.");}},getConfig:function getConfig(){var map=this.map,mapConfig=map&&map.getMapConfig();if(mapConfig){return mapConfig.esri;}},_cacheTheTokenInServer:function _cacheTheTokenInServer(appId,tokJSON,key){var splitParams={taskId:"getESRIConfig",key:key,taskEnv:"xhr",taskContentType:"json",tokenJson:JSON.stringify(tokJSON),id:appId},callback={success:function(res){if(res){if(!!res.ec&&res.ec==1){$MUTIL.log("Successfully cached the token in client authentication mode");}else{$MUTIL.log("Error caching the token on web server in client authentication mode : "+res);}}},failure:function(res){$MUTIL.log("Error caching the token on web server in client authentication mode : "+res);}};mstrApp.serverRequest(splitParams,callback);},isWebMercator:function isWebMercator(spatialReference){var wkid=spatialReference&&spatialReference.wkid;return wkid===102100||wkid===102113||wkid===3857||wkid===3785;},latLngToPixelXY:function latLngToPixelXY(point,needRaw){var screenPoint;if(!point||!this.isProjectionReady()||!$MUTIL.checkVal(point.lat)||!$MUTIL.checkVal(point.lng)){$MUTIL.log("Catch invalid point");return ;}screenPoint=this._toScreen(point.lng,point.lat);if(needRaw!==true){screenPoint=this.adjustPointInsideViewer(screenPoint,this._xCoordsMin);}if(screenPoint&&$MUTIL.checkVal(screenPoint.x)&&$MUTIL.checkVal(screenPoint.y)){return{x:parseInt(screenPoint.x),y:parseInt(screenPoint.y)};}},_toScreen:function _toScreen(lng,lat){if(!this._baseMap){return ;}var map=this._baseMap,spatialReference=map.spatialReference,geometry=esri.geometry,latLng=new geometry.Point(lng,lat,this.wgs84SP),mapPoint=this.isWebMercator(spatialReference)?geometry.geographicToWebMercator(latLng):latLng;return new geometry.toScreenGeometry(map.extent,map.width,map.height,mapPoint);},pixelXYtoLatLng:function pixelXYtoLatLng(pixel){var map=this._baseMap,spatialReference=map.spatialReference,geometry=esri.geometry,screenPoint,mapPoint,latLng;if(!map||!this.isProjectionReady()||!pixel||!$MUTIL.checkVal(pixel.x)||!$MUTIL.checkVal(pixel.y)){$MUTIL.log("Catch invalid map/point/projection");return ;}screenPoint=new geometry.ScreenPoint(pixel.x,pixel.y);mapPoint=geometry.toMapGeometry(map.extent,map.width,map.height,screenPoint);if(mapPoint){latLng=this.isWebMercator(spatialReference)?geometry.webMercatorToGeographic(mapPoint):mapPoint;return{lat:latLng.y,lng:latLng.x};}},isProjectionReady:function isProjectionReady(){try{return !!esri&&!!esri.geometry;}catch(e){}},getSearchSuggestions:function getSearchSuggestions(pattern,callback){var locatorService=this.getLocatorService(),blocks=this.getInHouseResults(pattern)||[];if(!locatorService){return ;}locatorService.suggestLocations({text:pattern}).then(function(suggestions){var results=getEsriSuggestionResults(suggestions);if(results){blocks.push(results);}callback(blocks);});},navToCloudLocation:function navToCloudLocation(item){var map=this._baseMap,locatorService=this.getLocatorService();if(!map||!locatorService){return ;}locatorService.addressToLocations({address:{SingleLine:item.n},magicKey:item.v});locatorService.on("address-to-locations-complete",function(evt){var geom,ext,extent;$ARR.forEach(evt.addresses,function(candidate){if(candidate.score>80){geom=candidate.location;ext=candidate.extent;extent=new esri.geometry.Extent(ext.xmin,ext.ymin,ext.xmax,ext.ymax,map.spatialReference);return false;}});if(!geom&&evt.addresses&&evt.addresses.length>0){geom=evt.addresses[0].location;ext=evt.addresses[0].extent;extent=new esri.geometry.Extent(ext.xmin,ext.ymin,ext.xmax,ext.ymax,map.spatialReference);}if(geom){map.setExtent(extent);map.centerAt(geom);}});},checkSupport:function checkSupport(){var mapConfig=this.map.getMapConfig(),config=mapConfig&&mapConfig.esri,err=config&&config.err,errorMsg,replaceStr;if(err&&err.length>0){this.displayError(err);return false;}if(mstrApp.isSingleTier&&(typeof (FormWrapper)!=="undefined")&&parseInt(FormWrapper.testInternetConnection(),10)!==0){errorMsg="Unable to download the ESRI map. No Internet connection. You can configure an Internet proxy through your computer's #";replaceStr='<a href="" style="color:#7CC5EC" onclick="window.FormWrapper.showProxyEditor(); return false;">'+mstrmojo.desc(7831,"Settings")+"</a>.";errorMsg=errorMsg.replace("#",replaceStr);this.displayError(errorMsg);return false;}return true;},getLocatorService:function(){var protocol=$MUTIL.getProtocol(),locatorService=this._locatorService,_baseMap=this._baseMap;if(!!_baseMap&&!!protocol&&!locatorService){locatorService=new esri.tasks.Locator(protocol+"//geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer");locatorService.outSpatialReference=_baseMap.spatialReference;this._locatorService=locatorService;}return this._locatorService;},showMapTools:function(){var _baseMap=this._baseMap;if(!_baseMap){return ;}if(!_baseMap._isPanArrows){_baseMap.showPanArrows();}if(!_baseMap._isZoomSlider){_baseMap.showZoomSlider();}},hideMapTools:function(){var _baseMap=this._baseMap;if(!_baseMap){return ;}if(_baseMap.isPanArrows){_baseMap.hidePanArrows();}if(_baseMap.isZoomSlider){_baseMap.hideZoomSlider();}},destroy:function destroy(ignoreDom){mstrmojo.esrimap.loadScriptListeners=[];this._super(ignoreDom);}});})();