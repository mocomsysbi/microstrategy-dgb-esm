(function(){mstrmojo.requiresCls("mstrmojo.func","mstrmojo.num","mstrmojo.array","mstrmojo.string","mstrmojo.VisEnum","mstrmojo.VisUtility","mstrmojo.kpicard.KPICardEnum");var $ARR=mstrmojo.array,$NUM=mstrmojo.num,$VISUTIL=mstrmojo.VisUtility,$BADGE_MODE=mstrmojo.kpicard.BADGE_MODE,$KPI_PROPERTIES=mstrmojo.kpicard.KPI_PROPERTIES,$KPI_STYLES=mstrmojo.kpicard.KPI_STYLES,$KPI_TEMPLATE_MODE=mstrmojo.kpicard.KPI_TEMPLATE_MODE,$SERVER_JSON_ERROR_TYPE=mstrmojo.VisEnum.SERVER_JSON_ERROR_TYPE,GROUP_SUPPORTING_TAGS=["at","dei","dpt","o","tui","ui"];function getMinForArray(arr){var min=Infinity;arr.forEach(function(e){if(min>e){min=e;}});return min;}mstrmojo.kpicard._KPICardDataModel=mstrmojo.provide("mstrmojo.kpicard._KPICardDataModel",{_mixinName:"mstrmojo.kpicard._KPICardDataModel",getUnitsByDropZoneID:function getUnitsByDropZoneID(id){var modelData=this.model&&this.model.data,dz=modelData&&modelData.dz,zone=dz&&dz[id];if(zone){if(zone.TemplateMetric){return zone.TemplateMetric;}else{if(zone.TemplateUnit){return zone.TemplateUnit;}}}return[];},checkData:function checkData(){var metrics=this.getUnitsByDropZoneID("metric");if(metrics.length<1){this.setError(undefined,$SERVER_JSON_ERROR_TYPE.NO_TEMPLATE_UNIT);}},getAttrID:function getAttrID(zoneName){var data=this.model&&this.model.data,dz=data&&data.dz,zone=dz&&dz[zoneName],items=zone&&zone.TemplateUnit,item=items&&items[0];return item&&item.id;},getAttrIdx:function getAttrIdx(row,zoneName){var attrID=this.getAttrID(zoneName),attrIdx=-1;$ARR.forEach(row,function(attr,idx){if(attr.id&&attr.id.indexOf(attrID)!==-1){attrIdx=idx;return false;}});return attrIdx;},getTrendAttributeName:function getTrendAttributeName(){var data=this.model&&this.model.data,gts=data&&data.gts,row=gts&&gts.row,timeAttrIdx=this.getAttrIdx(row,"trend");return timeAttrIdx>-1?row[timeAttrIdx].n:"";},getTimeAttrElemIdx:function getTimeAttrElemIdx(rhItems,timeAttrIdx){var timeRHItemIdx=$ARR.find(rhItems,"tui",timeAttrIdx);if(timeRHItemIdx>=0){return rhItems[timeRHItemIdx].idx;}return -1;},createModelForSingleKPI:function createModelForSingleKPI(){var xtabModel=this.model,data=xtabModel&&xtabModel.data,nfs=data&&$VISUTIL.getNumberFormat(data,0),gts=data&&data.gts,gvs=data&&data.gvs&&data.gvs.items,col=gts&&gts.col,row=gts&&gts.row,ghs=data&&data.ghs,rhs=ghs&&ghs.rhs.items,rowCnt=(rhs&&rhs.length)||(gvs&&gvs.length),metrics=col&&col[0],metricList=metrics&&metrics.es,metricIdx=0,metric=metricList[metricIdx],timeAttrIdx=this.getAttrIdx(row,"trend"),categoryAttrIdx=this.getAttrIdx(row,"BreakBy"),hasTimeAttr=timeAttrIdx>-1,hasCategoryAttr=categoryAttrIdx>-1,timeAttrElemList=hasTimeAttr&&row[timeAttrIdx].es,categoryAttr=hasCategoryAttr&&row[categoryAttrIdx],trendAttr=hasTimeAttr&&row[timeAttrIdx],trendAttrName=trendAttr.n||"",categoryAttrName=categoryAttr.n||"",categoryAttrId=categoryAttr.id||null,categoryAttrElemList=hasCategoryAttr&&row[categoryAttrIdx].es,singleKPIModels=[],singleKPIModel,currCategoryRhsIdx=-1,lastCategoryRhsIdx=-1,currCellRowData=null,elemData=null,tagsCnt=GROUP_SUPPORTING_TAGS.length,me=this,i,m,tag,timeAttrElemIdx,chartData,chartFormatData,xAxisData,isSubtotalRow=function(){var rowHeader=rhs&&rhs[i],items=rowHeader&&rowHeader.items,len=(items&&items.length)||0;for(m=0;m<len;m++){if(items[m].stt===1){return true;}}return false;},isCategoryChanged=function(){if(hasCategoryAttr){currCellRowData=rhs[i].items[categoryAttrIdx];currCategoryRhsIdx=currCellRowData.idx;if(currCategoryRhsIdx!==lastCategoryRhsIdx){lastCategoryRhsIdx=currCategoryRhsIdx;elemData={};for(m=0;m<tagsCnt;m++){tag=GROUP_SUPPORTING_TAGS[m];elemData[tag]=currCellRowData[tag];}return true;}else{return false;}}else{if(!singleKPIModel){return true;}else{return false;}}},finishCreateModelForSingleKPI=function(){if(singleKPIModel){singleKPIModel.chartData=chartData;singleKPIModel.chartFormatData=chartFormatData;singleKPIModel.trendName=trendAttrName;singleKPIModel.xAxisData=xAxisData;singleKPIModel.nfs=nfs;me.populateSingleKPIAttributes(singleKPIModel);singleKPIModels.push(singleKPIModel);}};this.isPercentNumberStyle=undefined;this.KPITemplateMode=(hasTimeAttr?1:0)+(hasCategoryAttr?2:0);for(i=0;i<rowCnt;i++){if(!isSubtotalRow()){if(isCategoryChanged()){finishCreateModelForSingleKPI();singleKPIModel={};singleKPIModel.metricName=metric.n;singleKPIModel.KPITemplateMode=this.KPITemplateMode;singleKPIModel.kpiModels=singleKPIModels;singleKPIModel.elemId="";singleKPIModel.rowIdx=-1;singleKPIModel.colIdx=-1;if(hasCategoryAttr){singleKPIModel.attr=categoryAttr;singleKPIModel.categoryName=categoryAttrName;singleKPIModel.attrId=categoryAttrId;singleKPIModel.elemData=elemData;singleKPIModel.categoryElemName=categoryAttrElemList[currCategoryRhsIdx].n;singleKPIModel.elemId=categoryAttrElemList[currCategoryRhsIdx].id;singleKPIModel.rowIdx=categoryAttrIdx;singleKPIModel.colIdx=i;}chartData=[];xAxisData=[];chartFormatData=[];}if(hasTimeAttr){timeAttrElemIdx=this.getTimeAttrElemIdx(rhs[i].items,timeAttrIdx);if(timeAttrElemIdx>=0){xAxisData.push(timeAttrElemList[timeAttrElemIdx].n);}}chartData.push(parseFloat(gvs[i].items[metricIdx].rv));chartFormatData.push(gvs[i].items[metricIdx].v);}}finishCreateModelForSingleKPI();this.singleKPIModels=singleKPIModels;this.breakByAttrSupportsViewFilter=xtabModel.supportsViewFilterActions(categoryAttr.id);},hasTimeLine:function hasTimeLine(){return this.KPITemplateMode===$KPI_TEMPLATE_MODE.METRIC_WITH_TREND||this.KPITemplateMode===$KPI_TEMPLATE_MODE.METRIC_WITH_TREND_AND_BREAKBY;},hasCategoryAttr:function hasCategoryAttr(){return this.KPITemplateMode===$KPI_TEMPLATE_MODE.METRIC_WITH_BREAKBY||this.KPITemplateMode===$KPI_TEMPLATE_MODE.METRIC_WITH_TREND_AND_BREAKBY;},populateSingleKPIAttributes:function populateSingleKPIAttributes(model){var chartData=model.chartData,chartFormatData=model.chartFormatData,dataCnt=chartData.length,lastValidMetricValueIdx=dataCnt-1;while(lastValidMetricValueIdx>0&&isNaN(chartData[lastValidMetricValueIdx])){lastValidMetricValueIdx--;}if(lastValidMetricValueIdx>=0){model.metricValue=chartFormatData[lastValidMetricValueIdx];model.metricRawValue=chartData[lastValidMetricValueIdx];}if(this.isPercentNumberStyle===undefined){this.getNumberStyle(model);}if(chartData.length>1&&lastValidMetricValueIdx>=1&&this.hasTimeLine()){model.dataMin=getMinForArray(chartData);model.prevMetricRawValue=chartData[lastValidMetricValueIdx-1];model.prevMetricFmtValue=chartFormatData[lastValidMetricValueIdx-1];model.prevMetricInfo=this.getPrevMetricInfoString(model.prevMetricFmtValue);this.generateCmpString(model,this.getFormatPropertyValue($KPI_PROPERTIES.BADGE_MODE));this.populateChartOption(model);}if(this.hasCategoryAttr()){model.metricNameHTML=model.categoryElemName;}else{model.metricNameHTML=model.metricName;}},populateChartOption:function populateChartOption(model){var me=this,option={title:{show:false,padding:0},tooltip:{show:true,trigger:"axis",axisPointer:{type:"line",lineStyle:{width:0}},formatter:function(params){me.showTooltip([{n:model.trendName,v:params[0].name},{n:model.metricName,v:model.chartFormatData[params[0].dataIndex]}]);}},xAxis:{show:false,boundaryGap:false,data:model.xAxisData},yAxis:{show:false,boundaryGap:false,min:Math.min(0,model.dataMin),max:"dataMax"},series:[{type:"line",smooth:true,symbol:"circle",showSymbol:false,data:model.chartData}],grid:{x:0,y:5,x2:0,y2:0,borderWidth:0}};option.series[0].itemStyle=this.getItemStyle(model);model.chartOption=option;},getItemStyle:function getItemStyle(model){var kpiStyle=this.getFormatPropertyValue($KPI_PROPERTIES.KPI_STYLE);var styleConfig=this.getSpecificKPIStyle(kpiStyle)||{};var echartItemStyle={normal:{color:model.cmpBgClr,areaStyle:{color:styleConfig.chartColor,opacity:styleConfig.chartOpacity,}}};if(kpiStyle===$KPI_STYLES.LIGHT){echartItemStyle.normal.lineStyle={color:"#D2D2D2",width:1};}else{echartItemStyle.normal.lineStyle={color:styleConfig.chartColor,width:1};}return echartItemStyle;},getNumberStyle:function getNumberStyle(model){var isPercent=false,metricValue;if(model.metricValue){metricValue=model.metricValue;isPercent=metricValue.indexOf("%")>0||metricValue.indexOf("â€°")>0;}this.isPercentNumberStyle=isPercent;},generateCmpString:function generateCmpString(model,badgeMode){model.badgeMode=badgeMode;if(model.metricRawValue!==undefined&&model.prevMetricRawValue!==undefined){if(badgeMode===$BADGE_MODE.PERCENTAGE){if(model.prevMetricRawValue===0){if(model.metricRawValue===0){model.compareToPrev=0;model.compareToPrevString=Number(0).toFixed(1)+"%";}else{model.compareToPrev=(model.metricRawValue-model.prevMetricRawValue)>=0?Infinity:-Infinity;model.compareToPrevString=model.compareToPrev>0?"\ue80e":"\ue80d";}}else{model.compareToPrev=(model.metricRawValue-model.prevMetricRawValue)/Math.abs(model.prevMetricRawValue);if(model.compareToPrev===0){model.compareToPrevString=Number(0).toFixed(1)+"%";}else{model.compareToPrevString=(model.compareToPrev>0?"+ ":"- ")+Number(Math.abs(model.compareToPrev*100)).toFixed(1)+"%";}}}else{if(badgeMode===$BADGE_MODE.VALUE){model.compareToPrev=model.metricRawValue-model.prevMetricRawValue;model.compareToPrevString=(model.compareToPrev>0?"+":"")+$NUM.formatByMask(model.nfs,model.compareToPrev);if(this.isPercentNumberStyle){model.compareToPrevString=model.compareToPrevString.replace("%","");model.compareToPrevString+=mstrmojo.desc(15954,"pp");}}}if(badgeMode!==$BADGE_MODE.NONE){if(model.compareToPrev>=0){model.cmpBgClr=this.getFormatPropertyValue($KPI_PROPERTIES.INCREASE_BG_COLOR);}else{model.cmpBgClr=this.getFormatPropertyValue($KPI_PROPERTIES.DECREASE_BG_COLOR);}}}}});}());