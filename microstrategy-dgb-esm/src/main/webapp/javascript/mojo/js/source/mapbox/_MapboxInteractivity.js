(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.gmaps.MapUtils");var $MOJO=mstrmojo,$ARR=$MOJO.array,$MUTLS=$MOJO.gmaps.MapUtils;mstrmojo.mapbox._MapboxInteractivity=mstrmojo.provide("mstrmojo.mapbox._MapboxInteractivity",{_mixinName:"mstrmojo.mapbox._MapboxInteractivity",_listeners:null,addEventListeners:function addEventListeners(){var _baseMap=this.getMapboxInstance(),_listeners=this._listeners=[{evt:"click",fn:this.onMouseClick.bind(this)},{evt:"contextmenu",fn:this.onContextMenu.bind(this)},{evt:"mousemove",fn:this.onMouseMove.bind(this)},{evt:"mouseout",fn:this.onMouseOut.bind(this)}];if(_baseMap){$ARR.forEach(_listeners,function(listener){_baseMap.on(listener.evt,listener.fn);});}},getAllQueryLayers:function getAllQueryLayers(){var layerIds=[];this.forEachGraphicLayer(function(graphicLayer){var _viewer=graphicLayer._viewer;if($MUTLS.checkHasFunction(_viewer,"getQueryLayers")){layerIds=layerIds.concat(_viewer.getQueryLayers());}});return layerIds;},getGraphicsFromFeature:function getGraphicsFromFeature(feature){var results=[];if(feature){this.forEachGraphicLayer(function(graphicLayer){var _viewer=graphicLayer&&graphicLayer._viewer;if(_viewer&&_viewer.contain(feature)){results=_viewer.getGraphicsFromFeature(feature);return false;}});}return results;},onMouseClick:function onMouseClick(e){if(!e){return ;}var map=this.getMapboxInstance(),point=e.point,features=map&&map.queryRenderedFeatures([point.x,point.y],{layers:this.getAllQueryLayers()}),firstFeature=features&&features[0];this.handleMouseClickEvt(e.originalEvent,this.getGraphicsFromFeature(firstFeature));this.forEachGraphicLayer(function(graphicLayer){var selectedGraphics=graphicLayer.selectedGraphics,_viewer=graphicLayer._viewer;if($MUTLS.checkHasFunction(_viewer,"contain")&&_viewer.contain(firstFeature)){_viewer.highlightGraphics(selectedGraphics);}});this.highlightAllLayers();},highlightAllLayers:function highlightAllLayers(){var isThereAnyHighlight=false;this.forEachGraphicLayer(function(graphicLayer){if(graphicLayer&&((graphicLayer.selectedGraphics&&graphicLayer.selectedGraphics.length>0)||(graphicLayer.contextMenuSelection&&graphicLayer.contextMenuSelection.length>0))){isThereAnyHighlight=true;}});if(isThereAnyHighlight){this.forEachGraphicLayer(function(graphicLayer){if(graphicLayer){var _viewer=graphicLayer._viewer,selGraphics=graphicLayer.selectedGraphics,ctxGraphics=graphicLayer.contextMenuSelection;if($MUTLS.checkHasFunction(_viewer,"handleHighlight")){_viewer.handleHighlight(selGraphics,ctxGraphics);}}});}else{this.forEachGraphicLayer(function(graphicLayer){var _viewer=graphicLayer&&graphicLayer._viewer;if($MUTLS.checkHasFunction(_viewer,"handleSelections")){_viewer.handleSelections();}if($MUTLS.checkHasFunction(_viewer,"handleContextMenu")){_viewer.handleContextMenu();}});}},onContextMenu:function onContextMenu(e){if(!e){return ;}var map=this.getMapboxInstance(),point=e.point,features=map&&map.queryRenderedFeatures([point.x,point.y],{layers:this.getAllQueryLayers()}),firstFeature=features&&features[0];this.handleContextMenuEvt(e.originalEvent,this.getGraphicsFromFeature(firstFeature));this.forEachGraphicLayer(function(graphicLayer){var contextMenuSelection=graphicLayer.contextMenuSelection,_viewer=graphicLayer._viewer;if(_viewer&&_viewer.contain(firstFeature)){_viewer.handleContextMenu(contextMenuSelection);}});this.highlightAllLayers();this.cntMenuShowTime=new Date();},onMouseMove:function onMouseMove(e){if(this.cntMenuShowTime&&(new Date()-this.cntMenuShowTime)<100){this.cntMenuShowTime=undefined;return ;}var map=this.getMapboxInstance(),layers=this.getAllQueryLayers(),point=e&&e.point,originalEvent=e&&e.originalEvent,features,firstFeature;if(!map||!layers||layers.length<1){return ;}if(point){features=map.queryRenderedFeatures([point.x,point.y],{layers:layers});}firstFeature=features&&features[0];if(!firstFeature){this.hideTooltip(true);}this.forEachGraphicLayer(function(graphicLayer){var _viewer=graphicLayer&&graphicLayer._viewer;if($MUTLS.checkHasFunction(_viewer,"handleHover")){if(_viewer.contain(firstFeature)){_viewer.handleHover(firstFeature,originalEvent);}else{_viewer.handleHover();}}});},onMouseOut:function onMouseOut(){this.onMouseMove();},removeEventListeners:function removeEventListeners(){var map=this.getMapboxInstance(),_listeners=this._listeners,_baseMap=this.getMapboxInstance();if(!_baseMap||!_listeners){return ;}$ARR.forEach(_listeners,function(listener){map.off(listener.evt,listener.fn);});}});}());