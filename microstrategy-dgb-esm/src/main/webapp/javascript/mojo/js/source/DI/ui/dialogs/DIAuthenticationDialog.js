(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.array","mstrmojo.string","mstrmojo.Editor","mstrmojo.DI.DIConstants","mstrmojo.DI.DIHelpers");mstrmojo.requiresDescs(118,221,1162,8374,8513,10071,12580,14900,14901,14902,14614,15210,15211);var $HASH=mstrmojo.hash,$ARR=mstrmojo.array,$STR=mstrmojo.string,$DIHelper=mstrmojo.DI.DIHelpers,constants=mstrmojo.DI.DIConstants;var hiddenPwd="PWDHIDDEN123!@#";var $CONNECTION_TYPE_ITEMS=[{did:2,n:mstrmojo.desc(14900,"Username and Password")}];function addLabeledControl(label,ctrl){var editor=this,box,cfg;cfg={scriptClass:"mstrmojo.Box",cssClass:"ctrl-box cf",children:[{scriptClass:"mstrmojo.Label",cssClass:"ctrl-label",cssDisplay:"inline-block",text:label},$HASH.copy({cssDisplay:"inline-block"},ctrl)]};box=editor.addChildren([cfg])[0];return box.children[1];}function addAuthenticationControls(){var editor=this,dbrole=editor.dbrole;addLabeledControl.call(editor,mstrmojo.desc(8513,"User:"),{scriptClass:"mstrmojo.TextBox",value:dbrole&&dbrole.ln||"",onvalueChange:function(){editor.checkValid();}});addLabeledControl.call(editor,mstrmojo.desc(1162,"Password:"),{scriptClass:"mstrmojo.TextBox",type:"password",value:!!dbrole?hiddenPwd:""});addLabeledControl.call(editor,mstrmojo.desc(14901,"Connection Name:"),{scriptClass:"mstrmojo.TextBox",value:dbrole&&dbrole.n||"",onvalueChange:function(){editor.checkValid();}});}function getControl(index){var controls,box;controls=$ARR.filter(this.children,function(w){return w.cssClass&&w.cssClass.indexOf("ctrl-box")>=0;});if(index<controls.length){box=controls[index];}if(box&&box.children.length===2){return box.children[1];}return null;}function checkDBRoleName(n,id){var model=mstrApp.getRootController().getModel(),dbroles=model.authDBRoles,idx,valid;idx=$ARR.find(dbroles,"n",n);if(idx<0){valid=true;}else{valid=dbroles[idx].did===id;}return valid;}function saveAuthDBRole(){var controller=mstrApp.getRootController(),editor=this,type=getControl.call(editor,0),sel=type.items[type.selectedIndex],dbrole=editor.dbrole,ctrl;if(sel.did===2){if(!dbrole){dbrole={tp:29,stp:7429,writable:"1",shared:"0",dbr_type:"6",owned:"1",connstr:"AuthMode=Basic;",db_type:7700,cefu:1,driverMode:1,dbms:constants.urlAuthDBMSId};}dbrole.ln=$STR.trim(getControl.call(editor,1).value);ctrl=getControl.call(editor,2);if(ctrl.value!==hiddenPwd){dbrole.password=ctrl.value;}dbrole.n=$STR.trim(getControl.call(editor,3).value);if(!checkDBRoleName(dbrole.n,dbrole.did)){controller.displayError(mstrmojo.desc(14614,"This name already exists. Please choose a different name."));return ;}if(editor.sharedConnection.isChecked()){dbrole.shared="1";}else{dbrole.shared="0";}controller.dataService.saveDBRole({success:function(){controller.getAuthenticationDBRoles();editor.close();},failure:function(res){if($DIHelper.isWS()){controller.displayError(null,false,res&&res.message,null,mstrmojo.desc(15210,"Add a New Connection"),mstrmojo.desc(15211,"Unexpected error occurred."));}else{controller.displayError(mstrmojo.desc(12580,"Unexpected error occurred during an operation. Please try again."),false,res&&res.message);}}},{dbroleinfo:JSON.stringify(dbrole)});}}mstrmojo.DI.ui.dialogs.DIAuthenticationDialog=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.DI.ui.dialogs.DIAuthenticationDialog",cssClass:"mstrmojo-DI-ui-dialogs-DIAuthenticationDialog",title:mstrmojo.desc(8374,"Connection"),onOpen:function(){var dbrole=this.dbrole;var isShared=false;var list=addLabeledControl.call(this,mstrmojo.desc(14902,"Credential Type:"),{scriptClass:"mstrmojo.ui.Pulldown",isHostedWithin:false,items:$CONNECTION_TYPE_ITEMS});list.set("selectedIndex",0);addAuthenticationControls.call(this);if(dbrole){isShared=!!parseInt(dbrole.shared,10);}this.addChildren([{scriptClass:"mstrmojo.CheckBox",cssClass:"sharedConnection",cssDisplay:"block",visible:false,alias:"sharedConnection",label:mstrmojo.desc(10071,"Share this connection with all users"),checked:isShared}]);this.checkValid();},checkValid:function(){var editor=this,btn=editor.btnHbox&&editor.btnHbox.children[0],valid,ln,n;ln=$STR.trim(getControl.call(editor,1).value);n=$STR.trim(getControl.call(editor,3).value);valid=ln.length&&n.length;if(btn){btn.set("enabled",!!valid);}},buttons:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton hot",text:mstrmojo.desc(118,"Save"),onclick:function(){saveAuthDBRole.call(this.parent.parent);}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton",text:mstrmojo.desc(221,"Cancel"),onclick:function(){var editor=this.parent.parent;editor.close();}}]});}());