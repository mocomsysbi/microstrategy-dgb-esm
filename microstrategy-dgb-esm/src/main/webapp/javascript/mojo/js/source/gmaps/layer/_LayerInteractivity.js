(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.gmaps.MapEnums","mstrmojo.gmaps.MapUtils");var $MOJO=mstrmojo,$ARR=$MOJO.array,$GMAPS=$MOJO.gmaps,$MUTIL=$GMAPS.MapUtils,LAYER_INDEX_MAX=$GMAPS.LAYER_INDEX_MAX,$EnumBaseMapType=$GMAPS.EnumBaseMapType;function needAddToSelections(curSelectedGraphics,newSelectedGraphics,useMultiple){if(!$ARR.isArray(curSelectedGraphics)||!$ARR.isArray(newSelectedGraphics)){return ;}var firstGraphic=newSelectedGraphics[0],selectedGraphics,intersection;if(firstGraphic.isSelected()){selectedGraphics=firstGraphic.getGraphicsForSelection();intersection=$ARR.intersection(selectedGraphics,curSelectedGraphics,"id");if(useMultiple||(selectedGraphics.length===curSelectedGraphics.length&&curSelectedGraphics.length===intersection.length)){return false;}}return true;}mstrmojo.gmaps.layer._LayerInteractivity=mstrmojo.provide("mstrmojo.gmaps.layer._LayerInteractivity",{_mixinName:"mstrmojo.gmaps.layer._LayerInteractivity",selectedGraphics:[],preCssTransform:null,panBy:function panBy(cssTransform){var _viewer=this._viewer;if(_viewer){_viewer.stopUpdate();_viewer.setTransform(cssTransform);}},resetCssTransform:function resetCssTransform(){var _viewer=this._viewer;if(_viewer){_viewer.setTransform({x:0,y:0});}this.preCssTransform=null;},handleGraphicsClick:function handleGraphicsClick(graphicArr,evt){if(!graphicArr||graphicArr.length<1||!this.map){return ;}var map=this.map,ctrlKey=evt&&(evt.ctrlKey||evt.metaKey),firstGraphic=graphicArr[0],isGraphicSelected=firstGraphic&&firstGraphic.isSelected(),isUseAsFilter,needAddToSelected,enableClearAll;if(ctrlKey){this.handleGraphicsSelection(graphicArr,!isGraphicSelected);}else{isUseAsFilter=this.isUseAsFilter();needAddToSelected=needAddToSelections(this.selectedGraphics,graphicArr,this.isForPremium());enableClearAll=!(isUseAsFilter&&needAddToSelected);map.clearSelections(enableClearAll);if(needAddToSelected){this.handleGraphicsSelection(graphicArr,true);}}},handleGraphicsContextMenuClick:function handleGraphicsContextMenuClick(graphicArr){if(!graphicArr||graphicArr.length<1||!this.map){return ;}$ARR.forEach(graphicArr,function(graphic){this.addToContextMenuSelection(graphic,true);},this);},handleGraphicsSelection:function handleGraphicsSelection(graphicArr,toAdd){var isAddedSelectedGraphics=false,map=this.map,vizbox=map&&map.parent;$ARR.forEach(graphicArr,function(graphic){if(!toAdd){this.removeSelectedGraphics(graphic);}else{this.addToSelectedGraphics(graphic);isAddedSelectedGraphics=true;}},this);map.displayVizBoxVisFilterIndicator(isAddedSelectedGraphics,vizbox);},addToSelectedGraphics:function addToSelectedGraphics(graphic){if(!graphic){return ;}if(!this.selectedGraphics){this.selectedGraphics=[];}var _viewer=this._viewer,graphicsToAdd=graphic.getGraphicsForSelection();$ARR.forEach(graphicsToAdd,function(subGraphic){if(this.findIdxInSelectedGraphics(subGraphic)>-1){return ;}this.selectedGraphics.push(subGraphic);subGraphic.setSelection(true);},this);if($MUTIL.checkHasFunction(_viewer,"moveGraphicToTop")){_viewer.moveGraphicToTop(graphic);}this.originSelectedGraphics.push(graphic);this.addVisSelection(this.getGraphicsDataRowIndices([graphic]));},addToContextMenuSelection:function addToContextMenuSelection(graphic,needMoveToFront){if(!graphic){return ;}if(!this.contextMenuSelection){this.contextMenuSelection=[];}var _viewer=this._viewer,graphicsToAdd=graphic.getGraphicsForSelection();if(needMoveToFront&&$MUTIL.checkHasFunction(_viewer,"moveGraphicToTop")){_viewer.moveGraphicToTop(graphic);}$ARR.forEach(graphicsToAdd,function(subGraphic){if(this.findIdxInContextMenuSelectedGraphics(subGraphic)>-1){return ;}this.contextMenuSelection.push(subGraphic);subGraphic.setContextMenuSelection(graphic.isSelected(),true);},this);this.addVisContextMenuSelection(this.getGraphicsDataRowIndices([graphic]));},cloneSelectionToContextMenuSelection:function cloneSelectionToContextMenuSelection(){var i,osg=this.originSelectedGraphics,len=osg&&osg.length;for(i=0;i<len;i=i+1){this.addToContextMenuSelection(osg[i]);}},removeSelectedGraphics:function removeSelectedGraphics(graphic){if(!graphic||!this.selectedGraphics){return ;}var _viewer=this._viewer,subGraphics=graphic.getGraphicsForSelection(),graphicIndex=this.originSelectedGraphics.indexOf(graphic);$ARR.forEach(subGraphics,function(subGraphic){var selectIdx=this.findIdxInSelectedGraphics(subGraphic);if(selectIdx<0){return ;}this.selectedGraphics.splice(selectIdx,1);subGraphic.setSelection(false);},this);if($MUTIL.checkHasFunction(_viewer,"moveGraphicToBottom")){_viewer.moveGraphicToBottom(graphic);}if(graphicIndex!==-1){this.originSelectedGraphics.splice(graphicIndex,1);}this.removeVisSelection(graphic.getDataRowIndices());},clearAllSelectedGraphics:function clearAllSelectedGraphics(enableClearAll){var map=this.map,_viewer=this._viewer,selectedGraphics=this.selectedGraphics;if(!map||!_viewer||(enableClearAll&&$MUTIL.isVI()&&this.isUseAsFilter()&&this.isClearAllDisabled())){return ;}if(selectedGraphics&&selectedGraphics.length>0){_viewer.clearHighlights(selectedGraphics);}this.selectedGraphics=[];this.originSelectedGraphics=[];this.clearSelections();},clearAllContextMenuSelection:function clearAllContextMenuSelection(){if(!this.map){return ;}$ARR.forEach(this.contextMenuSelection,function(graphic){graphic.setContextMenuSelection(graphic.isSelected(),false);});this.contextMenuSelection=[];this.clearCxtMnuSelection();},clearAllContextMenuSelectionHighLights:function clearAllContextMenuSelectionHighLights(){var _viewer=this._viewer;$ARR.forEach(this.contextMenuSelection,function(graphic){graphic.setContextMenuSelection(graphic.isSelected(),false);if(!graphic.isSelected()&&$MUTIL.checkHasFunction(_viewer,"moveGraphicToBottom")){_viewer.moveGraphicToBottom(graphic);}});if($MUTIL.checkHasFunction(_viewer,"handleContextMenu")){_viewer.handleContextMenu();}this.contextMenuSelection=[];},findIdxInSelectedGraphics:function findIdxInSelectedGraphics(graphic){if(!graphic||!this.selectedGraphics){return -1;}return this.selectedGraphics.indexOf(graphic);},findIdxInContextMenuSelectedGraphics:function findIdxInContextMenuSelectedGraphics(graphic){if(!graphic||!this.contextMenuSelection){return -1;}return this.contextMenuSelection.indexOf(graphic);},getGraphicsFromPoint:function getGraphicsFromPoint(evt){var target=this.getTargetFromPoint(evt);return $ARR.ensureArray(this.findTouchedGraphic(target));},getTargetFromPoint:function getTargetFromPoint(evt){if(!this._viewer){return ;}var target,_viewer=this._viewer,isDataLabelLayerShown=_viewer.isDataLabelShown(),isAffinityLineShown=_viewer.isAffinityLineShown();if(isDataLabelLayerShown){_viewer.hideDataLabelLayer();}if(isAffinityLineShown){_viewer.hideAffinityLineLayer();}if(_viewer){_viewer.setLayerZIndex(LAYER_INDEX_MAX);}target=document.elementFromPoint(evt.clientX,evt.clientY);this.setLayerZIndex();if(isDataLabelLayerShown){_viewer.showDataLabelLayer();}if(isAffinityLineShown){_viewer.showAffinityLineLayer();}return target;},findTouchedGraphic:function findTouchedGraphic(target){var graphicID=target&&target.graphicID;if(graphicID){return mstrmojo.all[graphicID];}return null;},hasGraphicSelected:function hasGraphicSelected(){return !!this.selectedGraphics&&(this.selectedGraphics.length>0);},isInFilterPanel:function isInFilterPanel(){var map=this.map;return !!map&&map.isInFilterPanel();},handleClickEvt:mstrmojo.emptyFn,handleContextMenuEvt:function handleContextMenuEvt(e,graphics){var map=this.map;if(e&&graphics){e.graphics=graphics;map.handleContextMenuEvt(e);this.handleGraphicsContextMenuClick(graphics);}}});}());