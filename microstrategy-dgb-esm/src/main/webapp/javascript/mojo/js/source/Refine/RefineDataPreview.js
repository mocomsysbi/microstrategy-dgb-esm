(function(){mstrmojo.requiresCls("mstrmojo.Refine.PopupEditBox","mstrmojo.Widget","mstrmojo.Table","mstrmojo.DataGrid","mstrmojo.Container","mstrmojo.Refine.RefineDataHeader","mstrmojo.Refine.RefineDataCell","mstrmojo.Refine.RefinePagination","mstrmojo.dom");mstrmojo.requiresDescs(4046,4049,1058,1059,2968,773,11411);var $CSS=mstrmojo.css;var headerNode={scriptClass:"mstrmojo.Refine.RefineDataHeader"};var cellNode={scriptClass:"mstrmojo.Refine.RefineDataCell"};var TOTALROWS="### rows";function comma(value){return value.toString().replace(/(\d)(?=(?:\d{3})+$)/g,"$1,");}mstrmojo.Refine.RefineDataPreview=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasLayout],{scriptClass:"mstrmojo.Refine.RefineDataPreview",markupString:'<div class="refine-data-preview"><div class="refine-datapreivew-title cf"></div><div class="fixed-width-preview-container"><div class="fixed-width-preview-container-inner" mstrAttach:scroll></div></div><div class="refine-viewpanel-header"></div></div>',markupSlots:{headerNode:function(){return this.domNode.children[2];},dataNode:function(){return this.domNode.children[1];},tableNode:function(){return this.domNode.children[1].children[0];},titleNode:function(){return this.domNode.firstChild;}},enableEdit:true,columnIndex:-1,lastColumnIndex:-1,markupMethods:{onvisibleChange:function(){this.headerNode.style.display=this.enableEdit?"block":"none";}},onscroll:function(){this.controller.model.raiseEvent({name:"previewScrollTop",scrollTop:this.tableNode.scrollTop});},setDimensions:function setDimensions(h,w){var height=parseInt(h,10);var width=parseInt(w,10);var _delta=6;if(isNaN(height)||isNaN(width)){return ;}if(!this.layoutConfig){this.layoutConfig={h:{},w:{}};}height-=32;this.layoutConfig.h.dataNode=(this.enableEdit?(height-26-2):(height-2))+"px";this.layoutConfig.w.dataNode=(width-2)+"px";this.layoutConfig.h.tableNode=(this.enableEdit?(height-26-2-_delta):(height-2-_delta))+"px";this.layoutConfig.w.tableNode=(width-2)+"px";this.layoutConfig.w.headerNode=(width-16-2)+"px";if(this._super){this._super((height-2)+"px",(width-2)+"px");}},children:[{scriptClass:"mstrmojo.Refine.RefinePagination",slot:"headerNode",alias:"pagingNode"},{scriptClass:"mstrmojo.Table",slot:"tableNode",cssClass:"refine-table",alias:"dataTable",onremoveChild:function(evt){var children=evt.value;for(var i=0;i<children.length;i++){children[i].destroy();}},populateData:function(columns,data){this.removeChildren();this.unrender();var i=0,j,cell;this.rows=data.rows.length+1;this.cols=columns.length;for(j=0;j<columns.length;j++){headerNode.slot=i+","+j;headerNode.columnIndex=j;headerNode.text=columns[j].name;headerNode.preview=this.parent;headerNode.allowEdit=this.parent.enableEdit;this.addChildren(headerNode);}for(i=1;i<=data.rows.length;i++){for(j=0;j<columns.length;j++){cell=cellNode;cell.slot=i+","+j;cell.columnIndex=j;cell.column=columns;cell.rowIndex=data.rows[i-1].i;var c=data.rows[i-1].cells[columns[j].cellIndex];if(c===null||c===undefined){c={v:""};}if(c.v===null||c.v===undefined){c.v="";}cell.text=c.v;if(c.t){cell.cssClass=c.t;}else{if(typeof c.v==="string"||c.v instanceof String){cell.cssClass="text";cell.text=c.v;}else{cell.cssClass="number";}}cell.preview=this.parent;cell.columnName=columns[j].name;this.addChildren(cell);}}this.render();this.updateCellClass(columns,data);},updateCellClass:function(columns,data){var i,j;var rows=this.domNode.firstChild.children;for(i=0;i<=data.rows.length;i++){var row=rows[i];var cells=row.children;for(j=0;j<columns.length;j++){if(i===0){cells[j].className="refine-header";}else{cells[j].className="refine-cell";}if(this.parent.columnIndex>=0&&this.parent.columnIndex===j){cells[j].className+=" selected";if(i===data.rows.length){cells[j].className+=" last";}}if(this.parent.lastColumnIndex>=0&&this.parent.lastColumnIndex===j){cells[j].className+=" last-selected";if(i===data.rows.length){cells[j].className+=" last";}}}}}},{alias:"previewTitle",slot:"titleNode",scriptClass:"mstrmojo.Label",cssClass:"refine-title-label"},{slot:"titleNode",scriptClass:"mstrmojo.Refine.RefineSampleButton",cssClass:"refine-title-sampleButton",},{scriptClass:"mstrmojo.Button",slot:"titleNode",alias:"refreshButton",cssClass:"mstrmojo.Refine.RefreshButton",iconClass:"mstrmojo-refine-refresh-button",visible:false,onclick:function(){var ctrl=mstrApp.getRootController(),refineCtrl=ctrl.refineApp.rootController,m=refineCtrl.model;if(m.hasUploadData){refineCtrl.refreshSampleData(0);}},useRichTooltip:true,updateTooltipConfig:function(){this.set("richTooltip",{cssClass:"vi-regular vi-tooltip-V",refNode:this.domNode,posType:mstrmojo.tooltip.POS_TOPCENTER,left:(parseInt(this.domNode.offsetWidth,10)+6).toString()+"px",top:"-"+(parseInt(this.domNode.offsetHeight,10)+21).toString()+"px",content:mstrmojo.desc(773,"refresh")});}}],columns:null,populate:function(columns,data){var model=this.controller.model;var tableID=this.controller.tableID;var source;var name="";source=mstrApp.getRootController().getModel().getImportSource(tableID);if(source){name=source.sourceInfo.name;}if(!!this.previewTitle){this.previewTitle.set("text",mstrmojo.desc(11411,"Sample Data")+": "+name);}this.dataTable.populateData(columns,data);this.pagingNode.children[1].set("text","/");this.pagingNode.children[2].set("text",comma(model.data.filtered)+" "+mstrmojo.desc(2968,"Rows"));this.pagingNode.right.totalPages.set("text","/ "+Math.ceil((parseInt(model.data.filtered,10)/parseInt(model.limit,10))).toString());this.pagingNode.set("totalPages",Math.ceil((parseInt(model.data.filtered,10)/parseInt(model.limit,10))).toString());this.handleStartChange();},handleDataChanged:function(event){this.data=event.value;this.populate(this.columns,this.data);this.controller.model.raiseEvent({name:"columnUnSelected"});},handleColumnsChanged:function(event){this.columns=event.value.columns;},handleColumnSelected:function(event){if(this.columnIndex!==event.columnIndex){if(event.isCtrlKey){this.lastColumnIndex=this.columnIndex;this.lastColumnName=this.columnName;}else{this.lastColumnIndex=-1;}this.columnIndex=event.columnIndex;this.columnName=event.columnName;this.dataTable.updateCellClass(this.columns,this.data);if(event.updateScrollLeft){this.tableNode.scrollLeft=this.dataTable["0,"+this.columnIndex].offsetLeft;}}if(this.lastColumnIndex>=0){if(this.lastColumnIndex<this.columnIndex){this.controller.generateColumnSuggestions(this.columnIndex,this.lastColumnName,this.columnName,this.columnIndex-this.lastColumnIndex+1);}else{this.controller.generateColumnSuggestions(this.columnIndex,this.columnName,this.lastColumnName,this.lastColumnIndex-this.columnIndex+1);}}else{this.controller.generateColumnSuggestions(this.columnIndex);}},handleColumnUnSelected:function(){this.columnIndex=-1;this.lastColumnIndex=-1;if(this.data){this.dataTable.updateCellClass(this.columns,this.data);}this.controller.model.raiseEvent({name:"emptySuggestions"});},handleStartChange:function(){var model=this.controller.model;if(model.start===0){this.pagingNode.right.firstNode.set("enabled",false);this.pagingNode.right.firstNode.set("useRichTooltip",false);this.pagingNode.right.previousNode.set("enabled",false);this.pagingNode.right.previousNode.set("useRichTooltip",false);}else{this.pagingNode.right.firstNode.set("enabled",true);this.pagingNode.right.firstNode.set("useRichTooltip",true);this.pagingNode.right.previousNode.set("enabled",true);this.pagingNode.right.previousNode.set("useRichTooltip",true);}if(model.start+model.limit>=model.data.filtered){this.pagingNode.right.nextNode.set("enabled",false);this.pagingNode.right.nextNode.set("useRichTooltip",false);this.pagingNode.right.lastNode.set("enabled",false);this.pagingNode.right.lastNode.set("useRichTooltip",false);this.pagingNode.right.currentPage.set("value",parseInt(parseInt(model.start,10)/parseInt(model.limit,10),10)+1);this.pagingNode.children[0].set("text",comma(parseInt(model.start,10)+1)+" - "+comma(model.data.filtered));}else{this.pagingNode.right.nextNode.set("enabled",true);this.pagingNode.right.nextNode.set("useRichTooltip",true);this.pagingNode.right.lastNode.set("enabled",true);this.pagingNode.right.lastNode.set("useRichTooltip",true);this.pagingNode.right.currentPage.set("value",parseInt(parseInt(model.start,10)/parseInt(model.limit,10),10)+1);this.pagingNode.children[0].set("text",comma(parseInt(model.start,10)+1)+" - "+comma(parseInt(model.start,10)+parseInt(model.limit,10)));}},});}());