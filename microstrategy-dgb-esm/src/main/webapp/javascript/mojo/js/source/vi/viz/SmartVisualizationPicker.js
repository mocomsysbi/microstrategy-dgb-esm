(function(){mstrmojo.requiresCls("mstrmojo.vi.viz.EnumVizStyles","mstrmojo.vi.viz.EnumDSSDropZones","mstrmojo.mstr.EnumDSSXMLObjectTypes","mstrmojo.mstr.EnumDSSXMLBaseFormType","mstrmojo.gm.GMEnums","mstrmojo.vi.viz.EnumWidgetTypes","mstrmojo.hash","mstrmojo.vi.models._IsNLPModel");var ENUM_VIZ_STYLES=mstrmojo.vi.viz.EnumVizStyles,ENUM_DROP_ZONES=mstrmojo.vi.viz.EnumDSSDropZones,ENUM_OBJECT_TYPES=mstrmojo.mstr.EnumDSSXMLObjectTypes,ENUM_FORM_TYPES=mstrmojo.mstr.EnumDSSXMLBaseFormType,ENUM_GRAPH_TYPE=mstrmojo.gm.EnumGraphType,ENUM_WIDGET_TYPE=mstrmojo.vi.viz.EnumWidgetTypes,isTimeAttr=mstrmojo.vi.models._IsNLPModel.isTimeAttr,$HASH=mstrmojo.hash;var ENUM_VISUALIZATIONS={KPICardVisualizationStyle:{s:"KPICardVisualizationStyle",dz:"mstrmojo.vi.models.KPICardDropZones",wtp:ENUM_WIDGET_TYPE.KPICARD},GoogleMapVisualizationStyle:{s:ENUM_VIZ_STYLES.GOOGLE_MAP,vt:2,wtp:ENUM_WIDGET_TYPE.GOOGLEMAP},MapboxVisualizationStyle:{s:ENUM_VIZ_STYLES.MAPBOX,wtp:ENUM_WIDGET_TYPE.MAPBOX},VIHeatMapVisualizationStyle:{s:ENUM_VIZ_STYLES.HEAT_MAP,vt:1,wtp:ENUM_WIDGET_TYPE.HEATMAP},GraphMatrixVisualizationStyle:{s:ENUM_VIZ_STYLES.GRAPH_MATRIX,vt:{v:70,h:71},wtp:ENUM_WIDGET_TYPE.GRAPH_MATRIX},BAR:{s:ENUM_VIZ_STYLES.GRAPH_MATRIX,chartType:ENUM_GRAPH_TYPE.BAR,vt:{v:70,h:71},wtp:ENUM_WIDGET_TYPE.GRAPH_MATRIX},BUBBLE:{s:ENUM_VIZ_STYLES.GRAPH_MATRIX,chartType:ENUM_GRAPH_TYPE.BUBBLE,vt:21,wtp:ENUM_WIDGET_TYPE.GRAPH_MATRIX},LINE:{s:ENUM_VIZ_STYLES.GRAPH_MATRIX,chartType:ENUM_GRAPH_TYPE.LINE,vt:{v:72,h:73},wtp:ENUM_WIDGET_TYPE.GRAPH_MATRIX},PIE:{s:ENUM_VIZ_STYLES.GRAPH_MATRIX,chartType:ENUM_GRAPH_TYPE.PIE,vt:61,wtp:1},NetworkVisualizationStyle:{s:ENUM_VIZ_STYLES.NETWORK,vt:58,wtp:ENUM_WIDGET_TYPE.NETWORK},Grid:{s:"",vt:0,wtp:ENUM_WIDGET_TYPE.GRID}};function getObjectsCategoryInfo(objects,fnPostCategorized){var metrics=[],attributes=[],dateAttr=null,geoAttr=null;(objects||[]).forEach(function(obj,idx){if(obj.t===ENUM_OBJECT_TYPES.Metric||obj.isDM){metrics.push(obj);}else{attributes.push(obj);}if(!geoAttr){(obj.fs||[]).forEach(function(form){var fgr=form.fgr;obj.lat=fgr===5?form.fid:obj.lat;obj.lng=fgr===6?form.fid:obj.lng;});geoAttr=(obj.lat&&obj.lng)?obj:geoAttr;}if(!dateAttr&&isTimeAttr(obj)){dateAttr=obj;}if(fnPostCategorized){fnPostCategorized(obj,idx);}});return{metrics:metrics,attributes:attributes,dateAttr:dateAttr,geoAttr:geoAttr};}mstrmojo.vi.viz.SmartVisualizationPicker=mstrmojo.declare(mstrmojo.Base,null,{scriptClass:"mstrmojo.vi.viz.SmartVisualizationPicker",buildVisualization:function(ro,style){var objects=ro.items,sorts=ro.sorts;var SORTS_ITEM={};if(sorts&&sorts.length>0){sorts.forEach(function(obj){SORTS_ITEM[obj.did]=true;});}(objects||[]).forEach(function(obj){obj.useInSort=!!(SORTS_ITEM[obj.did]);});var styleObj=this.getVisualizationStyle(objects,style);this.setObjectsDropzone(objects,styleObj);var widgetProps=this.getVisualizationProperties(objects,styleObj);return{objects:objects,style:styleObj,widgetProps:widgetProps};},mapConfig:null,getVisualizationStyle:function getVisualizationStyle(objects,style){var viz,me=this,checkForMap=function checkForMap(){return ENUM_VISUALIZATIONS[$HASH.walk("mapConfig.mapbox.token",me)?ENUM_VIZ_STYLES.MAPBOX:ENUM_VIZ_STYLES.GOOGLE_MAP];};if(style&&((style===ENUM_VIZ_STYLES.GOOGLE_MAP)||(style===ENUM_VIZ_STYLES.ESRI_MAP)||(style===ENUM_VIZ_STYLES.MAPBOX))){return checkForMap();}if(style&&style!==""){return ENUM_VISUALIZATIONS[style]||{n:style,wtp:ENUM_WIDGET_TYPE.CUSTOM};}var objectsInfo=getObjectsCategoryInfo(objects),metricCount=objectsInfo.metrics.length,attrCount=objectsInfo.attributes.length;if(metricCount===1&&attrCount===0){viz=ENUM_VISUALIZATIONS.KPICardVisualizationStyle;}else{if(metricCount===2&&attrCount===1){viz=ENUM_VISUALIZATIONS.BUBBLE;}else{if(objectsInfo.geoAttr){viz=checkForMap();}else{if(objectsInfo.dateAttr){viz=ENUM_VISUALIZATIONS.LINE;}else{viz=ENUM_VISUALIZATIONS.BAR;}}}}return viz;},setObjectsDropzone:function setObjectsDropzone(objects,style){var objectsInfo,metrics,attributes,metric,attribute,fnApplyColorByAndSizeBy=function(metrics,attributes,useAttr){var metric0=metrics[0],metric1=metrics[1],att0=attributes&&attributes[0];if(useAttr){if(metric0){metric0.zoneId=ENUM_DROP_ZONES.SizeBy;}if(att0){att0.zoneId=ENUM_DROP_ZONES.ColorBy;}}else{if(metric0){metric0.zoneId=ENUM_DROP_ZONES.ColorBy;}if(metric1){metric1.zoneId=ENUM_DROP_ZONES.SizeBy;}}};objects=objects||[];switch(style.s){case"MapboxVisualizationStyle":objectsInfo=getObjectsCategoryInfo(objects,function(obj){obj.zoneId=ENUM_DROP_ZONES.AdditionalMetrics;});var gAttr=objectsInfo.geoAttr;if(gAttr){gAttr.zoneId=ENUM_DROP_ZONES.GeoAttribute;gAttr.usedInDropZones=true;}mstrmojo.array.forEach(objectsInfo.metrics,function(met){met.zoneId=9;});break;case"KPICardVisualizationStyle":objectsInfo=getObjectsCategoryInfo(objects);metric=objectsInfo.metrics[0];if(metric){metric.zoneId=ENUM_DROP_ZONES.Metric;}break;case ENUM_VIZ_STYLES.GRAPH_MATRIX:switch(style.chartType){case ENUM_GRAPH_TYPE.LINE:case ENUM_GRAPH_TYPE.BAR:var isColorByEmpty=true,typeOnXAxis,typeOnYAxis;objects.forEach(function(obj,idx){if(idx===0){typeOnYAxis=obj.isDM&&obj.fn?ENUM_OBJECT_TYPES.Metric:obj.t;obj.zoneId=ENUM_DROP_ZONES.YAxis;}else{if(typeOnXAxis&&typeOnYAxis&&isColorByEmpty&&!obj.useInSort){obj.zoneId=ENUM_DROP_ZONES.ColorBy;isColorByEmpty=false;}else{if(obj.t===typeOnYAxis){obj.zoneId=ENUM_DROP_ZONES.YAxis;}else{obj.zoneId=ENUM_DROP_ZONES.XAxis;typeOnXAxis=obj.t;}}}});break;case ENUM_GRAPH_TYPE.PIE:var index;objectsInfo=getObjectsCategoryInfo(objects);attributes=objectsInfo.attributes;attribute=attributes[0];if(attribute){attribute.zoneId=ENUM_DROP_ZONES.ColorBy;}attribute=attributes[1];if(attribute){attribute.zoneId=ENUM_DROP_ZONES.XAxis;}for(index=2;index<attributes.length;index++){attributes[index].zoneId=ENUM_DROP_ZONES.AdditionalMetrics;}metrics=objectsInfo.metrics;metric=metrics[0];if(metric){metric.zoneId=ENUM_DROP_ZONES.Angle;}metric=metrics[1];if(metric){metric.zoneId=ENUM_DROP_ZONES.YAxis;}metric=metrics[2];if(metric){metric.zoneId=ENUM_DROP_ZONES.SizeBy;}for(index=3;index<metrics.length;index++){metrics[index].zoneId=ENUM_DROP_ZONES.AdditionalMetrics;}break;case ENUM_GRAPH_TYPE.BUBBLE:var yAxisTaken=false;objects.forEach(function(obj){if(obj.t===ENUM_OBJECT_TYPES.Metric||obj.isDM){if(!yAxisTaken){obj.zoneId=ENUM_DROP_ZONES.YAxis;yAxisTaken=true;}else{obj.zoneId=ENUM_DROP_ZONES.XAxis;}}else{obj.zoneId=ENUM_DROP_ZONES.BreakBy;}});break;}break;case ENUM_VIZ_STYLES.GOOGLE_MAP:objectsInfo=getObjectsCategoryInfo(objects,function(obj){obj.zoneId=ENUM_DROP_ZONES.AdditionalMetrics;});if(objectsInfo.geoAttr){objectsInfo.geoAttr.zoneId=ENUM_DROP_ZONES.GeoAttribute;}metrics=objectsInfo.metrics;fnApplyColorByAndSizeBy(metrics);break;case ENUM_VIZ_STYLES.HEAT_MAP:objectsInfo=getObjectsCategoryInfo(objects,function(obj){obj.zoneId=(obj.t===ENUM_OBJECT_TYPES.Metric)?ENUM_DROP_ZONES.AdditionalMetrics:ENUM_DROP_ZONES.Grouping;});metrics=objectsInfo.metrics;attributes=objectsInfo.attributes;fnApplyColorByAndSizeBy(metrics,attributes,true);break;case ENUM_VIZ_STYLES.NETWORK:objectsInfo=getObjectsCategoryInfo(objects);attributes=objectsInfo.attributes;attribute=attributes[0];if(attribute){attribute.zoneId=ENUM_DROP_ZONES.FromItem;}attribute=attributes[1];if(attribute){attribute.zoneId=ENUM_DROP_ZONES.ToItem;}metrics=objectsInfo.metrics;fnApplyColorByAndSizeBy(metrics);metric=metrics[2];if(metric){metric.zoneId=ENUM_DROP_ZONES.ItemSize;}break;}},getVisualizationProperties:function getVisualizationProperties(objects,style){switch(style.s){case ENUM_VIZ_STYLES.GOOGLE_MAP:return'<props><widgetProps><fmt><gtp value="2"/><lm value="1"/><LegendPosition value="2"/><showLegend value="false"/><clgd value="1"/><ls value="false"/><bmt value="1"/><dv value="Topographic Map"/><lx value="0"/><ln value="Layer 1"/><ih value="0"/><ga value=""/><lat value=""/><lng value=""/><cmt value=""/><smt value=""/><tooltip value=""/><elx value="0"/><dlShw value="0"/><dlShwAll value="false"/><dlFntFml value="Arial"/><dlFntSz value="8pt"/><dlFntStyle value="0"/><dlFntClr value="0"/><mtp value="5"/><maxst value="1"/><minst value="1"/></fmt></widgetProps></props>';}}});}());