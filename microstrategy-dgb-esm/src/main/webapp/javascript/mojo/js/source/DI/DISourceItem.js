(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.Label","mstrmojo.List","mstrmojo.DI.DIConstants","mstrmojo.dom","mstrmojo.Button","mstrmojo.List","mstrmojo.Table","mstrmojo.DI.DIDatabaseHelper","mstrmojo.warehouse.EnumDatabaseType","mstrmojo.DI.DIHelpers");mstrmojo.requiresDescs(13191,13227,13961,14030,14712,14893,9849,15172);var $H=mstrmojo.hash,constants=mstrmojo.DI.DIConstants,$A=mstrmojo.array,$DOM=mstrmojo.dom,$HELPER=mstrmojo.DI.DIDatabaseHelper,$ENUM_DATABASE_TYPE=mstrmojo.warehouse.EnumDatabaseType,$Helper=mstrmojo.DI.DIHelpers,detectCustomImg=mstrmojo.DI.DIHelpers.detectCustomImg;function disableImportOptionByDBType(dbType,srcItem){if(dbType===constants.dbType.PIG){srcItem.showImportOption=false;srcItem.sourceInfo.type=constants.xdaType.ffsql;}}function excludeDB(dbType){if(mstrApp.isSingleTier){if((dbType===1400)&&!(window.FormWrapper.isWin32&&window.FormWrapper.isWin32())){return true;}if([6800,5300,5600,6600,7000].indexOf(dbType)!==-1){return true;}}return false;}mstrmojo.DI.DISourceItem=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasPopup],{scriptClass:"mstrmojo.DI.DISourceItem",pageType:null,icon:null,dbTypeIconCls:null,title:"",n:"",desc:"",connectorDesc:"",enabled:true,containHadoopFile:false,showImportOption:false,dbTypes:null,tooltipOpenDelay:0,useRichTooltip:true,keywordLeft:"",keyword:"",keywordRight:"",waitDbTypesFetched:false,preBuildRendering:function preBuildRendering(){if(this._super){this._super();}var name=!this.keyword?"{@en@n}":'{@en@keywordLeft}<span style="font-weight: bold;">{@en@keyword}</span>{@en@keywordRight}';this.markupString='<div id="{@id}" class="mstrmojo-di-source-item {@icon}" mstrAttach:click,mouseover,mouseout><div class="mstrmojo-di-source-name"><span class="mstrmojo-di-source-name-span normal">'+name+'</span></div><div class="mstrmojo-di-source-below"><div class="mstrmojo-di-Icons medium-{@icon} {@dbTypeIconCls}"></div><div class="mstrmojo-di-source-link"></div><div class="mstrmojo-di-source-desc">{@en@desc}</div><div class="mstrmojo-di-source-desc"><span class="mstrmojo-di-source-name-span connector">{@en@connectorDesc}</span></div><div class="mstrmojo-di-source-introduction"></div><div class="mstrmojo-di-source-link mstrmojo-di-source-editlink-paddingtop"></div><div class="mstrmojo-di-source-pulldown mstrmojo-di-source-link-paddingtop"></div><div class="mstrmojo-di-source-link"></div></div></div>';},markupSlots:{nameNode:function(){return this.domNode.firstChild;},iconNode:function(){return this.domNode.children[1].children[0];},firstLinkNode:function(){return this.domNode.children[1].children[1];},descNode:function(){return this.domNode.children[1].children[2];},connectordescNode:function(){return this.domNode.children[1].children[3];},introductionNode:function(){return this.domNode.children[1].children[4];},editLinkNode:function(){return this.domNode.children[1].children[5];},pulldownNode:function(){return this.domNode.children[1].children[6];},lastLinkNode:function(){return this.domNode.children[1].lastChild;}},markupMethods:{onvisibleChange:function(){this.domNode.style.display=this.visible?"block":"none";}},init:function init(props){this._super(props);var model=mstrApp.getRootController().model;if(this.dbObjectsDisplayOptions){if(model.supportDBObjects&&model.supportDBObjects.supportDBType){this.filterDB();}else{model.attachEventListener(constants.srcItemTypes.DBTYPE_SOURCE,this.id,"filterDB");}}},filterDB:function filterDB(evt){var model,dbTypes,uniqDBTypes,isCustomConnector=evt&&evt.isCustomConnector;if(!mstrApp.getRootController){return ;}if(!evt||!evt.src){model=mstrApp.getRootController().model;}else{model=evt.src;}dbTypes=model.supportDBObjects&&model.supportDBObjects.supportDBType;dbTypes=$HELPER.filterDBByDispOption(dbTypes,this.dbObjectsDisplayOptions,this.dbIdExcludeFilter);dbTypes=$HELPER.filterDBByAdminConfig(dbTypes,this.dbRolesAdminConfig);this.dbTypes=dbTypes;this.dbIds=$HELPER.getDBIds(dbTypes);if(this.isWaitingDBTypes){mstrApp.hideProgress();this.onclick(this.clickEvent,this.clickEventTarget);}if(!mstrApp.isSingleTier&&this.sid===constants.sourceItemType.database&&!mstrApp.dbRoles&&this.showDBList&&!isCustomConnector){uniqDBTypes=$HELPER.getUniqueDBTypes(dbTypes);if($Helper.getEnvObj().isAppSchema()){uniqDBTypes=$A.filter(uniqDBTypes,function(item){return $Helper.filterDisableSources(item);});}mstrApp.getRootController().getDBRoles(uniqDBTypes,this.dbRolesAdminConfig);}},handleSourceSelect:function handleSourceSelect(selectedItem,subItem){var $this=this,defaultConfig,dbTypes=[],dbItems=[],config,controller=mstrApp.getRootController(),model=controller.model,isFilterDDA,isXquery=!!subItem&&subItem.dbType===3000,sourceInfo;if(!mstrApp.isSingleTier&&this.sid===constants.sourceItemType.database&&mstrApp.dbRoles){if(!$H.equals(mstrApp.dbRolesAdminConfig,this.dbRolesAdminConfig||[])){mstrApp.dbRoles=undefined;}}mstrApp.dbmsID=selectedItem.oid;mstrApp.conUrl=selectedItem.url;mstrApp.clientId=selectedItem.user;mstrApp.newConDbroleId=selectedItem.oid;if(selectedItem.dbIds){dbTypes=(subItem&&subItem.dbType)?[subItem.dbType]:$HELPER.getUniqueDBTypes(selectedItem.dbTypes);isFilterDDA=$this.parent.parent.isFilterDDA;$A.forEach(dbTypes,function(dbType){if(!isFilterDDA||model.canAddToDDACube(selectedItem.sourceInfo.subtype,dbType)){dbItems.push(dbType);}});mstrApp.dbIds=(subItem&&subItem.id)?[].concat(subItem.id):selectedItem.dbIds;mstrApp.dbTypes=dbItems;mstrApp.supportDBObjects=mstrApp.getRootController().model.supportDBObjects;mstrApp.dbObjectsDisplayOptions=this.dbObjectsDisplayOptions;mstrApp.dbRolesVersionExcludeFilter=this.excludeDBVFilter||[];}if(selectedItem.showImportOption){defaultConfig={onOK:function(item){var sourceInfoClone=mstrmojo.hash.clone($this.sourceInfo);var sourceInfo=mstrmojo.hash.copy(item.sourceInfo,sourceInfoClone);$this.openSelectedSource(item.pageType,sourceInfo);}};if(selectedItem.sourceInfo.type===constants.sourceType.googleBigQuery){config={isODBC:true,srcInfo:selectedItem.sourceInfo};}else{if(selectedItem.sourceInfo.type===constants.xdaType.querybuilder){if(selectedItem.isSAPHanaDDA){config={isSAPHanaDDA:true};}else{config=(subItem&&subItem.dbType===$ENUM_DATABASE_TYPE.SAPHana)?{isSAPHana:true}:{isODBC:true};config.hasNonSAPHana=selectedItem.hasNonSAPHana;if(isXquery){sourceInfo={sourceType:constants.sourceType.querybuilder,type:constants.xdaType.ffsql};controller.showPage(constants.pageType.database,sourceInfo);return ;}}}else{if(selectedItem.enableHadoopOption){config=$H.copy(defaultConfig,{isContainHadoop:true});}else{config=$H.copy(defaultConfig,{isContainHadoop:false});}}}mstrApp.getRootController().showDialog(constants.dialogType.qbImportOptionDialog,config);}else{if(selectedItem.importFromCube){var cfg={OKFn:function(item){if(item&&item.did){if(model.cubeID&&model.cubeID===item.did){controller.displayError(mstrmojo.desc(14893,"We have detected that you are attempting to merge a dataset with itself. Please select different datasets."),false);return ;}controller.importFromCube(item.did,!controller.model.hasEMMAReportInstance(),constants.actions.importSource);}},oTypes:[779,776,3],supportedTypes:$A.hash([779,776,3]),rootFolderType:7,isImportFromCube:selectedItem.importFromCube};if($Helper.getEnvObj().isWSDataSet()){var callback={success:function(res){if(res&&res.objectId){if(model.cubeID&&model.cubeID===res.objectId){controller.displayError(mstrmojo.desc(14893,"We have detected that you are attempting to merge a dataset with itself. Please select different datasets."),false);return ;}controller.importFromCube(res.objectId,!model.hasEMMAReportInstance(),constants.actions.importSource);}}};var params={taskId:"openNativeWindow",windowType:1};mstrApp.serverRequest(params,callback,{});}else{mstrApp.getRootController().showDialog(constants.dialogType.objectPicker,cfg);}}else{if(selectedItem.addConnector||selectedItem.newConnector){mstrApp.getRootController().showDialog(constants.dialogType.addConnectorDialog);}else{if(selectedItem.pageType===constants.pageType.cloudElement){var idx=$A.find(model.cloudElementDBRoles,"did",subItem.did);$this.openSelectedSource(undefined,{n:idx>=0?model.cloudElementDBRoles[idx].n:"",did:subItem.did});}else{$this.openSelectedSource();}}}}},openSelectedSource:function(pageType,sourceInfo){var controller=mstrApp.getRootController(),slot;if(!this.pageType){return ;}if(this.enabled){if(mstrApp.isSingleTier&&this.checkConectivity&&window.FormWrapper.testInternetConnection()!==0){var errorMessage=mstrmojo.desc(13961,"No Internet connection. You can configure an Internet proxy through your computer's #."),replaceStr='<a href="" onclick="mstrApp.getRootController().dialogController.close(mstrmojo.DI.DIConstants.dialogType.errorDialog);window.setTimeout(function(){window.FormWrapper.showProxyEditor();},100);return false;">'+mstrmojo.desc(14125,"settings")+"</a>";errorMessage=errorMessage.replace("#",replaceStr)+".";controller.displayError(errorMessage,false,"",null,mstrmojo.desc(11812,"Notification"));return ;}slot=mstrApp.getRootController().navigationController.getPageSlot();slot.setConfig({properties:{operationMode:constants.operationMode.create}});controller.showPage(pageType===undefined?this.pageType:pageType,sourceInfo===undefined?this.sourceInfo:sourceInfo,slot);}},onclick:function(evt,clickEventTarget){var evtTarget=evt.getTarget();if(!evtTarget){evtTarget=clickEventTarget;}var target=$DOM.findWidget(evtTarget);if(!target){return ;}var dbList=this.dbList;if(evt.e&&evt.e.button===1){evt.cancel();return ;}if(dbList){if(this.waitDbTypes&&!this.dbTypes){this.isWaitingDBTypes=true;this.clickEvent=evt;this.clickEventTarget=evt.e&&(evt.e.target||evt.e.srcElement);mstrApp.showProgress();return ;}if(target===dbList||target===dbList.list){return ;}}this.handleSourceSelect(target);},onmouseover:function(evt){var originalEvt=evt.e;if($DOM.contains(this.domNode,originalEvt.relatedTarget,true)){originalEvt.stopImmediatePropagation();}},onmouseout:function(evt){var originalEvt=evt.e;if($DOM.contains(this.domNode,originalEvt.relatedTarget,true)){originalEvt.stopImmediatePropagation();}},postBuildRendering:function postBuildRendering(){if(this._super){this._super();}if(this.customizeIcon){if(!constants.sourceIconClsName[this.itemId]){detectCustomImg(this.originalName?this.originalName:this.n,this.iconNode);}}else{if(this.iconData&&mstrmojo.string.startsWith(this.iconData,"data:image")){this.iconNode.innerHTML='<img src="'+this.iconData+'" style="width:75px;height:75px;"/>';}else{if($Helper.isOriginalConnector(this.oid)&&this.oid===constants.originalConnector.elastic){mstrmojo.css.addClass(this.iconNode,"medium-Elastic_Connector");}else{if($Helper.isOriginalConnector(this.oid)&&this.oid===constants.originalConnector.tapClicks){mstrmojo.css.addClass(this.iconNode,"medium-TapClicks_Connector");}else{if(!this.icon&&!mstrmojo.string.startsWith(this.iconData,"data:image")&&!$Helper.isOriginalConnector(this.oid)){mstrmojo.css.addClass(this.iconNode,"medium-defaultconnector");}}}}}if(!this.enabled){mstrmojo.css.addClass(this.domNode,"disabled");}else{mstrmojo.css.addClass(this.domNode,"enabled");}this.nameNode.firstChild.style.position="relative";this.nameNode.firstChild.style.top=((this.nameNode.clientHeight-this.nameNode.firstChild.clientHeight)/2)+"px";var model=mstrApp.getRootController().model;if(this.waitDbTypesFetched&&model.sourceList.length===0&&mstrApp.diParams.ImportDatabase!==0){model.attachEventListener(constants.srcItemTypes.DBTYPE_SOURCE,this.id,function(){this.set("enabled",true);mstrmojo.css.removeClass(this.domNode,"disabled");mstrmojo.css.addClass(this.domNode,"enabled");});}},updateTooltipConfig:function(){var pos=$DOM.position(this.nameNode);this.set("richTooltip",{cssClass:"vi-regular A-center vi-tooltip-V",top:Math.max(pos.y-20,0),left:Math.max(pos.x+pos.w/2,0),posType:mstrmojo.tooltip.POS_BOTTOMCENTER,content:this.title});},postCreate:function(){if(this.containHadoopFile&&!mstrApp.isSingleTier){var browseHadoopFilesButton={scriptClass:"mstrmojo.Button",slot:"firstLinkNode",alias:"hadoopFiles",text:mstrmojo.desc(13191,"Browse Hadoop Files"),onclick:function onclick(evt){$DOM.stopPropogation(evt.hWin,evt.e);var controller=mstrApp.getRootController();controller.showPage(constants.pageType.hadoop,1);}};!mstrApp.diParams.disableHadoop&&this.addChildren(browseHadoopFilesButton);}if(!$Helper.isWS()&&this.showOAuthLink&&(mstrApp.diParams.SetOAuthParams||mstrApp.isSingleTier)){var setOAuthButton={scriptClass:"mstrmojo.Button",slot:"editLinkNode",alias:"setOAuth",text:mstrmojo.desc(13227,"Set OAuth Parameters"),onclick:function onclick(event){event.cancel();var model=mstrApp.getRootController().model;var externalSources=model.externalSources[this.parent.sourceInfo.type];var sourceItem=this.parent;mstrApp.getRootController().openOAuthParaDialog(event,{sourceName:externalSources.name,did:externalSources.dbRoleID,isOneTier:!!mstrApp.isSingleTier,sourceItem:sourceItem});}};this.addChildren(setOAuthButton);}if(this.showWhiteListLink&&!mstrApp.isSingleTier&&mstrApp.diParams.configureProjectBasic){var setWhiteList={scriptClass:"mstrmojo.Button",slot:"editLinkNode",alias:"setWhiteList",text:mstrmojo.desc(14712,"Set Allowed URLs"),onclick:function onclick(event){if(this.parent.enabled){event.cancel();var sourceItem=this.parent;mstrApp.getRootController().openWhiteListDialog(event,{isOneTier:!!mstrApp.isSingleTier,sourceItem:sourceItem});}}};this.addChildren(setWhiteList);}if(this.showEditDialog&&(!mstrApp.isSingleTier||mstrApp.isWorkstation)){var me=this,introductionButton={scriptClass:"mstrmojo.Button",slot:"introductionNode",alias:"introductionButton",text:mstrmojo.desc(9849,"Learn more"),bindings:{visible:function(){return me.introductionUrl.trim()!="";}},onclick:function onclick(event){if(this.parent.enabled){event.cancel();var url=me.introductionUrl.trim();if($Helper.isWS()){window.FormWrapper.openPage(url);}else{window.open(url);}}}};this.addChildren(introductionButton);}if(this.showEditDialog&&(!mstrApp.isSingleTier||mstrApp.isWorkstation)){var me=this,editButton={scriptClass:"mstrmojo.Button",slot:"editLinkNode",alias:"editConnector",text:mstrmojo.desc(15172,"Edit Connector"),onclick:function onclick(event){var rootCtrl=mstrApp.getRootController();if(this.parent.enabled){event.cancel();rootCtrl.connectorScrollTop=this.parent.parent.domNode.scrollTop;rootCtrl.openEditConnectorDialog(event,{title:me.n,isNew:false,name:me.n,url:me.url,desc:me.connectorDesc,introductionUrl:me.introductionUrl,iconData:me.iconData,oid:me.oid,type:me.type,user:me.user,pwd:me.pwd});}}};this.addChildren(editButton);}}});}());