(function(){mstrmojo.requiresCls("mstrmojo.string","mstrmojo.expr","mstrmojo.array","mstrmojo.hash");mstrmojo.requiresDescs(308,5923,7930,5282,5283,2793,2787,2788,12298);var $STR=mstrmojo.string,$EXP=mstrmojo.expr,$XPT=$EXP.ET,$ARR=mstrmojo.array,$HASH=mstrmojo.hash;var $EXP_FN=$EXP.FN,FN_NOT=$EXP.BRANCH_FNS[$EXP_FN.NOT],OBJECT_TYPE=mstrmojo.mstr.EnumDSSXMLObjectTypes,OBJECT_SUBTYPE=mstrmojo.mstr.EnumDSSXMLObjectSubTypes,CONSOLIDATION_TYPE=mstrmojo.mstr.EnumDSSConsolidationType;function HTML_ANGLES(str){return $STR.htmlAngles(str)||"";}var STR_TEMPLATE={betweenText:mstrmojo.desc(308,"and"),atText:mstrmojo.desc(5923,"at"),emptyText:mstrmojo.desc(7930,"Empty condition"),andText:mstrmojo.desc(5282,"AND"),orText:mstrmojo.desc(5283,"OR"),boldandText:"<span style='font-weight:bold;'>"+mstrmojo.desc(5282,"AND")+"</span>",boldorText:"<span style='font-weight:bold;'>"+mstrmojo.desc(5283,"OR")+"</span>",whereText:mstrmojo.desc(2793,"Where (##)"),notText:mstrmojo.desc(12298,"NOT")};var EXPRNODE_TO_HTML_STRING={"*":function(d,config){return{html:d?('<span class="mstrmojo-unknown">'+(HTML_ANGLES(d.n||d.xml)||"...")+"</span>"):null,text:d?(HTML_ANGLES(d.n||d.xml)||"..."):null};}};function _isNot(data){return !!data.not||data.fn===$EXP_FN.NOT_EQUAL||data.fn===$EXP_FN.NOT_IN_LIST||data.fn===$EXP_FN.NOT_BETWEEN||data.fn===$EXP_FN.NOT;}function _not(data){if(data&&data.not){return{html:'<span class="mstrmojo-text mstrmojo-not">'+FN_NOT+"</span>",text:FN_NOT+" "};}return{html:"",text:""};}function _htmlEmbedObj(n,obj_t){var html=n&&((obj_t?'<span class="mstrmojo-ListIcon t'+obj_t+'"></span>':"")+'<span class="mstrmojo-text mstrmojo-embedobj">'+HTML_ANGLES(n)+"</span>");return{html:html,text:n&&((obj_t?obj_t+" ":"")+HTML_ANGLES(n))};}function getAttributeCls(attr,oriCls){var cls=oriCls&&oriCls.trim().split(" ")||[];if(attr.t===OBJECT_TYPE.Attribute&&attr.st===OBJECT_SUBTYPE.AttributeRecursive){cls.push("recursive");}else{if(attr.t===OBJECT_TYPE.Consolidation&&attr.st===OBJECT_SUBTYPE.ConsolidationManaged){cls.push("derived");if(attr.ndetype===CONSOLIDATION_TYPE.DssRecursiveDerivedElement){cls.push("recursive");}}}return cls.join(" ");}function _htmlAttribute(att,cls){var attrName=HTML_ANGLES(att.n);return{html:'<span class="mstrmojo-text mstrmojo-attr '+getAttributeCls(att,cls)+'">'+attrName+"</span>",text:attrName};}EXPRNODE_TO_HTML_STRING[$XPT.R]=function(d,config){return _htmlEmbedObj(d.r&&d.r.n,d.r&&d.r.t);};EXPRNODE_TO_HTML_STRING[$XPT.F]=function(d,config){return _htmlEmbedObj(d.f&&d.f.n,d.f&&d.f.t);};EXPRNODE_TO_HTML_STRING[$XPT.XML]=function(d,config){return _htmlEmbedObj(d.n||d.p&&d.p.n||d.xml,d.p&&d.p.t);};EXPRNODE_TO_HTML_STRING[$XPT.AE]=function(d,config){var h=[],txt=[],emptyTxt=(config&&config.elemsEmpty)||"("+mstrmojo.desc(2210,"Empty")+")";if(d&&d.a&&d.a.n){var attribute=_htmlAttribute(d.a);h.push(attribute.html);txt.push("{"+attribute.text+"}");var fnName=HTML_ANGLES($EXP.fnName(d.et,d.fn,d.fnt));h.push('<span class="mstrmojo-text mstrmojo-fn">'+fnName+"</span>");txt.push(" "+fnName+" ");var es=d.es,l=es&&es.length||0;if(l){h.push('<span class="mstrmojo-elems">');txt.push("[");var k=h.length,eleName="";for(var e=0;e<l;e++){h[k++]='<span class="mstrmojo-text mstrmojo-elem">';eleName=HTML_ANGLES(es[e].n);h[k++]=eleName;txt.push(eleName);if(e<l-1){h[k++]=", ";txt.push(", ");}h[k++]="</span>";}h[k++]="</span>";txt.push("]");}else{h.push('<span class="mstrmojo-text mstrmojo-emptyelems">'+emptyTxt+"</span>");txt.push(emptyTxt);}}return{html:h.join(""),text:txt.join("")};};EXPRNODE_TO_HTML_STRING[$XPT.AQ]=function(d,config){var h=[],txt=[];if(d&&d.a&&d.a.n){var attribute=_htmlAttribute(d.a);h.push(attribute.html);txt.push("{"+attribute.text+"}");if(d.fm&&d.fm.n){var fmName=HTML_ANGLES(d.fm.n);h.push('<span class="mstrmojo-text mstrmojo-form">'+fmName+"</span>");txt.push("("+fmName+")");if(d.fn!=null){var fnName=HTML_ANGLES($EXP.fnName(d.et,d.fn,d.fnt,d.fm.dtp));h.push('<span class="mstrmojo-text mstrmojo-fn">'+fnName+"</span>");txt.push(" "+fnName+" ");var cc=$EXP.fnCstCount(d.fn,d.fnt);if(d.et===$XPT.AC){if(cc>=1){if(d.a2&&d.a2.n){var attr2Name=HTML_ANGLES(d.a2.n);h.push('<span class="mstrmojo-text mstrmojo-attr2">'+attr2Name+"</span>");txt.push("{"+attr2Name+"}");if(d.fm2&&d.fm2.n){var fm2Name=HTML_ANGLES(d.fm2.n);h.push('<span class="mstrmojo-text mstrmojo-form2">'+fm2Name+"</span>");txt.push("("+fm2Name+")");}}if(cc>1){h.push('<span class="mstrmojo-text mstrmojo-btwn">'+STR_TEMPLATE.betweenText+"</span>");txt.push(" "+STR_TEMPLATE.betweenText+" ");if(d.a3&&d.a3.n){var attr3Name=HTML_ANGLES(d.a3.n);h.push('<span class="mstrmojo-text mstrmojo-attr3">'+attr3Name+"</span>");txt.push("{"+attr3Name+"}");if(d.fm3&&d.fm3.n){var fm3Name=HTML_ANGLES(d.fm3.n);h.push('<span class="mstrmojo-text mstrmojo-form3">'+fm3Name+"</span>");txt.push("("+fm3Name+")");}}}}}else{if(d.et===$XPT.AL){var cs=d.cs||[],t=[];for(var i=0,len=cs.length;i<len;i++){t.push(cs[i].v);}var tList=t.join(mstrConfig.listSep);h.push('<span class="mstrmojo-text mstrmojo-c1">'+tList+"</span>");txt.push("["+tList+"]");}else{if(cc>=1){var cs=d.cs,c0=cs&&cs[0];var c0Name=HTML_ANGLES(c0&&c0.p&&c0.p.n||c0&&c0.v);h.push('<span class="mstrmojo-text mstrmojo-c1">'+c0Name+"</span>");txt.push(c0Name);if(cc>1){var c1=cs&&cs[1];h.push('<span class="mstrmojo-text mstrmojo-btwn">'+STR_TEMPLATE.betweenText+"</span>");txt.push(" "+STR_TEMPLATE.betweenText+" ");var c1Name=HTML_ANGLES(c1&&c1.p&&c1.p.n||c1&&c1.v);h.push('<span class="mstrmojo-text mstrmojo-c1">'+c1Name+"</span>");txt.push(c1Name);}}}}}}}return{html:h.join(""),text:txt.join("")};};EXPRNODE_TO_HTML_STRING[$XPT.AC]=EXPRNODE_TO_HTML_STRING[$XPT.AQ];EXPRNODE_TO_HTML_STRING[$XPT.AL]=EXPRNODE_TO_HTML_STRING[$XPT.AQ];EXPRNODE_TO_HTML_STRING[$XPT.MQ]=function(d,config){var h=[],txt=[],metric=d&&d.m,name=metric&&metric.n;if(name){var functionType=d.fnt,funcTypePercentage=$EXP.FNT.PER,funcTypeRank=$EXP.FNT.RANK;name=functionType===funcTypePercentage?mstrmojo.desc(2787,"Percentage of ##").replace("##",name):functionType===funcTypeRank?mstrmojo.desc(2788,"Rank of ##").replace("##",name):name;h.push('<span class="mstrmojo-text mstrmojo-metric">'+HTML_ANGLES(name)+"</span>");txt.push(HTML_ANGLES(name));if(d.fn!=null){var fnName=HTML_ANGLES($EXP.fnName(d.et,d.fn,functionType,$EXP.DTP.REAL));h.push('<span class="mstrmojo-text mstrmojo-fn">'+fnName+"</span>");txt.push(" "+fnName+" ");var cc=$EXP.fnCstCount(d.fn,functionType);if(d.et==$EXP.ET.MC){if(cc>=1){var m2n=(d.m2&&d.m2.n)||(d.c2&&d.c2.v)||"?";h.push('<span class="mstrmojo-text mstrmojo-m2">'+HTML_ANGLES(m2n)+"</span>");txt.push(HTML_ANGLES(m2n));if(cc>1){h.push('<span class="mstrmojo-text mstrmojo-btwn">'+STR_TEMPLATE.betweenText+"</span>");txt.push(" "+STR_TEMPLATE.betweenText+" ");var m3n=(d.m3&&d.m3.n)||(d.c3&&d.c3.v)||"?";h.push('<span class="mstrmojo-text mstrmojo-m3">'+HTML_ANGLES(m3n)+"</span>");txt.push(HTML_ANGLES(m3n));}}}else{if(cc>=1){var cs=d.cs,c0=cs&&cs[0];var fnPercent=function(c){var v=c.v;if(d.fnt==funcTypePercentage){if(v.replace){c.v=v.replace(/%$/,"");}v=c.v+"%";}return v;};var percentage=HTML_ANGLES(c0&&c0.p&&c0.p.n||c0&&c0.v&&fnPercent(c0));h.push('<span class="mstrmojo-text mstrmojo-c1">'+percentage+"</span>");txt.push(percentage);if(cc>1){var c1=cs&&cs[1],c1Name=HTML_ANGLES(c1&&c1.p&&c1.p.n||c1&&c1.v&&fnPercent(c1));h.push('<span class="mstrmojo-text mstrmojo-btwn">'+STR_TEMPLATE.betweenText+"</span>");txt.push(" "+STR_TEMPLATE.betweenText+" ");h.push('<span class="mstrmojo-text mstrmojo-c2">'+c1Name+"</span>");txt.push(c1Name);}}}var uts=d.dmy&&d.dmy.uts,uLen=uts&&uts.length;if(uLen){h.push('<span class="mstrmojo-text mstrmojo-at">'+STR_TEMPLATE.atText+"</span>");txt.push(" "+STR_TEMPLATE.atText+" ");h.push('<span class="mstrmojo-dmy">');for(var u=0;u<uLen;u++){var ut=uts[u];h.push('<span class="mstrmojo-text mstrmojo-dmyunit">');h.push(HTML_ANGLES(ut.utgt?ut.utgt.n:ut.n));txt.push(HTML_ANGLES(ut.utgt?ut.utgt.n:ut.n));if(u<uLen-1){h.push(",");txt.push(",");}h.push("</span>");}h.push("</span>");}}}return{html:h.join(""),text:txt.join("")};};EXPRNODE_TO_HTML_STRING[$XPT.MC]=EXPRNODE_TO_HTML_STRING[$XPT.MQ];EXPRNODE_TO_HTML_STRING[$XPT.ANDOR]=function(d,config){var h=[],txt=[],emptyTxt=(config&&config.elemsEmpty)||"("+mstrmojo.desc(2210,"Empty")+")",tgt=$HASH.valarray($EXP.findTargets(d,"did"))[0],isFirst=true;function addPrefix(not){if(!isFirst){h.push('<span class="spliter"></span>');txt.push(", ");}isFirst=false;if(not){txt.push(mstrmojo.desc(12298,"NOT")+" ");}}if(!tgt){return{html:'<span class="mstrmojo-text mstrmojo-emptyelems">'+emptyTxt+"</span>",text:emptyTxt};}var attribute=_htmlAttribute(tgt,"andor");h.push(attribute.html);txt.push("{"+attribute.text+"}");h.push("<span>:</span>");txt.push(" : ");h.push('<span class="mstrmojo-elems">');txt.push("[");$ARR.forEach(d.nds,function walkChildren(nd){if(!nd){return ;}var isNot=_isNot(nd),fm=nd.fm,cs=nd.cs,cssCls,eleName,cstName,cst;switch(nd.et){case $XPT.ANDOR:$ARR.forEach(nd.nds,walkChildren);break;case $XPT.AE:switch(nd.fn){case $EXP_FN.IN_LIST:case $EXP_FN.NOT_IN_LIST:$ARR.forEach(nd.es,function(e){addPrefix(isNot);cssCls=isNot?" not":"";eleName=HTML_ANGLES(e.n);h.push('<span class="mstrmojo-text mstrmojo-elem single'+cssCls+'">'+eleName+"</span>");txt.push(eleName);});break;case $EXP_FN.DESCENDANT:var clonedEs=(nd.es||[]).slice();if(clonedEs.length===0){clonedEs.push({n:emptyTxt});}$ARR.forEach(clonedEs,function(e){addPrefix(isNot);cssCls=isNot?" not":"";eleName=HTML_ANGLES(e.n);if(cs&&cs[0]){var displayName;cst=cs[0].v;if(isNaN(cst)){cstName=cst.substr(cst.indexOf(";")+1);}else{cstName=mstrmojo.desc(493,"Level")+" "+(parseInt(cst,10)+1);}displayName=cstName+" "+mstrmojo.desc(12853,"of")+" "+eleName;h.push('<span class="mstrmojo-text mstrmojo-elem level'+cssCls+'">');h.push(displayName);txt.push(displayName);}else{h.push('<span class="mstrmojo-text mstrmojo-elem descendant'+cssCls+'">');h.push(HTML_ANGLES(e.n));txt.push(eleName);}h.push("</span>");});break;}break;case $XPT.AQ:$ARR.forEach(nd.cs,function(c){addPrefix(isNot);cssCls=isNot?" not":"";cst=c.v;cstName=(fm&&fm.n)?HTML_ANGLES(fm.n+" "+cst):"";if(fm&&fm.n==="LEVEL_NUMBER"){cssCls+=" level";if(isNaN(cst)){cstName=cst.substr(cst.indexOf(";")+1);}else{cstName=mstrmojo.desc(493,"Level")+" "+(parseInt(cst,10)+1);}}h.push('<span class="mstrmojo-text mstrmojo-elem constant'+cssCls+'">'+cstName+"</span>");txt.push(cstName);});break;}});h.push("</span>");txt.push("]");return{html:h.join(""),text:txt.join("")};};function getExprNodeHtmlAndTextPrivate(nd,config){var convertFn=EXPRNODE_TO_HTML_STRING[nd&&nd.et]||EXPRNODE_TO_HTML_STRING["*"],notResult=_not(nd),exprResult=convertFn&&convertFn(nd,config),emptyText=config&&config.emptyText||STR_TEMPLATE.emptyText;return{html:notResult&&notResult.html+((exprResult&&exprResult.html)||('<span class="mstrmojo-text empty-cond">'+emptyText+"</span>")),text:notResult&&notResult.text+((exprResult&&exprResult.text)||emptyText)};}function getExprConditionNodeText(nd){return getExprNodeHtmlAndTextPrivate(nd).text;}function getExprTextHelper(nd,isRoot,useBoldSplitter){if(!nd){return null;}var et=nd.et,fn=nd.fn,nds=nd.nds;if(et===$XPT.ANDOR){var boldDecorator=useBoldSplitter?"bold":"";splitter=fn===$EXP_FN.AND?STR_TEMPLATE[boldDecorator+"andText"]:(fn===$EXP_FN.OR?STR_TEMPLATE[boldDecorator+"orText"]:"");nds=[].concat(nds);if(nds.length<1){return null;}var subexprs=[],subexprText;$ARR.forEach(nds,function(child){subexprText=getExprTextHelper(child,false,useBoldSplitter);if(subexprText){subexprs.push(subexprText);}});var exprText,subCnt=subexprs.length;if(subCnt<1){return null;}else{if(subCnt===1){exprText=subexprs[0];}else{exprText=subexprs.join(" "+splitter+" ");}}exprText=isRoot||nd.not?exprText:"("+exprText+")";return nd.not?STR_TEMPLATE.notText+" "+exprText:exprText;}else{if(et===$XPT.RLS){var dmy=nd.dmy&&nd.dmy.uts||[],txt=[],setText;$ARR.forEach(dmy,function(it){txt.push("{"+it.n+"}");});setText=txt.join(", ");var condition=nd.nds&&nd.nds[0],conditionExpr=getExprTextHelper(condition,false,useBoldSplitter);if(conditionExpr){return"("+setText+" "+STR_TEMPLATE.whereText.replace(/\(##\)/g,"").replace(/'##'/g,"")+conditionExpr+")";}return null;}else{return getExprConditionNodeText(nd);}}}function handleEmpty(expr){if(mstrmojo.fe.FilterUtils.isExprEmpty(expr)){return{et:14,fn:19};}else{((expr&&expr.nds)||[]).forEach(function(nd,idx){expr.nds[idx]=handleEmpty(nd);});return expr;}}mstrmojo.fe.FilterUtils=mstrmojo.provide("mstrmojo.fe.FilterUtils",{getExprXml:function(expr){var root="<exp>",end="</exp>",props={a:true,a2:true,a3:true,agg:true,cc:true,ce:true,cgp:true,cs:true,conid:true,desc:true,did:true,attId:true,dmt:true,dmy:true,dtp:true,es:true,et:true,expr:true,f:true,flat:true,flt:true,fm:true,fm2:true,fm3:true,fn:true,fnt:true,fres:true,gb:true,isp:true,items:true,m:true,m2:true,m3:true,n:true,nds:true,not:true,pf:true,p:true,r:true,rps:true,st:true,t:true,utgt:true,utp:true,uts:true,v:true,xml:true,relation:true,applySubExpr:true,useSchema:true,guide:true,rsTp:true,joTp:true,paTp:true,erTp:true,exp:true,joAttrs:true,ph:true,idx:true,idc:true,idcsi:true,ucfg:true,node:true},config={getArrItemName:function(n){return n.substr(0,n.length-1);},isSerializable:function(nodeName,jsons,index){if(nodeName==="xml"){var ndXML=jsons[index].xml;return{att:'hasXML = "-1"',child:ndXML};}else{if(mstrmojo.array.indexOf(["header_format","grid_format","child_header_format","child_grid_format"],nodeName)>-1){var format=jsons[index][nodeName];if(!format){return{};}var xml="<"+nodeName+">";for(var prs in format){xml+="<prs n='"+prs+"'>";var prsv=format[prs];for(var pr in prsv){var prv=prsv[pr];xml+="<pr n='"+pr+"' v='"+(prv==="pru"?"":prv)+"'";xml+=prv==="pru"?' pru="1"':"";xml+="/>";}xml+="</prs>";}xml+="</"+nodeName+">";return{child:xml};}else{if(nodeName==="cs"){var nd=jsons[index],cs=jsons[index][nodeName];if(nd&&nd.fnt&&nd.fnt==$EXP.FNT.PER&&cs){if(cs[0]){cs[0].v+="%";}if(cs[1]){cs[1].v+="%";}}return true;}else{if(nodeName==="c2"||nodeName==="c3"){var nd=jsons[index];if(nd&&nd.et==$EXP.ET.MC&&(nd.fn==$EXP.FN.BETWEEN||nd.fn==$EXP.FN.NOT_BETWEEN)){return true;}else{return false;}}}}}return(props[nodeName])?true:false;},skipNull:true},rootNode=handleEmpty(expr);if(!rootNode||rootNode.et!=$XPT.ANDOR||rootNode.fn===$EXP_FN.NOT||rootNode.not){rootNode={et:$XPT.ANDOR,fn:$EXP.FN.AND,nds:rootNode?[rootNode]:[]};}var ndXml=$STR.json2xml("nd",[{},rootNode],config);return root+ndXml+end;},isExprEmpty:function(expr){return(!expr||(expr.et===$XPT.ANDOR&&(expr.nds||[]).length<1));},getExprConditionNodeHtml:function getExprConditionNodeHtml(nd){return getExprNodeHtmlAndTextPrivate(nd).html;},getExprConditionNodeText:function getExprConditionNodeText(nd){return getExprNodeHtmlAndTextPrivate(nd).text;},getExprNodeHtmlAndText:function getExprNodeHtmlAndText(nd,config){return getExprNodeHtmlAndTextPrivate(nd,config);},getExprText:function getExprText(rootNd,useBoldSplitter){return getExprTextHelper(rootNd,true,useBoldSplitter);}});}());