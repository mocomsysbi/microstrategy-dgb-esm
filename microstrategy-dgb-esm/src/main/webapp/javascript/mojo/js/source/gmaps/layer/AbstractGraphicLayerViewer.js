(function(){mstrmojo.requiresCls("mstrmojo.Obj","mstrmojo.array","mstrmojo.dom","mstrmojo.gmaps.MapEnums","mstrmojo.gmaps.MapUtils");var $MOJO=mstrmojo,$GMAPS=$MOJO.gmaps,$DOM=$MOJO.dom,$ARR=$MOJO.array,$MUTIL=$GMAPS.MapUtils,$EnumDataLabelShowOption=$GMAPS.EnumDataLabelShowOption,emptyFn=$MOJO.emptyFn,UPDATE_INTERVAL=20;function _clearTimer(timer){if(timer){clearTimeout(timer);}}mstrmojo.gmaps.layer.AbstractGraphicLayerViewer=mstrmojo.declare(mstrmojo.Obj,null,{scriptClass:"mstrmojo.gmaps.layer.AbstractGraphicLayerViewer",key:null,parent:null,graphics:null,graphicType:null,markerType:null,isCluster:false,applyThreshold:true,updateStartTime:null,_updateStartIdx:0,getVisMap:function getVisMap(){var parent=this.parent;if(parent){return parent.map;}},getWidth:function getWidth(){var parent=this.parent;if(parent){return parent.getWidth();}},getHeight:function getHeight(){var parent=this.parent;if(parent){return parent.getHeight();}},getGraphicsOffset:function getGraphicsOffset(){var parent=this.parent;if(parent){return parent.getGraphicsOffset();}},setVisibility:function setVisibility(isVisible){var div_=this.getNode();if(div_&&div_.style){div_.style.display=(!!isVisible)?"block":"none";}},resize:function resize(width,height){var div_=this.getNode(),svgNode=this.svgNode,boundingRect=$DOM.position(div_),currentWidth=boundingRect.w,currentHeight=boundingRect.h;if($MUTIL.checkVal(height)&&$MUTIL.checkVal(width)&&!(height===currentHeight&&width===currentWidth)){height=parseInt(height);width=parseInt(width);$MUTIL.setCssStyles(div_,{height:height+"px",width:width+"px"});$MUTIL.setCssStyles(svgNode,{height:height+"px",width:width+"px"});}},getMapZoom:function getMapZoom(){var map=this.getMapInstance();if(map){return map.getZoom();}},getNode:emptyFn,setTransform:emptyFn,clean:emptyFn,update:emptyFn,setShapeFillColor:emptyFn,setShapeFillOpacity:emptyFn,setShapeStrokeColor:emptyFn,setShapeStrokeStyle:emptyFn,getMapInstance:function getMapInstance(){var baseLayer=this.execMethodOfParent("getBaseLayer");if(baseLayer){return baseLayer.getBaseMap();}},getFmts:function getFmts(){return this.execMethodOfParent("getLayerFmts");},hasSizeby:function hasSizeby(){return this.execMethodOfParent("hasSizeByMetric");},isVisible:function isVisible(){return this.execMethodOfParent("isVisible");},hasThreshold:function hasThreshold(){return this.execMethodOfParent("hasColorByMetric");},hasColorByAttr:function hasColorByAttr(){return this.execMethodOfParent("hasColorByAttribute");},hasColorBy:function hasColorBy(){return this.hasThreshold()||this.hasColorByAttr();},getLabelOffset:function getLabelOffset(){return[0,0];},getFontSize:function getFontSize(){var labelConfig=this.execMethodOfParent("getLabelConfig");if(labelConfig){return parseInt(labelConfig.dlFontStyle.fontSize);}},execMethodOfParent:function execMethodOfParent(methodName){var parent=this.parent;if(methodName&&$MUTIL.checkHasFunction(parent,methodName)){return parent[methodName]();}else{console.log("method doesn't exist");}},setLayerZIndex:function setLayerZIndex(zIndex){var div_=this.getNode();if(div_&&div_.style&&$MUTIL.checkVal(zIndex)){div_.style.zIndex=parseInt(zIndex);}},needLabel:function needLabel(){var labelConfig=this.execMethodOfParent("getLabelConfig");return !!labelConfig&&labelConfig.dlShowOption!==$EnumDataLabelShowOption.NONE;},getGraphicsContained:function getGraphicsContained(selectionShape){var selectedGraphics=[],graphics=this.graphics,graphic,i,il;if(!graphics||graphics.length<1){return ;}for(i=0,il=graphics.length;i<il;i++){graphic=graphics[i];if(graphic&&(graphic.intersect(selectionShape)===true)){selectedGraphics.push(graphic);}}return selectedGraphics;},updateGraphicsPositionInScreen:function updateGraphicsPositionInScreen(baseLayer){var graphicArr=this.graphics,count=(graphicArr&&graphicArr.length)||0,i=count,me=this,startTime=(new Date()).valueOf(),_updateStartIdx=this._updateStartIdx;if(!this.updateStartTime){this.updateStartTime=startTime;}this._updateStartIdx=($MUTIL.checkVal(_updateStartIdx))?_updateStartIdx:0;(function update(){var graphicArr=me.graphics,graphic,j=me._updateStartIdx,innerStartTime=new Date();if((startTime!==me.updateStartTime)||!$ARR.isArray(graphicArr)||graphicArr.length<1||!baseLayer){_clearTimer(me.updateGraphicTimer);i=count;j=me._updateStartIdx=0;me.updateStartTime=startTime;}if(i<=0){_clearTimer(me.updateGraphicTimer);me.parent.callbackForUpdateGraphics();me.updateStartTime=null;return ;}while(i>0){graphic=graphicArr[j<count?j:0];if($MUTIL.checkHasFunction(graphic,"updatePosition")){graphic.updatePosition(baseLayer.getScreenPositionInfo(graphic));}i--;j++;if((new Date()-innerStartTime)>=UPDATE_INTERVAL){break;}}me._updateStartIdx=(j>=count)?0:j;_clearTimer(me.updateGraphicTimer);me.updateGraphicTimer=setTimeout(update,0);})();},stopUpdate:function stopUpdate(){if(this.updateGraphicTimer){clearTimeout(this.updateGraphicTimer);}},setMarkerType:emptyFn,updateDataLabelLayer:emptyFn,highlightGraphics:emptyFn,desolveClustersIfZoomChanged:$MOJO.emptyFn,clearHighlights:function clearHighlights(selectedGraphics){$ARR.forEach(selectedGraphics,function(graphic){graphic.setSelection(false);},this);},destroy:function destroy(){delete this.parent;delete this.graphics;this._super();}});}());