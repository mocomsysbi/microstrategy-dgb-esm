(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.string","mstrmojo.vi.enums.EnumFilterClearActionType","mstrmojo.vi.enums.EnumVisFilterType");var ARRAY=mstrmojo.array,$STR=mstrmojo.string,CLEAR_FILTER_TYPE=mstrmojo.vi.enums.EnumFilterClearActionType,VIS_FILTER_TYPE=mstrmojo.vi.enums.EnumVisFilterType;mstrmojo.vi.ui.rw._SupportViewFilterInVizBox=mstrmojo.provide("mstrmojo.vi.ui.rw._SupportViewFilterInVizBox",{_mixinName:"mstrmojo.vi.ui.rw._SupportViewFilterInVizBox",getSelectorObjectsFromTemplateLimit:function getSelectorObjectsFromTemplateLimit(){return this.getSelObjsFromTemlateLimitHandler();},getSelectorObjectsFromViewFilter:function getSelectorObjectsFromViewFilter(){return this.getSelObjsFromVFHandler();},getSelObjsFromVFHandler:function getSelObjsFromVFHandler(){var vis=this,model=vis.model,data=vis.node.data,filterExpression=data&&data.vfexpr;return model&&model.getSelectorDataFromViewFilter(filterExpression);},getSelObjsFromTemlateLimitHandler:function getSelObjsFromTemlateLimitHandler(){var vis=this,model=vis.model,data=vis.node.data,expr=data&&data.tpl;return model&&model.getSelectorDataFromTemplateLimit(expr);},makeBold:function makeBold(str){return"<span style='font-weight:bold;'>"+str+"</span>";},getSelectorExpr:function getSelectorExpr(selectorData,isTooltipString){var menuStringArray=[],firstUnitName="",hasCommonUnit=true,typeString=selectorData.keepOnly?"##":mstrmojo.desc(13232,"Not ##"),menuString,orStr=mstrmojo.desc(5283,"OR");if(isTooltipString){orStr=this.makeBold(orStr);}selectorData.data.every(function(ORArray){[].concat(ORArray).every(function(elementData){if(firstUnitName===""){firstUnitName=elementData.tn;}return(hasCommonUnit=(firstUnitName===elementData.tn));});return hasCommonUnit;});selectorData.data.forEach(function(ORArray,idx){if(idx>0){menuStringArray.push(orStr);}var andString=[];[].concat(ORArray).forEach(function(elementData){var v=isTooltipString?$STR.encodeHtmlString(elementData.v):elementData.v,tn=isTooltipString?$STR.encodeHtmlString(elementData.tn):elementData.tn;andString.push((hasCommonUnit?"":(elementData.tn+" = "))+(v||mstrmojo.desc(14323,"NULL")));});menuStringArray.push(andString.join(" "));});if(menuStringArray.length>0){menuString=typeString.replace("##",(hasCommonUnit?firstUnitName+" = ":"")+menuStringArray.join(" "));}return menuString;},getLinkingSelectorExpr:function getLinkingSelectorExpr(selectorData,isTooltipString){var menuStringArray=[],firstUnitName="",hasCommonUnit=true,orStr=mstrmojo.desc(5283,"OR"),typeString=selectorData.keepOnly?"##":mstrmojo.desc(13232,"Not ##");if(isTooltipString){orStr=this.makeBold(orStr);}selectorData.data.every(function(ORArray){[].concat(ORArray).every(function(elementData){if(firstUnitName===""){firstUnitName=elementData.tn;}return(hasCommonUnit=(firstUnitName===elementData.tn));});return hasCommonUnit;});selectorData.data.forEach(function(ORArray,idx){var andString=[];if(hasCommonUnit){if(idx>0){andString.push(orStr);}else{andString.push(typeString.replace("##",firstUnitName+" = "));}}[].concat(ORArray).forEach(function(elementData){var v=isTooltipString?$STR.encodeHtmlString(elementData.v):elementData.v,tn=isTooltipString?$STR.encodeHtmlString(elementData.tn):elementData.tn;andString.push((hasCommonUnit?"":(tn+" = "))+(v||mstrmojo.desc(14323,"NULL")));});menuStringArray.push(andString.join(" "));});return menuStringArray.join(" ");},getFilterMenuPairs:function getFilterMenuPairs(selectorObjects){var me=this,menuPairs=[],CLEAR_STR=mstrmojo.desc(2827,"Clear");if(selectorObjects instanceof Array){selectorObjects.forEach(function(selectorData,index){var menuString=me.getSelectorExpr(selectorData),menuTtpString=me.getSelectorExpr(selectorData,true);menuPairs.push({menuString:CLEAR_STR+' "'+menuString+'"',menuTtpString:CLEAR_STR+' "'+menuTtpString+'"',ctxt:index});});}return menuPairs;},filterMenuHandler:function filterMenuHandler(ctxt,callback){var vis=this,controller=vis.controller;switch(ctxt.type){case CLEAR_FILTER_TYPE.CLEAR_KEEP_ONLY:ctxt=ctxt.idx;controller.applyKeepOnly(vis,callback,undefined,ctxt,false);break;case CLEAR_FILTER_TYPE.CLEAR_ALL:controller.clearFiltersForVis(vis,[VIS_FILTER_TYPE.KEEP_ONLY,VIS_FILTER_TYPE.LINKING,VIS_FILTER_TYPE.DRILLING],callback);break;case CLEAR_FILTER_TYPE.CLEAR_ADV_QUALIFICATION:controller.clearFiltersForVis(vis,[VIS_FILTER_TYPE.ADV_QUALIFICATION],callback);break;case CLEAR_FILTER_TYPE.CLEAR_KEEP_ONLY_AND_LINKING:controller.clearFiltersForVis(vis,[VIS_FILTER_TYPE.KEEP_ONLY,VIS_FILTER_TYPE.LINKING],callback);break;case CLEAR_FILTER_TYPE.CLEAR_LINKING:controller.clearLinkingFilter(ctxt,callback);break;case CLEAR_FILTER_TYPE.CLEAR_DRILLING:controller.clearFiltersForVis(vis,[VIS_FILTER_TYPE.DRILLING],callback);break;default:break;}},hasKeepOnly:function hasKeepOnly(selectorObjects){return selectorObjects===null||selectorObjects.length>0;},getSelectorDataForKeepOnly:function getSelectorDataForKeepOnly(nodeToAdd,nodeIdxToRemove){var visualization=this,visModel=visualization.model,data=visualization.model.data||visualization.node.data,templateLimitExpression=data.tpl,newSelectorData;if(nodeIdxToRemove===-1){newSelectorData=[];}else{newSelectorData=[].concat(visModel.getSelectorDataFromTemplateLimit(templateLimitExpression));if(nodeIdxToRemove===-2){newSelectorData=ARRAY.filter(newSelectorData,function(e){return !e.keepOnly;});}else{if(nodeIdxToRemove>=0){newSelectorData.splice(nodeIdxToRemove,1);}}}if(nodeToAdd){newSelectorData=newSelectorData.concat(nodeToAdd);}return newSelectorData;}});}());