(function(){mstrmojo.requiresClsP("mstrmojo.chart.model.enums","EnumDSSObjectType","EnumDSSAxisName");mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.array","mstrmojo.VisUtility");mstrmojo.requiresClsP("mstrmojo.vi.viz","KnownVisualizations","EnumVisualizationTemplates","VisualizationTransition","HeatMapVisualizationHelper","NetworkVisualizationHelper","ImageLayoutHelper","MapHelper");var $MOJO=mstrmojo,$HASH=$MOJO.hash,$ARR=$MOJO.array,$VIZ=$MOJO.vi.viz,$KNOWN_VIZ=$VIZ.KnownVisualizations,$CHART_ENUMS=$MOJO.chart.model.enums,$DSSOBJ_TYPES=$CHART_ENUMS.EnumDSSObjectType,$AXIS_NAMES=$CHART_ENUMS.EnumDSSAxisName,$GRID="Grid",$UTIL=$MOJO.VisUtility,THRESHOLD_BANDS=[0.1,0.3,0.5,0.7,0.9],BAND_COLORS=["#CC2525","#E34B4B","#E97D7D","#79D479","#57BA57","#2CA02C"];function getTemplateInfo(node){var gsi=$HASH.copy(node.data.gsi),whichMetricsAxis=gsi.tma===1?"rows":"cols",metricsAxis=gsi[whichMetricsAxis],mx=gsi.mx;gsi[whichMetricsAxis]=metricsAxis.filter(function(unit){return unit.t!==-1&&unit.did!=="-1";});if(mx){mx.forEach(function(m){m.t=4;});}return gsi;}function isMetricsUnit(u){return u.did==="-1"||u.t===4;}function combineDropZoneActions(node,heatmapHelper,actions,templateActions,thresholdActions){var dzActions=heatmapHelper.getAddDropZonesAction();if(heatmapHelper.colorBy.length>0){var cbUnit=heatmapHelper.colorBy[0];if(isMetricsUnit(cbUnit)){this.addThresholds(node,cbUnit,thresholdActions,BAND_COLORS,THRESHOLD_BANDS);}}dzActions.actions=templateActions.concat(dzActions.actions).concat(thresholdActions);if(dzActions.actions.length){actions.push(dzActions);}return heatmapHelper.getXml();}function pivotMetricNamesToColumnsIfNecessary(heatmapHelper,templateActions,gsi){var i,len,rows=gsi.rows,columns=gsi.cols;for(i=0,len=rows.length;i<len;i++){var row=rows[i];if(isMetricsUnit(row)){templateActions.push({act:"pivot",axis:$AXIS_NAMES.DssAxisColumns,unitPos:columns.length});}else{if(row.t!==$DSSOBJ_TYPES.DssTypeMetric&&!isMetricsUnit(row)){heatmapHelper.groupingObjects.push(row);}}}}function addNonMetricUnitsToGrouping(heatmapHelper,gsi){var i,len,columns=gsi.cols;for(i=0,len=columns.length;i<len;i++){var col=columns[i];if(col.t!==$DSSOBJ_TYPES.DssTypeMetric&&!isMetricsUnit(col)){heatmapHelper.groupingObjects.push(col);}}}function transitionGridToHeatMap(actions,node,thresholdActions){var templateActions=[],heatmapHelper=new $VIZ.HeatMapVisualizationHelper({node:node}),i,gsi=getTemplateInfo(node);pivotMetricNamesToColumnsIfNecessary(heatmapHelper,templateActions,gsi);addNonMetricUnitsToGrouping(heatmapHelper,gsi);var metrics=gsi.mx,attrs=gsi.rows,basicThresholds=[];var model=new mstrmojo.threshold.ThresholdModel({});model.set("data",$HASH.clone(node.data));model.objectType=node.defn.t;if(!$HASH.isEmpty(gsi.thresholds)){basicThresholds=$ARR.filter(metrics,function(metric){if(Object.keys(gsi.thresholds).indexOf(metric.did)>-1){model.metricId=metric.did;return !model.isAdvanced(metric.did);}});}if(basicThresholds.length===0){if(attrs.length>0){heatmapHelper.colorBy.push(attrs[attrs.length-1]);}if(metrics.length>0){heatmapHelper.sizeByMetric=metrics[0];}}else{heatmapHelper.colorBy.push(basicThresholds[0]);heatmapHelper.sizeByMetric=metrics.length===1?metrics[0]:(metrics[0].did===basicThresholds[0].did?metrics[1]:metrics[0]);}for(i=1;i<metrics.length;i++){if((heatmapHelper.sizeByMetric&&metrics[i].did!==heatmapHelper.sizeByMetric.did)&&(heatmapHelper.colorBy[0]&&metrics[i].did!==heatmapHelper.colorBy[0].did)){heatmapHelper.tooltipMetrics.push(metrics[i]);}}return combineDropZoneActions.call(this,node,heatmapHelper,actions,templateActions,thresholdActions);}function addRemainingMetrics(gsi,heatmapHelper){var i,len,metrics=gsi.mx,m;if(metrics.length>0){for(i=0,len=metrics.length;i<len;i++){m=metrics[i];if(heatmapHelper.colorBy.length===0){heatmapHelper.colorBy.push(m);}else{if(!heatmapHelper.sizeByMetric){if(m.t===$DSSOBJ_TYPES.DssTypeMetric){heatmapHelper.sizeByMetric=m;}}else{if((m.did!==heatmapHelper.sizeByMetric.did)&&(m.did!==heatmapHelper.colorBy[0].did)&&m.t===$DSSOBJ_TYPES.DssTypeMetric){heatmapHelper.tooltipMetrics.push(m);}}}}}}function handleGroupingObjects(order,graphMatrixHelper,heatmapHelper,isPie){$ARR.forEach(order,function(key){$ARR.forEach(graphMatrixHelper[key],function(obj){if(!isMetricsUnit(obj)){heatmapHelper.groupingObjects.push(obj);}else{if(!heatmapHelper.sizeByMetric&&!isPie){heatmapHelper.sizeByMetric=obj;}else{heatmapHelper.tooltipMetrics.push(obj);}}});});}function duplicateLastGrpToColorby(heatmapHelper){var groupingLen=heatmapHelper.groupingObjects.length;if(heatmapHelper.colorBy.length===0&&groupingLen>0){heatmapHelper.colorBy.push(heatmapHelper.groupingObjects[groupingLen-1]);}}function transitionNetworkToHeatMap(actions,node,thresholdActions){var templateActions=[],heatmapHelper=new $VIZ.HeatMapVisualizationHelper({node:node}),networkHelper=new $VIZ.NetworkVisualizationHelper({node:node});networkHelper.setData(node.data.dz);var groupingObjects=heatmapHelper.groupingObjects;if(networkHelper.fromItemAttribute){groupingObjects.push(networkHelper.fromItemAttribute);}if(networkHelper.toItemAttribute){groupingObjects.push(networkHelper.toItemAttribute);}var networkEdgeColor=networkHelper.edgeColorMetric;if(networkEdgeColor){heatmapHelper.colorBy.push(networkEdgeColor);}else{duplicateLastGrpToColorby(heatmapHelper);}if(networkHelper.edgeSizeMetric){heatmapHelper.sizeByMetric=networkHelper.edgeSizeMetric;}else{if(networkHelper.nodeSizeMetric){heatmapHelper.sizeByMetric=networkHelper.nodeSizeMetric;}}return combineDropZoneActions.call(this,node,heatmapHelper,actions,templateActions,thresholdActions);}function transitionPieChartToHeatMap(actions,node,thresholdActions){var templateActions=[],heatmapHelper=new $VIZ.HeatMapVisualizationHelper({node:node}),graphMatrixHelper=new $VIZ.GraphMatrixHelper({node:node}),gsi=getTemplateInfo(node);gsi.mx=this.filterGMTrainingMetric(node.data.dz,gsi.mx);graphMatrixHelper.setData(node.data.dz);var order=["columnObjects","rowObjects","yAxisObjects","xAxisObjects","breakByObjects","sliceObjects"];handleGroupingObjects(order,graphMatrixHelper,heatmapHelper,true);heatmapHelper.colorBy=graphMatrixHelper.colorByObjects;duplicateLastGrpToColorby(heatmapHelper);heatmapHelper.sizeByMetric=graphMatrixHelper.angleObjects[0];if(!heatmapHelper.sizeByMetric){heatmapHelper.sizeByMetric=graphMatrixHelper.sizeByObjects[0];}else{if(graphMatrixHelper.sizeByObjects[0]){heatmapHelper.tooltipMetrics.push(graphMatrixHelper.sizeByObjects[0]);}}var arr_keys=[];$ARR.forEach(heatmapHelper.tooltipMetrics,function(unit){arr_keys.push(unit.did);});$ARR.forEach(graphMatrixHelper.tooltipMetrics,function(obj){if(isMetricsUnit(obj)){if(!heatmapHelper.sizeByMetric){heatmapHelper.sizeByMetric=obj;}else{if(arr_keys.indexOf(obj.did)===-1){heatmapHelper.tooltipMetrics.push(obj);}}}});return combineDropZoneActions.call(this,node,heatmapHelper,actions,templateActions,thresholdActions);}function transitionGraphMatrixToHeatMap(actions,node,thresholdActions,isHistogramOrBoxPlot){var templateActions=[],heatmapHelper=new $VIZ.HeatMapVisualizationHelper({node:node}),graphMatrixHelper=new $VIZ.GraphMatrixHelper({node:node}),gsi=getTemplateInfo(node);gsi.mx=this.filterGMTrainingMetric(node.data.dz,gsi.mx);graphMatrixHelper.setData(node.data.dz);var order=["columnObjects","rowObjects","yAxisObjects","xAxisObjects","breakByObjects"];handleGroupingObjects(order,graphMatrixHelper,heatmapHelper,false);heatmapHelper.colorBy=graphMatrixHelper.colorByObjects;duplicateLastGrpToColorby(heatmapHelper);if(!heatmapHelper.sizeByMetric){heatmapHelper.sizeByMetric=graphMatrixHelper.sizeByObjects[0];}else{if(graphMatrixHelper.sizeByObjects[0]){heatmapHelper.tooltipMetrics.push(graphMatrixHelper.sizeByObjects[0]);}}if(!isHistogramOrBoxPlot){var arr_keys=[];$ARR.forEach(heatmapHelper.tooltipMetrics,function(unit){arr_keys.push(unit.did);});$ARR.forEach(graphMatrixHelper.tooltipMetrics,function(obj){if(isMetricsUnit(obj)){if(!heatmapHelper.sizeByMetric){heatmapHelper.sizeByMetric=obj;}else{if(arr_keys.indexOf(obj.did)===-1){heatmapHelper.tooltipMetrics.push(obj);}}}});}return combineDropZoneActions.call(this,node,heatmapHelper,actions,templateActions,thresholdActions);}function transitionImageLayoutToHeatMap(actions,node,thresholdActions){var templateActions=[],heatmapHelper=new $VIZ.HeatMapVisualizationHelper({node:node}),imageLayoutHelper=new $VIZ.ImageLayoutHelper({node:node}),gsi=getTemplateInfo(node);imageLayoutHelper.setData(node.data.dz);if(imageLayoutHelper.geoAttribute){heatmapHelper.groupingObjects.push(imageLayoutHelper.geoAttribute);}if(imageLayoutHelper.colorByMetric){heatmapHelper.colorBy.push(imageLayoutHelper.colorByMetric);}if(imageLayoutHelper.sizeByMetric){heatmapHelper.sizeByMetric=imageLayoutHelper.sizeByMetric;}addRemainingMetrics.call(this,gsi,heatmapHelper);return combineDropZoneActions.call(this,node,heatmapHelper,actions,templateActions,thresholdActions);}function transitionMapToHeatMap(actions,vis,thresholdActions){var oldHelper,anObj,HelperCls=$VIZ.MapHelper,heatmapHelper=new $VIZ.HeatMapVisualizationHelper({node:vis.node}),templateActions=[],topLayer=vis.getTopLayerHost();oldHelper=new HelperCls({data:vis.node.data});oldHelper.setWidget(topLayer);var sizeBy=oldHelper.getSizeByUnit();heatmapHelper.sizeByMetric=sizeBy;var angleBy=oldHelper.getAngleUnit();if(angleBy){if(sizeBy){heatmapHelper.tooltipMetrics.push(angleBy);}else{heatmapHelper.sizeByMetric=angleBy;}}var colorBy=oldHelper.getColorByUnit();if(colorBy){if(isMetricsUnit(colorBy)){heatmapHelper.colorBy.push(colorBy);}else{heatmapHelper.groupingObjects.push(colorBy);}}anObj=oldHelper.getGeoUnit();if(anObj){heatmapHelper.groupingObjects.push(anObj);}var sliceBy=oldHelper.getSliceByUnits();if(sliceBy){heatmapHelper.groupingObjects=heatmapHelper.groupingObjects.concat(sliceBy);}var tooltips=oldHelper.getTooltipUnits();$ARR.forEach(tooltips,function(obj){if(isMetricsUnit(obj)){if(!heatmapHelper.sizeByMetric&&heatmapHelper.colorBy.length===0){heatmapHelper.sizeByMetric=obj;}else{heatmapHelper.tooltipMetrics.push(obj);}}else{heatmapHelper.groupingObjects.push(obj);}});duplicateLastGrpToColorby(heatmapHelper);return combineDropZoneActions.call(this,vis.node,heatmapHelper,actions,templateActions,thresholdActions);}mstrmojo.vi.viz.HeatMapVisualizationTransition=mstrmojo.declare(mstrmojo.vi.viz.VisualizationTransition,null,{scriptClass:"mstrmojo.vi.viz.HeatMapVisualizationTransition",transitionDropZones:function transitionDropZones(actions,vt){var newWidgetProp="";var vis=this.vis,data=vis.node.data,curVisName=data.visName?data.visName:$GRID,curVisId=$KNOWN_VIZ.getDefinition(curVisName).id,thresholdActions=[],colorThresholds=$UTIL.getPropertyByPath(vis,"node.data.gsi.thresholds");if(curVisId===$KNOWN_VIZ.GOOGLEMAP||curVisId===$KNOWN_VIZ.ESRIMAP||curVisId===$KNOWN_VIZ.MAPBOX){var topLayer=vis.getTopLayerHost();colorThresholds=$UTIL.getPropertyByPath(topLayer,"node.data.gsi.thresholds");}this.clearImageThreshold(colorThresholds,thresholdActions);switch(curVisId){case $KNOWN_VIZ.GRAPHMATRIX:case $KNOWN_VIZ.NEWGRAPHMATRIX:var chartInfo=vis.getChartInfo(),isPie=chartInfo&&(chartInfo.isPie||chartInfo.isRing),isHistogram=chartInfo&&chartInfo.isHistogram,isBoxPlot=chartInfo&&chartInfo.isBoxPlot;if(isPie){newWidgetProp=transitionPieChartToHeatMap.call(this,actions,vis.node,thresholdActions);}else{if(isHistogram||isBoxPlot){newWidgetProp=transitionGraphMatrixToHeatMap.call(this,actions,vis.node,thresholdActions,true);}else{newWidgetProp=transitionGraphMatrixToHeatMap.call(this,actions,vis.node,thresholdActions,false);}}break;case $KNOWN_VIZ.GOOGLEMAP:case $KNOWN_VIZ.ESRIMAP:case $KNOWN_VIZ.MAPBOX:newWidgetProp=transitionMapToHeatMap.call(this,actions,vis,thresholdActions);break;case $KNOWN_VIZ.IMAGELAYOUT:newWidgetProp=transitionImageLayoutToHeatMap.call(this,actions,vis.node,thresholdActions);break;case $KNOWN_VIZ.NETWORK:newWidgetProp=transitionNetworkToHeatMap.call(this,actions,vis.node,thresholdActions);break;case $KNOWN_VIZ.HEATMAP:break;default:newWidgetProp=transitionGridToHeatMap.call(this,actions,vis.node,thresholdActions);break;}return{wp:newWidgetProp,handled:false};}});}());