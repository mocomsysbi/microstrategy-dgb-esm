(function(){mstrmojo.requiresCls("mstrmojo.ME.TokenInputBox","mstrmojo.mstr.EnumDSSXMLObjectTypes","mstrmojo.array","mstrmojo.css","mstrmojo.desc","mstrmojo.tooltip","mstrmojo.dom","mstrmojo.string","mstrmojo.range");var $OBJ_TYPE=mstrmojo.mstr.EnumDSSXMLObjectTypes,$ARR=mstrmojo.array,$CSS=mstrmojo.css,$DESC=mstrmojo.desc,$DOM=mstrmojo.dom,$STR=mstrmojo.string,_R=mstrmojo.range;var PREFIX_TOKEN='ApplySimple("',POSTFIX_TOEKN='")',DROP_AREA="dragIn",CSS_ERR="err",CSS_TOKEN="mstrmojo-token",ENUM_CARET_POS={BEFORE_PREFIX:1,AT_PREFIX:2,AT_POSTFIX:3,AFTER_POSTFIX:4,OTHER:99},DROP_CUE_OFFSET={x:0,y:9};mstrmojo.requiresDescs(15834);mstrmojo.vi.ui.editors.cm.CalculatedMemberExpressionInputBox=mstrmojo.declare(mstrmojo.ME.TokenInputBox,null,{scriptClass:"mstrmojo.vi.ui.editors.cm.CalculatedMemberExpressionInputBox",cssClass:"mstrmojo-CalculatedMemberExpressionInputBox",expValid:false,tooltipOpenDelay:100,useRichTooltip:true,renderOnScroll:false,renderBlockSize:0,postBuildRendering:function postBuildRendering(){this._super();this.onexpValidChange();},updateTooltipConfig:function updateTooltipConfig(){if(this.expValid){delete this.richTooltip;}else{var position=$DOM.position(this.domNode);if(position.x||position.y||position.w||position.h){this.richTooltip={cssClass:"vi-regular vi-tooltip-V",posType:mstrmojo.tooltip.POS_BOTTOMLEFT,content:$STR.encodeHtmlString($DESC(15834,"MDX pass-through expression should not contain '', //, --, /*, */ or be empty.")),top:position.y,left:position.x};}}},startTokenSuggestion:mstrmojo.emptyFn,resetDisplay:function resetDisplay(ptoExp){ptoExp=ptoExp||"";var reg=/-|\+|\*|\/|\(|\)/,idx=ptoExp.search(reg),t,tokens=[];while(idx>=0){if(idx>0){t=ptoExp.substring(0,idx);tokens.push({v:t,isNew:true});}t=ptoExp.substr(idx,1);tokens.push({v:t,isNew:true});ptoExp=ptoExp.substr(idx+1);idx=ptoExp.search(reg);}if(ptoExp.length>0){tokens.push({v:ptoExp,isNew:true});}if(tokens.length>0){this.resetTokens(tokens);}else{this.resetTokens(null);}},createToken:function createToken(item){return{v:item.v.split(":")[1],isNew:true,isDelimiter:true};},resetTokens:function resetTokens(tokens){var fullTokens=[{v:PREFIX_TOKEN,isNew:true,isDelimiter:true,oi:{t:$OBJ_TYPE.Function}}];if(tokens){fullTokens=fullTokens.concat(tokens);}fullTokens.push({v:POSTFIX_TOEKN,isNew:true,isDelimiter:true,oi:{t:$OBJ_TYPE.Function}});this.clearTokens();this.insertTokens(fullTokens);var editNode=this.editNode,itemWrap=this.listMapper.findWrapper(editNode,this.items.length-2);this._delaySetTextCaretPos(itemWrap,itemWrap.innerText.length);},getExpression:function getExpression(){var items=this.items,n=items.length;if(n>=2&&items[0].v===PREFIX_TOKEN&&items[n-1].v===POSTFIX_TOEKN){return $ARR.map(items.slice(1,n-1),function(item){return item.v;}).join("");}},isExpressionValid:function isExpressionValid(){var exp=this.getExpression(),regExp=/(\'|\/\/|\-\-|\/\*|\*\/)/;return exp&&exp.trim()&&!regExp.test(exp);},insertTokens:function insertTokens(tokens){var ret=this._super(tokens);this.set("expValid",this.isExpressionValid());return ret;},getCaretPosition:function getCaretPosition(container,offset){var pos=ENUM_CARET_POS.OTHER,prefixNode,postfixNode,preLen;try{container=$DOM.findAncestorByName(container,"span",true,this.domNode);if(container){prefixNode=this.editNode.firstElementChild.firstElementChild;postfixNode=this.editNode.lastElementChild.firstElementChild;preLen=PREFIX_TOKEN.length;if(container===prefixNode&&offset<preLen){pos=ENUM_CARET_POS.BEFORE_PREFIX;}else{if(container===prefixNode&&offset===preLen||container.parentElement.previousElementSibling.firstElementChild===prefixNode&&offset===0){pos=ENUM_CARET_POS.AT_PREFIX;}else{if(container===postfixNode&&offset>0){pos=ENUM_CARET_POS.AFTER_POSTFIX;}else{if(container===postfixNode&&offset===0||container.parentElement.nextElementSibling.firstElementChild===postfixNode&&offset===container.textContent.length){pos=ENUM_CARET_POS.AT_POSTFIX;}}}}}}catch(e){}return pos;},on_saveRangeInfoChange:function on_saveRangeInfoChange(){var rangeInfo=this._saveRangeInfo;if(rangeInfo){var sPos=this.getCaretPosition(rangeInfo.startContainer,rangeInfo.startOffset),ePos=this.getCaretPosition(rangeInfo.endContainer,rangeInfo.endOffset);if(sPos===ENUM_CARET_POS.BEFORE_PREFIX||ePos===ENUM_CARET_POS.BEFORE_PREFIX){var prefixNode=this.editNode.firstElementChild.firstElementChild;this._delaySetTextCaretPos(prefixNode,PREFIX_TOKEN.length);}else{if(sPos===ENUM_CARET_POS.AFTER_POSTFIX||ePos===ENUM_CARET_POS.AFTER_POSTFIX){var postfixNode=this.editNode.lastElementChild.firstElementChild,preToken=postfixNode.parentElement.previousElementSibling.firstElementChild;this._delaySetTextCaretPos(preToken,preToken.textContent.length);}}}},isSelectionOutOfRange:function isSelectionOutOfRange(){var rangeInfo=this._saveRangeInfo;if(rangeInfo){var sPos=this.getCaretPosition(rangeInfo.startContainer,rangeInfo.startOffset),ePos=this.getCaretPosition(rangeInfo.endContainer,rangeInfo.endOffset);return sPos===ENUM_CARET_POS.AFTER_POSTFIX||sPos===ENUM_CARET_POS.BEFORE_PREFIX||ePos===ENUM_CARET_POS.AFTER_POSTFIX||ePos===ENUM_CARET_POS.BEFORE_PREFIX;}},processDeleteKeyDown:function processDeleteKeyDown(rInfo){var rangeInfo=this._saveRangeInfo;if(this.isSelectionOutOfRange()){return true;}if(rangeInfo&&rangeInfo.collapsed){var caretPos=this.getCaretPosition(rangeInfo.startContainer,rangeInfo.startOffset);if(caretPos===ENUM_CARET_POS.AT_POSTFIX||caretPos===ENUM_CARET_POS.AT_PREFIX&&this.items.length===2){return true;}}return this._super(rInfo);},processBackspaceKeyDown:function processBackspaceKeyDown(rInfo){var rangeInfo=this._saveRangeInfo;if(this.isSelectionOutOfRange()){return true;}if(rangeInfo&&rangeInfo.collapsed&&this.getCaretPosition(rangeInfo.startContainer,rangeInfo.startOffset)===ENUM_CARET_POS.AT_PREFIX){return true;}else{return this._super(rInfo);}},handlekeypress:function handlekeypress(e){var ret=this._super(e);this.set("expValid",this.isExpressionValid());return ret;},handlekeydown:function handlekeydown(e){this.set("_saveRangeInfo",_R.getRangeInfo());var ret=this._super(e);this.set("expValid",this.isExpressionValid());return ret;},onexpValidChange:function onexpValidChange(){$CSS.toggleClass(this.domNode,CSS_ERR,!this.expValid);if(this.expValid){this.hideTooltip();}else{if(document.activeElement===this.editNode){this.showTooltip();}}},ondropCuePosChange:function ondropCuePosChange(evt){var pos=evt.value,dragdata=this.dragdata;if(dragdata&&dragdata.setAvatarClass){dragdata.setAvatarClass(pos?"add":"");}var idx=Math.min(pos&&pos.idx||1,this.items.length-1),_saveRangeInfo=this._saveRangeInfo,startContainer=_saveRangeInfo&&_saveRangeInfo.startContainer,startOffset=_saveRangeInfo&&_saveRangeInfo.startOffset;startContainer=this.listMapper.findWrapper(this.editNode,idx-1);startOffset=startContainer.innerText.length;if(startContainer&&typeof startOffset==="number"){if(this.listMapper.findIndex(this,this.editNode,startContainer)!==-1){if($DOM.isSafari||mstrApp.isWorkstation&&$DOM.isMac()){var tokenNode;if(!startContainer.classList.contains(CSS_TOKEN)){var nodes=startContainer.getElementsByClassName(CSS_TOKEN);if(nodes.length>0){tokenNode=nodes[0];}}else{tokenNode=startContainer;}var r={collapsed:true,startContainer:tokenNode,startOffset:startOffset};this.set("_saveRangeInfo",r);}else{this._delaySetTextCaretPos(startContainer,startOffset);}if(pos!==null&&idx!==(pos&&pos.idx)){var targetNode=this.listMapper.findWrapper(this.editNode,idx),firsetNode=this.listMapper.findWrapper(this.editNode,0);if(targetNode&&firsetNode){this.set("dropCuePos",{idx:idx,idxActual:idx,top:targetNode.offsetTop-firsetNode.offsetTop+DROP_CUE_OFFSET.y,left:targetNode.offsetLeft-firsetNode.offsetLeft+DROP_CUE_OFFSET.x});}}}}},ondragenter:function ondragenter(context){if(this.isDraggingItem(context)){$CSS.addClass(this.domNode,DROP_AREA);this._super(context);var prefixNode=this.listMapper.findWrapper(this.editNode,0),rect=prefixNode&&prefixNode.getBoundingClientRect();if(rect){this.set("dropCuePos",{left:rect.width+DROP_CUE_OFFSET.x,top:DROP_CUE_OFFSET.y});}}},ondragleave:function ondragleave(context){if(this.isDraggingItem(context)){$CSS.removeClass(this.domNode,DROP_AREA);this._super(context);}},ondrop:function ondrop(context){if(this.isDraggingItem(context)){$CSS.removeClass(this.domNode,DROP_AREA);var idx=this._super(context),startContainer=this.listMapper.findWrapper(this.editNode,idx),startOffset=startContainer.innerText.length;this._delaySetTextCaretPos(startContainer,startOffset);}},isDraggingItem:function isDraggingItem(context){return context.src&&context.src.node&&context.src.node.className.indexOf("item")>=0;}});}());