(function(){mstrmojo.requiresCls("mstrmojo.vi.ui.InteractiveUnitList","mstrmojo.array","mstrmojo.hash","mstrmojo.string","mstrmojo.vi.ui._IsDropTarget","mstrmojo.vi.models.EnumDragSources","mstrmojo.ui.menus.MenuConfig","mstrmojo.vi.controllers.EnumPanelManipulationType","mstrmojo.vi.controllers.EnumLayoutManipulationType","mstrmojo.vi.controllers.EnumEvents","mstrmojo.vi.ui.DatasetUnitMenuUtils");mstrmojo.requiresDescs(221,629,1388,3397,14919,14920,14921,14923,14924,15023,15024);var $ARR=mstrmojo.array,$CSS=mstrmojo.css,$DOM=mstrmojo.dom,$HASH=mstrmojo.hash,$STR=mstrmojo.string,$DU=mstrmojo.vi.ui.DatasetUnitMenuUtils,ICON_SIZE=18,ICON_TEXT_PADDING=5,PADDING_LEFT=10,LEVEL_DIFF=13,DELEMITER="\u001E",PANEL_MANIPULATION_TYPE=mstrmojo.vi.controllers.EnumPanelManipulationType,LAYOUT_MANIPULATION_TYPE=mstrmojo.vi.controllers.EnumLayoutManipulationType,ENUM_DRAG_SOURCES=mstrmojo.vi.models.EnumDragSources,EVENTS=mstrmojo.vi.controllers.EnumEvents;function reloadItems(){this.set("items",(this.getAllItems()||[]).map(function(item){return $HASH.copy(item);}));}function isOnTopHalf(context){var tgtNode=context.tgt.node,tgtItemNodeObj=$DOM.findAncestorByAttr(tgtNode,"idx",true,this.domNode),tgtItemNode=tgtItemNodeObj&&tgtItemNodeObj.node,tgtIdx=parseInt(tgtItemNodeObj&&tgtItemNodeObj.value,10);var posY=context.last&&context.last.y,targetRect=tgtItemNode.getBoundingClientRect(),top=targetRect&&targetRect.top,bottom=targetRect&&targetRect.bottom;return(bottom-posY)>(posY-top);}function allowManipulation(){return !(mstrApp.isAppStatePresentation()||mstrApp.isAppStateSelection())&&mstrApp.allowWebDashboardDesign();}mstrmojo.vi.ui.TableOfContentsUnitList=mstrmojo.declare(mstrmojo.vi.ui.InteractiveUnitList,[mstrmojo.vi.ui._IsDropTarget],{scriptClass:"mstrmojo.vi.ui.TableOfContentsUnitList",chapter:null,level:null,multiSelect:true,useListModKeys:true,avatarCssClass:"tableOfContentUnitList",encodeUnitAvatar:true,init:function init(props){this._super(props);reloadItems.call(this);},getItemMarkup:function getItemMarkup(item){return this._super(item).replace('<span class="txt" unselectable="on">{@en@n}</span>','<div class="icon" style="{@iconLeft}"></div><span class="txt {@midTruncateCssClass}" unselectable="on"">{@en@n}</span>').replace("{@midTruncateCssClass}",this.midTruncateCssClass);},getItemProps:function getItemProps(item,idx){var props=this._super(item,idx);if(item.mnu){props.addCls(mstrmojo.vi.ui.InteractiveUnitList.CLS_HAS_MENU);}props.dsc=item.dsc;if(this.level!==null){var padding=PADDING_LEFT+this.level*LEVEL_DIFF;props.addStyle("padding-left: "+(padding+ICON_SIZE+ICON_TEXT_PADDING)+"px;");props.iconLeft=$STR.encodeHtmlString("left:"+padding+"px;");}return props;},getItemTooltip:function(item,itemNode,target){var labelNode=this.getLabelNode(itemNode);if(this.hasTooltipContent(item,itemNode)){var position=$DOM.position(labelNode),content="<div>"+$STR.encodeHtmlString(item.n)+"</div>"+(item.dsc?"<div>"+$STR.encodeHtmlString(item.dsc)+"</div>":"");return{areaId:item._renderIdx+"text",cssClass:"vi-regular vi-tooltip-V",contentNodeCssClass:"regular-unitlist-tooltips",posType:mstrmojo.tooltip.POS_BOTTOMLEFT,content:content,top:position.y-6,left:position.x,enableHover:true};}return null;},onchapterChange:reloadItems,getAllItems:function getAllItems(){return this.chapter&&this.chapter.panels;},reloadItems:reloadItems,addMenuProp:false,lastDragOverInfo:null,twoClicksItem:function twoClicksItem(item,evt){if(!allowManipulation()){return ;}var tocPanel=mstrmojo.all[this.panelId],modelId=tocPanel.model.id,chapterKey=this.chapter.k,panelStackKey=this.chapter.panelStackKey,pageKey=item.k,oldTitle=item.n;var itemLabelNode=this.getLabelNode(this.getItemNodeFromTarget(evt.getTarget()));$DU.renameItem(itemLabelNode,item,function(renameWidget){mstrmojo.all[modelId].raiseEvent({name:EVENTS.MANIPULATE_PANEL,type:PANEL_MANIPULATION_TYPE.RENAME,panelKey:pageKey,panelStackKey:panelStackKey,layoutKey:chapterKey,newTitle:renameWidget.text,oldTitle:oldTitle});},{allowEmptyText:false,cssClass:itemLabelNode.className});},doItemSelect:function doItemSelect(item,evt){var hWin=evt&&evt.hWin,e=evt&&evt.e,isTargeting=(mstrApp.isAppStateSelection()),tocPanel=mstrmojo.all[this.panelId],isMetaKey=$DOM.isMetaKey(hWin,e),shiftKey=$DOM.shiftKey(hWin,e),oldItems=tocPanel.getPanelSelectedItems(),newChapterKey=this.chapter.k,pageKey=item.k,crossList=oldItems.some(function(item){return item.ulist!==this;},this);if(crossList){if(shiftKey){if(!this.getSelectedItems().length){return ;}}else{if(isMetaKey){return ;}else{var hash={};$ARR.forEach(oldItems,function(item){var chapterKey=item.ulist.chapter.k;if(!hash[chapterKey]){hash[chapterKey]=true;tocPanel.getChapterPanel(chapterKey).clearSelect();}});}}}if(!shiftKey&&!isMetaKey){tocPanel.model.raiseEvent({name:isTargeting?"targetLayoutSelected":"layoutSelected",layoutKey:newChapterKey,panelKey:pageKey});}if(!isTargeting){tocPanel.clearChapterSelect();this._super(item,evt);}},isDragValid:function isDragValid(context){return allowManipulation()&&this._super(context);},oncontextmenu:function oncontextmenu(evt){if(!allowManipulation()){mstrmojo.dom.preventDefault(window,evt.e);return false;}return this._super(evt);},showMultiSelectionMenu:function showMultiSelectionMenu(items,el,position){var dataSelected={};$ARR.forEach(items,function(item){var layoutKey=item.layoutKey;if(!dataSelected[layoutKey]){dataSelected[layoutKey]={layoutKey:layoutKey,layoutName:item.ulist.chapter.title,panelKeys:[item.k],panelNames:[item.n],panelStackKey:item.pnk,panelCntInLayout:item.ulist.items.length,allPanelsSelected:false};}else{dataSelected[layoutKey].panelKeys.push(item.k);dataSelected[layoutKey].panelNames.push(item.n);}});$HASH.forEach(dataSelected,function(item){item.allPanelsSelected=(item.panelCntInLayout===item.panelKeys.length);});dataSelected=$HASH.valarray(dataSelected);var tocPanel=mstrmojo.all[this.panelId],model=tocPanel.model,modelId=model.id;var menuCfg=new mstrmojo.ui.menus.MenuConfig({position:position,isHostedWithin:false});if(dataSelected.length===1&&dataSelected[0].allPanelsSelected&&tocPanel.chapterCount>1){menuCfg.addMenuItem(mstrmojo.desc(15023,'Delete Chapter "##"').replace("##",dataSelected[0].layoutName),"",function(){mstrmojo.warn(mstrmojo.desc(14921,"Deleting a chapter will delete all the pages in this chapter. Do you want to continue?"),{confirmBtn:{t:mstrmojo.desc(629,"Delete"),fn:function(){mstrmojo.all[modelId].raiseEvent({name:EVENTS.MANIPULATE_LAYOUT,type:LAYOUT_MANIPULATION_TYPE.DELETE,layoutKey:dataSelected[0].layoutKey});},hot:false},cancelBtn:{t:mstrmojo.desc(221,"Cancel")}});});}else{if(dataSelected.length===1&&!dataSelected[0].allPanelsSelected){menuCfg.addMenuItem(mstrmojo.desc(15024,"Delete ## Pages").replace("##",items.length),"",function(){mstrmojo.all[modelId].raiseEvent({name:EVENTS.MANIPULATE_PANEL,type:PANEL_MANIPULATION_TYPE.DELETE,panelKeys:dataSelected[0].panelKeys,layoutKey:dataSelected[0].layoutKey});});}}if(menuCfg.hasMenuItems()){this.openPopup(menuCfg.newInstance());}},showItemMenu:function showItemMenu(item,el,position){this.doItemSelect(item,{});var menuCfg=new mstrmojo.ui.menus.MenuConfig({position:position,isHostedWithin:false}),tocPanel=mstrmojo.all[this.panelId],chapterKey=this.chapter.k,chapterTitle=this.chapter.title,panelStackKey=this.chapter.panelStackKey,pageKey=item.k,model=tocPanel.model,modelId=model.id;var panelCnt=this.items.length,chapterCnt=tocPanel.chapterCount,currentIdx=item._renderIdx,lblTitle=this.title;menuCfg.addMenuItem(mstrmojo.desc(14919,"Insert Page"),"",function(){mstrmojo.all[modelId].raiseEvent({name:EVENTS.MANIPULATE_PANEL,type:PANEL_MANIPULATION_TYPE.NEW,panelKey:pageKey,panelStackKey:panelStackKey,layoutKey:chapterKey});});menuCfg.addMenuItem(mstrmojo.desc(14923,"Duplicate Page"),"dup",function(){mstrmojo.all[modelId].raiseEvent({name:EVENTS.MANIPULATE_PANEL,type:PANEL_MANIPULATION_TYPE.DUPLICATE,panelKey:pageKey,panelStackKey:panelStackKey,layoutKey:chapterKey});});var itemLabelNode=this.getLabelNode(this.getItemNodeFromTarget(el));menuCfg.addMenuItem(mstrmojo.desc(1388,"Rename"),"rnm",function(){$DU.renameItem(itemLabelNode,item,function(renameWidget){mstrmojo.all[modelId].raiseEvent({name:EVENTS.MANIPULATE_PANEL,type:PANEL_MANIPULATION_TYPE.RENAME,panelKey:pageKey,panelStackKey:panelStackKey,layoutKey:chapterKey,newTitle:renameWidget.text,oldTitle:item.n});},{allowEmptyText:false,cssClass:itemLabelNode.className});});if(panelCnt>1){menuCfg.addMenuItem(mstrmojo.desc(629,"Delete"),"cls",function(){mstrmojo.all[modelId].raiseEvent({name:EVENTS.MANIPULATE_PANEL,type:PANEL_MANIPULATION_TYPE.DELETE,panelKey:[pageKey],panelKeys:[pageKey],panelStackKey:panelStackKey,layoutKey:chapterKey});});}else{if(panelCnt===1&&chapterCnt>1){menuCfg.addMenuItem(mstrmojo.desc(15023,'Delete Chapter "##"').replace("##",chapterTitle),"cls",function(){mstrmojo.warn(mstrmojo.desc(14921,"Deleting a chapter will delete all the pages in this chapter. Do you want to continue?"),{confirmBtn:{t:mstrmojo.desc(629,"Delete"),fn:function(){mstrmojo.all[modelId].raiseEvent({name:EVENTS.MANIPULATE_LAYOUT,type:LAYOUT_MANIPULATION_TYPE.DELETE,layoutKey:chapterKey});},hot:false},cancelBtn:{t:mstrmojo.desc(221,"Cancel")}});});}}this.openPopup(menuCfg.newInstance());},allowDrop:function allowDrop(context){var dragData=context.getCtxtDragData(),dragSource=dragData.src;if(dragSource===ENUM_DRAG_SOURCES.TOC_PAGES_LIST&&dragData.chapterKey===this.chapter.k){return true;}else{if(dragSource===ENUM_DRAG_SOURCES.TOC_PAGES_LIST&&dragData.chapterKey!==this.chapter.k&&dragData.items.length===1){return true;}}var tocPanel=mstrmojo.all[this.panelId],portlet=tocPanel.getChapterPanel(this.chapter.k),dndIndicator=portlet.pageDnDIndicatorNode;dndIndicator.style.display="none";return false;},getDragData:function getDragData(context){this.selectDragNode(context);var avatarClass=this.avatarCssClass,me=this,dragData=this._super(context);dragData.src=ENUM_DRAG_SOURCES.TOC_PAGES_LIST;dragData.chapterKey=this.chapter&&this.chapter.k;dragData.panelStackKey=this.chapter&&this.chapter.panelStackKey;dragData.isAllPageSelected=(this.chapter&&this.chapter.panels.length)===dragData.items.length;dragData.setAvatarClass=function setAvatarClass(cls){var avatar=me.avatar;if(avatar){var classes=["mstrmojo-VIUnitList",avatarClass,"hasOwnAvatar",mstrApp.getThemeClassName(),cls||""];avatar.className=classes.join(" ");}};return dragData;},ondrop:function ondrop(context){var dragData=context.getCtxtDragData&&context.getCtxtDragData(),tocPanel=mstrmojo.all[this.panelId],portlet=tocPanel.getChapterPanel(this.chapter.k),dndIndicator=portlet.pageDnDIndicatorNode,chapterKey=this.chapter.k,panelStackKey=this.chapter.panelStackKey,panelCount=this.chapter.panels.length,model=tocPanel.model,tgtIdx=this.lastDragOverInfo&&this.lastDragOverInfo.targetIdx,dropOnTopHalf=this.lastDragOverInfo&&this.lastDragOverInfo.onTopHalf;dndIndicator.style.display="none";if(!(dragData.item&&dragData.items.length>0&&this.lastDragOverInfo)){return ;}var panelKeys=[],fromIdxs=[];$ARR.forEach(dragData.items,function(item){panelKeys.push(item.k);fromIdxs.push(item._renderIdx);});if(dragData.chapterKey===chapterKey){var from=fromIdxs[0],to=tgtIdx,movingForward=from>tgtIdx,movingBackward=from<tgtIdx;if(dropOnTopHalf&&movingBackward){to=tgtIdx-1;}else{if(!dropOnTopHalf&&movingForward){to=tgtIdx+1;}}var toIdxs=[to];for(var i=1;i<fromIdxs.length;i++){for(var j=i;j<fromIdxs.length;j++){if(from<fromIdxs[j]&&fromIdxs[j]<=to){fromIdxs[j]--;}else{if(to<=fromIdxs[j]&&fromIdxs[j]<from){fromIdxs[j]++;}}}from=fromIdxs[i];if(from>to){to=Math.min(to+1,panelCount-1);}toIdxs.push(to);}model.raiseEvent({name:EVENTS.MANIPULATE_PANEL,type:PANEL_MANIPULATION_TYPE.MOVE,panelKeys:panelKeys,panelStackKey:panelStackKey,layoutKey:chapterKey,fromIdx:fromIdxs,toIdx:toIdxs});}else{var movePage=function(){model.raiseEvent({name:EVENTS.MANIPULATE_PANEL,type:PANEL_MANIPULATION_TYPE.CROSS_CHAPTER_MOVE,panelKeys:panelKeys,srcPanelStackKey:dragData.panelStackKey,srcLayoutKey:dragData.chapterKey,tgtPanelStackKey:panelStackKey,tgtLayoutKey:chapterKey,toIdx:dropOnTopHalf?tgtIdx:tgtIdx+1,isAllPageSelected:dragData.isAllPageSelected});};if(model.hasFilters(dragData.chapterKey)){mstrmojo.warn(mstrmojo.desc(15630,"Moving this page will clear the filtering applied through the Filter Panel and may cause visualizations to return a very large amount of data. Do you want to continue?"),{confirmBtn:{t:mstrmojo.desc(212,"Continue"),fn:movePage},cancelBtn:{t:"Cancel"}});}else{movePage();}}},ondragover:function ondragover(context){var tocPanel=mstrmojo.all[this.panelId],portlet=tocPanel.getChapterPanel(this.chapter.k),dndIndicator=portlet.pageDnDIndicatorNode,tgtNode=context.tgt.node,tgtItemNodeObj=$DOM.findAncestorByAttr(tgtNode,"idx",true,this.domNode),tgtItemNode=tgtItemNodeObj&&tgtItemNodeObj.node,tgtIdx=parseInt(tgtItemNodeObj&&tgtItemNodeObj.value,10);var onTopHalf=isOnTopHalf(context);var listRect=this.domNode.getBoundingClientRect(),targetRect=tgtItemNode.getBoundingClientRect(),top=targetRect&&targetRect.top,bottom=targetRect&&targetRect.bottom,offset=-15-listRect.top;this.lastDragOverInfo={onTopHalf:onTopHalf,targetIdx:tgtIdx};dndIndicator.style.display="block";if(onTopHalf){dndIndicator.style.top=(top+offset)+"px";}else{dndIndicator.style.top=(bottom+offset)+"px";}},ondragleave:function ondragleave(ctxt){var tocPanel=mstrmojo.all[this.panelId],portlet=tocPanel.getChapterPanel(this.chapter.k),dndIndicator=portlet.pageDnDIndicatorNode,targetWidget=ctxt.tgt&&ctxt.tgt.widget;if(targetWidget.id!==portlet.id){dndIndicator.style.display="none";}if(this._super){this._super(ctxt);}},positionAvatar:function positionAvatar(pos,context){context.dragOffsets={x:15,y:20};if(this._super){this._super(pos,context);}},getDropAvatarIcon:function getDropAvatarIcon(context){return"move";}});}());