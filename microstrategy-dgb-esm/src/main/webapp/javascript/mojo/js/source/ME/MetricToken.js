(function(){mstrmojo.requiresCls("mstrmojo.dom","mstrmojo.css","mstrmojo.string","mstrmojo.Widget","mstrmojo.ui.menus._HasMenuPopup","mstrmojo.mstr.EnumDSSXMLObjectTypes","mstrmojo.mstr.EnumDSSXMLObjectSubTypes","mstrmojo.ME.MetricDataService");mstrmojo.requiresDescs(3224);var DEL_LIST=["(",")","{","}","-","+","*","/","<",">","|","~",","],OTHER_SPECIALS={" ":true,"@":true},DEL_MAP=null,DOM=mstrmojo.dom,CSS=mstrmojo.css,OBJ_TYPE=mstrmojo.mstr.EnumDSSXMLObjectTypes,OBJ_SUBTYPE=mstrmojo.mstr.EnumDSSXMLObjectSubTypes,MDS=mstrmojo.ME.MetricDataService;function _isDelimiter(c){if(!DEL_MAP){DEL_MAP={};var i,len;for(i=0,len=DEL_LIST.length;i<len;i++){DEL_MAP[DEL_LIST[i]]=true;}}return DEL_MAP.hasOwnProperty(c);}function _containsSpecials(s){if(!s){return false;}var len=s.length,i,c;for(i=0;i<len;i++){c=s.charAt(i);if(c==="["){return false;}if(_isDelimiter(c)||OTHER_SPECIALS[c]){return true;}}return false;}function _brackets(s){return _containsSpecials(s)?"["+s+"]":s;}function _splitAttrAndAttrForm(s){if(!s){return null;}var len=s.length,split=s.split("["),sLen=split.length,attribute,form;if(sLen===1){return s.split("@");}else{if(sLen===3){attribute=split[1];attribute="["+attribute.substring(0,attribute.length-1);form="["+split[2];}else{if(split[0].length===0){var str=split[1],indexRB=str.indexOf("]");attribute="["+str.substring(0,indexRB+1);if(indexRB===str.length-1){return[attribute];}else{form=str.substring(indexRB+2);}}else{var str=split[0];attribute=str.substring(0,str.length-1);form="["+split[1];}}}return[attribute,form];}var QUOTABLE_DATATYPES={8:true,9:true,10:true};var _quotes=function(dtp,v){return QUOTABLE_DATATYPES[dtp]&&!/^\".*\"$/.test(v)?'"'+v+'"':v;};var _unquotes=function(tk,v,dtp){var quotable=typeof dtp==="undefined"?true:QUOTABLE_DATATYPES[dtp];if(v.length===2&&v==='""'){return v;}return tk.tp===261&&v.length>=2&&quotable?(/^\s+$/.test(v.substr(1,v.length-2))?v:v.substr(1,v.length-2)):v;};mstrmojo.ME.MetricToken=mstrmojo.declare(mstrmojo.Widget,[mstrmojo.ui.menus._HasMenuPopup],{data:null,markupString:'<span id={@id} class="mstrmojo-token {@cssClass}" mstrAttach:contextmenu></span>',active:false,markupMethods:{ondataChange:function(){var d=this.data,isEmbeddedFilter=this.isEmbeddedFilter(),txt=isEmbeddedFilter?"&nbsp;":mstrmojo.string.encodeHtmlString(String(d.v));if(d.v===","){this.domNode.innerHTML=txt+"&nbsp;";}else{if(d.tp===259&&d.v==="Desc"){this.domNode.innerHTML="&nbsp;"+txt;}else{if(MDS.isLogicOrCompFunc(d)){this.domNode.innerHTML="&nbsp;"+txt+"&nbsp;";}else{this.domNode.innerHTML=txt;}}}CSS.toggleClass(this.domNode,["mstr"],this.isMstrO());CSS.toggleClass(this.domNode,["nfn"],!this.isFunction());CSS.toggleClass(this.domNode,["invalid"],d.sta===-1);CSS.toggleClass(this.domNode,["embeddedFilter"],isEmbeddedFilter);},onactiveChange:function(){mstrmojo.css.toggleClass(this.domNode,["active"],this.active);}},oncontextmenu:function oncontextmenu(evt){this.closePopup();if(this.isEmbeddedFilter()){var menuCfg=new mstrmojo.ui.menus.MenuConfig({position:DOM.getMousePosition(evt.e,evt.hWin),isHostedWithin:false,alignWithAnchor:true});var me=this;menuCfg.addMenuItem(mstrmojo.desc(3224,"Edit..."),"",function(){var inputBox=me.parent;if(inputBox&&inputBox.editEmbeddedFilterToken){inputBox.editEmbeddedFilterToken(me);}});this.openPopup(menuCfg.newInstance());}},isMstrO:function isMstrO(){return !!this.data.oi||!!this.data.rfd;},isFunction:function isFunction(){return this.isMstrO()&&(this.data.oi&&this.data.oi.t===OBJ_TYPE.Function);},isEmbeddedFilter:function isEmbeddedFilter(){var oi=this.data.oi,oiType=oi&&oi.t,oiSubType=oi&&oi.st;return this.isMstrO()&&oiType===OBJ_TYPE.Filter&&oiSubType===OBJ_SUBTYPE.Filter&&oi.isEmbedded;},brackets:_brackets,length:function length(){return this.isEmbeddedFilter()?1:this.data.v.toString().length;},isDelimiter:function isDelimiter(){return this.data.isDelimiter||(this.length()===1&&_isDelimiter(this.data.v));},split2Tokens:function split2Tokens(offset){var d=this.data,s=d&&d.v.toString(),sb=s.substring(0,offset),sa=s.substring(offset);return[{v:sb,isNew:true},{v:sa,isNew:true}];},mergeTo:function mergeTo(w){var d=this.data,s=d&&d.v.toString(),ws=w.data.v.toString();return{v:s+ws,isNew:true};},brackets:_brackets,setItemInfo:function setItemInfo(it){var d=this.data;d.v=this.brackets(it.n);d.oi=it;d.sta=1;d.isNew=true;this.set("data",d);this.paint();},spliceContent:function spliceContent(offset,length,istChar){var d=this.data,s=d&&d.v.toString(),sb=s.substring(0,offset);length=(length===null||length===undefined)?(s.length-offset):length;var sa=s.substring(offset+length),ns=sb+(istChar||"")+sa;d.v=ns;d.isNew=true;d.sta=1;d.ift=(this.isAttributeToken()||d.at)&&(d.v.indexOf("@")>=0);if(d.ift){d.at=d.oi||d.at;}else{delete d.at;}delete d.oi;delete d.exv;delete d.extp;delete d.tp;this.set("data",d);this.paint();},isAttributeToken:function isAttributeToken(){return this.data&&this.data.oi&&this.data.oi.t===OBJ_TYPE.Attribute;},setFormInfo:function setFormInfo(it){var d=this.data,attr=d.oi||d.at;d.v=this.brackets(attr.n)+"@"+this.brackets(it.n);d.exv=it.did;d.extp=8;d.sta=1;d.isNew=true;d.oi=d.at;delete d.at;this.set("data",d);this.paint();}});mstrmojo.ME.MetricToken.isDelimiter=_isDelimiter;mstrmojo.ME.MetricToken.brackets=_brackets;mstrmojo.ME.MetricToken.splitAttrAndAttrForm=_splitAttrAndAttrForm;mstrmojo.ME.MetricToken.quotes=_quotes;mstrmojo.ME.MetricToken.unquotes=_unquotes;mstrmojo.ME.MetricToken.QUOTABLE_DATATYPES=QUOTABLE_DATATYPES;mstrmojo.ME.MetricToken.argDelimiter={".":",",",":";"}[mstrConfig&&mstrConfig.decimalSep]||",";})();