(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.hash","mstrmojo.func","mstrmojo.VisUtility","mstrmojo.kpicard.KPICardEnum","mstrmojo.mstr.EnumDSSXMLObjectTypes","mstrmojo.vi.viz.EnumDSSDropZones","mstrmojo.vi.models.DropZonesModel","mstrmojo.vi.models._DropZoneCommon","mstrmojo.vi.ui.DatasetUnitMenuUtils","mstrmojo.vi.util.ThresholdUtils","mstrmojo.models.datasets.DataInterface");var $MOJO=mstrmojo,$ARR=$MOJO.array,$HASH=$MOJO.hash,$FUNC=mstrmojo.func,$KPI_PROPERTIES=mstrmojo.kpicard.KPI_PROPERTIES,$DISPLAY_MODE=mstrmojo.kpicard.DISPLAY_MODE,$EDZ=$MOJO.vi.viz.EnumDSSDropZones,$DU=mstrmojo.vi.ui.DatasetUnitMenuUtils,$VISUTIL=mstrmojo.VisUtility,$OBJ_TYPES=$MOJO.mstr.EnumDSSXMLObjectTypes,$TARGET_POS=$MOJO.vi.models.DropZonesModel.ENUM_TARGET_POSITION,$FEATURES=mstrmojo.vi.enums.EnumFeatures,DZ_BREAKBY=$EDZ.BreakBy,DZ_TREND=$EDZ.Trend,DZ_METRIC=$EDZ.Metric,$CARDLIMIT=mstrmojo.kpicard.CARDLIMIT,$DATASET_INTERFACE=mstrmojo.models.datasets.DataInterface,ROWS=1,METRICS=-1;mstrmojo.vi.models.KPICardDropZones=mstrmojo.declare(mstrmojo.vi.models.DropZonesModel,[mstrmojo.vi.models._DropZoneCommon],{scriptClass:"mstrmojo.vi.models.KPICardDropZones",help:"editor_panel_kpi.htm",propertyChanged:false,getHostModel:function getHostModel(){return this.getHost().model.data;},getDropZones:function getDropZones(){var dzf=this.getDZFlatStruct(),singleUnit=function(title){return{allowSingle:true,title:title};},zones=[this.getZone(mstrmojo.desc(517,"Metric"),DZ_METRIC,dzf.metric,false,singleUnit(mstrmojo.desc(13829,"Drag a metric here"))),this.getZone(mstrmojo.desc(12173,"Break By"),DZ_BREAKBY,dzf.BreakBy,false,singleUnit(mstrmojo.desc(13833,"Drag an attribute here"))),this.getZone(mstrmojo.desc(15863,"Trend"),DZ_TREND,dzf.trend,false,singleUnit(mstrmojo.desc(13833,"Drag an attribute here")))];this.dropZones=zones;return{n:this.getHost().defn.ttl,zones:zones};},getAllowDropInfo:function getAllowDropInfo(zone,dragItems,idx,edge,context){var me=this,baseInfo=this._super(zone,dragItems,idx,edge,context),invalidPos=zone.items.length!==0&&edge!==$TARGET_POS.ON,allowItem=invalidPos?null:$ARR.filterOne(baseInfo.allowedItems,function(item){var isMetric=me.isMetric(item);return DZ_METRIC===zone.id?isMetric:(!isMetric&&item.t!==$OBJ_TYPES.Dimension);});return $HASH.copy({allowedItems:allowItem?[allowItem]:[]},baseInfo);},unitsDropped:function unitsDropped(zone,context,dropInfo){var actions=context.actions||[],templateActions=[],submittedActions,dragData=context.src.data,idx=dropInfo.idx,edge=dropInfo.edge,allowedItems=dropInfo.allowedItems,callbacksGenerator,me=this,cardinate,dispMode=me.getHost().getFormatPropertyValue($KPI_PROPERTIES.DISPLAY_MODE),isBreakByUpdate=zone.id===DZ_BREAKBY;if(edge===$TARGET_POS.ON&&dropInfo.removeReplaced){templateActions=templateActions.concat(this.getRemoveDropZoneUnitActions(zone,zone.items[idx]));}templateActions=templateActions.concat(this.getAddDropZoneUnitsActions(zone,allowedItems,this.getDropTargetIndex(zone,dropInfo),{datasetId:dragData.dsid}));submittedActions=actions.concat(me.getUpdateTemplateAction(templateActions));callbacksGenerator=function(hookVFUnset){return function(){var _submittedActions=hookVFUnset?me.docModel.wrapUnsetVisualizationFilterAction(submittedActions):submittedActions;me.submitDropZoneUpdates(_submittedActions,$FUNC.wrapMethods(context.callback,me.getHost().model.docModel.controller._getXtabCallback(me.getHost())),undefined,isBreakByUpdate);};};if(zone.id===DZ_BREAKBY&&dispMode===$DISPLAY_MODE.STACKED){cardinate=$CARDLIMIT;}else{cardinate=undefined;}this.checkAndWarnLargeItemsForAddUnits(allowedItems,function(){me.docModel.checkAndNotifyVFChangeOnDZUnitsUpdate({actions:submittedActions,zm:me},callbacksGenerator(true),callbacksGenerator(false));},undefined,undefined,undefined,undefined,cardinate);},checkBreakByLimit:function(callback,cancelCB){var me=this;this.checkAndWarnLargeItemsForAddUnits(me.dropZones[1].items,callback,undefined,undefined,undefined,true,$CARDLIMIT,cancelCB);},getAddItemActions:function addItem(zone,items,idx,isDND,replaceItem,datasetId){var actions=[],me=this,extras={datasetId:datasetId},checkAndAddToZone=function(zone,item,extras){$ARR.insert(actions,null,me.getAddDropZoneUnitsActions(zone,[item],0,extras));};checkAndAddToZone(zone,items[0],extras);return actions;},clearGridModeSettings:function clearGridModeSettings(zone){if(zone.id===DZ_TREND){return ;}var host=this.getHost(),dispMode=host.getFormatPropertyValue($KPI_PROPERTIES.DISPLAY_MODE);if(host&&dispMode&&dispMode===$DISPLAY_MODE.GRID){host.updateProperties($KPI_PROPERTIES.GRID_COLUMN_COUNT);host.updateProperties($KPI_PROPERTIES.FIX_CARD_HEIGHT);host.updateProperties($KPI_PROPERTIES.CARD_HEIGHT);this.propertyChanged=true;}},getAddDropZoneUnitsActions:function getAddDropZoneUnitsActions(zone,items,idx,extras){this.clearGridModeSettings(zone);return this._super(zone,items,idx,extras);},getRemoveDropZoneUnitActions:function getRemoveDropZoneUnitActions(zone,item){var actions=this._super(zone,item),host=this.getHost();if(zone.id===DZ_TREND){host.updateProperties($KPI_PROPERTIES.PREVIOUS_METRIC_NAME);this.propertyChanged=true;}this.clearGridModeSettings(zone);return actions;},deleteItem:function deleteItem(zone,idx){var me=this,model=me.docModel,actions=this.getRemoveDropZoneUnitActions(zone,zone.items[idx]),templateActions=actions.length?[this.getUpdateTemplateAction(actions)]:[];model&&model.checkAndNotifyVFChangeOnDZUnitsUpdate({ca:[zone.id],zm:me},function(){me.submitDropZoneUpdates(templateActions.concat(model.wrapUnsetVisualizationFilterAction()));},function(){me.submitDropZoneUpdates(templateActions);});},submitDropZoneUpdates:function submitDropZoneUpdates(actions,callback,extras,isBreakByUpdate){var host=this.getHost(),docModel=this.docModel,model=host.model,nodeKey=model.xtab.k,sortRows=host.getSortRows();if(this.propertyChanged){actions=actions.concat(host.getSetPropertiesAction());this.propertyChanged=false;}if(sortRows&&sortRows.length>0&&isBreakByUpdate){actions=actions.concat(docModel.getDataService().getUpdateTemplateAction(nodeKey,{act:"clearSort"}));}this._super(actions,callback,extras);},generateSortKeyByItem:function generateSortKeyByItem(item,formId){var sortItem=this.handleSortItem(item),itemType=sortItem.t,itemId=sortItem.did,tplAttInfo=this.getUnitInfoInTemplate(itemId),sortFormId=formId||(tplAttInfo.unit.fid||(tplAttInfo.unit.fs&&tplAttInfo.unit.fs[0].id));return this.generateSortKey(itemType,itemId,sortFormId);},generateSortKey:function generateSortKey(itemType,itemId,sortFormId){return[itemType,itemId,sortFormId,"21"].join("!");},handleSortItem:function handleSortItem(item){var host=this.getHost(),data=host.model.data,gts=data.gts,sortItem=$HASH.copy(item);if(item.t===$OBJ_TYPES.DssTypeDimension){$ARR.forEach((gts.row||[]).concat(gts.col||[]),function(t){if(t.hid===sortItem.did){sortItem.did=t.id;sortItem.t=t.otp;return false;}});}return sortItem;},getAppliedSortInfo:function getAppliedSortInfo(dzId,sortRows){var item=this.resolveDropZoneItem(dzId),sortInfo=null,me=this,sortItem,itemType,itemId;if(!item){return sortInfo;}sortItem=this.handleSortItem(item);itemType=sortItem.t;itemId=sortItem.did;$ARR.forEach(sortRows,function(sortRow){var sortKey=sortRow&&sortRow.key,sortKeyData;if(sortKey){sortKeyData=sortKey.split("!");if(sortKeyData[0]===itemType.toString()&&sortKeyData[1]===itemId){sortInfo={key:me.generateSortKey(itemType,itemId,sortKeyData[2]),isAsc:sortRow.isAsc};}}});return sortInfo;},generateSortInfo:function generateSortInfo(item,formId,isAsc){return{key:this.generateSortKeyByItem(item,formId),isAsc:isAsc};},resolveDropZoneItem:function resolveDropZoneItem(dzId){var dropZone=this.getZoneModelByZoneId(dzId),items=dropZone&&dropZone.items;return items&&items[0];},handleKPISort:function handleKPISort(sortItem,isAsc){var host=this.getHost(),sortRows=host.getSortRows(),breakBySort,breakByItem,trendSort,axisSorts=[],sorts=[];if(sortItem.sortIdx===0){axisSorts.push(this.generateSortInfo(sortItem,null,isAsc));trendSort=this.getAppliedSortInfo(DZ_TREND,sortRows);if(trendSort){axisSorts.push(trendSort);}}else{if(sortItem.sortIdx===1){breakBySort=this.getAppliedSortInfo(DZ_BREAKBY,sortRows);if(breakBySort){axisSorts.push(breakBySort);}else{breakByItem=this.resolveDropZoneItem(DZ_BREAKBY);if(breakByItem){axisSorts.push(this.generateSortInfo(breakByItem,null,true));}}axisSorts.push(this.generateSortInfo(sortItem,sortItem.sortForm,isAsc));}}sorts.push(axisSorts);sorts.push(null);this.docModel.controller.onAdvancedSort(host,sorts,null,null);},getTrendSortSubMenu:function getTrendSortSubMenu(itemContext,isAsc){var me=this,item=itemContext.item,sortItem=this.handleSortItem(item),fs,menuItems=[],menuContent=[];fs=$DATASET_INTERFACE.getFormsByAttrId(item.attId||item.did,this.docModel.datasets);$ARR.forEach(fs||[],function(f){var fid=f.fid;if($ARR.find(menuItems,"id",fid)<0){menuItems.push({id:fid,n:f.fnm,sortItem:sortItem,isAsc:isAsc});}});menuContent.push({scriptClass:"mstrmojo.ui.ScrollableContainer",alias:"scrollableContainer",children:[{scriptClass:"mstrmojo.vi.ui.InteractiveUnitList",draggable:false,CLS_HAS_MENU:"",items:menuItems,listHooks:{select:function select(el,unit){var sortItem=unit.sortItem;if(sortItem){sortItem.sortIdx=1;sortItem.sortForm=unit.id;me.handleKPISort(sortItem,unit.isAsc);}if(this.parent&&this.parent.parent&&this.parent.parent.closeAllMenus){this.parent.parent.closeAllMenus();}}}}]});return new mstrmojo.ui.menus.EditorConfig({data:{},cssClass:"replaceReference",okVisible:false,cancelVisible:false,contents:menuContent,onOpen:function opOpen(){this.scrollableContainer.updateScrollbars();}});},getTrendSortAscendingSubMenu:function getTrendSortAscendingSubMenu(itemContext){return this.getTrendSortSubMenu(itemContext,true);},getTrendSortDescendingSubMenu:function getTrendSortDescendingSubMenu(itemContext){return this.getTrendSortSubMenu(itemContext,false);},addTrendSortMenu:function addTrendSortMenu(itemContext,menuCfg){var host=this.getHost(),sortRows=host.getSortRows(),item=itemContext.item,axis=itemContext.axis,data=host.model.data,metricsAxis=data.gsi.tma,me=this;if(item.t===$OBJ_TYPES.DssTypeFilter){return ;}if(axis!==METRICS||metricsAxis!==ROWS){menuCfg.addPopupMenuItem(mstrmojo.desc(7974,"Sort Ascending"),this.id,this.getTrendSortAscendingSubMenu,"",itemContext);menuCfg.addPopupMenuItem(mstrmojo.desc(7975,"Sort Descending"),this.id,this.getTrendSortDescendingSubMenu,"",itemContext);if(sortRows&&sortRows.length>0){menuCfg.addMenuItem(mstrmojo.desc(11699,"Clear Sort"),"",function(){me.submitDropZoneTemplateUpdates([{act:"clearSort"}]);});}}},addBreakBySortMenu:function addBreakBySortMenu(itemContext,menuCfg){var host=this.getHost(),sortRows=host.getSortRows(),item=itemContext.item,axis=itemContext.axis,data=host.model.data,metricsAxis=data.gsi.tma,sortItem,me=this;if(item.t===$OBJ_TYPES.DssTypeFilter){return ;}if(axis!==METRICS||metricsAxis!==ROWS){sortItem=this.handleSortItem(item);sortItem.sortIdx=0;menuCfg.addMenuItem(mstrmojo.desc(7974,"Sort Ascending"),"xt",function(){me.handleKPISort(sortItem,true);});menuCfg.addMenuItem(mstrmojo.desc(7975,"Sort Descending"),"xt",function(){me.handleKPISort(sortItem,false);});if(sortRows&&sortRows.length>0){menuCfg.addMenuItem(mstrmojo.desc(11699,"Clear Sort"),"",function(){me.submitDropZoneTemplateUpdates([{act:"clearSort"}]);});}}},getUnitMenuItems:function getUnitMenuItems(cfg,zone,item,el){var me=this,dzid=this.id,isMetric=this.isMetric(item),isAttr=this.isAttribute(item),items=zone.items,cnt=items.length,itemContext={zone:zone,idx:$ARR.find(items,"id",item.id),cnt:cnt,item:item,useDropzone:true},isElemGroup=(item.t===47&&item.st===12033),dModel=this.docModel,did=item.did,dataset=$DU.getDatasetFromAttributeId(dModel.datasets,did),isInVFConfigMode=mstrApp.isInVFConfigMode,createDADMPriv=mstrmojo.resolveFeature($FEATURES.INSERT_NEW_METRIC);if(isElemGroup&&!isInVFConfigMode){cfg.addMenuItem(mstrmojo.desc(13296,"Edit Groups..."),"eg",this.getCreateOrEditElementGroupFunc(itemContext));cfg.addSeparator();}if(zone.id===DZ_BREAKBY){this.addBreakBySortMenu(itemContext,cfg);cfg.addSeparator();}if(zone.id===DZ_TREND){this.addTrendSortMenu(itemContext,cfg);cfg.addSeparator();}if(isMetric&&!isInVFConfigMode){if(item.um){cfg.addMenuItem(mstrmojo.desc(3224,"Edit..."),"",function(){me.editDerivedMetric(itemContext,"edit");},itemContext);cfg.addSeparator();}if(createDADMPriv){if(dModel.findDatasetIdFromUnit(did)&&!dModel.isFromSolrCube(did)&&!dModel.isFromMDXCube(did)){cfg.addSubMenuItem(mstrmojo.desc(11806,"Aggregate By"),"",dzid,me.getAggregateByMetricSubMenu,itemContext);cfg.addSeparator();}cfg.addEditorMenuItem(mstrmojo.desc(5188,"Calculation"),dzid,me.getCalculationEditorCfg,itemContext);cfg.addMenuItem(mstrmojo.desc(13624,"Create Metric..."),"",function(){me.newDerivedMetric(itemContext);},itemContext);}}else{if(isAttr&&!isInVFConfigMode){var isDynamicLinkAttr=this.isDynamicLink(item);if(!dataset||!dModel.isMDXDataset(dataset)){if(item.da){cfg.addMenuItem(mstrmojo.desc(3224,"Edit..."),"",function(){me.editDerivedAttribute(itemContext);},itemContext);cfg.addSeparator();}if(isAttr&&(item.de!==true)&&!$VISUTIL.isCGorCon(this.getHost(),item)&&!this.isDynamicLink(item)&&createDADMPriv){cfg.addMenuItem(mstrmojo.desc(13625,"Create Attribute..."),"",function(){me.newDerivedAttribute(itemContext,!me.allowInsertNewAttribute(zone));},itemContext);}}if(!$DU.hasOldDEOverDatasets(did,dModel.datasets)&&!this.isRecursiveAttribute(item)&&!isDynamicLinkAttr){cfg.addMenuItem(mstrmojo.desc(13295,"Create Groups..."),"eg",this.getCreateOrEditElementGroupFunc(itemContext));}}}cfg.addSeparator();if(this.showNumberFormat(item)){cfg.addEditorMenuItem(mstrmojo.desc(13237,"Number Format"),dzid,this.getNumberFormatEditorCfg,itemContext);}if(this.shouldShowDisplayFormsMenu(item)){cfg.addEditorMenuItem(mstrmojo.desc(11908,"Display Attribute Forms"),this.id,function(){return me.getDisplayFormsMenu(item);});}cfg.addSeparator();if(me.hasReplaceCandidates(itemContext)&&(!(mstrApp.isAppStatePresentation&&mstrApp.isAppStatePresentation())||!!mstrmojo.resolveFeature($FEATURES.WEB_DRILL_AND_LINK))){cfg.addSubMenuItem(mstrmojo.desc(14003,"Replace With"),"",dzid,me.getReplaceSubMenu,itemContext);}cfg.addMenuItem(mstrmojo.desc(1388,"Rename"),"",function(){me.renameItem(el,item);});cfg.addMenuItem(mstrmojo.desc(190,"Remove"),"xt",function(){me.deleteItem(zone,me.getUnitIndexInZone(zone,item));});}});}());