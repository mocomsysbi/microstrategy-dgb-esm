(function(){mstrmojo.requiresCls("mstrmojo.css","mstrmojo.dom","mstrmojo.func","mstrmojo.Dialog","mstrmojo.Button","mstrmojo._IsPopup","mstrmojo._CanAutoClose","mstrmojo.VisUtility","mstrmojo.vi._MonitorsAppState","mstrmojo.PerformanceLogOutput");var VISTOOLBAR_HEIGHT=60,$MOJO=mstrmojo,$CSS=$MOJO.css,$DOM=$MOJO.dom,$FUNC=$MOJO.func,$VISUTIL=$MOJO.VisUtility,$NWB=$MOJO.Button.newWebButton,BORDER_WIDTH=2,PADDING_LR_FLOATING=60,PADDING_TOP_FLOATING=3,PADDING_BOTTOM_FLOATING=44,PADDING_EXTRA_FOR_FILTER_PORTLET=48,PADDING_DEFAULT_FOR_FILTER_PORTLET=4,WAIT_TIME=160,$PerfLog=$MOJO.PerformanceLogOutput;function applySelections(){$PerfLog.startTimer({functionName:"VisFilter.updateSelections",purpose:"from Apply filter to End"},"timerid_VisFilter_updateSelections");$PerfLog.visPrint("VisFilter updateSelections start");var srcFilterPortlet=this.filterPortlet,_actionCache=this._actionCache;if(srcFilterPortlet&&_actionCache){srcFilterPortlet.selector.applySelections(_actionCache);}this.destroy();}function getVis(){var vizBox=this.vizBox;return vizBox&&vizBox.boxContent;}function getThemeClass(){return mstrApp?mstrApp.getThemeClassName():"";}function getFilterPortletRect(){var filterPortlet=this.filterPortlet,domNode=filterPortlet&&filterPortlet.domNode;if(domNode){return domNode.getBoundingClientRect();}}function getFilterPanelStack(){var portlet=this.filterPortlet,filterPanel=portlet&&portlet.parent;return filterPanel&&filterPanel.parent;}function updateFilterPanelPaddingBottom(padding){var portlet=this.filterPortlet,portletNode=portlet&&portlet.domNode,filterPanelNode=portletNode&&portletNode.parentNode;if(filterPanelNode){filterPanelNode.style.paddingBottom=padding+"px";}}function getFilterPanelConainterRect(){var filterPanelStack=getFilterPanelStack.call(this),container=filterPanelStack&&filterPanelStack.containerNode;if(container){return container.getBoundingClientRect();}}function getCurtainMainFmts(){if(!this.model){return ;}var mainPanelRect=this.model.getMainPanelFormatting(),filterPortletRect=getFilterPortletRect.call(this),mainFmt={top:mainPanelRect.top,height:mainPanelRect.height};if(filterPortletRect.left<mainPanelRect.left){mainFmt.left=filterPortletRect.right;mainFmt.width=mainPanelRect.right-mainFmt.left;}else{mainFmt.left=mainPanelRect.left;mainFmt.width=filterPortletRect.left-mainFmt.left;}return mainFmt;}function getCurtainBorderFmts(){var floatingRect=getFloatingPanelFormatting.call(this),filterPortletRect=getFilterPortletRect.call(this),filterPanelRect=getFilterPanelConainterRect.call(this),offset=BORDER_WIDTH/2,borderFmt={top:Math.max(filterPortletRect.top,filterPanelRect.top)+offset};borderFmt.height=(filterPortletRect.bottom<filterPanelRect.bottom)?(filterPortletRect.bottom-borderFmt.top)-offset:(filterPanelRect.bottom-borderFmt.top)-offset;borderFmt.height=borderFmt.height<0?0:borderFmt.height;if(filterPortletRect.left<floatingRect.left){borderFmt.right=floatingRect.left+BORDER_WIDTH;borderFmt.left=floatingRect.left-BORDER_WIDTH*3;}else{borderFmt.left=floatingRect.right+offset;borderFmt.right=filterPortletRect.left+BORDER_WIDTH*2;}borderFmt.width=borderFmt.right-borderFmt.left;return borderFmt;}function updateCurtainMain(){var mainRect=document.getElementById("VisFilterCurtain-main"),mainFmts=getCurtainMainFmts.call(this);if(mainRect){mainRect.style.left=mainFmts.left+"px";mainRect.style.width=mainFmts.width+"px";mainRect.style.top=mainFmts.top+"px";mainRect.style.height=mainFmts.height+"px";}}function updateCurtainBorder(){var borderRect=document.getElementById("VisFilterCurtain-border"),borderFmts=getCurtainBorderFmts.call(this);if(borderRect){borderRect.style.left=borderFmts.left+"px";borderRect.style.width=borderFmts.width+"px";borderRect.style.top=borderFmts.top+"px";borderRect.style.height=borderFmts.height+"px";}}function updatePortletSplitter(isVisible){var filterPortlet=this.filterPortlet,dn=filterPortlet&&filterPortlet.domNode,prePortletDn=dn&&dn.previousSibling&&dn.previousSibling.previousSibling,splitterDn=prePortletDn&&prePortletDn.querySelector(".splitter"),newVal=isVisible?"block":"none",valOfSlitterDn;if(dn){$CSS.setStyleValue(dn.querySelector(".splitter"),["display"],[newVal]);}if(splitterDn){valOfSlitterDn=$CSS.getStyleValue(splitterDn,"display");if(!isVisible&&valOfSlitterDn==="none"){this.ignorePreDivider=true;}if(!this.ignorePreDivider){$CSS.setStyleValue(splitterDn,["display"],[newVal]);delete this.ignorePreDivider;}}}function updateCurtain(){updateCurtainMain.call(this);updateCurtainBorder.call(this);updatePortletSplitter.call(this,false);}function getFloatingPanelFormatting(){var model=this.model,mainPanelRect=model.getMainPanelFormatting(),filterPanelRect=model.getFilterPanelFormatting(),padding=mainPanelRect.width>PADDING_LR_FLOATING?PADDING_LR_FLOATING:0,formatting={top:mainPanelRect.top+PADDING_TOP_FLOATING,height:mainPanelRect.height-PADDING_BOTTOM_FLOATING-PADDING_TOP_FLOATING};if(filterPanelRect.left<mainPanelRect.left){formatting.left=filterPanelRect.right-BORDER_WIDTH;formatting.right=mainPanelRect.right-padding;}else{formatting.right=filterPanelRect.left-BORDER_WIDTH*2;formatting.left=mainPanelRect.left+padding;}formatting.bottom=formatting.top+formatting.height;formatting.width=formatting.right-formatting.left;return formatting;}function isMenuForVis(el){var node=el,elLimit=document.body;while(node&&(node!==elLimit)){var v=node.getAttribute&&node.getAttribute("class");if(v!==null&&v.indexOf("forVisFilter")>=0){return true;}node=node.parentNode;}return false;}function updateSummaryBar(vis){var srcFilterPortlet=this.filterPortlet,selectionCache=vis&&vis.getSelectionCache(),selections=(selectionCache&&selectionCache._viSelections)||{};if(srcFilterPortlet&&vis){srcFilterPortlet.updateSummaryBar(selections);}}mstrmojo.vi.ui.rw.VisFilterDisplayPanel=mstrmojo.declare(mstrmojo.Dialog,[mstrmojo._IsPopup,mstrmojo._CanAutoClose,mstrmojo.vi._MonitorsAppState],{scriptClass:"mstrmojo.vi.ui.rw.VisFilterDisplayPanel",markupString:'<div id="{@id}" class="mstrmojo-Dialog {@cssClass}" style="z-index: 8;" tabindex="0" mstrAttach:click,contextmenu><div class="mstrmojo-Editor" style="height:{@height}"><div class="mstrmojo-Editor-titlebar"><div class="mstrmojo-Editor-title">{@title}</div></div><div class="mstrmojo-Editor-content"></div></div><svg id="VisFilterCurtain-main" /><svg id="VisFilterCurtain-border" /><div class="mstrmojo-Editor-tip"></div></div>',cssClass:"mstrmojo-VisFilterDisplayPanel",children:[{scriptClass:"mstrmojo.Box",cssClass:"titlebar-container",slot:"titleNode",alias:"titleBar",children:[{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(1763,"Clear All"),alias:"clearAllBtn",cssClass:"edt-link disabled",disabled:true,onclick:function(e){var floatingPanel=this.parent.parent,vis=getVis.call(floatingPanel);if(!this.disabled&&vis){vis.clearAllSelectionsAndHighlight(e);}}},{scriptClass:"mstrmojo.Box",alias:"btnBox",children:[$NWB(mstrmojo.desc(221,"Cancel"),function(){var floatingPanel=this.parent.parent.parent;if(floatingPanel){floatingPanel.cancelSelections();}}),$NWB(mstrmojo.desc(8473,"Done"),function(){var floatingPanel=this.parent.parent.parent;if(floatingPanel){applySelections.call(floatingPanel);}},true,{alias:"savebtn",enabled:false})]}]},{scriptClass:"mstrmojo.Box",alias:"visContainer",slot:"containerNode"}],locksHover:true,nodeKey:null,vizBox:null,filterPortlet:null,include:null,model:null,_actionCache:null,_prevSelectionInfo:null,disposable:false,init:function init(props){this._super(props);if(!this.model){return ;}this.cssClass+=" "+getThemeClass();},_addVizBox:function _addVizBox(){var vizBox=this.vizBox=this.model.getVizBox(this.nodeKey,{width:parseInt(this.width),height:parseInt(this.height)-VISTOOLBAR_HEIGHT}),vis=vizBox&&vizBox.boxContent;if(vis){vis.filterCtrl=this;}this.visContainer.addChildren(vizBox);return vizBox;},preBuildRendering:function preBuildRendering(){var formatting=getFloatingPanelFormatting.call(this),vizBox=this.vizBox;if(!formatting){return ;}this.height=formatting.height+"px";this.width=formatting.width+"px";this.left=formatting.left+"px";this.top=formatting.top+"px";var selectedVizBox=this.selectedVizBox=document.querySelector(".mstrmojo-VIMainVizPanel .mstrmojo-UnitContainer.selected");$CSS.removeClass(selectedVizBox,"selected");if(!vizBox){this.vizBox=this._addVizBox();}else{vizBox.updateLayout({height:(formatting.height-VISTOOLBAR_HEIGHT)+"px",width:formatting.width+"px"});}this._super();},postBuildRendering:function postBuildRendering(){this._super();updateCurtain.call(this);this.updateTitleBar();this.updateVisFilterPortletStyle();},updateVisFilterPortletStyle:function updateVisFilterPortletStyle(){var filterPanelStack=getFilterPanelStack.call(this),scrollNode=filterPanelStack.scrollNode;if(!filterPanelStack||!scrollNode){return ;}filterPanelStack.disableScroll();var pltNode=this.filterPortlet.domNode,scrollNodeScrollTop=scrollNode.scrollTop,scrollNodeHeight=scrollNode.clientHeight,scrollNodeScrollHeight=scrollNode.scrollHeight,srcollNodeRect=scrollNode.getBoundingClientRect(),pltNodeOffsetTop=pltNode.offsetTop,pltNodeRect=pltNode.getBoundingClientRect(),pltNodeHeight=pltNodeRect.height,pltNodeTotalHeight=pltNodeOffsetTop+pltNodeHeight,mainPanelRect=this.model.getMainPanelFormatting(),paddingExtra=srcollNodeRect.bottom-mainPanelRect.bottom+PADDING_EXTRA_FOR_FILTER_PORTLET,distance;if(pltNodeOffsetTop<scrollNodeScrollTop){scrollNode.scrollTop=pltNodeOffsetTop;}else{if(scrollNodeScrollTop+scrollNodeHeight<pltNodeTotalHeight+paddingExtra){distance=scrollNodeScrollHeight-pltNodeTotalHeight;if(distance<paddingExtra){updateFilterPanelPaddingBottom.call(this,paddingExtra);}scrollNode.scrollTop=pltNodeTotalHeight+paddingExtra-scrollNodeHeight;}}},close:function close(evtTarget){var filterPortlet=this.filterPortlet,portletDom=filterPortlet&&filterPortlet.domNode,isMenuForVisFilter=$VISUTIL.isHostedPopupNode(evtTarget,"class",true,document.body)||isMenuForVis(evtTarget),isEditorNode=$VISUTIL.isMojoEditorNode(evtTarget,"class",true,document.body);if(!(portletDom&&evtTarget&&portletDom.contains(evtTarget))&&!isMenuForVisFilter&&!isEditorNode){this._super();}},onClose:function onClose(){updatePortletSplitter.call(this,true);this.cancelSelections();},onAppStateChange:function onAppStateChange(evt){this._super(evt);this.cancelSelections();},cacheUpdateAction:function cacheUpdateAction(action){this.updateTitleBar(true);this._actionCache=action;},updateTitleBar:function updateTitleBar(selectionChanged){var titleBar=this.titleBar,clearAllBtn=titleBar&&titleBar.clearAllBtn,vis=getVis.call(this),selectionCount=vis?vis.getSelectionSize():0;if(!clearAllBtn||!vis){return ;}updateSummaryBar.call(this,vis);titleBar.btnBox.savebtn.set("enabled",!!selectionChanged);if(selectionCount>0){$CSS.removeClass(clearAllBtn.domNode,"disabled");clearAllBtn.disabled=false;}else{$CSS.addClass(clearAllBtn.domNode,"disabled");clearAllBtn.disabled=true;}},getResizeHandler:function getResizeHandler(){var id=this.id;return $FUNC.debounce(function(){var dialog=mstrmojo.all[id];if(dialog){dialog.resizeDialog();dialog.positionDialog();}},WAIT_TIME);},resizeDialog:function resizeDialog(){this._super();this.refresh();},cancelSelections:function cancelSelections(){var vis=getVis.call(this);if(vis){vis.setSelectionCache(vis.getPrevSelectionInfo());vis.clearHighlightsCache();}updateSummaryBar.call(this,vis);this.destroy();},updateFormats:function updateFormats(){updateCurtainBorder.call(this);},oncontextmenu:function oncontextmenu(evt){$DOM.stopPropogation(window,evt);$DOM.preventDefault(window,evt);},updateVis:function updateVis(node){var vis=getVis.call(this),sc=node&&node.data&&node.data.sc;if(sc){sc.exp=null;}if(vis&&node){vis.updateForInteractiveMode=true;vis.node=node;vis.update(node);vis.refresh();delete vis.updateForInteractiveMode;}},destroy:function(){var vizBox=this.vizBox,model=this.model,vis=getVis.call(this),filterPortlet=this.filterPortlet,filterPanelStack=getFilterPanelStack.call(this);if(filterPanelStack){filterPanelStack.enableScroll();}updateFilterPanelPaddingBottom.call(this,PADDING_DEFAULT_FOR_FILTER_PORTLET);updatePortletSplitter.call(this,true);if(filterPortlet){filterPortlet.resetVisFilterState();this.filterPortlet=null;}$CSS.addClass(this.selectedVizBox,"selected");if(model&&vizBox){model.destroyVisualiztionselector(vizBox);}if(vis){vis.filterCtrl=null;}this.vizBox=null;this.model=null;this._super();mstrApp.isInVFInteractMode=false;}});}());