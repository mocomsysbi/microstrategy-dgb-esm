(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.array","mstrmojo.gmaps.MapUtils","mstrmojo.vi.ui.rw._HasVisSelections");var $MOJO=mstrmojo,$A=$MOJO.array,$H=$MOJO.hash,$MUTIL=$MOJO.gmaps.MapUtils,SELECTION_TYPE=mstrmojo.vi.ui.rw.SelectionType;var UNIT_SELECT_ALL="OA:(All)";var SELECTOR_ACTION=2;function getTitleColumnIndices(){var gridData=this.getLayerModel(),titles=gridData.getRowTitles(),titleId,i,titleCount=titles.size(),titleIds={},title;if(titleCount>0){for(i=0;i<titleCount;i++){title=titles.getTitle(i);titleId=title.getUnitId();titleIds[titleId]=i;}}return titleIds;}function findSelectedGraphic(all,selected,eid,columnIndex){var graphic,i,count=!!all?all.length:0;for(i=0;i<count;i++){graphic=all[i];if(!selected[graphic.id]&&isGraphicSelected.call(this,graphic,eid,columnIndex)){return graphic;}}return null;}function isGraphicSelected(graphic,eid,columnIndex){var rowIndex,rowIndices,i,rowNum,priModel=this.getLayerModel(),rowHeaderElements,rowHeaderElement,elementId;if(!graphic){return false;}rowIndices=graphic.getDataRowIndices();rowNum=(rowIndices&&rowIndices.length)||0;for(i=0;i<rowNum;i++){rowIndex=rowIndices[i];rowHeaderElements=priModel.getRowHeaders(rowIndex);rowHeaderElement=rowHeaderElements.getHeader(columnIndex);if(rowHeaderElement){elementId=rowHeaderElement.getElementId();if(this.model.compareElementsId(elementId,eid)){return true;}}}return false;}function findGraphicByData(all,selected,attributes,graphicData){var graphic,i,j,attribute,attrInfo,attrId,eid,columnIndex,count=!!all?all.length:0,attrCnt=attributes&&attributes.length;for(i=0;i<count;i++){graphic=all[i];if(graphic&&!selected[graphic.id]){for(j=0;j<attrCnt;j++){attribute=attributes[j];attrId=attribute.id;columnIndex=attribute.columnIndex;attrInfo=graphicData[attrId]&&graphicData[attrId][0];eid=attrInfo&&attrInfo.id;if(!isGraphicSelected.call(this,graphic,eid,columnIndex)){break;}}if(j===attrCnt){selected[graphic.id]=graphic;return ;}}}}function selectWithMetrics(data){var dataAtts=data[$H.keyarray(data)[0]],attIds=$H.keyarray(dataAtts),resultGraphics={},results=[],allGraphics=this.getAllGraphicsForHighlight(),commonAttributes=this.getCommonAttributes(attIds),index,key;if(!commonAttributes||commonAttributes.length===0){return results;}for(index in data){if(data.hasOwnProperty(index)){findGraphicByData.call(this,allGraphics,resultGraphics,commonAttributes,data[index]);}}for(key in resultGraphics){results.push(resultGraphics[key]);}return results;}function selectWithAttributes(data){var index,singleData,attributeId,elements,element,elementCount,eid,selectedGraphic,allGraphics=this.getAllGraphicsForHighlight(),titleIds=getTitleColumnIndices.call(this),columnIndex,resultGraphics={},results=[],i,j,key,linkedAttributes;for(index in data){if(data.hasOwnProperty(index)){singleData=data[index];for(attributeId in singleData){linkedAttributes=this.model.getLinkedAttributes(attributeId)||[];linkedAttributes=[attributeId].concat(linkedAttributes);if(singleData.hasOwnProperty(attributeId)){elements=singleData[attributeId];elementCount=elements.length;for(i=0;i<elementCount;i++){element=elements[i];eid=element.id;for(j=0;j<linkedAttributes.length;j++){if(titleIds.hasOwnProperty(linkedAttributes[j])){columnIndex=titleIds[linkedAttributes[j]];selectedGraphic=findSelectedGraphic.call(this,allGraphics,resultGraphics,eid,columnIndex);if(!!selectedGraphic&&!resultGraphics[selectedGraphic.id]){resultGraphics[selectedGraphic.id]=selectedGraphic;}break;}}}}}}}for(key in resultGraphics){results.push(resultGraphics[key]);}return results;}function getSelectorDataFromExpression(exp){var res={type:mstrmojo.vi.ui.rw.SelectionType.ATTS,data:exp},lookupType=function(nd,prevTy){if(parseInt(nd.fn,10)===22&&parseInt(prevTy,10)===19){res.type=mstrmojo.vi.ui.rw.SelectionType.METRICS;}$A.forEach((nd.nds||[]),function(i){lookupType(i,nd.fn);});};lookupType(exp,null);return res;}function findPanelStackAsInfoWindow(selectorControl){var targetKeys=selectorControl.tks;if(selectorControl&&targetKeys){var docModel=mstrApp.docModel,targets=targetKeys.split("\u001E");var ifws=[];$A.forEach(targets,function(target){var targetDefn=docModel.getTargetDefn(target),defn=targetDefn[target];if(defn&&defn.ifw){ifws.push(target);}});return ifws;}}function getTemplateUnitSelectionAction(columnIndex){var me=this,selectedGraphics=me.selectedGraphics,selectedGraphicsLength=selectedGraphics.length,selectedGraphic=selectedGraphics[0]||me.graphics[0];if(!selectedGraphic){return ;}if(selectedGraphic.parentGraphic){selectedGraphic=selectedGraphic.parentGraphic;}var itemSeparator="\x1e",graphicAttributes=selectedGraphic.attributes,columnIndies=graphicAttributes.columnIndices,row=selectedGraphic.parent.data.gts.row,geoAttribute=row[columnIndies[columnIndex]],geoAttributeSelector=geoAttribute&&geoAttribute.sc;if(geoAttributeSelector&&geoAttributeSelector.tks){var targetKeys=geoAttributeSelector.tks,controlKeyContext=geoAttributeSelector.ck,controlKey=geoAttributeSelector.ckey,elementList=[];$A.forEach(selectedGraphics,function(graphic){var attributes=graphic.attributes,attribute=row[attributes.columnIndices[columnIndex]];if(attribute.did===geoAttribute.did){var geoIndices=attributes.geoIndices;if(geoIndices){$A.forEach(geoIndices,function(index){elementList.push(attribute.es[index].id);});}else{elementList.push(attribute.es[attributes.geoIndex].id);}}});if(mstrApp.docModel&&selectedGraphicsLength>0){var ifws=findPanelStackAsInfoWindow(geoAttributeSelector);$H.forEach(ifws,function(psId){mstrApp.docModel.showInfoWin(psId,selectedGraphics[selectedGraphicsLength-1].geometry.node);});}if($MUTIL.isExpress()){return{key:me.key+controlKey,type:mstrmojo.EnumRWUnitType.GRID,ck:controlKeyContext,ctlKey:controlKey,tks:targetKeys,suppressIW:true,eid:elementList.length===0?UNIT_SELECT_ALL:elementList.join(itemSeparator)};}else{if(this.isViewerSliceable()){return microstrategy.updateManager.createActionObject(null,mstrUpdateManager.SET_CUR_CTL_ELEMENTS,this.map.getMapConfig().common.beanPath,["2048130","2048127","2048137","2048138","2048018"],[controlKey,elementList,controlKeyContext,"1","false"],[]);}}}}mstrmojo.gmaps.layer._GraphicLayerDataSelectionHelper=mstrmojo.provide("mstrmojo.gmaps.layer._GraphicLayerDataSelectionHelper",{highlightFromViSelection:function highlightFromViSelection(){if(this.highlight&&this.highlight instanceof Function){this.highlight(this.getSelectionType(),this.getSelectionHash(),true);}},initViSelectionFromScExp:function initViSelectionFromScExp(){this._super&&this._super();var sc=mstrApp.isInVFConfigMode?null:this.findSelectorControl();if(sc&&!$H.isEmpty(sc.exp)&&this.addSelectionsFromExpression){this.addSelectionsFromExpression(getSelectorDataFromExpression(sc.exp));}if(this.isInFilterPanel()){this.update();}},showData:function(){var map=this.map,xtab=this.getXtab();if(!map.gridData){map.gridData=xtab&&xtab.getData();}mstrmojo.vi.ui.ViewDataDialog.open(map.parent,true);},getAssociatedNodes:function getAssociatedNodes(){var xtab=this.getXtab(),node=xtab&&xtab.node,gt=node&&node.defn&&node.defn.an;return gt&&gt.length>0?gt:[];},isVisFilterSource:function isVisFilterSource(){var nodes=this.getAssociatedNodes();return nodes&&nodes.length>0;},canDoMultiSelect:function canDoMultiSelect(){var attributeId=this.getGeoColumnAttribute();return this.supportsViewFilterActions(attributeId);},getZoneModelByZoneId:function getZoneModelByZoneId(zoneId){var zones=this.getDropZonesInZoneModel(),resZone=undefined;$A.forEach(zones,function(zone){if(zone.id===zoneId){resZone=zone;return false;}});return resZone;},getDropZonesInZoneModel:function getDropZonesInZoneModel(){var map=this.map,zonesModel=map.zonesModel,layerKey=this.key,result=null;if(zonesModel&&layerKey){result=zonesModel.getDropZones(true,layerKey).zones||[];}return result;},getItemInZoneModel:function getItemInZoneModel(id){var map=this.map,zonesModel=map.zonesModel,layerKey=this.key,result=null,gsi=this.data&&this.data.gsi;if(zonesModel&&layerKey){(zonesModel.getDropZones(true,layerKey).zones||[]).some(function(zone){return !!zone.items.some(function(item){if(item.did===id){result=item;return true;}});});}else{if(gsi){$A.forEach((gsi.cols||[]).concat(gsi.rows||[]),function(unit){if(unit.did===id){result=unit;return false;}});}}return result;},supportsViewFilterActions:function supportsViewFilterActions(id){var item=this.getItemInZoneModel(id),isDe=function(item){return item.de;},isCGorConsolidation=function(item){return item.t===1||item.t===47;},isNDE=function(item){return item.t===47&&item.st===12033;};return item&&(!isDe(item)&&!isCGorConsolidation(item)||isNDE(item));},getSelectedObjectMetricInfo:function getSelectedObjectMetricInfo(rowIndex,reserveTTpAttr){var i,item,rtn={},info=this.getObjInfo(rowIndex,reserveTTpAttr),n=info.length,value;for(i=0;i<n;i++){item=info[i];value=item.v;if(rtn[item.tid]&&rtn[item.tid][0]&&rtn[item.tid][0].n){value=rtn[item.tid][0].n+":"+item.v;}rtn[item.tid]=[{id:item.eid,n:value}];}return rtn;},getObjInfo:function getObjInfo(rowIndex,reserveTTpAttr){var gridData=this.getLayerModel(),titles=gridData&&gridData.getRowTitles(),attrFormIndices=this.getAttrFormIndices(reserveTTpAttr),oneAttrForms,oneAttrFormCount,attrCount=attrFormIndices.length,formCount,selObjInfo,rowItems,rowItem,attrIndex,formIndex,i,attrTitle,attrName,attrID,attrElemName,attrElemID;rowItems=gridData.getRowHeaders(rowIndex);formCount=rowItems.size();selObjInfo=[];for(attrIndex=0;attrIndex<attrCount;attrIndex++){oneAttrForms=attrFormIndices[attrIndex];oneAttrFormCount=oneAttrForms.length;attrTitle=titles.getTitle(attrIndex);attrName=attrTitle.getName();attrID=attrTitle.getUnitId();for(i=0;i<oneAttrFormCount;i++){formIndex=oneAttrForms[i];if(formIndex<formCount){rowItem=rowItems.getHeader(formIndex);if(rowItem.t&&rowItem.h.stt===1){return[];}attrElemName=rowItem.getName();attrElemID=rowItem.getElementId();selObjInfo.push({n:attrName,tid:attrID,v:attrElemName,eid:attrElemID});}}}return selObjInfo;},getGeoColumnAttribute:function getGeoColumnAttribute(){var columnIndex=this.getGeoColumnIndex(),model=this.getLayerModel(),title;title=model.getRowTitles().getTitle(columnIndex);if(!!title){return title.getUnitId();}return null;},getCommonAttributes:function getCommonAttributes(attributeArray){var commonAttributes=[],i,j,titleIds=getTitleColumnIndices.call(this),attributeCount=!!attributeArray?attributeArray.length:0,attribute,linkedAttributes;for(i=0;i<attributeCount;i++){attribute=attributeArray[i];linkedAttributes=this.model.getLinkedAttributes(attribute)||[];linkedAttributes=[attribute].concat(linkedAttributes);for(j=0;j<linkedAttributes.length;j++){if(titleIds.hasOwnProperty(linkedAttributes[j])){commonAttributes.push({id:attribute,columnIndex:titleIds[linkedAttributes[j]]});break;}}}return commonAttributes;},addVisSelection:function addVisSelection(rowIndices){if(!$MUTIL.isOIVM()){return ;}var rowIndex,rowCount,i,selObjInfo;rowIndices=$A.ensureArray(rowIndices);rowCount=rowIndices.length;for(i=0;i<rowCount;i++){rowIndex=rowIndices[i];selObjInfo=this.getSelectedObjectMetricInfo(rowIndex);if(Object.keys(selObjInfo).length>0){this.addMetricValueSelection(selObjInfo);}}this.addRowIndicesSelection(rowIndices);},addVisContextMenuSelection:function addVisContextMenuSelection(rowIndices){if(!$MUTIL.isOIVM()){return ;}var rowIndex,rowCount,i,selObjInfo;rowIndices=$A.ensureArray(rowIndices);rowCount=rowIndices.length;for(i=0;i<rowCount;i++){rowIndex=rowIndices[i];selObjInfo=this.getSelectedObjectMetricInfo(rowIndex,true);if(Object.keys(selObjInfo).length>0){this.addContextMenuMetricValueSelection(selObjInfo);}}},removeVisSelection:function removeVisSelection(rowIndices){if(!$MUTIL.isOIVM()){return ;}var rowIndex,rowCount,i,selObjInfo,attributeIndex=this.getGeoColumnIndex(),selAttrInfo;rowIndices=$A.ensureArray(rowIndices);rowCount=rowIndices.length;for(i=0;i<rowCount;i++){rowIndex=rowIndices[i];if(this.getSelectionType()===SELECTION_TYPE.ATTS){selObjInfo=this.getObjInfo(rowIndex);selAttrInfo=selObjInfo[attributeIndex];if(selAttrInfo){this.removeAttributeSelection(selAttrInfo.tid,selAttrInfo.eid);}}else{if(this.getSelectionType()===SELECTION_TYPE.METRICS){selObjInfo=this.getSelectedObjectMetricInfo(rowIndex);if(Object.keys(selObjInfo).length>0){this.removeMetricValueSelection(selObjInfo);}this.removeSelectedGraphicInfo(rowIndex);}}}},isClearAllDisabled:function isClearAllDisabled(){var sc=this.findSelectorControl();return !!sc&&!sc.showall;},clearSelections:function clearSelections(){if($MUTIL.isOIVM()){if(this._super){this._super();}}},clearCxtMnuSelection:function clearCxtMnuSelection(){if(this._super){this._super();}},getAttrFormIndices:function getAttrFormIndices(reserveTTpAttr){var me=this,gridData=me.getLayerModel(),titles=gridData.getRowTitles(),i,j,k=0,attrFormIndices=[],titleCount=titles.size(),isTtpOnlyAttrs=function(attrId){var modelData=me.data,dz=modelData&&modelData.dz,ttpZone=dz&&dz.AdditionalMetrics,ttpAttrs=$A.ensureArray(ttpZone&&ttpZone.TemplateUnit),otherAttrZones=$A.map(["Geo","Lat","Long","ColorBy","SliceBy"],function(zoneName){return $A.ensureArray(dz&&dz[zoneName]&&dz[zoneName].TemplateUnit);}),ret=false,attrsOnlyInTtp=$A.difference.apply(this,[ttpAttrs].concat(otherAttrZones).concat("id"));$A.forEach(attrsOnlyInTtp,function(attr){if(attrId===attr.id){ret=true;return false;}});return ret;};if(titleCount>0){var idx=0;for(i=0;i<titleCount;i++){var title=titles.getTitle(i),fs=title.getForms();attrFormIndices.push([]);if(fs){for(j=0;j<fs.length;j++){attrFormIndices[k].push(idx++);}}else{idx++;}if(!reserveTTpAttr&&isTtpOnlyAttrs(title.getUnitId())){attrFormIndices[k]=[];}k++;}}else{attrFormIndices=null;}this.attributeFormIndices=attrFormIndices;return attrFormIndices;},isUseAsFilter:function isUseAsFilter(){var map=this.map,vis=map.fnGetWidget(this.key),node=vis&&vis.node,an=node&&node.defn&&node.defn.an;return !!an&&an.length>0;},deleteSelectorControl:function deleteSelectorControl(){var map=this.map,data=map.getGridData(this.key),sc=data&&data.sc;if(sc&&parseInt(sc.ct,10)===6){delete data.sc;}},findSelectorControl:function findSelectorControl(){var map=this.map,data=map.getGridData(this.key),v=data&&data.sc;if(v&&parseInt(v.ct,10)===6){this.selectorControl=v;this.isMultiSelect=true;}else{delete this.selectorControl;}return this.selectorControl;},highlight:function highlight(selTy,data,fromExpression){if(this._super){this._super.apply(this,arguments);}var graphics,_viewer=this._viewer;if(!fromExpression){this.clearSelections();}if(selTy==="empty"||$H.isEmpty(data)){this.initViSelectionFromScExp();selTy=this.getSelectionType();data=this.getSelectionHash();}if(selTy===SELECTION_TYPE.METRICS){graphics=selectWithMetrics.call(this,data);}else{if(selTy===SELECTION_TYPE.ATTS){graphics=selectWithAttributes.call(this,data);}}$A.forEach(graphics,function(graphic){this.addToSelectedGraphics(graphic);},this);if(_viewer){_viewer.highlightGraphics(graphics);}},isViewerSliceable:function isViewerSliceable(){var index=this.getGeoColumnIndex(),item=this.data.ghs.rhs.items[0].items[index],actionType;if(!!item){actionType=item.at;if(actionType===undefined||isNaN(actionType)){return false;}if((actionType&SELECTOR_ACTION)>0){return true;}}return false;},addTemplateUnitSelection:function addTemplateUnitSelection(actions){var graphic=this.selectedGraphics[0]||this.graphics[0];if(!graphic){return ;}if(graphic.parentGraphic){graphic=graphic.parentGraphic;}var graphicAttributes=graphic.attributes,columnIndies=graphicAttributes.columnIndices,row=graphic.parent.data.gts.row,geoAttribute=row[columnIndies[0]],longGeoAttribute=row[columnIndies[1]],action;action=getTemplateUnitSelectionAction.call(this,0);if(action){actions.push(action);}if(longGeoAttribute&&longGeoAttribute.id!==geoAttribute.id){action=getTemplateUnitSelectionAction.call(this,1);if(action){actions.push(action);}}},getAllGraphicsForHighlight:function getAllGraphicsForHighlight(){var _viewer=this._viewer,graphicsForHighlight=[],graphics=_viewer&&_viewer.graphics||this.graphics;$A.forEach(graphics,function(graphic){graphicsForHighlight=graphicsForHighlight.concat(graphic.getGraphicsForSelection());});return graphicsForHighlight;}});}());