(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.array","mstrmojo.css","mstrmojo.VisUtility","mstrmojo.VisTooltip","mstrmojo.VisBase","mstrmojo.PerformanceLogOutput","mstrmojo._VizSelectionHelper","mstrmojo.kpicard.KPICardEnum","mstrmojo.kpicard._KPICardProperty","mstrmojo.kpicard._KPICardDataModel","mstrmojo.kpicard._KPICardInteractivity","mstrmojo.kpicard.layout.HorizontalLayout","mstrmojo.kpicard.layout.VerticalLayout","mstrmojo.kpicard.layout.StackedLayout","mstrmojo.kpicard.layout.SmartLayout","mstrmojo.kpicard.layout.GridLayout","mstrmojo.kpicard._SupportKPICardBrushesAndHighlights","mstrmojo.util.ui._LassoSelector","mstrmojo.vi.ui.rw._XtabDE","mstrmojo.vi.ui.rw._HasVisSelections","mstrmojo.vi.ui.rw.selectors._IsMultiUnitControl","mstrmojo.vi.ui.rw.selectors._BrushesAndHighlights","mstrmojo.vi._MonitorsAppState","mstrmojo.ui.menus._HasMenuPopup","mstrmojo.VisEnum","mstrmojo.util.FontLoader");var $HASH=mstrmojo.hash,$ARR=mstrmojo.array,$CSS=mstrmojo.css,$VISUTIL=mstrmojo.VisUtility,$ENUM_PROPERTY_NAMES=mstrmojo.models.FormatModel.ENUM_PROPERTY_NAMES,$KPI_PROPERTIES=mstrmojo.kpicard.KPI_PROPERTIES,$TEXT_SIZE_TYPE=mstrmojo.kpicard.TEXT_SIZE_TYPE,$CAN_SET_FONT_PARTS=mstrmojo.kpicard.CAN_SET_FONT_PARTS,$DISPLAY_MODE=mstrmojo.kpicard.DISPLAY_MODE,$PerfLog=mstrmojo.PerformanceLogOutput,$CTRL_TYPE=mstrmojo.VisEnum.ControlType,CSS_LOADED=false,ExternalLibraries=["libraries/echarts.common.min.js","libraries/jquery.min.js","libraries/slick/slick.min.js"],ExternalCss=["libraries/slick/slick.css","libraries/slick/slick-theme.css"];var DISPLAY_MODE_CLASS_NAME=["kpicard.layout.StackedLayout","kpicard.layout.SmartLayout","kpicard.layout.HorizontalLayout","kpicard.layout.VerticalLayout","kpicard.layout.GridLayout"];var KPI_STYLE_MAP={"1":"light-style","2":"night-style","3":"desert-style","4":"ocean-style"};var VISKPI_ATTACHED_EVENTS=["click","contextmenu","mousemove"];function compareNumbers(a,b){return a-b;}function getMedianValue(arr){if(arr&&arr.length){var mid=(arr.length-1)/2;arr.sort(compareNumbers);return(arr[Math.ceil(mid)]+arr[Math.floor(mid)])/2;}return NaN;}mstrmojo.kpicard.VisKPICard=mstrmojo.declare(mstrmojo.VisBase,[mstrmojo._VizSelectionHelper,mstrmojo.vi.ui.rw._HasVisSelections,mstrmojo.vi.ui.rw.selectors._IsMultiUnitControl,mstrmojo.vi.ui.rw.selectors._BrushesAndHighlights,mstrmojo.vi._MonitorsAppState,mstrmojo.kpicard._SupportKPICardBrushesAndHighlights,mstrmojo.util.ui._LassoSelector,mstrmojo.vi.ui.rw._XtabDE,mstrmojo.ui.menus._HasMenuPopup,mstrmojo.kpicard._KPICardProperty,mstrmojo.kpicard._KPICardDataModel,mstrmojo.kpicard._KPICardInteractivity],{scriptClass:"mstrmojo.kpicard.VisKPICard",cssClass:"kpicard-widget",isPercentNumberStyle:undefined,layoutor:undefined,normalizedIdCache:{},markupString:'<div id="{@id}" class="{@cssClass}" style="position:absolute; width:{@width}px; height:{@height}px; left:{@left}px; top:{@top}px; z-index: {@zIndex};" mstrAttach:'+VISKPI_ATTACHED_EVENTS.join(",")+"></div>",selectedCards:null,contextMenuSelections:null,colorThresholds:null,unifyMetricNameSize:null,unifyMetricValueSize:null,unifyPrevMetricSize:null,unifyBadgeSize:null,plusMinus:null,clickFromSingleKPICard:false,tooltipWin:undefined,tooltipCont:undefined,tooltipPos:{},markupSlots:{containerNode:function(){return this.domNode;}},init:function init(props){this._super(props);if(!this.tooltipWin){this.tooltipWin=new mstrmojo.VisTooltip();this.tooltipWin.render();}this.loadDependCss();},requirePreload:true,getFonts:function getFonts(){var fontProps=this.getFormatPropertyValue($KPI_PROPERTIES.NEW_FONT);var previous=[];var fontArr=[];$HASH.forEach(fontProps,function(value){var ff=value[$ENUM_PROPERTY_NAMES.FONT_FAMILY];if(previous.indexOf(ff)<0){fontArr.push({name:ff,isItalic:false,isBold:false});fontArr.push({name:ff,isItalic:false,isBold:true});previous.push(ff);}});return fontArr;},update:function(node){var modelData,egt,eg,isPauseMode=this.excludeData,continueUpdate=this._super(node);if(continueUpdate!==false){this.clearError();modelData=this.model.data||{};egt=modelData.egt;eg=modelData.eg;if((egt!==undefined||eg!==undefined)&&!isPauseMode){this.setError(eg,egt);}this.checkData();this.modelData=modelData;}return continueUpdate;},postBuildRendering:function postBuildRendering(){$PerfLog.visPrint("VisKPICard PostBuildRendering Start");$PerfLog.startTimer({functionName:"VisKPICard.postBuildRendering: ",purpose:"from Build to End"},"timerid_KPI_fromBuildtoEnd");if(this.waitingForData){return ;}if(this.isEmpty()||this.excludeData){this._super();return ;}this.initColorThresholds();if(!this.hasRendered||!this.isResizing){this.createModelForSingleKPI();}delete this.isResizing;this.plot();var exp=this.getExp(),gtsModel=this.getRowsAndCols();$VISUTIL.modifyScExp(exp,gtsModel,this.model,this.normalizedIdCache);if(this._super){this._super();}this.registerLassoSelector(this.domNode,[$CTRL_TYPE.KPI_V_SCROLLBAR,$CTRL_TYPE.KPI_H_SCROLLBAR],false);$PerfLog.endTimer("timerid_KPI_fromBuildtoEnd");$PerfLog.recordJSHeapMemory("KPI Memory usage at the end");},refresh:function refresh(postUnrender,isResize){if(isResize){this.isResizing=true;}this._super(postUnrender);},resetSelections:function resetSelections(){this.selectedCards=[];this.contextMenuSelections=[];},loadDependLibraries:function loadDependLibraries(){var widgetId=this.id,jsRoot=mstrmojo.getJsRoot(),libs=[];if(mstrApp.isSingleTier){jsRoot="file://"+jsRoot;}if(!window.echarts){libs.push({url:jsRoot+ExternalLibraries[0],forceReload:false});}if(!window.jQuery){libs.push({url:jsRoot+ExternalLibraries[1],forceReload:false});}if(!(window.jQuery&&window.jQuery.fn.slick)){libs.push({url:jsRoot+ExternalLibraries[2],forceReload:false});}this.requiresExternalScripts(libs,function(){var kpiViz=mstrmojo.all[widgetId];if(kpiViz){kpiViz.plot();}});},loadDependCss:function loadDependCss(){var jsRoot;if(!CSS_LOADED){jsRoot=mstrmojo.getJsRoot();mstrmojo.insertCSSLinks($ARR.map(ExternalCss,function(link){return jsRoot+link;}));CSS_LOADED=true;}},setError:function(msg,type){var translatedError=$VISUTIL.translateGridError(msg,type);this.error=translatedError.msg;this.errorType=translatedError.type;},clearError:function(){this.error=undefined;this.errorType=undefined;},hasError:function(){return this.error!==undefined||this.errorType!==undefined;},isEmpty:function(){return this.hasError();},getVisEmptyMsgControls:function(){return $VISUTIL.getVisEmptyMsgControls.call(this);},unifyNodeFontSize:function unifyNodeFontSize(nodeName){var size=this.getUnifiedNodeFontSize(nodeName);var textSizeType=this.getFormatPropertyValue($KPI_PROPERTIES.TEXT_SIZE_TYPE);var font=this.getFormatPropertyValue($KPI_PROPERTIES.NEW_FONT);if(textSizeType===$TEXT_SIZE_TYPE.FIXED){return ;}var unifyChecked=textSizeType===$TEXT_SIZE_TYPE.UNIFIED;var unifySteps;switch(nodeName){case"metricValueNode":this.unifyMetricValueSize=size;unifySteps=font[$CAN_SET_FONT_PARTS.PRIMARY_VALUE][$KPI_PROPERTIES.UNIFY_STEPS];break;case"metricNameNode":this.unifyMetricNameSize=size;unifySteps=font[$CAN_SET_FONT_PARTS.LABEL][$KPI_PROPERTIES.UNIFY_STEPS];break;case"prevMetricNode":this.unifyPrevMetricSize=size;unifySteps=font[$CAN_SET_FONT_PARTS.PREVIOUS_VALUE][$KPI_PROPERTIES.UNIFY_STEPS];break;case"compareNode":this.unifyBadgeSize=size;unifySteps=font[$CAN_SET_FONT_PARTS.TREND_IDENTITY][$KPI_PROPERTIES.UNIFY_STEPS];break;}this.layoutor.forEachChild(function(kpiCard){if(nodeName==="compareNode"){kpiCard.unifyBadgeTextSize(unifyChecked,Number(unifySteps));}else{kpiCard.resetNodeTextSize(kpiCard[nodeName],unifyChecked,size,Number(unifySteps));}});},initUnifiedSize:function(partArr){if(!partArr||partArr.indexOf($CAN_SET_FONT_PARTS.LABEL)>-1){this.unifyMetricNameSize=this.getUnifiedNodeFontSize("metricNameNode");}if(!partArr||partArr.indexOf($CAN_SET_FONT_PARTS.PRIMARY_VALUE)>-1){this.unifyMetricValueSize=this.getUnifiedNodeFontSize("metricValueNode");}if(!partArr||partArr.indexOf($CAN_SET_FONT_PARTS.PREVIOUS_VALUE)>-1){this.unifyPrevMetricSize=this.getUnifiedNodeFontSize("prevMetricNode");}if(!partArr||partArr.indexOf($CAN_SET_FONT_PARTS.TREND_IDENTITY)>-1){this.unifyBadgeSize=this.getUnifiedNodeFontSize("compareNode");}},modifyFontSize:function(partArr){this.initUnifiedSize(partArr);this.layoutor.forEachChild(function(kpiCard){kpiCard.applyUnifySteps("init",partArr);});},getUnifiedNodeFontSize:function(nodeName){var fontSizes=[],fontSize;this.layoutor.forEachChild(function(kpiCard){fontSize=parseFloat(kpiCard[nodeName].style.fontSize);if(!isNaN(fontSize)){fontSizes.push(fontSize);}});return getMedianValue(fontSizes);},plot:function(){var containerNode=this.containerNode,div=document.createElement("div"),child,props,className,LayoutClass,displayMode,initialElemId,fmts=this.fmts,bgColor=fmts&&fmts["background-color"];this.resetSelections();containerNode.innerHTML="";containerNode.className=this.cssClass;initialElemId=this.getFormatPropertyValue($KPI_PROPERTIES.CURRENT_SLIDE_ELEMENT);containerNode.appendChild(div);props={parent:this,placeholder:div,width:parseInt(this.width)+"px",height:parseInt(this.height)+"px",enableAutoPlay:this.getFormatPropertyValue($KPI_PROPERTIES.AUTO_PLAY),singleKPIModels:this.singleKPIModels,widgetId:this.id,initialElemId:initialElemId};displayMode=this.getFormatPropertyValue($KPI_PROPERTIES.DISPLAY_MODE);this.lassoSelectorEnabled=(displayMode!==$DISPLAY_MODE.STACKED&&this.singleKPIModels.length>1);if(this.singleKPIModels.length===1||displayMode===$DISPLAY_MODE.STACKED){$CSS.toggleClass(containerNode,"one-card",true);}this.removeLayout();className=DISPLAY_MODE_CLASS_NAME[parseInt(displayMode)-1];LayoutClass=$HASH.walk(className,mstrmojo);child=new LayoutClass(props);this.addChildren([child]);if(!child.hasRendered){child.render();}this.layoutor=child;if(this.getFormatPropertyValue($KPI_PROPERTIES.TEXT_SIZE_TYPE)!==$TEXT_SIZE_TYPE.FIXED){this.modifyFontSize();}this.applyColorThresholds();if(bgColor){this.updateBorderColor(bgColor);}},isInStackedMode:function isInStackedMode(){var displayMode=this.getFormatPropertyValue($KPI_PROPERTIES.DISPLAY_MODE),layoutor=this.layoutor,singleKPIModels=layoutor.singleKPIModels,hasMultipleSlides=singleKPIModels&&singleKPIModels.length>1;return displayMode===$DISPLAY_MODE.STACKED&&hasMultipleSlides;},isStackedAutoPlay:function isStackedAutoPlay(){return this.getFormatPropertyValue($KPI_PROPERTIES.AUTO_PLAY);},applyNewStyle:function applyNewStyle(propVal){var v,style,containerNode=this.containerNode;for(v in KPI_STYLE_MAP){style=KPI_STYLE_MAP[v];if(v===propVal){$CSS.toggleClass(containerNode,style,true);}else{$CSS.toggleClass(containerNode,style,false);}}},initColorThresholds:function initColorThresholds(){var colorThresholdsProp=this.readColorThresholdsProp(),colorThresholds=colorThresholdsProp&&colorThresholdsProp.thresholds;this.colorThresholds=colorThresholds||[];},addColorThreshold:function addColorThreshold(color){var enabled=true,colorThreshold,colorThresholdsProp,colorThresholds=this.colorThresholds,colorThresholdsPropStr;colorThreshold={min:undefined,max:undefined,color:color,enabled:enabled};colorThresholds.push(colorThreshold);colorThresholdsProp={thresholds:colorThresholds};colorThresholdsPropStr=JSON.stringify(colorThresholdsProp);this.writeProperties($KPI_PROPERTIES.COLOR_THRESHOLDS,colorThresholdsPropStr);},updateColorThresholds:function updateColorThresholds(){var colorThresholdsProp,colorThresholds=this.colorThresholds,colorThresholdsPropStr;colorThresholdsProp={thresholds:colorThresholds};colorThresholdsPropStr=JSON.stringify(colorThresholdsProp);this.writeProperties($KPI_PROPERTIES.COLOR_THRESHOLDS,colorThresholdsPropStr);},setColorThresholdProperty:function setColorThresholdProperty(idx,property,value){var colorThreshold,colorThresholds=this.colorThresholds;if(idx>=colorThresholds.length||idx<0){return ;}colorThreshold=colorThresholds[idx];colorThreshold[property]=value;this.updateColorThresholds();},removeColorThreshold:function removeColorThreshold(idx){this.colorThresholds.splice(idx,1);this.updateColorThresholds();},applyColorThresholds:function applyColorThresholds(sc){var i,colorThresholds=this.colorThresholds,colorThreshold,colorThresholdCount=colorThresholds.length,layoutor=this.layoutor;if(!layoutor){return ;}var iterateFunc=layoutor.forEachChild.bind(layoutor);if(sc){iterateFunc=$ARR.forEach.bind($ARR,[sc]);}iterateFunc(function(singleCard){singleCard.clearColorThreshold();});if(!colorThresholdCount){return ;}iterateFunc(function(singleCard){for(i=0;i<colorThresholdCount;i+=1){colorThreshold=colorThresholds[i];if(colorThreshold.enabled){singleCard.applyColorThreshold(i,colorThreshold);}}});},readColorThresholdsProp:function readColorThresholdsProp(){var colorThresholdsPropStr=this.getFormatPropertyValue($KPI_PROPERTIES.COLOR_THRESHOLDS);return colorThresholdsPropStr&&JSON.parse(colorThresholdsPropStr);},getDefaultFontFamily:function getDefaultFontFamily(){var themeProps=mstrApp&&mstrApp.getThemeProps("KPI");return(themeProps&&themeProps.fontFamily)||"Open Sans";},getDefaultFontColor:function getDefaultFontColor(){var kpiStyle=this.getFormatPropertyValue($KPI_PROPERTIES.KPI_STYLE);var themeProps=mstrApp&&mstrApp.getThemeProps("KPI");var defaultFontClr=themeProps&&themeProps.defaultFontClr;return(defaultFontClr&&defaultFontClr[kpiStyle])||"#35383A";},isClearAllEnabled:function isClearAllEnabled(){var modelData=this.modelData||{},sc=modelData.sc;return !!(sc===undefined||sc.showall);},unrender:function unrender(){var lastOpened=this._lastOpened;if(lastOpened){this.closePopup();}if(this._super){this._super();}this.removeLayout();},removeLayout:function removeLayout(){if(this.layoutor){this.removeChildren(this.layoutor);this.layoutor.destroy();this.layoutor=null;}},getSortRows:function getSortRows(){var xtabModel=this.model,data=xtabModel&&xtabModel.data,gsi=data&&data.gsi,sorts=gsi&&gsi.sorts;return sorts&&sorts[0];},onBEMFormatChange:function onBEMFormatChange(evt){var propertyName=evt&&evt.propertyName,value=evt&&evt.value;if(!propertyName||!value){return ;}if(propertyName==="bc"){this.updateBorderColor(value);}},updateBorderColor:function updateBorderColor(bgColor){var layoutor=this.layoutor;if(!layoutor){return ;}layoutor.forEachChild(function(kpiCard){kpiCard.updateBorderColor(bgColor);});},onclick:function onclick(event){var ctrlKey=event.ctrlKey||event.metaKey;if(this.clickFromSingleKPICard){this.clickFromSingleKPICard=false;return ;}if(this.clickFromCreatingLasso){return ;}if(!ctrlKey&&!this.contextMenuDismiss){this.clearSelectedCards();this.prepareLMCSelectionData();this.endSelections();}this.contextMenuDismiss=false;},oncontextmenu:function oncontextmenu(){this.contextMenuDismiss=false;},onmousemove:function onmousemove(evt){this.updateTooltipPos(evt.e.pageX,evt.e.pageY);},destroy:function destroy(skipCleanup){var tooltipWin=this.tooltipWin;if(tooltipWin){tooltipWin.hide();this.tooltipWin=undefined;}this._super(skipCleanup);}});}());