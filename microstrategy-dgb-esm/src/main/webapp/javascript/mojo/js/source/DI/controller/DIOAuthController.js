(function(){mstrmojo.requiresCls("mstrmojo.dom","mstrmojo.DI.DIConstants","mstrmojo.DI.DIHelpers");mstrmojo.requiresDescs(12604,12605,12607,12608,12893,12894,12895,12896,13302,13994,16025);var constants=mstrmojo.DI.DIConstants,helpers=mstrmojo.DI.DIHelpers,$DOM=mstrmojo.dom,$HASH=mstrmojo.hash;function updateSalesForceLogoutIframe(src){var ifmID="oAuthSourcelogout";var ifm=document.getElementById(ifmID);if(!ifm){ifm=document.createElement("IFRAME");ifm.id=ifmID;document.body.appendChild(ifm);ifm.style.display="none";}ifm.src=src;}function getOAuthCallbackURLOrigin(url){var callbackURIReg=/&?redirect_uri=([^&]*)&?/;var originReg=/^((https|http):\/\/[^\/]+)\/?/;var matches,callbackURL,callbackOrigin;matches=callbackURIReg.exec(url);if(matches){callbackURL=window.decodeURIComponent(matches[1]);matches=originReg.exec(callbackURL);if(matches){callbackOrigin=matches[1];}}return callbackOrigin;}function getDIRootCtrl(){var rootController=this.getRootController();return rootController.CDDIcontroller?rootController.CDDIcontroller:rootController;}mstrmojo.DI.controller.DIOAuthController=mstrmojo.declare(mstrmojo.Obj,null,{popupWnd:null,responseHandler:null,beforeOAuth:function(){var r;if(!this.popupWnd||this.popupWnd.closed){r=helpers.createOAuthPopupWindow();this.popupWnd=r.wnd;}return !!this.popupWnd;},afterOAuth:function(){var that=this;window.setTimeout(function(){if(that.popupWnd&&!that.popupWnd.closed){that.popupWnd.close();}that.popupWnd=null;},0);},getExternalSourcesInfo:function getExternalSourcesInfo(){var controller=mstrApp.getRootController(),model=controller.getModel(),url=window.location.href.toLowerCase(),urlParams=helpers.getURLParameters(url);if(window.opener&&(url.indexOf("code=")>=0||url.indexOf("oauth_token")>=0||url.indexOf("accesstoken")>=0||url.indexOf("denied=")>=0||url.indexOf("access_denied")>=0||(urlParams.state&&urlParams.state.toUpperCase()==="OC"))){model.set("operationMode",constants.operationMode.oauth);helpers.sendResponse2Window(window.location.href);}else{if(window.opener&&(mstrApp.diParams.code||url.indexOf("authenticated=")>=0)){model.set("operationMode",constants.operationMode.oauth);helpers.sendResponse2Window(window.location.href+"&code="+mstrApp.diParams.code);}else{model.populateExternalSources();controller.restoreForLaunchingApp();}}},oAuthSignOut:function oAuthSignOut(type){var controller=mstrApp.getRootController(),oAuthSource=controller.model.externalSources[type],params={},curSlot,slot,pageConfig,url,intType=parseInt(type,10);var callback={success:function(){var windowOptions;oAuthSource.reset();if(intType===constants.sourceType.facebook){windowOptions=helpers.getPopupWindowOptions();window.open("https://www.facebook.com","",windowOptions);return ;}slot=controller.navigationController.getPageSlot();if(pageConfig){slot.setConfig(pageConfig);}controller.getOAuthSourceReports(type,false,slot);}};if(!oAuthSource){controller.displayError(mstrmojo.desc(12608,"Could not log out. Please do so by manually going to the website"),false);}if(helpers.isIE7()&&intType===constants.sourceType.salesforce){window.location.href="https://embedexpress-dev-ed.my.salesforce.com/secur/logout.jsp";}else{switch(intType){case constants.sourceType.dropbox:updateSalesForceLogoutIframe("https://www.dropbox.com/logout");break;case constants.sourceType.googleDrive:updateSalesForceLogoutIframe("https://www.google.com/accounts/logout");break;case constants.sourceType.googleAnalytics:updateSalesForceLogoutIframe("https://www.google.com/accounts/logout");break;case constants.sourceType.salesforce:url="https://embedexpress-dev-ed.my.salesforce.com/secur/logout.jsp";if(oAuthSource.instanceUrl){url=oAuthSource.instanceUrl+"/secur/logout.jsp";}updateSalesForceLogoutIframe(url);break;case constants.sourceType.twitter:updateSalesForceLogoutIframe("https://twitter.com/logout");break;}if(controller.rootView.currentPage){curSlot=controller.navigationController.getPageSlot(controller.rootView.currentPage.pageSlotKey);pageConfig=curSlot.getConfig();}if(controller.rootView.currentPage&&controller.rootView.currentPage.tableID){controller.showPage(constants.pageType.emmaPreview);}else{if(controller.rootView.currentPage){controller.showPage(constants.pageType.dataSelection);}}}params.dbRoleID=oAuthSource.dbRoleID;if(oAuthSource.sourceAccountID){params.sourceAccountID=oAuthSource.sourceAccountID;}controller.dataService.signOutOAuthSource(callback,params);},oneTierOAuth:function oneTierOAuth(sourceType,forceRefreshTokenFetch,slot,cb){this.sourceType=sourceType;this.slot=slot;this.getWebServiceURL(sourceType,forceRefreshTokenFetch,slot,cb);},getWebServiceURL:function getWebServiceURL(sourceType,forceRefreshTokenFetch,slot,cb){var sourceTypeEnum=constants.sourceType,DIController=getDIRootCtrl.call(window.mstrApp),me=this,externalSource=DIController.model&&DIController.model.externalSources[sourceType],responseHandler=function OAuthResponseHandler(evt){var url,urlParams,msg=mstrmojo.desc(13302,"This app is blocked by admin in Salesforce.");if(mstrApp.originUrl.indexOf(evt.origin)>=0){me.afterOAuth();$DOM.detachEvent(window,"message",me.responseHandler);me.responseHandler=null;if(sourceType===constants.sourceType.salesforce){url=evt&&evt.data;urlParams=helpers.getURLParameters(url);if(urlParams.error&&urlParams.error==="OAUTH_APP_BLOCKED"){DIController.displayError(mstrmojo.desc(12607,"Uh-Oh, Error fetching the list of reports from the external source"),false,msg);return ;}}me.getWebServiceCatalog(sourceType,evt.data,slot,cb);}};var callback={success:function(res){var authURL;if(res.url){authURL=res.url;}else{authURL=res;}if(helpers.isServerBasedWS()){var newRedirectURL;if(sourceType===constants.sourceType.twitter){newRedirectURL="http://127.0.0.1";}else{if(sourceType===constants.sourceType.facebook){newRedirectURL="http://localhost/";}else{newRedirectURL="http://localhost";}}authURL=authURL.replace(/(redirect_uri=).*?(&)/,"$1"+newRedirectURL+"$2");}if(!authURL||authURL.length===0){$DOM.detachEvent(window,"message",me.responseHandler);me.responseHandler=null;DIController.displayError(mstrmojo.desc(12893,"Oops Unable to get the authorization URL for the given webservice. Please contact your administrator"));return ;}if(forceRefreshTokenFetch&&(sourceType===sourceTypeEnum.googleDrive||sourceType===sourceTypeEnum.googleAnalytics||sourceType===sourceTypeEnum.googleBigQuery)){if(authURL.indexOf("approval_prompt=force")<0){authURL+="&approval_prompt=force";}}if(mstrApp.isCloud){var location=window.location,protocol=location.protocol,shardHost=location.hostname,port=location.port,pathparams=location.pathname.split("/");var app=pathparams&&pathparams.length!==0&&pathparams[1],envString="ptc_"+protocol+"shrd_"+shardHost+":port_"+port+":app_"+app;authURL+=("&state="+envString);}if(mstrmojo.getCSRFToken()){authURL+=("&state=validateRandNum"+mstrmojo.getCSRFToken());}if(!helpers.getEnvObj().isWS()){var callbackURLOrigin=getOAuthCallbackURLOrigin(authURL);var currentOrigin=window.location.origin;if(callbackURLOrigin!==undefined&&callbackURLOrigin!==currentOrigin){var errMsg=mstrmojo.desc(16025,"The OAuth Callback URL origin # does not match current origin ##. This might not bring you back to current Web. Please modify the Callback URL to make it work properly.");errMsg=errMsg.replace("#",callbackURLOrigin).replace("##",currentOrigin);DIController.displayError(errMsg,false,null,function(){me.openAuthWindow(authURL);});return ;}}me.openAuthWindow(authURL);},failure:function(res){$DOM.detachEvent(window,"message",me.responseHandler);this.responseHandler=null;me.afterOAuth();DIController.displayError(mstrmojo.desc(12893,"Oops Unable to get the authorization URL for the given webservice. Please contact your administrator"),false,res.message);DIController.showPage(constants.pageType.dataSelection);}};if(helpers.isIE()){window.postMessagePassthrough=function(response,origin){responseHandler({origin:origin,data:response});};}if(me.responseHandler){$DOM.detachEvent(window,"message",me.responseHandler);}$DOM.attachEvent(window,"message",responseHandler);this.responseHandler=responseHandler;var params={dbRoleID:externalSource.dbRoleID,scope:externalSource.scope,flags:4};DIController.dataService.getWebServiceURL(callback,params);},openAuthWindow:function(authURL){var me=this,DIController=getDIRootCtrl.call(window.mstrApp);me.popupWnd=helpers.openPopupWindow(me.popupWnd,"Authorization",authURL);if(!me.popupWnd){$DOM.detachEvent(window,"message",me.responseHandler);me.responseHandler=null;DIController.displayError(mstrmojo.desc(12894,"Your browser has blocked the popup for this site. Please enable the popup for this site in order to continue and sign in."),false);return ;}else{var loop=setInterval(function(){if(me.popupWnd&&me.popupWnd.closed){clearInterval(loop);$DOM.detachEvent(window,"message",me.responseHandler);me.responseHandler=null;}},500);}},oneTierOAuthHandler:function oneTierOAuthHandler(code){this.afterOAuth();if(code.search("access_denied")<0&&code.search("denied")<0){this.getWebServiceCatalog(this.sourceType,code,this.slot);}},getWebServiceCatalogCallback:function getWebServiceCatelogCallback(type,slot,cb){var DIController=getDIRootCtrl.call(window.mstrApp);var oAuth=this;var model=DIController.model||{},oAuthSource=model.externalSources&&model.externalSources[type],currentSourceType=type,tableID,slotCfg,importSource,xdaType,dialog;return{success:function(res){if(!oAuthSource.sourceAccountID&&res.mi.sinf.said){oAuthSource.sourceAccountID=res.mi.sinf.said;}if(model.operationMode===constants.operationMode.subscribe){DIController.readyForSubscription();}else{if(model.operationMode===constants.operationMode.enterCredentials){DIController.model.updateDocumentCredentials(oAuth.tableIDs,true);}else{if(model.operationMode===constants.operationMode.refresh||model.isInputCredential){oAuthSource.populateReports(res,undefined,true);}else{var sourceInfo=model.externalSources;switch(currentSourceType){case constants.sourceType.twitter:oAuthSource.populateReports(res);DIController.showPage(constants.pageType.twitter,sourceInfo[currentSourceType],slot);break;case constants.sourceType.facebook:oAuthSource.populateReports(res);DIController.showPage(constants.pageType.facebook,sourceInfo[currentSourceType],slot);break;case constants.sourceType.dropbox:case constants.sourceType.googleDrive:case constants.sourceType.salesforce:case constants.sourceType.googleAnalytics:DIController.showPage(constants.pageType.sourceObjectsDnD,sourceInfo[currentSourceType],slot);oAuthSource.populateReports(res);break;case constants.sourceType.googleBigQuery:slotCfg=slot&&slot.getConfig&&slot.getConfig();tableID=slotCfg&&slotCfg.properties&&slotCfg.properties.tableID;importSource=tableID&&model.getImportSource(tableID);xdaType=(importSource&&importSource.xdaType)||mstrApp.bigQueryXdatype;oAuthSource.populateReports(res,null,mstrApp.isVI);window.setTimeout(function(){DIController.showPage(constants.pageType.database,{sourceType:constants.sourceType.googleBigQuery,type:xdaType},slot);dialog=DIController.rootView.parent;if(dialog&&dialog.editorNode){$DOM.center(dialog.editorNode);}},1);break;}}}}cb&&cb.success&&cb.success();},failure:function(res){var errorCode=parseInt(res.code||(res.getResponseHeader?res.getResponseHeader("X-MSTR-TaskErrorCode"):-1),10);DIController.closePageDialog();if(model.operationMode===constants.operationMode.enterCredentials){DIController.model.updateDocumentCredentials(this.tableIDs,false);}if(errorCode===constants.backendError.refreshTokenUnavailable){DIController.displayError(mstrmojo.desc(12607,"Uh-Oh, Error fetching the list of reports from the external source"),false,res.message);}else{if(errorCode===constants.backendError.noExternalSession){DIController.displayError(mstrmojo.desc(12607,"Uh-Oh, Error fetching the list of reports from the external source"),false,res.message);}else{if(errorCode===constants.backendError.noExternalSourceInfo&&currentSourceType===constants.sourceType.googleAnalytics){var msg=mstrmojo.desc(12895,"Could not find a Google Analytics account for your account. Please sign in with a different account.");mstrmojo.alert(msg,function(){DIController.oAuthSignOut(currentSourceType);});}else{DIController.displayError(mstrmojo.desc(12607,"Uh-Oh, Error fetching the list of reports from the external source"),false,res.message);if(model.operationMode!==constants.operationMode.enterCredentials){DIController.showPage(constants.pageType.dataSelection);}}}}cb&&cb.failure&&cb.failure();}};},getWebServiceCatalog:function getWebServiceCatalog(type,code,slot,cb){var DIController=getDIRootCtrl.call(mstrApp);var oAuthSource=DIController.model.externalSources[type],params={dbRoleID:oAuthSource.dbRoleID,code:code};params.flags=constants.sourcesInfoFlags.getReports|constants.sourcesInfoFlags.getUserName;if(type===constants.sourceType.googleAnalytics){params.flags=params.flags|constants.sourcesInfoFlags.getGAnalyticsAccount;}if(type===constants.sourceType.googleBigQuery){params.flags=constants.sourcesInfoFlags.getGAnalyticsAccount|constants.sourcesInfoFlags.getUserName;}if(type===constants.sourceType.salesforce){params.flags|=constants.sourcesInfoFlags.getTokensInfo;}if(this.tableIDs&&this.tableIDs[0]){params.tableIDs=this.tableIDs;}params.isWorkstation=helpers.isServerBasedWS();DIController.dataService.getWebServiceCatalog(this.getWebServiceCatalogCallback(type,slot,cb),params);},getAnalyticsWebProperties:function getAnalyticsWebProperties(accountID){var controller=mstrApp.getRootController();var oAuthSource=controller.model.externalSources[constants.sourceType.googleAnalytics];var params=oAuthSource.getSourceParams();params.gaAccountID=accountID;params.gaWebPropertyID="";params.flags=constants.sourcesInfoFlags.getGAnalyticsAccount;if(oAuthSource.checkWebProperties(accountID,true)){controller.getAnalyticsProfiles(accountID,oAuthSource.getAccountById(accountID).webProperties[0].id);return ;}var callback={success:function(res){oAuthSource.onGetAnalyticsWebProperties[accountID]=false;oAuthSource.populateWebProperties(res,accountID);controller.getAnalyticsProfiles(accountID,oAuthSource.getAccountById(accountID).webProperties[0].id);},failure:function(){controller.displayError(mstrmojo.desc(12604,"Unable to fetch Analytics web properties."),false);}};if(!oAuthSource.onGetAnalyticsWebProperties[accountID]){oAuthSource.onGetAnalyticsWebProperties[accountID]=true;controller.dataService.getOAuthSourceReports(callback,params);}},getAnalyticsProfiles:function getAnalyticsProfiles(accountID,webPropertyID){var controller=mstrApp.getRootController();var oAuthSource=controller.model.externalSources[constants.sourceType.googleAnalytics];var params=oAuthSource.getSourceParams();params.gaAccountID=accountID;params.gaWebPropertyID=webPropertyID;params.flags=constants.sourcesInfoFlags.getGAnalyticsAccount;if(oAuthSource.checkProfiles(accountID,webPropertyID,true)){return ;}var callback={success:function(res){oAuthSource.onGetAnalyticsProfiles[accountID+":"+webPropertyID]=false;oAuthSource.populateProfiles(res,accountID,webPropertyID);},failure:function(){controller.displayError(mstrmojo.desc(12605,"Unable to fetch Analytics profiles."),false);}};if(!oAuthSource.onGetAnalyticsProfiles[accountID+":"+webPropertyID]){oAuthSource.onGetAnalyticsProfiles[accountID+":"+webPropertyID]=true;controller.dataService.getOAuthSourceReports(callback,params);}},getOAuthSourceReports:function getOAuthSourceReports(type,sendOAuthDetails,slot,query,cb){var controller=mstrApp.getRootController();var oAuthSource=controller.model.externalSources[type],params={},currentSourceType=type,model=controller.model,tableID,slotCfg,footerConfig,importSource,xdaType,dialog;if(!oAuthSource){return ;}if(sendOAuthDetails){params=oAuthSource.getSourceParams();if(type===constants.sourceType.googleAnalytics){params.gaAccountID="";params.gaWebPropertyID="";params.flags=constants.sourcesInfoFlags.getGAnalyticsAccount|constants.sourcesInfoFlags.getReports|constants.sourcesInfoFlags.getTokensInfo|constants.sourcesInfoFlags.getUserName;}}else{params.dbRoleID=oAuthSource.dbRoleID;if(oAuthSource.sourceAccountID){params.sourceAccountID=oAuthSource.sourceAccountID;}}if(type===constants.sourceType.googleAnalytics){params.flags=constants.sourcesInfoFlags.getGAnalyticsAccount|constants.sourcesInfoFlags.getReports|constants.sourcesInfoFlags.getTokensInfo|constants.sourcesInfoFlags.getUserName;}if(type===constants.sourceType.googleBigQuery){params.flags=constants.sourcesInfoFlags.getGAnalyticsAccount|constants.sourcesInfoFlags.getTokensInfo|constants.sourcesInfoFlags.getUserName;}if(type===constants.sourceType.facebook){params.fbPageSearchQuery=query;}slotCfg=slot&&slot.getConfig&&slot.getConfig();footerConfig=slotCfg&&slotCfg.footerConfig;var callback=cb||{success:function(res){if(!oAuthSource.sourceAccountID&&res.mi.sinf.said){oAuthSource.sourceAccountID=res.mi.sinf.said;}if(model.operationMode===constants.operationMode.subscribe){controller.readyForSubscription();}else{var sourceInfo=model.externalSources;switch(currentSourceType){case constants.sourceType.twitter:oAuthSource.populateReports(res);controller.showPage(constants.pageType.twitter,sourceInfo[currentSourceType],slot,footerConfig);break;case constants.sourceType.facebook:oAuthSource.populateReports(res);controller.showPage(constants.pageType.facebook,sourceInfo[currentSourceType],slot,footerConfig);break;case constants.sourceType.dropbox:case constants.sourceType.googleDrive:case constants.sourceType.salesforce:case constants.sourceType.googleAnalytics:controller.showPage(constants.pageType.sourceObjectsDnD,sourceInfo[currentSourceType],slot,footerConfig);oAuthSource.populateReports(res);break;case constants.sourceType.googleBigQuery:tableID=slotCfg&&slotCfg.properties&&slotCfg.properties.tableID;importSource=tableID&&model.getImportSource(tableID);xdaType=(importSource&&importSource.xdaType)||mstrApp.bigQueryXdatype;oAuthSource.populateReports(res);window.setTimeout(function(){controller.showPage(constants.pageType.database,{sourceType:constants.sourceType.googleBigQuery,type:xdaType},slot,footerConfig);dialog=controller.rootView.parent;if(dialog&&dialog.editorNode){$DOM.center(dialog.editorNode);}},1);break;}}},failure:function(res){var errorCode=parseInt(res.code||(res.getResponseHeader&&res.res.getResponseHeader("X-MSTR-TaskErrorCode")),10);if(errorCode===constants.backendError.refreshTokenUnavailable){controller.gotoOAuthLogin(currentSourceType,true,slot);}else{if(errorCode===constants.backendError.noExternalSession&&(!sendOAuthDetails)){controller.gotoOAuthLogin(currentSourceType,false,slot);}else{if(errorCode===constants.backendError.noExternalSourceInfo&&currentSourceType===constants.sourceType.googleAnalytics){var msg=mstrmojo.desc(12896,"Could not find a Google Analytics account for ####. Please sign in with a different account.").replace("####",oAuthSource.userDisplayName);mstrmojo.alert(msg,function(){controller.oAuthSignOut(currentSourceType);});}else{controller.displayError(mstrmojo.desc(12607,"Uh-Oh, Error fetching the list of reports from the external source"),false,res&&res.message);controller.showPage(constants.pageType.dataSelection);}}}}};if(!params.userDisplayName){delete params.userDisplayName;}if(!params.instanceURL){delete params.instanceURL;}controller.dataService.getOAuthSourceReports(callback,params);},getOAuthSourceFolderContents:function getOAuthSourceFolderContents(type,params,callback){var controller=mstrApp.getRootController();var oAuthSource=controller.model.externalSources[type];var baseParams=oAuthSource.getSourceParams();controller.dataService.getOAuthSourceReports(callback,$HASH.copy(params,baseParams));},oAuthSourceBrowserFunction:function(type,node,path,address){var controller=mstrApp.getRootController();var callback={success:function(res){var list=controller.parseOAuthSourceFolder(type,res);node.data.browser.set("fileList",list);if(path){var items=node.items,i;var folders=items,reports=items;var index=path.indexOf("/",1);if(index!==-1){var folderName=path.substring(1,index);for(i=0;i<folders.length;i++){if(folders[i].isFolder===true&&folders[i].n===folderName){node.data.browser.autoSelectNode(folders[i].node,path.substring(index),address);folders[i].fetched=true;folders[i].node.set("state",1);}}}else{var fileName=path.substring(1);for(i=0;i<reports.length;i++){if(reports[i].isFolder!==true&&reports[i].n===fileName){if(address){if(address===reports[i].address){reports[i].node.data.browser.autoSelectNode(reports[i].node);}}else{reports[i].node.data.browser.autoSelectNode(reports[i].node);}}}}}},failure:function(res){if(node&&node.data){node.set("state",0);node.data.set("fetched",false);}controller.displayError(mstrmojo.desc(12607,"Uh-Oh, Error fetching the list of reports from the external source"),false,res&&res.message);}};this.getOAuthSourceFolderContents(type,{folderName:node.data.address},callback);},oAuthSourceFetchFunction:function oAuthSourceFetchFunction(type,params){var controller=mstrApp.getRootController();var callback={success:function(res){var oAuthSource=mstrApp.getRootController().getModel().externalSources[type];oAuthSource.populateReports(res);},failure:function(res){controller.displayError(mstrmojo.desc(12607,"Uh-Oh, Error fetching the list of reports from the external source"),false,res&&res.message);}};this.getOAuthSourceFolderContents(type,params,callback);},parseOAuthSourceFolder:function parseOAuthSourceFolder(type,res){var oAuthSource=mstrApp.getRootController().getModel().externalSources[type];return oAuthSource.parseOAuthSourceFolder(res);}});}());