(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.string","mstrmojo.elementHelper","mstrmojo.SimpleObjectInputBox","mstrmojo._HasTooltip","mstrmojo.mstr.EnumDSSXMLObjectTypes");var $ARR=mstrmojo.array,$DOM=mstrmojo.dom,$KEYS=mstrmojo.Enum_Keys,$HASH=mstrmojo.hash,$OBJECT_TYPE=mstrmojo.mstr.EnumDSSXMLObjectTypes,thousandsSeperator=mstrConfig.thousandsSep;if(thousandsSeperator===undefined){thousandsSeperator=",";}var ERR_SDK_E_INVALID=2147762227,ERR_SDK_E_PROMPT_NUMERICAL_VALUES=2147762262,ERR_SDK_E_PROMPT_DATE_TIME=2147762269,MAX_SUGGESTION_POPUP_HEIGHT=140,MIN_SUGGESTION_POPUP_WIDTH=118,MAX_SUGGESTION_POPUP_WIDTH=350,SELECT_ALL_ITEM=-100,NO_MATCH_MSG=-101,GET_ELEMENT_FLAG_DERIVED_ELEMENT=64;var markup;mstrmojo.SearchBoxSelectorList=mstrmojo.declare(mstrmojo.SuggestionList,null,{postBuildRendering:function postBuildRendering(){var ret=this._super(),popup=this.parent,id=popup.id;if(!this.onScroll){this.onScroll=function onScroll(){var popup=mstrmojo.all[id],node=popup.domNode;if(!popup.isFetching&&Math.ceil(node.offsetHeight+node.scrollTop)>=node.scrollHeight){popup.isFetching=true;popup.opener.getCandidatesThroughTaskCall({isIncFetch:true},{});}};}var popupNode=popup.domNode;if(popup.supportsIncFetch){$DOM.attachEvent(popupNode,"scroll",this.onScroll);}else{$DOM.detachEvent(popupNode,"scroll",this.onScroll);}return ret;},getItemMarkup:function(item,idx){if(!markup){markup=this._super(item,idx).replace(">{@"+this.itemField+"}<",">{@"+this.itemField+"}{@weight}<");}return markup;},getItemProps:function getItemProps(item,idx){var props=this._super(item,idx),weight=item.wt;props.weight=weight?"<em>("+mstrmojo.num.addSeparators(weight,thousandsSeperator)+" "+this.parent.opener.wtStr+")</em>":"";return props;},onmouseover:function(el,e){var selected=el.e.srcElement;if(selected.scrollWidth<=selected.offsetWidth){selected.title="";}},onclick:function(evt){var suggestionItems=this.parent.opener.suggestionItems,len=suggestionItems.length;this._super(evt);if(len<=1){return ;}var allIdx=$ARR.find(suggestionItems,"t",SELECT_ALL_ITEM),item=this.getItemFromTarget(evt.getTarget());if(item&&item.t&&item.t===SELECT_ALL_ITEM){$ARR.forEach(suggestionItems,function(suggestionItem,index){if(!this.selectedIndices[index]){this.doItemSelect(suggestionItem,{});}},this);}else{if(this.selectedIndices[allIdx]){this.doItemSelect(suggestionItems[allIdx],{});}}}});mstrmojo.SearchBoxSelector=mstrmojo.declare(mstrmojo.SimpleObjectInputBox,[mstrmojo._HasTooltip],{scriptClass:"mstrmojo.SearchBoxSelector",cssClass:"mstrmojo-SearchBoxSelector",srcid:null,srct:$OBJECT_TYPE.Attribute,dataSourcesXML:null,useClientForm:false,maxItemWidth:"",wtStr:"likes",suggestionListClass:"mstrmojo.SearchBoxSelectorList",useRichTooltip:false,postCreate:function postCreate(){var suggestionPopup=$HASH.clone(this.suggestionPopup);suggestionPopup.cssClass="mstrmojo-SearchBoxSelector-suggest";suggestionPopup.nudge=function(){var popupNode=this.domNode,containerNode=this.containerNode;if(!popupNode){return ;}var height=Math.min(containerNode&&containerNode.offsetHeight||MAX_SUGGESTION_POPUP_HEIGHT,(mstrApp&&mstrApp.MAX_SUGGESTION_POPUP_HEIGHT)||MAX_SUGGESTION_POPUP_HEIGHT),width=popupNode.offsetWidth,windowDimensions=$DOM.windowDim(),left=parseInt(this.left,10),top=parseInt(this.top,10);if(top+height>=windowDimensions.h){top=Math.max(top-height-(this.target?this.target.offsetHeight:0),0);if(top+height>=windowDimensions.h){top=5;height=$DOM.getMaxScrollHeight();}}if(left+width>=windowDimensions.w){left=Math.max(left-width,0);}var editorNodeStyle=popupNode.style;editorNodeStyle.top=top+"px";editorNodeStyle.left=left+"px";editorNodeStyle.maxHeight=height+"px";var opener=this.opener,oWidth=opener&&opener.width,curWidth=$DOM.position(popupNode).w;if(oWidth!==undefined&&curWidth<parseInt(oWidth,10)&&editorNodeStyle.maxWidth!==oWidth){editorNodeStyle.maxWidth=oWidth;this.nudge();}};this.suggestionPopup=suggestionPopup;},preBuildRendering:function preBuildRendering(){var width=this.parent.contentNode.offsetWidth||this.parent.width;this.set("maxItemWidth",parseInt(width,10));this._super();},postBuildRendering:function postBuildRendering(){var fmts=this.parent.defn.fmts;if(!fmts.height){this.domNode.style.height="auto";}return this._super();},filterCandidates:function filterCandidates(items,t,max){var filteredCandidates=items,suggestCnt=this.suggestCount;if(!this.noCache){max=max||suggestCnt;if(t==="*"){t="";}else{t=mstrmojo.string.regEscape(t);}var itemField=this.itemField,testExp=new RegExp(t,"i");filteredCandidates=$ARR.filter(items,function(item){return testExp.test(item[itemField]);},{max:max});}if(filteredCandidates.length){$ARR.forEach(this.items,function(item){var idx=$ARR.find(filteredCandidates,"v",item.v);if(idx>-1){filteredCandidates.splice(idx,1);}});}return filteredCandidates;},getCandidatesThroughTaskCall:function getCandidatesThroughTaskCall(params,callbacks){var id=this.id,targetWas=this.getSuggestionTarget(),searchPattern=params.pattern||"",rawInput=searchPattern,parent=this.parent,attributeId=this.srcid,isIncFetch=params.isIncFetch,_last_hit=this._last_hit,me=this,isSearching=false,searchQueue;if(isIncFetch){searchPattern=params.pattern=_last_hit.pattern;}if(searchPattern===""||searchPattern.trim()==="%"){return ;}if(attributeId){var taskParams={taskId:"browseElements",styleName:"MojoAttributeStyle",attributeID:attributeId,dataSourcesXML:this.dsrc||"",blockBegin:isIncFetch?_last_hit.loadedCount:1,blockCount:this.items.length+this.suggestCount,searchPattern:searchPattern,rawInput:rawInput,browseFlags:1,otp:this.srct},instParams=null;var defn=parent.defn;if(defn.dsid){instParams={};instParams.datasetID=defn.dsid;instParams.messageID=parent.model.mid;instParams.ctlKey=parent.ckey;}if(this.srct===$OBJECT_TYPE.Consolidation){taskParams.browseFlags=GET_ELEMENT_FLAG_DERIVED_ELEMENT;}var defnSearchForms=defn.fs||defn.sfs;if(defnSearchForms){var searchForms="",separator="";$ARR.forEach(defnSearchForms,function(form){searchForms+=separator+form.did;separator=";";});taskParams.searchForms=searchForms;if(parent.model.isnew||this.useClientForm){var clientFormPatterns="",_separator="",model=parent.model,attr=$ARR.filterOne(model.getDatasetUnits(["att"]),function(unit){return unit.did===attributeId;}),attrForms=attr.fs||[];$ARR.forEach(defnSearchForms,function(searchForm){var fm=$ARR.filterOne(attrForms,function(form){return form.fid===searchForm.did;});clientFormPatterns+=_separator+searchForm.did+":"+(fm&&fm.bftp||0);_separator=";";});taskParams.clientFormPatterns=clientFormPatterns;}}callbacks.success=function(res){var box=mstrmojo.all[id],suggestionPopup=box&&box.suggestionPopup,target,len,newPattern,items,srcPattern=params.pattern,sq=box&&box._searchQueue,showResults=!sq||sq.length<=(isIncFetch?0:1)||!box.stifleIntermediateSearch;if(box){if(res&&res.es){target=box.getSuggestionTarget();len=res.es.length;if(!res||!target||(targetWas!==target)){return ;}newPattern=target.getSearchPattern();items=res.es;if(attributeId){items=mstrmojo.elementHelper.buildElemsTerseID(items,attributeId,true);}box._last_hit={items:items,pattern:srcPattern,loadedCount:res.bb+len};suggestionPopup.isFetching=false;if(showResults){suggestionPopup.supportsIncFetch=(res.bb+res.bc)<res.sz;if(newPattern&&newPattern.indexOf(srcPattern)>-1){var filteredCandidates=box.filterCandidates(items,newPattern);box.updateSuggestion(isIncFetch?box.suggestionItems.concat(filteredCandidates):filteredCandidates);}if(box.inputBox){box.inputBox.focus();}if(!box._ListenerProc){box._ListenerProc=function(){var pulldownSuggestionPopup=box.suggestionPopup;if(pulldownSuggestionPopup.visibile){pulldownSuggestionPopup.nudge();}};$DOM.attachEvent(window,"resize",box._ListenerProc);}}}else{if(showResults){box.updateSuggestion([]);}}}};callbacks.failure=function(res){var box=mstrmojo.all[id],ec=parseInt(res.code,10)+4294967296,isIgnoredError=(ec===ERR_SDK_E_INVALID||ec===ERR_SDK_E_PROMPT_NUMERICAL_VALUES||ec===ERR_SDK_E_PROMPT_DATE_TIME);if(!isIgnoredError){mstrmojo.alert(res.message);}if(box&&box.failMessage){box.failMessage(isIgnoredError?{errCode:ec,msg:res.message}:{});}};callbacks.complete=function(){var sq=me._searchQueue,currSrch=sq&&sq.pop();mstrApp.hideWait();if(sq&&sq.length&&me.showSuggestion){me._searchQueue=[];me.showSuggestion(currSrch);}};if(this.hitEnterToTest){if(isIncFetch&&this.onIncrementalFetch){this.onIncrementalFetch();}mstrApp.showWait({message:mstrmojo.desc(15823,'Searching "#"...').replace("#",searchPattern)});}else{if(!isIncFetch){searchQueue=this._searchQueue;isSearching=searchQueue&&searchQueue.length;if(!searchQueue){this._searchQueue=[];}this._searchQueue.push(searchPattern);}}if(!isSearching){mstrmojo.elementHelper.browseElements(callbacks,taskParams,instParams);}}},destroy:function destroy(ignoreDom){if(this._ListenerProc){$DOM.detachEvent(window,"resize",this._ListenerProc);delete this._ListenerProc;}this._super(ignoreDom);},onsuggestionItemsChange:function onsuggestionItemsChange(){var suggestionItems=this.suggestionItems,popup=this.suggestionPopup,editorNode=popup.editorNode,hasScrollBar=suggestionItems&&(suggestionItems.length>8),height="",px="";if(hasScrollBar){height=(mstrApp&&mstrApp.MAX_SUGGESTION_POPUP_HEIGHT)||MAX_SUGGESTION_POPUP_HEIGHT;px="px";}if(editorNode){editorNode.style.maxHeight=height+px;}else{if(hasScrollBar){px+=";";popup.cssText=(popup.cssText||"")+"max-height:"+height+px;}}if(mstrApp.isExpress){var width=this.parent.contentNode.offsetWidth,minWidth=(width===null||MIN_SUGGESTION_POPUP_WIDTH<width)?MIN_SUGGESTION_POPUP_WIDTH:width,maxWidth=(width===null||MAX_SUGGESTION_POPUP_WIDTH>width)?MAX_SUGGESTION_POPUP_WIDTH:width;popup.cssText=(popup.cssText||"")+"min-width:"+minWidth+"px; max-width:"+maxWidth+"px;";}},getSuggestionPos:function getSuggestionPos(){var ret=this._super();if(ret){ret.lockIW=this;}return ret;},updateSuggestion:function updateSuggestion(items){var len=items&&items.length;this.autoSelect=true;this.set("disableClick",false);if(this.parent.defn.multi&&len&&len>1){items=$ARR.filter(items,function(item){return(item.v!=="u;"&&item.t!==14)&&(item.t!==SELECT_ALL_ITEM);});items.unshift({n:mstrmojo.desc(13976,"(All search results)"),t:SELECT_ALL_ITEM});this.autoSelect=false;}if(!len){items=[{n:mstrmojo.desc(13779,"No elements match your search"),t:NO_MATCH_MSG,cls:"nomatch"}];}if(items.length===1&&items[0].t===NO_MATCH_MSG){this.autoSelect=false;this.set("disableClick",true);}this._super(items);var me=this;me.mw=me.mw||function(e){var popup=me._lastOpened;if(!popup||!popup.visible){$DOM.detachEvent(document,$DOM.isFF?"DOMMouseScroll":"mousewheel",me.mw);return ;}var target=$DOM.eventTarget(self,e);var domNode=popup.domNode;if(!$DOM.contains(domNode,target,true,document.body)){popup.close();$DOM.detachEvent(document,$DOM.isFF?"DOMMouseScroll":"mousewheel",me.mw);}};$DOM.attachEvent(document,$DOM.isFF?"DOMMouseScroll":"mousewheel",me.mw);},handleSuggestionItemSelect:function handleSuggestionItemSelect(it,obCfg){if($ARR.isArray(it)||it.t===SELECT_ALL_ITEM){it=$ARR.ensureArray(it);var items=$ARR.filter(it,function(item){return item.t!==SELECT_ALL_ITEM;});if(items.length<it.length){items=$ARR.filter(this.suggestionItems,function(item){return item.t!==SELECT_ALL_ITEM;});}this.onSuggestionItemSelect(items);}else{this._super(it,obCfg);}},prekeydown:function prekeydown(evt){this._super(evt);var e=evt.e,height=(mstrApp&&mstrApp.MAX_SUGGESTION_POPUP_HEIGHT)||MAX_SUGGESTION_POPUP_HEIGHT,maxItems=8,itemHeight=height/maxItems;var selected=this.getSelected();if(selected){var index=selected._renderIdx,minScroll=(index-maxItems+1)*itemHeight,maxScroll=(index-1)*itemHeight,currentScrollTop=this.suggestionPopup.domNode.scrollTop;switch(parseInt(e.keyCode||e.charCode,10)){case $KEYS.DOWN_ARROW:if(currentScrollTop<=minScroll){this.suggestionPopup.domNode.scrollTop=minScroll;}else{if(currentScrollTop>maxScroll){this.suggestionPopup.domNode.scrollTop=maxScroll;}}break;case $KEYS.UP_ARROW:if(currentScrollTop<=minScroll||currentScrollTop>maxScroll){this.suggestionPopup.domNode.scrollTop=maxScroll;}break;}}}});}());