(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.array","mstrmojo.gmaps.MapEnums","mstrmojo.mapbox.MapboxEnums","mstrmojo.gmaps.MapUtils");var $MOJO=mstrmojo,$H=$MOJO.hash,$ARR=$MOJO.array,$GMAPS=$MOJO.gmaps,$MAPBOX=$MOJO.mapbox,$MUTIL=$GMAPS.MapUtils,$FILTER=$MAPBOX.FILTER,ID_SUFFIX=$MAPBOX.ID_SUFFIX,EnumFillColor={Small:"#0096FF",Medium:"#FF9300",Large:"#FF2600",Small_Hover:"#6DBDF5",Medium_Hover:"#FFB34C",Large_Hover:"#FF7158"},EnumStrokeColor={Small_Hover:"#E1F2FF",Medium_Hover:"#FFECD2",Large_Hover:"#FFE4E0"},EnumWidth={Small:15,Large:30,Medium:21,Small_Border:5,Medium_Border:8,Large_Border:10,Border_Selection:2,Border_ContextMenu:1},STOPS=[0,10,100];function getClusterStops(values){if(values){return{property:"point_count",type:"interval",stops:$ARR.map(STOPS,function(key,i){return[key,values[i]];})};}}function getClusterIdFilter(clusterIds){return["in","cluster_id"].concat($ARR.isArray(clusterIds)?clusterIds:[]);}mstrmojo.gmaps.layer.mapbox._ClusterViewerWrapper=mstrmojo.provide("mstrmojo.gmaps.layer.mapbox._ClusterViewerWrapper",{_mixinName:"mstrmojo.gmaps.layer.mapbox._ClusterViewerWrapper",getClusterLayerId:function getClusterLayerId(){var id=this.getLayerId();return id+ID_SUFFIX.Cluster;},addClusterLayers:function addClusterLayers(map,sourceId){var layerId=this.getClusterLayerId(),labelLayerId=layerId+ID_SUFFIX.DataLabel,_layerIds=this._layerIds,clusterTextLayerProps={layout:{"text-field":"{point_count_abbreviated}","text-font":["DIN Offc Pro Medium","Arial Unicode MS Bold"],"text-size":12,"text-allow-overlap":true},paint:{"text-color":"#ffffff"}};map.addLayer($H.copy(this.getClusterLayerOptions(),this.getLayerCtrlProps(layerId,"circle",sourceId,$FILTER.CLUSTER)));_layerIds.push(layerId);map.addLayer($H.copy(this.getClusterLayerOptionsHover(),this.getLayerCtrlProps(layerId+ID_SUFFIX.Hover,"circle",sourceId,$FILTER.NOCLUSTER)));_layerIds.push(layerId+ID_SUFFIX.Hover);map.addLayer($H.copy(this.getClusterLayerOptionsSelection(),this.getLayerCtrlProps(layerId+ID_SUFFIX.Selection,"circle",sourceId,$FILTER.NOCLUSTER)));_layerIds.push(layerId+ID_SUFFIX.Selection);map.addLayer($H.copy(this.getClusterLayerOptionsContextMenu(),this.getLayerCtrlProps(layerId+ID_SUFFIX.ContextMenu,"circle",sourceId,$FILTER.NOCLUSTER)));_layerIds.push(layerId+ID_SUFFIX.ContextMenu);map.addLayer($H.copy(clusterTextLayerProps,this.getLayerCtrlProps(labelLayerId,"symbol",sourceId,$FILTER.CLUSTER)));_layerIds.push(labelLayerId);},getClusterLayerOptions:function getClusterLayerOptions(){return{paint:{"circle-color":getClusterStops([EnumFillColor.Small,EnumFillColor.Medium,EnumFillColor.Large]),"circle-radius":getClusterStops([EnumWidth.Small,EnumWidth.Medium,EnumWidth.Large]),"circle-opacity":this.getFillOpacityForZoomAnimation(1),"circle-stroke-color":getClusterStops([EnumFillColor.Small,EnumFillColor.Medium,EnumFillColor.Large]),"circle-stroke-width":getClusterStops([EnumWidth.Small_Border,EnumWidth.Medium_Border,EnumWidth.Large_Border]),"circle-stroke-opacity":this.getFillOpacityForZoomAnimation(0.35)}};},getClusterLayerOptionsHover:function getClusterLayerOptionsHover(){return{paint:{"circle-opacity":0.9,"circle-color":getClusterStops([EnumFillColor.Small_Hover,EnumFillColor.Medium_Hover,EnumFillColor.Large_Hover]),"circle-radius":getClusterStops([EnumWidth.Small,EnumWidth.Medium,EnumWidth.Large]),"circle-stroke-color":getClusterStops([EnumStrokeColor.Small_Hover,EnumStrokeColor.Medium_Hover,EnumStrokeColor.Large_Hover]),"circle-stroke-width":getClusterStops([EnumWidth.Small_Border,EnumWidth.Medium_Border,EnumWidth.Large_Border]),"circle-stroke-opacity":0.3}};},getClusterLayerOptionsSelection:function getClusterLayerOptionsSelection(){return{paint:{"circle-opacity":0,"circle-radius":getClusterStops([EnumWidth.Small+EnumWidth.Small_Border,EnumWidth.Medium+EnumWidth.Medium_Border,EnumWidth.Large+EnumWidth.Large_Border]),"circle-stroke-color":"#000000","circle-stroke-width":EnumWidth.Border_Selection,"circle-stroke-opacity":this.getFillOpacityForZoomAnimation(1)}};},getClusterLayerOptionsContextMenu:function getClusterLayerOptionsContextMenu(){return{paint:{"circle-opacity":0,"circle-radius":getClusterStops([EnumWidth.Small+EnumWidth.Small_Border-EnumWidth.Border_ContextMenu,EnumWidth.Medium+EnumWidth.Medium_Border-EnumWidth.Border_ContextMenu,EnumWidth.Large+EnumWidth.Large_Border-EnumWidth.Border_ContextMenu]),"circle-stroke-color":getClusterStops([EnumFillColor.Small,EnumFillColor.Medium,EnumFillColor.Large]),"circle-stroke-width":EnumWidth.Border_ContextMenu}};},desolveFeature:function desolveFeature(feature){var map=this.getMapInstance(),cluster=this.cluster,cluster_id=feature&&feature.properties.cluster_id;return($MUTIL.checkDefined(cluster_id)&&cluster)?cluster.getLeaves(cluster_id,Math.floor(map.getZoom()),Infinity):[feature];},isClusterFeature:function isClusterFeature(feature){return !!(feature&&feature.properties.cluster);},handleClusterHover:function handleClusterHover(feature){var map=this.getMapInstance(),layerId=this.getClusterLayerId()+ID_SUFFIX.Hover,id=feature&&feature.properties.cluster_id;if(!map){return ;}if($MUTIL.checkDefined(id)){map.setFilter(layerId,getClusterIdFilter([id]));}else{map.setFilter(layerId,$FILTER.NOCLUSTER);}},_getAllClusters:function _getAllClusters(map){var cluster=this.cluster,me=this;if(map&&cluster){return $ARR.filter(cluster.getClusters([-180,-90,180,90],Math.floor(map.getZoom())),function(item){return me.isClusterFeature(item);});}},_findClustersFromFeatures:function _findClustersFromFeatures(map,idList){var cluster=this.cluster,results=[],clusterFeatures;if(!map||!cluster||!idList||idList.length<1){return ;}clusterFeatures=this._getAllClusters(map);$ARR.forEach(clusterFeatures,function(feature){var items=this.desolveFeature(feature);if($ARR.some(items,function(item){return idList.indexOf(item.properties.id)!==-1;})){results.push(feature.properties.cluster_id);}},this);return results;},handleClusterSelection:function handleClusterSelection(idList){var map=this.getMapInstance(),layerId=this.getClusterLayerId(),clusterIds=this._findClustersFromFeatures(map,idList);if(!map){return ;}if(!clusterIds||clusterIds.length<1){map.setFilter(layerId,$FILTER.CLUSTER);map.setFilter(layerId+ID_SUFFIX.Selection,$FILTER.NOCLUSTER);map.setFilter(layerId+ID_SUFFIX.ContextMenu,$FILTER.NOCLUSTER);}else{map.setFilter(layerId+ID_SUFFIX.Selection,getClusterIdFilter(clusterIds));}},handleClusterContextMenu:function handleClusterContextMenu(idList){var map=this.getMapInstance(),layerId=this.getClusterLayerId(),clusterIds=this._findClustersFromFeatures(map,idList);if(!map){return ;}if(!clusterIds||clusterIds.length<1){map.setFilter(layerId,$FILTER.CLUSTER);map.setFilter(layerId+ID_SUFFIX.ContextMenu,$FILTER.NOCLUSTER);}else{map.setFilter(layerId+ID_SUFFIX.ContextMenu,getClusterIdFilter(clusterIds));}}});}());