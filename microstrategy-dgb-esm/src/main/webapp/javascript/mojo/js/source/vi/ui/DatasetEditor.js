(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.Box","mstrmojo.Button","mstrmojo.Container","mstrmojo.ui.Pulldown","mstrmojo.dom","mstrmojo.css","mstrmojo.Editor","mstrmojo.hash","mstrmojo.Label","mstrmojo.DynamicClassFactory","mstrmojo.vi.ui._IsDropTarget","mstrmojo.vi.models.EnumDragSources","mstrmojo.vi.ui.AllObjectsBrowser","mstrmojo.vi.ui.DatasetUnitList","mstrmojo.vi.ui.editors.ReportFilterEditor","mstrmojo.ui.CheckList","mstrmojo.ui.menus.EditorConfig","mstrmojo.ui._HasScroller","mstrmojo.DI.DIConstants");var $HASH=mstrmojo.hash,$DOM=mstrmojo.dom,$CSS=mstrmojo.css,$ARR=mstrmojo.array,ENUM_SOURCE=mstrmojo.vi.models.EnumDragSources,CONSTANTS=mstrmojo.DI.DIConstants,DATASET_MODE={IN_MEMORY:1,LIVE:2},NEWDATASET={id:"",att:[],mx:[]},DATA_ACCESS_HELP_URL="Selecting_how_a_dataset_accesses_its_data__Direct_.htm";var DESC_EDIT_FILTER=mstrmojo.desc(13402,"Edit Filter..."),DESC_ADD_FILTER=mstrmojo.desc(15347,"Add Filter..."),DESC_CLEAR_SELECTIONS=mstrmojo.desc(13231,"Clear All Selections");function checkModifiedItems(modifiedItems,item,isAdd){var pushArr=isAdd?modifiedItems.add:modifiedItems.del,delArr=isAdd?modifiedItems.del:modifiedItems.add;var delidx=$ARR.find(delArr,"did",item.did);if(delidx===-1){pushArr.push(item);}else{$ARR.removeIndices(delArr,delidx,1);}if(!isAdd){modifiedItems.fs.add=$ARR.filter(modifiedItems.fs.add,function(it){return item.did!==it.unitId;});modifiedItems.fs.del=$ARR.filter(modifiedItems.fs.del,function(it){return item.did!==it.unitId;});}}function checkModifiedForms(modifiedItems,action,isAdd){var pushArr=isAdd?modifiedItems.fs.add:modifiedItems.fs.del,delArr=isAdd?modifiedItems.fs.del:modifiedItems.fs.add,delidx=-1,idx;for(idx=0;idx<delArr.length;idx++){if(delArr[idx].unitId===action.unitId&&delArr[idx].attFormId===action.attFormId){delidx=idx;}}if(delidx===-1){pushArr.push(action);return true;}$ARR.removeIndices(delArr,delidx,1);return false;}function highlightItemsInObjectBrowser(objectsBrowser,dataset){objectsBrowser.set("highlightItems",dataset.mx.concat(dataset.att).map(function(item){return item.did;}));}function showWarningTooltip(editor,dataset){var warningBtn=editor.btnHbox.warningBtn;if(dataset.att.length>1&&(dataset.mx.length-editor.derivedMetricCount)===0){warningBtn.set("visible",true);window.setTimeout(function(){warningBtn.showTooltip();warningBtn._autoHideTimeout=window.setTimeout(function(){warningBtn.hideTooltip();},3000);},0);}else{warningBtn.hideTooltip();warningBtn.set("visible",false);}}function updateButtonStatus(editor){var dataset=editor.dataset,unitListContainer=editor.editorContainer.unitListContainer,clearButton=unitListContainer.clearBtn,itemCount=$ARR.filter(dataset.att.concat(dataset.mx),function(item){return !item.um&&!item.da&&item.st!==12033;}).length,okButton=editor.btnHbox.okBtn,hasInvalidItem=!!$ARR.filterOne(dataset.att,function(item){return(editor.invalidItems||{})[item.did];}),modifiedItems=editor.modifiedItems,hasModifiedItems=!!modifiedItems.add.length||!!modifiedItems.del.length||!!modifiedItems.fs.add.length||!!modifiedItems.fs.del.length||((modifiedItems.filter||null)!==(dataset.filter||null))||!!modifiedItems.convert;clearButton.set("itemCount",itemCount);clearButton.set("visible",itemCount!==0);okButton.set("enabled",!!itemCount&&hasModifiedItems&&!hasInvalidItem);}function addItemsToListOnBox(items,targetDataset,modifiedItems){$ARR.forEach(items,function(item){checkModifiedItems(modifiedItems,item,true);item.isNew=true;$ARR.insert(item.t===4?targetDataset.mx:targetDataset.att,null,[item]);});this.updateScrollbars();highlightItemsInObjectBrowser(this.editorContainer.objectBrowser,targetDataset);showWarningTooltip(this,targetDataset);updateButtonStatus(this);}function removeItemsFromDataset(items){var targetItems,editor=this,dataset=editor.dataset;$ARR.forEach(items,function(item){targetItems=item.t===4?dataset.mx:dataset.att;checkModifiedItems(editor.modifiedItems,item,false);$ARR.removeIndices(targetItems,$ARR.find(targetItems,"did",item.did),1);});editor.set("dataset",$HASH.copy(dataset));editor.updateScrollbars();highlightItemsInObjectBrowser(editor.editorContainer.objectBrowser,dataset);showWarningTooltip(editor,dataset);updateButtonStatus(editor);}function serverRequest(taskParams,callback,config){if(mstrApp.serverRequest){mstrApp.serverRequest(taskParams,callback,config);}else{window.$MAPF=function(){return false;};this.getServerProxy().request(callback,taskParams,false,config);}}function getAllowItems(items,mx,att){var allowItems=[];$ARR.forEach(items,function(item){if((item.t===4&&$ARR.find(mx,"did",item.did)===-1)||(item.t!==4&&$ARR.find(att,"did",item.did)===-1)){allowItems.push(item);}});return allowItems;}function getsubMenuCfg(me,item){return function(){var selectedIndices=[],oldFormSelectedIndices=null,submenu=new mstrmojo.ui.menus.EditorConfig({data:{item:item},contents:[{alias:"fs",scriptClass:"mstrmojo.ui.CheckList",selectedIndices:selectedIndices,postBuildRendering:function(){var itemNodes=this.itemsContainerNode.childNodes;$ARR.forEach(this.items,function(item,idx){if(item.idf){mstrmojo.css.addClass(itemNodes[idx],"disableOption");return false;}});},preselectionChange:function preselectionChange(evt){var removeIdx=evt.removed&&evt.removed[0];if(evt.removed&&this.items[removeIdx].idf){this.selectedIndices[removeIdx]=true;return false;}return true;}}],okBtnText:mstrmojo.desc(1442,"Ok"),setAllItems:function(allItems){this.contents[0].items=allItems;this.set("contents",this.contents);},fnOk:function fnOk(data,editor){var datasetEditor=me.parent.parent.parent,formList=editor.fs,selected=formList.selectedIndices,fs=formList.items,pos=1;$HASH.forEach(oldFormSelectedIndices,function(v,n){if(v){checkModifiedForms(datasetEditor.modifiedItems,{act:"removeAttrFormFromDataset",unitId:item.did,attFormId:fs[n].id},false);item.fs[n].obf=false;}});$HASH.forEach(selected,function(v,n){if(v){var addToActions=checkModifiedForms(me.parent.parent.parent.modifiedItems,{act:"addAttrFormToDataset",unitId:item.did,attFormId:fs[n].id,unitPos:pos},true);if(addToActions){pos++;}item.fs[n].obf=true;}});updateButtonStatus(datasetEditor);}});var all=[];$ARR.forEach(item.fs,function(form){all.push({id:form.fid,n:form.fnm,idf:form.idf});if(form.obf||form.idf){selectedIndices[all.length-1]=true;}});if(!oldFormSelectedIndices){oldFormSelectedIndices=$HASH.cloneArray(selectedIndices);}submenu.setAllItems(all);return submenu;};}function getUnitListCfg(objName){return{scriptClass:"mstrmojo.vi.ui.DatasetUnitList",alias:objName+"List",cssClass:objName+"Unitlist",cssDisplay:"inline-block",multiSelect:true,draggable:false,useListModKeys:true,tooltipOpenDelay:0,postCreate:function(){this.avatarCssClass+=" noIcon";},doItemSelect:function(item,evt){var me=this,isMetaKey=$DOM.isMetaKey(evt.hWin,evt.e);if(!isMetaKey){$ARR.forEach(this.parent.allList,function(list){if(list!==me.alias){me.parent[list].clearSelect();}});}if(typeof evt.getTarget==="function"){var target=evt.getTarget();if(target.className.indexOf("clsx")!==-1){var editor=this.parent.parent.parent;removeItemsFromDataset.call(editor,[item]);return ;}}this.constructor.prototype.doItemSelect.call(this,item,evt);},onItemContextMenu:function onItemContextMenu(item,evt){var e=evt.e,itemNode=this.getItemNodeFromTarget(evt.getTarget()),hWin=evt.hWin,targetSelected=this.getSelectedItems().some(function(obj){return obj.itemNode===itemNode;});if(item&&!targetSelected){this.doItemSelect(item,evt);}var target=evt.getTarget(),items=this.parent.getSelectedItems();if(items.length){this.closePopup();var multi=items&&items.length>1,method=multi?"showMultiSelectionMenu":"showItemMenu";this[method](multi?items:item,this.getItemNodeFromTarget(target),mstrmojo.dom.getMousePosition(e,hWin));return true;}},hasTooltipContent:function(item,itemNode){return(!!item&&!!item.n)||(this.parent.parent.parent.invalidItems||{})[item.did];},getItemTooltip:function(item,itemNode,target){var richTooltip=this.constructor.prototype.getItemTooltip.call(this,item,itemNode,target);if(richTooltip){if(itemNode.classList.contains("invalid")){richTooltip.content=mstrmojo.desc(15392,"This is an invalid object. Please remove it before adding this dataset to the Dossier.");richTooltip.cssClass+=" vi-warning triangle-warning";richTooltip.left=richTooltip.left+102;return richTooltip;}richTooltip.refNode=itemNode;richTooltip.top=-5;if(item.t===mstrmojo.warehouse.EnumObjectTypes.METRIC){richTooltip.left=itemNode.getBoundingClientRect().width+12;richTooltip.posType=mstrmojo.tooltip.POS_TOPLEFT;richTooltip.cssClass="vi-regular vi-tooltip-C";}else{richTooltip.left=-4;richTooltip.posType=mstrmojo.tooltip.POS_TOPRIGHT;richTooltip.cssClass="vi-regular vi-tooltip-D";}return richTooltip;}return null;},getItemProps:function getItemProps(item,idx){var props=this.constructor.prototype.getItemProps.call(this,item,idx),editor=this.parent.parent.parent,dataset=editor.dataset,did=item.did,index=$ARR.find(dataset[objName],"did",did);dataset[objName][index].isNew=false;props.addCls((editor.invalidItems||{})[did]?"invalid":"");return props;},getAttributeForms:function getAttributeForms(attDid,callback){serverRequest.call(this,{taskId:"getAttributeForms",styleName:"VIMojoAttributeStyle",attributeID:attDid,displayedForms:0},callback,{showProgress:false});},showItemMenu:function showItemMenu(item,el,position){var menuCfg=new mstrmojo.ui.menus.MenuConfig({position:position,isHostedWithin:false}),datasetEditor=this.parent.parent.parent;menuCfg.addMenuItem(mstrmojo.desc(629,"Delete"),"",function(){removeItemsFromDataset.call(datasetEditor,[item]);});if(item.t===12){var forms=item.fs,fnAddAttributeForms=function(){if(forms.length>1){menuCfg.addPopupMenuItem(mstrmojo.desc(14327,"Available Attribute Forms"),"",getsubMenuCfg(this,item));}}.bind(this);if(!forms){var requestForms=function requestForms(){this.getAttributeForms(item.did,{success:function(res){var datasetAttributes=datasetEditor.dataset.att;forms=item.fs=datasetAttributes[$ARR.find(datasetAttributes,"did",item.did)].fs=(res.fms||[]).map(function(form){return{fid:form.did,fnm:form.n,obf:!!form.obf,idf:!!form.idf};});fnAddAttributeForms();this.openPopup(menuCfg.newInstance());}.bind(this),failure:function(res){mstrmojo.alert(res.message);}});}.bind(this);if(mstrApp.isSingleTier){datasetEditor.editorContainer.objectBrowser.dataProvider.loadObjects([item],{success:function(){requestForms();}});}else{requestForms();}return ;}fnAddAttributeForms();}this.openPopup(menuCfg.newInstance());},showMultiSelectionMenu:function showMultiSelectionMenu(items,el,position){var menuCfg=new mstrmojo.ui.menus.MenuConfig({position:position,isHostedWithin:false}),datasetEditor=this.parent.parent.parent;menuCfg.addMenuItem(mstrmojo.desc(629,"Delete"),"",function(){removeItemsFromDataset.call(datasetEditor,items);});this.openPopup(menuCfg.newInstance());},getAllItems:function(){return this.dataset&&$ARR.filter(this.dataset[objName],function(item){return !item.um&&!item.da&&item.st!==12033;});},filterItems:function(items){return items;},bindings:{dataset:"this.parent.parent.parent.dataset"}};}mstrmojo.vi.ui.DatasetEditorContent=mstrmojo.DynamicClassFactory.newComponent(mstrmojo.Box,[mstrmojo.vi.ui._IsDropTarget,mstrmojo.vi.ui._HasUnitListAvatar],{allowDrop:function(context){var dragData=context.src.data,items=dragData.items,dataset=this.dataset,mx=dataset.mx,att=dataset.att;return getAllowItems(items,mx,att).length&&dragData.src===ENUM_SOURCE.ALL_OBJECT_LIST;},isDragValid:function isDragValid(context){return !isNaN(parseInt(context.src.node.getAttribute("idx"),10))||this._super(context)||false;},ondragstart:function ondragstart(context){var list=null,me=this,inList=function(tulist){return $DOM.contains(tulist.domNode,context.src.node,true,tulist.domNode);};$ARR.forEach(this.allList,function(listName){if(inList(me[listName])){list=me[listName];return false;}});if(list){list.selectDragNode(context);}this._super(context);}});var okBtn=mstrmojo.Button.newWebButton(mstrmojo.desc(118,"Save"),function(){var datasetEditor=this.parent.parent,dataset=datasetEditor.dataset,datasets=datasetEditor.docModel.datasets,actions=[],otherActions=datasetEditor.modifiedItems.fs.add.concat(datasetEditor.modifiedItems.fs.del),addUnit={act:"addUnitToDataset"},removeUnit={act:"removeBaseUnitFromDataset"},addFilter={act:"setDatasetFilter",useJson:false},GUIDforNewDS="$GUID_141",idx=0;if(datasetEditor.modifiedItems.convert){actions.push(datasetEditor.modifiedItems.convert);idx=$ARR.indexOf($HASH.keyarray(datasets),dataset.did)+1;addUnit.dsidx=removeUnit.dsidx=addFilter.dsidx=idx;$ARR.forEach(otherActions,function(formAction){formAction.dsidx=idx;});}else{if(!dataset.did&&datasetEditor.modifiedItems.add.length){var isDatasetLiveMode=dataset.dsm===DATASET_MODE.LIVE;if(datasetEditor.modifiedItems.create){datasetEditor.modifiedItems.create.idd=isDatasetLiveMode;}actions.push(datasetEditor.modifiedItems.create||{act:"createDataset",prm:true,mgo:true,idd:isDatasetLiveMode,newObjectIds:[GUIDforNewDS]});var dropZoneModel=datasetEditor.docModel.getSelectedViUnit().getZonesModel();if(dropZoneModel){actions.push({act:"editNode",nodeKey:dropZoneModel.getHost().k,datasetId:GUIDforNewDS});}actions=actions.concat(datasetEditor.docModel.getOpenDatasetPanelAction());addUnit.dsid=addFilter.dsid=GUIDforNewDS;$ARR.forEach(otherActions,function(formAction){formAction.dsid=GUIDforNewDS;});}else{if(dataset){var datasetId=dataset.did;addUnit.dsid=removeUnit.dsid=addFilter.dsid=datasetId;$ARR.forEach(otherActions,function(formAction){formAction.dsid=datasetId;});}}}$ARR.forEach(datasetEditor.modifiedItems.add,function(item){actions.push($HASH.copy(addUnit,{unitId:item.did,unitType:item.t}));});$ARR.forEach(datasetEditor.modifiedItems.del,function(item){actions.push($HASH.copy(removeUnit,{unitId:item.did,unitType:item.t}));});actions=actions.concat(otherActions);if((datasetEditor.modifiedItems.filter||null)!==(dataset.filter||null)){actions.push($HASH.copy(addFilter,{expr:mstrmojo.fe.FilterUtils.getExprXml(datasetEditor.modifiedItems.filter)}));}if(actions.length){if(!dataset.mngd&&!!dataset.did&&!datasetEditor.modifiedItems.convert){actions.push({act:"datasetSaveAs",managed:false,nonDelta:true,dsID:dataset.did,rptName:dataset.name,rptDesc:"",folderID:dataset.pfid,saveAsOverwrite:true});}}if(datasetEditor.modifiedItems.add.length){datasetEditor.editorContainer.objectBrowser.dataProvider.loadObjects(datasetEditor.modifiedItems.add,{success:function(){datasetEditor.onOk(actions);}});}else{datasetEditor.onOk(actions);}if(datasetEditor.closeOnSubmit){datasetEditor.close();}},true,{alias:"okBtn"}),cancelBtn=mstrmojo.Button.newWebButton(mstrmojo.desc(221,"Cancel"),function(){var editor=this.parent.parent;if(editor.onCancel){editor.onCancel();}editor.close();}),warningBtn=mstrmojo.Button.newWebButton("",null,false,{cssClass:"warningBtn",alias:"warningBtn",useRichTooltip:true,tooltipOpenDelay:0,updateTooltipConfig:function updateTooltipConfig(){var targetPosition=$DOM.position(this.domNode);this.richTooltip={content:'<div class="name">'+mstrmojo.desc(15393,"Adding at least one metric is recommended")+'</div><div class="dsc">'+mstrmojo.desc(15394,"It may prevent attributes from different hierarchies to be cross joined.")+"</div>",cssClass:"vi-warning vi-tooltip-D A-center",left:targetPosition.x-308,top:targetPosition.y-7};},showTooltip:function showTooltip(){window.clearTimeout(this._autoHideTimeout);this._autoHideTimeout=undefined;if(this.hasOpenTooltip){this.hideTooltip();}this.constructor.prototype.showTooltip.call(this);}});function getFilterEditor(config){var editorId="dfe",editor,targetMap={},filter=config.datasetFilter;function isExpressionSupported(expr){if(!expr.et){return false;}if(expr.et===mstrmojo.expr.ET.RLS){return false;}if(expr.p){return false;}if(expr.cs&&expr.cs.some(function(c){return !!c.p;})){return false;}return !expr.nds||expr.nds.every(isExpressionSupported);}function showEditor(){$ARR.forEach(config.att,function(unit){if(unit.t!==12||unit.da){return ;}var did=unit.did;targetMap[did]={did:did,n:unit.n,t:unit.t,isInvalid:config.invalidItems[did],fs:unit.fs};});$ARR.forEach(config.mx,function(unit){if(unit.um){return ;}targetMap[unit.did]={did:unit.did,n:unit.n,t:unit.t};});if(filter){mstrmojo.expr.findTargets(filter,"did",targetMap);}var filterModel={expr:$HASH.clone(filter),targets:$HASH.valarray(targetMap)};editor=editorId&&window.mstrmojo&&mstrmojo.all[editorId];if(!editor){editor=mstrmojo.insert({id:editorId,scriptClass:"mstrmojo.vi.ui.editors.ReportFilterEditor",showLimits:false,objectBrowsingEnabled:true});}if(config.zIndex){editor.set("zIndex",config.zIndex);}editor.set("title",mstrmojo.desc(5758,"Filter Editor"));editor.set("onSave",config.fnOk);editor.onCancel=config.onCancel;editor.set("model",filterModel);editor.set("docModel",config.docModel);editor.onUpdateBrowseElementsParams=config.browseParam;editor.open();}if(filter&&!isExpressionSupported(filter)){mstrmojo.warn(mstrmojo.desc(15700,"The filter contains an advanced condition or a prompt that cannot be edited. Would you like to clear the existing filter?"),{confirmBtn:{t:mstrmojo.desc(13528,"Clear existing filter"),fn:function(){filter=null;showEditor();}},cancelBtn:{t:mstrmojo.desc(221,"Cancel")}},{title:mstrmojo.desc(11812,"Notification")});}else{showEditor();}}mstrmojo.vi.ui.DatasetEditor=mstrmojo.declare(mstrmojo.Editor,[mstrmojo.ui._HasScroller],{scriptClass:"mstrmojo.vi.ui.DatasetEditor",cssClass:"mstrmojo-VIDatasetEditor",dataset:NEWDATASET,docModel:null,dataProvider:null,help:"Add_Existing_Objects.htm",modifiedItems:{add:[],del:[],fs:{add:[],del:[]},filter:undefined},useRichTooltip:false,closeOnSubmit:true,init:function(config){this.buttons=[warningBtn,okBtn,cancelBtn];this._super(config);if(!this.docModel.allowModifyReportList()){this.dataModeContainer.children=[];}okBtn.text=this.okBtnText||mstrmojo.desc(118,"Save");},onOpen:function(){var dataset=this.dataset,modifiedItems=this.modifiedItems;if(!dataset.did){dataset=this.dataset=$HASH.clone(NEWDATASET);}else{this.updateScrollbars();}modifiedItems.add=[];modifiedItems.del=[];modifiedItems.fs.add=[];modifiedItems.fs.del=[];modifiedItems.filter=dataset.filter;showWarningTooltip(this,dataset);updateButtonStatus(this,dataset.att.length+dataset.mx.length);this.editorContainer.filterBtn.refresh();},onPreClose:function onPreClose(){if(this.onCancel){this.onCancel();}return this._super();},setupScrollNodes:function setupScrollNodes(){this.scrollNode=this.editorContainer.containNode;},children:[{scriptClass:"mstrmojo.Container",alias:"editorContainer",markupString:'<div class="mstrmojo-VIDatasetEditorContents"><div class="objbrowserContainer"></div><div class="datasetEditorContainer"><div class="datasetEditorTopContainer"><div class="filterLink"></div></div><div class="datasetEditorContent"><div mstrAttach:mouseout,mouseover></div></div></div></div>',markupSlots:{browserNode:function(){return this.domNode.firstChild;},filterNode:function(){return this.domNode.childNodes[1].firstChild.firstChild;},containNode:function(){return this.domNode.childNodes[1].childNodes[1].firstChild;}},onmouseout:function(){mstrmojo.css.removeClass(this.containNode.parentNode,"entered");},onmouseover:function(){mstrmojo.css.addClass(this.containNode.parentNode,"entered");},children:[{scriptClass:"mstrmojo.vi.ui.AllObjectsBrowser",alias:"objectBrowser",cssClass:"datasetEditorobjbrowser",slot:"browserNode",bindings:{model:"this.parent.parent.docModel"},dblClickOnNodes:function(evt){var target=evt.getTarget(),item=$DOM.findWidget(target).data,editor=this.parent.parent,dataset=editor.dataset;if(item&&$ARR.indexOf([4,12,1,47],item.t)!==-1){if((item.t===4&&$ARR.find(dataset.mx,"did",item.did)===-1)||(item.t!==4&&$ARR.find(dataset.att,"did",item.did)===-1)){addItemsToListOnBox.call(editor,[item],dataset,editor.modifiedItems);}editor.set("dataset",$HASH.copy(dataset));}},postBuildRendering:function(){var editor=this.parent.parent;this.set("dataProvider",editor.dataProvider);this.set("opened",true);this.constructor.prototype.postBuildRendering.call(this);highlightItemsInObjectBrowser(this,editor.dataset);},allowDrop:function(context){var dragData=context.src.data;return dragData&&dragData.src!==ENUM_SOURCE.ALL_OBJECT_LIST;},getDropAvatarIcon:function getDropAvatarIcon(){return"hasIcon remove";},ondrop:function ondrop(context){if(context.src.data.onRemove){context.src.data.onRemove(context.src.data.items);}}},{scriptClass:"mstrmojo.Button",alias:"filterBtn",slot:"filterNode",cssClass:"filterButton",disabled:false,text:DESC_ADD_FILTER,richTooltip:{cssClass:"vi-regular V-center vi-tooltip-V disabled-filter-button",posType:mstrmojo.tooltip.POS_BOTTOMCENTER},useRichTooltip:false,updateTooltipConfig:function updateTooltipConfig(){var tooltip=this.richTooltip,position=$DOM.position(this.domNode);tooltip.left=position.x+position.w-36;tooltip.top=position.y-5;},buildRendering:function buildRendering(){var editor=this.parent.parent,filter=editor.modifiedItems.filter,nds=filter&&filter.nds,xdaType=$HASH.walk("dataset.xdaType",editor),richTooltip=this.richTooltip;if(xdaType===CONSTANTS.xdaType.customFreeFormSQL){this.enabled=false;this.useRichTooltip=true;richTooltip.content="<div class='info-icon long-text'></div>"+mstrmojo.desc(16297,"Adding filters at the dataset level is not supported for Free Form SQL Reports. To filter your data, add filters to the dossier via the Filter Panel or in the canvas.");}else{this.text=(filter&&(!nds||nds.length>0))?DESC_EDIT_FILTER:DESC_ADD_FILTER;richTooltip.content="<div class='info-icon'></div>"+mstrmojo.desc(15814,"Adding a filter at the dataset level is only supported for In-Memory data access mode.");}var ret=this.constructor.prototype.buildRendering.call(this);$CSS.toggleClass(this.domNode,"hasFilter",filter);return ret;},onenabledChange:function(){if(this.enabled){this.useRichTooltip=false;}else{this.useRichTooltip=true;}},onclick:function(){var me=this,editor=this.parent.parent,dataset=editor.dataset,filter=editor.modifiedItems.filter,fnUpdateInvalidItems=function(filterModel,editor){var invalidItems=editor.invalidItems||{};filterModel.targets.forEach(function(item){if(item.isInvalid){invalidItems[item.did]=true;}});editor.invalidItems=invalidItems;editor.editorContainer.unitListContainer.attList.refresh();updateButtonStatus(editor);},fnOk=function(filterModel){editor.modifiedItems.filter=filterModel.expr;var filter=filterModel.expr,nds=filter&&filter.nds;fnUpdateInvalidItems(filterModel,editor);this.text=(filter&&(!nds||nds.length>0))?DESC_EDIT_FILTER:DESC_ADD_FILTER;$CSS.toggleClass(this.domNode,"hasFilter",filter);me.refresh();},onCancel=function(filterModel){fnUpdateInvalidItems(filterModel,editor);};if(dataset){getFilterEditor({datasetName:"- "+(dataset.name||mstrmojo.desc(11636,"New Dataset")),datasetFilter:filter,att:editor.editorContainer.unitListContainer.attList.items,mx:editor.editorContainer.unitListContainer.mxList.items,invalidItems:editor.invalidItems||{},docModel:editor.docModel,fnOk:fnOk,onCancel:onCancel,browseParam:mstrmojo.emptyFn,zIndex:editor.zIndex+1});}}},{scriptClass:"mstrmojo.vi.ui.DatasetEditorContent",alias:"unitListContainer",slot:"containNode",bindings:{dataset:"this.parent.parent.dataset",cssClass:function(){return"datasetEditorUnitlistContainer"+(this.dataset.idd?" noFilter":"");}},ondrop:function ondrop(context){var me=this,editor=me.parent.parent,targetDataset=editor.dataset,allowItems=getAllowItems(context.src.data.items,editor.dataset.mx,editor.dataset.att);addItemsToListOnBox.call(editor,allowItems,targetDataset,me.parent.parent.modifiedItems);editor.set("dataset",$HASH.copy(targetDataset));editor.updateScrollbars();},allList:["attList","mxList"],getDragData:function getDragData(context){var info=this.constructor.prototype.getDragData.call(this,context),me=this,editor=me.parent.parent;info.onRemove=function(items){removeItemsFromDataset.call(editor,items);};return info;},getSelectedItems:function(){var me=this,result=[];this.allList.forEach(function(listName){result=result.concat(me[listName].getSelectedItems());});return result;},children:[{scriptClass:"mstrmojo.Button",alias:"clearBtn",cssClass:"clearButton",text:DESC_CLEAR_SELECTIONS,itemCount:0,onitemCountChange:function onitemCountChange(){this.set("text",DESC_CLEAR_SELECTIONS+" ("+this.itemCount+")");},onclick:function onclick(){var editor=this.parent.parent.parent,dataset=editor.dataset;removeItemsFromDataset.call(editor,dataset.att.concat(dataset.mx));}},getUnitListCfg.call(this,"att"),getUnitListCfg.call(this,"mx"),{scriptClass:"mstrmojo.Label",cssClass:"dragObjectMsg",bindings:{visible:"!this.parent.attList.items.length && !this.parent.mxList.items.length"},text:mstrmojo.desc(11668,"Drag objects here.")}]}]},{scriptClass:"mstrmojo.Container",slot:"buttonNode",alias:"dataModeContainer",useRichTooltip:false,richTooltip:{cssClass:"vi-regular V-center vi-tooltip-V pulldown-tooltip",posType:mstrmojo.tooltip.POS_BOTTOMCENTER,enableHover:true,},updateTooltipConfig:function updateTooltipConfig(){var tooltip=this.richTooltip,position=$DOM.position(this.dataModeInfoIcon.domNode),datasetEditor=this.parent;tooltip.left=position.x+position.w-9;tooltip.top=position.y-8;if(datasetEditor.dataset.dsm){tooltip.content=mstrmojo.desc(15813,"Switching data access mode is not supported.");}else{tooltip.content=mstrmojo.desc(15812,"We only support one Live dataset per dossier using existing application objects. If you would like to add new objects, please edit the existing Live dataset.");}tooltip.content+="<br /><div class='help-link-label' onclick='mstrApp.showHelpTopic(\"##HELPTOPIC##\")'>"+mstrmojo.desc(15811,"Learn more about Data Access Mode")+"</div>";tooltip.content=tooltip.content.replace("##HELPTOPIC##",DATA_ACCESS_HELP_URL);},markupString:'<div class="dataModeContainer"><div class="live-mode-pulldown-label"></div><div class="live-mode-pulldown"></div><div></div></div>',markupSlots:{dataModeLabelNode:function(){return this.domNode.firstChild;},dataModePulldownNode:function(){return this.domNode.childNodes[1];},dataModeInfoNode:function(){return this.domNode.childNodes[2];}},children:[{scriptClass:"mstrmojo.Label",slot:"dataModeLabelNode",alias:"dataModeLabel",text:mstrmojo.desc(11922,"Data Access Mode"),postCreate:function(){var dataModeCont=this.parent,datasetEditor=dataModeCont.parent;if(datasetEditor.dataset.dsm||datasetEditor.hasLTSDataset){dataModeCont.set("useRichTooltip",true);}},postBuildRendering:function(){var dataModeCont=this.parent,datasetEditor=dataModeCont.parent;if(datasetEditor.dataset.dsm||datasetEditor.hasLTSDataset){this.set("enabled",false);}this.constructor.prototype.postBuildRendering.call(this);}},{scriptClass:"mstrmojo.ui.Pulldown",slot:"dataModePulldownNode",alias:"dataModePulldown",items:[{n:mstrmojo.desc(11921,"In-Memory"),v:DATASET_MODE.IN_MEMORY,d:mstrmojo.desc(15826,"Retrieves dataset results from a data source and stores them in memory.")},{n:mstrmojo.desc(12726,"Connect Live"),v:DATASET_MODE.LIVE,d:mstrmojo.desc(15827,"Retrieves dataset results directly from the source.")}],getPopupListConfig:function(){var config=mstrmojo.ui.Pulldown.prototype.getPopupListConfig.call(this);config.showTooltip=function showTooltip(e,win){if(!this.hasOpenTooltip){var target=$DOM.eventTarget(win,e),item=this.getItemFromTarget(target);if(item){var node=this.getItemNodeFromTarget(target);this.richTooltip={content:item.d,refNode:node,cssClass:"vi-regular vi-tooltip-C pulldown-tooltip",left:149,top:0};mstrmojo._HasTooltip.showTooltip.call(this,e,win);}}};config.tooltipOpenDelay=700;return config;},postBuildRendering:function(){var datasetEditor=this.parent.parent,datasetDsm=datasetEditor.dataset.dsm,filterBtn=datasetEditor.editorContainer.filterBtn;if(datasetDsm||datasetEditor.hasLTSDataset){this.set("enabled",false);if(datasetDsm===DATASET_MODE.LIVE){filterBtn.set("enabled",false);}}this.selectedIndex=datasetDsm?datasetDsm-1:0;this.constructor.prototype.postBuildRendering.call(this);},onSelectedItemChange:function(){var datasetEditor=this.parent.parent,filterBtn=datasetEditor.editorContainer.filterBtn,confirmSwitch=function(okFn,cancelFn){mstrmojo.confirm("<b>"+mstrmojo.desc(15819,"Switching to Connect Live will remove the filters defined in this dataset. Would you like to continue?")+"</b><br /><br />"+mstrmojo.desc(15816,"Filter at the dataset level is only supported for In-Memory data access mode."),{confirmBtn:{t:mstrmojo.desc(7660,"Switch"),fn:okFn},cancelBtn:{t:mstrmojo.desc(2140,"Cancel"),fn:cancelFn}},{title:mstrmojo.desc(15817,"Switch to Connect Live Mode"),allowHTML:true});},switchModeToLive=function(){datasetEditor.dataset.dsm=this.selectedIndex+1;datasetEditor.modifiedItems.filter=undefined;filterBtn.set("enabled",false);filterBtn.refresh();},cancelSwitch=function(){this.set("selectedIndex",DATASET_MODE.IN_MEMORY-1);};if(this.selectedIndex===DATASET_MODE.LIVE-1){if(datasetEditor.modifiedItems.filter){confirmSwitch(switchModeToLive.bind(this),cancelSwitch.bind(this));}else{switchModeToLive.bind(this)();}}else{datasetEditor.dataset.dsm=this.selectedIndex+1;filterBtn.set("enabled",true);filterBtn.refresh();}}},{scriptClass:"mstrmojo.Label",slot:"dataModeInfoNode",alias:"dataModeInfoIcon",cssClass:"info-icon",richTooltip:{cssClass:"vi-regular V-center vi-tooltip-V pulldown-tooltip",posType:mstrmojo.tooltip.POS_BOTTOMCENTER,enableHover:true,},useRichTooltip:false,updateTooltipConfig:function updateTooltipConfig(){var tooltip=this.richTooltip,position=$DOM.position(this.domNode);tooltip.left=position.x+position.w-9;tooltip.top=position.y-9;tooltip.content=mstrmojo.desc(15818,"You can determine how a dossier accesses data in this dataset. The dataset access mode determines whether the data is loaded in-memory or retrieved directly from the source.");tooltip.content+="<br /><div class='help-link-label' onclick='mstrApp.showHelpTopic(\"##HELPTOPIC##\")'>"+mstrmojo.desc(15811,"Learn more about Data Access Mode")+"</div>";tooltip.content=tooltip.content.replace("##HELPTOPIC##",DATA_ACCESS_HELP_URL);},postCreate:function(){var datasetEditor=this.parent.parent;if(datasetEditor.dataset.id===""&&!datasetEditor.hasLTSDataset){this.useRichTooltip=true;}}}]}]});}());