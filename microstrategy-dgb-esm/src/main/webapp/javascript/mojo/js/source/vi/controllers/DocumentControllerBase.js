(function(){mstrmojo.requiresCls("mstrmojo.rw.DocController","mstrmojo.vi.ui.DocumentView","mstrmojo.vi.models.DocModel","mstrmojo.vi.controllers.EnumEvents","mstrmojo.hash","mstrmojo.func","mstrmojo.UUID","mstrmojo.vi.controllers.UICmdMgr","mstrmojo.Label","mstrmojo.TextBox","mstrmojo.Button","mstrmojo.expr","mstrmojo.dom","mstrmojo.DocDataService","mstrmojo.vi.enums.EnumFeatures","mstrmojo.string");mstrmojo.requiresClsP("mstrmojo.vi.factories","VisualizationTransitionFactory");mstrmojo.requiresDescs(221,1388,5414,5415,5421,5422,11812,13157,14719);var $VI=mstrmojo.vi,$FUNC=mstrmojo.func,$HASH=mstrmojo.hash,$ARR=mstrmojo.array,$UUID=mstrmojo.UUID,$DESC=mstrmojo.desc,$NWB=mstrmojo.Button.newWebButton,E=mstrmojo.expr,$DDS=mstrmojo.DocDataService,$DOM=mstrmojo.dom,EVENTS=mstrmojo.vi.controllers.EnumEvents,$VI_MODELS=$VI.models,FEATURES=mstrmojo.vi.enums.EnumFeatures;var EXP_PDF=3,EXP_EXCEL=4,SECOND_TO_MILLISECOND=1000;var TP_ATTRIBUTE=12,STP_RECURSIVE_ATTRIBUTE=3076;var WS_ALERT_TYPE_EXISTING_DATASET=1,WS_ALERT_TYPE_EXISTING_OBJECT=2;var SAVE_WAIT_BOX_CONFIG={config:{waitBoxCfg:{message:mstrmojo.desc(10492,"Saving..."),cssClass:"saving-in-progress"}}};function hasDataSource(model){return !!Object.keys(model.datasets||{}).length;}mstrmojo.vi.controllers.DocumentControllerBase=mstrmojo.declare(mstrmojo.rw.DocController,[],{scriptClass:"mstrmojo.vi.controllers.DocumentControllerBase",model:null,rootCtrl:null,view:null,visTransitionFactory:null,cmdMgr:null,start:function start(documentData){var model=new mstrmojo.vi.models.DocModel(documentData),rootCtrl=this.rootCtrl;model.lastSavedStid=model.stid||0;model.controller=this;model.copyable=(documentData.defn||{})["copyable"]!=="false";var cmdMgr=this.cmdMgr=new mstrmojo.vi.controllers.UICmdMgr({controller:this,model:model});cmdMgr.dataService=model.getDataService();var visTransitionFactory=this.visTransitionFactory=new $VI.factories.VisualizationTransitionFactory();var layoutsCacheSize=parseInt(mstrApp.viLayoutsCacheSize);var view=this.view=new $VI.ui.DocumentView({controller:this,model:model,hasDataSource:hasDataSource(model),LAYOUTS_CACHE_SIZE:layoutsCacheSize>=0?layoutsCacheSize:10});this.set("model",model);model.attachEventListener("layoutSelected",view.id,"layoutSelected");model.attachEventListener("selectPage",view.id,"selectPage");this.addDisposable([cmdMgr,visTransitionFactory,model,view]);},build:function build(){this.view.buildChildren();},submitTemplateUpdates:function submitTemplateUpdates(view,actions,callback,extras,urInfo,withUndoRedo){if(withUndoRedo){this.submitUndoRedoTemplateUpdates(view,actions,callback,extras,urInfo);}else{this.model.getDataService().submitTemplateUpdates(view.k,actions,$FUNC.wrapMethods(this._getXtabCallback(view),callback),extras);}},submitUndoRedoTemplateUpdates:function submitUndoRedoTemplateUpdates(view,actions,callback,extras,urInfo){this.submitUndoRedoTemplateWithCallback(view,this.dataService().getUpdateTemplateAction(view.k,actions),callback,extras,urInfo);},submitUndoRedoTemplateWithCallback:function submitUndoRedoTemplateWithCallback(view,actions,callback,extras,urInfo){this.submitUndoRedoUpdates(actions,{},$FUNC.wrapMethods(this._getXtabCallback(view),callback),extras,urInfo);},submitUndoRedoUpdates:function submitUndoRedoUpdates(actions,undoActions,callback,extras,urInfo){this.cmdMgr.execute({execute:function(){this.submit(actions,callback,extras);},urInfo:$HASH.copy(urInfo,{callback:callback})});},exportVisualization:function exportVisualization(viz,mode){var EXPORT_WARNING_THRESHOLD=10000000;var rw=viz.node.data.rw,fnExport=function(){switch(mode){case EXP_PDF:this.printPDF(viz.k);break;case EXP_EXCEL:this.exportExcel(viz.k);break;}}.bind(this);if(rw&&(rw.col.tc*rw.row.tc>EXPORT_WARNING_THRESHOLD)){mstrmojo.warn(mstrmojo.desc(15506,"Exporting the dossier may take a few minutes. Do you want to export anyway?"),undefined,{buttons:[$NWB(mstrmojo.desc(246,"Export"),fnExport),$NWB(mstrmojo.desc(221,"Cancel"),undefined,true)]});}else{fnExport();}},getReloadLayoutViewCallback:function getRepaintLayoutCallback(callback){var view=this.view;return $FUNC.wrapMethods({success:function(){view.showSelectedLayout();}},callback);},getRefreshCallback:function getRefreshCallback(){var m=this.model;return $FUNC.wrapMethods(m.getDatasetsUpdateCallback(),m.getReloadLayoutModelCallback(),this.getReloadLayoutViewCallback(),this.getUpdateTOCPanlelCallback());},getUpdateLayoutViewCallback:function getUpdateLayoutViewCallback(callback){var view=this.view;return $FUNC.wrapMethods({success:function(res){view.updateLayouts(res);}},callback);},getUpdateTOCPanlelCallback:function getUpdateTOCPanlelCallback(callback){var model=this.model;return $FUNC.wrapMethods({success:function(){model.raiseEvent({name:EVENTS.UPDATE_TOC});}},callback);},getUpdateLayoutsCallback:function getUpdateLayoutsCallback(){var m=this.model;return $FUNC.wrapMethods(m.getDatasetsUpdateCallback(),this.getUpdateLayoutViewCallback());},getPartialUpdateCallback:function getPartialUpdateCallback(callback){var targetDefinitions={},me=this,model=me.model,zonesModel=model.getSelectedViUnit().getZonesModel();return $FUNC.wrapMethods({success:function(res){var puKeys=res.pukeys&&res.pukeys.split("\u001E");if(puKeys&&puKeys.length>0){targetDefinitions=model.getUnitDefinitions(puKeys);}model.partialUpdate(res.data,targetDefinitions,res.defn,puKeys);}},model.getUpdateHiddenLayoutsCallback(),callback||(zonesModel&&zonesModel.getUpdateCallback()));},_getXtabCallback:function _getXtabCallback(xtab,callback,updateDefn){return $FUNC.wrapMethods(this._super(xtab,updateDefn),callback||(xtab.parent.getZonesModel&&xtab.parent.getZonesModel().getUpdateCallback()));},undo:function undo(){this.cmdMgr.undo();},redo:function redo(){this.cmdMgr.redo();},onCmdMgrChanged:function onCmdMgrChanged(){mstrApp.rootCtrl.generateToolbar();},isDocChanged:function isDocChanged(){var model=this.model,currentStateId=model.getDataService().stid||0,lastSavedStateId=model.lastSavedStid||0;return currentStateId>lastSavedStateId||!!model.dty;},dataService:function dataService(){return this.model.getDataService();},onKeepOnlyOrExcludeNodeAdded:function onKeepOnlyOrExclude(visModel,visData,submitFn){submitFn();},applyKeepOnly:function applyKeepOnly(visualization,callback,nodeToAdd,nodeIdxToRemove,noUnset){var visModel=visualization.model,data=visualization.gridData||visualization.model.data||visualization.node.data,me=this,submitUpdates=function(selectorData){var info=visModel.getKeepOnlyActionsForAssociatedNodes(selectorData||[],callback),docModel=me.model,deferredSubmit=function(needUnset){var _submittedActions=needUnset?docModel.wrapUnsetVisualizationFilterAction(info.actions):info.actions;me.submitUndoRedoUpdates(_submittedActions,null,info.callback);};if(noUnset===false){deferredSubmit(false);return ;}docModel.checkAndNotifyVFChangeOnKeepOnlyExclude({},function(){deferredSubmit(true);},function(){deferredSubmit(false);});}.bind(this),newSelectorData=visualization.getSelectorDataForKeepOnly(nodeToAdd,nodeIdxToRemove);if(nodeToAdd){this.onKeepOnlyOrExcludeNodeAdded(visModel,data,function(){submitUpdates(newSelectorData);});}else{submitUpdates(newSelectorData);}},clearFiltersForVis:function clearFiltersForVis(visualization,filtersToClear,callback){var visModel=visualization.model,actionInfo=visModel.getClearFiltersForVisActions(visualization,undefined,filtersToClear,callback);this.submitUndoRedoUpdates(actionInfo.actions,null,actionInfo.callback,actionInfo.extras);},clearLinkingFilter:function clearLinkingFilter(ctxt,callback){this.submitUndoRedoUpdates([{act:"clearUCNodeCondition",nodeKey:ctxt.nodeKey}],null,callback,{style:{params:{treesToRender:3}}});},clearLinkingMultiFilter:function clearLinkingFilter(ctxt,selectionsInfos,callback){var actions=[],model=this.model,curLayoutKey=model.getCurrentLayoutKey(),layout=(model.defn.layouts).filter(function(layout){return layout.k===curLayoutKey;})[0],units=layout.units,cgbMap=layout.cgbMap,cgbMapKeys=$HASH.keyarray(cgbMap),ckey=ctxt.ckey,sources,visKey;$ARR.forEach(selectionsInfos,function(si){visKey=si.vis.k;sources=$ARR.filter(cgbMapKeys,function(key){if(cgbMap[key]===visKey){return units[key]&&$ARR.find(units[key].scs,"ckey",ckey)>-1;}return false;});if(sources.length){$ARR.forEach(sources,function(ucKey){actions.push({act:"clearUCNodeCondition",nodeKey:ucKey});});}});this.submitUndoRedoUpdates(actions,null,callback,{style:{params:{treesToRender:3}}});},applyKeepOnlyForMutilTemplate:function applyKeepOnlyForMutilTemplate(selectionsInfos,callback,needUnset){var visualization,nodeToAdd,nodeIdxToRemove,visModel,nodeKey,graphicLayer,docModel=this.model,data,templateLimitExpression,newSelectorData,docCtrl=this,updateInfo={actions:[],callback:callback},getUpdateInfo=function(visModel,graphicLayer,nodeKey,selectorData){var info=visModel.getKeepOnlyActionsForAssociatedNodes(selectorData,updateInfo.callback,graphicLayer);updateInfo.callback=info.callback;updateInfo.actions=updateInfo.actions.concat(info.actions);};$ARR.forEach(selectionsInfos,function(selectionInfo){visualization=selectionInfo.vis;nodeToAdd=selectionInfo.selectorData;nodeIdxToRemove=selectionInfo.nodeIdxToRemove;graphicLayer=selectionInfo.graphicLayer;visModel=visualization.model;data=visualization.model.data||visualization.node.data;nodeKey=data.k;templateLimitExpression=data.tpl;if(nodeIdxToRemove===-1){newSelectorData=[];}else{newSelectorData=[].concat(visModel.getSelectorDataFromTemplateLimit(templateLimitExpression));}if(nodeIdxToRemove===-2){newSelectorData=mstrmojo.array.filter(newSelectorData,function(e){return !e.keepOnly;});}else{if(nodeIdxToRemove>=0){newSelectorData.splice(nodeIdxToRemove,1);}}if(nodeToAdd){newSelectorData=newSelectorData.concat(nodeToAdd);docCtrl.onKeepOnlyOrExcludeNodeAdded(visModel,data,function(){getUpdateInfo(visModel,graphicLayer,nodeKey,newSelectorData);});}else{getUpdateInfo(visModel,graphicLayer,nodeKey,newSelectorData);}});if(updateInfo.actions&&updateInfo.actions.length>0){var deferredSubmit=function(needUnset){var _submittedActions=needUnset?docModel.wrapUnsetVisualizationFilterAction(updateInfo.actions):updateInfo.actions;docCtrl.submitUndoRedoUpdates(_submittedActions,null,updateInfo.callback);};if(!needUnset){deferredSubmit(false);return ;}docModel.checkAndNotifyVFChangeOnKeepOnlyExclude({},function(){deferredSubmit(true);},function(){deferredSubmit(false);});}},clearFiltersForVisMultipleTemplate:function clearFiltersForVisMultipleTemplate(selectionsInfos,filtersToClear,callback){var visualization,visModel,graphicLayer,updateInfo={actions:[],callback:callback};$ARR.forEach(selectionsInfos,function(selectionInfo){visualization=selectionInfo.vis;graphicLayer=selectionInfo.graphicLayer;visModel=visualization.model;var actionInfo=visModel.getClearFiltersForVisActions(visualization,graphicLayer,filtersToClear,updateInfo.callback);updateInfo.actions=updateInfo.actions.concat(actionInfo.actions);updateInfo.callback=actionInfo.callback;updateInfo.extras=actionInfo.extras;});this.submitUndoRedoUpdates(updateInfo.actions,null,updateInfo.callback,updateInfo.extras);}});}());