(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.array","mstrmojo.string","mstrmojo.models.template.DataInterface","mstrmojo.vi.ui.DatasetUnitMenuUtils");var STR=mstrmojo.string,TAG_TEMPLATE_OBJECT="TemplateObject",TAG_VALUE="Value",OBJECT_TYPE_ATTRIBUTE=12,OBJECT_TYPE_METRIC=4,_attributeTokens={},_metricTokens={},templateWordBase={},templateWordBaseWithoutSpace={},templateObjectsByName={},objSuggestionList=[],categorizedObj={},categorizedDatasets={},$ARRAY=mstrmojo.array,$HASH=mstrmojo.hash,$NLP,$DS_UTILS=mstrmojo.vi.ui.DatasetUnitMenuUtils,SPLIT_CHAR="\u200C",ATTRS_ENUMS={GEO:"geo",TIME:"time",CATEGORY:"category",SUBCATEGORY:"subcategory",PRODUCT:"product",DEPARTMENT:"department",BUSINESS_UNIT:"businessUnit",ALL_THE_REST:"allTheRest"},MX_ENUMS={PROFIT:"profit",REVENUE:"revenue",COST:"cost",SOLD:"sold",SALES:"sales",AMOUNT:"amount",ALL_THE_REST:"allTheRest"},SYMBOL_TYPE={LEXICAL:0,OBJECT:1,CONDITION:2,AGGREGATION:3};function getConsolidatedTokens(input){var terms=$NLP(input,templateWordBase).list[0].terms,combined=[],index=0,name=[],valName=[],text,getLongObjs=function getLongObjs(name){var word="";$ARRAY.forEach(name,function(item){word=word+" "+item;word=word.trim();if(templateWordBase[word]){combined.push(word.replace(/ +/g,SPLIT_CHAR));word="";}});},getLongNum=function getLongNum(valName){var n=$NLP(valName.join(" ")).values().numbers(),numeric;if($ARRAY.isArray(n)&&n.length>0){numeric=n[0];combined.push(numeric);}};while(index<terms.length){text=terms[index].normal;if(!terms[index].tags[TAG_TEMPLATE_OBJECT]&&!terms[index].tags[TAG_VALUE]){if(valName.length>0){getLongNum(valName);}valName=[];if(name.length>0){getLongObjs(name);}combined.push(text);name=[];}else{if(terms[index].tags[TAG_VALUE]&&!terms[index].tags[TAG_TEMPLATE_OBJECT]){valName.push(text);}else{name.push(text);}}index++;}if(name.length>0){getLongObjs(name);}if(valName.length>0){getLongNum(valName);}return $NLP(combined.join(" "),templateWordBaseWithoutSpace);}function resolveAggregationSymbols(tokens){var list,token,term,AGGREGATION_TOKENS={average:"Avg",maximum:"Max",max:"Max",minimum:"Min",min:"Min",sum:"Sum","sum of":"Sum",count:"Count","count of":"Count"};$HASH.forEach(AGGREGATION_TOKENS,function(op,keyword){list=tokens.match(keyword+" #"+TAG_TEMPLATE_OBJECT).list;$ARRAY.forEach(list,function(item){term=$ARRAY.filter(item.terms,function(it){return !!it.tags[TAG_TEMPLATE_OBJECT];});token=term[0];token.symboltp=SYMBOL_TYPE.AGGREGATION;token.fn=op;token.isDM=true;});});return tokens;}function resolveSortingSymbols(tokens){var SORTS_KEYWORDS=["sort by","sorted by"],list,sorts=[],token,term;$ARRAY.forEach(SORTS_KEYWORDS,function(keyword){list=tokens.match(keyword+" #"+TAG_TEMPLATE_OBJECT).list;$ARRAY.forEach(list,function(item){term=$ARRAY.filter(item.terms,function(it){return !!it.tags[TAG_TEMPLATE_OBJECT];});token=templateObjectsByName[term[0].normal];if(token.t===OBJECT_TYPE_ATTRIBUTE&&token.fs&&token.fs[0]){token.fid=token.fs[0].fid;}sorts.push(token);});});return sorts;}function resolveConditionSymbols(tokens){var OP_GREATER="greater",OP_LESS="less",OP_IS="equal",CONDITION_KEYWORDS={"bigger than":OP_GREATER,"larger than":OP_GREATER,"greater than":OP_GREATER,"smaller than":OP_LESS,"less than":OP_LESS,is:OP_IS,are:OP_IS},list,term,token,$NLP=$NLP||window.nlp;$HASH.forEach(CONDITION_KEYWORDS,function(op,keyword){list=tokens.match("#"+TAG_TEMPLATE_OBJECT+" * "+keyword+" #value").list;$ARRAY.forEach(list,function(item){term=$ARRAY.filter(item.terms,function(it){return !!it.tags[TAG_TEMPLATE_OBJECT];});token=term.slice(-1)[0];token.symboltp=SYMBOL_TYPE.CONDITION;token.condiOp=op;token.condiValue=$ARRAY.filter(item.terms,function(it){return !!it.tags[TAG_VALUE];})[0].normal;token.condiValue=$NLP(token.condiValue).values().numbers()[0];});});var populateRankPattern=function populateRankPattern(isTop){var RANK_PATTERN=["#"+TAG_TEMPLATE_OBJECT+(isTop?" with highest #":" with lowest #")+TAG_TEMPLATE_OBJECT,"#"+TAG_TEMPLATE_OBJECT+(isTop?" with the highest #":" with the lowest #")+TAG_TEMPLATE_OBJECT,"#"+TAG_TEMPLATE_OBJECT+(isTop?" with most #":" with fewest #")+TAG_TEMPLATE_OBJECT,"#"+TAG_TEMPLATE_OBJECT+(isTop?" with the most #":" with the fewest #")+TAG_TEMPLATE_OBJECT,"#"+TAG_TEMPLATE_OBJECT+(isTop?" with greatest #":" with least #")+TAG_TEMPLATE_OBJECT,"#"+TAG_TEMPLATE_OBJECT+(isTop?" with the greatest #":" with the least #")+TAG_TEMPLATE_OBJECT,"#"+TAG_TEMPLATE_OBJECT+(isTop?" with largest #":" with smallest #")+TAG_TEMPLATE_OBJECT,"#"+TAG_TEMPLATE_OBJECT+(isTop?" with the largest #":" with the smallest #")+TAG_TEMPLATE_OBJECT,"#"+TAG_TEMPLATE_OBJECT+(isTop?" with maximum #":" with minimum #")+TAG_TEMPLATE_OBJECT,"#"+TAG_TEMPLATE_OBJECT+(isTop?" with the maximum #":" with the minimum #")+TAG_TEMPLATE_OBJECT];return RANK_PATTERN;};var SINGLE_TOP_RANK_PATTERN=populateRankPattern(true);var SINGLE_BOTTOM_RANK_PATTERN=populateRankPattern(false);var singleTopOrBottom=function singleTopOrBottom(condition){var pattern=(condition==="top")?SINGLE_TOP_RANK_PATTERN:SINGLE_BOTTOM_RANK_PATTERN;$ARRAY.forEach(pattern,function(value){var newList=tokens.match(value).list;$ARRAY.forEach(newList,function(item){term=$ARRAY.filter(item.terms,function(it){return !!it.tags[TAG_TEMPLATE_OBJECT];});token=term[1];token.symboltp=SYMBOL_TYPE.CONDITION;token.condiOp=condition;token.condiValue=1;});});};singleTopOrBottom("top");singleTopOrBottom("bottom");var RANKING_PATTERN=["top #value #"+TAG_TEMPLATE_OBJECT+" by #"+TAG_TEMPLATE_OBJECT,"top #value #"+TAG_TEMPLATE_OBJECT+" with the highest #"+TAG_TEMPLATE_OBJECT];$ARRAY.forEach(RANKING_PATTERN,function(value){list=tokens.match(value).list;$ARRAY.forEach(list,function(item){term=$ARRAY.filter(item.terms,function(it){return !!it.tags[TAG_TEMPLATE_OBJECT];});token=term[1];token.symboltp=SYMBOL_TYPE.CONDITION;token.condiOp="top";token.condiValue=$ARRAY.filter(item.terms,function(it){return !!it.tags[TAG_VALUE];})[0].normal;token.condiValue=$NLP(token.condiValue).values().numbers()[0];});});return tokens;}function resolveVisType(tokens){var VIZ_TYPE_TOKENS={kpi:"KPICardVisualizationStyle","geospatial map":"MapboxVisualizationStyle","heat map":"VIHeatMapVisualizationStyle",heatmap:"VIHeatMapVisualizationStyle","tree map":"VIHeatMapVisualizationStyle",treemap:"VIHeatMapVisualizationStyle",map:"GoogleMapVisualizationStyle",line:"LINE",bar:"BAR",pie:"PIE",bubble:"BUBBLE",network:"NetworkVisualizationStyle",table:"Grid",grid:"Grid"},visType="";$HASH.forEach(VIZ_TYPE_TOKENS,function(styelName,keyword){if(tokens.match(keyword).found){visType=styelName;return false;}});return visType;}function applyMatchingRuleSet(input){var filter=[],templateObjects=[],candidate,tokens=getConsolidatedTokens(input);$ARRAY.forEach(tokens.list[0].terms,function(token){if(token.tags[TAG_TEMPLATE_OBJECT]){token.symboltp=SYMBOL_TYPE.OBJECT;}});tokens=resolveAggregationSymbols(tokens);tokens=resolveConditionSymbols(tokens);$ARRAY.forEach(tokens.list[0].terms,function(symbol){switch(symbol.symboltp){case SYMBOL_TYPE.CONDITION:candidate=templateObjectsByName[symbol.normal];filter.push({fn:symbol.condiOp,v:symbol.condiValue,did:candidate.did,n:candidate.n,t:candidate.t,st:candidate.st,dsid:candidate.datasetId,isDM:symbol.isDM});templateObjects.push($HASH.copy({fn:symbol.fn,isDM:symbol.isDM,dmName:symbol.fn+" "+candidate.n,t:symbol.isDM?OBJECT_TYPE_METRIC:candidate.t},$HASH.clone(candidate)));break;case SYMBOL_TYPE.OBJECT:case SYMBOL_TYPE.AGGREGATION:candidate=templateObjectsByName[symbol.normal];templateObjects.push($HASH.copy({fn:symbol.fn,isDM:symbol.isDM,dmName:symbol.fn+" "+candidate.n,t:candidate.t},$HASH.clone(candidate)));break;default:break;}});return{items:templateObjects,visType:resolveVisType(tokens),filter:filter,sorts:resolveSortingSymbols(tokens)};}function createObjItemForSuggestionList(item,result){var itemType=$DS_UTILS.getUnitCssClass(item);result.push({n:item.n,html:'<div class="icn '+itemType+'"></div>'+STR.encodeHtmlString(item.n),dsName:item.dsName});}function createObjSuggestionList(){objSuggestionList=[];$HASH.forEach(_metricTokens,function(item){createObjItemForSuggestionList(item,objSuggestionList);});$HASH.forEach(_attributeTokens,function(item){createObjItemForSuggestionList(item,objSuggestionList);});}function matchObjName(n,synonyms){synonyms=$ARRAY.ensureArray(synonyms);n=n.toLowerCase();var findIt=false;$ARRAY.forEach(synonyms,function(term){if(n.indexOf(term)>-1){findIt=true;return false;}return true;});return findIt;}function isTimeAttr(item){return $DS_UTILS.isTimeAttr(item)||matchObjName(item.n,["month","year","quarter","week","date"]);}function getAttrObjType(item){if($DS_UTILS.isGeoAttr(item)){return ATTRS_ENUMS.GEO;}else{if(isTimeAttr(item)){return ATTRS_ENUMS.TIME;}else{if(matchObjName(item.n,["category","categories"])){return ATTRS_ENUMS.CATEGORY;}else{if(matchObjName(item.n,["subcategory","subcategories","sub-category"])){return ATTRS_ENUMS.SUBCATEGORY;}else{if(matchObjName(item.n,["product","products"])){return ATTRS_ENUMS.PRODUCT;}else{if(matchObjName(item.n,["department","departments"])){return ATTRS_ENUMS.DEPARTMENT;}else{if(matchObjName(item.n,["business unit","business units"])){return ATTRS_ENUMS.BUSINESS_UNIT;}else{return ATTRS_ENUMS.ALL_THE_REST;}}}}}}}}function getMxObjType(item){if(matchObjName(item.n,["profit","profits"])){return MX_ENUMS.PROFIT;}else{if(matchObjName(item.n,["revenue"])){return MX_ENUMS.REVENUE;}else{if(matchObjName(item.n,["cost","costs"])){return MX_ENUMS.COST;}else{if(matchObjName(item.n,["sold","units sold"])){return MX_ENUMS.SOLD;}else{if(matchObjName(item.n,["sales"])){return MX_ENUMS.SALES;}else{if(matchObjName(item.n,["amount"])){return MX_ENUMS.AMOUNT;}else{return MX_ENUMS.ALL_THE_REST;}}}}}}}function giveEmptyObjectTemplate(){return{att:{geo:[],time:[],category:[],subcategory:[],product:[],department:[],businessUnit:[],preferredAttrs:[],allTheRest:[]},mx:{profit:[],revenue:[],cost:[],sold:[],sales:[],amount:[],preferredMetrics:[],allTheRest:[]}};}function categorizeObj(){var containsObject=function containsObject2(obj,list){return $ARRAY.some(list,function(item){return item.did===obj.did&&item.datasetId===obj.datasetId;});};categorizedDatasets={};categorizedObj={};categorizedObj=giveEmptyObjectTemplate();var att=categorizedObj.att,mx=categorizedObj.mx;$HASH.forEach(_attributeTokens,function(item){var dset=item.datasetId;if(!categorizedDatasets[item.datasetId]){categorizedDatasets[item.datasetId]=giveEmptyObjectTemplate();}var dsetAtt=categorizedDatasets[dset].att,category=getAttrObjType(item);if(!containsObject(item,att[category])){att[category].push(item);}if(!containsObject(item,dsetAtt[category])){dsetAtt[category].push(item);}});att.preferredAttrs=[].concat(att.category).concat(att.subcategory).concat(att.product).concat(att.department).concat(att.businessUnit);$ARRAY.forEach($HASH.keyarray(categorizedDatasets),function(set){var d=categorizedDatasets[set].att;d.preferredAttrs=[].concat(d.category).concat(d.subcategory).concat(d.product).concat(d.department).concat(d.businessUnit);});$HASH.forEach(_metricTokens,function(item){var dset=item.datasetId;if(!categorizedDatasets[dset]){categorizedDatasets[dset]=giveEmptyObjectTemplate();}var dsetMx=categorizedDatasets[dset].mx,category=getMxObjType(item);if(!containsObject(item,mx[category])){mx[category].push(item);}if(!containsObject(item,dsetMx[category])){dsetMx[category].push(item);}});mx.preferredMetrics=[].concat(mx.profit).concat(mx.revenue).concat(mx.cost).concat(mx.sold).concat(mx.sales).concat(mx.amount);$ARRAY.forEach($HASH.keyarray(categorizedDatasets),function(set){var d=categorizedDatasets[set].mx;d.preferredMetrics=[].concat(d.profit).concat(d.revenue).concat(d.cost).concat(d.sold).concat(d.sales).concat(d.amount);});}var M1="%%METRIC_1%%";var M2="%%METRIC_2%%";var A1="%%ATTRIBUTE_1%%";var AT1="%%ATTRIBUTE_TIME_1%%";var AG1="%%ATTRIBUTE_GEO_1%%";var Q_ICON='<div class="icn question"></div>';function wrapObjWithSpliter(name){return SPLIT_CHAR+name+SPLIT_CHAR;}function wrapObjWithBold(name){return"<b>"+name+"</b>";}var SAMPLE_Q_TEMPLATE=[{templates:[{n:"What is the total "+wrapObjWithSpliter(M1)+"?",html:Q_ICON+"What is the total "+wrapObjWithBold(M1)+"?",type:"sample-question"}],config:{mx:1}},{templates:[{n:"Count ("+wrapObjWithSpliter(A1)+")",html:Q_ICON+"Count ("+wrapObjWithBold(A1)+")",type:"sample-question"}],config:{att:1}},{templates:[{n:"What is the "+wrapObjWithSpliter(M1)+" by "+wrapObjWithSpliter(AT1)+"?",html:Q_ICON+"What is the "+wrapObjWithBold(M1)+" by "+wrapObjWithBold(AT1)+"?",type:"sample-question"}],config:{att_time:1,mx:1}},{templates:[{n:"Show me the distribution of "+wrapObjWithSpliter(M1)+" by "+wrapObjWithSpliter(AG1),html:Q_ICON+"Show me the distribution of "+wrapObjWithBold(M1)+" by "+wrapObjWithBold(AG1),type:"sample-question"},{n:"Show me a map of "+wrapObjWithSpliter(M1)+" by "+wrapObjWithSpliter(AG1),html:Q_ICON+"Show me a map of "+wrapObjWithBold(M1)+" by "+wrapObjWithBold(AG1),type:"sample-question"}],config:{att_geo:1,mx:1}},{templates:[{n:"Show me the "+wrapObjWithSpliter(M1)+" by "+wrapObjWithSpliter(A1),html:Q_ICON+"Show me the "+wrapObjWithBold(M1)+" by "+wrapObjWithBold(A1),type:"sample-question"}],config:{att:1,mx:1}},{templates:[{n:"Show me the "+wrapObjWithSpliter(M1)+" by "+wrapObjWithSpliter(A1)+" by "+wrapObjWithSpliter(AT1),html:Q_ICON+"Show me the "+wrapObjWithBold(M1)+" by "+wrapObjWithBold(A1)+" by "+wrapObjWithBold(AT1),type:"sample-question"}],config:{att:1,att_time:1,mx:1}},{templates:[{n:"What is the correlation between "+wrapObjWithSpliter(M1)+" and "+wrapObjWithSpliter(M2)+" by "+wrapObjWithSpliter(A1)+"?",html:Q_ICON+"What is the correlation between "+wrapObjWithBold(M1)+" and "+wrapObjWithBold(M2)+" by "+wrapObjWithBold(A1)+"?",type:"sample-question"}],config:{att:1,mx:2}},{templates:[{n:"What are the top 3 "+wrapObjWithSpliter(A1)+" with the highest "+wrapObjWithSpliter(M1)+"?",html:Q_ICON+"What are the top 3 "+wrapObjWithBold(A1)+" with the highest "+wrapObjWithBold(M1)+"?",type:"sample-question"}],config:{att:1,mx:1}},{templates:[{n:"What is the "+wrapObjWithSpliter(M1)+" by "+wrapObjWithSpliter(A1)+" sorted by "+wrapObjWithSpliter(M1)+"?",html:Q_ICON+"What is the "+wrapObjWithBold(M1)+" by "+wrapObjWithBold(A1)+" sorted by "+wrapObjWithBold(M1)+"?",type:"sample-question"}],config:{att:1,mx:1}}];function getCntOfCombination(m,n){if(m>n){return 0;}var temp1=1,temp2=1;for(var i=0;i<m;i++){temp1=temp1*(n-i);temp2=temp2*(m-i);}return temp1/temp2;}function getCntOfDistinctQuestion(category,categorizedObj){var config=category.config,categorizedMetrics=categorizedObj.mx,categorizedAttrs=categorizedObj.att,timeAttrsCnt=categorizedAttrs.time.length,geoAttrsCnt=categorizedAttrs.geo.length,preferredAttrsCnt=categorizedAttrs.preferredAttrs.length,allTheRestAttrsCnt=categorizedAttrs.allTheRest.length,preferredMetricsCnt=categorizedMetrics.preferredMetrics.length,allTheRestMetricsCnt=categorizedMetrics.allTheRest.length;var requiredAttCnt=config.att||0,requiredTimeAttCnt=config.att_time||0,requiredGeoAttCnt=config.att_geo||0,requiredMxCnt=config.mx||0;var result={preferred:0,others:0,total:0};if(requiredTimeAttCnt>timeAttrsCnt||requiredGeoAttCnt>geoAttrsCnt||requiredAttCnt>(preferredAttrsCnt+allTheRestAttrsCnt)||requiredMxCnt>(preferredMetricsCnt+allTheRestMetricsCnt)){return result;}if(requiredAttCnt>preferredAttrsCnt||requiredMxCnt>preferredMetricsCnt){result.preferred=0;}else{result.preferred=getCntOfCombination(requiredAttCnt,preferredAttrsCnt)*getCntOfCombination(requiredMxCnt,preferredMetricsCnt)*getCntOfCombination(requiredTimeAttCnt,timeAttrsCnt)*getCntOfCombination(requiredGeoAttCnt,geoAttrsCnt);}result.total=getCntOfCombination(requiredAttCnt,preferredAttrsCnt+allTheRestAttrsCnt)*getCntOfCombination(requiredMxCnt,preferredMetricsCnt+allTheRestMetricsCnt)*getCntOfCombination(requiredTimeAttCnt,timeAttrsCnt)*getCntOfCombination(requiredGeoAttCnt,geoAttrsCnt);result.others=result.total-result.preferred;return result;}function getRandomCombinationFromArr(arr,n){var len=arr.length;if(len<n){return null;}if(len===n){return arr;}var i,index=[],result=[];while(result.length<n){i=Math.floor(Math.random()*len);if(index.indexOf(i)>-1){continue;}index.push(i);result.push(arr[i]);}return result;}function generateSampleQuestion(category,categorizedObj){var categorizedMetrics=categorizedObj.mx,categorizedAttrs=categorizedObj.att,preferredAttr=categorizedAttrs.preferredAttrs,timeAttr=categorizedAttrs.time,geoAttr=categorizedAttrs.geo,otherAttr=categorizedAttrs.allTheRest,preferredMx=categorizedMetrics.preferredMetrics,otherMx=categorizedMetrics.allTheRest;var templates=category.templates,config=category.config,template=getRandomCombinationFromArr(templates,1)[0];var result=$HASH.clone(template);var time=getRandomCombinationFromArr(timeAttr,config.att_time),geo=getRandomCombinationFromArr(geoAttr,config.att_geo),attr=[].concat(getRandomCombinationFromArr(preferredAttr,Math.min(preferredAttr.length,config.att))).concat(getRandomCombinationFromArr(otherAttr,Math.max(0,config.att-preferredAttr.length))),mx=[].concat(getRandomCombinationFromArr(preferredMx,Math.min(preferredMx.length,config.mx))).concat(getRandomCombinationFromArr(otherMx,Math.max(0,config.mx-preferredMx.length)));var getObjName=function(item,encode){if(encode){return STR.encodeHtmlString(item&&item.n||"");}return item&&item.n||"";};result.n=result.n.replace(new RegExp(M1,"g"),getObjName(mx[0],false)).replace(new RegExp(M2,"g"),getObjName(mx[1],false)).replace(new RegExp(A1,"g"),getObjName(attr[0],false)).replace(new RegExp(AT1,"g"),getObjName(time[0],false)).replace(new RegExp(AG1,"g"),getObjName(geo[0],false));result.html=result.html.replace(new RegExp(M1,"g"),STR.encodeHtmlString(getObjName(mx[0]))).replace(new RegExp(M2,"g"),STR.encodeHtmlString(getObjName(mx[1]))).replace(new RegExp(A1,"g"),STR.encodeHtmlString(getObjName(attr[0]))).replace(new RegExp(AT1,"g"),STR.encodeHtmlString(getObjName(time[0]))).replace(new RegExp(AG1,"g"),STR.encodeHtmlString(getObjName(geo[0])));return result;}function generateSampleQuestions(){var result=[],listofDatasets=[],questionCountPerDataset={};$ARRAY.forEach($HASH.keyarray(categorizedDatasets),function(set){listofDatasets.push(set);questionCountPerDataset[set]=[];});$ARRAY.forEach($HASH.keyarray(categorizedDatasets),function(set){var cntOfQuestionsForEachCategory=[];$ARRAY.forEach(SAMPLE_Q_TEMPLATE,function(category){var cntQues=getCntOfDistinctQuestion(category,categorizedDatasets[set]);cntOfQuestionsForEachCategory.push(cntQues);});var cntTotalArr=$ARRAY.map(cntOfQuestionsForEachCategory,function(element){return element.total;});questionCountPerDataset[set]=cntTotalArr;});$ARRAY.forEach(SAMPLE_Q_TEMPLATE,function(category,idx){var rand=Math.floor(Math.random()*listofDatasets.length);if(questionCountPerDataset&&listofDatasets&&listofDatasets[rand]){var randDataset=listofDatasets[rand];if(questionCountPerDataset[randDataset][idx]>0){result.push(generateSampleQuestion(category,categorizedDatasets[randDataset]));}else{if(questionCountPerDataset[randDataset][idx]===0){var listOfDatasetsInShuffle=mstrmojo.hash.clone(listofDatasets),i=0,randShuffleDataset=listOfDatasetsInShuffle[rand],questionsCountForRandomSet=questionCountPerDataset[randShuffleDataset];while(questionsCountForRandomSet&&questionsCountForRandomSet[idx]===0&&i<listOfDatasetsInShuffle.length){var chosen=randShuffleDataset,index=listOfDatasetsInShuffle.indexOf(chosen);if(index>-1){listOfDatasetsInShuffle.splice(index,1);}rand=Math.floor(Math.random()*listOfDatasetsInShuffle.length);randShuffleDataset=listOfDatasetsInShuffle[rand];questionsCountForRandomSet=questionCountPerDataset[randShuffleDataset];i++;}if(randShuffleDataset&&questionsCountForRandomSet&&questionsCountForRandomSet[idx]&&questionsCountForRandomSet[idx]>0){result.push(generateSampleQuestion(category,categorizedDatasets[randShuffleDataset]));}}}}});return result;}mstrmojo.vi.models._IsNLPModel=mstrmojo.provide("mstrmojo.vi.models._IsNLPModel",{_mixinName:"mstrmojo.vi.models._IsNLPModel",isWordBaseBuilt:false,mapConfig:null,buildWordBase:function buildWordBase(forceRebuild){if(forceRebuild){this.isWordBaseBuilt=false;}templateWordBase={};templateWordBaseWithoutSpace={};templateObjectsByName={};if(!this.isWordBaseBuilt){var name,did,hasMultipleDS=true;_attributeTokens={};_metricTokens={};if(Object.keys){hasMultipleDS=Object.keys(this.datasets||{}).length>1;}$HASH.forEach(this.datasets,function(dataset,datasetId){var datasetName=dataset.name||"";$ARRAY.forEach(dataset.att,function(attribute){if(attribute.hide){return true;}name=attribute.n.toLowerCase();did=attribute.did.toLowerCase();attribute.datasetId=datasetId;if(hasMultipleDS){attribute.dsName=datasetName;}_attributeTokens[name]=attribute;templateWordBase[name]=TAG_TEMPLATE_OBJECT;templateWordBase[did]=TAG_TEMPLATE_OBJECT;name=name.replace(/\s/g,SPLIT_CHAR);templateWordBaseWithoutSpace[name]=TAG_TEMPLATE_OBJECT;templateWordBaseWithoutSpace[did]=TAG_TEMPLATE_OBJECT;templateObjectsByName[name]=attribute;templateObjectsByName[did]=attribute;});$ARRAY.forEach(dataset.mx,function(metric){if(metric.hide){return true;}metric.datasetId=datasetId;if(hasMultipleDS){metric.dsName=datasetName;}name=metric.n.toLowerCase();did=metric.did.toLowerCase();_metricTokens[name]=metric;templateWordBase[name]=TAG_TEMPLATE_OBJECT;templateWordBase[did]=TAG_TEMPLATE_OBJECT;name=name.replace(/\s/g,SPLIT_CHAR);templateWordBaseWithoutSpace[name]=TAG_TEMPLATE_OBJECT;templateWordBaseWithoutSpace[did]=TAG_TEMPLATE_OBJECT;templateObjectsByName[name]=metric;templateObjectsByName[did]=metric;});});categorizeObj();createObjSuggestionList();this.isWordBaseBuilt=true;}},getSuggestionListItems:function getSuggestionListItems(config,maxCnt){var pattern=config.pattern,items=[];pattern=STR.regEscape((pattern||"").trim());if(!(config&&config.showSampleQuestion)){maxCnt=maxCnt||1000;var filteredObjs=$ARRAY.filter(objSuggestionList,function(it){return(new RegExp("\\s"+pattern+"|^"+pattern,"i")).test(it.n);},{max:maxCnt});$ARRAY.forEach(filteredObjs,function(it,idx){it.matchPos=((it.n||"").toLowerCase()).indexOf((pattern||"").toLowerCase())>-1?((it.n||"").toLowerCase()).indexOf((pattern||"").toLowerCase()):Infinity;it.pos=idx;});var compa=function(a,b){if(a.matchPos<b.matchPos){return -1;}else{if(a.matchPos===b.matchPos){return a.pos-b.pos;}}return 1;};filteredObjs=(filteredObjs||[]).sort(compa);items=filteredObjs;}else{items.push({n:"",html:"You may ask a question like",type:"dummy",cls:"label"});items=items.concat(generateSampleQuestions());}return items;},getRelevantObjects:function getRelevantObjects(input){$NLP=$NLP||window.nlp;input=input.replace(/\?+$/,"").toLowerCase();this.buildWordBase(true);var inputTokens=input.split(SPLIT_CHAR);(inputTokens||[]).forEach(function(tk,idx){if(templateWordBase[tk]){if(_attributeTokens[tk]){inputTokens[idx]=_attributeTokens[tk].did;}else{if(_metricTokens[tk]){inputTokens[idx]=_metricTokens[tk].did;}}}});input=inputTokens.join("").toLowerCase();return applyMatchingRuleSet(input);},checkForMapboxKey:function(){var me=this;if(!me.mapConfig){var splitParams={taskId:"getMultiMapConfig",key:"",taskEnv:"xhr",taskContentType:"json"},callback={success:function(res){if(res){me.mapConfig=res;}},failure:function(){}};mstrApp.serverRequest(splitParams,callback);}}});mstrmojo.vi.models._IsNLPModel.isTimeAttr=isTimeAttr;}());