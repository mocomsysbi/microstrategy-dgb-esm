(function(){mstrmojo.requiresCls("mstrmojo.ui.PopupConfig","mstrmojo.array","mstrmojo.hash","mstrmojo.css","mstrmojo.ui._HasUITheme","mstrmojo.vi.ui.theme","mstrmojo.dom");function toggleLockInfoWinForScroll(owner,lock){if(!mstrmojo.DocInfoWindow){return ;}var w=owner;while(w){if(w instanceof mstrmojo.DocInfoWindow){w[lock?"registerScrollLock":"releaseScrollLock"](this);break;}w=w.parent;}}var $ARR=mstrmojo.array,$DOM=mstrmojo.dom,$HASH=mstrmojo.hash,$CSS=mstrmojo.css,$PX="px",$ENUM_THEME_NAMES=mstrmojo.ui._HasUITheme.EnumThemeNames;var isDebugging=false;function toggleLockInfoWin(owner,lock){if(!mstrmojo.DocInfoWindow){return ;}var w=owner;while(w){if(w instanceof mstrmojo.DocInfoWindow){w[lock?"registerLock":"releaseLock"](this);this.lockIW=lock?w:null;break;}w=w.parent;}}var $PC=mstrmojo.ui.PopupConfig,$DIRCFG=$PC.directionCfg,$ENUM_CORNERS=$PC.ENUM_CORNERS,ENUM_CORNER_TOP_LEFT=$ENUM_CORNERS.TOP_LEFT,ENUM_CORNER_TOP_RIGHT=$ENUM_CORNERS.TOP_RIGHT,ENUM_CORNER_BOTTOM_RIGHT=$ENUM_CORNERS.BOTTOM_RIGHT,ENUM_CORNER_BOTTOM_LEFT=$ENUM_CORNERS.BOTTOM_LEFT;function isCornerLeft(corner){return(corner===ENUM_CORNER_BOTTOM_LEFT||corner===ENUM_CORNER_TOP_LEFT);}function isCornerRight(corner){return(corner===ENUM_CORNER_TOP_RIGHT||corner===ENUM_CORNER_BOTTOM_RIGHT);}function isCornerBottom(corner){return(corner===ENUM_CORNER_BOTTOM_RIGHT||corner===ENUM_CORNER_BOTTOM_LEFT);}function isCornerTop(corner){return(corner===ENUM_CORNER_TOP_RIGHT||corner===ENUM_CORNER_TOP_LEFT);}function calculateOverflowDirections(cfg,bodyPos,hostElemPos,menuPos){var hostX=hostElemPos.x,hostY=hostElemPos.y,hostWidth=hostElemPos.w||0,hostHeight=hostElemPos.h||0,menuWidth=menuPos.w,menuHeight=menuPos.h,corners=cfg.alignment,popupCorner=corners.popup,hostCorner=corners.host,isHostAlignedRight=isCornerRight(hostCorner),isHostAlignedBottom=isCornerBottom(hostCorner),hasOverflowedRight=false,hasOverflowedBottom=false,hasOverflowedLeft=false,hasOverflowedTop=false,checkOverflowLeft=false,checkOverflowTop=false,isMobile=$DOM.isMobile,DIRCFG=mstrmojo.ui.PopupConfig.directionCfg;if(isCornerLeft(popupCorner)){var menuRightPos=hostX+menuWidth+(isHostAlignedRight?hostWidth:0);hasOverflowedRight=bodyPos.w<menuRightPos;checkOverflowLeft=isMobile&&(hasOverflowedRight||DIRCFG.isRightToLeft());}if(isCornerTop(popupCorner)){var menuBottomPos=hostY+menuHeight+(isHostAlignedBottom?hostHeight:0);hasOverflowedBottom=bodyPos.h<menuBottomPos;checkOverflowTop=isMobile&&hasOverflowedBottom;}if(isCornerRight(popupCorner)||checkOverflowLeft){var menuLeftPos=hostX-menuWidth+((isHostAlignedRight&&!checkOverflowLeft)?hostWidth:0);hasOverflowedLeft=menuLeftPos<0;}if(isCornerBottom(popupCorner)||checkOverflowTop){var menuTopPos=hostY-menuHeight+((isHostAlignedBottom&&!checkOverflowTop)?hostHeight:0);hasOverflowedTop=menuTopPos<0;}return{top:hasOverflowedTop,bottom:hasOverflowedBottom,left:hasOverflowedLeft,right:hasOverflowedRight};}function callPopupHandlers(isOpen){var popupConfig=this.popupConfig;if(popupConfig){$HASH.forEach(popupConfig.popupHandlers,function(h,id){var fn=h[isOpen?"open":"close"];if(fn){fn.call(mstrmojo.all[id]||fn,!!isOpen);}});}}function setHostProxyVisibility(show){var cfg=this.popupConfig;if(cfg&&!cfg.isHostedWithin){var hostProxy=this.hostProxy;if(hostProxy){hostProxy.style.display=show?"":"none";}}}function isValidPosValue(v){return v!==undefined&&v!==null&&!isNaN(v);}mstrmojo._IsPopup={visible:false,lockIWForScroll:false,disposable:true,opener:null,onOpen:mstrmojo.emptyFn,onClose:mstrmojo.emptyFn,popupConfig:null,hostProxy:undefined,open:function open(opener,config){callPopupHandlers.call(this,true);if(this.updatePopupConfig){this.updatePopupConfig(config,opener);}else{$HASH.forEach(config,function(v,k){this.set(k,v);},this);}var positionCSS="popup-mid-render";this.set("opener",opener);if(!this.hasRendered){var currentVisible=this.visible;this.visible=false;this.render();$CSS.addClass(this.domNode,positionCSS);this.set("visible",currentVisible);}if(this.nudge){this.domNode.style.top="-10000px";}setHostProxyVisibility.call(this,true);this.set("visible",true);if(this.lockIWForScroll){toggleLockInfoWinForScroll.call(this,this.opener,true);}if(config&&config.lockIW){toggleLockInfoWin.call(this,config.lockIW,true);}if(this.nudge){this.nudge();}if(this.adjustSize){this.adjustSize();}this.adjustCornersForPopupOverflow();this.onOpen();$CSS.removeClass(this.domNode,positionCSS);},adjustCornersForPopupOverflow:function adjustCornersForPopupOverflow(){var cfg=this.popupConfig;if(!cfg){return false;}var includeScroll=(cfg.includeScroll!==undefined)?cfg.includeScroll:true;var anchor=cfg.anchorElement||cfg.hostElement,popupAnchorPos=cfg.position||$DOM.position(anchor,includeScroll),zIndex=anchor&&anchor.style&&anchor.style.zIndex;if(!cfg.isHostedWithin){var oldHostProxy=this.hostProxy,hostProxyElement=this.hostProxy=document.createElement("div");document.body.appendChild(hostProxyElement);hostProxyElement.appendChild(this.domNode);if(oldHostProxy){oldHostProxy.parentNode.removeChild(oldHostProxy);}var divStyle=hostProxyElement.style,POS_TO_STYLE_ATTR_MAP={x:"left",y:"top",w:"width"};hostProxyElement.className=cfg.hostProxyCssClass;divStyle.position="absolute";divStyle.background="none";$CSS.addClass(hostProxyElement,"mstrmojo-popup-widget-hosted");divStyle.height="0";$ARR.forEach(["x","y","w"],function(posProp){var popupAnchorProp=popupAnchorPos[posProp];if(isValidPosValue(popupAnchorProp)){divStyle[POS_TO_STYLE_ATTR_MAP[posProp]]=popupAnchorProp+$PX;}});}var cornersEnum=cfg.ENUM_CORNERS,BOTTOM_LEFT=cornersEnum.BOTTOM_LEFT,BOTTOM_RIGHT=cornersEnum.BOTTOM_RIGHT,TOP_RIGHT=cornersEnum.TOP_RIGHT,TOP_LEFT=cornersEnum.TOP_LEFT;var bodyPos=$DOM.position(document.body),menuPos=$DOM.position(this.domNode),overflowDirections=calculateOverflowDirections(cfg,bodyPos,popupAnchorPos,menuPos),hasOverflowedRight=overflowDirections.right,hasOverflowedBottom=overflowDirections.bottom,hasOverflowedLeft=overflowDirections.left,hasOverflowedTop=overflowDirections.top,corners=cfg.alignment,originalPopupCorner=corners.popup,originalHostCorner=corners.host,popupCorner=originalPopupCorner,hostCorner=originalHostCorner,isMobile=$DOM.isMobile,isSubMenu=anchor&&anchor.classList&&anchor.classList.contains("mstrmojo-ui-Menu-item"),currentMenuId=this.id,parentNode=anchor&&anchor.parentNode,parentElement=parentNode&&parentNode.parentElement,parentMenu=anchor||this.domNode,parentPos,domNodeStyle=this.domNode.style;if(parentElement&&parentElement.classList.contains("mstrmojo-ui-Menu")){parentMenu=parentElement;}parentPos=$DOM.position(parentMenu);if(isSubMenu&&((hasOverflowedLeft&&hasOverflowedRight)||(hasOverflowedTop&&hasOverflowedBottom))){if(parentElement){domNodeStyle.top=parentPos.y+"px";domNodeStyle.left=parentPos.x+"px";var allMenus=document.getElementsByClassName("mstrmojo-ui-Menu");$ARR.forEach(allMenus,function(currentMenu){if(currentMenuId!==currentMenu.id){currentMenu.style.visibility="hidden";}});}cfg.anchorElement=parentMenu;cfg.position={h:0,w:0,x:(parentPos.x+menuPos.w)>bodyPos.w?Math.min(parentPos.x,5):parentPos.x,y:(parentPos.y+menuPos.h)>bodyPos.h?Math.min(parentPos.y,90):parentPos.y};this.adjustCornersForPopupOverflow();return ;}if($DIRCFG.isRightToLeft()&&(!isMobile||menuPos.w>0)){if(!isMobile||!hasOverflowedLeft){hasOverflowedRight=true;}else{if(!isMobile||!hasOverflowedRight){$DIRCFG.setDirection(false);this.resetDirection=true;if(isMobile){hostCorner=(hostCorner===TOP_RIGHT)?TOP_LEFT:BOTTOM_LEFT;}}}}else{if(hasOverflowedRight){$DIRCFG.setDirection(true);this.resetDirection=true;}}if(hasOverflowedRight||hasOverflowedLeft){if(isCornerLeft(hostCorner)){hostCorner=isCornerTop(hostCorner)?TOP_RIGHT:BOTTOM_RIGHT;}else{if(isCornerRight(hostCorner)){hostCorner=isCornerTop(hostCorner)?TOP_LEFT:BOTTOM_LEFT;}}if(hasOverflowedRight&&isCornerLeft(popupCorner)){popupCorner=isCornerTop(popupCorner)?TOP_RIGHT:BOTTOM_RIGHT;}else{if(hasOverflowedLeft&&isCornerRight(popupCorner)){popupCorner=isCornerTop(popupCorner)?TOP_LEFT:BOTTOM_LEFT;}}}if(hasOverflowedBottom||hasOverflowedTop){if(isCornerLeft(hostCorner)){hostCorner=isCornerTop(hostCorner)?BOTTOM_LEFT:TOP_LEFT;}else{if(isCornerRight(hostCorner)){hostCorner=isCornerTop(hostCorner)?BOTTOM_RIGHT:TOP_RIGHT;}}if(hasOverflowedBottom&&isCornerTop(popupCorner)){popupCorner=isCornerLeft(popupCorner)?BOTTOM_LEFT:BOTTOM_RIGHT;}else{if(hasOverflowedTop&&isCornerBottom(popupCorner)){popupCorner=isCornerLeft(popupCorner)?TOP_LEFT:TOP_RIGHT;}}}if(hasOverflowedTop||hasOverflowedRight||hasOverflowedBottom||hasOverflowedLeft){if(isDebugging){console.log("Overflow directions: "+JSON.stringify(overflowDirections));}this._orgalgn={host:originalHostCorner,popup:originalPopupCorner};cfg.setAlignment(hostCorner,popupCorner);}if(!cfg.isHostedWithin){if(isValidPosValue(popupAnchorPos.y)&&isValidPosValue(popupAnchorPos.h)){this.hostProxy.style.top=(popupAnchorPos.y+(isCornerBottom(popupCorner)?(cfg.alignWithAnchor===true?popupAnchorPos.h:0):(cfg.alignWithAnchor===true?0:popupAnchorPos.h)))+$PX;this.hostProxy.style.zIndex=(isValidPosValue(zIndex)&&(zIndex>100))?zIndex+1:101;}}var hostStyle,hostBorder={};if(cfg.isHostedWithin&&!!this.opener){hostStyle=$CSS.getComputedStyle(this.opener.domNode);}$ARR.forEach(["left","right","top","bottom"],function(position){hostBorder[position]=hostStyle?parseInt(hostStyle["border-"+position+"-width"]||0,10):0;});var isHostBottom=isCornerBottom(hostCorner),isHostRight=isCornerRight(hostCorner),isPopupBottom=isCornerBottom(popupCorner),isPopupRight=isCornerRight(popupCorner),setPositionToHundredPercent=function(pos,includeBorder){return"calc(100% + "+(includeBorder?hostBorder[pos]:0)+"px)";},setPositionToZero=function(pos,includeBorder){return(includeBorder?-hostBorder[pos]:0)+"px";};var top,right,bottom,left;top=right=bottom=left="auto";if(isPopupBottom){bottom=isHostBottom?setPositionToZero("top"):setPositionToHundredPercent("top");}else{top=isHostBottom?setPositionToHundredPercent("bottom"):setPositionToZero("bottom");}if(isPopupRight){right=isHostRight?setPositionToZero("left"):setPositionToHundredPercent("left");}else{left=isHostRight?setPositionToHundredPercent("right"):setPositionToZero("right");}domNodeStyle.top=top;domNodeStyle.right=right;domNodeStyle.bottom=bottom;domNodeStyle.left=left;var curPos=$DOM.position(this.domNode),minMenuPos=5;if(hasOverflowedBottom||hasOverflowedTop){var curY=curPos.y,maxWinH=$DOM.getMaxScrollHeight()+"px",scrollNode=this.scrollNode,scrollNodeMaxHeight=scrollNode&&scrollNode.style.maxHeight;if(curY<0||(curY+curPos.h>bodyPos.h)){if(scrollNode&&maxWinH!==scrollNodeMaxHeight){scrollNode.style.maxHeight=maxWinH;this.updateScrollbars();}var domNodeStyleTop=(-popupAnchorPos.y+minMenuPos)+$PX;if(!cfg.isHostedWithin){if(this.hostProxy){this.hostProxy.style.top=0;}domNodeStyleTop=minMenuPos+$PX;}domNodeStyle.top=domNodeStyleTop;domNodeStyle.bottom="auto";}}if(hasOverflowedLeft||hasOverflowedRight){var curX=curPos.x;if(curX<0||(curX+curPos.w>bodyPos.w)){var domNodeStyleLeft=(-popupAnchorPos.x+minMenuPos)+$PX;if(!cfg.isHostedWithin){if(this.hostProxy){this.hostProxy.style.left=0;}domNodeStyleLeft=minMenuPos+$PX;}domNodeStyle.left=domNodeStyleLeft;domNodeStyle.right="auto";}}return true;},close:function close(config){if(this.keepOpen){return ;}if(this.onClose){this.onClose(config);}setHostProxyVisibility.call(this,false);if(this.lockIWForScroll){toggleLockInfoWinForScroll.call(this,this.opener,false);}this.set("visible",false);this.set("opener",null);if(this.lockIW){toggleLockInfoWin.call(this,this.lockIW,false);}callPopupHandlers.call(this,false);var originalAlignment=this._orgalgn;if(originalAlignment){this.popupConfig.setAlignment(originalAlignment.host,originalAlignment.popup);}if(this.resetDirection){this.resetDirection=false;$DIRCFG.setDirection(false);}},preBuildRendering:function preBuildRendering(props){this._super(props);var popupCfg=this.popupConfig;if(popupCfg&&!popupCfg.isHostedWithin){var css=popupCfg.hostProxyCssClass.split(" "),isThemeDefined=false;$ARR.forEach($HASH.keyarray($ENUM_THEME_NAMES),function(themeName){if(css.indexOf($ENUM_THEME_NAMES[themeName])>=0){isThemeDefined=true;return false;}});if(!(isThemeDefined||popupCfg.noInheritTheme)){var themeClassName=mstrmojo.vi.ui.theme.getThemeClass.call(this);if(themeClassName){css.push(themeClassName);}}popupCfg.hostProxyCssClass=css.join(" ");}},buildRendering:function buildRendering(){var res=this._super();if(res){if(!this.parent&&!this.domNode.parentElement){document.body.appendChild(this.domNode);}}return res;},postBuildRendering:function postBuildRendering(){var me=this,popupCfg=this.popupConfig;if(popupCfg&&!this._ListenerProc){this._ListenerProc=function(){me.monitorWindow();};$DOM.attachEvent(window,"resize",this._ListenerProc);}this._super();},monitorWindow:function(){var maxHeight=$DOM.getMaxScrollHeight();if(this.updateScrollbars&&this.scrollNode){this.scrollNode.style.maxHeight=(this.scrollNodeMaxHeight||maxHeight)+"px";this.updateScrollbars();}if(this.visible){var me=this,timeoutId=null;window.clearTimeout(timeoutId);timeoutId=window.setTimeout(function(){me.scrollNode.style.maxHeight=(me.scrollNodeMaxHeight||maxHeight)+$PX;me.adjustCornersForPopupOverflow();},175);}},destroy:function destroy(ignoreDom){if(this._ListenerProc){$DOM.detachEvent(window,"resize",this._ListenerProc);delete this._ListenerProc;}this._super(ignoreDom);},unrender:function unrender(ignoreDom){if(this.popupConfig&&!this.popupConfig.isHostedWithin&&this.hostProxy){document.body.removeChild(this.hostProxy);delete this.hostProxy;}this._super(ignoreDom);}};}());