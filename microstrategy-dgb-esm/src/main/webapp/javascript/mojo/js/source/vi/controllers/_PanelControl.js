(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.hash","mstrmojo.string","mstrmojo.func","mstrmojo.EnumRWUnitType ","mstrmojo.DocDataService","mstrmojo.vi.controllers.EnumPanelManipulationType","mstrmojo.vi.controllers.EnumEvents","mstrmojo.vi.controllers.ControlUtils","mstrmojo.vi.models.VIComponentMap.TYPES","mstrmojo.vi.models._PanelActions");var ARRAY=mstrmojo.array,HASH=mstrmojo.hash,STR=mstrmojo.string,FUNC=mstrmojo.func,PANEL_MANIPULATION_TYPE=mstrmojo.vi.controllers.EnumPanelManipulationType,VI_TYPES=mstrmojo.vi.models.VIComponentMap.TYPES,ENUM_RW_UNIT_TYPE=mstrmojo.EnumRWUnitType,EVENTS=mstrmojo.vi.controllers.EnumEvents,UTILS=mstrmojo.vi.controllers.ControlUtils,REQUEST_DEFN_DATA=mstrmojo.DocDataService.REQUEST_DEFN_DATA,defnUpdatePanelRemoval=mstrmojo.vi.models._PanelActions.defnUpdatePanelRemoval;function deletePanelWithinLayout(params){var model=this.model,modelId=model.id,layoutKey=params.layoutKey,panelKeys=[].concat(params.panelKeys),currentLayoutKey=model.getCurrentLayoutKey(),targetSources,partialRetrievalNodes=[];var stack=model.getVIComponent(VI_TYPES.VIZ_CONTENT,layoutKey),stackId=stack.id;var cmdMgr=model.cmdMgr(),actions=[];ARRAY.forEach(panelKeys,function(key){actions.push(model.getRemoveVisPanelAction(key));});if(stack){var panels=stack.panels,deleteIdx=[],selectedIdx=stack.selectedIdx,currentSelectedPanel=panels[selectedIdx],currentSelectedPanelKey=currentSelectedPanel&&currentSelectedPanel.k,panel,selecedIdxDeleted=false;ARRAY.forEach(panelKeys,function(panelKey){var index=ARRAY.find(panels,"k",panelKey);deleteIdx.push(index);if(index===selectedIdx){selecedIdxDeleted=true;}});var newSelectedPanel=null;if(selecedIdxDeleted){newSelectedPanel=panels[UTILS.findNewSelectedIndex(deleteIdx,selectedIdx,panels.length)];}if(currentLayoutKey===layoutKey){var layout=stack.model.getCurrentLayoutDef(),cgbMap=layout.cgbMap,units=layout.units,vizKey,bc,sc,np,ucNode,source;targetSources={};partialRetrievalNodes=[];ARRAY.forEach(panelKeys,function(delKey){ARRAY.forEach(panels,function(pan,idx){if(ARRAY.indexOf(deleteIdx,idx)===-1){ARRAY.forEach(pan.children,function(ch){np=HASH.walk("boxContent.node.data.navpage",ch);if(np&&np===delKey){partialRetrievalNodes.push(ch.k);}});}});panel=model.getPanel(delKey,layoutKey);ARRAY.forEach(panel.children,function(viz){vizKey=viz.k;HASH.forEach(cgbMap,function(tgt,src){ucNode=units[src];if(tgt===vizKey&&ucNode){ARRAY.forEach(ucNode.scs,function(sc){source=sc.pnk;if(units[source]){partialRetrievalNodes.push(source);}});}});bc=viz.boxContent;sc=bc&&bc.selectorControl;if(sc){HASH.forEach(sc.cgb,function(tgt){if(units[tgt]){partialRetrievalNodes.push(tgt);}});}});});if(newSelectedPanel){actions.push(model.getSetCurrentPanelAction(newSelectedPanel.k));}}var fnRemoveAndSelect=function(cmdMgr){var unit,act,pr,np;var stack=mstrmojo.all[stackId],panels=stack.panels;stack.removePanelsByIndex(deleteIdx);stack.selectedIdx=panels.indexOf(newSelectedPanel||currentSelectedPanel);if(currentLayoutKey===layoutKey){if(newSelectedPanel){var key=newSelectedPanel.k;if(!newSelectedPanel.defn.l&&cmdMgr){var update=stack.model.getDataService().newUpdateWithoutCmd();stack.selectPanelDeferred(update,key,false,true);update.cmd=cmdMgr.getInterimCmd();if(partialRetrievalNodes.length){act=update.actions[0];act.partialRetrieval=act.partialRetrieval||{};pr=act.partialRetrieval;pr.nodes=(pr.nodes||[]).concat(partialRetrievalNodes);}update.submit();}else{HASH.forEach(partialRetrievalNodes,function(source){ARRAY.forEach(panels,function(pan){unit=pan.getUnitByKey(source);if(unit){unit=unit.boxContent.node;np=unit.data.navpage;targetSources[source]={sc:unit.data.sc,an:unit.defn.an,data:np&&unit.data};delete unit.data.sc;delete unit.defn.an;if(np){unit.data={};}return false;}});});stack.selectPanel(key,false,true);if(cmdMgr){cmdMgr.getInterimCmd().completeSubmit();}}}else{cmdMgr.getInterimCmd().completeSubmit();stack.notifyPanelSelector();}}else{cmdMgr.getInterimCmd().completeSubmit();}panel=null;defnUpdatePanelRemoval.call(mstrmojo.all[modelId],true,layoutKey,panelKeys);};model.execute({execute:function(){this.submitInterim(actions,{success:function(){fnRemoveAndSelect(cmdMgr);}},{params:{suppressData:true}});},urInfo:{silent:false,undo:function(){var unit,stack=mstrmojo.all[stackId],panels=stack.panels,deletedPanels=[];ARRAY.forEach(panelKeys,function(panelKey){deletedPanels.push(model.getPanel(panelKey,layoutKey));});stack.addChildren(deletedPanels);defnUpdatePanelRemoval.call(mstrmojo.all[modelId],false,layoutKey,panelKeys);stack.selectPanel(currentSelectedPanelKey,null,true);stack.sortPanels(selectedIdx);HASH.forEach(targetSources,function(val,source){ARRAY.forEach(panels,function(pan){unit=pan.getUnitByKey(source);if(unit){unit=unit.boxContent.node;if(val.data){unit.data=val.data;}unit.data.sc=val.sc;unit.defn.an=val.an;return false;}});});},redo:fnRemoveAndSelect,callback:{success:function(res){mstrmojo.all[modelId].raiseEvent({name:EVENTS.UPDATE_TOC});if(res){mstrmojo.all[modelId].partialUpdate(res.data,ARRAY.hash(partialRetrievalNodes),res.defn,partialRetrievalNodes);}}},extras:{style:{params:{treesToRender:partialRetrievalNodes.length?3:1}}}}});}else{model.execute({execute:function(){this.submit(actions,{success:function(){defnUpdatePanelRemoval.call(mstrmojo.all[modelId],true,layoutKey,panelKeys);}},{params:{suppressData:true}});},urInfo:{silent:true,undo:function(){defnUpdatePanelRemoval.call(mstrmojo.all[modelId],false,layoutKey,panelKeys);},redo:function(){defnUpdatePanelRemoval.call(mstrmojo.all[modelId],true,layoutKey,panelKeys);}}});}}function duplicatePanel(params){var model=this.model,modelId=model.id,layoutKey=params.layoutKey,panelKey=params.panelKey,panelStack=model.getVIComponent(VI_TYPES.VIZ_CONTENT,layoutKey),stackId=panelStack.id,panels,newPanel,toDelete,panel=model.getPanel(panelKey,layoutKey),panelIdx=ARRAY.find(panelStack.panels,"k",panelKey)+1,newPanelNode=model.createNewUnitNode(null,function(defn){defn.t=ENUM_RW_UNIT_TYPE.PANEL;return defn;}),newPanelKey=newPanelNode.k;model.duplicatePanel(panel,panelStack,panelIdx,layoutKey,panelStack.builder,{undo:function(){var stack=mstrmojo.all[stackId];panels=stack.panels;newPanel=model.getPanel(newPanelKey,layoutKey);if(newPanel){stack.removePanel(newPanel);defnUpdatePanelRemoval.call(mstrmojo.all[modelId],true,layoutKey,newPanelKey);toDelete=newPanel;stack.selectPanel(panel.k,false,true);}},redo:function(){var stack=mstrmojo.all[stackId];stack.addChildren([newPanel],panelIdx);defnUpdatePanelRemoval.call(mstrmojo.all[modelId],false,layoutKey,newPanelKey);stack.selectPanel(newPanelKey,null,true);toDelete=null;},discard:function(){if(toDelete){toDelete.destroy();}}},newPanelNode);}function movePanel(params){var model=this.model,modelId=model.id,layoutKey=params.layoutKey,panelKeys=[].concat(params.panelKeys),toIdx=[].concat(params.toIdx),fromIdx=[].concat(params.fromIdx),panelStack=model.getVIComponent(VI_TYPES.VIZ_CONTENT,layoutKey),stackId=panelStack&&panelStack.id,selectedIdx=panelStack&&panelStack.selectedIdx;var callback=!!(panelStack)?function(from,to){var panelToMove=null;ARRAY.forEach(panelKeys,function(key,idx){panelToMove=mstrmojo.all[modelId].getPanel(key,layoutKey);if(selectedIdx===from[idx]){selectedIdx=to[idx];}else{if(from[idx]>selectedIdx&&to[idx]<=selectedIdx){selectedIdx++;}else{if(from[idx]<selectedIdx&&to[idx]>=selectedIdx){selectedIdx--;}}}var stack=mstrmojo.all[stackId];panelToMove=stack.children[ARRAY.find(stack.children,"id",panelToMove.id)];stack.changePanelPosition(panelToMove,from[idx],to[idx],ARRAY.find(stack.children,"k",panelToMove.k),selectedIdx);});}:mstrmojo.emptyFn;model.movePanelsInLayout(panelKeys,undefined,layoutKey,toIdx,fromIdx,callback);}function renamePanel(params){var model=this.model,layoutKey=params.layoutKey,panelKey=params.panelKey,panelStack=model.getVIComponent(VI_TYPES.VIZ_CONTENT,layoutKey),stackId=panelStack&&panelStack.id,panel=model.getPanel(panelKey,layoutKey),newTitle=params&&params.newTitle,oldTitle=params&&params.oldTitle;model.updateTitle(newTitle,oldTitle,panelKey,layoutKey,"ttl",{success:function(newTitle){if(panel){if(panel.destroyed===true){mstrmojo.all[stackId].panels.forEach(function(item){if(item.k===panelKey){panel=item;}});}panel.titleText=newTitle;panel.title=STR.encodeHtmlString(newTitle);model.raiseEvent({name:"ontitleChange",newTitle:newTitle,panelKey:panel.k});}if(mstrmojo.all[stackId]){mstrmojo.all[stackId].notifyPanelSelector();}}});}function addNewPanel(params){var model=this.model,doc=this.view,dataService=model.getDataService(),layoutKey=params.layoutKey,panelStackKey=params.panelStackKey,panelStack=model.getVIComponent(VI_TYPES.VIZ_CONTENT,layoutKey),addedPanel,toDelete;if(panelStack){model.execute({execute:function(){var update=dataService.newUpdate(this,null);doc.showLayout((doc._layouts||[]).filter(function(layout){return layout.k===layoutKey;})[0],undefined,update);addedPanel=model.addPanel(update,panelStackKey,layoutKey);model.addVisualizationDeferred(update,addedPanel.k,layoutKey);model.selectNewPanel(update,addedPanel.k);update.submit();},urInfo:{disablePU:true,treesToRender:3,callback:UTILS.rebuildAndUpdateTOCcallback.call(model)},discard:function(){if(toDelete){toDelete.destroy();}}});}else{model.execute({execute:function(){var update=dataService.newUpdate(this,null);doc.showLayout((doc._layouts||[]).filter(function(layout){return layout.k===layoutKey;})[0],undefined,update);var newPanelKey={k:null};model.addPanel(update,panelStackKey,layoutKey,newPanelKey);newPanelKey=newPanelKey.k;var visNode=model.createNewUnitNode(null,null,null,null,layoutKey);update.addActions([model.getCopyEmptyTemplateAction(visNode.k,newPanelKey,layoutKey),model.getSetCurrentPanelAction(newPanelKey)]);update.submit();},urInfo:{disablePU:true,treesToRender:3,callback:UTILS.rebuildAndUpdateTOCcallback.call(model)},discard:function(){if(toDelete){toDelete.destroy();}}});}}function movePanelCrossChapter(params){var model=this.model,modelId=model.id,panelKeys=[].concat(params.panelKeys),srcPanelKey=panelKeys[0],srcPanelStackKey=params.srcPanelStackKey,srcLayoutKey=params.srcLayoutKey,tgtPanelStackKey=params.tgtPanelStackKey,tgtLayoutKey=params.tgtLayoutKey,toIdx=params.toIdx,isAllPageSelected=params.isAllPageSelected,addedPanel;var getMovePanelCrossChapterUpdate=function(cmd){var dataService=model.getDataService(),docView=model.controller.view,update=dataService.newUpdate(),srcPanel=model.getPanel(srcPanelKey,srcLayoutKey),dstPanelKey,destination;if(tgtLayoutKey){model.markDirtyLayout(tgtLayoutKey);docView.showLayout(docView.getLayout(tgtLayoutKey),null,update);destination={parentKey:tgtPanelStackKey};cmd.urInfo=HASH.copy({undo:function(){defnUpdatePanelRemoval.call(mstrmojo.all[modelId],false,srcLayoutKey,[srcPanelKey]);defnUpdatePanelRemoval.call(mstrmojo.all[modelId],true,tgtLayoutKey,[dstPanelKey]);},redo:function(){defnUpdatePanelRemoval.call(mstrmojo.all[modelId],true,srcLayoutKey,[srcPanelKey]);defnUpdatePanelRemoval.call(mstrmojo.all[modelId],false,tgtLayoutKey,[dstPanelKey]);},callback:FUNC.wrapMethods({success:function(){model.markDirtyLayout(srcLayoutKey);model.markDirtyLayout(tgtLayoutKey);}},UTILS.rebuildAndUpdateTOCcallback.call(model))},this.urInfo);}dstPanelKey=srcPanelKey;update.addActions(dataService.getMacroMoveNodeAction(srcPanel,destination));update.addActions(dataService.getMoveNodeActionUsingKey(dstPanelKey,ENUM_RW_UNIT_TYPE.PANEL,tgtPanelStackKey,toIdx));update.addCallbacks({success:function(){defnUpdatePanelRemoval.call(mstrmojo.all[modelId],true,srcLayoutKey,[srcPanelKey]);}});model.markDirtyLayout(srcLayoutKey);srcPanel.destroy();update.addActions([{act:"setCurrentPanel",unitKey:dstPanelKey}]);update.addExtras(REQUEST_DEFN_DATA);return update;};if(isAllPageSelected){model.execute({execute:function(){var dataService=model.getDataService();var update=dataService.newUpdate();addedPanel=model.addPanel(update,srcPanelStackKey,srcLayoutKey,undefined,true);var addedPanelKey=addedPanel.k;model.addVisualizationDeferred(update,addedPanelKey,srcLayoutKey);model.selectNewPanel(update,addedPanelKey);update.addCallbacks({success:function(){var cmd=model.cmdMgr().getInterimCmd(),update=getMovePanelCrossChapterUpdate(cmd);cmd.urInfo.undo=FUNC.composite([cmd.urInfo.undo,function(){defnUpdatePanelRemoval.call(mstrmojo.all[modelId],true,srcLayoutKey,[addedPanelKey]);}]);cmd.urInfo.redo=FUNC.composite([cmd.urInfo.redo,function(){defnUpdatePanelRemoval.call(mstrmojo.all[modelId],false,srcLayoutKey,[addedPanelKey]);}]);cmd.submitUpdate(update,model.cmdMgr().CMD_PHASE.LAST);}});this.submitUpdate(update,model.cmdMgr().CMD_PHASE.FIRST);},urInfo:{treesToRender:3,disablePU:true}});}else{model.execute({execute:function(){var update=getMovePanelCrossChapterUpdate(this);this.submitUpdate(update);},urInfo:{treesToRender:3}});}}function movePanelToNewChapter(params){var model=this.model,dataService=model.getDataService(),doc=this.view,cmdMgr=model.cmdMgr(),newChapterIdx=params.newChapterIdx,srcChapterKey=params.srcChapterKey,srcPanelKey=params.panelKeys[0];model.execute({execute:function execute(){var update=model.getDataService().newUpdate(this),newChapterKey=model.getNextKey();model.addNewLayout(update,{nodeKey:newChapterKey,index:newChapterIdx+1},mstrmojo.func.wrapMethods(doc.getRedisplayLayoutCallback(newChapterIdx,newChapterKey,doc.getSelectedLayoutWidget()),{success:function(){var boxes=model.replaceKeyBoxes,boxFormatCmd=model.cmdMgr().getInterimCmd(),boxUpdate=model.getDataService().newUpdate(boxFormatCmd,{extras:mstrmojo.DocDataService.SUPPRESS_DATA});if(boxes&&boxes.length>0){ARRAY.forEach(boxes,function(unit){unit.addSaveBoxLayoutActions(boxUpdate,true);});}model.clearMapLayout();boxUpdate.addCallbacks({success:function success(){var movePanelCmd=cmdMgr.getInterimCmd(),moveUpdate=dataService.newUpdate(movePanelCmd),newlyPanelStackKey=model.getVisPanelStackKey(newChapterKey);var srcPanel=model.getPanel(srcPanelKey,srcChapterKey);var destination={parentKey:newlyPanelStackKey};var dstPanelKey=srcPanelKey;var destroyPanel=function(){var srcPanel=model.getPanel(srcPanelKey,srcChapterKey);model.markDirtyLayout(srcChapterKey);srcPanel.destroy();};moveUpdate.addActions(dataService.getMacroMoveNodeAction(srcPanel,destination));moveUpdate.addCallbacks({success:function(){defnUpdatePanelRemoval.call(model,true,srcChapterKey,[srcPanelKey]);}});movePanelCmd.urInfo.redo=function(){destroyPanel();defnUpdatePanelRemoval.call(model,true,srcChapterKey,[srcPanelKey]);};destroyPanel();var panelKeyToBeDelete=model.getVisPanelKeys(newChapterKey)[0];moveUpdate.addActions([model.getRemoveVisPanelAction(panelKeyToBeDelete)]);moveUpdate.addActions([{act:"setCurrentPanel",unitKey:dstPanelKey,disablePU:true}]);moveUpdate.addExtras(REQUEST_DEFN_DATA);moveUpdate.addCallbacks(UTILS.rebuildAndUpdateTOCcallback.call(model));movePanelCmd.submitUpdate(moveUpdate,cmdMgr.CMD_PHASE.LAST);}});boxFormatCmd.submitUpdate(boxUpdate,cmdMgr.CMD_PHASE.MIDDLE);}}));this.submitUpdate(update,cmdMgr.CMD_PHASE.FIRST);},urInfo:{treesToRender:3,callback:UTILS.rebuildAndUpdateTOCcallback.call(model)}});}mstrmojo.vi.controllers._PanelControl=mstrmojo.provide("mstrmojo.vi.controllers._PanelControl",{_mixinName:"mstrmojo.vi.controllers._PanelControl",manipulatePanel:function manipulatePanel(params){switch(params&&params.type){case PANEL_MANIPULATION_TYPE.DELETE:deletePanelWithinLayout.call(this,params);break;case PANEL_MANIPULATION_TYPE.DUPLICATE:duplicatePanel.call(this,params);break;case PANEL_MANIPULATION_TYPE.MOVE:movePanel.call(this,params);break;case PANEL_MANIPULATION_TYPE.NEW:addNewPanel.call(this,params);break;case PANEL_MANIPULATION_TYPE.RENAME:renamePanel.call(this,params);break;case PANEL_MANIPULATION_TYPE.CROSS_CHAPTER_MOVE:movePanelCrossChapter.call(this,params);break;case PANEL_MANIPULATION_TYPE.MOVE_TO_NEW_CHAPTER:movePanelToNewChapter.call(this,params);break;}}});}());