(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.hash","mstrmojo.chart.model.enums.EnumDSSObjectType","mstrmojo.models.datasets.DataInterface","mstrmojo.vi.models.DropZonesModel","mstrmojo.vi.viz.MapHelper","mstrmojo.vi.viz.EnumDSSDropZones","mstrmojo.gmaps.EnumActions","mstrmojo.gmaps.MapUtils","mstrmojo.gmaps.MapEnums");mstrmojo.requiresClsP("mstrmojo.vi.models","_DropZoneCommon");mstrmojo.requiresClsP("mstrmojo.vi.util","TemplateUtils","ThresholdUtils");var $MOJO=mstrmojo,$ARR=$MOJO.array,$HASH=$MOJO.hash,$EDZ=$MOJO.vi.viz.EnumDSSDropZones,$MH=$MOJO.vi.viz.MapHelper,$EOT=$MOJO.chart.model.enums.EnumDSSObjectType,$DU=$MOJO.vi.ui.DatasetUnitMenuUtils,$VI_UTILS=$MOJO.vi.util,$THRESHOLD_UTILS=$VI_UTILS.ThresholdUtils,$TEMPLATE_UTILS=$VI_UTILS.TemplateUtils,ENUM_TARGET=$MOJO.vi.models.DropZonesModel.ENUM_TARGET_POSITION,$GMAPS=$MOJO.gmaps,$MUTIL=$GMAPS.MapUtils,$EnumPropertyType=$GMAPS.EnumPropertyType,$EnumGraphicType=$GMAPS.EnumGraphicType,$EnumActions=$GMAPS.EnumActions,$FEATURES=mstrmojo.vi.enums.EnumFeatures,$EnumBaseMapType=$GMAPS.EnumBaseMapType,$EnumLayerZoneSource=mstrmojo.gmaps.EnumLayerZoneSource;var restrictTooltip=true;function _isSameUnit(item,m){return(!!m)&&item.did===m.did;}mstrmojo.vi.models.MapDropZones=mstrmojo.declare(mstrmojo.vi.models.DropZonesModel,[mstrmojo.vi.models._DropZoneCommon],{help:"editor_panel_map.htm",dirtyVP:false,getHost:function getHost(isPrimary){var host=this._super();if(!!host){return(isPrimary!==true)?host.getEditingHost():host;}},getRequiredItemsInfo:function getRequiredItemsInfo(type){if(!type){return 0;}var allItems=[];this.getDropZones(true).zones.forEach(function(zone){if(zone){allItems=allItems.concat(zone.items);}});return Number(allItems.reduce(function(sum,item){if(parseInt(item.did,10)!==-1&&item.t===type){return sum+1;}return sum;},0));},getDropZones:function getDropZones(excludeLayerZone,layerKey){var zoneModel=[],me=this,getTitle=function(id){switch(id){case $EDZ.GeoAttribute:return mstrmojo.desc(13830);case $EDZ.Latitude:return mstrmojo.desc(13831);case $EDZ.Longitude:return mstrmojo.desc(13832);case $EDZ.SliceBy:return mstrmojo.desc(13833);case $EDZ.Angle:case $EDZ.SizeBy:return mstrmojo.desc(13829);case $EDZ.ColorBy:if(me.isMapBox()){return mstrmojo.desc(11668);}return mstrmojo.desc(13829);case $EDZ.AdditionalMetrics:return mstrmojo.desc(11668);}return"";},host=this.getHost(true),isImageMap,vp,layerZone,isMapboxArea;if(!layerKey&&host){layerKey=host.getEditingGridKey();}if(!$MUTIL.checkDefined(layerKey)){return{zones:zoneModel};}vp=host.getProperties(layerKey);if(!excludeLayerZone&&!mstrApp.isInVFConfigMode){layerZone=host.getLayerZoneControl($EnumLayerZoneSource.DROP_ZONE);if(layerZone){layerZone.n="Layers";zoneModel.push(layerZone);}}isImageMap=host.getBaseMapType()===$EnumBaseMapType.Image;isMapboxArea=this.isMapBoxArea();$HASH.forEach(this.getZonesCfg(),function(z){if(z.show(vp)){var zoneName=z.n;if(isImageMap){if(z.id===$EDZ.Latitude){zoneName="Y";}else{if(z.id===$EDZ.Longitude){zoneName="X";}}}zoneModel.push(me.getZone(zoneName,z.id,host.getDropZoneItems(z.id,layerKey),false,{allowSingle:z.id===$EDZ.GeoAttribute&&isMapboxArea?false:z.allowSingle,title:getTitle(z.id)}));}});if(!excludeLayerZone){this.dropZones=zoneModel;}return{n:host.node.defn.ttl,zones:zoneModel};},getZonesCfg:function getZonesCfg(){return mstrmojo.vi.viz.MapHelper.zonesCfg;},getAllZones:function(layerKey){return this.getDropZones(true,layerKey).zones||[];},getClearAllUnitsActions:function getClearAllUnitsActions(layerKey){var actions=[];(this.getAllZones(layerKey)).forEach(function(zone){((zone&&zone.items)||[]).forEach(function(item){Array.prototype.push.apply(actions,this.getRemoveDropZoneUnitActions(zone,item));},this);},this);return actions;},getZone:function getZone(n,id,src,disabled,extraParas){if((id===$EDZ.Latitude||id===$EDZ.Longitude)&&src[0]&&(src[0].t===21)){var geoDZ=this.getHost(true).getEditingDropZoneItems($EDZ.GeoAttribute),geoId=geoDZ.length>0?geoDZ[0].id:null,geo=$TEMPLATE_UTILS.findUnitsById(this.getHostModel().gsi,geoId)[0];if(geo){return this._super(n,id,[{did:src[0].id,t:21,n:geo.n+"@"+((id===$EDZ.Latitude)?mstrmojo.desc(7696,"Latitude"):mstrmojo.desc(7697,"Longitude"))}],disabled,extraParas);}}return this._super(n,id,src,disabled,extraParas);},getUnitMenuItems:function getUnitMenuItems(cfg,zone,item,editableLabelNode){if(!item||!zone){return ;}var items=zone.items,cnt=items.length,zid=zone.id,itemContext={zone:zone,idx:$ARR.indexOf(items,item),cnt:cnt,item:item,useDropzone:true},me=this,id=this.id,isInVFConfigMode=mstrApp.isInVFConfigMode,createDADMPriv=mstrmojo.resolveFeature($FEATURES.INSERT_NEW_METRIC),dModel=this.docModel,did=item.did,dataset=$DU.getDatasetFromAttributeId(dModel.datasets,did),needSep=false;if(item.t===$EOT.DssTypeAttributeForm){return ;}if(item.t===$EOT.DssTypeMetric&&!isInVFConfigMode){if(item.um){cfg.addMenuItem(mstrmojo.desc(3224,"Edit..."),"",function(){me.editDerivedMetric(itemContext,"edit");},itemContext);cfg.addSeparator();}if(createDADMPriv){if(dModel.findDatasetIdFromUnit(did)&&!dModel.isFromSolrCube(did)&&!dModel.isFromMDXCube(did)){cfg.addSubMenuItem(mstrmojo.desc(11806,"Aggregate By"),"",id,me.getAggregateByMetricSubMenu,itemContext);cfg.addSeparator();}cfg.addEditorMenuItem(mstrmojo.desc(5188,"Calculation"),id,me.getCalculationEditorCfg,itemContext);cfg.addMenuItem(mstrmojo.desc(13624,"Create Metric..."),"",function(){me.newDerivedMetric(itemContext);},itemContext);}}else{if((!dataset||!dModel.isMDXDataset(dataset))&&!isInVFConfigMode){if(item.da){cfg.addMenuItem(mstrmojo.desc(3224,"Edit..."),"",function(){me.editDerivedAttribute(itemContext);},itemContext);cfg.addSeparator();}if(item.t===12){if(this.allowInsertNewAttribute(zone)&&!this.isDynamicLink(item)&&createDADMPriv){cfg.addMenuItem(mstrmojo.desc(13625,"Create Attribute..."),"",function(){me.newDerivedAttribute(itemContext);},itemContext);}}}if((zone.id===$EDZ.GeoAttribute||zone.id===$EDZ.SliceBy||zone.id===$EDZ.AdditionalMetrics)&&this.shouldShowDisplayFormsMenu(item)){var geo=this.getZoneModelByZoneId($EDZ.GeoAttribute)||{},lat=this.getZoneModelByZoneId($EDZ.Latitude)||{},lng=this.getZoneModelByZoneId($EDZ.Longitude)||{};if(this.isPolygonMap()||($ARR.find((geo.items||[]).concat(lat.items||[]).concat(lng.items),"did",item.did)<0)){cfg.addEditorMenuItem(mstrmojo.desc(11908,"Display Attribute Forms"),id,function(){return me.getDisplayFormsMenu(item);});}}}cfg.addSeparator();if(this.showNumberFormat(item)&&zid!==$EDZ.GeoAttribute&&zid!==$EDZ.Latitude&&zid!==$EDZ.Longitude){cfg.addEditorMenuItem(mstrmojo.desc(13237,"Number Format"),id,this.getNumberFormatEditorCfg,itemContext);needSep=true;}if(item.t===$EOT.DssTypeMetric&&zid===$EDZ.ColorBy){this.buildThresholdMenuOptions(cfg,itemContext,true);needSep=true;}if(needSep){cfg.addSeparator();}if(me.hasReplaceCandidates(itemContext)&&(!(mstrApp.isAppStatePresentation&&mstrApp.isAppStatePresentation())||!!mstrmojo.resolveFeature($FEATURES.WEB_DRILL_AND_LINK))){cfg.addSubMenuItem(mstrmojo.desc(14003,"Replace With"),"",id,me.getReplaceSubMenu,itemContext);}cfg.addMenuItem(mstrmojo.desc(1388,"Rename"),id,function(){mstrmojo.all[id].renameItem(editableLabelNode,item);});cfg.addMenuItem(mstrmojo.desc(190,"Remove"),"xt",function(){mstrmojo.all[id].deleteItem(zone,itemContext.idx);});},isPolygonMap:function isPolygonMap(){var props=this.getEditingVp();return !!props&&(props[$EnumPropertyType.graphicType]===$EnumGraphicType.Area);},buildThresholdMenuOptions:function buildThresholdMenuOptions(cfg,itemContext,isColorBy){var vis=this.getHost();vis.model.buildThresholdMenuOptions(cfg,itemContext,isColorBy,this.canSupportImageThreshold());},showNumberFormat:function showNumberFormat(item){var vis=this.getHost();return vis.model.showNumberFormat(item);},getNumberFormatEditorCfg:function getNumberFormatEditorCfg(itemContext){var vis=this.getHost();return vis.model.getNumberFormatEditorCfg(itemContext);},getAllowDropInfo:function getAllowDropInfo(zone,dragItems,idx,edge,context){var baseInfo=this._super(zone,dragItems,idx,edge,context),candidates=baseInfo.allowedItems,isReplacing=edge===ENUM_TARGET.ON,maxAllowNum={max:1},isMapBoxArea=this.isMapBoxArea(),allowedItems,removeReplaced,zoneItemLen,me=this,filterCandidates=function(type,checkUnequal){return $ARR.filter(candidates,function(item){return checkUnequal?(item.t!==type):(item.t===type);},maxAllowNum);},checkDep=function(target){var sliceDZ,sliceItems,matched,candidate;switch(target){case $EDZ.AdditionalMetrics:sliceDZ=me.getZoneModelByZoneId($EDZ.SliceBy);sliceItems=sliceDZ&&sliceDZ.items;candidate=candidates&&candidates[0];if(candidate&&me.isAttribute(candidate)&&sliceItems&&sliceItems.length){matched=$ARR.some(sliceItems,function(ele){return candidates.length&&_isSameUnit(candidate,ele);});if(!matched||sliceItems.length>1){candidates=filterCandidates($EOT.DssTypeAttribute,true);}}break;default:break;}};if(!zone){return baseInfo;}switch(zone.id){case $EDZ.GeoAttribute:if(isMapBoxArea){maxAllowNum={max:2};}candidates=filterCandidates($EOT.DssTypeAttribute);break;case $EDZ.Latitude:case $EDZ.Longitude:candidates=filterCandidates($EOT.DssTypeAttribute);break;case $EDZ.SliceBy:maxAllowNum=null;candidates=filterCandidates($EOT.DssTypeAttribute);break;case $EDZ.Angle:case $EDZ.SizeBy:candidates=filterCandidates($EOT.DssTypeMetric);break;case $EDZ.ColorBy:if(this.isMapBox()){candidates=filterCandidates($EOT.DssTypeAttributeForm,true);}else{candidates=filterCandidates($EOT.DssTypeMetric);}break;case $EDZ.AdditionalMetrics:maxAllowNum=null;candidates=filterCandidates($EOT.DssTypeAttributeForm,true);break;}if(restrictTooltip){checkDep(zone.id);}removeReplaced=isReplacing&&zone.items&&zone.items[idx]&&$ARR.find(candidates,"did",zone.items[idx].did)===-1;if(isMapBoxArea&&zone.id===$EDZ.GeoAttribute){if(!candidates||candidates.length<=0){allowedItems=[];}else{zoneItemLen=(zone.items&&zone.items.length)||0;if(zoneItemLen>=2){if(removeReplaced){allowedItems=[candidates[0]];}else{allowedItems=[];}}else{if(zoneItemLen===1){if(isReplacing){allowedItems=candidates;}else{allowedItems=$ARR.filter(candidates,function(cd){return cd.did!==zone.items[0].did;},{max:1});}}else{allowedItems=candidates;}}}}else{allowedItems=(maxAllowNum&&zone.items&&!(zone.items.length<maxAllowNum.max||isReplacing))?[]:candidates;}return $HASH.copy({allowedItems:allowedItems,removeReplaced:removeReplaced},baseInfo);},getDropActions:function getDropActions(zone,dropInfo,dsid){if(!zone||!dropInfo){return[];}var items=dropInfo.allowedItems,idx=dropInfo.idx,firstItem=items[0],zid=zone.id,actions=[],getLatitudeForm=function(attr){var r=null;$ARR.forEach(attr.fs||[],function(f){if($MH.isLatitude(f.fnm,f.fgr)&&f.obf){r=f;return false;}});return r;},getLongitudeForm=function(attr){var r=null;$ARR.forEach(attr.fs||[],function(f){if($MH.isLongitude(f.fnm,f.fgr)&&f.obf){r=f;return false;}});return r;};if(!zid){return actions;}actions=actions.concat(this.getCreateDropZonesAction(zid));if(this.hasLatLngZone()&&zid===$EDZ.GeoAttribute){var lat=getLatitudeForm(firstItem),lng=getLongitudeForm(firstItem);if(!lat||!lng){if(lat&&$MH.isLatitude(firstItem.n)){zid=$EDZ.Latitude;zone=this.getZoneModelByZoneId(zid);}else{if(lng&&$MH.isLongitude(firstItem.n)){zid=$EDZ.Longitude;zone=this.getZoneModelByZoneId(zid);}}}}if(!zone){return actions;}if(dropInfo.edge===ENUM_TARGET.ON&&dropInfo.removeReplaced){var del=this.getRemoveDropZoneUnitActions(zone,zone.items[idx]);if(del){actions=actions.concat(del);if((zid===$EDZ.Latitude||zid===$EDZ.Longitude)&&zone.items[0].t===21){var delZone=this.getZoneModelByZoneId($EDZ.GeoAttribute),delItems=delZone&&delZone.items;if(delItems&&delItems[0]){actions=actions.concat(this.getRemoveDropZoneUnitActions(delZone,delItems[0]));}delZone=this.getZoneModelByZoneId(zone.id===$EDZ.Latitude?$EDZ.Longitude:$EDZ.Latitude);delItems=delZone&&delZone.items;if(delItems&&delItems[0]&&delItems[0].t===21){actions=actions.concat(this.getRemoveDropZoneUnitActions(delZone,delItems[0]));}}}}var tgtIdx=this.getDropTargetIndex(zone,dropInfo);$ARR.insert(actions,null,this.getAddDropZoneUnitsActions(zone,items,tgtIdx,{datasetId:dsid}));this.checkExistingUnitsToRemove(zid,items,actions);this.checkAndAddThresholdAction(zid,firstItem,actions);if(this.isMapBox()){actions=this.checkAndAddToTooltipZone(zid,items,actions,{datasetId:dsid});}var addForm=function(form){actions.push({act:"addForm",unitId:firstItem.did,attFormId:form.fid,unitPos:1});};if(zid===$EDZ.GeoAttribute){this.addClearZoneAction(actions,$EDZ.Latitude);this.addClearZoneAction(actions,$EDZ.Longitude);var latForm=getLatitudeForm(firstItem),latZone=this.getZoneModelByZoneId($EDZ.Latitude),longiForm=getLongitudeForm(firstItem),lngZone=this.getZoneModelByZoneId($EDZ.Longitude);if(latForm){addForm(latForm);if(latZone){actions=actions.concat(this.getAddDropZoneUnitsActions({id:$EDZ.Latitude},[{did:latForm.fid,t:21}],0,{datasetId:dsid}));}}if(longiForm){addForm(longiForm);if(lngZone){actions=actions.concat(this.getAddDropZoneUnitsActions({id:$EDZ.Longitude},[{did:longiForm.fid,t:21}],0,{datasetId:dsid}));}}}else{if(zid===$EDZ.Latitude||zid===$EDZ.Longitude){this.addClearZoneAction(actions,$EDZ.GeoAttribute);}}return actions.length?this.getUpdateTemplateAction(actions):[];},addClearZoneAction:function addClearZoneAction(actions,zoneId){var zone=this.getZoneModelByZoneId(zoneId);if(zone&&zone.items&&zone.items.length){Array.prototype.push.apply(actions,this.getRemoveDropZoneUnitActions(zone,zone.items[0]));}},unitsDropped:function unitsDropped(zone,context,dropInfo){var data=context.src.data,actions=context.actions||[],allowedItems=dropInfo.allowedItems,me=this,docModel=me.docModel,host=me.getHost(),submittedActions,gridData=host&&host.getData();this.addAttributeNameAndTargetVisForAddUnits(gridData,allowedItems);this.checkAndWarnLargeItemsForAddUnits(allowedItems,function(){submittedActions=actions.concat(me.getDropActions(zone,dropInfo,data.dsid));docModel.checkAndNotifyVFChangeOnDZUnitsUpdate({actions:submittedActions,zm:me},function(){var _submittedActions=docModel.wrapUnsetVisualizationFilterAction(submittedActions);me.submitDropZoneUpdates(_submittedActions,context.callback);},function(){me.submitDropZoneUpdates(submittedActions,context.callback);});});},checkAndAddThresholdAction:function checkAndAddThresholdAction(zoneID,item,actions){var host=this.getHost(),colors=["#abcffa","#7ca8de","#4570af","#224b8f","#0e3270"],ranges=[0.2,0.4,0.6,0.8];if(this.isMetric(item)&&zoneID===$EDZ.ColorBy){$THRESHOLD_UTILS.addThresholds(host.model,host,host.model,item,actions,colors,ranges);return true;}return false;},checkExistingUnitsToRemove:function checkExistingUnitsToRemove(zoneID,items,actions){var geoz=this.getZoneModelByZoneId($EDZ.GeoAttribute),latz=this.getZoneModelByZoneId($EDZ.Latitude),lngz=this.getZoneModelByZoneId($EDZ.Longitude),agz=this.getZoneModelByZoneId($EDZ.Angle),cbz=this.getZoneModelByZoneId($EDZ.ColorBy),sbz=this.getZoneModelByZoneId($EDZ.SizeBy),slbz=this.getZoneModelByZoneId($EDZ.SliceBy),tz=this.getZoneModelByZoneId($EDZ.AdditionalMetrics),geos=geoz&&geoz.items.length&&geoz.items,lati=latz&&latz.items.length&&latz.items[0],lngi=lngz&&lngz.items.length&&lngz.items[0],agi=agz&&agz.items.length&&agz.items[0],cbi=cbz&&cbz.items.length&&cbz.items[0],sbi=sbz&&sbz.items.length&&sbz.items[0],slbs=slbz&&slbz.items.length&&slbz.items,tis=this.isMapBox()?[]:(tz&&tz.items.length&&tz.items),me=this,_addAction=function(zoneModel,item){Array.prototype.push.apply(actions,me.getRemoveDropZoneUnitActions(zoneModel,item));},item,ti,slb,geo,i,il,j,jl;switch(zoneID){case $EDZ.AdditionalMetrics:if(!this.isMapBox()){for(i=0,il=items.length;i<il;i++){item=items[i];if(this.isMetric(item)){if(cbi&&_isSameUnit(item,cbi)){_addAction(cbz,cbi);}if(sbi&&_isSameUnit(item,sbi)){_addAction(sbz,sbi);}if(agi&&_isSameUnit(item,agi)){_addAction(agz,agi);}}else{if(slbs){for(j=0,jl=slbs.length;j<jl;j++){slb=slbs[j];if(slb&&_isSameUnit(item,slb)){_addAction(slbz,slb);}}}if(geos){for(j=0,jl=geos.length;j<jl;j++){geo=geos[j];if(geo&&_isSameUnit(item,geo)){_addAction(geoz,geo);this.addClearZoneAction(actions,$EDZ.Latitude);this.addClearZoneAction(actions,$EDZ.Longitude);}}}if(lati&&_isSameUnit(item,lati)){_addAction(latz,lati);}if(lngi&&_isSameUnit(item,lngi)){_addAction(lngz,lngi);}}}}break;case $EDZ.ColorBy:case $EDZ.SizeBy:case $EDZ.Angle:item=items[0];if(this.isMetric(item)&&tis){for(i=0;i<tis.length;i++){ti=tis[i];if(_isSameUnit(item,ti)){_addAction(tz,ti);}}}break;case $EDZ.SliceBy:for(i=0,il=items.length;i<il;i++){item=items[i];if(this.isMetric(item)){continue;}if(tis){for(j=0,jl=tis.length;j<jl;j++){ti=tis[j];if(!this.isMetric(ti)&&(restrictTooltip||_isSameUnit(item,ti))){_addAction(tz,ti);}}}if(geos){for(j=0,jl=geos.length;j<jl;j++){geo=geos[j];if(geo&&_isSameUnit(item,geo)){_addAction(geoz,geo);this.addClearZoneAction(actions,$EDZ.Latitude);this.addClearZoneAction(actions,$EDZ.Longitude);}}}if(lati&&_isSameUnit(item,lati)){_addAction(latz,lati);}if(lngi&&_isSameUnit(item,lngi)){_addAction(lngz,lngi);}}break;case $EDZ.GeoAttribute:for(i=0,il=items.length;i<il;i++){item=items[i];if(!this.isMetric(item)){if(tis){for(i=0;i<tis.length;i++){ti=tis[i];if(_isSameUnit(item,ti)){_addAction(tz,ti);}}}if(slbs){for(j=0,jl=slbs.length;j<jl;j++){slb=slbs[j];if(slb&&_isSameUnit(item,slb)){_addAction(slbz,slb);}}}if(lati&&_isSameUnit(item,lati)){_addAction(latz,lati);}if(lngi&&_isSameUnit(item,lngi)){_addAction(lngz,lngi);}}}break;case $EDZ.Latitude:item=items[0];if(!this.isMetric(item)){if(tis){for(i=0;i<tis.length;i++){ti=tis[i];if(_isSameUnit(item,ti)){_addAction(tz,ti);}}}if(slbs){for(j=0,jl=slbs.length;j<jl;j++){slb=slbs[j];if(slb&&_isSameUnit(item,slb)){_addAction(slbz,slb);}}}if(lngi&&_isSameUnit(item,lngi)){_addAction(lngz,lngi);}}break;case $EDZ.Longitude:item=items[0];if(!this.isMetric(item)){if(tis){for(i=0;i<tis.length;i++){ti=tis[i];if(_isSameUnit(item,ti)){_addAction(tz,ti);}}}if(slbs){for(j=0,jl=slbs.length;j<jl;j++){slb=slbs[j];if(slb&&_isSameUnit(item,slb)){_addAction(slbz,slb);}}}if(lati&&_isSameUnit(item,lati)){_addAction(latz,lati);}}break;default:break;}},checkAndAddToTooltipZone:function checkAndAddToTooltipZone(zid,items,actions,extra){var tooltipZone=this.getZoneModelByZoneId($EDZ.AdditionalMetrics),tooltipZoneItems=$ARR.map($ARR.ensureArray(tooltipZone&&tooltipZone.items),function(item){return item&&item.did;});items=$ARR.filter(items,function(item){return $MH.shouldSyncItemToTooltipZone(item.did,zid,tooltipZoneItems);});if(items.length>0){actions=actions.concat(this.getAddDropZoneUnitsActions({id:$EDZ.AdditionalMetrics},items,this.getItemCountInZone($EDZ.AdditionalMetrics),extra));}return actions;},getAvatarIconClass:function getAvatarIconClass(){return"viMap";},getActionsForDeleteItem:function getActionsForDeleteItem(zone,idx){var actions=this.getRemoveDropZoneUnitActions(zone,zone.items[idx]);if(zone.id===$EDZ.GeoAttribute){var latZone=this.getZoneModelByZoneId($EDZ.Latitude),lat=latZone&&latZone.items&&latZone.items[0],lngZone=this.getZoneModelByZoneId($EDZ.Longitude),lng=lngZone&&lngZone.items&&lngZone.items[0];if(lat){actions=actions.concat(this.getRemoveDropZoneUnitActions({id:$EDZ.Latitude},lat));}if(lng){actions=actions.concat(this.getRemoveDropZoneUnitActions({id:$EDZ.Longitude},lng));}}return actions;},deleteItem:function deleteItem(zone,idx){var me=this,model=me.docModel;model&&model.checkAndNotifyVFChangeOnDZUnitsUpdate({ca:[zone.id],zm:me},function(){var deleteActions=me.getActionsForDeleteItem(zone,idx);me.submitDropZoneUpdates(model.wrapUnsetVisualizationFilterAction((deleteActions&&deleteActions.length>0)?me.getUpdateTemplateAction(deleteActions):[]));},function(){me.submitDropZoneTemplateUpdates(me.getActionsForDeleteItem(zone,idx));});},deleteItems:function deleteItem(zone,items){var actions=[],id=this.id,me=this,model=me.docModel;items.forEach(function(item){var dzModel=mstrmojo.all[id];if(dzModel){actions=actions.concat(dzModel.getRemoveDropZoneUnitActions(zone,item));}});model&&model.checkAndNotifyVFChangeOnDZUnitsUpdate({ca:[zone.id],zm:me},function(){me.submitDropZoneTemplateUpdates(model.wrapUnsetVisualizationFilterAction(actions||[]));},function(){me.submitDropZoneTemplateUpdates(actions||[]);});},getEditingVp:function getEditingVp(){var data=this.getHostModel();if(data){return data.vp;}},hasLatLngZone:function hasLatLngZone(){var vp=this.getEditingVp(),graphicType=vp&&vp[$EnumPropertyType.graphicType];return !!graphicType&&graphicType!==$EnumGraphicType.Area;},isMapBox:function isMapBox(){var host=this.getHost(true);return host.scriptClass==="mstrmojo.mapbox.VisMapbox";},isMapBoxArea:function isMapBoxArea(){var host=this.getHost(true),vp=this.getEditingVp();return host.getBaseMapType()===$EnumBaseMapType.Mapbox&&vp&&vp[$EnumPropertyType.graphicType]===$EnumGraphicType.Area;},getWidgetPropsAction:function getWidgetPropsAction(){var widget=this.getHost(true),actions;widget.modelData=this.getHostModel();actions=widget.getSetPropertiesAction();delete widget.modelData;return actions&&actions[0];},getHostModel:function(){var host=this.getHost(true);if(host&&(host.getEditingGridData instanceof Function)){return host.getEditingGridData();}},getAddDropZoneUnitsActions:function getAddDropZoneUnitsActions(zone,items,idx,extras){var actions=[],me=this;items.reverse().forEach(function(item){updateVP.call(me,me.getHostModel().vp,{item:item,idx:idx,zone:zone},"onAdd");actions.push(me.getAddDropZoneUnitAction(zone,item,idx,extras));});return actions;},getAddItemActions:function(zone,items,idx,datasetId){var templateActions=this.getAddDropZoneUnitsActions(zone,items,idx,{datasetId:datasetId});this.checkAndAddThresholdAction(zone.id,items[0],templateActions);return templateActions;},getRemoveDropZoneUnitActions:function getRemoveDropZoneUnitActions(zone,item){var actions=this._super(zone,item),idx=$ARR.find(zone.items,"did",item.did);updateVP.call(this,this.getHostModel().vp,{item:item,idx:idx,zone:zone},"onDel");return actions;},submitDropZoneUpdates:function submitDropZoneUpdates(actions,callback,extras){var visMap=this.getHost(true),host=this.getHost(),prevVp={};if(!host||!visMap){return ;}actions=[].concat(actions||[]);if(this.dirtyVP){actions.push(this.getWidgetPropsAction());this.dirtyVP=false;}visMap.syncLayerProperties(host.model.data.vp,prevVp);var dzUpdateCallback=callback||host.model.docModel.controller._getXtabCallback(host);this._super(actions,dzUpdateCallback,extras);},isShowAllRows:function isShowAllRows(map){var sar=$HASH.walk("model.data.gsi.prop.sar",map);return sar===undefined||sar==="-1";},checkAttributeChanges:function checkAttributeChanges(actions){var isChanged=false,xtab=this.getHost(),tmpActions=$ARR.ensureArray(actions),_noRefresh=function(action){return action&&(((action.act===$EnumActions.add||action.act===$EnumActions.remove)&&(action.unitType===$EOT.DssTypeAttribute||action.unitType===$EOT.DssTypeAttributeForm))||(action.act===$EnumActions.addForm||action.act===$EnumActions.removeForm));},actionArr,i,il,j,jl;if(!this.isShowAllRows(xtab)){xtab.useRefresh=false;return ;}for(i=0,il=tmpActions.length;i<il;i++){if(tmpActions[i]&&tmpActions[i].act==="updateTemplate"){actionArr=tmpActions[i].actions;if(!$ARR.isArray(actionArr)){continue;}for(j=0,jl=actionArr.length;j<jl;j++){if(_noRefresh(actionArr[j])){isChanged=true;break;}}if(isChanged===true){break;}}}xtab.useRefresh=!isChanged;},canSupportImageThreshold:function canSupportImageThreshold(){var host=this.getHost(),data=host&&host.model&&host.model.data,vp=data&&data.vp;return $MH.supportImageThreshold(vp);},getCreateDropZonesAction:function getCreateDropZonesAction(zoneId){var host=this.getHost(true),dz=host&&host.getEditingDz(),actions=[];if(!$MUTIL.checkDefined(zoneId)||!$MUTIL.checkDefined(dz)){return actions;}if(zoneId===$EDZ.SliceBy&&(dz.SliceBy===undefined)){actions.push(this.getCreateDropZoneAction($EDZ.SliceBy,3,34,-1));}if(zoneId===$EDZ.Angle&&(dz.AngleBy===undefined)){actions.push(this.getCreateDropZoneAction($EDZ.Angle,4,4,1));}return actions;},getCreateDropZoneAction:function getCreateDropZoneAction(zoneId,idx,dropzone_types,sizelimit){var host=this.getHost(true),nodeKey,treeType;if(!host){return{};}nodeKey=host.getEditingGridKey();treeType=host.defn&&host.defn.tt;if(!nodeKey||!treeType){return{};}return{act:"createDefaultDropZone",treeType:treeType,nodeKey:nodeKey,zoneId:zoneId,dropzone_index:idx,dropzone_types:dropzone_types,dropzone_sizelimit:sizelimit};},hasReplaceCandidates:function(itemContext){return(!itemContext||!itemContext.zone)?null:this._super(itemContext);},destroy:function destroy(ignoreDOM){var dropZones=this.dropZones,layerZone=dropZones&&dropZones[0];if(layerZone&&layerZone.destroy){layerZone.destroy(ignoreDOM);dropZones.splice(0,1);}this._super(ignoreDOM);}});function updateVP(vp,context,action){var zoneId=context.zone.id;if(zoneId===$EDZ.GeoAttribute&&context.idx>0){return ;}$ARR.forEach(this.getZonesCfg(),function(z){if(z.id===zoneId){z[action](vp,context);return false;}});this.dirtyVP=true;}}());