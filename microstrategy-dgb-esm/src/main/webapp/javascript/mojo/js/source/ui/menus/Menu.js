(function(){mstrmojo.requiresCls("mstrmojo.ListBase","mstrmojo._IsList","mstrmojo._CanAutoClose","mstrmojo._IsPopup","mstrmojo.ui.menus._HasMenuPopup","mstrmojo.ui.menus._IsMenuPopup","mstrmojo.ui.PopupConfig","mstrmojo.ui._HasScroller","mstrmojo.ui._HasUITheme","mstrmojo.dom","mstrmojo.css","mstrmojo.ui._HasListTooltip");var $DOM=mstrmojo.dom,$CSS=mstrmojo.css,$DIRCFG=mstrmojo.ui.PopupConfig.directionCfg;var itemMarkup={};var debug=false;function openSubMenu(item,isActionAreaClicked){if(item.pop){if(isActionAreaClicked&&item.ax){window.clearTimeout(this._popupAxTimeout);item.actionFn();this.closeAllMenus();}else{var popupConfig=item.fn.call(mstrmojo.all[item.scope],item.ctxt);var corners=popupConfig.ENUM_CORNERS,originMaxHeight=popupConfig.maxHeight,maxScrollHeight=$DOM.getMaxScrollHeight();popupConfig.setAlignment(corners.TOP_RIGHT,corners.TOP_LEFT);popupConfig.hostId=this.id;popupConfig.hostElement=this._getItemNode(item._renderIdx);popupConfig.includeScroll=this.includeScroll;popupConfig.supportsScroll=true;popupConfig.alignWithAnchor=true;popupConfig.isHostedWithin=false;popupConfig.maxHeight=originMaxHeight?Math.min(maxScrollHeight,originMaxHeight):maxScrollHeight;this.openPopup(popupConfig.newInstance());}}else{if(item.dsbld!==true){if(item.fn(item,this)!==false){this.closeAllMenus();}}}}mstrmojo.ui.menus.Menu=mstrmojo.declare(mstrmojo.ListBase,[mstrmojo._IsList,mstrmojo.ui.menus._HasMenuPopup,mstrmojo._IsPopup,mstrmojo.ui.menus._IsMenuPopup,mstrmojo._CanAutoClose,mstrmojo.ui._HasListTooltip,mstrmojo.ui._HasScroller,mstrmojo.ui._HasUITheme],{scriptClass:"mstrmojo.ui.menus.Menu",selectionPolicy:"reselect",locksHover:true,closeOnClick:true,themeClassName:"mojo-theme-dark",icnCss:"mstrmojo-ui-Menu-item-container",popupConfig:null,tooltipCss:{leftCssClass:"menuTooltip",rightCssClass:"menuTooltip"},setupScrollNodes:function(){if(this.popupConfig&&this.popupConfig.supportsScroll){this.scrollNode=this.itemsContainerNode;this.scrollbarHostNode=this.domNode;}},updateScrollbars:function(){this._super();if(this.popupConfig&&this.popupConfig.supportsScroll&&this.hasCustomScrollbar){var scrollNode=this.scrollNode;if(!scrollNode){return ;}var scrollbarWidth=$DOM.getComputedScrollbarWidth(scrollNode);scrollNode.style.marginRight=-scrollbarWidth+"px";scrollNode.style.paddingRight=0;}},onscroll:function(){this.closePopup();this._super();},init:function init(props){this._super(props);if(!!mstrApp.isWSStyling){this.themeClassName="mojo-theme-light";}if(props.themeClassName){this.themeClassName=props.themeClassName;}var menuConfig=this.popupConfig;this.items=menuConfig.getMenuItems();var css=["mstrmojo-ui-Menu","unselectable"],cfgCss=menuConfig.menuCssClass;if(cfgCss){css.push(cfgCss);}if(menuConfig.hasToggleItem){css.push("hasToggleItem");}$CSS.addWidgetCssClass(this,css);if(menuConfig&&menuConfig.supportsScroll&&menuConfig.maxHeight>0){this.icnCssText=(this.icnCssText||"")+";max-height:"+menuConfig.maxHeight+"px";}this.useRichTooltip=!!menuConfig.useTooltip;this.tstid=menuConfig.tstid;},markupMethods:{onvisibleChange:function onvisibleChange(){var isVisible=this.visible;if(!debug||isVisible){$CSS.toggleClass(this.domNode,"visible",isVisible);}}},getItemMarkup:function getItemMarkup(item,idx){if(item.getItemMarkup){return item.getItemMarkup.apply(this,[item,idx]);}var isPopup=!!item.pop,type=isPopup?"submenu":"item",markup=itemMarkup[type],replaceMarkup='<div class="micn"></div>';if(!markup){replaceMarkup+=!!mstrApp.isWSStyling?'<div class="mtxt">{@en@n}</div>':"{@en@n}";if(isPopup){replaceMarkup+='<div class="arw"></div>';}markup=this._super(item,idx).replace("{@en@n}",replaceMarkup);itemMarkup[type]=markup;}if(item.tstid){markup=markup.replace("{@tag}","{@tag} "+mstrmojo.tstid(item)+" ");}return markup;},getItemProps:function getItemProps(item,idx){var props=this._super(item,idx);props.tag="a";props.addCls("mstrmojo-ui-Menu-item");props.addCls(item.cls);return props;},onmouseover:function onmouseover(evt){var target=evt.config&&evt.config.targetHostElement?evt.config.targetHostElement:evt.getTarget(),item=this.getItemFromTarget(target),me=this,lastOpened=me._lastOpened,lastOpenIndex=lastOpened&&this.getItemFromTarget(lastOpened.popupConfig.hostElement)._renderIdx,itemNode=this.getItemNodeFromTarget(target),within=(lastOpenIndex!==undefined&&$DOM.contains(this._getItemNode(lastOpenIndex),target,true,this.domNode));if(item){this._lastHoverIx=item._renderIdx;window.clearTimeout(this._popupTimeOut);window.clearTimeout(this._popupAxTimeout);if(this._lastHoverIx!==lastOpenIndex&&!within){this._popupTimeOut=window.setTimeout(function(){if(me._lastOpened&&me._lastOpened.visible){me.closePopup();}if(me.visible&&item.pop){if(item.ax){me._popupAxTimeout=window.setTimeout(function(){$CSS.removeClass(itemNode,"hlt-ax");openSubMenu.call(me,item);},0);}else{openSubMenu.call(me,item);}}},400);if(item.pop&&item.ax){$CSS.addClass(itemNode,"hlt-ax");}}}var popupConfig=this.popupConfig;if(popupConfig&&!popupConfig.isHostedWithin&&this.opener){this.opener.raiseEvent(mstrmojo._HasMarkup.newDomEvent(evt.name,evt.hWin,evt.e,{targetHostElement:popupConfig.hostElement}));}},onclick:function onclick(evt){this._evtTarget=evt.getTarget();this._super(evt);evt.cancel();},postselectionChange:function postselectionChange(evt){var added=evt.added;if(added){var item=this.items[added[0]];openSubMenu.call(this,item,!(item.ax&&this._evtTarget.className==="arw"));delete this._evtTarget;}},oncontextmenu:function oncontextmenu(evt){$DOM.preventDefault(window,evt.e);return false;},postBuildRendering:function postBuildRendering(props){this._super(props);if(this.popupConfig.supportsScroll){var me=this;window.setTimeout(function(){me.updateScrollbars();},10);}},showTooltip:function showTooltip(e,win){var target=$DOM.eventTarget(win,e),node=this.getItemNodeFromTarget(target),item=this.getItemFromTarget(target);this.itemDisabled=item&&item.dsbld;if(node&&((item&&item.ttp)||(node.scrollWidth>node.clientWidth)||(target.scrollWidth>target.clientWidth))){this._super(e,win);}},onCloseMenuCallBack:null,onClose:function onClose(config){if(this._super){this._super(config);}this.closePopup();if(this.onCloseMenuCallBack){this.onCloseMenuCallBack();}}});}());