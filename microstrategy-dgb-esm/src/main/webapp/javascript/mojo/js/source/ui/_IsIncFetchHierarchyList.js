(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.array","mstrmojo.expr","mstrmojo.func","mstrmojo.css","mstrmojo.UUID","mstrmojo.fe.FilterUtils","mstrmojo.desc");var $FUNC=mstrmojo.func,$HASH=mstrmojo.hash,$ARR=mstrmojo.array,$EXPR=mstrmojo.expr,$CSS=mstrmojo.css,$DTP=$EXPR.DTP,$UUID=mstrmojo.UUID,$FU=mstrmojo.fe.FilterUtils,$CSS=mstrmojo.css;var GDDE_FLAG_GET_ANCESTORS=16,GDDE_FLAG_USE_OPT=32;function buildExpressionXML(attribute,branch,level){var attr=$HASH.copyProps(["did","t","st","n"],attribute),levelForm=(attribute.fs||[]).filter(function(form){return form.fnm==="LEVEL_NUMBER"||form.n==="LEVEL_NUMBER";})[0],exprNode;if(branch){exprNode={et:$EXPR.ET.AE,fn:$EXPR.FN.DESCENDANT,a:attr,es:[{v:branch.v,n:branch.n}]};if(parseInt(level,10)>=branch.lv){exprNode.cs=[{v:level-branch.lv,dtp:$DTP.INTEGER},{v:2,dtp:$DTP.INTEGER}];}}else{if(parseInt(level,10)>=0&&levelForm){exprNode={et:$EXPR.ET.AQ,fn:$EXPR.FN.EQUAL,a:attr,fm:{did:levelForm.did||levelForm.fid,n:levelForm.n||levelForm.fnm,dtp:$DTP.INTEGER},cs:[{v:level,dtp:$DTP.INTEGER}]};}}return exprNode?$FU.getExprXml(exprNode):"";}mstrmojo.ui._IsIncFetchHierarchyList=mstrmojo.provide("mstrmojo.ui._IsIncFetchHierarchyList",{_mixinName:"mstrmojo.ui._IsIncFetchHierarchyList",blockCount:500,getDataHelper:mstrmojo.emptyFn,getAttribute:mstrmojo.emptyFn,isHiearachyDisplay:mstrmojo.emptyFn,getItemMarkup:function getItemMarkup(item,idx){var mu;if(item.fetcher){mu='<{@tag} class="item fetcher {@cls}" idx="{@idx}" style="{@style}"><span class="indent" style="padding-left: {@indent}px;"></span><span class="text">{@en@n}</span></{@tag}>';}else{mu=this._super(item,idx);}return mu;},isFetcher:function isFetcher(target){if(target instanceof HTMLElement){target=this.getItemFromTarget(target);}return target&&target.fetcher;},fetchItems:function fetchItems(params,callback){this._super(params,$FUNC.wrapMethods(this.getFetchItemsCallback(params),callback));},fetchItemsThroughTaskCall:function fetchItemsThroughTaskCall(params,callback){var dataHelper=this.getDataHelper(),attribute=this.getAttribute();if(dataHelper&&attribute&&!this.isFetching){this.set("isFetching",true);var me=this,branch=params.branch,level=parseInt(params.level,10),blockBegin=params.blockBegin||1,blockCount=params.blockCount||this.blockCount,browseFlags=params.browseFlags||0;dataHelper.set("browseConfig",$HASH.copy({blockBegin:blockBegin,blockCount:blockCount,browseFlags:browseFlags,expressionXML:(branch||level>=0)?buildExpressionXML(attribute,branch,level):"",otp:attribute.t,compress:1},$HASH.copy(dataHelper.browseConfig)));dataHelper.getItems(blockBegin,$FUNC.wrapMethods({success:function(res){if(res){$HASH.copy({bb:blockBegin,bc:blockCount},res);$ARR.forEach(res.es,function(e){if(!e.pid&&e.pi>-1){e.pid=res.es[e.pi].v;delete e.pi;}$HASH.copy({lv:e.lv||0,hcd:!!e.hcd,hid:!!e.hid,dhid:!!e.hid,pid:e.pid||""},e);});}}},callback,{complete:function(res){me.set("isFetching",false);}}),{hideFailureErr:callback.failure});}},getFlatDisplayItems:function getFlatDisplayItems(items){return items.filter(function(item){var flatHidden=item.fhid;delete item.fhid;return !flatHidden;});},getFetchItemsCallback:function getFetchItemsCallback(params){var me=this,branch=params.branch,level=parseInt(params.level,10),isHiearachy=this.isHiearachyDisplay();return{success:function(res){if(res&&res.es){var es=res.es,loadCount=res.bb+res.bc-1;if(res.sz>loadCount&&!res.raad){es.push({v:"fetcher"+$UUID.create(),n:mstrmojo.desc(1005,"More..."),fetcher:true,lv:isHiearachy?(level>=0?level:(branch?branch.lv+1:0)):-1,config:$HASH.copy({blockBegin:loadCount+1},$HASH.copy(params))});}if(!isHiearachy){es.forEach(function(e){var flatHidden=e.hid,item=me.getItemByValue(e.v);delete e.epd;delete e.hid;if(item){delete e.hcd;}$HASH.copy({fhid:flatHidden,dhid:!item||item.dhid},e);});}if(me.setDisplayParent){me.setDisplayParent(es,null,true);}}}};},getMaxLevel:function getMaxLevel(){var attr=this.getAttribute(),levelFormCount=(attr&&attr.lvfs||[]).length;if(levelFormCount>0){return levelFormCount-1;}return this._super?this._super():0;},getLevels:function getLevels(){var attr=this.getAttribute(),levelForms=attr&&attr.lvfs||[];return levelForms.map(function(form,idx){return{v:idx,n:form.lvfn};});},initElements:function initElements(callback){if(this.isHiearachyDisplay()){delete this.displayRoots;var items=this.getItems(),len=items.length,item,idx;if(len>0){if(this.raad){for(var i=len-1;i>-1;i--){item=items[i];if(item.fetcher&&item.fake){item.hid=true;idx=$ARR.find(item.parent&&item.parent.children,"idx",item.idx);if(idx>-1){item.parent.children.splice(idx,1);}idx=$ARR.find(item.displayParent&&item.displayParent.displayChildren,"idx",item.idx);if(idx>-1){item.displayParent.displayChildren.splice(idx,1);}}}}this.refresh();}else{this.fetchItems({browseFlags:GDDE_FLAG_USE_OPT},callback);}}else{this.clearItemsNode();this.fetchItems({blockCount:500,browseFlags:GDDE_FLAG_GET_ANCESTORS},callback);}},clearItemsNode:function clearItemsNode(){var itemsContainerNode=this.itemsContainerNode;if(itemsContainerNode){itemsContainerNode.innerText="";this.updateScrollbars();}},onclick:function onclick(evt){var target=evt.getTarget(),itemNode=this.getItemNodeFromTarget(target),item=this.getItemFromTarget(target);if(item&&item.fetcher){if($CSS.hasClass(target,"text")){if(item.fake){var findDisplayAncestor=function(item){if(item.displayParent){if(!item.displayParent.hid){return item.displayParent;}else{return findDisplayAncestor(item.displayParent);}}},displayAncestor=findDisplayAncestor(item),displayChildren=displayAncestor?displayAncestor.displayChildren:this.getDisplayRoots(),items=this.items,nextSiblingIdx=item.config.nextSiblingIdx,bc=this.blockCount,endIdx=nextSiblingIdx+bc,nextSiblings;if(displayChildren.length-1>endIdx){nextSiblings=displayChildren.slice(nextSiblingIdx,endIdx);item.config.nextSiblingIdx+=bc;item.lv=nextSiblings[nextSiblings.length-1].lv;nextSiblings.push(item);}else{displayChildren.pop();if(item.parent){item.parent.children.pop();}items.splice($ARR.find(items,"idx",item.idx),1);nextSiblings=displayChildren.slice(nextSiblingIdx,displayChildren.length);}itemNode.outerHTML=this._buildSiblingsMarkup(nextSiblings).join("");this.updateScrollbars();}else{this.fetchItems(item.config,{success:function(res){item.hid=true;itemNode.outerHTML="";}});}}evt.cancel();}else{this._super(evt);}},});}());