(function(){mstrmojo.requiresCls("mstrmojo._HasScrollbox","mstrmojo.array","mstrmojo.css","mstrmojo.dom","mstrmojo.string","mstrmojo.Widget","mstrmojo.ui.SimpleTree","mstrmojo.DI.DIConstants","mstrmojo.DI.DIHelpers");var $MOJO=mstrmojo,$ARR=$MOJO.array,$CSS=$MOJO.css,$DOM=$MOJO.dom,$H=$MOJO.hash,$STR=$MOJO.string,$DIConstants=mstrmojo.DI.DIConstants,CLASS_SELECTED="selected",CLASS_OPEN="open",CLASS_LEAF="leaf",CLASS_LOADING="loading",INDEX_ATTR_DELIMITER=":",ITEM_TAG="li",ITEM_CONTAINER_TAG="ul",INDEX_ATTR="idx",LEVEL_ATTR="level";function buildTreeItemMarkup(item,level,index,childMarkup){var offset=this.renderIndex*this.renderBlockSize,indexArr=index.split(":"),idx=parseInt(indexArr[0],10)+offset,isSelected=!!this.selectedIndices[idx],isExpanded=!!this.expandedIndices[idx],isLeaf=(item.isLeaf||(!this.dataHelper&&!(item.items&&item.items.length)));indexArr[0]=idx;return $STR.apply('<{@tag} class="{@cls}" level="{@level}" idx="{@idx}">{@itemMkp}{@childMkp}</{@tag}>',{tag:ITEM_TAG,cls:(isSelected?CLASS_SELECTED:"")+(isExpanded?" "+CLASS_OPEN:"")+(isLeaf?" "+CLASS_LEAF:""),level:level,idx:indexArr.join(":"),itemMkp:this.itemRenderer.render(item,level,index,this),childMkp:childMarkup||""});}function buildMarkup(items,level,index){var markup=[],count=0,itemRenderer=this.itemRenderer,renderFn=itemRenderer&&itemRenderer.render,itemCount=items&&items.length,currentIndex,serializedIdx,item,i;markup[count++]="<"+ITEM_CONTAINER_TAG+">";if(renderFn&&typeof renderFn==="function"&&itemCount){for(i=0;i<items.length;i++){item=items[i];currentIndex=index.concat([i]);serializedIdx=currentIndex.join(INDEX_ATTR_DELIMITER);markup[count++]=buildTreeItemMarkup.call(this,item,level,serializedIdx,buildMarkup.call(this,item.items,level+1,currentIndex));}}markup[count]="</"+ITEM_CONTAINER_TAG+">";return markup.join("");}function getTreeItemHelper(newItems,indexStack){var firstIndex=indexStack[0];if(indexStack&&indexStack.length===1){return newItems[firstIndex];}return getTreeItemHelper(newItems[firstIndex].items,indexStack.slice(1));}function delegateSelect(mthName,el,item,level,idx,widget){var hook=widget.treeHooks[mthName];if(hook&&hook.call(widget,el,item,level,idx)){return ;}$CSS.toggleClass(el,CLASS_SELECTED,mthName==="select");}function delegateExpand(mthName,el,item,level,idx,widget){var hook=widget.treeHooks[mthName],children=item.items,hasNoItems=(!children||children.length===0),isActionExpand=mthName==="expand",dataHelper=widget.dataHelper;if(hook&&hook.call(widget,el,item,level,idx)){return ;}if(isActionExpand&&!dataHelper&&hasNoItems){$CSS.addClass(el,CLASS_LEAF);return ;}if(isActionExpand&&dataHelper){if(hasNoItems){if(item.tp==="search"){$CSS.toggleClass(el,CLASS_OPEN,isActionExpand);return ;}$CSS.toggleClass(el,CLASS_LOADING,true);dataHelper.fetch(item,{success:function success(res){var newItems=item.items=res.items;if(newItems&&newItems.length>0){el.innerHTML+=buildMarkup.call(widget,newItems,(parseInt(level,10)+1),item._renderIdx.split(INDEX_ATTR_DELIMITER));}else{$CSS.addClass(el,CLASS_LEAF);}},complete:function complete(){$CSS.toggleClass(el,CLASS_LOADING,false);}});}}$CSS.toggleClass(el,CLASS_OPEN,isActionExpand);}mstrmojo.ui.DIPublishSimpleTree=mstrmojo.declare(mstrmojo.ui.SimpleTree,[mstrmojo._HasScrollbox],{scriptClass:"mstrmojo.ui.DIPublishSimpleTree",markupString:'<div id="{@id}" class="mstrmojo-SimpleTree mstrmojo-DIPublishSimpleTree {@cssClass}" mstrAttach:click>{@itemsHTML}</div>',init:function init(props){this._super(props);},getItemMarkup:function(){return'<span class="{@cls} icon" style="display: {@icon_display}">&nbsp;</span><{@tag} class="{@cls}" style="{@style}" title={@n}>{@n}</{@tag}><div class="extra-action" style="display:{@extra_visible}">{@extra}</div>';},getItemProps:function getItemProps(item,level,index){var ret={tag:"div",cls:"item ",n:item.n||"",style:"",idx:index,icon_display:"none"};if(item.isLeaf){ret.cls+=item.dataSourceType;ret.extra_visible=item.extra?"inline-block":"none";ret.icon_display="inline-block";switch(item.dataSourceType){case $DIConstants.dataSourceType.DROPBOX:case $DIConstants.dataSourceType.GOOGLE_ANALYTICS:case $DIConstants.dataSourceType.GOOGLE_BIGQUERY:case $DIConstants.dataSourceType.GOOGLE_DRIVE:case $DIConstants.dataSourceType.SALESFORCE:if(item.extra&&item.extra.isLoggedIn){ret.extra="<div id='"+item.extra.loginEmail+"*"+index+"' class='loginName' title='"+item.extra.loginName+"'>"+item.extra.loginName+"</div>";}else{ret.extra="<div class='mstrmojo-Button mstrmojo-di-button mstrmojo-WebButton'><div class='mstrmojo-Button-text'>"+mstrmojo.desc(9935,"Log In")+"</div></div>";ret.extra_visible="inline-block";}break;case $DIConstants.dataSourceType.FILE_LOCAL:case $DIConstants.dataSourceType.FILE_URL:if(item.extra&&item.extra.isUploaded){ret.extra="<div class='mstrmojo-Button mstrmojo-di-button mstrmojo-WebButton'><div class='mstrmojo-Button-text'>"+mstrmojo.desc(764,"Change")+"</div></div>";}else{ret.extra="<div class='mstrmojo-Button mstrmojo-di-button mstrmojo-WebButton'><div class='mstrmojo-Button-text'>"+mstrmojo.desc(505,"Update")+"</div></div>";ret.extra_visible="inline-block";}break;default:ret.extra="";}}return ret;},addChild:function addChild(index,items){var $this=this,parentItems=$this.getTreeItem(index).items,indexArray=index.split(INDEX_ATTR_DELIMITER);indexArray.push(parentItems.length);if(this.hasRendered){var treeNodes=this.domNode.getElementsByTagName(ITEM_TAG);$ARR.forEach(treeNodes,function(treeNode){if(treeNode.getAttribute(INDEX_ATTR)===index){var currentItem=items[0];var div=document.createElement("div");div.innerHTML=buildTreeItemMarkup.call($this,currentItem,parseInt(treeNode.getAttribute(LEVEL_ATTR),10)+1,indexArray.join(INDEX_ATTR_DELIMITER),buildMarkup.call($this,currentItem.items,parseInt(treeNode.getAttribute(LEVEL_ATTR),10)+2,indexArray));treeNode.lastChild.appendChild(div.firstChild);parentItems.push(currentItem);return false;}return true;});}},updateChild:function updateChild(index,nodeData){var $this=this;$H.copy(nodeData,$this.getTreeItem(index));if(this.hasRendered){var treeNodes=this.domNode.getElementsByTagName(ITEM_TAG);$ARR.forEach(treeNodes,function(treeNode){if(treeNode.getAttribute(INDEX_ATTR)===index){var level=parseInt(treeNode.getAttribute(LEVEL_ATTR),10);treeNode.innerHTML=$this.itemRenderer.render(nodeData,level,index,$this)+buildMarkup.call($this,nodeData.items,level+1,index.split(INDEX_ATTR_DELIMITER));return false;}return true;});}},removeChild:function removeChild(index){var indexArray=index.split(INDEX_ATTR_DELIMITER),level=indexArray.length,lastIndex=indexArray[level-1],parentItem=this;if(level>1){indexArray=indexArray.splice(0,level-1);parentItem=this.getTreeItem(indexArray.join(INDEX_ATTR_DELIMITER));parentItem.items.splice(lastIndex,1);this.updateChild(parentItem._renderIdx,parentItem);}else{this.items.splice(lastIndex,1);this.refresh();}},getItemWithPropName:function getItemWithPropName(newItems,propName,propValue){var index=$ARR.find(newItems,propName,propValue);var i,returnVal=[];if(index!==-1){returnVal.push(newItems[index]);}for(i=0;i<newItems.length;i++){var currentItems=newItems[i].items;if(currentItems&&currentItems.length){var childItems=this.getItemWithPropName(currentItems,propName,propValue);if(childItems&&childItems.length){returnVal=returnVal.concat(childItems);}}}return returnVal;},handleForOAuthSources:function handleForOAuthSources(tableIds,dataSourceType,renderIndex){var sourceType=mstrmojo.DI.DIHelpers.convertDataSourceType2SourceType(dataSourceType),model=mstrApp.getRootController().getModel(),$this=this;if(sourceType>0){mstrApp.getRootController().setTableIDsForOAuth(tableIds);mstrApp.getRootController().gotoOAuthLogin(sourceType);model.externalSources[sourceType].attachEventListener("oAuthReportsFetched",this.id,function(){var treeNode=$this.getTreeItem(renderIndex);if(treeNode){treeNode.extra={isLoggedIn:true,loginName:model.externalSources[sourceType].userDisplayName,loginEmail:model.externalSources[sourceType].userEmail};$this.updateChild(renderIndex,treeNode);}});}else{mstrmojo.alert("can not found such source Type");}},onclick:function onclick(evt){try{var target=evt.target||$DOM.eventTarget(evt.hWin,evt.e),targetTag=target.tagName.toLowerCase(),item=$DOM.findAncestorByAttr(target,INDEX_ATTR,true,this.domNode),level=item&&item.node.getAttribute(LEVEL_ATTR),idx=item&&item.value,$this=this;if(targetTag===ITEM_CONTAINER_TAG){return ;}if(targetTag==="div"&&target.className.indexOf("loginName")>=0){var cfgEditor=new mstrmojo.ui.menus.EditorConfig({hostId:target.id,hostElement:target,isHostedWithin:false,hostProxyCssClass:"oauth-log-info-for-publish",cancelVisible:false,okBtnText:mstrmojo.desc(13380,"Log out"),contents:[{scriptClass:"mstrmojo.HBox",cssClass:"oauth-log-info-box",children:[{scriptClass:"mstrmojo.Label",cssClass:"login-icon",text:"ICON"},{scriptClass:"mstrmojo.VBox",cssClass:"oauth-log-info-box2",children:[{scriptClass:"mstrmojo.Label",cssClass:"login-name",text:target.textContent},{scriptClass:"mstrmojo.Label",cssClass:"login-email",text:target.id.split("*")[0]}]}],}],data:{}});cfgEditor.fnOk=function(){console.log("clicked.");};var listEditor=cfgEditor.newInstance();listEditor.open();return ;}var tableIds=[this.parent.data.id];if(targetTag==="button"||(targetTag==="div"&&target.className.indexOf("Button")>=0)){this.items.forEach(function(item1){item1.items.forEach(function(item2){if(item2._renderIdx===idx){$this.handleForOAuthSources(tableIds,item2.dataSourceType,idx);}});});return ;}if(idx!==null&&!isNaN(parseInt(level,10))){var config={sel:{indicesName:"selected",enabledFn:"select",disabledFn:"unselect"},ex:{indicesName:"expanded",enabledFn:"expand",disabledFn:"collapse"}}[(targetTag!==ITEM_TAG)?"sel":"ex"];var indices=this[config.indicesName+"Indices"],isActionEnabled=indices[idx];if(isActionEnabled){delete indices[idx];}else{indices[idx]=true;}this.itemRenderer[isActionEnabled?config.disabledFn:config.enabledFn](item.node,this.getTreeItem(idx),level,idx,this);}}catch(ex){mstrApp.onerror(ex);}}});}());