(function(){mstrmojo.requiresCls("mstrmojo.DocSelector","mstrmojo.fe.FilterUtils","mstrmojo.func","mstrmojo.array","mstrmojo.hash","mstrmojo.expr","mstrmojo.DocDataService");var $FU=mstrmojo.fe.FilterUtils,$ARR=mstrmojo.array,$HASH=mstrmojo.hash,$FUNC=mstrmojo.func,$EXPR=mstrmojo.expr;var LEVEL_NUMBER_NAME="LEVEL_NUMBER",SUPPRESS_DATA=mstrmojo.DocDataService.SUPPRESS_DATA;var GDDE_FLAG_GET_ANCESTORS=16,GDDE_FLAG_TERSE_ID=1;function isNDEObject(attrInfo){return attrInfo.t===47&&attrInfo.st===12033;}function getEvent(){return{type:parseInt(this.type,10),src:this.k,ck:this.ck,ctlKey:this.ckey,ckey:this.ckey,tks:this.tks};}mstrmojo.DynamicListDocSelector=mstrmojo.declare(mstrmojo.DocSelector,null,{scriptClass:"mstrmojo.DynamicListDocSelector",_ieformatHandlers:{domNode:["F","text-align","vertical-align","line-height","z-index","top","left"],contentNode:["width","B","P","height"],filterNode:["height","width","B","P","fx","background-color"],item:["color","font","text-decoration","text-align","line-height"]},formatHandlers:{domNode:["F","text-align","vertical-align","line-height","z-index","top","left"],contentNode:["height","width","B","P","fx","background-color"],item:["color","font","text-decoration","text-align","line-height"]},_buildEvent:function _buildEvent(rEvt,widget){var node=this.node,attrInfo=this.getAttrInfo(),exprJSON;exprJSON=widget.buildSelectionExprJSON(attrInfo);node.defn.set("cek",{expr:exprJSON,disablePU:true});rEvt.expr=$FU.getExprXml(exprJSON);if(this.incFetch){rEvt.prKey=this.k;}},initControlInfo:function initControlInfo(){var data=this.node.data;this._super();$HASH.copy({incFetch:data.inc!==false,levelForms:data.lvfs||[]},this);},getCekEvtListener:function getCekEvtListener(selectorContainer,selectorControl){return function(evt){var value=evt.value;if(value.hasOwnProperty("expr")){selectorContainer.expr=value.expr;if(!value.disablePU){selectorContainer.handleActionInSyncPhase(function(){selectorControl.setSelectionByExprJSON(value.expr);selectorControl.refresh();});}}};},updateWidget:function updateWidget(selectorContainer){var selectorWidget=this._super(selectorContainer),attInfo=selectorContainer.getAttrInfo(),node=selectorContainer.node,data=node.data,defn=node.defn;selectorWidget.updateItems(data.elms,data.p_relation);if(selectorContainer.lockSelection){selectorWidget.setSelectionByExprJSON(selectorContainer.expr);}else{if(data.unset){selectorWidget.setSelectionByExprJSON();}else{if(data.exp){selectorWidget.setSelectionByExprJSON(data.exp);}else{if(data.ces){selectorWidget.setSelectionByList(data.ces,defn.include);}}}selectorContainer.expr=selectorWidget.buildSelectionExprJSON(this.getAttrInfo());}selectorWidget.browseFlags=GDDE_FLAG_GET_ANCESTORS+(isNDEObject(attInfo)?0:GDDE_FLAG_TERSE_ID);return selectorWidget;},clearSelector:function clearSelector(applyNow){var evt=getEvent.call(this);this.node.defn.set("cek",{expr:null});evt.unset=true;evt[applyNow?"forceApply":"forceBuffer"]=true;this.slice(evt);},getWidgetConfig:function getWidgetConfig(selectorContainer,selectorStyle,defn,elements){var levelForms=selectorContainer.levelForms,cfg=this._super(selectorContainer,selectorStyle,defn,elements);if(levelForms.length>0){cfg.getMaxLevel=function(){return selectorContainer.getMaxLevel();};cfg.getLevels=function(){return selectorContainer.getLevels();};}cfg.getLevelExpression=function(level){var attInfo=selectorContainer.getAttrInfo();return selectorContainer.getLevelExpression(attInfo,level);};cfg.delegateExpandCollapse=function(params,callback){return selectorContainer.onExpandCollapse(params,callback,!selectorContainer.incFetch);};return cfg;},onExpandCollapse:function onExpandCollapse(params,callback,suppressData){var me=this,fps=this.isInFilterPanel()&&this.getFilterPanel(),node=this.node,defn=node.defn,model=this.model,ds=model.getDataService(),actions=[ds.getRASelectorExpandAction({ck:defn.ck,ckey:defn.ckey,elementId:params.elementId,isExpand:params.isExpand?1:0})],callbacks=suppressData?callback:$FUNC.wrapMethods({success:function(res){var bs;if(fps){bs=fps.getBufferedSlice(defn.ckey);}me.lockSelection=true;model.partialUpdate(res.data,model.getTargetDefn(node.k));me.lockSelection=false;if(fps&&bs){fps.bufferSlice(bs);}}},callback),extras=suppressData?SUPPRESS_DATA:{};model.controller.cmdMgr.execute({execute:function(){this.submit(actions,callbacks,extras);},urInfo:{extraPuKeys:defn.ck.split("\u001E").slice(1),treesToRender:3}});return !suppressData;},getMaxLevel:function getMaxLevel(){var maxLevel=0;$ARR.forEach(this.levelForms,function(form){if(form.lv>0){maxLevel=Math.max(maxLevel,form.lv);}});return maxLevel;},getLevels:function getLevels(){return $ARR.map(this.levelForms,function(form){return{v:form.lv,n:form.lvfn};});},getLevelExpression:function getLevelExpression(attrInfo,level){var levelForm=(attrInfo.fs||[]).filter(function(f){return(f.n||f.fnm)===LEVEL_NUMBER_NAME;})[0];if(levelForm&&parseInt(level,10)>=0){return{et:$EXPR.ET.AQ,fn:$EXPR.FN.EQUAL,a:$HASH.copyProps(["did","n","t","st"],attrInfo),fm:{did:levelForm.did||levelForm.fid,n:LEVEL_NUMBER_NAME,dtp:$EXPR.DTP.INTEGER},cs:[{v:level,dtp:$EXPR.DTP.INTEGER}]};}return null;},getAttrInfo:function getAttrInfo(objectId){var defn=this.node.defn,datasets=this.model.datasets,objectInfo;objectId=objectId||defn.srcid;$HASH.forEach(datasets,function(dataset){objectInfo=dataset.att.filter(function(att){return att.did===objectId;})[0];if(objectInfo){return false;}});if(objectInfo&&isNDEObject(objectInfo)){var attrInfo=this.getAttrInfo(objectInfo.attId);objectInfo.fs=attrInfo.fs;objectInfo.lvfs=attrInfo.lvfs;}return objectInfo?objectInfo:{};}});}());