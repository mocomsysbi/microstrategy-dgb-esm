(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.hash","mstrmojo.num","mstrmojo.func","mstrmojo.EnumRWUnitType","mstrmojo.storage.DOMLocalStorage");var ls=new mstrmojo.storage.DOMLocalStorage({itemTimeToLive:-1});var $MOJO=mstrmojo,$ALL=$MOJO.all,$NUM=$MOJO.num,$HASH=$MOJO.hash,$ARR=$MOJO.array,$FUC=$MOJO.func,$RWU=$MOJO.EnumRWUnitType,CONSTANTS={update:"updateTemplate",add:"addDropZoneUnit",remove:"removeDropZoneUnit",ungroup:"removeQuickDE",ungroup1:"removeNDEFromDS",add2group:"applyDEChanges",muteKey:"__MSTR_MUTE_VFN",gridStyle:"XtabGrid"};function getSelectedVisualization(){var me=this,vizBox=me.getSelectedViUnit();return vizBox&&vizBox.boxContent;}function canNotifyDropzonesUpdate(props){var actions=$ARR.ensureArray(props.actions),acts,zoneId,zonesModel=props.zm,visName=props.vn,blacklist,addCombinedZoneEnum=props.cmb,candidates=props.ca||[],key=props.k;var isAddOrRemove=function(n){return n===CONSTANTS.add||CONSTANTS.remove;};if(!!zonesModel===false){return false;}blacklist=zonesModel.getVFNotifierBlackList(visName,addCombinedZoneEnum);if(candidates.length){return $ARR.intersection(candidates,blacklist).length>0;}actions=$ARR.filter(actions,function(e){e=e||{};return(e.act===CONSTANTS.update&&e.keyContext===key)||isAddOrRemove(e.act||"");});return actions.some(function(action){action=action||{};acts=action.actions||$ARR.ensureArray(actions);return acts.some(function(act){act=act||{};zoneId=act.zoneId;zoneId=$NUM.isInt(act.zoneId)?zoneId:act.axis;return isAddOrRemove(act.act||"")&&$NUM.isInt(zoneId)&&blacklist.indexOf(zoneId)!==-1;});});}function canNotifyGroupingUpdate(props){var acts,actions=$ARR.ensureArray(props.actions),key=props.k;var isAddingGrouping=function(n){return n===CONSTANTS.add2group;};var isUnGrouping=function(n){return n===CONSTANTS.ungroup||n===CONSTANTS.ungroup1;};var _actions=$ARR.filter(actions,function(e){e=e||{};return(e.k===key&&isAddingGrouping(e.act||""))||isUnGrouping(e.act||"");});if(_actions.length>0){return true;}actions=$ARR.filter(actions,function(e){e=e||{};return(e.act===CONSTANTS.update&&e.keyContext===key);});return actions.some(function(action){action=action||{};acts=action.actions||$ARR.ensureArray(actions);return acts.some(function(act){act=act||{};return isUnGrouping(act.act||"");});});}function canNotifyClear(props){props=props||{};var blackList,visName=props.vn,clearedZones=props.ca,zonesModel=props.zm;if(zonesModel&&clearedZones){blackList=zonesModel.getVFNotifierBlackList(visName,props.cmb);return $ARR.intersection(blackList,clearedZones).length;}return false;}function canMuteNotifier(){var mute;if(!!mstrApp.muteVFNotifier){return true;}try{mute=JSON.parse(ls.getItem(CONSTANTS.muteKey))===true;}catch(e){mute=false;}return mute;}function hasVisSelection(vis){var selectionCache,visSelections,data=vis.node&&vis.node.data,sc=data&&data.sc,exp=sc&&sc.exp;if(exp&&exp.nds){return exp.nds.length>0;}selectionCache=vis.getSelectionCache&&vis.getSelectionCache();visSelections=selectionCache&&selectionCache._viSelections;return(visSelections?Object.keys(visSelections):[]).length>0;}mstrmojo.vi.models._NotificationVisFilter=mstrmojo.provide("mstrmojo.vi.models._NotificationVisFilter",{_mixinName:"mstrmojo.vi.models._NotificationVisFilter",isVisFilter:function isVisFilter(defn){var vis=null;if(defn){if(defn&&defn.iifp){return[$RWU.VISUALIZATION,$RWU.MOJOVISUALIZATION,$RWU.GRID,$RWU.GRAPH,$RWU.GRIDGRAPH].indexOf(defn.t)!==-1;}vis=$ALL[defn.id];}else{vis=getSelectedVisualization.call(this);}return vis&&vis.isInFilterPanel&&vis.isInFilterPanel();},hasSelectionOnVisFilter:function hasSelectionOnVisFilter(){var vis=getSelectedVisualization.call(this);if(vis&&vis.isInFilterPanel&&vis.isInFilterPanel()){return hasVisSelection(vis);}return false;},clearSelectionOnVisFilter:function clearSelectionOnVisFilter(updateSummary){var vis=getSelectedVisualization.call(this);if(vis&&vis.setSelectionCache){vis.setSelectionCache({});if(updateSummary){this.raiseEvent({name:"clearSelector",id:vis.id,k:vis.k});}}},needNotifyVFChange:function needNotifyVFChange(actionType,props){if(actionType==="CHANGE_VISTYPE"){return false;}props=props||{};var vis=null,defn=props.defn,cntf=false;if(defn&&defn.id){vis=$ALL[defn.id];}else{vis=getSelectedVisualization.call(this);}if(vis&&vis.isInFilterPanel&&vis.isInFilterPanel()){cntf=mstrApp.isInVFConfigMode&&hasVisSelection.call(this,vis);}if(cntf){props.k=props.k||vis.k;props.vn=$HASH.walk("model.data.visName",vis)||$HASH.walk("model.data.vis.vn",vis);if(props.vn===undefined){props.vn=vis.defn&&vis.defn.t===521?CONSTANTS.gridStyle:null;}switch(actionType){case"DROP_ZONE_UPDATE":cntf=canNotifyDropzonesUpdate.call(this,props);break;case"GROUP_UPDATE":cntf=canNotifyGroupingUpdate.call(this,props);break;case"CLEAR_ALL":cntf=canNotifyClear.call(this,props);break;case"CHANGE_VISTYPE":case"KEEPONLY_EXCLUDE":break;default:cntf=false;break;}}return cntf;},notifyVFChange:function notifyVFChange(callbacks){callbacks=callbacks||{};var me=this,vis=getSelectedVisualization.call(me),tempFn=callbacks.onConfirm,primaryMsg=mstrmojo.desc(15298,"Do you want to unset filter?"),subMsg=mstrmojo.desc(15299,"The actions which changes the data will unset the filter."),htmlMsg='<div style="font-weight: bold">'+primaryMsg+"</div><div>"+subMsg+"</div>";if(tempFn){callbacks.onConfirm=$FUC.composite([tempFn,function(){me.raiseEvent({name:"clearSelector",id:vis.id,k:vis.k});}]);}mstrmojo.warn(htmlMsg,{confirmBtn:{t:mstrmojo.desc(1442,"OK"),fn:callbacks.onConfirm||mstrmojo.emptyFn},cancelBtn:{t:mstrmojo.desc(2140,"Cancel"),fn:callbacks.onCancel||mstrmojo.emptyFn}},{title:mstrmojo.desc(14595,"Unset Filter"),allowHTML:true,children:[{scriptClass:"mstrmojo.Label",cssClass:"alert-content",text:htmlMsg,slot:"containerNode",allowHTML:true},{scriptClass:"mstrmojo.CheckBox",slot:"buttonNode",cssClass:"mstrmojo-checkbox-inline",label:mstrmojo.desc(15300,"Do not show me again"),onclick:function(){mstrApp.muteVFNotifier=this.checked;if(this.checked){ls.setItem(CONSTANTS.muteKey,true);}else{ls.removeItem(CONSTANTS.muteKey);}}}]});},wrapUnsetVisualizationFilterAction:function wrapUnsetVisualizationFilterAction(actions,ignorePU){var vis=getSelectedVisualization.call(this),sc=vis&&vis.model.data&&vis.model.data.sc,unsetAction,getMUSelectorActions=function(){var ds=this.getDataService();return ds&&ds.getMultiUnitSelectorAction({ck:sc.ck,ct:sc.ct,ctlKey:sc.ckey,selections:[],tks:sc.tks,type:521,isNavigation:false,ignoreTargetData:true});};vis.clearSelections();vis.setSelectionCache({_selectionType:vis.getSelectionType(),_viSelections:vis.getSelectionHash()});if(sc){unsetAction=getMUSelectorActions.call(this,sc);if(unsetAction&&unsetAction.partialUpdate&&ignorePU){delete unsetAction.partialUpdate;}return[unsetAction].concat($ARR.ensureArray(actions));}return actions;},checkAndNotify:function checkAndNotify(cb,cancelFn){if(canMuteNotifier()){var vis=getSelectedVisualization.call(this);this.raiseEvent({name:"clearSelector",id:vis.id,k:vis.k});return cb();}else{return this.notifyVFChange({onConfirm:cb,onCancel:cancelFn});}},checkAndNotifyVFChangeOnDZUnitsUpdate:function checkAndNotifyVFChangeOnDZUnitsUpdate(props,cb,fallbackCb){if(this.needNotifyVFChange("DROP_ZONE_UPDATE",props)){var selectUnit=this.getSelectedViUnit(),cancelFn=function(){if(selectUnit&&selectUnit.selectVIUnit){selectUnit.selectVIUnit(true);}};return this.checkAndNotify(cb,cancelFn);}fallbackCb=fallbackCb||cb;return fallbackCb();},checkAndNotifyVFChangeOnVisTypeUpdate:function checkAndNotifyVFChangeOnVisTypeUpdate(props,cb,fallbackCb){if(this.needNotifyVFChange("CHANGE_VISTYPE",props)){this.clearSelectionOnVisFilter();return this.checkAndNotify(cb);}fallbackCb=fallbackCb||cb;return fallbackCb();},checkAndNotifyVFChangeOnClearAll:function checkAndNotifyVFChangeOnClearAll(props,cb,fallbackCb){if(this.needNotifyVFChange("CLEAR_ALL",props)){this.clearSelectionOnVisFilter();return this.checkAndNotify(cb);}fallbackCb=fallbackCb||cb;return fallbackCb();},checkAndNotifyVFChangeOnGroupUpdate:function checkAndNotifyVFChangeOnGroupUpdate(props,cb,fallbackCb){if(this.needNotifyVFChange("GROUP_UPDATE",props)){this.clearSelectionOnVisFilter();return this.checkAndNotify(cb);}fallbackCb=fallbackCb||cb;return fallbackCb();},checkAndNotifyVFChangeOnKeepOnlyExclude:function checkAndNotifyVFChangeOnKeepOnlyExclude(props,cb,fallbackCb){if(this.needNotifyVFChange("KEEPONLY_EXCLUDE",props)){return this.checkAndNotify(cb);}fallbackCb=fallbackCb||cb;return fallbackCb();}});}());