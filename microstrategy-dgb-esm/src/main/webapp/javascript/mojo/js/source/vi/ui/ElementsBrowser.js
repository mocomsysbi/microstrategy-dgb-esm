(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.css","mstrmojo.expr","mstrmojo.func","mstrmojo.string","mstrmojo.Box","mstrmojo.HBox","mstrmojo.TextBox","mstrmojo.Button","mstrmojo.Label","mstrmojo._HasLayout","mstrmojo.Editor","mstrmojo.ui.CheckList","mstrmojo.ui.ToggleButton","mstrmojo.mstr.EnumDSSXMLObjectTypes");mstrmojo.requiresDescs(10,1763,15120,15801);var $ARR=mstrmojo.array,$CSS=mstrmojo.css,$DOM=mstrmojo.dom,$EXPR=mstrmojo.expr,$FUNC=mstrmojo.func,$STR=mstrmojo.string,$NWB=mstrmojo.Button.newWebButton,$OBJECT_TYPE=mstrmojo.mstr.EnumDSSXMLObjectTypes;var defaultClearAllText=mstrmojo.desc(1763,"Clear All");mstrmojo.vi.ui.IncCheckList=mstrmojo.declare(mstrmojo.ui.CheckList,[mstrmojo.ui._IsIncFetchList],{scriptClass:"mstrmojo.vi.ui.IncCheckList",allowUnlistedValues:false,cssClass:"elementsList",initElements:function initElements(callback){var dataHelper=this.ifDataHelper,me=this;if(!dataHelper){return ;}callback=$FUNC.wrapMethods({success:function(res){me.clearSelect(true);me.set("items",[]);me.initScroll();me.addItems(res&&res.es);}},callback);dataHelper.getItems(1,callback,{hideFailureErr:true});},addItems:function addItems(items){this._super(items||[]);this.postAddItems();this.updateScrollbars();},postAddItems:mstrmojo.emptyFn});function dataTypeIsSupportedForClearAll(attribute){return !$ARR.filterOne(attribute.fs,function(item){return item.isbf&&(!!item.dtp?item.dtp:$EXPR.mapBaseFormTypeToDataType(item.bftp))!==$EXPR.DTP.CHAR;});}mstrmojo.vi.ui.ElementsBrowser=mstrmojo.declare(mstrmojo.Box,[mstrmojo._HasLayout],{scriptClass:"mstrmojo.vi.ui.ElementsBrowser",markupString:'<div id="{@id}" class="mstrmojo-Box mstrmojo-ui-vi-ElementsBrowser {@cssClass}" style="{@cssText}"><div></div><div></div><div></div></div>',markupSlots:{containerNode:function(){return this.domNode;},searchBoxNode:function(){return this.domNode.firstChild;},buttonPanelNode:function(){return this.domNode.childNodes[1];},elementListNode:function(){return this.domNode.childNodes[2];}},layoutConfig:{h:{searchBoxNode:"26px",buttonPanelNode:"36px",elementListNode:"100%"},w:{searchBoxNode:"100%",buttonPanelNode:"100%",elementListNode:"100%"},xt:true},onBrowseElementsFailure:mstrmojo.emptyFn,onUpdateBrowseElementsParams:mstrmojo.emptyFn,children:[{scriptClass:"mstrmojo.HBox",slot:"searchBoxNode",alias:"util",cssClass:"elemsBrowser-utils-bar",children:[{scriptClass:"mstrmojo.Box",cssClass:"eb-box-search",alias:"box",children:[{scriptClass:"mstrmojo.TextBox",alias:"searchBox",hint:mstrmojo.desc(10,"Search"),cssClass:"eb-searchBox",valueChangeDelay:300,onEnter:function onEnter(){var text=this.value,eleBrowser=this.parent.parent.parent;eleBrowser.set("searchPattern",text);},onvalueChange:function onvalueChange(){var text=this.value,eleBrowser=this.parent.parent.parent;eleBrowser.set("searchPattern",text);}},{scriptClass:"mstrmojo.Button",cssClass:"eb-searchBox-clear",text:"",onclick:function(){var searchBox=this.parent.searchBox;searchBox.set("value","");searchBox.cleanUp();searchBox.focus();},bindings:{visible:"(this.parent.searchBox.value || '').length > 0"}}]},{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(15120,"View Selected"),cssClass:"eb-viewSelected",title:mstrmojo.desc(15120,"View Selected")},{scriptClass:"mstrmojo.ui.ToggleButton",alias:"toggleSelected",oncheckedChange:function oncheckedChange(){var eleBrowser=this.parent.parent;eleBrowser.onsearchPatternChange();}}]},{scriptClass:"mstrmojo.HBox",slot:"buttonPanelNode",alias:"buttonPanel",cssClass:"elemsBrowser-button-panel",children:[{scriptClass:"mstrmojo.Button",text:defaultClearAllText,title:defaultClearAllText,alias:"clearAllBtn",cssClass:"eb-clearAll",useRichTooltip:true,updateTooltipConfig:function updateTooltipConfig(){var targetPosition=$DOM.position(this.domNode);this.richTooltip={content:mstrmojo.desc(16192,"This function is currently not supported for non-text elements in the searching result."),cssClass:"vi-info vi-tooltip-C",left:targetPosition.x+60,top:targetPosition.y+5};},onclick:function(){var eleBrowser=this.parent.parent,eleList=eleBrowser.elementList;eleList.clearSelect(false);var localSearchItems=eleBrowser.getLocalSearchItems(),itemIdField=eleBrowser.itemIdField;eleBrowser.onItemsSelectionChange({added:[],removed:localSearchItems,itemIdField:itemIdField});$ARR.removeItems(eleBrowser.selectedItems,itemIdField,localSearchItems);},showTooltip:function showTooltip(e,win){var eleBrowser=this.parent.parent;if(!this.enabled&&!$STR.isEmpty(eleBrowser.getSearchBox().value)&&!dataTypeIsSupportedForClearAll(eleBrowser.attribute)){mstrmojo._HasTooltip.showTooltip.call(this,e,win);}}},]},{scriptClass:"mstrmojo.vi.ui.IncCheckList",alias:"elementList",slot:"elementListNode",itemIdField:null,bindings:{ifDataHelper:"this.parent.ifDataHelper",itemIdField:"this.parent.itemIdField"},postAddItems:function(){var selectedItems=this.parent.selectedItems||[];this.setSelectedItems(selectedItems);}}],itemIdField:"v",ifDataSource:null,searchPattern:null,ifDataHelper:null,attribute:null,attributeId:null,selectedItems:[],init:function(props){this._super(props);this.set("ifDataHelper",new mstrmojo.mstr.DocElementDataHelper({source:this.ifDataSource}));if(this.ifDataSource&&this.attribute){this.onattributeChange();}this.elementList.attachEventListener("selectionChange",this.id,"onElementsListchange");},updateClearAllBtnState:function updateClearAllBtnState(){this.buttonPanel&&this.buttonPanel.clearAllBtn.set("enabled",($STR.isEmpty(this.getSearchBox().value)||dataTypeIsSupportedForClearAll(this.attribute))&&(this.getLocalSearchItems().length>0));},onElementsListchange:function onElementsListchange(evt){var added=evt&&evt.added||[],removed=evt&&evt.removed||[],items=this.elementList.items,itemIdField=this.itemIdField;if(!this.selectedItems){this.selectedItems=[];}var selectedItems=this.selectedItems,addedItems=[],removedItems=$ARR.get(items,removed);$ARR.removeItems(selectedItems,itemIdField,removedItems);var item;$ARR.forEach(added,function(idx){item=items[idx];if(item&&$ARR.find(selectedItems,itemIdField,item[itemIdField])<0){selectedItems.push(item);addedItems.push(item);}});this.updateClearAllBtnState();if(removedItems.length>0||addedItems.length>0){this.onItemsSelectionChange({added:addedItems,removed:removedItems,itemIdField:itemIdField});}},onItemsSelectionChange:mstrmojo.emptyFn,updateBrowseConfig:function updateBrowseConfig(){var me=this,attrId=this.attributeId,attr=this.attribute,pattern=this.searchPattern,handleValidation=function(searchbox,message){searchbox.set("textValid",!message);searchbox.domNode.title=$STR.encodeHtmlString(message,true);};if(!attrId){return ;}this.ifDataHelper.set("items",null);var browseConfig={attributeID:attrId};if(pattern&&pattern!==""){browseConfig.searchPattern=pattern;browseConfig.matchCase=false;browseConfig.otp=attr.t||$OBJECT_TYPE.Attribute;}this.onUpdateBrowseElementsParams(browseConfig);this.ifDataHelper.set("browseConfig",browseConfig);var searchBox=me.getSearchBox();this.elementList.initElements({success:function(res){handleValidation(searchBox,"");},failure:function(res){var ec=parseInt(res.code,10)+4294967296,ERR_SDK_E_PROMPT_DATE_TIME=2147762269,ERR_SDK_E_INVALID=2147762227,ERR_SDK_E_PROMPT_NUMERICAL_VALUES=2147762262,MSI_CUBE_NOT_PUBLISHED=2147894808;if(ec===ERR_SDK_E_INVALID||ec===ERR_SDK_E_PROMPT_NUMERICAL_VALUES){handleValidation(searchBox,"");}else{if(ec!==ERR_SDK_E_PROMPT_DATE_TIME){var fn=(ec!==MSI_CUBE_NOT_PUBLISHED)?me.onBrowseElementsFailure.bind(me):null;var errorInfo={shortDesc:mstrmojo.desc(15402,"This object is not available at this time."),longDesc:res.message},editorProps={title:mstrmojo.desc(15403,"Invalid Object"),buttons:[$NWB(mstrmojo.desc(13197,"Got it"),fn,false)]};mstrmojo.error(errorInfo,undefined,editorProps);handleValidation(searchBox,"");}else{handleValidation(searchBox,res.message);}}}});var toggleBtn=this.util&&this.util.toggleSelected;if(toggleBtn){toggleBtn.checked=false;$CSS.toggleClass(toggleBtn.domNode,"checked",false);}this.updateClearAllBtnState();},isObjSearchable:function isObjSearchable(obj){return !(obj&&obj.t===$OBJECT_TYPE.Consolidation);},onattributeChange:function onattributeChange(){var attr=this.attribute;this.attributeId=attr&&attr.did;this.searchPattern=null;this.selectedItems=[];this.updateBrowseConfig();var searchBox=this.getSearchBox(),isObjectSearchable=this.isObjSearchable(attr);if(searchBox){searchBox.set("enabled",isObjectSearchable);searchBox.set("hint",isObjectSearchable?mstrmojo.desc(10,"Search"):mstrmojo.desc(15801,"Not searchable"));}},getSearchBox:function getSearchBox(){var util=this.util,box=this.util&&this.util.box;return box&&box.searchBox;},onifDataSourceChange:function onifDataSourceChange(){this.ifDataHelper.set("source",this.ifDataSource);this.ifDataHelper.set("items",null);},onsearchPatternChange:function onsearchPatternChange(){var toggleBtn=this.util&&this.util.toggleSelected;if(!toggleBtn||!toggleBtn.checked){this.updateBrowseConfig();}else{var filteredRes=this.getLocalSearchItems();this.elementList.clearSelect(true);this.elementList.set("items",[]);this.elementList.addItems(filteredRes);this.updateClearAllBtnState();}},getLocalSearchItems:function getLocalSearchItems(){var filteredRes=[],name;if(this.searchPattern&&this.searchPattern!==""){var pattern=this.searchPattern.toLowerCase();$ARR.forEach(this.selectedItems,function(item){name=(item.n||"").toLowerCase();if(name.indexOf(pattern)>-1){filteredRes.push(item);}});}else{filteredRes=(this.selectedItems||[]).slice(0);}return filteredRes;},_set_selectedItems:function _set_selectedItems(n,v){var was=this.selectedItems,itemIdField=this.itemIdField;v=v||[];this.selectedItems=v;this.updateClearAllBtnState();if(was.length!==v.length){return true;}var intersaction=$ARR.intersection(was,v,itemIdField);return intersaction.length!==was.length;},onselectedItemsChange:function(){this.elementList.setSelectedItems(this.selectedItems);}});}());