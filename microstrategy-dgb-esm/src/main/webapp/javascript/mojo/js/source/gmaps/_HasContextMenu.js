(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.css","mstrmojo.dom","mstrmojo.hash","mstrmojo.gm.GMUtility","mstrmojo.gmaps.MapColorUtils","mstrmojo.gmaps.MapEnums","mstrmojo.gmaps.MapUtils","mstrmojo.gmaps._AreaMapHelper","mstrmojo.PerformanceLogOutput","mstrmojo.ui.menus.MenuConfig","mstrmojo.vi.enums.EnumFeatures","mstrmojo.vi.viz.EnumDSSDropZones","mstrmojo.vi.viz.MapHelper","mstrmojo.VisUtility");mstrmojo.requiresDescs(11701,3946,11476,13272,13273,5752);var $ARR=mstrmojo.array,$H=mstrmojo.hash,$DOM=mstrmojo.dom,$MH=mstrmojo.vi.viz.MapHelper,$FEATURES=mstrmojo.vi.enums.EnumFeatures,$CSS=mstrmojo.css,$GMAPS=mstrmojo.gmaps,SELECTION_HASH_TYPE=$GMAPS.SelectionHashType,ENUM_PROPERTY_TYPE=$GMAPS.EnumPropertyType,ENUM_BASE_MAP_TYPE=$GMAPS.EnumBaseMapType,ENUM_SHAPE_FORMAT_PROPS=$GMAPS.EnumShapeFormatting,ENUM_DEFAULT_SHAPE_FORMAT_STYLE=$GMAPS.EnumDefaultShapeFormatStyle,ENUM_GRAPHIC_TYPE=$GMAPS.EnumGraphicType,ENUM_MARKER_TYPE=$GMAPS.EnumMarkerType,AREA_MAP_HELPER=$GMAPS._AreaMapHelper,MAP_UTILS=mstrmojo.gmaps.MapUtils,ENUM_DSS_DROP_ZONES=mstrmojo.vi.viz.EnumDSSDropZones,GEOZONE_ID=ENUM_DSS_DROP_ZONES.GeoAttribute,TOOLTIP_ID=ENUM_DSS_DROP_ZONES.AdditionalMetrics,ENUM_GEOGRAPHIC_ROLE=$GMAPS.EnumGeographicRole,GEOROLE_LAT=parseInt(ENUM_GEOGRAPHIC_ROLE.EnumGeographicRoleLatitiude,10),GEOROLE_LNG=parseInt(ENUM_GEOGRAPHIC_ROLE.EnumGeographicRoleLongitude,10),DRILL_DOWN=1,ROLE_HIERARCHY={3:2,2:9,9:8},$PerfLog=mstrmojo.PerformanceLogOutput,$UTIL=mstrmojo.VisUtility,$GMU=mstrmojo.gm.GMUtility,$MCU=$GMAPS.MapColorUtils;function getDrillTargetRole(drillDirection,curRole){if(drillDirection===DRILL_DOWN){return ROLE_HIERARCHY[curRole];}else{var p=null;$H.forEach(ROLE_HIERARCHY,function(v,k){if(v===curRole){p=k;return false;}});return parseInt(p,10);}}function getDrillUnitGeoRole(drillUnit,isAreaGeoRole){var geoRole=0;if(drillUnit){if(drillUnit.fgr){return drillUnit.fgr;}else{if(drillUnit.fs){$ARR.forEach(drillUnit.fs,function(form){if(form.fgr>0){if(isAreaGeoRole){if($MH.isGeoRoleSupportArea(form.fgr)){geoRole=form.fgr;return false;}}else{geoRole=form.fgr;return false;}}});return geoRole;}}}}function getGeoRoleUnit(datasets,datasetId,geoRole){var dataset=datasets[datasetId],atts=dataset.att,unit=undefined,i,len,form;$ARR.forEach(atts,function(att){for(i=0,len=att.fs.length;i<len;i++){form=att.fs[i];if(parseInt(form.fgr)===parseInt(geoRole)){unit={did:att.did,t:att.t,fgr:geoRole};break;}}if(unit){return false;}});return unit;}function showToolbarByFormat(pos,toolbarData){var widget=this,ph=document.createElement("div"),me=this;if(widget._lastOpened){widget.closePopup();}widget._lastOpened=null;function configurePopup(config,itemBtn){config.hostId=this.id;config.hostElement=itemBtn;}ph.setAttribute("class","gm-menu-placeholder");this.domToolbarPH=ph;ph.style.top=pos.y+"px";ph.style.left=pos.x+"px";ph.innerHTML="";document.body.appendChild(ph);$CSS.toggleClass(ph,mstrApp.getThemeClassName(),true);configurePopup.call(this,toolbarData,ph);widget.toolEditor=toolbarData.newInstance({unrender:function(){}});widget.toolEditorClosefn=function(evt){var target=evt.target,toolbarRoot=widget.toolEditor.domNode;if(!$DOM.contains(toolbarRoot,target,true,toolbarRoot)&&!$UTIL.isHostedPopupNode(target,"class",true,document.body)){if(widget.menuEditor){var menuRoot=widget.menuEditor.domNode;if(!$DOM.contains(menuRoot,target,true,menuRoot)){me.hideToolbar();}}else{me.hideToolbar();}}};$DOM.attachEvent(document.body,"mousedown",widget.toolEditorClosefn,true);widget.openPopup(widget.toolEditor);$CSS.toggleClass(document.body,"hasToolbarPopup",true);}function getRowContainer(children,rowContainerCSSClass){children=children||[];rowContainerCSSClass=rowContainerCSSClass||"";$ARR.forEach(children,function(child){child.cssDisplay="inline-block";});return{scriptClass:"mstrmojo.HBox",cssClass:rowContainerCSSClass,children:children};}function getLabelBox(children,labelcss){return new mstrmojo.Box({children:children||[],cssText:labelcss});}function getLabelAndControlBox(labelText,control,reverseOrder,rowContainerCSSClass){var label=new mstrmojo.Label({text:labelText}),labelBox=getLabelBox(label,"white-space: nowrap; margin-right:9px;");var children=[labelBox,control];if(reverseOrder){children=[control,labelBox];}return getRowContainer(children,rowContainerCSSClass);}function initPropValueToControl(widget,control,childrenNames){$ARR.forEach(childrenNames,function(childName){var val=widget.getPropertyValue(childName,widget.RMCSelectedLayerKey);if(!val){switch(childName){case ENUM_SHAPE_FORMAT_PROPS.SHAPE_FORMAT_FILL_OPACITY:val=ENUM_DEFAULT_SHAPE_FORMAT_STYLE.FILL_OPACITY;break;case ENUM_SHAPE_FORMAT_PROPS.SHAPE_FORMAT_FILL_COLOR:val=ENUM_DEFAULT_SHAPE_FORMAT_STYLE.FILL_COLOR;break;case ENUM_SHAPE_FORMAT_PROPS.SHAPE_FORMAT_BORDER_STYLE:val=ENUM_DEFAULT_SHAPE_FORMAT_STYLE.BORDER_STYLE;break;case ENUM_SHAPE_FORMAT_PROPS.SHAPE_FORMAT_BORDER_COLOR:val=ENUM_DEFAULT_SHAPE_FORMAT_STYLE.BORDER_COLOR;break;}}control.syncControls(function(){control.setChildValue(childName,val);});});}function getChangeFormatPropertyFn(widget,propName){return function(newValue){var currentVal=widget.getPropertyValue(propName,widget.RMCSelectedLayerKey),firstEquality=newValue===currentVal;if(!firstEquality){widget&&widget.writeProperties(propName,newValue,widget.RMCSelectedLayerKey);}};}function getGroupCompProps(widget,props,childrenNames,scope,levelSelection){props=props||{};if(props.propNames===undefined){props.propNames=childrenNames;}if(props.onGroupValueChange===undefined){props.onGroupValueChange=function(propertyName,newValue,oldValue){if(newValue!==oldValue&&newValue!==undefined){getChangeFormatPropertyFn(widget,propertyName,scope,levelSelection).call(this,newValue,oldValue);}};}return props;}function getLineConfigComp(widget,label,childrenNames,scope,levelSelection,props){props=getGroupCompProps(widget,props,childrenNames,scope,levelSelection);$H.copy({cssClass:"mstrmojo-ui-ToolBarLineGroup",layoutConfig:null,width:props.width||"125px",showNoFillInColor:false},props);var control=new mstrmojo.ui.editors.controls.LineConfigGroup(props);if(control){control.height="22px;";control.iniChildrenComp(childrenNames);initPropValueToControl(widget,control,childrenNames,scope,levelSelection);}if(typeof label==="string"){return getLabelAndControlBox(label,control,false,(props||[]).rowContainerCSSClass);}return control;}function getFillConfigComp(widget,label,childrenNames,scope,props){props=getGroupCompProps(widget,props,childrenNames,scope);$H.copy({width:props.width||"140px",height:"22px",colorPickerHostWithin:true},props);var control=new mstrmojo.ui.editors.controls.FillConfigGroup(props);if(control){control.iniChildrenComp(childrenNames);initPropValueToControl(widget,control,childrenNames,scope);}if(typeof label==="string"){return getLabelAndControlBox(label,control);}return control;}function getOpacityAndBorderToolbar(widget,hasSingleControl){var fillConfig=getFillConfigComp(widget,mstrmojo.desc(13658,"Fill Opacity"),[ENUM_SHAPE_FORMAT_PROPS.SHAPE_FORMAT_FILL_OPACITY],null,{width:"60px",visibleControls:mstrmojo.ui.editors.controls.FillConfigGroup.CTRL_FLAGS.FILL_TRANSPARENCY}),toolbarConfig=[fillConfig];if(!hasSingleControl){var lineConfig=getLineConfigComp(widget,mstrmojo.desc(3538,"Border Style"),[ENUM_SHAPE_FORMAT_PROPS.SHAPE_FORMAT_BORDER_STYLE],null,undefined,{width:"60px",hideColorControl:true,rowContainerCSSClass:"mstrmojo-ui-rowContainer"});toolbarConfig.push(lineConfig);}return new mstrmojo.ui.menus.ToolbarEditorConfig({contents:[{scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-ui-FillOpacityAndBorderStyleToolbar",children:toolbarConfig}]});}function generateColorPaletteEditor(colorby,callback){var title=mstrmojo.desc(2885,"Fill"),SHAPE_FILL="ShapeClr",SHAPE_OPACITY="ShapeFillTrans",hasCallback=callback&&callback.onFillChanged&&callback.onOpacityChanged,cb=hasCallback?function(name,newVal){if(name===SHAPE_FILL){callback.onFillChanged.call(this,newVal,function(color){colorControl.syncControls(function(){this.setChildValue(SHAPE_FILL,color);});});$UTIL.setColorPickerShowAutomatic(colorControl,newVal!=="automatic");}else{if(name===SHAPE_OPACITY){callback.onOpacityChanged.call(this,newVal);}}}:mstrmojo.emptyFn,colorControl=new mstrmojo.ui.editors.controls.FillConfigGroup({colorPickerHostWithin:true,onGroupValueChange:cb,width:"125px"});if(colorControl){colorControl.fillColorAndTrans.layoutConfig={w:{col1Node:"50%",dividerNode:"5px",col2Node:"50%"},xt:true};colorControl.iniChildrenComp([SHAPE_FILL,SHAPE_OPACITY]);colorControl.syncControls(function(){this.setChildValue(SHAPE_FILL,colorby.color);this.setChildValue(SHAPE_OPACITY,colorby.opacity);});$UTIL.setColorPickerShowAutomatic(colorControl,colorby.showAutomatic);}return getLabelAndControlBox(title,colorControl);}function getColorByAttributeEditor(widget,layer){var cbElements=layer.getFormatColorByElements(),cbSel=layer.getContextMenuColorBySelections(),len,cbElement,comb,itemIdx,cbItem,callback,fillOpacityConfig=getFillConfigComp(widget,mstrmojo.desc(13658,"Fill Opacity"),[ENUM_SHAPE_FORMAT_PROPS.SHAPE_FORMAT_FILL_OPACITY],null,{width:"60px",visibleControls:mstrmojo.ui.editors.controls.FillConfigGroup.CTRL_FLAGS.FILL_TRANSPARENCY}),toolbarConfig=[fillOpacityConfig],cbSelIndexes,multiSel,elementMulti;if(cbSel===undefined||cbSel===null||cbSel.length===0){return new mstrmojo.ui.menus.ToolbarEditorConfig({contents:[{scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-ui-FillOpacityAndBorderStyleToolbar",children:toolbarConfig}]});}len=cbSel.length;if(len>1){cbSelIndexes=$MCU.cbSelectionToIndices(cbSel,cbElements);multiSel=[];$ARR.forEach(cbSelIndexes,function(index){multiSel.push(cbElements[index]);});elementMulti=$MCU.getColorInfoForItemAll(multiSel);cbElement={color:elementMulti.color,opacity:elementMulti.opacity};}else{comb=$H.clone(cbSel[0]);itemIdx=$UTIL.findInArray(cbElements,function(item){return $GMU.isEqualComb(comb,$H.clone(item.comb));});if(itemIdx===-1){return new mstrmojo.ui.menus.ToolbarEditorConfig({contents:[{scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-ui-FillOpacityAndBorderStyleToolbar",children:toolbarConfig}]});}cbElement=cbElements[itemIdx];}cbItem={color:cbElement.color,opacity:cbElement.opacity,showAutomatic:cbSel.some(function(comb){return $UTIL.isColorManuallySet(widget,comb);})};callback={onFillChanged:function(newValue,toolbarCallback){var rawValue=newValue,isAutomatic=rawValue==="automatic",sub;if(isAutomatic){newValue="default";}else{newValue=$GMU.encodeColor(newValue);}sub=widget.listenToUpdateColorMap(function(){var color="#ffffff",selectionLength=cbSel.length;if(isAutomatic){if(selectionLength===1){color=$GMU.decodeColor($UTIL.getCombColor(widget,cbElement.comb));}if(toolbarCallback instanceof Function){toolbarCallback(color);}rawValue=color;}widget.raiseEvent({name:"colorByColorChange",type:"invalidateCache"});widget.raiseEvent({name:"colorByColorChange",type:"fill",fill:rawValue,showAutomatic:!isAutomatic});widget.detachUpdateColorMapListener(sub);});widget.updateColorMap(cbSel,$UTIL.repeat(newValue,cbSel.length));},onOpacityChanged:function(newValue){layer.updateLayerColorByOpacity(cbSel,$UTIL.repeat(newValue,cbSel.length));widget.raiseEvent({name:"colorByColorChange",type:"opacity",opacity:newValue});}};toolbarConfig=[generateColorPaletteEditor.call(this,cbItem,callback)];return new mstrmojo.ui.menus.ToolbarEditorConfig({contents:[{scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-ui-FillOpacityAndBorderStyleToolbar",children:toolbarConfig}]});}function getBorderAndFillEditor(widget,lineChildrenNames,fillChildrenNames,scope,hasSingleControl){var fillConfig=getFillConfigComp(widget,mstrmojo.desc(2885,"Fill"),fillChildrenNames,scope,{showGradient:false}),toolbarConfig=[fillConfig];if(!hasSingleControl){var lineConfig=getLineConfigComp(widget,mstrmojo.desc(9736,"Border"),lineChildrenNames,scope,undefined,{rowContainerCSSClass:"mstrmojo-ui-rowContainer",showNoneOption:false});toolbarConfig.push(lineConfig);}return new mstrmojo.ui.menus.ToolbarEditorConfig({contents:[{scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-ui-ToolbarBorderAndFill",children:toolbarConfig}]});}function getDatasetForGraphicLayer(graphicLayer){if(!graphicLayer){return null;}var xtab=graphicLayer.getXtab(),xtabModel=xtab&&xtab.model,docModel=xtabModel&&xtabModel.docModel,datasets=docModel&&docModel.datasets,datasetId=xtabModel.data.datasetId,dataset;if(datasets&&datasetId){dataset=datasets[datasetId];}return dataset;}function getGraphicTypeForDrill(drillUnit,graphicLayer,shapeConfig){if(!drillUnit||!graphicLayer){return ;}var mapHelper=new $MH(),currentGraphicType=graphicLayer.graphicType,hasLatLng=!!mapHelper.getLatitudeForm(drillUnit)&&!!mapHelper.getLatitudeForm(drillUnit);if(currentGraphicType!==ENUM_GRAPHIC_TYPE.Area){if(!hasLatLng&&shapeConfig){return ENUM_GRAPHIC_TYPE.Area;}}else{if(!shapeConfig&&hasLatLng){return undefined;}}return currentGraphicType;}mstrmojo.gmaps._HasContextMenu=mstrmojo.provide("mstrmojo.gmaps._HasContextMenu",{_mixinName:"mstrmojo.gmaps._HasContextMenu",EnumContextMenuTargetType:{GeoGraphic:1,BlankSpace:2,DensityGraphic:3,SelectionArea:4},contextMenu:null,showMenu:function showMenu(event,targetConfig){if(mstrApp.isInVFInteractMode){$DOM.stopPropogation(window,event);$DOM.preventDefault(window,event);return false;}var cfg=this.getMenuConfig(targetConfig),hasMenuShown;if(!cfg.hasMenuItems()){hasMenuShown=false;}else{cfg.hostId=this.id;cfg.isHostedWithin=false;cfg.position=this.getMousePositionFromEvent(event);if(MAP_UTILS.checkHasFunction(this.contextMenu,"destroy")){this.contextMenu.destroy();}this.contextMenu=cfg.newInstance();this.openPopup(this.contextMenu);hasMenuShown=true;}return hasMenuShown;},_isESRIOrMapbox:function _isESRIOrMapbox(){var mapViewer=this.mapViewer,baseMapType=mapViewer.getBaseMapType();return baseMapType===ENUM_BASE_MAP_TYPE.Esri||baseMapType===ENUM_BASE_MAP_TYPE.Mapbox;},_validGeoAttribute:function _validGeoAttribute(attr){var validGeoRole=0,hasLat=false,hasLng=false,fgr,fnm,isESRIOrMapbox=this._isESRIOrMapbox();$ARR.forEach(attr.fs,function(form){fgr=form.fgr;fnm=form.fnm;if(fgr>0&&fgr!==GEOROLE_LAT&&fgr!==GEOROLE_LNG&&isESRIOrMapbox){validGeoRole=fgr;return false;}else{if(fgr===GEOROLE_LAT||(fnm&&fnm.toLowerCase().indexOf("latitude")>-1)){hasLat=true;}else{if(fgr===GEOROLE_LNG||(fnm&&fnm.toLowerCase().indexOf("longitude")>-1)){hasLng=true;}}}});return !!validGeoRole||(hasLat&&hasLng);},findDrillableUnits:function findDrillableUnits(graphicLayer){var dataset=getDatasetForGraphicLayer(graphicLayer),atts=dataset&&dataset.att,dropzones=graphicLayer.getDropZones(),currentGeoAttId=dropzones&&dropzones.geoAttribute,rtn=[],i,n;for(i=0,n=atts.length;i<n;i++){if((currentGeoAttId&&atts[i].did!==currentGeoAttId)&&this._validGeoAttribute(atts[i])){rtn.push(atts[i]);}}return rtn;},getMenuConfig:function getMenuConfig(targetConfig){var selectedLayer=this.getGraphicLayerForRMC();if(!selectedLayer){return new mstrmojo.ui.menus.MenuConfig();}var mapViewer=this.mapViewer,hasSelection=mapViewer.hasSelectedGraphics(),cfg=new mstrmojo.ui.menus.MenuConfig(),graphicType=selectedLayer.graphicType,markerType=selectedLayer.getMarkerType(),me=this,drillableUnits;if(targetConfig&&targetConfig.type===this.EnumContextMenuTargetType.GeoGraphic&&MAP_UTILS.isVI()){if(this.isLinkedFilterEnabled&&this.isLinkedFilterEnabled()){if(!this.isVisMap||this.mapViewer.getGraphicLayer(this.getKeyForTemplateSelection()).isVisible()){var fnApplyFilter=function(){me.handleContextMenuSelectionData(true);};cfg.addMenuItem(mstrmojo.desc(15070,"Go to Targets"),"",fnApplyFilter);cfg.addSeparator();}}if(this.canDoMultiSelect()){cfg.addMenuItem(mstrmojo.desc(11701,"Keep only"),"xt",this.getMenuHandler("keepOnly"));cfg.addMenuItem(mstrmojo.desc(3946,"Exclude"),"xt",this.getMenuHandler("exclude"));if(!mstrApp.isInVFConfigMode&&mstrmojo.resolveFeature($FEATURES.WEB_DRILL_AND_LINK)){drillableUnits=this.findDrillableUnits(selectedLayer);if(drillableUnits&&drillableUnits.length>0){cfg.addPopupMenuItem(mstrmojo.desc(145,"Drill"),this.id,function(){var n=drillableUnits.length,subMenu=new mstrmojo.ui.menus.MenuConfig(),i;for(i=0;i<n;i++){subMenu.addMenuItem(drillableUnits[i].n,"xt",me.getMenuHandler("drill"),{drillUnit:drillableUnits[i]});}return subMenu;},"xt");}}cfg.addSeparator();}if(!mstrApp.isDossier){if(!this.excludeData){cfg.addMenuItem(mstrmojo.desc(11476,"Show Data"),"xt",this.getMenuHandler("showData"));}if(graphicType!==undefined&&(graphicType!==ENUM_GRAPHIC_TYPE.Density&&!(graphicType===ENUM_GRAPHIC_TYPE.Marker&&markerType===ENUM_MARKER_TYPE.Image))){cfg.addMenuItem(mstrmojo.desc(1918,"Format"),"xt",this.getMenuHandler("shapeFormat"));}}}if(targetConfig&&targetConfig.type===this.EnumContextMenuTargetType.GeoGraphic){if(selectedLayer&&selectedLayer.isVisible()&&selectedLayer.isAffinityLineLayerEnabled()){if(cfg.hasMenuItems()){cfg.addSeparator();}if(selectedLayer.isAffinityLineShown()){cfg.addMenuItem(mstrmojo.desc(13650,"Hide affinity lines"),"xt",this.getMenuHandler("hideAffinityLines",targetConfig.object));}else{cfg.addMenuItem(mstrmojo.desc(13651,"Show affinity lines"),"xt",this.getMenuHandler("showAffinityLines",targetConfig.object));}}}else{if(targetConfig&&targetConfig.type===this.EnumContextMenuTargetType.BlankSpace){if(mapViewer.isMapEnabledAffinityLine()){if(cfg.hasMenuItems()){cfg.addSeparator();}if(mapViewer.isMapShownAffinityLine()){cfg.addMenuItem(mstrmojo.desc(13650,"Hide affinity lines"),"xt",this.getMenuHandler("hideAllAffinityLines"));}if(mapViewer.isMapHideAffinityLine()){cfg.addMenuItem(mstrmojo.desc(13651,"Show affinity lines"),"xt",this.getMenuHandler("showAllAffinityLines"));}}}}if((hasSelection||(targetConfig&&targetConfig.type===this.EnumContextMenuTargetType.GeoGraphic)||(targetConfig&&targetConfig.type===this.EnumContextMenuTargetType.DensityGraphic))&&!MAP_UTILS.isVI()){if(this.isMapDrillEnabled(selectedLayer)){if(cfg.hasMenuItems()){cfg.addSeparator();}cfg.addMenuItem(mstrmojo.desc(5752,"Links"),"xt",this.getMenuHandler("linkDrill"));}}return cfg;},getMenuHandler:function(name,targetObj){var handler;if(this._super){handler=this._super(name,targetObj);}if(handler!==mstrmojo.emptyFn){return handler;}var me=this,param=targetObj,handlers={keepOnly:function selectionKeepOnly(){$PerfLog.startTimer({functionName:"Vis.keepOnly",purpose:"from KeepOnly to End"},"timerid_Vis_keepOnly");me.processCommon();me.isKeepOnlyExclude=true;me.processKeepOnly(true);},drill:function drillWithin(menuItem){$PerfLog.startTimer({functionName:"Vis.drill",purpose:"from drill to End"},"timerid_Vis_drill");me.processCommon();me.processDrillWithin(menuItem);},exclude:function selectionExclude(){$PerfLog.startTimer({functionName:"Vis.exclude",purpose:"from exclude to End"},"timerid_Vis_exclude");me.processCommon();me.isKeepOnlyExclude=true;me.processExclude();},showData:function showData(){me.processCommon();me.processShowData();},linkDrill:function linkDrill(){me.processCommon();me.processDrill();},hideAffinityLines:function hideAffinityLines(){me.processCommon();me.mapViewer.hideAffinityLinesLayer(param);},showAffinityLines:function showAffinityLines(){me.processCommon();me.mapViewer.displayAffinityLinesLayer(param);},hideAllAffinityLines:function hideAllAffinityLines(){me.processCommon();me.mapViewer.hideAllAffinityLinesLayer();},showAllAffinityLines:function showAllAffinityLines(){me.processCommon();me.mapViewer.showAllAffinityLinesLayer();},shapeFormat:function shapeFormat(){me.processCommon();me.processShapeFormat();}};if(handlers.hasOwnProperty(name)){return handlers[name];}return mstrmojo.emptyFn;},getMousePositionFromEvent:function getMousePositionFromEvent(evt){return $DOM.getMousePosition(evt,window);},getTargetConfig:function getTargetConfig(targetGraphics){var targetConfig,graphicLayer;if(targetGraphics&&targetGraphics.length>0){graphicLayer=targetGraphics[0]&&targetGraphics[0].getGraphicLayer();this.RMCSelectedLayerKey=graphicLayer&&graphicLayer.key;targetConfig={type:this.EnumContextMenuTargetType.GeoGraphic,object:targetGraphics};}else{targetConfig={type:this.EnumContextMenuTargetType.BlankSpace,object:null};}return targetConfig;},handleContextMenuEvt:function handleContextMenuEvt(evt){var graphics=evt&&evt.graphics,targetConfig=this.getTargetConfig(graphics),rmcHandled=this.showMenu(evt,targetConfig);if(rmcHandled||!MAP_UTILS.isVI()){$DOM.stopPropogation(window,evt);$DOM.preventDefault(window,evt);}},getGraphicLayerForRMC:function getGraphicLayerForRMC(){var mapViewer=this.mapViewer,selectedLayerKey=this.RMCSelectedLayerKey;return mapViewer.getGraphicLayer(selectedLayerKey);},processCommon:function processCommon(){},constructSelectionInfos:function constructSelectionInfos(isKeepOnly,isClearInFilterButton,nodeIdxToRemove,layerKey){var selectionInfos=[],mapViewer=this.mapViewer,selectionInfo,selectionData;if(isClearInFilterButton){mapViewer.forEachGraphicLayer(function(graphicLayer){selectionInfos.push({vis:graphicLayer.getXtab(),graphicLayer:graphicLayer,selectorData:null,nodeIdxToRemove:(layerKey&&graphicLayer.key!==layerKey)?undefined:nodeIdxToRemove});},false,true);}else{mapViewer.forEachGraphicLayer(function(graphicLayer){selectionData=graphicLayer.getContextMenuSelections();selectionInfo={vis:graphicLayer.getXtab(),graphicLayer:graphicLayer,selectorData:null};if(selectionData&&selectionData.length>0){selectionInfo.nodeIdxToRemove=isKeepOnly?-2:undefined;selectionInfo.selectorData={data:graphicLayer.getContextMenuSelections(),keepOnly:isKeepOnly};}selectionInfos.push(selectionInfo);});}return selectionInfos;},processKeepOnly:function processKeepOnly(isKeepOnly){var selectionInfos=this.constructSelectionInfos(isKeepOnly);this.updateAfterKeepOnlyForMultiTemplate(selectionInfos);},processDrillTo:function processDrillTo(drillDirection){var dzModel=this.zonesModel,zone=dzModel.getZoneModelByZoneId(GEOZONE_ID),geoRole=getDrillUnitGeoRole(zone.items[0]),xtabData=this.model.data,datasetId=xtabData.datasetId,shapeConfig=AREA_MAP_HELPER.getMatchingShape(this.getMenuConfig().common.shapes,null,geoRole),targetRole=getDrillTargetRole(drillDirection,geoRole),unit;if(targetRole&&shapeConfig){unit=getGeoRoleUnit(this.model.docModel.datasets,datasetId,targetRole);}if(unit){this.processDrillWithin({ctxt:{drillUnit:unit}});}},getValidShapeConfig:function getValidShapeConfig(geoRole){var mapConfig=this.getMapConfig(),commonConfig=mapConfig&&mapConfig.common,shapes=commonConfig&&commonConfig.shapes,layers=commonConfig&&commonConfig.layers,mapViewer=this.mapViewer,baseMapType=mapViewer.getBaseMapType(),availableShapes;if(commonConfig&&geoRole){availableShapes=AREA_MAP_HELPER.getAvailableShapes(shapes,layers,geoRole,baseMapType);return AREA_MAP_HELPER.getMatchingShape(availableShapes,null,geoRole);}},processDrillWithin:function processDrillWithin(menuItem){var drillUnit=menuItem.ctxt.drillUnit,graphicLayer=this.getGraphicLayerForRMC(),selections=graphicLayer&&graphicLayer.getContextMenuSelections(),xtab=graphicLayer&&graphicLayer.getXtab(),xtabData=xtab&&xtab.getData(),actions=[],dzModel=this.zonesModel,geoZone,unitItem={did:drillUnit.did,t:drillUnit.t},tooltipZone={id:TOOLTIP_ID},callback=this.model.docModel.controller._getXtabCallback(this),datasetId=xtabData.datasetId,METRIC_NAMES_ID="00000000000000000000000000000000",METRIC_NAMES_UNIT_TYPE=0,DATASET_TYPE=3,key=graphicLayer.key,geoRole=getDrillUnitGeoRole(drillUnit,true),shapeConfig=this.getValidShapeConfig(geoRole),actionList,updateTemplateActions,dropInfo,extras={datasetId:datasetId,datasetType:datasetId===METRIC_NAMES_ID?METRIC_NAMES_UNIT_TYPE:DATASET_TYPE},newGraphicType=getGraphicTypeForDrill(drillUnit,graphicLayer,shapeConfig);this.selectionHashType=SELECTION_HASH_TYPE.RMC_LAYER;if(!graphicLayer||selections.length<=0){return ;}this.updateEditingLayerIdx(graphicLayer.getLayerIdx());$UTIL.selectDropZonePanel(this);dzModel.getDropZones();geoZone=dzModel.getZoneModelByZoneId(GEOZONE_ID);if(geoZone&&geoZone.items&&geoZone.items.length>0&&drillUnit){actions=actions.concat(dzModel.getActionsForDeleteItem(geoZone,0));this.updateProperties(ENUM_PROPERTY_TYPE.graphicType,newGraphicType,key);if(!newGraphicType||newGraphicType===ENUM_GRAPHIC_TYPE.Area){this.updateProperties(ENUM_PROPERTY_TYPE.markerType,undefined,key);}this.updateProperties("sa",undefined,key);this.updateProperties("sm",undefined,key);dzModel.getDropZones();dropInfo={allowedItems:[drillUnit],idx:0,edge:0,item:drillUnit,removeReplaced:false};updateTemplateActions=dzModel.getDropActions(geoZone,dropInfo,datasetId);if(updateTemplateActions&&updateTemplateActions.actions&&updateTemplateActions.actions.length>0){actions=actions.concat(updateTemplateActions.actions);}if(newGraphicType===ENUM_GRAPHIC_TYPE.Area&&shapeConfig&&shapeConfig.sfr){unitItem=getGeoRoleUnit(this.model.docModel.datasets,datasetId,shapeConfig.sfr);if(unitItem){$ARR.insert(actions,null,dzModel.getAddDropZoneUnitsActions(tooltipZone,[unitItem],dzModel.getItemCountInZone(TOOLTIP_ID),extras));}}actionList=[{act:"updateTemplate",keyContext:key,actions:actions}];actionList.push(dzModel.getWidgetPropsAction());this.updateAfterDrill(actionList,callback,xtab);}},processExclude:function processExclude(){this.processKeepOnly(false);},processShowData:function processShowData(){this.showData();},hideToolbar:function(){var ph=this.domToolbarPH,phChild=ph.firstChild,phParent=ph.parentNode,widget=this;function destroyDisposable(scope,obj){if(obj){$ARR.removeItem(scope.disposables,obj);obj.destroy();}}destroyDisposable(widget,widget.toolEditor);if(phChild){ph.removeChild(phChild);}if(phParent){phParent.removeChild(ph);}var me=widget.toolEditor;if(me){widget.removeChildren(me);me.unrender=function(){me._super();};me.destroy();me.unrender=function(){};delete widget.toolEditor;$CSS.toggleClass(document.body,"hasToolbarPopup",false);$CSS.toggleClass(ph,mstrApp.getThemeClassName(),false);}if(widget.toolEditorClosefn){$DOM.detachEvent(document.body,"mousedown",widget.toolEditorClosefn,true);delete widget.toolEditorClosefn;}},processShapeFormat:function processShapeFormat(){var contextMenu=this.contextMenu,pos=contextMenu&&contextMenu.popupConfig&&contextMenu.popupConfig.position,widget=this.getEditingHost(),tfg;$UTIL.selectPropertyPanel(this,this.isMapbox()?$GMAPS.TARGET_FORMATTING_LAYERS:$GMAPS.TARGET_MAPOPTIONS);this.selectRMCLayer();widget.parent.selectVIUnit();tfg=this.getShapeFormatToolbarConfig();if(tfg){showToolbarByFormat.call(this,pos,tfg);}},selectRMCLayer:function selectRMCLayer(){var editModel=this.edtModel;if(editModel&&typeof editModel.selectLayerForRMCFmt==="function"){editModel.selectLayerForRMCFmt(this.RMCSelectedLayerKey);}},getShapeFormatToolbarConfig:function(){var borderChildrenName=[ENUM_SHAPE_FORMAT_PROPS.SHAPE_FORMAT_BORDER_COLOR,ENUM_SHAPE_FORMAT_PROPS.SHAPE_FORMAT_BORDER_STYLE],fillChildrenName=[ENUM_SHAPE_FORMAT_PROPS.SHAPE_FORMAT_FILL_COLOR,ENUM_SHAPE_FORMAT_PROPS.SHAPE_FORMAT_FILL_OPACITY],tfg;var selectedLayer=this.getGraphicLayerForRMC(),layerKey=this.RMCSelectedLayerKey,graphicType=selectedLayer.graphicType,map=selectedLayer.map,isColorByAttr=map.isEditingDropZoneColorByAttr(),colorByItems=map.getDropZoneItems(mstrmojo.vi.viz.EnumDSSDropZones.ColorBy,layerKey),hasMetricInColorByDropZone=isColorByAttr===false&&colorByItems&&colorByItems.length>0,hasAttributeInColorByDropZone=isColorByAttr===true&&colorByItems&&colorByItems.length>0,singleControl=graphicType===ENUM_GRAPHIC_TYPE.Marker;if(hasMetricInColorByDropZone){tfg=getOpacityAndBorderToolbar(this,singleControl,layerKey);}else{if(hasAttributeInColorByDropZone){tfg=getColorByAttributeEditor(this,selectedLayer);}else{tfg=getBorderAndFillEditor(this,borderChildrenName,fillChildrenName,null,singleControl);}}return tfg;},processDrill:function processDrill(){this.getGraphicLayerForRMC().processDrill();},isMapDrillEnabled:function isMapDrillEnabled(selectedLayer){return selectedLayer.isDrillable();},canDoMultiSelect:function canDoMultiSelect(){var mapViewer=this.mapViewer,result=true;mapViewer.forEachGraphicLayer(function(graphicLayer){var hasGraphics=function(graphicLayer){return graphicLayer.graphics&&graphicLayer.graphics.length>0;};if(hasGraphics(graphicLayer)&&!graphicLayer.canDoMultiSelect()){result=false;}});return result;}});})();