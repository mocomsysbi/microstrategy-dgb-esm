(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.array","mstrmojo.hash","mstrmojo.color","mstrmojo._HasLayout","mstrmojo.vi.ui._IsPanel","mstrmojo._HasPopup","mstrmojo._HasOwnAvatar","mstrmojo.vi.ui._HasTargets","mstrmojo.vi.ui._IsBoxLayoutChild","mstrmojo.vi.ui._IsDropTarget","mstrmojo.vi._MonitorsAppState","mstrmojo.vi._MonitorsLayoutMode","mstrmojo._Formattable","mstrmojo.vi.ui._IsUnitContainerTitleBar","mstrmojo.DynamicClassFactory","mstrmojo.Box","mstrmojo.css","mstrmojo.dom","mstrmojo.func","mstrmojo.models.FormatModel","mstrmojo.DocDataService","mstrmojo.vi.ui.TitleBar","mstrmojo.vi.models.EnumDragSources","mstrmojo.vi.enums.EnumThemeProperties","mstrmojo.vi.ui.rw._HasVisFilterIndicator","mstrmojo.EnumRWUnitType","mstrmojo.vi.ui._CanGroup","mstrmojo.EnumRWUnitType");mstrmojo.requiresDescs(629,1388,11477,11478);var $ARR=mstrmojo.array,$CSS=mstrmojo.css,$DOM=mstrmojo.dom,$HASH=mstrmojo.hash,$COLOR=mstrmojo.color,$DRAG_SRC=mstrmojo.vi.models.EnumDragSources,$FORMAT_MODEL=mstrmojo.models.FormatModel,$ENUM_FORMAT_PROPERTIES=$FORMAT_MODEL.ENUM_PROPERTY_NAMES,DEFAULT_Z_INDEX=1,CSS_BTN_VISIBLE="visible",CSS_MOUSE_LEFT="mouse-left",CSS_NO_MENU="no-menu",CSS_OVERLAY="ctrlOverlay",CSS_OR_VERTICAL="or-v",CSS_OR_HORIZONTAL="or-h";var CSS_GHOST_IMG={SHORT:"ghost-short",TALL:"ghost-tall",GRANDE:"ghost-grande",VENTI:"ghost-venti",HIDE_TITLE:"ghost-hide-title",HIDE_DESC:"ghost-hide-desc"};var CSS_GHOST_DESC={BLACK:"ghost-black",WHITE:"ghost-white",GREY:"ghost-grey"};var CSS_GHOST_IMG_ARR=$HASH.valarray(CSS_GHOST_IMG);var CSS_GHOST_DESC_ARR=$HASH.valarray(CSS_GHOST_DESC);var CSS_GHOST_ALL=CSS_GHOST_IMG_ARR.concat(CSS_GHOST_DESC_ARR);var GHOST_STYLE_MATRIX={W_LV1:{H_LV1:[CSS_GHOST_IMG.VENTI],H_LV2:[CSS_GHOST_IMG.GRANDE],H_LV3:[CSS_GHOST_IMG.TALL],H_LV4:[CSS_GHOST_IMG.TALL,CSS_GHOST_IMG.HIDE_TITLE],H_LV5:[CSS_GHOST_IMG.SHORT,CSS_GHOST_IMG.HIDE_TITLE],H_LV6:[CSS_GHOST_IMG.SHORT,CSS_GHOST_IMG.HIDE_TITLE,CSS_GHOST_IMG.HIDE_DESC]},W_LV2:{H_LV1:[CSS_GHOST_IMG.GRANDE],H_LV2:[CSS_GHOST_IMG.GRANDE],H_LV3:[CSS_GHOST_IMG.TALL],H_LV4:[CSS_GHOST_IMG.TALL,CSS_GHOST_IMG.HIDE_TITLE],H_LV5:[CSS_GHOST_IMG.SHORT,CSS_GHOST_IMG.HIDE_TITLE],H_LV6:[CSS_GHOST_IMG.SHORT,CSS_GHOST_IMG.HIDE_TITLE,CSS_GHOST_IMG.HIDE_DESC]},W_LV3:{H_LV1:[CSS_GHOST_IMG.TALL],H_LV2:[CSS_GHOST_IMG.TALL],H_LV3:[CSS_GHOST_IMG.TALL],H_LV4:[CSS_GHOST_IMG.TALL,CSS_GHOST_IMG.HIDE_TITLE],H_LV5:[CSS_GHOST_IMG.SHORT,CSS_GHOST_IMG.HIDE_TITLE],H_LV6:[CSS_GHOST_IMG.SHORT,CSS_GHOST_IMG.HIDE_TITLE,CSS_GHOST_IMG.HIDE_DESC]},W_LV4:{H_LV1:[CSS_GHOST_IMG.SHORT],H_LV2:[CSS_GHOST_IMG.SHORT],H_LV3:[CSS_GHOST_IMG.SHORT],H_LV4:[CSS_GHOST_IMG.SHORT,CSS_GHOST_IMG.HIDE_TITLE],H_LV5:[CSS_GHOST_IMG.SHORT,CSS_GHOST_IMG.HIDE_TITLE],H_LV6:[CSS_GHOST_IMG.SHORT,CSS_GHOST_IMG.HIDE_TITLE,CSS_GHOST_IMG.HIDE_DESC]},W_LV5:{H_LV1:[CSS_GHOST_IMG.SHORT],H_LV2:[CSS_GHOST_IMG.SHORT],H_LV3:[CSS_GHOST_IMG.SHORT],H_LV4:[CSS_GHOST_IMG.SHORT,CSS_GHOST_IMG.HIDE_TITLE],H_LV5:[CSS_GHOST_IMG.SHORT,CSS_GHOST_IMG.HIDE_TITLE,CSS_GHOST_IMG.HIDE_DESC],H_LV6:[CSS_GHOST_IMG.SHORT,CSS_GHOST_IMG.HIDE_TITLE,CSS_GHOST_IMG.HIDE_DESC]}};function calculateGhostDescCss(colorHex){var color=colorHex?colorHex.c1||colorHex:"",luminance=$COLOR.getLuminance(color),luminanceWhite=255,luminanceBlack=68.7914,ratioWhite=Math.max(luminanceWhite/luminance,luminance/luminanceWhite),ratioBlack=Math.max(luminanceBlack/luminance,luminance/luminanceBlack);if(ratioWhite>=ratioBlack){return CSS_GHOST_DESC.WHITE;}if(luminance<190){return CSS_GHOST_DESC.BLACK;}return CSS_GHOST_DESC.GREY;}function calculateGhostImgCss(width,height){var widthLevel,heightLevel,cssCls;if(width>=1024){widthLevel="W_LV1";}else{if(width>=640){widthLevel="W_LV2";}else{if(width>=320){widthLevel="W_LV3";}else{if(width>=100){widthLevel="W_LV4";}else{widthLevel="W_LV5";}}}}if(height>=1024){heightLevel="H_LV1";}else{if(height>=640){heightLevel="H_LV2";}else{if(height>=320){heightLevel="H_LV3";}else{if(height>=200){heightLevel="H_LV4";}else{if(height>=100){heightLevel="H_LV5";}else{heightLevel="H_LV6";}}}}}cssCls=GHOST_STYLE_MATRIX[widthLevel][heightLevel];if(this.getFormats){var formats=this.getFormats(),backgroundColor=formats&&formats["background-color"];cssCls=cssCls.concat(calculateGhostDescCss(backgroundColor));}return cssCls;}mstrmojo.vi.ui.rw.UnitContainerTitleBar=mstrmojo.DynamicClassFactory.newComponent(mstrmojo.vi.ui.TitleBar,[mstrmojo.vi.ui._IsUnitContainerTitleBar],{scriptClass:"mstrmojo.vi.ui.rw.UnitContainerTitleBar"});var MNU_HIDE_TITLE={n:mstrmojo.desc(11477,"Hide Titlebar"),cls:"htb",fn:function(){this.toggleTitleBar(false);},dsbld:false};var MNU_SHOW_TITLE={n:mstrmojo.desc(11478,"Show Titlebar"),cls:"stb",fn:function(){this.toggleTitleBar(true);},dsbld:false};function toggleHighlight(isSelected,autoRemove,forceRemove){var isPresentationMode=mstrApp.isAppStatePresentation(),dNode=this.domNode;$CSS.toggleClass(this.domNode,"pulse",isSelected&&!isPresentationMode&&!forceRemove);if(autoRemove){setTimeout(function(){$CSS.toggleClass(dNode,"pulse",false);},500);}}function getUnitContainer(modelId,unitContainerKey){return mstrmojo.all[modelId].getPanel().getUnitByKey(unitContainerKey);}function setMenuButtonVisibility(){var info=this.menuBtnInfo,menuCfg=info&&info.menuCfg,menus=menuCfg&&menuCfg.menus,btnVisible=(menus&&menus.length>0),btn=info&&info.btn;if(btn){btn.style.display=btnVisible?"block":"none";}$CSS.toggleClass(this.domNode,CSS_NO_MENU,!btnVisible);}function checkDragSrc(context,src){var dragData=this.getContextDragData(context);return !!(dragData&&(dragData.src===src));}function isDragFromFilter(context){return checkDragSrc.call(this,context,$DRAG_SRC.FILTERS);}function isDragFromDatasets(context){return checkDragSrc.call(this,context,$DRAG_SRC.DATASETS);}function isDragFromAllObjectsBrowser(context){return checkDragSrc.call(this,context,$DRAG_SRC.ALL_OBJECT_LIST);}function clearOverlay(overlay){var children=overlay.children;if(children&&children.length){overlay.removeChildren();children.forEach(function(child){child.destroy();});}}function getUnitFormats(){var boxContent=this.boxContent;if(boxContent&&boxContent.getFormats){return boxContent.getFormats();}return null;}function toggleControlOverlay(evt){if(evt.visible){if(evt.controls){this.showControlOverlay(evt.controls);}else{throw new Error('mstrmojo.vi.ui.rw.UnitContainer: "controls" should be provided when showing the control overlay');}}else{this.hideControlOverlay();}}function launchFormatAction(formatData,fnCustom){var docController=this.model.controller,viPropPanelType="propertiesPanel",fnShowEditorTarget=function(){var fmtTarget=this.getFormatMenuItemTarget(formatData);var edtModel=this.getEditorModel();if(edtModel.selectTargetByValue){edtModel.selectTargetByValue(fmtTarget);}if(fnCustom){fnCustom(fmtTarget);}var propPanel=docController.getViPanel(viPropPanelType),propPanelParent=propPanel&&propPanel.parent;if(propPanelParent&&propPanelParent.highlightSelected){propPanelParent.highlightSelected();}}.bind(this);if(docController.getViPanel(viPropPanelType)){docController.selectViPanel(viPropPanelType);fnShowEditorTarget();}else{docController.openViPanel(viPropPanelType,{success:fnShowEditorTarget});}}function applyFormat(isTitleBar,formats){var fmtNodeName=isTitleBar?"titlebarNode":"domNode";this.clearCache();this.clearSlotBackgroundCSS(fmtNodeName);this.applyCSSFormatToNode(fmtNodeName,formats);}mstrmojo.vi.ui.rw.UnitContainer=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasLayout,mstrmojo._Formattable,mstrmojo._HasPopup,mstrmojo._HasOwnAvatar,mstrmojo.vi.ui._IsBoxLayoutChild,mstrmojo.vi.ui._IsDropTarget,mstrmojo.vi._MonitorsAppState,mstrmojo.vi._MonitorsLayoutMode,mstrmojo.vi.ui._HasTargets,mstrmojo.vi.ui.rw._HasVisFilterIndicator,mstrmojo.vi.ui._CanGroup],{scriptClass:"mstrmojo.vi.ui.rw.UnitContainer",markupString:'<div id="{@id}" class="mstrmojo-UnitContainer {@cssClass}" style="{@cssText} {@domNodeCssText}" mstrAttach:mouseenter,mouseleave,mouseover,mouseout,mousemove,click,contextmenu><div class="mstrmojo-UnitContainer-titlebar" style="{@titlebarNodeCssText}"></div><div class="mstrmojo-UnitContainer-content"></div><div class="mstrmojo-VIDND-mask"></div></div>',markupSlots:{titlebarNode:function(){return this.domNode.firstChild;},containerNode:function(){return this.domNode.childNodes[1];},maskNode:function(){return this.domNode.lastChild;}},markupMethods:{onvisibleChange:mstrmojo.Widget.visibleMarkupMethod,ontopChange:mstrmojo.Widget.topMarkupMethod,onleftChange:mstrmojo.Widget.leftMarkupMethod,onzIndexChange:function(){this.domNode.style.zIndex=this.zIndex||DEFAULT_Z_INDEX;},onenabledChange:function(){$CSS.toggleClass(this.domNode,"inactive",!this.enabled);},onorientationChange:function(){var ctrlOverlay=this.ctrlOverlay.domNode,orientation=this.orientation;$CSS.toggleClass(ctrlOverlay,CSS_OR_VERTICAL,orientation==="v");$CSS.toggleClass(ctrlOverlay,CSS_OR_HORIZONTAL,orientation==="h");this.orientationHasChanged();},onghostImgCssChange:function(){var ctrlOverlay=this.ctrlOverlay.domNode,cssClasses=this.ghostImgCss;$CSS.removeClass(ctrlOverlay,CSS_GHOST_ALL);$CSS.addClass(ctrlOverlay,cssClasses);}},layoutConfig:{h:{titlebarNode:"auto",containerNode:"100%"},w:{titlebarNode:"100%",containerNode:"100%"},xt:true},formatHandlers:{domNode:["B","BG"],titlebarNode:{src:"ttl",props:["F","BG","text-align"]}},updateOverlay:mstrmojo.emptyFn,getCacheKey:function getCacheKey(){return this._super()+"-vi-uc";},getPanelForAddAction:function getPanelForAddAction(){return"propertiesPanel";},getExcludedPanels:function getExcludedPanels(){return["editPanel"];},titleBarCss:"",orientation:"h",k:"",boxContent:null,parent:null,enabled:true,draggable:true,ctrlOverlay:null,model:null,title:"",titleBar:null,showTitleBar:false,bubbleMouseOver:true,dimensionsSet:false,getEditOverlayControls:mstrmojo.emptyFn,isNewUnitContainer:true,ghostImgCss:[],shouldShowCustomizeContextMenu:function(evt){var target=evt.getTarget(),nodeName=target&&target.nodeName.toLowerCase();return nodeName&&!(nodeName==="textarea"||(nodeName==="input"&&target.type.toLowerCase()==="text"));},switchToEditMode:function switchToEditMode(){this.showControlOverlay(this.getEditOverlayControls());},init:function init(props){this._super(props);var id=this.id,model=this.model,boxContent=this.boxContent,tb;model.attachEventListener("viUnitSelected",id,function(evt){this.toggleBoxSelection(id===evt.id);});model.attachEventListener("viIconTabClicked",id,function(evt){var hgl=model.hgl;if(model.getSelectedViUnit()&&evt.id!=="vi_flt"&&!hgl){toggleHighlight.call(this,id===model.getSelectedViUnit().id,true,false);}});model.attachEventListener("viVizEditorDrag",id,function(evt){var hgl=model.hgl;if(model.getSelectedViUnit()&&evt.id!=="vi_flt"&&!hgl){toggleHighlight.call(this,id===model.getSelectedViUnit().id,false,!evt.isIn);}});this.addChildren([this.getTitleBarCfg(),{scriptClass:"mstrmojo.Box",cssClass:CSS_OVERLAY,alias:"ctrlOverlay",slot:"containerNode",visible:false}],0);tb=this.titleBar;if(tb&&tb.tbToolbar){tb.tbToolbar.toolbarClicked=function(){model.selectVIUnit(id);};}this.menuBtnInfo={};this.showTitleBar=!!this.defn.httl;this.draggable=mstrApp.allowWebDashboardDesign();boxContent.attachEventListener("toggleCtrlOverlay",this.id,toggleControlOverlay);var edtModel=boxContent.edtModel;if(edtModel){edtModel.attachEventListener("BEMFormatChange",this.id,"updateGhostImgCss");}},getDocModel:function getDocModel(){return this.model;},getBoxBorderWidth:function getBoxBorderWidth(){var fmts=getUnitFormats.call(this),border=fmts&&fmts.border;if(border){var convertedWidths=[2,4];if(mstrApp.isSingleTier&&$DOM.getOSInfo().name.toLowerCase().indexOf("mac")>=0||mstrApp.isExporting){convertedWidths=[2.66,5.34];}return border.indexOf("2pt")>-1?convertedWidths[1]:convertedWidths[0];}return 0;},onFormat:function onFormat(){var boxContent=this.boxContent;if(boxContent.execFormatHandler){boxContent.execFormatHandler();return ;}launchFormatAction.call(this);},showControlOverlay:function showControlOverlay(controls,cssClass){var overlay=this.ctrlOverlay,overlayDomNode=overlay.domNode;if(overlayDomNode){var overlayCss=[CSS_OVERLAY];overlayCss.push((this.orientation==="v")?CSS_OR_VERTICAL:CSS_OR_HORIZONTAL);overlayCss=overlayCss.concat(this.ghostImgCss);if(cssClass){overlayCss.push(cssClass);}overlayDomNode.className=overlayCss.join(" ");}overlay.set("visible",true);clearOverlay(overlay);overlay.addChildren(controls);},hideControlOverlay:function hideControlOverlay(){var overlay=this.ctrlOverlay;overlay.set("visible",false);clearOverlay(overlay);},editingTitleCallback:function editingTitleCallback(isEditing){var menuBtnInfo=this.menuBtnInfo;$CSS.toggleClass(menuBtnInfo.btn,"editing-title",isEditing);},getTitleBarCfg:function getTitleBarCfg(){return{scriptClass:"mstrmojo.vi.ui.rw.UnitContainerTitleBar",slot:"titlebarNode",alias:"titleBar",title:this.title,editTitleOnDoubleClick:mstrApp.allowWebDashboardDesign(),beganEditingTitlebar:function beganEditingTitlebar(){this.parent.editingTitleCallback(true);},titleEdited:function titleEdited(){this.parent.editingTitleCallback(false);},close:function(){this.parent.deleteSelf();},getLayoutOffsets:function getLayoutOffsets(){return{h:mstrApp.getThemeProps(mstrmojo.vi.enums.EnumThemeProperties.SUBTYPE.LAYOUT).ucTBLOHeight,w:0};}};},getDisplayName:function getDisplayName(){return this.title;},updateDisplayName:function updateDisplayName(displayText,oldDisplayText,isTitle){var model=this.model,key=this.k;if(isTitle){model.renameRWUnitTitle(displayText,oldDisplayText,key,{success:function(appliedTitle){this.set("title",appliedTitle);}.bind(this),failure:function(err){mstrmojo.err(err);this.set("title",oldDisplayText);}.bind(this)});}else{model.renameRWUnit(displayText,oldDisplayText,key,{success:function(){this.synchronizeEditors();}.bind(this)});}},ontitleChange:function ontitleChange(){this.titleBar.set("title",this.title);},oncontextmenu:function oncontextmenu(evt){if(mstrApp.isInVFInteractMode||(this.boxContent&&this.boxContent.isCustomSort)){$DOM.preventDefault(window,evt.e);}else{if(this.shouldShowCustomizeContextMenu(evt)){var menuConfig=this.addContextMenuItems(new mstrmojo.ui.menus.MenuConfig({position:$DOM.getMousePosition(evt.e,evt.hWin),isHostedWithin:false}),evt);$DOM.preventDefault(window,evt.e);if(menuConfig.hasMenuItems()){this.openPopup(menuConfig.newInstance());}}}evt.cancel();},addContextMenuItems:function addContextMenuItems(menuCfg,evt){var editorModel=this.getEditorModel(),fnFormatHandler;if(editorModel.getFormattingToolbar){fnFormatHandler=function(fmtTarget){var toolbar=editorModel.getFormattingToolbar(fmtTarget,evt.getTarget());if(toolbar){this.openPopup(toolbar);}}.bind(this);}if(!mstrApp.isInVFConfigMode){this.addFormatMenuItem(menuCfg,evt,fnFormatHandler);}return menuCfg;},addFormatMenuItem:function addFormatMenuItem(menuCfg,formatData,fnCustom){if(!mstrApp.isAppStatePresentation()&&mstrApp.allowWebDashboardDesign()){menuCfg.addMenuItem(mstrmojo.desc(1918,"Format"),"",function(){this.selectVIUnit();launchFormatAction.call(this,formatData,fnCustom);}.bind(this));}return menuCfg;},getFormatMenuItemTarget:function getFormatMenuItemTarget(formatData){return mstrmojo.vi.models.editors.BaseEditorModel.TITLE_CONTAINER_VALUE;},applyBoxSize:function applyBoxSize(height,width,top,left){this._super(height,width,top,left);this.dimensionsSet=true;var widthInt=parseInt(width,10),heightInt=parseInt(height,10);var newOrientation=widthInt>heightInt?"h":"v";if(newOrientation!==this.orientation){this.set("orientation",newOrientation);}this.set("ghostImgCss",calculateGhostImgCss.call(this,widthInt,heightInt));},childRenderCheck:function childRenderCheck(c){var doChildRender=this._super(c);if(c===this.boxContent){doChildRender=doChildRender&&this.dimensionsSet;}return doChildRender;},postUpdateLayout:function postUpdateLayout(){var boxContent=this.boxContent;if(!this.domNode){return ;}if(!boxContent.hasRendered){boxContent.render();var selectedUnitKey=this.model.getLatestSelectedViUnitKey(),unit=selectedUnitKey&&this.parent.getUnitByKey(selectedUnitKey);if(unit){this.model.selectVIUnit(unit.id);}else{this.parent.selectFirstBox();}}else{this.updateVisFilterIndicator();boxContent.refresh(null,!mstrApp.isPartialUpdate);}this.isNewUnitContainer=false;},orientationHasChanged:mstrmojo.emptyFn,onRender:function onRender(){this._super();var selectedUnit=this.model.getSelectedViUnit();this.toggleBoxSelection(selectedUnit&&selectedUnit.k===this.k);},onAppStateChange:function onAppStateChange(evt){var appState=mstrmojo.vi.VisualInsightApp.APP_STATES,selectionMode=appState.SELECTOR_TARGETING,presentationMode=appState.PRESENTATION,pauseMode=appState.PAUSE,isPresentationOn=mstrApp.isAppStatePresentation(),isPauseModeOn=mstrApp.isAppStatePause();if(isPresentationOn||evt.valueWas&presentationMode){this.draggable=!(isPresentationOn||mstrApp.isLayoutModePreview());this.generateToolbar();}if(evt.valueWas&selectionMode||mstrApp.isAppStateSelection()||isPauseModeOn||evt.valueWas&pauseMode){this.generateToolbar();}var selectedUnit=this.model.getSelectedViUnit();this.toggleBoxSelection(selectedUnit&&selectedUnit.k===this.k);},onLayoutModeChange:function onLayoutModeChange(evt){var isPreviewOn=mstrApp.isLayoutPreview(evt.value);if(isPreviewOn||mstrApp.isLayoutPreview(evt.valueWas)){this.draggable=!(mstrApp.isAppStatePresentation()||isPreviewOn);this.generateToolbar();}},selectVIUnit:function selectVIUnit(forceSelection){var parent=this.parent;if(this.enabled&&parent&&parent.selectVIUnit&&!(mstrApp.isAppStateSelection()&&mstrApp.isLayoutModePreview())){this.toggleBoxSelection(this.parent.selectVIUnit(this,forceSelection));}},synchronizeEditors:function synchronizeEditors(){if(this.model.getLatestSelectedViUnitKey()===this.k){this.selectVIUnit(true);}},addToggleTitleMenuItem:function addToggleTitleMenuItem(cfg){var titleButtons=[MNU_HIDE_TITLE,MNU_SHOW_TITLE];if(!this.showTitleBar){titleButtons.reverse();}cfg.addDualStateItem(this.id,titleButtons[0],titleButtons[1]);},canShowDesignMenuItems:function canShowDesignMenuItems(){return mstrApp.allowWebDashboardDesign();},updateToolbar:function updateToolbar(cfg){var corners=cfg.ENUM_CORNERS,boxContent=this.boxContent,vizNode=boxContent&&boxContent.node,isXtab=vizNode&&(!vizNode.defn.vis||!vizNode.defn.vis.ve);cfg.setAlignment(corners.BOTTOM_RIGHT,corners.TOP_RIGHT);cfg.isHostedWithin=false;cfg.showContextMenu=false;if(this.canShowDesignMenuItems()&&!mstrApp.isAppStatePresentation()){cfg.addSeparator();if(!(mstrApp.isInVFConfigMode&&!isXtab)){this.addFormatMenuItem(cfg);}if(this.showTitleBar){cfg.addMenuItem(mstrmojo.desc(1388,"Rename"),"rnm",function(){this.draggable=false;this.titleBar.editTitle();}.bind(this));}if(undefined!==this.getEditOverlayControls()){cfg.addMenuItem(mstrmojo.desc(3272,"Edit"),"cls",this.switchToEditMode.bind(this));}this.addDeleteMenuItem(cfg);}return cfg;},addDeleteMenuItem:function addDeleteMenuItem(menuCfg){if(!mstrApp.isLayoutModePreview()&&!(mstrApp.isInVFConfigMode||mstrApp.isInVFInteractMode)){var key=this.k,modelId=this.model.id;menuCfg.addMenuItem(mstrmojo.desc(629,"Delete"),"cls",function(){getUnitContainer(modelId,key).deleteSelf();});}return menuCfg;},deleteSelf:function deleteSelf(callback){var scdp,unitContainerKey=this.k,model=this.model,modelId=model.id,modelData=model.data,parent=getUnitContainer(modelId,unitContainerKey).parent,parentKey=parent.k,keys=[parentKey],tgtFilters=[],getChildren=function(node){return node.sections||node.subsections||node.objects||node.panels||node.layouts||node.children;},deleteNode=function(node,key){var children=getChildren(node),i;for(i=0;children&&(i<children.length);i++){if((children[i]&&children[i].k)===key){$ARR.removeIndices(children,i,1);return ;}else{deleteNode(children[i],key);}}},undoRedoCallback=model.getRebuildCallback(),undoRedo=function(isDeleted){var unitContainer=getUnitContainer(modelId,unitContainerKey),mod=mstrmojo.all[modelId],layoutDef=mod.getCurrentLayoutDef(),units=(layoutDef&&layoutDef.units)||{},unitDef=units[unitContainerKey];if(unitContainer){if(isDeleted){unitContainer.defn._isDeleted=true;}else{delete unitContainer.defn._isDeleted;}}if(unitDef){if(isDeleted){unitDef._isDeleted=true;}else{delete unitDef._isDeleted;}}mod.syncLayerDefn(unitContainerKey,scdp,isDeleted);};tgtFilters=tgtFilters.concat(model.getSourceFilterKeys(unitContainerKey,true));tgtFilters=tgtFilters.concat(model.getTargetFilterKeys(this));this.model.execute({execute:function(){var unitContainer=getUnitContainer(modelId,unitContainerKey);if(unitContainer){var panel=unitContainer.parent,model=mstrmojo.all[modelId],update=model.getDataService().newUpdate();var hasMultipleChildren=panel.hasMultipleChildren();update.addUpdate(unitContainer.createDeleteUpdate());scdp=model.getMapLayerKeys(unitContainer.boxContent);update.addActions(model.getDeleteMapLayersActions(scdp));update.addCallbacks({success:function success(response){model.partialUpdate(response.data,model.getTargetDefn(tgtFilters),response.defn,tgtFilters);deleteNode(modelData,unitContainerKey);model.deleteDataCache(unitContainer.boxContent&&unitContainer.boxContent.id);unitContainer.defn._isDeleted=true;model.syncLayerDefn(unitContainerKey,scdp,true);unitContainer.destroy();}});panel.deleteBoxAndSubmitDeferred(update,unitContainer,null,true);if(!hasMultipleChildren){model.addVisualizationDeferred(update,panel.k);}panel.selectFirstBox();update.addCallbacks(callback);update.addExtras({style:{params:{treesToRender:0}}});this.submitUpdate(update);}},urInfo:{undo:function undo(){undoRedo(false);},redo:function redo(){undoRedo(true);},puKeys:keys,extras:mstrmojo.DocDataService.REQUEST_DEFN_DATA,callback:undoRedoCallback}});},undoInsert:function undoInsert(){var panel=this.parent,model=mstrmojo.all[this.model.id];panel.deleteBoxAndSubmitDeferred(model.getDataService().newUpdate(),this,null,true);panel.selectFirstBox();this.destroy();},createDeleteUpdate:function createDeleteUpdate(){},getTitleBarVisibility:function TitleBarVisibility(){return this.titleBar&&this.showTitleBar;},setTitleBarVisibility:function setTitleBarVisibility(isVisible){var titleBar=this.titleBar;titleBar.set("visible",isVisible);var info=this.menuBtnInfo,menuBtn=info&&info.btn;if(info){if(!info.menuCfg){info.menuCfg=titleBar.getMenuConfig();}if(mstrApp&&mstrApp.isInVFInteractMode){info.menuCfg=null;}if(!menuBtn){menuBtn=info.btn=document.createElement("div");menuBtn.className="hover-menu-btn";var id=this.id;$DOM.attachEvent(menuBtn,"click",function(evt){var panel=mstrmojo.all[id],cfg=info.menuCfg;cfg.hostId=id;cfg.hostElement=menuBtn;cfg.supportsScroll=true;cfg.isHostedWithin=false;cfg.maxHeight=$DOM.getMaxScrollHeight();panel.openPopup(new mstrmojo.ui.menus.Menu({popupConfig:cfg}));evt.preventDefault();});}this.domNode.appendChild(menuBtn);}setMenuButtonVisibility.call(this);this.doLayout();},refresh:function refresh(){delete this._currentLayout;if(!this.parent.boxLayoutConfig.dirty){this._super();}else{applyFormat.call(this,false,this.getFormats());if(this.showTitleBar){applyFormat.call(this,true,this.getFormats());}}},addFormatProps:function addFormatProps(action,skipPartialRetrieval){return action;},onclick:function onclick(evt){evt.e.justSwitched=this.k!==this.getDocModel().getLatestSelectedViUnitKey();this.selectVIUnit();if(!evt.e.ptvSelected&&this.switchPropertyOnClick(evt)){this.boxContent.edtModel.selectTargetByValue(mstrmojo.vi.models.editors.BaseEditorModel.TITLE_CONTAINER_VALUE);}},switchPropertyOnClick:function switchPropertyOnClick(){var editorModel=this.boxContent.edtModel;return !!(editorModel&&editorModel.selectTargetByValue);},getZonesModel:function getZonesModel(){return null;},getEditorModel:function getEditorModel(){return this.boxContent.edtModel;},onmouseenter:function onmouseenter(){var menuBtnInfo=this.menuBtnInfo;if(menuBtnInfo&&menuBtnInfo.menuCfg){$CSS.addClass(menuBtnInfo.btn,CSS_BTN_VISIBLE);$CSS.removeClass(menuBtnInfo.btn,CSS_MOUSE_LEFT);}},onmouseleave:function onmouseleave(){var menuBtnInfo=this.menuBtnInfo;if(menuBtnInfo&&menuBtnInfo.menuCfg){$CSS.addClass(menuBtnInfo.btn,CSS_MOUSE_LEFT);$CSS.removeClass(menuBtnInfo.btn,CSS_BTN_VISIBLE);}},onmouseover:function onmouseover(evt){if(!mstrApp.isInteractive()){return ;}if(!this.bubbleMouseOver){evt.cancel();}var timeout=this._panelTimeout;if(timeout){window.clearTimeout(timeout);delete this._panelTimeout;}if(this.titleBar.visible&&!mstrApp.isAppStateSelection()){this.titleBar.setToolbarVisibility(true);}},onmouseout:function onmouseout(){var id=this.id;this._panelTimeout=window.setTimeout(function(){var panel=mstrmojo.all[id];if(panel){panel.titleBar.setToolbarVisibility(false);}},200);},menuDisplayCallback:function menuDisplayCallback(visible){var menuBtnInfo=this.menuBtnInfo;$CSS.toggleClass(menuBtnInfo.btn,CSS_BTN_VISIBLE,visible);$CSS.toggleClass(menuBtnInfo.btn,CSS_MOUSE_LEFT,!visible);},onmousemove:function onmousemove(){var me=this,menuBtnInfo=me.menuBtnInfo;if(me.titleBar&&!me.titleBar.visible&&menuBtnInfo&&menuBtnInfo.menuCfg){if(!!me.mouseMovingTimer){clearTimeout(me.mouseMovingTimer);clearTimeout(me.menuDisplayTimeout);}me.mouseMovingTimer=setTimeout(function(){clearTimeout(me.menuDisplayDelay);me.menuDisplayDelay=null;clearTimeout(me.menuDisplayTimeout);me.menuDisplayTimeout=setTimeout(function(){me.menuDisplayCallback(false);},1500);},100);if(!me.menuDisplayDelay){me.menuDisplayDelay=setTimeout(function(){me.menuDisplayCallback(true);},500);}}},isDragValid:function isDragValid(context){var srcNode=context.src.node,srcNodeTagName=srcNode.tagName,srcNodeClassName=srcNode.className;srcNodeTagName=(srcNodeTagName&&srcNodeTagName.toLowerCase())||"";srcNodeClassName=(srcNodeClassName&&srcNodeClassName.toLowerCase())||"";if(srcNodeTagName==="input"||srcNodeTagName==="textarea"||srcNodeClassName.indexOf("hover-menu-btn")>-1||srcNodeClassName.indexOf("icn")>-1){return false;}return this.parent.hasMultipleChildren();},initializeDrag:function initializeDrag(){if(this._super()!==false){this.selectVIUnit();}},getTargetDropZone:function getTargetDropZone(context){if(isDragFromDatasets.call(this,context)||isDragFromAllObjectsBrowser.call(this,context)){return"";}return this._super(context);},allowDrop:function allowDrop(context){var dragSrc=context.src,widget=dragSrc&&dragSrc.widget;if(widget&&widget===this){return false;}if(isDragFromFilter.call(this,context)&&this.allowDropFromFilter(context)){return true;}if(isDragFromDatasets.call(this,context)&&this.allowDropFromDataset(context)){return true;}if(isDragFromAllObjectsBrowser.call(this,context)&&this.allowDropFromAllObjectsBrowser(context)){return true;}return this._super(context);},allowDropFromFilter:function allowDropFromFilter(context){var src=context&&context.src,widget=src&&src.widget;return mstrApp.allowWebDashboardDesign()&&!(widget&&widget.isVisFilter());},allowDropFromDataset:function allowDropFromDataset(context){return false;},allowDropFromAllObjectsBrowser:function allowDropFromAllObjectsBrowser(context){return this.allowDropFromDataset(context);},close:function(){this.parent.deleteBoxAndSubmit(this);this.parent.removeChildren(this);mstrApp.rootCtrl.generateToolbar();this.destroy();},createAvatar:function createAvatar(){this.domNode.style.zIndex="-1";var avatar=document.createElement("div");avatar.className=this.getAvatarCls().join(" ");avatar.textContent=this.getDisplayName();return this.offsetAvatar(avatar);},ondragend:function ondragend(context){this.domNode.style.zIndex=DEFAULT_Z_INDEX;this._super(context);},wasDropped:function wasDropped(context){this.domNode.style.zIndex=DEFAULT_Z_INDEX;this._super(context);},ondrop:function ondrop(context){var isFromFilter=isDragFromFilter.call(this,context),edge=this.maskNode.zone,selectorNode,docModel=this.getDocModel(),me=this;if(isFromFilter){selectorNode=context.src.widget.selector.node;}this._super(context);if(isDragFromDatasets.call(this,context)){docModel.selectVIUnit(this.id);this.dropFromDataset(context);}if(isDragFromAllObjectsBrowser.call(this,context)){var widget=context.src.widget,dp=widget&&widget.dataProvider;if(dp){dp.loadObjects(context.getCtxtDragData().items,{success:function(){me.dropFromAllObjects(context);}});}}if(isFromFilter){var targetBox=this;if(!edge){edge=this.parent.getPanelTargetEdge(context);if(edge){targetBox=null;}}this.model.insertExistingFilter(selectorNode,targetBox,edge);}},postDropBox:function postDropBox(){this.domNode.style.zIndex=DEFAULT_Z_INDEX;},rebuildBoxContent:function rebuildBoxContent(boxContentNode){var boxContent=this.boxContent,parentPanel=this.parent;this.removeChildren(boxContent);boxContent.destroy();if(boxContentNode){boxContent=parentPanel.builder.build([boxContentNode],this.model,{pk:parentPanel.k})[0].boxContent;}else{boxContent=this.model.rebuildUnitFromDataCache(boxContent.id,parentPanel.k,parentPanel.builder).boxContent;}this.addChildren([boxContent]);},dropFromDataset:mstrmojo.emptyFn,dropFromAllObjects:mstrmojo.emptyFn,generateToolbar:function generateToolbar(){var titleBar=this.titleBar,toolbarCfg=titleBar.toolbarCfg,menuBtnInfo=this.menuBtnInfo;if(menuBtnInfo){if(toolbarCfg){toolbarCfg.destroy();}if(menuBtnInfo.menuCfg&&menuBtnInfo.menuCfg.destroy){menuBtnInfo.menuCfg.destroy();}if(mstrApp&&mstrApp.isInVFInteractMode||mstrApp.isAppStateSelection()){menuBtnInfo.menuCfg=null;}else{titleBar.set("toolbarCfg",this.updateToolbar(new mstrmojo.ui.menus.ToolbarConfig()));menuBtnInfo.menuCfg=titleBar.getMenuConfig();}}if(this.hasRendered){setMenuButtonVisibility.call(this);}},getTitleVisibilityFmts:function getTitleVisibilityFmts(value){return{FormattingView:{ShowTitleBar:value}};},toggleTitleBar:function toggleTitleBar(isVisible){var contentWidgetId=this.boxContent.id,model=this.model,toggleUnitContainerTitle=function toggleUnitContainerTitle(newVisibleValue){var boxContent=mstrmojo.all[contentWidgetId],unitContainer=boxContent.parent;clearTimeout(unitContainer.mouseMovingTimer);clearTimeout(unitContainer.menuDisplayTimeout);clearTimeout(unitContainer.menuDisplayDelay);unitContainer.setTitleBarVisibility(newVisibleValue);unitContainer.parent.selectVIUnit(unitContainer,true);unitContainer.applyBoxSize(unitContainer.height,unitContainer.width,unitContainer.top,unitContainer.left);unitContainer.showTitleBar=newVisibleValue;unitContainer.generateToolbar();boxContent.refresh(null,true);},containerID=this.id;toggleUnitContainerTitle(isVisible);model.controller.cmdMgr.execute({execute:function(){var unitContainer=mstrmojo.all[contentWidgetId].parent;this.submit([model.getUnitFormatAction(unitContainer,unitContainer.defn.t===mstrmojo.EnumRWUnitType.SELECTOR?5:1,unitContainer.getTitleVisibilityFmts(isVisible?1:0),true)],{success:function success(){mstrmojo.all[containerID].defn.httl=isVisible;},failure:function failure(){toggleUnitContainerTitle(!isVisible);}},mstrmojo.DocDataService.RAPID_EXEC);toggleUnitContainerTitle(isVisible);},urInfo:{silent:true,undo:function undo(){toggleUnitContainerTitle(!isVisible);},redo:function redo(){toggleUnitContainerTitle(isVisible);}}});},getFormats:function getFormats(){var boxContent=this.boxContent;if(boxContent){return boxContent.getFormats();}return null;},clearFormats:function clearFormats(){var boxContent=this.boxContent;if(boxContent&&boxContent.clearFormats){boxContent.clearFormats();}},preBuildRendering:function preBuildRendering(){var boxContent=this.boxContent;if(boxContent){boxContent.attachEventListener("regenerateToolbar",this.id,"generateToolbar");}this.generateToolbar();return this._super();},postBuildRendering:function postBuildRendering(){var showTitleBar=this.showTitleBar;this.setTitleBarVisibility(showTitleBar);if((mstrApp.isAppStatePresentation&&mstrApp.isAppStatePresentation())||(mstrApp.isLayoutModePreview&&mstrApp.isLayoutModePreview())){this.draggable=false;}this._super();this.titleBar.setToolbarVisibility(false);this.applyBoxSize(this.height,this.width,this.top,this.left);return true;},changeUnitFormats:function changeUnitFormats(isTitleBar,formatType,formats,propertyName,newValue,oldValue,fnValueConverter,fnListener){var fnChangeFmtValue=function(value){if(fnValueConverter){value=fnValueConverter(value);}$FORMAT_MODEL.updateFormatBlock(isTitleBar?formats.ttl:formats,propertyName,value);var box=this.parent?this:this.model.getSelectedViUnit();applyFormat.call(box,isTitleBar,formats);var widget=this.boxContent;if(!widget.excludeData){if(!isTitleBar&&widget.restylePlotly){widget.restylePlotly(formats);}}if(fnListener){fnListener(value);}box.synchronizeEditors();if(isTitleBar&&propertyName===$ENUM_FORMAT_PROPERTIES.FONT_SIZE){box.doLayout();box.postUpdateLayout();}},fnUpdateFmtDefn=function(res){this.model.updateDefnCache(res.defn,[this.k]);this.clearFormats();formats=this.getFormats();},callback={success:fnChangeFmtValue.bind(this,newValue)};var borderStyle="none",ExtrasType=mstrmojo.DocDataService.SUPPRESS_DATA;if(propertyName===$ENUM_FORMAT_PROPERTIES.BORDER_STYLE&&oldValue===borderStyle){ExtrasType=mstrmojo.DocDataService.REQUEST_ONLY_DEFINITION;callback=mstrmojo.func.wrapMethods({success:fnUpdateFmtDefn.bind(this)},callback);}this.model.saveUnitFormatProperty(this,[{formatType:formatType,propertyName:propertyName,newValue:newValue,oldValue:oldValue}],callback,ExtrasType,{silent:true,undo:fnChangeFmtValue.bind(this,oldValue),redo:fnChangeFmtValue.bind(this,newValue)});},redraw:function redraw(){if(this.boxContent.redraw()===true){return true;}return this._super();},getAvatarCls:function getAvatarCls(){return["mstrmojo-VIUnit-avatar","icn-avi",mstrApp.getThemeClassName()];},addDragHandle:function addDragHandle(){var handleNode=document.createElement("div");handleNode.className="uc-drag-handle";this.domNode.appendChild(handleNode);},toggleDragHandleVisibility:function toggleDragHandleVisibility(show){$CSS.toggleClass(this.domNode,"no-handler",!show);},toggleBoxSelection:function toggleBoxSelection(isSelected){if(mstrApp.isInVFInteractMode){return ;}var isPresentationMode=mstrApp.isAppStatePresentation(),isPrintPreviewMode=mstrApp.isAppStatePrintPreview(),dNode=this.domNode;$CSS.toggleClass(dNode,"selected",isSelected&&!(isPresentationMode||isPrintPreviewMode));},updateGhostImgCss:function updateGhostImgCss(evt){if(evt.propertyName===$ENUM_FORMAT_PROPERTIES.BACKGROUND_COLOR&&!evt.isTitle){var ghostImgCss=this.ghostImgCss||[];ghostImgCss=$ARR.filter(ghostImgCss,function(item){return CSS_GHOST_DESC_ARR.indexOf(item)===-1;});ghostImgCss=ghostImgCss.concat(calculateGhostDescCss(evt.value));this.set("ghostImgCss",ghostImgCss);}}});}());