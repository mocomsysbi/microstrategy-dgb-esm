(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.Box","mstrmojo.Label","mstrmojo.ui.SearchablePulldown","mstrmojo.warehouse.ui.WaitBoxTip");mstrmojo.requiresDescs(14185,2901,14187);var $A=mstrmojo.array,$DOM=mstrmojo.dom,$CONSTANT=mstrmojo.DI.DIConstants,STR_SEARCH_NS=mstrmojo.desc(14185,"Search for a namespace"),STR_LOADING_NS=mstrmojo.desc(2901,"Loading..."),STR_UPDATE=mstrmojo.desc(14187,"Update namespaces"),$ENUM_DATA_CHANGE_EVENTS=mstrmojo.warehouse.EnumDataChangeEvents,STR_WAITBOXTIP_ID="WaitBoxTip",maxNamespaceLength=20,nameSpace=mstrmojo.desc(15258,"Namespace"),suffix="...",$DIHELPER=mstrmojo.DI.DIHelpers;var REFRESH_NS_BUTTON_WIDTH=31;mstrmojo.ui.PopupListForNS=mstrmojo.declare(mstrmojo.ui.PopupList,null,{scriptClass:"mstrmojo.ui.PopupListForNS",onclick:function(evt){if(evt.getTarget().className.indexOf("disabled")!==-1){return false;}else{this._super(evt);}}});mstrmojo.warehouse.ui.NameSpacePullDown=mstrmojo.declare(mstrmojo.Box,null,{scriptClass:"mstrmojo.architect.ui.NameSpacePullDown",cssClass:"mstrmojo-wh-NameSpacePullDown",visible:false,pulldown:undefined,btnRefreshNS:undefined,selectedIndex:undefined,waitBoxTip:undefined,labelNS:undefined,keepNamespacesVisible:false,sourceInfoLoadedByRefreshBtn:undefined,children:[{scriptClass:"mstrmojo.Label",alias:"labelNS",cssClass:"mstrmojo-wh-labelNS",text:nameSpace.length>maxNamespaceLength?nameSpace.substring(0,maxNamespaceLength-suffix.length)+suffix:nameSpace,title:nameSpace,useRichTooltip:true,updateTooltipConfig:function(){var pos=$DOM.position(this.domNode);this.set("richTooltip",{cssClass:"vi-regular A-center vi-tooltip-A",top:Math.max(pos.y+pos.h*1.2,0),left:Math.max(pos.x+pos.w*0.5,0),posType:mstrmojo.tooltip.POS_TOPCENTER,content:this.title});},visible:false},{scriptClass:"mstrmojo.ui.SearchablePulldown",alias:"pulldown",isHostedWithin:false,scrollNodeMaxHeight:350,hostedCSSClass:"mstrmojo-wh-Panel.AvailableTables",visible:false,nameSpacesLoaded:undefined,renderOnScroll:true,updateText:function updateText(text){this.selectedNode.textContent=text;},onPopupWidgetOpened:function onPopupWidgetOpened(){this.getPopupWidget().set("width",mstrmojo.dom.position(this.domNode).w+"px");},onPopupWidgetClosed:function onPopupWidgetClosed(){this.set("isEditing",false);var pulldownList=this.getPopupList(),oldItems=pulldownList._oldItems;delete pulldownList._oldItems;if(oldItems&&(!oldItems[0].cls||oldItems[0].cls.indexOf("disabled")===-1)){this.setDefaultListAndIndex(oldItems);}},onitemSelected:function onitemSelected(item){if(this.parent.mode===1){this.parent.selectedIndex=this.selectedIndex;if(this.parent.onItemSelectedCallback){this.parent.onItemSelectedCallback(item);}}else{this.parent.selectedIndex=undefined;}},getPopupListConfig:function(){var cfg=mstrmojo.ui.Pulldown.prototype.getPopupListConfig();cfg.scriptClass="mstrmojo.ui.PopupListForNS";return cfg;}},{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-wh-btnRefreshNS",alias:"btnRefreshNS",visible:false,onclick:function onclick(){if(this.parent.catalogRefreshNS&&typeof this.parent.catalogRefreshNS==="function"){this.parent.catalogRefreshNS();}else{var controller=mstrApp.getRootController(),model=controller.model;if(controller instanceof mstrmojo.qb.bigquery.RootController||controller instanceof mstrmojo.qb.bigquery.ESController){controller.getNameSpaces();}else{model.catalogRefresh=true;if(this.parent.sourceInfoLoadedByRefreshBtn!==undefined){model.sourceInfo=this.parent.sourceInfoLoadedByRefreshBtn;}controller.updateSelectedDBRoleId();}}},title:STR_UPDATE,tooltipOpenDelay:0,useRichTooltip:true,updateTooltipConfig:function(){var pos=$DOM.position(this.domNode);this.set("richTooltip",{cssClass:"vi-regular vi-tooltip-A",top:Math.max(pos.y+34,0),left:Math.max(pos.x-8,0),posType:mstrmojo.tooltip.POS_TOPLEFT,content:this.title});},onvisibleChange:function onvisibleChange(evt){if(this.parent&&this.parent.domNode){var width=this.parent.domNode.clientWidth||parseInt(this.parent.width,10);if(typeof width==="number"&&width>0){if(mstrApp.isWorkstation){this.parent.pulldown.set("width",width-(this.visible?(this.domNode.clientWidth==0?28:this.domNode.clientWidth):0)+"px");}else{this.parent.pulldown.set("width",width-(this.visible?this.domNode.clientWidth:0)+"px");}}}}}],onwidthChange:function onwidthChange(evt){var width=parseInt(evt.value,10);if(width>0){this.pulldown.set("width",width-(this.btnRefreshNS.visible?this.btnRefreshNS.domNode.clientWidth:0)+"px");if(this.waitBoxTip){this.waitBoxTip.adjustCorners();}}},onvisibleChange:function onvisibleChange(evt){if(this&&this.domNode){var width=this.domNode.clientWidth||parseInt(this.width,10);if(this.visible&&typeof width==="number"&&width>0){this.pulldown.set("width",width-this.btnRefreshNS.domNode.clientWidth+"px");if(this.waitBoxTip){this.waitBoxTip.adjustCorners();}}}},postBuildRendering:function postBuildRendering(){var me=this;if(this._super){this._super();}if($DOM.isIE8||$DOM.isIE9){mstrmojo.css.addClass(this.domNode,"ie9");}if(!mstrmojo.all[STR_WAITBOXTIP_ID]){mstrmojo.insert({scriptClass:"mstrmojo.warehouse.ui.WaitBoxTip",cssClass:"mstrmojo-WaitBoxTip",id:STR_WAITBOXTIP_ID,adjustCorners:function adjustCorners(){var self=this;if(me&&me.domNode){var marginLeftOfPullDown=$DOM.getComputedMargin(me.pulldown.domNode)[3],marginLeftOfRefreshBtn=$DOM.getComputedMargin(me.btnRefreshNS.domNode)[3],marginRightOfLabel=$DOM.getComputedMargin(me.labelNS.domNode)[1];setTimeout(function(){var parentPosition=mstrmojo.dom.position(me.domNode);self.set("width",((me.domNode.clientWidth||parseInt(me.width,10))-(me.btnRefreshNS.visible?me.btnRefreshNS.domNode.clientWidth:0)-(me.labelNS.visible?me.labelNS.domNode.clientWidth:0)-marginLeftOfPullDown-marginLeftOfRefreshBtn-marginRightOfLabel)+"px");self.set("position",{left:parentPosition.x+(me.labelNS.visible?me.labelNS.domNode.clientWidth:0)+marginLeftOfPullDown+marginRightOfLabel+"px",top:(parentPosition.y+me.domNode.clientHeight)+"px"});},300);}}});}this.waitBoxTip=mstrmojo.all[STR_WAITBOXTIP_ID];},init:function init(props){this._super(props);var $this=this,evtConfig={},listConfig=evtConfig[this.id]={};listConfig[$ENUM_DATA_CHANGE_EVENTS.NAMESPACES_CHANGED]=function nsChanged(evt){$this.loadNameSpaces(evt);};listConfig[$ENUM_DATA_CHANGE_EVENTS.NAMESPACES_REQUESTED]=function nsChanged(evt){$this.preLoadNameSpaces(evt);};listConfig[$ENUM_DATA_CHANGE_EVENTS.NAMESPACES_CANCELED]=function nsChanged(evt){$this.afterCancelNameSpaces(evt);};mstrApp.getRootController().attachDataChangeListeners(evtConfig);},mode:0,afterCancelNameSpaces:function afterCancelNameSpaces(evt){var isOpen=this.pulldown.getPopupList().visible;if(isOpen){this.pulldown.getPopupList().close();}this.mode=0;this.pulldown.set("items",[{n:""},{n:STR_UPDATE}]);this.pulldown.updateText(STR_UPDATE);this.pulldown.set("visible",true);this.set("visible",true);this.btnRefreshNS.set("visible",true);this.labelNS.set("visible",true);if($CONSTANT.xdaType.qbSingleTable===mstrApp.type){this.pulldown.domNode.style.maxWidth="153px";}},preLoadNameSpaces:function preLoadNameSpaces(evt){if(!((this.sourceInfo===evt.sourceInfo)||(evt.sourceInfo==="")||(evt.sourceInfo===undefined))){return ;}this.set("visible",true);this.pulldown.set("visible",true);this.btnRefreshNS.set("visible",true);this.labelNS.set("visible",true);this.mode=0;var nameSpaces=[];if(this.sourceInfo==="tablesPanel"){nameSpaces[0]={n:""};this.pulldown.set("items",nameSpaces);this.pulldown.set("selectedIndex",0);this.pulldown.updateText(STR_SEARCH_NS);var width=this.domNode.clientWidth||parseInt(this.width,10),marginLeftOfPullDown=$DOM.getComputedMargin(this.pulldown.domNode)[3],marginLeftOfRefreshBtn=$DOM.getComputedMargin(this.btnRefreshNS.domNode)[3],marginRightOfLabel=$DOM.getComputedMargin(this.labelNS.domNode)[1];this.waitBoxTip.showWait({message:STR_LOADING_NS,showCancel:true,cancelCallback:this.cancelNamespace,extraCls:$CONSTANT.xdaType.qbSingleTable===mstrApp.type?"extraCls-selectTables":undefined,position:{left:$DOM.position(this.domNode).x+(this.labelNS.visible?this.labelNS.domNode.clientWidth:0)+marginLeftOfPullDown+marginRightOfLabel+"px",top:($DOM.position(this.domNode).y+this.domNode.clientHeight)+"px"},width:(width-(this.btnRefreshNS.visible?this.btnRefreshNS.domNode.clientWidth:0)-(this.labelNS.visible?this.labelNS.domNode.clientWidth:0)-marginLeftOfPullDown-marginLeftOfRefreshBtn-marginRightOfLabel)+"px"});}else{if(this.parent.parent.parent){nameSpaces[0]={n:""};nameSpaces[1]={n:STR_LOADING_NS};this.pulldown.set("items",nameSpaces);if(!this.keepNamespacesIndexUnselectedBeforeLoading){this.pulldown.set("selectedIndex",0);}this.labelNS.set("visible",true);this.pulldown.set("visible",true);this.set("visible",true);this.pulldown.updateText(STR_SEARCH_NS);}}},cancelNamespace:function cancelNamespace(){mstrApp.getRootController().cancelLoadNameSpaces();},loadNameSpaces:function loadNameSpaces(res){if(this.waitBoxTip){this.waitBoxTip.closeWait();}if(!((this.sourceInfo===res.sourceInfo)||(res.sourceInfo==="")||(res.sourceInfo===undefined))){return ;}var nameSpaces=res.namespaces||[],hasNamespaces=true,newDBRoleID=res.dbRoleID,wls,cookieNameSpace,idx=-1;if(nameSpaces.length===0){nameSpaces.push({n:""});hasNamespaces=false;}nameSpaces=nameSpaces.sort(function(a,b){return a.n.toLowerCase().localeCompare(b.n.toLowerCase());});var pulldown=this.pulldown,txt=pulldown.selectedNode.innerHTML,popupList=pulldown.getPopupList(),isOpen=popupList.visible,visible=this.keepNamespacesVisible||hasNamespaces;if(isOpen){popupList.close();}this.mode=1;pulldown.set("items",nameSpaces);pulldown.set("visible",visible);this.labelNS.set("visible",visible);this.set("visible",visible);this.btnRefreshNS.set("visible",visible);if(!hasNamespaces&&!res.error){pulldown.set("selectedIndex",0);}this.dbRoleID=newDBRoleID;if(this.nameSpacesLoaded){this.nameSpacesLoaded();}if(hasNamespaces){if(this.sourceInfo==="tablesPanel"||isOpen){pulldown.openPopup(popupList);}if(mstrApp.getRootController().isUsingCookieNamespace()){wls=window.localStorage;cookieNameSpace=(wls&&wls.getItem(newDBRoleID));idx=$A.find(nameSpaces,"n",cookieNameSpace);}if(idx>=0){pulldown.set("selectedIndex",idx);}else{pulldown.updateText(txt);}if(txt&&txt!==STR_SEARCH_NS){pulldown.processSearch();}}}});}());