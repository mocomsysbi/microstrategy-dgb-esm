(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.hash","mstrmojo.expr","mstrmojo.ME.TokenInputBox","mstrmojo.ME.MetricDataService","mstrmojo.DataGrid","mstrmojo.Button","mstrmojo.ToolBar","mstrmojo.Editor","mstrmojo.ME._MetricEditorHelper","mstrmojo.mstr.EnumFunction","mstrmojo.mstr.EnumDSSXMLObjectTypes","mstrmojo.ME._HasLevel","mstrmojo.ME._HasSortBy","mstrmojo.ME.FunctionInfo");mstrmojo.requiresDescs(1107,1281,2148,2397,2399,3324,3377,3693,4531,4788,6223,6397,6398,9577,9579,9581,9582,9583,9584,11564,11565,12178,12179,12853,13806,13807,13808,14173,14334);var E=mstrmojo.expr,ARR=mstrmojo.array,HASH=mstrmojo.hash,ENUM_F=mstrmojo.mstr.EnumFunction,_brackets=mstrmojo.ME.MetricToken.brackets,_splitAttrAndAttrForm=mstrmojo.ME.MetricToken.splitAttrAndAttrForm,OBJ_TYPE=mstrmojo.mstr.EnumDSSXMLObjectTypes,MDS=mstrmojo.ME.MetricDataService;var ID,EDITOR;var isCount=function(fct){return(fct||EDITOR.metricContent1.fctPulldown.selectedItem).fnt===ENUM_F.FunctionCount;};var _setupFunctionProps=function(fctProps,fct){var isCount=fct.fnt===ENUM_F.FunctionCount,useGUIDefault=EDITOR.useGUIDefault;var dftsFctProps=[{n:"Distinct",dtp:11,dfv:"0",v:(isCount&&useGUIDefault?"-1":"0"),desc:"",dn:mstrmojo.desc(13806,"Include Distinct Elements:")},{n:"Null",dtp:11,dfv:"0",desc:"",dn:mstrmojo.desc(13807,"Include Null:")},{n:"UseLookupForAttributes",dtp:11,dfv:"0",v:"0",desc:"",dn:mstrmojo.desc(13808,"Use Lookup For Attributes:")},{n:"FactID",dtp:-1,desc:"",dn:"",items:[]}];if(!isCount||EDITOR.isDME){dftsFctProps.splice(ARR.find(dftsFctProps,"n","Null"),1);}if(EDITOR.isDME){dftsFctProps.splice(ARR.find(dftsFctProps,"n","FactID"),1,{n:"MetricID",dtp:-3,desc:"",dn:mstrmojo.desc(14173,"Metric Guide:"),items:[]});}mstrmojo.array.forEach(fctProps,function updatePropFromMetricDef(item){var idx=mstrmojo.array.find(dftsFctProps,"n",item.n);if(idx>-1){mstrmojo.hash.copy(item,dftsFctProps[idx]);}});return dftsFctProps;};mstrmojo.ME.SimpleMetricEditor=mstrmojo.declare(mstrmojo.Editor,[mstrmojo.ME._MetricEditorHelper,mstrmojo.ME._HasLevel,mstrmojo.ME._HasSortBy],{scriptClass:"mstrmojo.ME.SimpleMetricEditor",cssClass:"mstrmojo-Editor-me mstrmojo-SimpleMetricEditor",title:"",help:"create_derived_metric.htm",fctSyntax:"",fctDesc:"",did:mstrmojo.ME._HasLevel.EnumEditorComponents.simple,isAggFunction:true,bindings:{candidates:"this.opener.candidates"},init:function init(props){if(this._super){this._super(props);}ID=this.id;EDITOR=this;},getMetricDefAsTokens:function getMetricDefAsTokens(){var fct=this.metricContent1.fctPulldown.selectedItem,expr=this.metricContent1.paramInput,tokens=[],i,j,len;tokens.push({v:fct.n,oi:fct});var props=this.functionPropsRef.getTokens();if(this.ios&&this.getSortByDefAsTokens){var sortbyDefTks=this.getSortByDefAsTokens();if(sortbyDefTks.length>0){props.push(sortbyDefTks);}}len=props.length;if(len>0){var anyProp,a,l,tks=[];anyProp=false;tks.push({v:"<",isDelimiter:true});for(i=0;i<len;i++){a=props[i];l=a.length;if(l===0){continue;}anyProp=true;for(j=0;j<l;j++){tks.push(a[j]);}tks.push({v:", ",isDelimiter:true});}tks.pop();if(anyProp){tks.push({v:">",isDelimiter:true});}tokens=tokens.concat(tks);}tokens.push({v:"(",isDelimiter:true});tokens=tokens.concat(expr.getTokens());tokens.push({v:")",isDelimiter:true});for(i=0,len=tokens.length;i<len;i++){tokens[i].isNew=true;}if(this.getLCTDefAsTokens){tokens=tokens.concat(this.getLCTDefAsTokens());}return tokens;},getMetricDefFromTokens:function getMetricDefFromTokens(){var fct=[],fctProps=[],expr=[],tokens=this.oi.tks.items,len=tokens.length,i;for(i=0;i<len;i++){var token=tokens[i],tp=token.tp,sctt=token.sctt;switch(sctt){case 65536:switch(tp){case 280:fct=token.oi;this.ios=fct.ios;break;}break;case 131072:if(tp===259||tp===303||tp===311){fctProps.push({n:tokens[i].v,v:tokens[i+2].v,oi:tokens[i+2].oi});}break;case -1:case 196608:expr.push(token);break;}}if(expr.length>2){if(expr[0].v==="("){expr.shift();}if(expr[expr.length-1].v===")"){expr.pop();}}return{fct:fct,fctProps:fctProps,expr:expr};},insertMode:false,_set_candidates:function(n,v){this.candidates=v;if(this.hasRendered){var pi=this.metricContent1.paramInput;pi.candidates=this.getCandidates([E.TP.METRIC,E.TP.ATTR,E.STP.NDE],true);if(this._super){this._super(n,v);}}return true;},getCandidates:function getCandidates(ts,showForms){var cs=this.candidates,its;if(cs){ts=ARR.ensureArray(ts);its=ARR.filter(cs.items,function(it){return ARR.indexOf(ts,it.t)>-1||ARR.indexOf(ts,it.st)>-1;});if(ARR.indexOf(ts,12)>-1&&showForms){if(this.replaceAttributeWithForms){its=this.replaceAttributeWithForms(its);}}return{items:its,isComplete:cs.isComplete};}return null;},getParamInputCandidates:function(){return this.getCandidates([E.TP.METRIC,E.TP.ATTR].concat(isCount()?[E.STP.NDE]:[]),true);},onOpen:function onOpen(){EDITOR=this;var meDef=this.getMetricDefFromTokens();var oi=this.oi;if(oi&&oi.tks){this.originTks=HASH.clone(oi.tks.items);this.originAfb=oi.mps&&oi.mps.afb;this.originSfb=oi.mps&&oi.mps.sfb;}var fcts=MDS.getAggFunctions(),fp=this.metricContent1.fctPulldown,did=meDef.fct&&meDef.fct.did||this.did;if(fcts&&fp){fp.set("items",fcts);if(did&&MDS.isBasicAggMap(did)){fp.set("value",did);}else{fp.set("value","8107C31BDD9911D3B98100C04F2233EA");}}this.set("fctProps",meDef.fctProps);if(this.functionPropsRef){this.functionPropsRef.propsCache=null;this.functionPropsRef.originFctProps=_setupFunctionProps(this.fctProps,this.metricContent1.fctPulldown.selectedItem);}var pi=this.metricContent1.paramInput;pi.candidates=this.getParamInputCandidates();var fakeO,tLen=meDef.expr.length;if(this.isDME&&this.refOi&&this.candidates){var refid=this.refOi.did;fakeO=mstrmojo.array.filterOne(this.candidates.items,function(itm){return itm.did===refid;});}if(tLen>0){fakeO={n:""};if(tLen===1){var tk=meDef.expr[0];if(tk.extp){fakeO={n:tk.v,did:tk.exv,exv:tk.exv,extp:tk.extp,oi:tk.oi,tk:tk};}else{fakeO=tk.oi||{n:tk.v,t:tk.tp};}}else{for(var i=0;i<tLen;i++){var expr=meDef.expr[i],ns=_splitAttrAndAttrForm(expr.v);if(expr.oi&&expr.exv&&ns.length===2){fakeO.n+=(_brackets(ns[0])+"@"+_brackets(ns[1]));}else{if(MDS.isLogicOrCompFunc(expr)){fakeO.n+=(" "+expr.v+" ");}else{if(expr.oi&&(expr.oi.t===mstrmojo.mstr.EnumDSSXMLObjectTypes.Metric||expr.oi.t===mstrmojo.mstr.EnumDSSXMLObjectTypes.Fact||expr.oi.t===mstrmojo.mstr.EnumDSSXMLObjectTypes.Attribute)){fakeO.n+=_brackets(expr.v);}else{fakeO.n+=expr.v;}}}}fakeO.t=-2;fakeO.tks=meDef.expr;}}pi.set("items",null);pi.set("items",fakeO?[fakeO]:null);this.set("title",this.insertMode?this.metricContent1.fctPulldown.selectedItem.n:mstrmojo.desc(9582,"Function Editor: ")+" "+this.oi.n);this.raiseEvent({name:"fctDidChange",did:did});if(this._super){this._super();}this.set("ios",fp.selectedItem.ios);},useGUIDefault:false,functionPropsRef:{scriptClass:"mstrmojo.Editor",cssClass:"mstrmojo-ME-functionParameters",useRichTooltip:false,setupFunctionProps:function setupFunctionProps(){var o=this.opener;this.fctPropsGrid.items=null;var selectedFunction=o.metricContent1.fctPulldown.selectedItem;this.propsCache=this.propsCache||{};this.propsCache[selectedFunction.did]=this.propsCache[selectedFunction.did]||_setupFunctionProps(o.fctProps,selectedFunction);this.cleanCopy={did:selectedFunction.did,props:mstrmojo.hash.clone(this.propsCache[selectedFunction.did])};this.set("fctProps",this.propsCache[selectedFunction.did]);},onOpen:function(){this.setupFunctionProps();var o=this.opener;this.set("title",o.metricContent1.fctPulldown.selectedItem.n+" "+mstrmojo.desc(11565,"Parameters"));},children:[{scriptClass:"mstrmojo.DataGrid",alias:"fctPropsGrid",cssClass:"functionPropsGrid",cssText:"margin: 5px auto; 0",makeObservable:true,banding:false,columns:[{headerText:"",dataFunction:function(d){return'<div class="mstrmojo-DataRow-text"title="'+(d.desc||"")+'">'+(d.dn||d.n)+"</div>";},colCss:"name"},{headerText:"",dataWidgetBuilder:function(d){var w;switch(d.dtp){case 11:w={scriptClass:"mstrmojo.ListHoriz",cssClass:"radio",itemIdField:"did",items:[{n:mstrmojo.desc(6397,"True"),did:"-1"},{n:mstrmojo.desc(6398,"False"),did:"0"}],popupToBody:true,popupZIndex:100,postCreate:function(){var d=this.data;var v=!!d.v?(d.v==="False"||d.v==="0"?0:-1):(d.dfv||0);this.set("selectedIndex",mstrmojo.array.find(this.items,"did",v));},onchange:function(evt){if(evt.removed.length===1){this.data.v=this.selectedItem.did;if(this.data.n==="UseLookupForAttributes"){this.dataGrid.factID.set("enabled",this.data.v==="0"||this.data.v==="False");}this.dataGrid.parent.set("dirty",true);}},getTokens:function(){var d=this.data,v=this.selectedItem.did;if(v!==d.dfv){return[{v:d.n},{v:"=",isDelimiter:true},{v:v==="-1"?"True":"False"}];}else{return[];}}};break;default:w={scriptClass:"mstrmojo.Pulldown",alias:"factID",cssClass:"mstrmojo-ME-Pulldown",popupCssClass:"mstrmojo-ME-Pulldown-Popup",itemIdField:"did",items:d.items,popupToBody:true,popupZIndex:100,postApplyProperties:function postApplyProperties(){this.fixHeight=window.mstrApp&&(mstrApp.isWorkstation||mstrApp.isVI)?true:false;},getTokens:function(){var d=this.data;return this.enabled&&this.selectedIndex>0?[{v:d.n},{v:"=",isDelimiter:true},{v:mstrmojo.ME.MetricToken.brackets(this.selectedItem.n),oi:this.selectedItem,isNew:true}]:[];},postCreate:function(){this.dataGrid.factID=this;var lookup={};mstrmojo.array.forEach(this.dataGrid.parent.fctProps,function(item){if(item.n==="UseLookupForAttributes"){lookup=item;return false;}});var v=!!lookup.v?(lookup.v==="False"||lookup.v==="0"?0:-1):(lookup.dfv||0);this.enabled=v===0;var me=this;switch(d.dtp){case -1:var success=function(res){if(res){me.set("items",[{n:mstrmojo.desc(3693,"(None)"),did:-1}].concat(res.items));me.set("value",d.oi&&d.oi.did||-1);}},failure=function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));};MDS.getFacts({pattern:"*",blockBegin:1,blockCount:-1,rootFolderType:39},{success:success,failure:failure});break;case -2:break;case -3:var metrics=[{n:mstrmojo.desc(4531,"Automatic"),did:-1}];mstrmojo.array.forEach(EDITOR.dsUnits.items,function(item){if(item.t===4){metrics.push(item);}});this.set("items",metrics);this.set("value",(d.oi&&d.oi.did)||-1);break;}},onvalueChange:function(evt){if(evt.valueWas!==null){this.data.oi=this.selectedItem;this.dataGrid.parent.set("dirty",true);}}};break;}w.alias="inputWidget";return w;},colCss:"dtp"}],bindings:{items:function(){return this.parent.fctProps;}}},{scriptClass:"mstrmojo.HBox",slot:"buttonNode",cssClass:"mstrmojo-Editor-buttonBar",cssText:"float:right;margin: 5px 0px;",children:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-Editor-button mstrmojo-WebButton hot",alias:"saveokButton",text:mstrmojo.desc(2397,"OK"),bindings:{enabled:"this.parent.parent.dirty"},onclick:function(){var editor=this.parent.parent;editor.opener.onmetricModify();editor.originFctProps=null;editor.close();}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-Editor-button mstrmojo-WebButton",text:mstrmojo.desc(2399,"Cancel"),onclick:function(){var editor=this.parent.parent;var cc=editor.cleanCopy;editor.propsCache[cc.did]=cc.props;editor.set("dirty",false);editor.close();}}]}],getTokens:function(){var props=[],i,len;var g=this.fctPropsGrid;var fctProps=this.originFctProps;if(fctProps){var prop,dtp,val,propTks;len=fctProps.length;for(i=0;i<len;i++){prop=fctProps[i];dtp=prop.dtp;val=prop.v||prop.dfv;if(dtp===11){var shouldIncludeToken=!MDS.isValEqual(val,prop.dfv);propTks=shouldIncludeToken?[{v:prop.n},{v:"=",isDelimiter:true},{v:MDS.isValEqual(val,"True")?"True":"False"}]:[];props.push(propTks);}else{if(prop.oi){propTks=[{v:prop.n},{v:"=",isDelimiter:true},{v:_brackets(prop.oi.n),oi:prop.oi}];props.push(propTks);}}}}else{if(g){var rs=g&&g.ctxtBuilder.itemWidgets;for(i=0,len=rs.length;i<len;i++){props.push(rs[i].inputWidget.getTokens());}}else{return[];}}return props;}},handleValidation:function(){},postBuildRendering:function(){if(this._super){this._super();}this.addSlots({scrollBoxNode:this.metricLCT.domNode});},children:[mstrmojo.ME._MetricEditorHelper.formatAndOptionsBarRef,mstrmojo.ME._MetricEditorHelper.nameEditBoxRef,mstrmojo.ME._MetricEditorHelper.functionNameRef,{scriptClass:"mstrmojo.Box",cssClass:"mstrmojo-SME-content1",alias:"metricContent1",children:[{scriptClass:"mstrmojo.Pulldown",alias:"fctPulldown",cssClass:"mstrmojo-SME-funcs-pulldown mstrmojo-ME-Pulldown",popupCssClass:"mstrmojo-ME-Pulldown-Popup",popupToBody:true,itemIdField:"did",itemField:"n",postApplyProperties:function postApplyProperties(){this.fixHeight=window.mstrApp&&(mstrApp.isWorkstation||mstrApp.isVI)?true:false;},onvalueChange:function(evt){var syntax="",desc="",item=this.selectedItem;if(item){desc=mstrmojo.ME.FunctionInfo.getDescAndExample(item).desc+"  "+MDS.getFunctionHelpTopic(item.h);var pars=item.pars,sa=[],i,len;sa.push(item.n);sa.push("(");for(i=0,len=pars.length;i<len;i++){sa.push(pars[i].n);if(i!==(len-1)){sa.push(", ");}}sa.push(")");syntax=sa.join("");}var editor=this.parent.parent;editor.set("fctSyntax",syntax);editor.set("fctDesc",desc);editor.set("fctName",item&&item.n);editor.set("ios",item&&item.ios);editor.raiseEvent({name:"fctDidChange",did:item&&item.did});if(evt.valueWas){editor.onmetricModify();}EDITOR.functionPropsRef.originFctProps=_setupFunctionProps(EDITOR.fctProps,item);EDITOR.metricContent1.paramInput.candidates=EDITOR.getParamInputCandidates();}},{scriptClass:"mstrmojo.Label",cssClass:"mstrmojo-SME-agg-label",text:mstrmojo.desc(12853,"of")},{scriptClass:"mstrmojo.ME.ObjectInputBox",alias:"paramInput",cssClass:"mstrmojo-SME-ObjectInputBox-param",maxObjectCount:1,browsableTypes:[11,12,13,43,4,8].join(","),folderLinksContextId:25,emptyText:mstrmojo.desc(14334,"Search for a fact, metric or attribute ..."),getCandidatesThroughTaskCall:function getCandidatesThroughTaskCall(params,callbacks){params.objectType="12,13,43,4";params.rootFolderType=39;params.blockCount=this.blockCount;MDS.getMetricComponents(params,callbacks);},bindings:{isDME:function(){return this.parent.parent.isDME;},dtp:function(){var fnt=this.parent.fctPulldown.selectedItem;return fnt.pars[0].dtp;}},hidePulldownButton:function(){return this.parent.parent.tbBrowsable;},hideItemWidgetBrowseButton:function(){return !this.parent.parent.tbBrowsable;},onSuggestionItemSelect:function onSuggestionItemSelect(it){if(mstrApp&&mstrApp.isVI){var previousItem=this.selectedItem,previousItemType=previousItem&&previousItem.t;if(it&&it.t===OBJ_TYPE.Metric&&previousItemType!==OBJ_TYPE.Metric){var editor=this.parent.parent,fctProps=(editor&&editor.fctProps)||[],defaultLookUpProp={n:"UseLookupForAttributes",v:"False"},functionPropsRef=editor.functionPropsRef,idx=ARR.find(fctProps,"n","UseLookupForAttributes");if(idx>-1){HASH.copy(defaultLookUpProp,fctProps[idx]);}else{fctProps.push(defaultLookUpProp);}editor.set("fctProps",fctProps);if(functionPropsRef){functionPropsRef.propsCache=null;functionPropsRef.originFctProps=_setupFunctionProps(editor.fctProps,editor.metricContent1.fctPulldown.selectedItem);}}}mstrmojo.ME.ObjectInputBox.prototype.onSuggestionItemSelect.call(this,it);},onitemchange:function(){this.parent.parent.onmetricModify();},getTokens:function(){var its=this.getSelectedObjects(),it,len=its.length,i,tks=[],tk,ns;if(len>0){for(i=0;i<len;i++){it=its[i];if(it.state===mstrmojo.Enum_OIB_States.VALID&&it.did){ns=_splitAttrAndAttrForm(it.n);if((it.t===mstrmojo.mstr.EnumDSSXMLObjectTypes.AttributeForm||it.exv)&&ns.length===2){tk={v:_brackets(ns[0])+"@"+_brackets(ns[1]),tp:2,lv:1};var formId=it.fmdid||it.exv;if(formId){tk.tp=275;tk.exv=formId;tk.extp=8;tk.lv=3;tk.oi=it.oi;}}else{tk={v:_brackets(it.n),oi:it};}}else{tk={v:it.n};}tks.push(tk);tks.push({v:",",isDelimiter:true});}tks.pop();}return tks;}}]},{scriptClass:"mstrmojo.Button",iconClass:"mstrmojo-ME-link mstrmojo-SME-fpLink",text:mstrmojo.desc(11564,"Function Parameters"),onclick:function(){var me=this.parent;me.openPopup("functionPropsRef",{selectedFunction:me.metricContent1.fctPulldown.selectedItem,zIndex:me.zIndex+1});}},mstrmojo.ME._HasLevel.getLCTComponent(),mstrmojo.ME._HasSortBy.getSortByWidget(true),{scriptClass:"mstrmojo.Label",slot:"buttonNode",cssClass:"mstrmojo-FE-functionSyntax",bindings:{visible:"this.parent.insertMode",text:"this.parent.fctSyntax"}},{scriptClass:"mstrmojo.Label",slot:"buttonNode",cssClass:"mstrmojo-FE-functionDesc",allowHTML:true,bindings:{visible:"this.parent.insertMode",text:"this.parent.fctDesc"}},mstrmojo.ME._MetricEditorHelper.switchRef,mstrmojo.ME._MetricEditorHelper.buttonBarRef]});}());