(function(){mstrmojo.requiresCls("mstrmojo.ListBase","mstrmojo._IsList","mstrmojo._HasSuggestion","mstrmojo.Enum_Keys","mstrmojo.css","mstrmojo.VisUtility","mstrmojo.hash","mstrmojo.dom");var $DOM=mstrmojo.dom,$CSS=mstrmojo.css,$STORAGE_NAME="srchBoxState",$KEYS=mstrmojo.Enum_Keys,$VISUTIL=mstrmojo.VisUtility,KEY_DELAY=200,markup,SCROLLBAR_WIDTH=24,DEFAULT_FONT={fontFamily:"Arial",fontSize:"11px"};var ERR_STR_MAP={2147762262:mstrmojo.desc(16256,"Please enter a numeric value"),2147762227:mstrmojo.desc(16257,"Unable to perform search with the operators provided")};var STATES={DEFAULT:1,ADDING:2,EMPTY:3,FULL:4};var deleteCssCls="mstrmojo-SimpleObjectInputBox-del";function testInputText(){var inputBox=this.inputBox,text=inputBox&&inputBox.value;if(text!==""&&(text!==this._lastPattern||!this.suggestionShown)){this.showSuggestion(text);this._isSearching=true;if(this.hitEnterToTest){this.inputBox.blur();}}this._lastPattern=text;delete this._timerHandle;}function clearInputTextTimer(){var timerHandle=this._timerHandle;if(timerHandle){window.clearTimeout(timerHandle);delete this._timerHandle;}}function hideInputTooltip(){if(this.richTooltip){if(this.tooltip){this.tooltip.set("allowOtherTooltips",false);}this.hideTooltip();}}function showInputTooltip(evt){var inputPos=this._inputPos,isPresentation=!mstrApp.isAppStatePresentation||mstrApp.isAppStatePresentation(),me=this,tooltip;if(this.richTooltip){tooltip=this.richTooltip;if(!this.hasOpenTooltip&&!this.suggestionShown){tooltip.top=(inputPos.h+inputPos.y)+"px";tooltip.left=inputPos.x+"px";if(!this.hitEnterToTest&&!isPresentation){window.setTimeout(function(){var ttp=me.tooltip,expandNode=ttp&&ttp.contentNode,childNodes,clickNode;childNodes=expandNode?expandNode.childNodes:null;if(childNodes&&childNodes.length>1){clickNode=childNodes[1];childNodes=clickNode.childNodes;if(childNodes&&childNodes.length>1){clickNode=childNodes[1];}else{clickNode=null;}}if(me.hasOpenTooltip&&clickNode&&!$CSS.hasClass(expandNode,"lng")){if(tooltip.onclick){me.tooltip.onclick=tooltip.onclick;$DOM.attachMarkupEvent(me.tooltip.id,clickNode,"click");}$CSS.addClass(expandNode,"lng");}},3000);}this.showTooltip(evt.e,evt.hWin);this.set("allowOtherTooltips",!this.hitEnterToTest);}}}function getStorage(){if(window.mstrLocalStorage===undefined){return{};}var wls=(mstrLocalStorage.getLocalStorage()||{})[$STORAGE_NAME];return(wls&&JSON.parse(wls))||{};}function setStorage(stg){if(window.mstrLocalStorage!==undefined){mstrLocalStorage.setItem($STORAGE_NAME,JSON.stringify(stg));}}mstrmojo.SimpleObjectInputBox=mstrmojo.declare(mstrmojo.ListBase,[mstrmojo._IsList,mstrmojo._HasSuggestion,mstrmojo.ui._HasScroller],{scriptClass:"mstrmojo.SimpleObjectInputBox",markupString:'<div id="{@id}" class="mstrmojo-ListBase mstrmojo-SimpleObjectInputBox {@cssClass}" style="{@cssText}" mstrAttach:click><div class="mstrmojo-SimpleObjectInputBox-container {@icnCss}" style="{@icnCssText}">{@itemsHtml}<input type="text" mstrAttach:keydown,keyup,blur,focus style="display: none;" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" /><div class="mstrmojo-SimpleObjectInputBox-empty"><div>{@emptyText}</div></div></div></div>',markupSlots:{itemsContainerNode:function(){return this.domNode.firstChild;},emptyTextNode:function(){return this.domNode.firstChild.lastChild;},inputBox:function(){var children=this.domNode.firstChild.children;return children[children.length-2];},scrollboxNode:function(){return this.domNode.firstChild;}},markupMethods:{onvisibleChange:mstrmojo.Widget.visibleMarkupMethod,onheightChange:mstrmojo.Widget.heightMarkupMethod,onwidthChange:mstrmojo.Widget.widthMarkupMethod,onmaxItemWidthChange:function onmaxItemWidthChange(){var w=this.maxItemWidth;if(!isNaN(w)&&w>0){this.emptyTextNode.style.maxWidth=w+"px";}}},itemField:"n",emptyText:"",state:0,maxItemWidth:"none",useKeyDelay:false,hitEnterToTest:false,maxObjectCount:null,useRichTooltip:true,init:function init(props){this._super(props);if(mstrApp.isWorkstation){DEFAULT_FONT.fontFamily="Helvetica";}},showTooltip:function showTooltip(evt,win){var target=evt.target||$DOM.eventTarget(evt.hWin,evt.e),item=this.getItemFromTarget(target);if(item&&item.n){var textNode=this.getItemNodeFromTarget(target).firstChild,position=$DOM.position(textNode);this.richTooltip={posType:mstrmojo.tooltip.POS_TOPCENTER,cssClass:"vi-regular vi-tooltip-A A-center",refNode:textNode,content:mstrmojo.string.encodeHtmlString(item.n),top:position.h+11,left:position.w/2};this._super(evt,win);}},getItemMarkup:function(item){if(!markup){var itemField=this.itemField;markup=this._super(item).replace(">{@en@n}<",'"><div class="elem">{@en@'+itemField+'}<div class="'+deleteCssCls+'"></div></div><');}return markup;},getItemProps:function getItemProps(item,idx){var props=this._super(item,idx),itemField=this.itemField;var maxWidth=this.maxItemWidth;if(!isNaN(maxWidth)&&maxWidth>0){maxWidth=(maxWidth-SCROLLBAR_WIDTH);}if(!mstrmojo.string.isEmpty(item[itemField])){var propItemFieldVal=item[itemField];props[itemField]=propItemFieldVal;if(maxWidth<$VISUTIL.measureTextWidth(propItemFieldVal,DEFAULT_FONT)){props.title=propItemFieldVal;}}props.addStyle("max-width:"+maxWidth+"px");return props;},getSuggestionPos:function getSuggestionPos(){var inputPosition=this._inputPos;return{target:this.inputBox,left:inputPosition.x+"px",top:inputPosition.y+inputPosition.h+"px",zIndex:100};},updateSuggestion:function updateSuggestion(items){var stg=getStorage();if(!stg.srch){if(this._super){this._super(items);}}this.inputBox.focus();hideInputTooltip.call(this);},failMessage:function failMessage(failedRes){var msg=ERR_STR_MAP[failedRes.errCode]||failedRes.msg,items=msg?[{n:msg,t:-101,cls:"nomatch"}]:[];this.updateSuggestion(items);},getSearchPattern:function getSearchPattern(){return this.inputBox?this.inputBox.value:"";},showInfoTooltip:function showInfoTooltip(searchPattern){var stg=getStorage(),container=this.parent.parent,pos=$DOM.position(container.domNode),origTooltip=this.richTooltip,me=this;if(!stg.hasShownInfo&&!mstrmojo.SimpleObjectInputBox.HAS_SHOWN_INFO){mstrmojo.SimpleObjectInputBox.HAS_SHOWN_INFO=true;stg.hasShownInfo=true;this.set("richTooltip",{posType:mstrmojo.tooltip.POS_BOTTOMCENTER,cssClass:"vi-regular vi-tooltip-V vi-tooltip-leftcenter",contentNodeCssClass:"srch info",top:pos.y+"px",left:pos.x+pos.w+8+"px",content:mstrmojo.desc(15909,'You can re-enable "Instant Search" from the menu.'),onClose:function(){me.set("richTooltip",origTooltip);}});this.showTooltip(window.event,window);if(this.tooltip){this.tooltip.set("allowOtherTooltips",false);}else{this.set("allowOtherTooltips",false);}}stg.srch=searchPattern;setStorage(stg);},onIncrementalFetch:function onIncrementalFetch(){this.inputBox.blur();},onSuggestionItemSelect:function onSuggestionItemSelect(item){clearInputTextTimer.call(this);this.set("items",this.items.concat(item));this._super();var id=this.id;window.setTimeout(function(){var obj=mstrmojo.all[id];if(parseInt(obj.state,10)!==STATES.FULL){obj.set("state",STATES.ADDING);}},0);},onstateChange:function onstateChange(evt){var state=evt.value;this.emptyTextNode.style.display=(state===STATES.ADDING)?"none":"block";var inputBox=this.inputBox,inputStyle=inputBox.style;if(state===STATES.ADDING){inputStyle.display="";this.updateScrollbars();inputBox.focus();this._inputPos=$DOM.position(inputBox,true);}else{clearInputTextTimer.call(this);inputStyle.display="none";inputBox.value="";this._lastPattern="";this.updateScrollbars();if(this.parent.getFormats&&!this.parent.getFormats().height&&this.parent.parent.performCanGrowCanShrink){this.parent.parent.performCanGrowCanShrink(this.parent.parent.children);}}},postBuildRendering:function postBuildRendering(){var ret,stg=getStorage();KEY_DELAY=(mstrApp.getSearchAutoCompleteDelay&&mstrApp.getSearchAutoCompleteDelay())||KEY_DELAY;this.state=0;this.setDefaultState();if(stg.srch){this.inputBox.value=stg.srch;this.set("state",STATES.ADDING);delete stg.srch;setStorage(stg);}ret=this._super();return ret;},preitemsChange:function preitemsChange(){this.setDefaultState();},onclick:function onclick(evt){var target=$DOM.eventTarget(evt.hWin,evt.e);if(target&&target.className===deleteCssCls){var item=$DOM.findAncestorByAttr(target,"idx",true,this.domNode),idx=item&&parseInt(item.value,10);this.hideTooltip();if(idx!==null&&!isNaN(idx)){var items=this.items.concat();items.splice(idx,1);this.set("items",items);}return ;}if(parseInt(this.state,10)!==STATES.FULL){this.set("state",STATES.ADDING);}},onblur:function onblur(){if(this._isSearching||this.tooltip){return ;}clearInputTextTimer.call(this);hideInputTooltip.call(this);if(!this.suggestionShown){this.setDefaultState();}},onfocus:function onfocus(){this._isSearching=false;if(this.suggestionShown){hideInputTooltip.call(this);}},prekeydown:function prekeydown(evt){var e=evt.e;switch(parseInt(e.keyCode||e.charCode,10)){case $KEYS.DOWN_ARROW:this.nextHighlight();break;case $KEYS.UP_ARROW:this.preHighlight();break;case $KEYS.TAB:case $KEYS.ENTER:$DOM.preventDefault(evt.hWin,e);if(this.suggestionShown){var item=this.getSelected();if(item){this.handleSuggestionItemSelect(item);}else{this.hideSuggestion();}}else{if(this.hitEnterToTest){hideInputTooltip.call(this);testInputText.call(this);}}break;case $KEYS.ESCAPE:clearInputTextTimer.call(this);if(this.suggestionShown){this.hideSuggestion();}else{this.setDefaultState();}break;case $KEYS.BACKSPACE:if(!this.getSearchPattern()&&!mstrApp.hasRequests()){$DOM.preventDefault(evt.hWin,e);var items=this.items&&this.items.concat();if(items&&items.length){items.splice(items.length-1,1);mstrApp.ignoreBackSpace=true;this.set("items",items);var id=this.id;window.setTimeout(function(){mstrmojo.all[id].set("state",STATES.ADDING);mstrApp.ignoreBackSpace=false;},0);}}break;}var rtt=this.richTooltip,clsNm=(rtt&&rtt.contentNodeCssClass)||"";if(clsNm.indexOf("srch info")>-1){hideInputTooltip.call(this);}},prekeyup:function prekeyup(evt){var e=evt.e,key=parseInt(e.keyCode||e.charCode,10),pattern=this.getSearchPattern();if(!pattern||pattern!==this._lastPattern){$DOM.preventDefault(evt.hWin,evt.e);this.hideSuggestion();}if(this.inputBox.value.length&&key!==$KEYS.ENTER&&key!==$KEYS.TAB&&!this.suggestionShown){showInputTooltip.call(this,evt);}else{hideInputTooltip.call(this);}if(this.hitEnterToTest){return ;}if(this.useKeyDelay){var id=this.id;if(!this._timerHandle){this._timerHandle=window.setTimeout(function(){testInputText.call(mstrmojo.all[id]);},KEY_DELAY);}}else{testInputText.call(this);}},widgetResized:function widgetResized(){if(this.hasRendered){var width=parseInt(this.width,10),itemCount=this.items.length,itemsNode=this.itemsContainerNode.childNodes;if(itemCount<=(itemsNode&&itemsNode.length)){var newWidth=width-SCROLLBAR_WIDTH;for(var i=0;i<itemCount;i++){var currItem=itemsNode[i],currText=currItem.textContent;currItem.style.maxWidth=newWidth+"px";if(currText&&newWidth<$VISUTIL.measureTextWidth(currText,DEFAULT_FONT)){currItem.title=currText;}else{currItem.title="";}}}if(this.emptyTextNode){this.emptyTextNode.style.maxWidth=width+"px";}this.updateScrollbars();}},setupScrollNodes:function setupScrollNodes(){this.scrollNode=this.scrollboxNode;},setDefaultState:function setDefaultState(){var mx=this.maxObjectCount,itsLen=(this.items&&this.items.length)||0,isFull=(mx!==null&&mx!==undefined&&itsLen>=mx);this.set("state",!itsLen?STATES.EMPTY:(isFull?STATES.FULL:STATES.DEFAULT));}});mstrmojo.SimpleObjectInputBox.HAS_SHOWN_INFO=false;}());