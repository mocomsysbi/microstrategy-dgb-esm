(function(){mstrmojo.requiresCls("mstrmojo.vi.ui.rw.selectors.CheckList","mstrmojo.ui.SearchBox","mstrmojo.string","mstrmojo.css","mstrmojo.hash","mstrmojo.dom");var $STR=mstrmojo.string,$CSS=mstrmojo.css,$HASH=mstrmojo.hash,$DOM=mstrmojo.dom,$TOOLTIP=mstrmojo.tooltip,DELIMITER_START="\u001E",DELIMITER_END="\u001F";function getItemTextForFilter(item,filterExpression){var unfilteredText=item.n;if(!filterExpression){return unfilteredText;}var filterRegExp=new RegExp($STR.regEscape(filterExpression),"ig");if(unfilteredText!==undefined&&filterRegExp.test(unfilteredText)){return unfilteredText.replace(filterRegExp,function(match){return DELIMITER_START+match+DELIMITER_END;});}return undefined;}function getSearchWidth(){return this.orientation==="v"?this.width:"135px";}function getWidthUpdateFn(){return function(evt){if(this._super){this._super(evt);}var searchInput=this.searchInput;if(searchInput){searchInput.set("width",getSearchWidth.call(this));}};}mstrmojo.vi.ui.rw.selectors.SearchableCheckList=mstrmojo.declare(mstrmojo.vi.ui.rw.selectors.CheckList,null,{scriptClass:"mstrmojo.vi.ui.rw.selectors.SearchableCheckList",init:function init(props){this._super(props);$CSS.addWidgetCssClass(this,"searchable");},searchInput:null,_set_items:function _set_items(propName,propValue){this._super(propName,propValue);var searchInput=this.searchInput;if(searchInput){searchInput.set("visible",propValue.length>15);}},buildRendering:function buildRendering(){if(this.isHoriz&&this.itemWidthMode===0){this.renderOnScroll=false;}this._super();var searchInputNode=document.createElement("div"),placeholder=searchInputNode.appendChild(document.createElement("div")),scrollboxNode=this.scrollboxNode,items=this.items,id=this.id;searchInputNode.className="search";this.domNode.insertBefore(searchInputNode,scrollboxNode);var searchInput=this.searchInput;if(!searchInput){searchInput=this.searchInput=new mstrmojo.ui.SearchBox({width:getSearchWidth.call(this),searchTriggered:function(pattern){var me=mstrmojo.all[id];me.filterItems(pattern);me.hideTooltip();}});this.addDisposable(searchInput);}searchInput.visible=items&&items.length>15;searchInput.placeholder=placeholder;searchInput.render();},preBuildRendering:function preBuildRendering(){var ret=this._super();if(this.idx2ridx){delete this.idx2ridx;}return ret;},onorientationChange:getWidthUpdateFn(),onwidthChange:getWidthUpdateFn(),updateScrollbars:function updateScrollbars(){var scrollboxNode=this.scrollboxNode;if(this.hasRendered&&this.orientation==="v"){scrollboxNode.style.height=this.getScrollboxHeight()+"px";}this._super();},getScrollboxHeight:function getScrollboxHeight(){var searchInput=this.searchInput,searchDimension=$DOM.position(searchInput.domNode);if(searchInput.visible){return parseInt(this.height,10)-searchDimension.h-8;}return parseInt(this.height,10);},unrender:function unrender(ignoreDom){var searchInput=this.searchInput;if(searchInput){searchInput.unrender(ignoreDom);}return this._super(ignoreDom);},getItemProps:function getItemProp(item,idx){var prop=this._super(item,idx);prop.html=$STR.encodeHtmlString(prop.n).replace(new RegExp(DELIMITER_START,"ig"),"<em>").replace(new RegExp(DELIMITER_END,"ig"),"</em>");return prop;},getItemMarkup:function getItemMarkUp(item,idx){return this._super(item,idx).replace("@en@n","@html");},_getItemNode:function _getItemNode(idx){var ridx;if($HASH.isEmpty(this.idx2ridx)){ridx=idx;}else{if(this.idx2ridx[idx]!==undefined){ridx=this.idx2ridx[idx];}else{return null;}}return this._super(ridx);},updateTooltipConfig:function updateTooltipConfig(evt,win){var target=evt.target||$DOM.eventTarget(evt.hWin,evt.e),arrowType="vi-tooltip-C",posType=$TOOLTIP.POS_TOPLEFT;var itemNode=target.parentElement||target,checkBox=itemNode.children[1],position=$DOM.position(itemNode);var leftOffset=position.w,windowWidth=$DOM.windowDim().w;if(windowWidth<(position.x+leftOffset+300)){arrowType="vi-tooltip-D";leftOffset=-10;posType=$TOOLTIP.POS_TOPRIGHT;}this.richTooltip={content:this.getTooltipContent(evt),cssClass:"vi-regular "+arrowType,top:-4,left:leftOffset,refNode:checkBox||itemNode,posType:posType};},filterItems:function filterItems(){var markup=[];this.renderIndex=0;this.itemsContainerNode.innerHTML="";this.idx2ridx={};this.updateRenderableItems();this.renderableItems.forEach(function(item,idx){markup.push(this.itemRenderer.render(item,item._renderIdx,this));this.idx2ridx[item._renderIdx]=idx;},this);this.itemsContainerNode.innerHTML=markup.join("");this.updateScrollbars();},updateRenderableItems:function updateRenderableItems(){var lastNode=this.itemsContainerNode.lastChild,startIdx=lastNode&&parseInt(lastNode.getAttribute("idx"),10)+1,i=typeof startIdx==="number"?startIdx:0,max=this.items.length,size=this.renderOnScroll?this.renderBlockSize:max,item;this.renderableItems=[];while(i<max&&this.renderableItems.length<size){item=this.getFilteredItem(i);if(item){this.renderableItems.push(item);}i++;}},getFilteredItem:function getFilteredItem(idx){var item=this.items[idx],searchInput=this.searchInput;if(!searchInput||searchInput.isClear()){item._renderIdx=idx;return item;}else{var filterPattern=searchInput.text,filteredName=getItemTextForFilter(item,filterPattern),isFiltered=filterPattern&&(!filteredName||idx===this.allIdx);if(!isFiltered){var clonedItem=JSON.parse(JSON.stringify(item));clonedItem._renderIdx=idx;clonedItem.n=filteredName;item._renderIdx=idx;return clonedItem;}}return null;},onScrollEnd:function onScrollEnd(){var props={v:{dimension:"h",offsetDimension:"offsetHeight",scroll:"scrollTop",scrollDimension:"scrollHeight"},h:{dimension:"w",offsetDimension:"offsetWidth",scroll:"scrollLeft",scrollDimension:"scrollWidth"}},prop=props[this.isHoriz?"h":"v"];if(this.renderOnScroll){var node=this.scrollNode,max=(this.renderIndex+1)*this.renderBlockSize;if(max>=this.items.length){return ;}if(node[prop.offsetDimension]+Math.ceil(node[prop.scroll])>=node[prop.scrollDimension]){var markup=[],n=this.itemsContainerNode.childElementCount;this.renderIndex++;this.updateRenderableItems();this.renderableItems.forEach(function(item,idx){markup.push(this.itemRenderer.render(item,item._renderIdx,this));if(this.idx2ridx){this.idx2ridx[item._renderIdx]=n+idx;}},this);this.itemsContainerNode.innerHTML+=markup.join("");}}},renderOnScroll:true,renderIndex:0,renderBlockSize:150});}());