(function(){mstrmojo.requiresCls("mstrmojo.dom","mstrmojo.array","mstrmojo.Box","mstrmojo.VBox","mstrmojo.Popup","mstrmojo.RadioList","mstrmojo.CheckBox","mstrmojo.gmaps.MapEnums");var $MOJO=mstrmojo,$ARR=$MOJO.array,$GMAPS=$MOJO.gmaps,$EnumToolbarState=$GMAPS.EnumToolbarState;mstrmojo.gmaps.MapLayerControlList=mstrmojo.declare(mstrmojo.Popup,[mstrmojo._HasPopup],{scriptClass:"mstrmojo.gmaps.MapLayerControlList",cssClass:"layerSelectBox",sourceToolbar:null,maxHeight:null,alias:"layerSelectBox",slot:"popupNode",locksHover:true,autoCloses:true,layerCount:null,layersRendered:null,onOpen:function onOpen(){var sourceToolbar=this.sourceToolbar,layerSelectVBox=this.layerCtrlContentWrapper.layerContentBox.layerSelectVBox,allLayerBox=layerSelectVBox.allLayers,topSpan;if(!sourceToolbar){return ;}sourceToolbar.set("state",$EnumToolbarState.LAYERS_SELECT);this.set("selected",true);if(allLayerBox){topSpan=allLayerBox;}else{topSpan=layerSelectVBox.children[0]&&layerSelectVBox.children[0].children[0];}if(topSpan&&topSpan.domNode){topSpan.domNode.style["margin-top"]="4px";}this.addEventsForLayerCheckbox();},onClose:function onClose(){this.set("selected",false);this.sourceToolbar&&this.sourceToolbar.set("state",$EnumToolbarState.NORMAL);},addEventsForLayerCheckbox:function addEventsForLayerCheckbox(){var layerCtrlItems=this.domNode&&this.domNode.getElementsByClassName("gridLayerNames"),item,label,i,il;for(i=0,il=layerCtrlItems.length;i<il;i++){item=layerCtrlItems[i];label=item.childNodes&&item.childNodes[1];if(label){label.removeAttribute("for");label.onclick=function(){var input=this.parentNode.childNodes[0];input&&input.click();};}}},children:[{alias:"layerCtrlContentWrapper",scriptClass:"mstrmojo.Box",cssClass:"layerCtrlContentWrapper",children:[{alias:"layerContentBox",scriptClass:"mstrmojo.Box",cssClass:"layerContentBox",children:[{alias:"layerSelectVBox",scriptClass:"mstrmojo.VBox",cssClass:"layerSelectVBox",cssText:"",postCreate:function(){var layerCtrl=this.parent&&this.parent.parent&&this.parent.parent.parent;layerCtrl&&layerCtrl.createLayerListContent(this);}}]}]}],createLayerListContent:function createLayerListContent(parent){var layerItems=this.sourceToolbar&&this.sourceToolbar.getLayerCtrlList(),children=[];if(!layerItems||!parent){return ;}this.layerCount=layerItems.length;this.layersRendered=0;this.addLayerItemsNode(children,layerItems);this.addAllCheckBox(children,layerItems);parent.set("children",children);},addAllCheckBox:function addAllCheckBox(children,layerItems){var allCheckBox;if(layerItems.length>1){allCheckBox=this._createAllCheckBox(layerItems);children.splice(0,0,allCheckBox);allCheckBox.set("checked",(this.layersRendered===this.layerCount));}},_createAllCheckBox:function _createAllCheckBox(layerItems){if(!$ARR.isArray(layerItems)){return ;}var me=this;return mstrmojo.insert({scriptClass:"mstrmojo.CheckBox",cssClass:"allLayer gridLayerNames",label:mstrmojo.desc(10371,"All Layers"),alias:"allLayers",cssDisplay:"block",align:"left",postCreate:function(){this.set("checked",true);},onclick:function(){var layerSelectVBox=this.parent,sourceToolbar=me.sourceToolbar,undoConfig={},redoConfig={},layer,layerKey,layerVBox,i,il;if(!layerSelectVBox||!sourceToolbar){return ;}for(i=0,il=layerItems.length;i<il;i++){if(!layerItems[i]){continue;}layerKey=layerItems[i].id;layerVBox=layerSelectVBox["layersbox"+layerKey];layer=layerVBox&&layerVBox.children&&layerVBox.children[0];if(layer&&this.checked!=layer.checked){undoConfig[layerKey]={isVisible:layer.checked};redoConfig[layerKey]={isVisible:this.checked};layer.processMe(this.checked,true);}}sourceToolbar.submitLayerVisibleChanges(undoConfig,redoConfig);}});},addLayerItemsNode:function addLayerItemsNode(children,layerItems){if(!$ARR.isArray(children)||!$ARR.isArray(layerItems)){return ;}var layerItem,gridMetricSel,i,il;for(i=0,il=layerItems.length;i<il;i++){layerItem=layerItems[i];if(layerItem){gridMetricSel=this._createSingleLayerNode(layerItem);children.push(gridMetricSel);}}},_createSingleLayerNode:function _createSingleLayerNode(layerItem){if(!layerItem){return ;}var me=this,layerKey=layerItem.id,layerName=layerItem.n,metrics=layerItem.metrics,isVisible=layerItem.isVisible;this.layersRendered+=(isVisible)?1:0;return mstrmojo.insert({scriptClass:"mstrmojo.VBox",cssClass:"layerSelectVBox",alias:"layersbox"+layerKey,halign:"left",cssText:"margin-top:3px;margin-bottom:5px;width:100%;",children:[me._createSingleLayerCheckbox(layerName,layerKey,isVisible),me._createMetricRadioList(layerKey,metrics,isVisible)]});},_createSingleLayerCheckbox:function _createSingleLayerCheckbox(layerName,layerKey,isChecked){var me=this;return{scriptClass:"mstrmojo.CheckBox",cssClass:"gridLayerNames",label:layerName,tooltip:layerName,align:"left",cssDisplay:"block",layerKey:layerKey,checked:isChecked,processMe:function processMe(checked,noUpdate){var sourceToolbar=me.sourceToolbar,layerKey=this.layerKey;if(!sourceToolbar){return ;}me.layersRendered+=(checked?1:-1);if(!noUpdate){sourceToolbar.setLayerVisibility(layerKey,checked);}this.set("checked",checked);this.parent["metricSelector_"+layerKey]&&this.parent["metricSelector_"+layerKey].set("enabled",checked);},onclick:function(evt){this.processMe(this.checked);if(this.parent.parent.allLayers){this.parent.parent.allLayers.set("checked",(me.layersRendered==me.layerCount));}}};},_createMetricRadioList:function _createMetricRadioList(layerKey,metrics,enabled){if(layerKey==undefined||!$ARR.isArray(metrics)||metrics.length<1){return ;}var me=this;return{scriptClass:"mstrmojo.RadioList",alias:"metricSelector_"+layerKey,layerKey:layerKey,cssClass:"layerMetrics",itemTitleField:"n",items:metrics,enabled:enabled,postCreate:function postCreate(evt){var sourceToolbar=me.sourceToolbar;if(sourceToolbar){this.selectedIndex=sourceToolbar.getLayerSelectedMetricIdx(this.layerKey);}},postselectionChange:function(evt){var item,items=this.items,sourceToolbar=me.sourceToolbar;if(items&&sourceToolbar&&this.parent.children[0].checked){item=items[evt.added[0]];if(item.v!=-1){sourceToolbar.onselectedMetricIdxChange(item.layerKey,evt.added[0],item.id);}}}};},getDomStyleVal:function getDomStyleVal(mapCssObj,property){var propertyValue;if(mapCssObj&&property){if(!window.getComputedStyle){propertyValue=parseInt(mapCssObj[property],10);}else{propertyValue=parseInt(mapCssObj.getPropertyValue(property),10);}}return isNaN(propertyValue)?0:propertyValue;},destroy:function destroy(ignoreDom){var pr=this.popupRef;if(this.popupToBody&&pr.hasRendered){pr.unrender(false);}delete this.sourceToolbar;this._super(ignoreDom);}});}());