(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.array");mstrmojo.vi.ui.rw.SelectionType={EMPTY:"empty",ATTS:"att",METRICS:"metric",COL_HEADERS:"col-headers",ROW_HEADERS:"row-headers",METRIC_VALUES:"metric-values"};var getCacheKey=function(obj){var mid=(mstrApp&&mstrApp.docModelData&&mstrApp.docModelData.mid)||"",key=obj.k||obj.key;return key+"-"+mid;},selectionCache={},selectionCachePrev={},$H=mstrmojo.hash,$A=mstrmojo.array,_getSelectionHash=function(candidate){var attIds=$H.keyarray(candidate).sort(),hashes=[],attValIds;$A.forEach(attIds,function(attId){attValIds=[];$A.forEach(candidate[attId],function(attVal){attValIds.push(this.model.getNormalizedFormElementId(attVal.id));},this);hashes.push(attId+"-"+attValIds.sort().join("@"));},this);return hashes.join("#");},addSelection=function(candidate){var hash=_getSelectionHash.call(this,candidate);if(!this._viSelections[hash]){this._viSelections[hash]=candidate;if(mstrApp&&mstrApp.isInVFConfigMode){return ;}selectionCache[getCacheKey(this)]={_selectionType:this.getSelectionType(),_viSelections:this.getSelectionHash()};}},addContextMenuSelection=function(candidate){var hash=_getSelectionHash.call(this,candidate);if(!this._viContextMenuSelections[hash]){this._viContextMenuSelections[hash]=candidate;}},removeSelection=function(candidate){var hash=_getSelectionHash.call(this,candidate),res=this._viSelections[hash];if(res){delete this._viSelections[hash];if(mstrApp&&mstrApp.isInVFConfigMode){return ;}selectionCache[getCacheKey(this)]={_selectionType:this.getSelectionType(),_viSelections:this.getSelectionHash()};}return res;},removeContextMenuSelection=function(candidate){var hash=_getSelectionHash.call(this,candidate),res=this._viContextMenuSelections[hash];if(res){delete this._viContextMenuSelections[hash];}return res;},cachePrevSelectionInfo=function(){var cacheKey=getCacheKey(this);selectionCachePrev=selectionCachePrev||{};if(selectionCache[cacheKey]){selectionCachePrev[cacheKey]=$H.clone(selectionCache[cacheKey]);}},getNormalSelection=function(attId,vId,value,unitIndex,ordinal,axis,forms){var s={};s[attId]=[{id:vId,n:value,fm:forms,ui:unitIndex,o:ordinal,axis:axis}];return s;},st=mstrmojo.vi.ui.rw.SelectionType;mstrmojo.vi.ui.rw._HasVisSelections=mstrmojo.provide("mstrmojo.vi.ui.rw._HasVisSelections",{_mixinName:"mstrmojo.vi.ui.rw._HasVisSelections",init:function(props){if(this._super){this._super(props);}this._viSelections={};},update:function update(node){var continueUpdate=true;if(this._super){continueUpdate=this._super(node);}if(!mstrApp.isInVFConfigMode){$H.copy(selectionCache[getCacheKey(this)],this);}if(!this.updateForInteractiveMode){cachePrevSelectionInfo.call(this);}return continueUpdate;},onSelectionChange:function onSelectionChange(data){if(this._super){this._super(data);}},_viSelections:{},_viContextMenuSelections:{},_selectionType:st.EMPTY,_contextMenuSelectionType:st.EMPTY,_cellSelections:[],getSelectionType:function(){return this._selectionType;},getContextMenuSelectionType:function(){return this._contextMenuSelectionType;},isSingleAttrSelection:function(){var aid=null,selections;if(this.getSelectionType()===st.ATTS){selections=this.getSelections();if(selections.length>1){return !selections.some(function(sel){if(!aid){aid=sel[0].tid;return false;}return aid!=sel[0].tid;},this);}return true;}return false;},isSingleContextMenuAttrSelection:function(){var aid=null,selections;if(this.getContextMenuSelectionType()===st.ATTS){selections=this.getContextMenuSelections();if(selections.length>1){return !selections.some(function(sel){if(!aid){aid=sel[0].tid;return false;}return aid!=sel[0].tid;},this);}return true;}return false;},isSingleSelection:function(){return(this._viSelections&&$H.keyarray(this._viSelections).length===1);},isSingleContextMenuSelection:function(){return(this._viContextMenuSelections&&$H.keyarray(this._viContextMenuSelections).length===1);},getSelectionSize:function getSelectionSize(){return(this._viSelections&&$H.keyarray(this._viSelections).length)||0;},getCxtMnuSelectionSize:function getCxtMnuSelectionSize(){return(this._viContextMenuSelections&&$H.keyarray(this._viContextMenuSelections).length)||0;},getSelectionHash:function getSelectionHash(){return this._viSelections;},getContextMenuSelectionHash:function getContextMenuSelectionHash(){return this._viContextMenuSelections;},getSelectionCache:function getSelectionCache(){return selectionCache[getCacheKey(this)];},setSelectionCache:function setSelectionCache(selectionInfo){selectionCache[getCacheKey(this)]=selectionInfo;},getPrevSelectionInfo:function getPrevSelectionInfo(){return selectionCachePrev[getCacheKey(this)];},getSelections:function getSelections(){var res=[],node;$H.forEach(this.getSelectionHash(),function(sel){node=[];res.push(node);$H.forEach(sel,function(ee,aid){$A.forEach(ee,function(e){node.push({tid:aid,eid:e.id,v:e.n,level:e.level});});});});return res;},getContextMenuSelections:function getContextMenuSelections(){var res=[],node;$H.forEach(this.getContextMenuSelectionHash(),function(sel){node=[];res.push(node);$H.forEach(sel,function(ee,aid){$A.forEach(ee,function(e){node.push({tid:aid,eid:e.id,fm:e.fm,v:e.n,axis:e.axis,o:e.o,ui:e.ui});});});});return res;},isMetricValueSelected:function isSelected(sel){return !!this._viSelections[_getSelectionHash.call(this,sel)];},isAttSelected:function isAttSelected(attId,elementId){return this.isMetricValueSelected(getNormalSelection(attId,elementId));},addAttributeSelection:function addAttributeSelection(attId,elementId,value){if(this._selectionType!==st.ATTS){this.clearSelections();this._selectionType=st.ATTS;}var p=getNormalSelection.call(this,attId,elementId,value);addSelection.call(this,p);return p[attId];},addContextMenuAttributeSelection:function addContextMenuAttributeSelection(attId,elementId,value,unitIndex,ordinal,axis,forms){if(this._contextMenuSelectionType!==st.ATTS){this.clearCxtMnuSelection();this._contextMenuSelectionType=st.ATTS;}var p=getNormalSelection.call(this,attId,elementId,value,unitIndex,ordinal,axis,forms);addContextMenuSelection.call(this,p);return p[attId];},removeAttributeSelection:function removeAttributeSelection(attId,elementId){return removeSelection.call(this,getNormalSelection.call(this,attId,elementId));},removeContextMenuAttributeSelection:function removeContextMenuAttributeSelection(attId,elementId){return removeContextMenuSelection.call(this,getNormalSelection.call(this,attId,elementId));},addMetricValueSelection:function addMetricValueSelection(candidate){if(this._selectionType!==st.METRICS){this.clearSelections();this._selectionType=st.METRICS;}addSelection.call(this,candidate);},addContextMenuMetricValueSelection:function addMetricValueSelection(candidate){if(this._contextMenuSelectionType!==st.METRICS){this.clearCxtMnuSelection();this._contextMenuSelectionType=st.METRICS;}addContextMenuSelection.call(this,candidate);},addAttrOrMetricCellSelection:function addAttrOrMetricCellSelection(candidate,targetId,isAttr){this._cellSelections.push({parentElementIds:candidate,target:{selectionType:isAttr?st.ATTS:st.METRICS,id:targetId}});},getCellSelections:function getCellSelections(){var that=this;that.clearCellSelections();var getParentAttributes=function(isAttr,cell){var parentAttributes=[];if(isAttr){while(cell.hasOwnProperty("_p")){parentAttributes.push(cell._p._e.id);cell=cell._p;}}else{var linkedAtts=that.model.getCellDataUnion(cell);$A.forEach(linkedAtts,function(attr){parentAttributes.push(attr.eid);});}return parentAttributes;};$A.forEach(that.highlights,function(sel){var cell=that.getCellForNode(sel),isAttribute=!cell.hasOwnProperty("mix")&&cell._e&&!cell.fi,candidate=getParentAttributes(isAttribute,cell);if(isAttribute){var elId=cell._e.id;that.addAttrOrMetricCellSelection(candidate,elId,true);}else{var metricId=cell._tp._e.oid;that.addAttrOrMetricCellSelection(candidate,metricId,false);}});return this._cellSelections;},removeMetricValueSelection:function removeMetricValueSelection(candidate){return removeSelection.call(this,candidate);},removeContextMenuMetricValueSelection:function removeContextMenuMetricValueSelection(candidate){return removeContextMenuSelection.call(this,candidate);},clearSelections:function clearSelections(){if(this._super){this._super();}this._viContextMenuSelections={};this._contextMenuSelectionType=st.EMPTY;this._viSelections={};this._selectionType=st.EMPTY;if(typeof this.clearSelectedGraphicInfo==="function"){this.clearSelectedGraphicInfo();}},clearCxtMnuSelection:function clearCxtMnuSelection(){if(this._super){this._super();}this._viContextMenuSelections={};this._contextMenuSelectionType=st.EMPTY;},clearCellSelections:function clearCellSelections(){this._cellSelections=[];},clearSelectionsCache:function clearSelectionsCache(){selectionCache={};},clearUnitSelections:function clearSelections(unitId){if(this._super){this._super();}var newSelections={};$H.forEach(this._viSelections,function(sel,k){if($H.keyarray(sel)[0]!==unitId){newSelections[k]=sel;}});this._viSelections=newSelections;},clearAllSelectionsAndHighlight:function clearAllSelectionsAndHighlight(){this.clearSelections(true);this.endSelections();},endSelections:function endSelections(){if(mstrApp&&mstrApp.isInVFConfigMode){return ;}selectionCache[getCacheKey(this)]={_selectionType:this.getSelectionType(),_viSelections:this.getSelectionHash()};this.raiseGraphicsSelectedEvent(this);if(this.isInFilterPanel()&&mstrApp&&mstrApp.isDossier){this.raiseGraphicsSelectionChangeEvent();return ;}this.onSelectionChange(this.getSelectionHash());},isInFilterPanel:function isInFilterPanel(){var nodeDefn=this.node&&this.node.defn;return nodeDefn.iifp;},addSelectionsFromExpression:function addSelectionsFromExpression(exp){this.clearSelections();this._selectionType=exp.type;var that=this,fill=function(node){var OR=20,AND=19,qual=function(n){return n.nds.length===1?OR:n.fn;},isLastNode=function(n){return parseInt(n.et,10)===5||parseInt(qual(n),10)===AND;},addToAttributes=function(node){$A.forEach(node.es,function(elem){that.addAttributeSelection(node.a.did,elem.v,elem.n);});},addToMetrics=function(node){var candidate={},addElements=function(n){$A.forEach(n.es,function(elem){$H.copy(getNormalSelection.call(that,n.a.did,elem.v,elem.n),candidate);});};if(node.nds){$A.forEach(node.nds,addElements);}else{if(node.es){addElements(node);}}that.addMetricValueSelection(candidate);};if(isLastNode(node)){node={nds:[node]};}$A.forEach(node.nds,function(n){if(isLastNode(n)){if(exp.type===st.ATTS){addToAttributes(n);}else{addToMetrics(n);}}else{fill(n);}});};fill(exp.data);},raiseGraphicsSelectedEvent:function raiseGraphicsSelectedEvent(){if(window.mstrApp&&window.mstrApp.isEmbedded){var me=this,model=me.model,data=model&&model.data,vizKey=data&&data.k,gts=data&&data.gts,row=gts&&gts.row,col=gts&&gts.col,templateUnits=$A.ensureArray(row).concat(col||[]),getAttrNameFromID=function(attrID){var attrName;$A.forEach(templateUnits,function(unit){if(unit&&unit.id===attrID){attrName=unit.n;return false;}});return attrName;},selectedGraphics=[],viSelections=this.getSelectionHash();$H.forEach(viSelections,function(sel){var selectedGraphic=[];$H.forEach(sel,function(attrElementList,attrID){var attrName=getAttrNameFromID(attrID);$A.forEach(attrElementList,function(attrElement){selectedGraphic.push({n:attrName,nid:attrID,v:attrElement.n,vid:attrElement.id});});});selectedGraphics.push(selectedGraphic);});mstrApp.raiseEvent({name:"graphicsSelected",value:{graphics:selectedGraphics,vizKey:vizKey}});}},raiseGraphicsSelectionChangeEvent:function raiseGraphicsSelectionChangeEvent(){if(mstrApp&&(typeof mstrApp.raiseEvent==="function")){mstrApp.raiseEvent({name:"graphicsSelectionChange",value:{selections:selectionCache[getCacheKey(this)],vizKey:this.k}});}}});mstrmojo.vi.ui.rw._HasVisSelections.VisSelectionType=null;mstrmojo.vi.ui.rw._HasVisSelections.clearAllSelectionsCache=function clearCache(){selectionCache={};selectionCachePrev={};};}());