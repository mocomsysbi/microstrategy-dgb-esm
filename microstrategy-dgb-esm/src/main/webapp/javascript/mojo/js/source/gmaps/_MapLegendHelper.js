(function(){mstrmojo.requiresCls("mstrmojo.num","mstrmojo.dom","mstrmojo.hash","mstrmojo.css","mstrmojo.array","mstrmojo.VisUtility","mstrmojo.gm.GMEnums","mstrmojo.VisEnum","mstrmojo.gm.GMLegend","mstrmojo.ui.menus.MenuConfig","mstrmojo.gm.EnumLegendSlot","mstrmojo.gm.GMUtility","mstrmojo.gmaps.MapUtils","mstrmojo.chart.enums.EnumFontStyle","mstrmojo.vi.viz.MapHelper","mstrmojo.gmaps.MapEnums","mstrmojo.elementHelper");var $ARR=mstrmojo.array,$HASH=mstrmojo.hash,$NUM=mstrmojo.num,$VIS_ENUM=mstrmojo.VisEnum,$GM=mstrmojo.gm,$GMU=$GM.GMUtility,$MU=mstrmojo.gmaps.MapUtils,$CSS=mstrmojo.css,PRP_LEGEND_SLOT=$GM.EnumLegendSlot,$EnumPropertyType=mstrmojo.gmaps.EnumPropertyType,$LEGEND=$GM.GMLegend,ENUM_FONT_SYLTE=mstrmojo.chart.enums.EnumFontStyle,ENUM_LEGEND_MODE=$VIS_ENUM.EnumLegendMode,ENUM_SINGLE_LEGEND_MODE=$VIS_ENUM.EnumSingleLegendMode,$VU=mstrmojo.VisUtility,MAPS_PROPERTIES=$VIS_ENUM.MAPS_PROPERTIES,LEGEND_PROPERTY=$VIS_ENUM.LegendPropertyTag,LEGEND_DATA_TYPE=$VIS_ENUM.GMLegendDataType,LEGEND_FORMATTING_TYPE=$VIS_ENUM.GMLegendFormatingPropertyTag;var LegendPropDefault={lgdBgFillClr:[15461355,1710618],lgdBgFillStyle:[0,0],lgdBgFillEff:[1,1],lgdBgFillTrans:[100,100],lgdFntSz:["11px","11px"],lgdFntFml:["Verdana","Verdana"],lgdFntStyle:[0,0],lgdFntClr:[6710886,16777215],lgdBdrShw:[false,false],lgdBdrClr:[11579568,5855577],lgdBdrThk:["1px","1px"],lgdBdrLnStyle:[0,0],lm:[0,0],LegendPosition:[2,2],lwr:[1,1]};function getFormatString(idx){var data=this.data,nf=data.nf||[],len=nf.length,nfs;if(idx>=0&&idx<len){nfs=$VU.getNumberFormat(data,idx);return nfs.replace(/\'/g,'"');}return"";}mstrmojo.gmaps._MapLegendHelper=mstrmojo.provide("mstrmojo.gmaps._MapLegendHelper",{_mixinName:"mstrmojo.gmaps._MapLegendHelper",processFontStyle:function(obj,fs){obj.fontWeight=(fs&ENUM_FONT_SYLTE.FS_BOLD?"bold":"normal");obj.fontStyle=(fs&ENUM_FONT_SYLTE.FS_ITALIC?"italic":"normal");if((fs&ENUM_FONT_SYLTE.FS_STRIKETHROUGH)&&(fs&ENUM_FONT_SYLTE.FS_UNDERLINE)){obj.textDecoration="line-through underline";}else{if(fs&ENUM_FONT_SYLTE.FS_STRIKETHROUGH){obj.textDecoration="line-through";}else{if(fs&ENUM_FONT_SYLTE.FS_UNDERLINE){obj.textDecoration="underline";}}}},sliceDefaultsLegendProp:function(idx){var rtn={};$HASH.keyarray(LegendPropDefault).forEach(function(prop){rtn[prop]=LegendPropDefault[prop][idx];});return rtn;},getLegendProperty:function(propName){var itemValue,props=this.map.getProperties(this.key);switch(propName){case MAPS_PROPERTIES.SHOW_LEGEND:itemValue=(!!props.ls&&props.ls.toString()==="true")?true:false;break;case LEGEND_PROPERTY.SCALE_LEGEND_WIDTH:itemValue=parseFloat(props.lwr);break;}if(itemValue===undefined||((typeof itemValue)==="number"&&isNaN(itemValue))){itemValue=this.defaultsLegendPop[propName];}return itemValue;},getLegendSize:function(){return{width:this.legendW,height:this.legendH,cutBy:this.legendCutBy};},updateSingleLegendSize:function(newValue){if(newValue===ENUM_SINGLE_LEGEND_MODE.COLLAPSE){this.renderCollapseMode();}else{this.renderExpandMode();}},renderCollapseMode:function(){this.legend.cbContainer.style.display="none";this.legend.sb1Container.style.display="none";var cbConHeight=this.legend.cbContainer.style.height?parseInt(this.legend.cbContainer.style.height,10):0,sb1ConHeight=this.legend.sb1Container.style.height?parseInt(this.legend.sb1Container.style.height,10):0,legendHeight=parseInt(this.legend.domNode.style.height,10);this.legend.domNode.style.height=legendHeight-cbConHeight-sb1ConHeight+"px";this.legend.collapsed=true;$CSS.removeClass(this.legend.triBtn,"map-legend-col-button");$CSS.addClass(this.legend.triBtn,"gm-legend-tri-button");},renderExpandMode:function(){this.legend.cbContainer.style.display="block";if(this.map.hasSizeBy(this.key)){this.legend.sb1Container.style.display="block";}var cbConHeight=this.legend.cbContainer.style.height?parseInt(this.legend.cbContainer.style.height,10):0,sb1ConHeight=this.legend.sb1Container.style.height?parseInt(this.legend.sb1Container.style.height,10):0,legendHeight=parseInt(this.legend.domNode.style.height,10);this.legend.domNode.style.height=legendHeight+cbConHeight+sb1ConHeight+"px";this.legend.collapsed=false;$CSS.removeClass(this.legend.triBtn,"gm-legend-tri-button");$CSS.addClass(this.legend.triBtn,"map-legend-col-button");},hEvalSize4Legend:function(){var rtn,p=this.map,cData=this.colorByInfo,sData=this.sizeByInfo,width=p.getWidth(),height=p.getHeight();if(this.getLegendProperty(MAPS_PROPERTIES.SHOW_LEGEND)===false){this.legendW=this.legendH=0;}else{rtn=$LEGEND.getLegendSize([{dataType:LEGEND_DATA_TYPE.COLOR_BY,dataObj:cData},{dataType:LEGEND_DATA_TYPE.SIZE_BY,dataObj:sData}],this.getLegendProperty(LEGEND_PROPERTY.SCALE_LEGEND_WIDTH),width,height,this.legendProperty);if(parseInt(p.getPropertyValue(LEGEND_PROPERTY.LEGEND_MODE,this.key,false))===ENUM_LEGEND_MODE.MINIMIZED||rtn.autoCollapse){rtn=$LEGEND.getLegendSize4MinMode(cData,height);this.legendCutBy=undefined;}this.legendCutBy=rtn.cutBy;this.legendW=rtn.width;this.legendH=rtn.height;}},destroyLegend:function(){var lgd=this.legend;if(lgd&&lgd.destroy instanceof Function){lgd.destroy();}delete this.legend;},resizeLegend:function(delta){var rtn,visMapBase=this.map,width=visMapBase.getWidth(),height=visMapBase.getHeight(),factor=delta/this.legendW+1,scale=this.getLegendProperty(LEGEND_PROPERTY.SCALE_LEGEND_WIDTH);if(this.legend){scale*=factor;this.legendW+=delta;rtn=$LEGEND.getLegendSize([{dataType:LEGEND_DATA_TYPE.COLOR_BY,dataObj:this.colorByInfo},{dataType:LEGEND_DATA_TYPE.SIZE_BY,dataObj:this.sizeByInfo}],scale,width,height,this.legendProperty,this.legendW);this.legendH=rtn.height;this.legendCutBy=rtn.cutBy;}},updateLegend:function(){if(this.legend){var legend=this.legend,visMapBase=this.map,lgdCon=visMapBase.legendCon,legendSize=this.getLegendSize(),lph=legend.domNode,isMinimal=parseInt(visMapBase.getPropertyValue(LEGEND_PROPERTY.LEGEND_MODE,this.key,false))===ENUM_LEGEND_MODE.MINIMIZED,layerName=this.getLayerName();lph.style.width=legendSize.width+"px";lph.style.height=legendSize.height+"px";legend.width=legendSize.width;legend.height=legendSize.height;legend.cutBy=legendSize.cutBy;visMapBase.updateLegendConWidth();lgdCon.calculateLegendDockedPositions(visMapBase.getWidth(),visMapBase.getHeight());legend.feedData([{dataType:LEGEND_DATA_TYPE.COLOR_BY,dataObj:this.colorByInfo},{dataType:LEGEND_DATA_TYPE.SIZE_BY,dataObj:this.sizeByInfo}],isMinimal);if(isMinimal){$CSS.removeClass(legend.triBtn,"gm-legend-tri-button-collapsed");legend.cbContainer.style.top="0px";legend.domNode.style.height=parseInt(this.legend.domNode.style.height,10)-16+"px";legend.lgdName.innerHTML="";}else{$CSS.removeClass(legend.triBtn,"gm-legend-tri-button");$CSS.addClass(legend.triBtn,"map-legend-col-button");legend.lgdName.innerHTML=layerName;}legend.updateAfterResize();if(lgdCon){lgdCon.updateScrollbars();lgdCon.addScrollNodeProperties();}}},updateSingleLegendAlignClass:function(){var dockPosition=this.map.getLegendConDockedPosition(),slot=dockPosition&&dockPosition.pos,isRight=(slot===PRP_LEGEND_SLOT.RIGHT_MIDDLE||slot===PRP_LEGEND_SLOT.RIGHT_TOP||slot===PRP_LEGEND_SLOT.RIGHT_BOTTOM||slot===PRP_LEGEND_SLOT.RIGHT),domLegend=this.legend.domLegend,domNode=this.legend.domNode;if(isRight){$CSS.removeClass(domLegend,"gm-align-left");$CSS.addClass(domLegend,"gm-align-right");$CSS.toggleClass(domLegend,"gm-legend-alignRight",true);$CSS.toggleClass(domLegend,"gm-legend-alignLeft",false);$CSS.toggleClass(domNode,"gm-legend-alignRight",true);$CSS.toggleClass(domNode,"gm-legend-alignLeft",false);}else{$CSS.removeClass(domLegend,"gm-align-right");$CSS.addClass(domLegend,"gm-align-left");$CSS.toggleClass(domLegend,"gm-legend-alignRight",false);$CSS.toggleClass(domLegend,"gm-legend-alignLeft",true);$CSS.toggleClass(domNode,"gm-legend-alignRight",false);$CSS.toggleClass(domNode,"gm-legend-alignLeft",true);}},updateDomNodeForSingleLegend:function(legend){var resizer=legend.splitter,resizeRect=legend.resizeRect;if(resizer){legend.domLegend.removeChild(resizer);}if(resizeRect){legend.domLegend.removeChild(resizeRect);}legend.dropZoneNode.style.removeProperty("top");legend.dropZoneNode.style.removeProperty("left");legend.dropZoneNode.style.position="relative";},attachLegendListeners:function(){var me=this,id=me.id,legend=me.legend;if(legend){me.legendClickListener=legend.attachEventListener("gm-legend-clicked",id,function(evt){if(evt.action==="minimize"||evt.action==="restore"){if(!legend.collapsed){me.map.writeProperties($EnumPropertyType.collapseLegend,ENUM_SINGLE_LEGEND_MODE.COLLAPSE,me.key);}else{me.map.writeProperties($EnumPropertyType.collapseLegend,ENUM_SINGLE_LEGEND_MODE.RESTORE,me.key);}}});}},initLegendProperties:function(){var isLightTheme=(mstrApp.getThemeClassName&&mstrApp.getThemeClassName().indexOf("light")>=0),me=this,LEGEND=me.legendProperty={};me.defaultsLegendPop=me.sliceDefaultsLegendProp(isLightTheme?0:1);me.colorByInfo=me.isColorByAttr?me.legendColorByElements:me.generateItemColorByInfo();me.sizeByInfo=me.generateItemSizeByInfo();LEGEND.fontFamily=me.getLegendProperty(LEGEND_FORMATTING_TYPE.LEGEND_FONT_FAMILY);LEGEND.fontSize=me.getLegendProperty(LEGEND_FORMATTING_TYPE.LEGEND_FONT_SIZE);me.processFontStyle(LEGEND,me.getLegendProperty(LEGEND_FORMATTING_TYPE.LEGEND_FONT_STYLE));LEGEND.color=$GMU.decodeColor(me.getLegendProperty(LEGEND_FORMATTING_TYPE.LEGEND_FONT_COLOR));LEGEND.backgroundColor=$GMU.decodeColor(me.getLegendProperty(LEGEND_FORMATTING_TYPE.LEGEND_BG_COLOR));LEGEND.opacity=me.getLegendProperty(LEGEND_FORMATTING_TYPE.LEGEND_BG_FILL_TRANSPARENCY)/100;if(this.getLegendProperty(LEGEND_FORMATTING_TYPE.LEGEND_BORDER_SHOW)){LEGEND.borderWidth=$VU.translateLineStyle(me.getLegendProperty(LEGEND_FORMATTING_TYPE.LEGEND_BORDER_LINE_STYLE)).width;LEGEND.borderStyle=$VU.translateLineStyle(me.getLegendProperty(LEGEND_FORMATTING_TYPE.LEGEND_BORDER_LINE_STYLE)).style;LEGEND.borderColor=$GMU.decodeColor(me.getLegendProperty(LEGEND_FORMATTING_TYPE.LEGEND_BORDER_COLOR));}},generateItemColorByInfo:function(){var colorById=this.dropZones&&this.dropZones.colorBy,data=this.data,gsi=data&&data.gsi,mx=gsi&&gsi.mx,thresholds=gsi&&gsi.thresholds;if(colorById&&thresholds){var colorByMetric,mxIdx;$ARR.forEach(mx,function(obj,i){if(obj.did===colorById){colorByMetric=obj;mxIdx=i;}});if(colorByMetric){var colorByThresholds=thresholds[colorById],fstThreshold=colorByThresholds&&colorByThresholds[0],isImageType=function(){return fstThreshold.rtp===4;};if(fstThreshold&&(isImageType()||(fstThreshold.fmt&&fstThreshold.fmt.bc))){var rankMode=$VU.getRankMode(colorByThresholds),fs=$VU.getColorByFormatStr(getFormatString.call(this,mxIdx),rankMode),colorByItems=$VU.getColorByItems(colorByThresholds,rankMode,colorByMetric.max,colorByMetric.min,colorByMetric.cnt,fs,this.getLegendProperty(LEGEND_FORMATTING_TYPE.LEGEND_BG_COLOR));if(isImageType()){$ARR.forEach(colorByItems,function(item,i){if(mstrApp.isDossier&&colorByThresholds[i]){colorByThresholds[i].rtxt=$MU.convertImageUrl(colorByThresholds[i].rtxt);}item.image="url("+colorByThresholds[i].rtxt+")";});}return{item:$VU.getColorByTitle(colorByMetric.n,rankMode),elements:colorByItems};}}}},generateItemSizeByInfo:function(){var sizeById=this.dropZones&&this.dropZones.sizeBy,data=this.data,gsi=data&&data.gsi,mx=gsi&&gsi.mx,thresholds=gsi&&gsi.thresholds;if(sizeById&&thresholds){var sizeByMetric,mxIdx;$ARR.forEach(mx,function(obj,i){if(obj.did===sizeById){sizeByMetric=obj;mxIdx=i;}});if(sizeByMetric){var sfs=getFormatString.call(this,mxIdx),sizeByValueStrings=[],start=sizeByMetric.min,end=sizeByMetric.max,delta=(end-start)/4,i;for(i=0;i<5;++i){sizeByValueStrings.push($NUM.formatByMask(sfs,end-i*delta));}var res={item:sizeByMetric.n},elements;if(sizeByValueStrings.length>1){elements=res.elements=[];$ARR.forEach(sizeByValueStrings,function(szByValue){elements.push({sign:"<",v:szByValue});});if(elements.length===5){elements[0].sign="=";elements[4].sign="=";}res.caseFlag=0;}else{if(sizeByValueStrings.length===1){res.elements=[{diameter:12,shape:"circle",sign:"=",v:sizeByValueStrings[0]}];res.caseFlag=2;}}return res;}}}});}());