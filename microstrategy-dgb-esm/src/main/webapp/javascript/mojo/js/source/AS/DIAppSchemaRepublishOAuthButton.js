(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.AS.DIAppSchemaService");mstrmojo.requiresDescs(9935,15600);var $DI_HELP=mstrmojo.DI.DIDatabaseHelper,$HASH=mstrmojo.hash,CSS_TOOLTIP="mstrmojo-Tooltip",CSS_SCROLL_NODE="mstrmojo-scrollNode",$DIHELPER=mstrmojo.DI.DIHelpers;mstrmojo.AS.DIAppSchemaRepublishOAuthButton=mstrmojo.declare(mstrmojo.Container,null,{scriptClass:"mstrmojo.AS.DIAppSchemaRepublishOAuthButton",cssClass:"",sourceType:"",isLogin:false,tableId:"",pipelineId:"",markupString:'<div id="{@id}" class="cf {@cssClass}" ><div style="display: inline-block;"></div><div style="display: inline-block; height: 15px;"></div></div>',markupSlots:{loginNode:function(){return this.domNode.children[0];},accountNode:function(){return this.domNode.children[1];}},children:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-Button mstrmojo-di-button mstrmojo-WebButton",text:mstrmojo.desc(9935,"Log In"),slot:"loginNode",alias:"login",bindings:{visible:function(){return !this.parent.isLogin;}},onclick:function(){var me=this,controller=mstrApp.getRootController(),model=mstrApp.getRootController().getModel(),sourceType=this.parent.sourceType;if(!(document.location.protocol.indexOf("https")>-1||mstrApp.isSingleTier||$DIHelper.isServerBasedWS())){mstrmojo.alert(mstrmojo.desc(15600,"We are unable to connect to this data source because your web server is not set up for HTTPS connections. Please contact your administrator."));return ;}controller.gotoOAuthLogin(sourceType);model.externalSources[sourceType].attachEventListener("oAuthReportsFetched",this.id,function(){this.parent.isLogin=true;var formData={workspace_id:model.workspaceId,pipeline_id:this.parent.pipelineId,table_id:this.parent.tableId,};var callback={success:function(res){var model=mstrApp.getRootController().getModel();model.externalSources[me.parent.sourceType].isLogin=true;model.raiseEvent({name:"OAuthInfoUpdate"});},failure:function(res){mstrmojo.alert("Update DBRole failed");}};mstrmojo.AS.DIAppSchemaService.checkConnection(formData,callback);});}},{scriptClass:"mstrmojo.HBox",alias:"account",slot:"accountNode",bindings:{visible:function(){return this.parent.isLogin;}},children:[{scriptClass:"mstrmojo.Label",alias:"icon",cssClass:"mstrmojo-accountIcon",},{scriptClass:"mstrmojo.Label",alias:"account",cssClass:"mstrmojo-accountId",useRichTooltip:true,richTooltip:{cssClass:"vi-regular vi-tooltip-V",posType:mstrmojo.tooltip.POS_TOPLEFT,content:this.text,refNode:this.domNode,top:-32,},onclick:function(evt){var offsetX=0;if($DIHELPER.getEnvObj().isAppSchema()&&this.parent.parent.parent&&this.parent.parent.parent.scriptClass==="mstrmojo.DI.DIAppSchemaRepublishTreeNode"){offsetX=-350;}if(this.detailTooltip.visible){this.detailTooltip.close();}else{this.detailTooltip.open({richTooltip:{cssClass:"vi-regular vi-tooltip-A mojo-theme-light",content:this.text,posType:mstrmojo.tooltip.POS_TOPLEFT,refNode:this.domNode,top:30,left:-10+offsetX}},{e:evt});this.detailTooltip.contentNodeCssText="font-size: 14px; line-height: 26px";this.detailTooltip.visible=true;}},preBuildRendering:function preBuildRendering(){var me=this,controller=mstrApp.getRootController(),model=mstrApp.getRootController().getModel(),sourceType=me.parent.parent.sourceType;this.text=model.externalSources[sourceType]&&model.externalSources[sourceType].userDisplayName;this.detailTooltip=new mstrmojo.Tooltip({preBuildRendering:function preBuildRendering(){if(this._super){this._super();}this.email=model.externalSources[sourceType]&&model.externalSources[sourceType].userEmail;this.markupString='<div id="{@id}" class="'+CSS_TOOLTIP+' {@cssClass}" style="{@cssText}"><div class="'+CSS_TOOLTIP+'-shadow {@shadowNodeCssClass}"></div><div class="'+CSS_TOOLTIP+'-contentWrapper"><div class="'+CSS_TOOLTIP+"-content "+CSS_SCROLL_NODE+' {@contentNodeCssClass}" style="background-color: #fff"></div><div style="max-width: 140px; word-break: break-all; opacity: 0.45; font-size: 12px; line-height: 16px">{@email}</div><hr><div id="{@id}_signOut" style="padding-left:34px; font-size:12px; color:#3B92ED; line-height:26px; visibility : visible" type="button" mstrAttach:click";>Sign out</div></div><div class="'+CSS_TOOLTIP+'-arrow"></div></div>';},onclick:function onclick(evt){if(evt.e.currentTarget.id===this.id+"_signOut"){this.close();controller.oAuthSignOut(sourceType);model.externalSources[sourceType].isLogin=false;model.raiseEvent({name:"OAuthInfoUpdate"});}}});}}]}]});})();