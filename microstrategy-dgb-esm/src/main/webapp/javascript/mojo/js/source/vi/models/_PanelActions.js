(function(){mstrmojo.requiresCls("mstrmojo.EnumRWUnitType","mstrmojo.DocDataService","mstrmojo.func","mstrmojo.array","mstrmojo.hash","mstrmojo.vi.models.VIComponentMap.TYPES","mstrmojo.vi.controllers.EnumEvents","mstrmojo.vi.enums.EnumFeatures");var $MOJO=mstrmojo,$FUNC=mstrmojo.func,$ARR=mstrmojo.array,$HASH=mstrmojo.hash,$DDS=mstrmojo.DocDataService,$RW_UNIT_TYPES=$MOJO.EnumRWUnitType,$VI_TYPES=mstrmojo.vi.models.VIComponentMap.TYPES,REQUEST_DEFN_DATA=$MOJO.DocDataService.REQUEST_DEFN_DATA,EVENTS=mstrmojo.vi.controllers.EnumEvents,FEATURES=mstrmojo.vi.enums.EnumFeatures;function replaceKeys(keyArrToMatch,keyArr,layoutRoot){(layoutRoot.children||[]).forEach(function(node){replaceKeys(keyArrToMatch,keyArr,node);});var ix=keyArrToMatch.indexOf(layoutRoot.k);if(ix!==-1){layoutRoot.k=keyArr[ix];}}function updatePanelsDefnAfterMove(panel,newIdx,oldIdx){var panelStack=panel&&panel.parent,panels=panelStack&&panelStack.panels;newIdx=newIdx+1;oldIdx=oldIdx+1;$ARR.forEach(panels,function(item){var idx=item.defn.chdidx;if(idx===oldIdx){item.defn.chdidx=newIdx;}if(oldIdx<idx&&idx<=newIdx){item.defn.chdidx=idx-1;}if(newIdx<=idx&&idx<oldIdx){item.defn.chdidx=idx+1;}});}function updateDefnAfterMove(panelStackKey,layoutKey,newIdxs,oldIdxs,isDuplicate){var layoutDefn=this.getLayoutDefn(layoutKey),panels=[];$HASH.forEach(layoutDefn.units,function(unit){if(unit.t===$RW_UNIT_TYPES.PANEL&&unit.pnk===panelStackKey&&!unit._isDeleted){panels.push(unit);}});for(var i=0;i<newIdxs.length;i++){var oldIdx=oldIdxs[i]+1,newIdx=newIdxs[i]+1;$ARR.forEach(panels,function(item,panelIdx){var idx=item.chdidx;if(idx===oldIdx){item.chdidx=newIdx;}if(oldIdx<idx&&idx<=newIdx){item.chdidx=idx-1;}if(newIdx<=idx&&idx<oldIdx){item.chdidx=isDuplicate&&panelIdx===oldIdx-1?idx:idx+1;}});}}function findFirstElementGreaterThanGiven(arr,value){if(!arr||arr.length===0){return -1;}var head=0,tail=arr.length-1;while(head<tail-1){var mid=Math.floor((head+tail)/2);if(arr[mid]>value){tail=mid;}else{head=mid;}}if(arr[head]>value){return head;}if(arr[tail]>value){return tail;}return -1;}function defnUpdatePanelRemoval(isDeleted,layoutKey,keys){var model=this,units=model.getLayoutDefn(layoutKey).units||{},panelKeys=[].concat(keys),removeKeys=panelKeys.slice();$ARR.forEach(panelKeys,function(panelKey){var panel=model.getPanel(panelKey,layoutKey);if(panel){$ARR.forEach(panel&&panel.children,function(child){var k=child.k;if(k){removeKeys.push(k);}if(!units[k]&&child.node&&child.node.defn){units[k]=child.node.defn;}});if(!units[panelKey]&&panel.node&&panel.node.defn){units[panelKey]=panel.node.defn;}}else{$HASH.forEach(units,function(unit,key){if(unit.pnk===panelKey){removeKeys.push(key);}});}});removeKeys.forEach(function(key){if(units[key]){if(isDeleted){units[key]._isDeleted=true;}else{delete units[key]._isDeleted;}}});var originPanelKeys=model.getVisPanelKeys(layoutKey),deletedIdxs=[];$ARR.forEach(panelKeys,function(key){if(units[key]){deletedIdxs.push(units[key].chdidx);}});deletedIdxs.sort(function(a,b){return a-b;});if(isDeleted){$ARR.forEach(originPanelKeys,function(key){var unit=units[key];if(!unit._isDeleted){var childBeforeCnt=findFirstElementGreaterThanGiven(deletedIdxs,unit.chdidx);if(childBeforeCnt===-1){unit.chdidx-=deletedIdxs.length;}else{unit.chdidx-=childBeforeCnt;}}});}if(!isDeleted){$ARR.forEach(deletedIdxs,function(index){var idx=index,keyToAddBack=null;$ARR.forEach(originPanelKeys,function(key){var unit=units[key];if(!unit._isDeleted){if(panelKeys.indexOf(key)===-1&&unit.chdidx>=idx){unit.chdidx+=1;}else{if(panelKeys.indexOf(key)!==-1&&unit.chdidx===idx){keyToAddBack=key;}}}});panelKeys.splice(panelKeys.indexOf(keyToAddBack),1);});}model.raiseEvent({name:EVENTS.UPDATE_TOC});}mstrmojo.vi.models._PanelActions=mstrmojo.provide("mstrmojo.vi.models._PanelActions",{_mixinName:"mstrmojo.vi.models._PanelActions",addPanel:function(update,panelStackKey,layoutKey,newPanelKeyObj,skipUpdateToc){var panelStack=this.getVIComponent($VI_TYPES.VIZ_CONTENT,layoutKey),panelNode=this.createNewUnitNode(null,function(defn){defn.t=$RW_UNIT_TYPES.PANEL;return defn;},null,null,layoutKey),panelKey=panelNode.k,id=this.id,panel=null;if(newPanelKeyObj){newPanelKeyObj.k=panelKey;}if(panelStack){var builder=panelStack.builder;panel=builder.build([panelNode],this,{pk:panelStackKey})[0];panelStack.addChildren([panel],null,false,true);panelStack.doLayout();panel.boxLayoutConfig.useDefaultBox([]);}update.add([{act:"addPanel",nodeKey:panelKey,titlePattern:mstrApp.supportFeature(FEATURES.USE_WORKSTATION_NAMING_STYLE)?1:0,parentKey:panelStackKey,index:0}],{success:function(res){var model=mstrmojo.all[id];model.partialUpdate(res.data,model.getUnitDefinitions(panelKey),res.defn);if(panel){panelNode.defn=model.getUnitDefinitions(panelKey)[panelKey];panel.defn=panelNode.defn;panel.node.defn=panelNode.defn;}if(!skipUpdateToc){model.raiseEvent({name:EVENTS.UPDATE_TOC});}}},REQUEST_DEFN_DATA);return panel;},selectNewPanel:function(update,panelKey){update.add([{act:"setCurrentPanel",unitKey:panelKey}],{success:function(){var panel=this.getPanel(panelKey);panel.parent.selectPanel(panelKey,null,true);}.bind(this)});},duplicatePanel:function duplicatePanel(panel,panelStack,dupPanelIdx,layoutKey,builder,undoRedoCB,newPanelNode){var panelNode=newPanelNode||this.createNewUnitNode(null,function(defn){defn.t=$RW_UNIT_TYPES.PANEL;return defn;}),duplicatedPanelKey=panelNode.k,panelKey=panel.k,panelStackKey=panelStack.k,id=this.id,duplicatedPanelName=mstrmojo.desc(11450,"## copy ###"),actions=[{act:"duplicatePanel",nodeKey:panelKey,parentKey:panelStackKey,duplicateKey:duplicatedPanelName.replace("###",panel.numDupl===0?"":panel.numDupl).replace("##",panel.titleText),newKey:duplicatedPanelKey,index:dupPanelIdx+1},{act:"setCurrentPanel",unitKey:duplicatedPanelKey}],newPanel;var dataService=this.getDataService();this.execute({execute:function(){var cmd=this,update=dataService.newUpdate(cmd,{actions:actions,extras:REQUEST_DEFN_DATA,callback:{success:function(res){var model=mstrmojo.all[id];model.partialUpdate(res.data,model.getUnitDefinitions(res.pukeys||duplicatedPanelKey),res.defn);panelNode.defn=model.getUnitDefinitions(duplicatedPanelKey)[duplicatedPanelKey];var newChildren=builder.build([panelNode],model,{pk:panelStackKey});newPanel=newChildren[0];panelStack.addChildren(newChildren);var numChildren=panelStack.children.length,numPanels=panelStack.panels.length;panelStack.changePanelPosition(newPanel,numPanels-1,dupPanelIdx,numChildren-1,dupPanelIdx);updateDefnAfterMove.call(model,panelStackKey,layoutKey,[dupPanelIdx],[numPanels-1],true);if(newPanel.defn.layoutXML){replaceKeys.call(this,panel.getTargetKeysExcludingTypes(),newPanel.getTargetKeysExcludingTypes(),panelNode.defn.layoutXML);}panel.numDupl=panel.numDupl+1;panelStack.selectPanel(duplicatedPanelKey,null,true);panelStack.doLayout();model.getPanel().saveBoxLayout(null,model.cmdMgr().CMD_PHASE.LAST);model.raiseEvent({name:EVENTS.UPDATE_TOC});}}});update.submit();},urInfo:{disablePU:true,treesToRender:3,undo:undoRedoCB.undo,redo:undoRedoCB.redo},discard:undoRedoCB.discard});},movePanel:function movePanel(panel,newIdx,oldIdx,callback){var dataService=this.getDataService(),model=this;callback=$FUNC.composite([callback,function(){updatePanelsDefnAfterMove(panel,newIdx,oldIdx);model.raiseEvent({name:EVENTS.UPDATE_TOC});}]);this.execute({execute:function(){this.submit([dataService.getMoveNodeAction(panel,panel.parent.k,newIdx),{act:"setCurrentPanel",unitKey:panel.k}],{success:function(){callback(oldIdx,newIdx);}},$DDS.RAPID_EXEC);},urInfo:{silent:true,undo:function(){callback(newIdx,oldIdx);},redo:function(){callback(oldIdx,newIdx);}}});},movePanelsInLayout:function movePanelsInLayout(panelKeys,currentPanelKey,layoutKey,newIdxs,oldIdxs,callback){var dataService=this.getDataService(),model=this,panelKey=panelKeys&&panelKeys[0],panelStack=this.getPanel(panelKey,layoutKey).parent,panelStackKey=panelStack.k,selector=panelStack.selector,selectMovedTab=selector.selectMovedTab,selectAndMove=selectMovedTab&&currentPanelKey!==panelKey,selectedKey=panelStack.selectedKey,update=model.getDataService().newUpdate();callback=$FUNC.composite([callback,function(oldIdxs,newIdxs){updateDefnAfterMove.call(model,panelStackKey,layoutKey,newIdxs,oldIdxs);model.raiseEvent({name:EVENTS.UPDATE_TOC});}]);$ARR.forEach(panelKeys,function(panelKey,idx){var action=dataService.getMoveNodeActionUsingKey(panelKey,$RW_UNIT_TYPES.PANEL,panelStackKey,newIdxs[idx]);update.actions.push(action);});if(selectAndMove){panelStack.selectPanelDeferred(update,panelKey,false,false);}update.callback=$FUNC.wrapMethods({success:function(){callback(oldIdxs,newIdxs);}},update.callback);update.extras=$HASH.copy({params:{suppressData:selectAndMove?false:true}},update.extras);this.execute({execute:function(){this.submitUpdate(update);},urInfo:{silent:selectMovedTab?false:true,treesToRender:selectMovedTab?$DDS.EnumTreesToRender.BOTH:$DDS.EnumTreesToRender.NONE,undo:function(){this.urInfo.puKeys=[selectedKey];var reverseNewIdx=newIdxs.slice(),reverseOldIdx=oldIdxs.slice();reverseNewIdx.reverse();reverseOldIdx.reverse();callback(reverseNewIdx,reverseOldIdx);},redo:function(){this.urInfo.puKeys=[panelKey];callback(oldIdxs,newIdxs);}}});},getRemoveUnitAction:function getRemoveUnitAction(panel){return{act:"removeUnit",unitKey:panel.k,unitType:panel.defn.t};},getRemoveVisPanelAction:function getRemoveVisPanelAction(panelKey){return{act:"removeUnit",unitKey:panelKey,unitType:$RW_UNIT_TYPES.PANEL};},getSetCurrentPanelAction:function getSetCurrentPanelAction(newSelectedPanelKey){return{act:"setCurrentPanel",unitKey:newSelectedPanelKey};}});mstrmojo.vi.models._PanelActions.defnUpdatePanelRemoval=defnUpdatePanelRemoval;}());