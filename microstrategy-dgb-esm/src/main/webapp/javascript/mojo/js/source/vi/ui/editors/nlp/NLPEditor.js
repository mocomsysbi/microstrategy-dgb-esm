(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.Editor","mstrmojo.vi.viz.SmartVisualizationPicker","mstrmojo.dom","mstrmojo.mstr.EnumDSSEmptyGraphMsgType","mstrmojo.VisEnum","mstrmojo.vi.ui.editors.nlp.SearchBoxWithSuggestion");mstrmojo.requiresDescs(15928);var $DOM=mstrmojo.dom,EMPTY_GRAPH_MSG_TYPE=mstrmojo.mstr.EnumDSSEmptyGraphMsgType,VIZ_BOX_CLS="mstrmojo.vi.ui.rw.VizBox",ARR=mstrmojo.array,SUGGESTION_LIMIT=1000,ENUM_VIZ=["kpi","geospatial map","heat map","heatmap","tree map","treemap","map","line","bar","pie","bubble","network"],CARDLIMIT=mstrmojo.VisEnum.VIS_CARDLIMIT.NON_GRID;function isVizEmpty(vizBox){if(vizBox&&vizBox.scriptClass===VIZ_BOX_CLS){var node=vizBox&&vizBox.boxContent&&vizBox.boxContent.node,data=node&&node.data;return data&&(data.egt===EMPTY_GRAPH_MSG_TYPE.DssNoTemplateUnit);}return false;}function searchTriggeredPrivate(text){var vizPicker=new mstrmojo.vi.viz.SmartVisualizationPicker();vizPicker.mapConfig=this.model.mapConfig;var ro=this.model.getRelevantObjects(text),wantNotGrid=false,vizWanted,vizInfo=vizPicker.buildVisualization(ro,ro.visType),docControl=this.docControl,docModel=docControl&&docControl.model,vizPanelStack=docModel&&docModel.getVizContentPanel(),cardOverLimit=false,badItemName="",items=vizInfo.objects,me=this;ARR.forEach(ENUM_VIZ,function(item){if(text.indexOf(item)!==-1){wantNotGrid=true;vizWanted=item;return false;}});if(vizPanelStack){vizPanelStack.restoreAnyMaxedVizBox();}if(vizInfo.objects.length>0){try{var useCurrentVizContainer=false;if(vizPanelStack.firstVizBoxId){if(isVizEmpty(docModel.getSelectedViUnit())){useCurrentVizContainer=true;}else{ARR.forEach(vizPanelStack.children,function(vizBox){if(isVizEmpty(vizBox)){useCurrentVizContainer=true;docModel.selectVIUnit(vizBox.id);return false;}});}}ARR.forEach(items,function(item){if(item.card>CARDLIMIT){cardOverLimit=true;badItemName=item.n;return false;}});var createVizFunc=function createVizFunc(isGrid){var didSpecify=false,changedTitle=false;if(isGrid===true){ARR.forEach(ENUM_VIZ,function(item){if(text.indexOf(item)!==-1){didSpecify=true;text=text.replace(item,"Grid");changedTitle=true;}});if(!changedTitle){text=text.replace(/\?+$/,"");text+=" as Grid";}ro=me.model.getRelevantObjects(text);vizInfo=vizPicker.buildVisualization(ro,ro.visType);}docControl.createSmartViz(vizInfo,ro.datasetId,ro.filter,ro.sorts,text,useCurrentVizContainer);};if(cardOverLimit&&wantNotGrid){var message=mstrmojo.desc(16281,"The attribute ##  has too many elements. Creating a ### may impact dossier performance. Would you like to show as a grid instead?").replace("##",badItemName).replace("###",vizWanted);mstrmojo.warn(message,{},{buttons:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-WebButton hot",text:"Create Grid",onclick:function(){createVizFunc(true);}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-WebButton",text:"Create Visualization",onclick:createVizFunc},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-WebButton",text:"Cancel",onclick:mstrmojo.emptyFn}],allowHTML:false});}else{if(cardOverLimit&&!wantNotGrid){createVizFunc(true);this.close();}else{createVizFunc();this.close();}}}catch(e){mstrmojo.error({shortDesc:mstrmojo.desc(15428,"Something went wrong during NLP processing.")});this.close();}}else{mstrmojo.alert(mstrmojo.desc(15429,"Cannot create a visualization based on your search."),undefined,undefined,undefined,undefined,{id:"nlpAlert"});}}mstrmojo.vi.ui.editors.nlp.NLPEditor=mstrmojo.declare(mstrmojo.Editor,[],{scriptClass:"mstrmojo.vi.ui.editors.nlp.NLPEditor",showTitle:false,autoClose:true,cssClass:"NLPEditor",model:null,docControl:null,children:[{scriptClass:"mstrmojo.vi.ui.editors.nlp.SearchBoxWithSuggestion",height:"43px",candidates:null,alias:"searchBox",suggestCount:SUGGESTION_LIMIT,REQUEST_THRESHOLD:SUGGESTION_LIMIT,noCache:true,text:"",searchTriggered:function(text){var nlpEditor=this.parent;nlpEditor.onSearchTriggered(text);},filterCandidates:function filterCandidates(its){return its;},getCandidatesThroughTaskCall:function(config,callbacks){var nlpEditor=this.parent,nlpModel=nlpEditor.model;config.showSampleQuestion=(this.text||"").trim()==="";callbacks.success({items:nlpModel.getSuggestionListItems(config,SUGGESTION_LIMIT)});}}],_set_visible:function _set_visible(n,v){var me=this;this._close_handler=function(evt){var target=$DOM.eventTarget(self,evt);var searchBox=me.searchBox,suggestionPopup=searchBox&&searchBox.suggestionPopup,popUpDom=suggestionPopup&&suggestionPopup.domNode,alertWidget=mstrmojo.all.nlpAlert,alertDom=alertWidget&&alertWidget.domNode,body=document.body;if(target&&target.parentNode&&!$DOM.contains(me.editorNode,target,true,body)&&!$DOM.contains(popUpDom,target,true,body)&&!$DOM.contains(alertDom,target,true,body)){me.close();}};return this._super(n,v);},onSearchTriggered:function onSearchTriggered(text){searchTriggeredPrivate.call(this,text);},candidates:[],init:function init(props){this._super(props);this.themeClassName=this.themeClassName+" nlp-editor";this.searchBox.attachEventListener("quitWatermelon",this.id,function(){this.close();});},onOpen:function onOpen(){var me=this,model=this.model;model.checkForMapboxKey();model.buildWordBase();window.setTimeout(function(){me.searchBox.inputNode.focus();me.searchBox.showSuggestion("");},10);},onClose:function onClose(){this.searchBox.clearSearch(true);this.searchBox.hideSuggestion();},postBuildRendering:function(){var me=this;this.onResize=function(){var searchBox=me.searchBox;searchBox.updateSuggestionPos();};$DOM.attachEvent(window,"resize",this.onResize);this._super();},destroy:function destroy(ignoreDom){if(this.onResize){$DOM.detachEvent(window,"resize",this.onResize);delete this.onResize;}this._super(ignoreDom);}});}());