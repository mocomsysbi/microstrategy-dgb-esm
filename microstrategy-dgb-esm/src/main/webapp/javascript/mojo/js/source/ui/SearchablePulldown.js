(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.css","mstrmojo.dom","mstrmojo.hash","mstrmojo._HasEditableText","mstrmojo.ui.Pulldown");var $ARR=mstrmojo.array,$DOM=mstrmojo.dom,$HASH=mstrmojo.hash,$KEY=mstrmojo.Enum_Keys,ARROW_WIDTH=19,KEY_ENTER=$KEY.ENTER,KEY_ESC=$KEY.ESCAPE,KEY_DOWN=$KEY.DOWN_ARROW,KEY_UP=$KEY.UP_ARROW;mstrmojo.ui.SearchablePulldown=mstrmojo.declare(mstrmojo.ui.Pulldown,[mstrmojo._HasEditableText],{scriptClass:"mstrmojo.ui.SearchablePulldown",editableSlot:"selectedNode",allowCustomText:false,isSearching:false,editOnClick:false,init:function init(props){this._super(props);var popupList=this.getPopupList();popupList.renderOnScroll=this.renderOnScroll||popupList.renderOnScroll;popupList.renderBlockSize=this.renderBlockSize||popupList.renderBlockSize;var clipClass=[];if((mstrApp.isWorkstation&&$DOM.isMac())||$DOM.isSafari){clipClass=["clip-safari"];}mstrmojo.css.addWidgetCssClass(this,["mstrmojo-ui-SearchablePulldown"].concat(clipClass));var prt=popupList.constructor.prototype,getItemProps=popupList.getItemProps||prt.getItemProps,getItemMarkup=popupList.getItemMarkup||prt.getItemMarkup;popupList.getItemProps=function(item,idx){var input=this._spft||"",itemName=item.n,index=itemName?itemName.toUpperCase().indexOf(input):-1,stripColorStyle=function(cssString){var cssArray=[],tupleArray;$ARR.forEach(cssString.split(";"),function(tuple){tupleArray=tuple.split(":");if(tupleArray.length===2&&tupleArray[0].toLowerCase()!=="color"){cssArray.push(tuple);}});return cssArray.join(";");};if(index===-1){input="";}var itemProps=getItemProps.call(this,item,idx);if(this.selectedIndices[idx]){itemProps.style=stripColorStyle(itemProps.style);}if(itemName){itemProps.before=itemName.slice(0,index);itemProps.input=itemName.substring(index,index+input.length);itemProps.after=itemName.slice(index+input.length,itemName.length);}return itemProps;};popupList.getItemMarkup=function(item,idx){var markup=getItemMarkup.call(this,item,idx);if(item.n&&item.v!=="u;"){return markup.replace("{@en@n}","{@en@before}<span class='sp-highlight'>{@en@input}</span>{@en@after}");}return markup;};this._originalFocusOnPopup=this.focusOnPopup;this.focusOnPopup=false;},onclick:function onclick(evt){if(this._originalFocusOnPopup!==undefined){this.focusOnPopup=false;}if(this.isClickingAnchorSlot(evt)){var isArrow=evt.e.offsetX>=(this.selectedNode.offsetWidth-ARROW_WIDTH),isPopupWidgetVisible=this.getPopupWidget().visible;if(!isPopupWidgetVisible||(isPopupWidgetVisible&&isArrow)){this.set("isEditing",!isPopupWidgetVisible);this._super(evt);}else{if(!this.isEditing){this.set("isEditing",true);}}}},setDefaultListAndIndex:function(oldItems,pressingEnter){var pulldownList=this.getPopupList(),textValue=this.text,selIdx=$ARR.find(oldItems,"n",textValue);if(selIdx===-1&&!this.allowCustomText){var fallbackItem=pulldownList.items[0]||oldItems[0];selIdx=$ARR.find(oldItems,"n",fallbackItem.n);}pulldownList.set("items",oldItems);if(pressingEnter){this.set("selectedIndex",selIdx);}},onPopupWidgetClosed:function onPopupWidgetClosed(config){this.set("isEditing",false);var pulldownList=this.getPopupList(),oldItems=pulldownList._oldItems;delete pulldownList._oldItems;if(oldItems){this.setDefaultListAndIndex(oldItems,config&&config.pressingEnter);}},_set_selectedIndex:function onselectedIndexChange(n,v){if(this.allowCustomText&&v===-1){this.selectedIndex=-1;this.onitemSelected(null,v);}else{this.isSearching=false;this._super(n,v,true);if(this.hasRendered){var selNode=this.selectedNode;this.text=selNode.innerText||selNode.textContent;}}return true;},onkeydown:function onkeydown(event){this._super(event);var evt=window.event||event.e,keyCode=evt.keyCode,popup=this.getPopupWidget();if(keyCode===KEY_ENTER){popup.close({pressingEnter:true});}else{if(this._originalFocusOnPopup&&(keyCode===KEY_DOWN||keyCode===KEY_UP)){this.focusOnPopup=true;if(popup.focus){popup.focus();}popup.raiseEvent(event);}}},onkeyup:function onkeyup(event){var evt=window.event||event.e,keyCode=evt.keyCode,pulldownList=this.getPopupWidget();this._super(event);if(keyCode===KEY_ESC||keyCode===KEY_ENTER){pulldownList.close();}else{if(keyCode!==KEY_DOWN&&keyCode!==KEY_UP){this.processSearch();}}},processSearch:function processSearch(){this.isSearching=true;this.hideTooltip();var result=[],pulldownList=this.getPopupList(),searchValue=this.selectedNode.innerHTML,oldItems=pulldownList._oldItems||pulldownList.items,input=searchValue.toUpperCase(),itemName;input=input.replace(/<BR>/,"");if(input.length>0){$ARR.forEach(oldItems,function(item){itemName=item.n;if(itemName&&itemName.toUpperCase().indexOf(input)>-1){result.push($HASH.clone(item));}},this);}else{result=oldItems;}pulldownList._spft=input;if(this.customizeSearchResult){this.customizeSearchResult(result);}pulldownList.set("items",result);if(pulldownList.adjustCornersForPopupOverflow){pulldownList.adjustCornersForPopupOverflow();}delete pulldownList._spft;pulldownList._oldItems=oldItems;pulldownList.set("visible",pulldownList.items.length!==0);}});}());