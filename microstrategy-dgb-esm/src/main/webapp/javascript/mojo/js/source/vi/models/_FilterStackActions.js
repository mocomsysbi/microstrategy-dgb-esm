(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.EnumRWUnitType","mstrmojo.models.FormatModel","mstrmojo.DocDataService","mstrmojo.hash","mstrmojo.vi.viz.EnumWidgetTypes","mstrmojo.vi.viz.EnumVizStyles","mstrmojo.vi.ui.rw.selectors.EnumVizSelectorMode","mstrmojo.css","mstrmojo.vi.ui.rw.selectors.VisSelectorCurtain");mstrmojo.requiresClsP("mstrmojo.vi.models","PanelFormatSaver","EnumPanelTypes","VIComponentMap");var $MOJO=mstrmojo,$HASH=$MOJO.hash,$ARR=$MOJO.array,$VI_MODELS=$MOJO.vi.models,$RW=$MOJO.vi.ui.rw,$VI_TYPES=$VI_MODELS.VIComponentMap.TYPES,$PANEL_TYPES=$VI_MODELS.EnumPanelTypes,VI_FILTER_STACK=$VI_TYPES.FILTER_STACK,$FORMAT_MODEL=$MOJO.models.FormatModel,$GET_FORMAT_OBJ=$FORMAT_MODEL.getFormatUpdate,$ENUM_FORMAT_PROPERTIES=$FORMAT_MODEL.ENUM_PROPERTY_NAMES,$RW_UNIT_TYPES=$MOJO.EnumRWUnitType,$ERR=$MOJO.mstr.EnumWebAPIErrorCodes,PANEL_FILTER_STACK=$PANEL_TYPES.FILTERS,UNDO_KEY=$MOJO.DocDataService.UNDO_KEY,ITEM_SEPARATOR="\u001E",REQUEST_DEFN_DATA=$MOJO.DocDataService.REQUEST_DEFN_DATA,SUPPRESS_DATA=$MOJO.DocDataService.SUPPRESS_DATA,FP_PATH="sections.0.subsections.0",$WIDGET_STYLE=mstrmojo.vi.viz.EnumVizStyles,$WIDGET_TYPE=mstrmojo.vi.viz.EnumWidgetTypes,$VIZ_SELECTOR_MODE=$RW.selectors.EnumVizSelectorMode,$CSS=mstrmojo.css;var DEFAULT_ROWS_COUNT=8,VISFILTER_MASK_SPACE=80,VISFILTER_CON_SPACE=10;function isUC(unit){return unit.t!==1&&(unit.t!==47||unit.st===12033);}function pivotExistingStackSelectors(stack,startIdx,endIdx,shiftOffset,refreshKeys){var actions=[];if(!stack){return actions;}refreshKeys=refreshKeys||{};stack.getFilters().forEach(function(filter){var oldIdx=parseInt(filter.defn.fmts["z-index"],10),filterKey=filter.defn.t===$RW_UNIT_TYPES.SELECTOR?filter.ckey:filter.k;if(oldIdx>=startIdx&&(!endIdx||oldIdx<=endIdx)){actions.push(this.getUnitFormatAction(filter,1,$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.Z_INDEX,oldIdx+shiftOffset)));refreshKeys[filterKey]=filter.id;}},this);return actions;}function getVIVizPanel(){var layoutKey=this.getCurrentLayoutKey();return this.getVIComponent($VI_TYPES.VIZ_CONTENT,layoutKey);}function getAddFilterActions(unit,targetKeys,nodeKey,ctrlKey,zIndex){var actions=[],ctrlStyle=this.getCtrlStyleFromDatasetUnit(unit,true),layoutUnits=this.getCurrentLayoutDef().units,stackKey=this.getVIPanelKeyFromUnits(PANEL_FILTER_STACK),panelKey=$HASH.keyarray(layoutUnits).filter(function(key){return layoutUnits[key].t===$RW_UNIT_TYPES.PANEL&&layoutUnits[key].isFilterPanel;})[0],panelFormats=this.getTargetDefn(panelKey)[panelKey].fmts,formatWidth=panelFormats&&panelFormats.width,width=(formatWidth&&formatWidth.charAt(formatWidth.length-1)!=="%")?parseInt(formatWidth,10):undefined,orientation;if(zIndex===undefined||zIndex===null){zIndex=999;}actions.push(this.getDataService().getAddCtrlAction(panelKey,nodeKey,ctrlKey,[stackKey],isUC(unit),unit.t,unit.did,targetKeys));if(ctrlStyle===1){orientation=1;}actions=actions.concat(this.getCtrlActionsByStyle(unit,this.buildKeyContext(nodeKey,ctrlKey),ctrlStyle,orientation,this.getCtrlHeightByStyle(ctrlStyle,unit.card&&(unit.card+1)||DEFAULT_ROWS_COUNT+1),width,zIndex,1));return actions;}function getAddVisFilterActions(targetKeys,vis,ctrlKey,CGBKeys){if(!vis){return ;}var actions=[],nodeKey=vis.k,layoutUnits=this.getCurrentLayoutDef().units,stackKey=this.getVIPanelKeyFromUnits(PANEL_FILTER_STACK),panelKey=$HASH.keyarray(layoutUnits).filter(function(key){return layoutUnits[key].t===$RW_UNIT_TYPES.PANEL&&layoutUnits[key].isFilterPanel;})[0],panelFormats=this.getTargetDefn(panelKey)[panelKey].fmts,formatWidth=panelFormats&&panelFormats.width,width=(formatWidth&&formatWidth.charAt(formatWidth.length-1)!=="%")?parseInt(formatWidth,10):undefined,orientation,me=this,keyContext=me.buildKeyContext(vis.k,ctrlKey),filterItems=me.getVIComponent($VI_TYPES.FILTER_PANEL).children,zIndex=filterItems?filterItems.length:0;actions.push(this.getSetVisAsFilterAction(nodeKey,ctrlKey,[stackKey],targetKeys,CGBKeys));actions=actions.concat(this.getCtrlActionsByStyleForVisFilter(nodeKey,zIndex));return actions;}function getExecAddFilterActions(update,keyContexts,units,zIndex,refreshKeys,extraInfo){var viMap=this.getVIMap(),stack=viMap.getComponent(VI_FILTER_STACK);if(extraInfo&&extraInfo.preInfo){update.addActions(extraInfo.preInfo.actions);}if(!keyContexts.length){var cmdZIndex=zIndex;units.forEach(function(unit){var nodeKey=this.getNextKey(),ctrlKey=this.getNextKey(),ctrlKeyContext=this.buildKeyContext(nodeKey,ctrlKey);keyContexts.push(ctrlKeyContext);update.addActions(getAddFilterActions.call(this,unit,[viMap.getComponentKey($VI_TYPES.MAIN_CONTENT)],nodeKey,ctrlKey,(cmdZIndex!==null?cmdZIndex++:null)));},this);var endzIndex=keyContexts.length&&(stack.getFilters().length-1);update.addActions(pivotExistingStackSelectors.call(this,stack,zIndex,endzIndex,keyContexts.length,refreshKeys));}else{var dataService=this.getDataService();keyContexts.forEach(function(key){dataService.addMoveControlAction(update,key,stack.contents.k);});update.addActions(pivotExistingStackSelectors.call(this,stack,zIndex,null,keyContexts.length,refreshKeys));}if(extraInfo&&extraInfo.postInfo){update.addActions(extraInfo.postInfo.actions);}}function getUndoAddFilterActions(update,keyContexts,zIndex,refreshKeys){var viMap=this.getVIMap(),stack=viMap.getComponent(VI_FILTER_STACK),dataService=this.getDataService();keyContexts.forEach(function(key){dataService.addMoveControlAction(update,key,UNDO_KEY);});update.addActions(pivotExistingStackSelectors.call(this,stack,zIndex+1,undefined,-keyContexts.length,refreshKeys));}function getDeleteFilterActions(update,model,filterDefinitions,refreshKeys,ignoreTargetData){var stack=model.getDocBuilder().getLayoutVIMap(model.getCurrentLayoutKey()).getComponent(VI_FILTER_STACK),panelKey=stack.contents.k,dataService=model.getDataService();var filters=stack.getFilters(),toRemove={},zIndexOffset=0;filterDefinitions.forEach(function(def){toRemove[def.ckey]=def;});filters.forEach(function(filter){var oldIdx=parseInt(filter.defn.fmts["z-index"],10);if(!filter.ckey){filter.ckey=filter.k;}if(!toRemove[filter.ckey]){if(zIndexOffset!==0){update.addActions(model.getUnitFormatAction(filter,1,$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.Z_INDEX,oldIdx-zIndexOffset)));refreshKeys[filter.ckey]=filter.id;}else{var targetKeys=filter.tks?filter.tks.split(ITEM_SEPARATOR):[];for(var p in toRemove){if(targetKeys.indexOf(toRemove[p].ckey)>=0){refreshKeys[filter.ckey]=filter.id;break;}}}}else{var definition=toRemove[filter.ckey],targetKeys=definition.tks?definition.tks.split(ITEM_SEPARATOR):[],targetDsKeys=definition.dsTks?definition.dsTks.split(ITEM_SEPARATOR):[],keyContext=definition.ck,fnTargetState=dataService.getRemoveCtrlTargetAction,fnTargetDsState=dataService.getRemoveCtrlTargetDatasetAction;if(!(filter instanceof mstrmojo.VisDocSelector)){targetKeys.forEach(function(targetKey){if(ignoreTargetData){update.addActions(fnTargetState.call(dataService,keyContext,targetKey,[],true));}else{update.addActions(fnTargetState.call(dataService,keyContext,targetKey,targetKey));}});}targetDsKeys.forEach(function(targetKey){update.addActions(fnTargetDsState.call(dataService,keyContext,targetKey));});if(model.datasetsSettings.unitOpr(definition.ttl,"isDeleteWithFilter")){update.addActions({act:"removeDerivedMetricFromDataset",dsid:model.findDatasetIdFromUnit(definition.srcid),metricId:definition.srcid});model.datasetsSettings.unitOpr(definition.ttl,"isDeleteWithFilter",false);model.datasetsSettings.unitOpr(definition.ttl,"completeHide",false);update.addActions(model.datasetsSettings.getSaveActions());}var updateNodeKeys=[panelKey];if(!ignoreTargetData){updateNodeKeys=updateNodeKeys.concat(targetKeys);}update.addActions(dataService.getRemoveCtrlAction(definition.ckey,updateNodeKeys));zIndexOffset=zIndexOffset+1;}},this);}function getReplaceFilterActions(update,filterDefinition,unitToRaplace,stack,refreshKeys){var panelKey=stack.contents.k,dataService=this.getDataService(),keyContext=filterDefinition.ck,controlKey=filterDefinition.ckey,targetKeys=filterDefinition.tks?filterDefinition.tks.split(ITEM_SEPARATOR):[];refreshKeys[panelKey]=true;refreshKeys[controlKey]=true;update.addActions(dataService.getReplaceCtrlAction(keyContext,controlKey,filterDefinition.ct,unitToRaplace.did,unitToRaplace.t,targetKeys.concat(panelKey)));}function addFilterStackSuccess(response,request,update,stack,refreshKeys,forcePU,extraInfo){var model=this,panel=stack.contents,rebuildKeys=stack.k,requestParameters=request.params.params,partialRetrieval=requestParameters&&JSON.parse(requestParameters).partialRetrieval,partialRetrievalNodes=partialRetrieval&&partialRetrieval.nodes;if(forcePU){rebuildKeys=response.pukeys;}else{if(partialRetrievalNodes){rebuildKeys=$HASH.keyarray(refreshKeys||{}).concat(partialRetrievalNodes).join(ITEM_SEPARATOR);}}model.partialUpdate(response.data,model.getTargetDefn(rebuildKeys),response.defn,$HASH.keyarray(refreshKeys||{}));if(mstrApp.isAppStatePause&&mstrApp.isAppStatePause()&&panel.refreshFP){panel.refreshFP();}else{if(panel&&panel.children){panel.rebuildChildren();}}if(!!extraInfo&&extraInfo.hasOwnProperty("isVisFilterAdded")&&extraInfo.isVisFilterAdded){var filterPanel=this.getVIComponent($VI_TYPES.FILTER_PANEL),filters=filterPanel.children,len=filters.length,domNode=filters[len-1].domNode,scrollNode=stack.scrollNode;scrollNode.scrollTop=scrollNode.scrollHeight-scrollNode.clientHeight;$CSS.addClass(domNode,["visSelector-Animation"]);$CSS.onAnimationEnd(domNode,function(){$CSS.removeClass(domNode,["visSelector-Animation"]);});}stack.getFilterDefinitions().forEach(function(defn){if(!defn.sfs){var sfs=[],item=model.getDatasetUnits(["att","mx"],function(it){return it.did===defn.srcid;})[0]||{};(item.fs||[]).forEach(function(form){sfs.push({did:form.fid});});if(sfs.length){defn.sfs=sfs;}}});var tabList=stack.parent&&stack.parent.tabList;if(tabList){tabList.singleSelect($ARR.find(tabList.items,"id","vi_flt"));}}function addFilterStackCallback(update,stack,refreshKeys,forcePU,extraInfo){var model=this;if(mstrmojo.array.find(update.actions,"act","removeDerivedMetricFromDataset")>=0){update.addCallbacks(model.getDatasetsUpdateCallback());}if(extraInfo&&extraInfo.preInfo){update.addCallbacks(extraInfo.preInfo.callback);}update.addCallbacks({success:function(response,request){addFilterStackSuccess.call(model,response,request,update,stack,refreshKeys,forcePU,extraInfo);},failure:function(response,request){var fn=null;if(response.code==$ERR.DFC_QRYENG_RES_TRUNC){fn=function(){model.controller.undo();};}mstrmojo.error({longDesc:response.message},fn,{title:"Error"});}});if(extraInfo&&extraInfo.postInfo){update.addCallbacks(extraInfo.postInfo.callback);}}function buildVizBox(nodeKey){var model=this,vizBox,layoutKey=model.getCurrentLayoutKey(),templateNode=model.getNodeDataByKey(nodeKey),unitNode=model.createNewUnitNode(function(){return templateNode.data;},function(){return templateNode.defn;},function(){return templateNode;},nodeKey,layoutKey),oldId=model.getWidgetId({k:nodeKey,wid:1},layoutKey),srcFilterPortlet;unitNode.defn.iifp=false;if(mstrmojo.all[unitNode.id]){var dataCache=model.dataCache[layoutKey];unitNode.id=model.adjustNodeId(oldId);dataCache[unitNode.id]=dataCache[oldId];srcFilterPortlet=mstrmojo.all[oldId].parent;}vizBox=model.createUnit(unitNode,"",layoutKey);vizBox.showTitleBar=false;unitNode.defn.iifp=true;vizBox.boxContent.srcFilterPortlet=srcFilterPortlet;return vizBox;}function getPanelFormatting(panelId){var layoutKey=this.getCurrentLayoutKey(),panel=this.getVIComponent(panelId,layoutKey);return panel.domNode.getBoundingClientRect();}function addVisFilterCallback(container,update,nodeKey){var model=this;update.addCallbacks({success:function(response,request){var res=response,vizBox;model.cachePrevSelectedUnitId();model.updateDefnCache(res.defn,[nodeKey]);model.updateDataCache(res.data,model.getTargetDefn(nodeKey));vizBox=model.insertVizBox(nodeKey,container,{});model.controller.rootCtrl.initPanelStautsInConfigMode();model.selectVIUnit(vizBox.id,true,{isAddAction:true});mstrApp.restoreVFKey=nodeKey;mstrApp.isEnableSaveBtn=false;},failure:function(response){var fn=null;if(response.code===$ERR.DFC_QRYENG_RES_TRUNC){fn=function(){model.controller.undo();};}mstrmojo.error({longDesc:response.message},fn,{title:"Error"});}});}function addSaveVisFilterCallback(update,stack,vis,ctrlKey,targetKeys,CGBKeys,refreshKeys,forcePU){if(!vis){return ;}var model=this,nodeKey=vis.k;update.addCallbacks({success:function(response,request){model.updateVisSelector(vis,ctrlKey,targetKeys,CGBKeys);model.updateDefnCache(response.defn,[nodeKey]);model.updateDataCache(response.data,model.getTargetDefn(nodeKey));model.destroyVisualiztionselector();model.controller.rootCtrl.restorePanelStatus(stack);addFilterStackSuccess.call(model,response,request,update,stack,refreshKeys,forcePU,{isVisFilterAdded:true});}});}function addCancelVisFilterCallback(update,stack,vis,refreshKeys,forcePU){if(!vis){return ;}var model=this,nodeKey=vis.k;update.addCallbacks({success:function(response,request){model.updateDefnCache(response.defn,[nodeKey]);model.updateDataCache(response.data,model.getTargetDefn(nodeKey));addFilterStackSuccess.call(model,response,request,update,stack,refreshKeys,forcePU);}});}mstrmojo.vi.models._FilterStackActions=mstrmojo.provide("mstrmojo.vi.models._FilterStackActions",{_mixinName:"mstrmojo.vi.models._FilterStackActions",addFilterStackSelectors:function addFilterStackSelectors(units,toIdx,extraInfo,forcePU){var dataService=this.getDataService(),model=this,viMap=this.getVIMap(),stack=viMap.getComponent(VI_FILTER_STACK),keyContexts=[],zIndex=toIdx!==undefined?toIdx:(stack?stack.getFilters().length:null),ds=model.getDataService();var addFiltersFN=function(){var isValid=(!stack||$ARR.find(stack.getFilterDefinitions(),"srcid",units[0]&&units[0].did)===-1);if(isValid){forcePU=forcePU||!!units.filter(function(unit){return !isUC(unit);}).length;model.execute({execute:function(){var update=dataService.newUpdate(this,{extras:REQUEST_DEFN_DATA}),refreshKeys={},panel=stack.contents;update.extras.skipUICmdMgrOnFailure=[$ERR.DFC_QRYENG_RES_TRUNC];update.extras.config={hideFailureErr:true};refreshKeys[panel.k]=true;getExecAddFilterActions.call(model,update,keyContexts,units,zIndex,refreshKeys,extraInfo);addFilterStackCallback.call(model,update,stack,refreshKeys,forcePU,extraInfo);var phase=zIndex===null?this.mgr.CMD_PHASE.FIRST:this.mgr.CMD_PHASE.LAST;this.submitUpdate(update,phase);}});}};if(!stack){ds.submitUpdates(model.getShowVIStackAction(PANEL_FILTER_STACK),{success:function(response,request){model.buildLoadedVIStack(PANEL_FILTER_STACK,FP_PATH,response,model.getDocBuilder());model.controller.view.openViPanel("filterPanel",{success:addFiltersFN});stack=model.getVIMap().getComponent(VI_FILTER_STACK);}},{preserveUndo:true});}else{if(stack.getOpenStatus()){addFiltersFN();}else{model.controller.view.openViPanel("filterPanel",{success:addFiltersFN});}}},pivotFilterStackSelector:function pivotFilterStackSelector(selector,fromIdx,toIdx){var dataService=this.getDataService(),selectorId=selector.id,stack=this.getVIMap().getComponent(VI_FILTER_STACK),model=this,shiftUp=fromIdx<toIdx;function cmdMethod(){var update=dataService.newUpdate(this,{extras:REQUEST_DEFN_DATA}),refreshKeys={},cmdFromIdx=this.getStateValue(fromIdx,toIdx),cmdToIdx=this.getStateValue(toIdx,fromIdx),cmdShiftUp=this.getStateValue(shiftUp,!shiftUp),selectorKey;selector=mstrmojo.all[selectorId];selectorKey=selector.defn.t===$RW_UNIT_TYPES.SELECTOR?selector.ckey:selector.k;update.addActions(pivotExistingStackSelectors.call(model,stack,cmdToIdx,cmdFromIdx+(cmdShiftUp?1:-1),cmdShiftUp?-1:1,refreshKeys));update.addActions(model.getUnitFormatAction(selector,1,$GET_FORMAT_OBJ($ENUM_FORMAT_PROPERTIES.Z_INDEX,cmdToIdx)));refreshKeys[selectorKey]=selectorId;addFilterStackCallback.call(model,update,stack,refreshKeys);this.urInfo=this.urInfo||{};this.urInfo.callback=update.callback;update.submit();}this.execute({execute:cmdMethod});},deleteVisFilterStackSelectors:function deleteVisFilterStackSelectors(selector,ignoreTargetData){var dataService=this.getDataService(),stack=this.getVIMap().getComponent(VI_FILTER_STACK),model=this,act=stack.model.getDataService().newUpdate(stack),filterDefinitions=[selector.defn],removeUnitAction=model.getRemoveUnitAction(selector),sc=selector.node.data.sc;if(sc){selector.ckey=selector.defn.ckey=sc.ckey;selector.defn.tks=sc.tks;selector.defn.ck=sc.ck;}if(stack.applyBufferedSlices){stack.applyBufferedSlices(true,act);}function cmdMethod(){var update=dataService.newUpdate(this,{extras:REQUEST_DEFN_DATA}),refreshKeys={};refreshKeys[stack.contents.k]=true;getDeleteFilterActions.call(this,update,model,filterDefinitions,refreshKeys,ignoreTargetData);addFilterStackCallback.call(model,update,stack,refreshKeys);this.urInfo=this.urInfo||{};this.urInfo.callback=update.callback;var actions=(act.actions||[]).concat(update.actions);actions.push(removeUnitAction);this.submit(actions,update.callback,update.extras);}this.execute({execute:cmdMethod});},deleteFilterStackSelectors:function deleteFilterStackSelectors(filterDefinitions,ignoreTargetData){var dataService=this.getDataService(),stack=this.getVIMap().getComponent(VI_FILTER_STACK),model=this,act=stack.model.getDataService().newUpdate(stack);if(stack.applyBufferedSlices){stack.applyBufferedSlices(true,act);}function cmdMethod(){var update=dataService.newUpdate(this,{extras:REQUEST_DEFN_DATA}),refreshKeys={};refreshKeys[stack.contents.k]=true;getDeleteFilterActions.call(this,update,model,filterDefinitions,refreshKeys,ignoreTargetData);addFilterStackCallback.call(model,update,stack,refreshKeys);this.urInfo=this.urInfo||{};this.urInfo.callback=update.callback;var actions=(act.actions||[]).concat(update.actions);this.submit(actions,update.callback,update.extras);}this.execute({execute:cmdMethod});},changeFilterStackSelectors:function changeFilterStackSelectors(unitsToAdd,definitionsToDelete){var dataService=this.getDataService(),model=this,viMap=this.getVIMap(),stack=viMap.getComponent(VI_FILTER_STACK),forcePU=!!unitsToAdd.filter(function(unit){return !isUC(unit);}).length,keyContexts=[];this.execute({execute:function(){var update=dataService.newUpdate(this,{extras:REQUEST_DEFN_DATA}),refreshKeys={};refreshKeys[stack.contents.k]=true;getDeleteFilterActions.call(this,update,model,definitionsToDelete,refreshKeys);getExecAddFilterActions.call(model,update,keyContexts,unitsToAdd,stack.getFilters().length+1,refreshKeys);addFilterStackCallback.call(model,update,stack,refreshKeys,forcePU);if(definitionsToDelete.length&&unitsToAdd.length){this.submitUpdate(update,this.mgr.CMD_PHASE.FIRST);}else{this.submitUpdate(update);}}});},replaceFilterStackSelectors:function replaceFilterStackSelectors(selectorDefinition,unitToRaplace){var dataService=this.getDataService(),stack=this.getVIMap().getComponent(VI_FILTER_STACK),model=this,act=dataService.newUpdate(stack);if(stack.applyBufferedSlices){stack.applyBufferedSlices(true,act);}this.execute({execute:function(){var update=dataService.newUpdate(this,{extras:REQUEST_DEFN_DATA}),refreshKeys={};getReplaceFilterActions.call(model,update,selectorDefinition,unitToRaplace,stack,refreshKeys);addFilterStackCallback.call(model,update,stack,refreshKeys);this.urInfo=this.urInfo||{};this.urInfo.callback=update.callback;var actions=(act.actions||[]).concat(update.actions);this.submit(actions,update.callback,update.extras);}});},buildVisFilterContainer:function buildVisFilterContainer(panelStack,layoutKey){var model=this,panelNode=model.createNewUnitNode(null,function(defn){defn.t=$RW_UNIT_TYPES.PANEL;return defn;},null,null,layoutKey),builder=panelStack.builder,panel;panel=builder.build([panelNode],model,{pk:panelStack.k})[0];return panel;},getPanelStackForVFContainer:function getPanelStackForVFContainer(){return getVIVizPanel.call(this);},addVisFilterContainer:function addVisFilterContainer(){var model=this,layoutKey=model.getCurrentLayoutKey(),panelStack=model.getPanelStackForVFContainer(),panel=this.buildVisFilterContainer(panelStack,layoutKey);panelStack.selectedVisFilterContainerKey=panel.k;panelStack.addChildren(panel);panel.render();$CSS.addClass(panel.domNode,["vis-filter-container"]);panelStack.prevSelectedKey=panelStack.selectedKey;panelStack.set("selectedKey",panel.k);return panel;},removeVizFilterUnit:function removeVizFilterUnit(requireUpdate){var me=this,dataService=me.getDataService(),vizBox=me.getSelectedViUnit(),vizBoxKey=vizBox.k,action=me.getRemoveUnitAction(vizBox),lytUnits=me.getCurrentLayoutDef().units,stack=this.getVIMap().getComponent(VI_FILTER_STACK);this.execute({execute:function(){var update=dataService.newUpdate(me,{extras:REQUEST_DEFN_DATA}),visId=me.getSelectedViUnit().boxContent.id,refreshKeys={},panel=stack.contents,vis=mstrmojo.all[visId];refreshKeys[panel.k]=true;update.addActions(mstrmojo.array.ensureArray(action));lytUnits[vizBoxKey]._isDeleted=true;if(requireUpdate===true){addCancelVisFilterCallback.call(me,update,stack,vis,refreshKeys);}this.submitUpdate(update);}});},destroyVisualiztionselector:function destroyVisualiztionselector(vizBox,selectVIUNit,keepContainer){vizBox=vizBox||this.getSelectedViUnit();var viz=vizBox.boxContent,node=viz.node,container=this.getVisFilterContainer();vizBox.boxContent.srcFilterPortlet=null;if(container&&vizBox.parent===container){container.removeAndDestroyChild(vizBox);}else{vizBox.destroy();}if(!keepContainer){mstrApp.isInVFConfigMode=false;this.removeVisFilterContainer();}if(!selectVIUNit){this.selectVIUnit(this.oldSelectedVizBoxId,true);}node.id=this.restoreNodeId(node.id);viz.clearHighlightsCache();},getVisFilterContainer:function getVisFilterContainer(){var model=this,currentLayoutKey=model.getCurrentLayoutKey(),panelkey=model.getPanelStackForVFContainer().selectedVisFilterContainerKey,widgetId=model.getWidgetId({k:panelkey,wid:1},currentLayoutKey);return mstrmojo.all[widgetId];},removeVisFilterContainer:function removeVisFilterContainer(){var model=this,container=this.getVisFilterContainer(),panelStack;if(container){panelStack=model.getPanelStackForVFContainer();panelStack.set("selectedKey",panelStack.prevSelectedKey);panelStack.removeAndDestroyChild(container);panelStack.selectedVisFilterContainerKey=null;panelStack.prevSelectedKey=null;}},rebuildVizBox:function rebuildVizBox(nodeKey){this.destroyVisualiztionselector("",true,true);return this.insertVizBox(nodeKey,this.getVisFilterContainer(),{});},doVisFilterLayout:function doVisFilterLayout(vizBox,formatting){var panelStack=this.getPanelStackForVFContainer(),vizWidth=formatting.hasOwnProperty("width")?formatting.width:parseInt(panelStack.width)-VISFILTER_CON_SPACE,visHeight=formatting.hasOwnProperty("height")?formatting.height:parseInt(panelStack.height)-VISFILTER_CON_SPACE;vizBox.updateLayout({height:visHeight+"px",left:"0px",top:"0px",width:vizWidth+"px"});},insertVizBox:function insertVizBox(nodeKey,container,formatting){var vizBox=buildVizBox.call(this,nodeKey);container.addChildren([vizBox]);container.domNode.style.width=vizBox.domNode.style.width;return vizBox;},addVisualizationSelector:function addVisualizationSelector(container,mode,title){var me=this,dataService=me.getDataService(),layoutUnits=me.getCurrentLayoutDef().units,panelKey=$HASH.keyarray(layoutUnits).filter(function(key){return layoutUnits[key].t===$RW_UNIT_TYPES.PANEL&&layoutUnits[key].isFilterPanel;})[0];mstrApp.isInVFConfigMode=mode===$VIZ_SELECTOR_MODE.CONFIGURATION;mstrApp.isInVFInteractMode=mode===$VIZ_SELECTOR_MODE.INTERACTIVE;this.execute({execute:function(){var update=dataService.newUpdate(this,{extras:REQUEST_DEFN_DATA}),nodeKey=me.getNextKey();update.addActions(me.getAddVisActions(panelKey,nodeKey,{style:$WIDGET_STYLE.GRAPH_MATRIX,type:$WIDGET_TYPE.GRAPH_MATRIX,extraFormatting:{FormattingAppearance:{Visible:1,Name:title},FormattingView:{Title:title}}}));addVisFilterCallback.call(me,container,update,nodeKey);this.submitUpdate(update);}});},saveVisSelectorAndExit:function saveVisSelectorAndExit(){var viMap=this.getVIMap();this.destroyVisualiztionselector();this.controller.rootCtrl.restorePanelStatus(viMap.getComponent(VI_FILTER_STACK));},saveVisAsSelector:function saveVisAsSelector(){var me=this,dataService=me.getDataService(),viMap=me.getVIMap(),stack=viMap.getComponent(VI_FILTER_STACK);this.execute({execute:function(){var update=dataService.newUpdate(me,{extras:REQUEST_DEFN_DATA}),ctrlKey=me.getNextKey(),targetKeys=[viMap.getComponentKey($VI_TYPES.MAIN_CONTENT)],CGBKeys=[],visId=me.getSelectedViUnit().boxContent.id,refreshKeys={},panel=stack.contents,vis=mstrmojo.all[visId];refreshKeys[panel.k]=true;$ARR.forEach(targetKeys,function(){CGBKeys.push([me.getNextKey(),true]);});update.addActions(getAddVisFilterActions.call(me,targetKeys,vis,ctrlKey,CGBKeys));addSaveVisFilterCallback.call(me,update,stack,vis,ctrlKey,targetKeys,CGBKeys,refreshKeys);this.submitUpdate(update);}});},getMainPanelFormatting:function getMainPanelFormatting(){return getPanelFormatting.call(this,$VI_TYPES.MAIN_CONTENT);},getFilterPanelFormatting:function getFilterPanelFormatting(){return getPanelFormatting.call(this,$VI_TYPES.FILTER_STACK);},getVizBox:function getVizBox(nodeKey,formatting){var vizBox=buildVizBox.call(this,nodeKey);this.doVisFilterLayout(vizBox,formatting);return vizBox;},cachePrevSelectedUnitId:function cachePrevSelectedUnitId(){var oldSelectedUnit=this.getSelectedViUnit();if(oldSelectedUnit){this.oldSelectedVizBoxId=oldSelectedUnit.id;}},insertVisCtrlToolbar:function insertVisCtrlToolbar(container,props){var toolbar=new mstrmojo.vi.ui.rw.VisFilterControlToolbar(props);toolbar.render();container.domNode.appendChild(toolbar.domNode);return toolbar;},loadHiddenFilterStack:function loadHiddenFilterStack(builder,fnCallback){this.loadHiddenVIStack(PANEL_FILTER_STACK,FP_PATH,builder,fnCallback);},getNextVisFilterTitle:function getNextVisFilterTitle(){var layoutDef=this.getCurrentLayoutDef(),units=(layoutDef&&layoutDef.units)||{},visFilterCount=0;$HASH.forEach(units,function(defn){var nodeType=defn&&defn.t;if(defn&&defn.iifp&&(nodeType===$RW_UNIT_TYPES.GRID||nodeType===$RW_UNIT_TYPES.GRAPH||nodeType===$RW_UNIT_TYPES.GRIDGRAPH||nodeType===$RW_UNIT_TYPES.VISUALIZATION||nodeType===$RW_UNIT_TYPES.MOJOVISUALIZATION)){visFilterCount++;}});return mstrmojo.desc(15290,"Visualization Filter ##").replace("##",(visFilterCount+1));},checkLargeItemsForVisFilter:function checkAndWarnLargeItemsBeforeVisFilterRendering(nodeKey,onOk){var node=this.getNodeDataByKey(nodeKey),data=node&&node.data,$_CheckDataCards=mstrmojo.vi.models._CheckDataCards,allowItems=[];if(data&&data.gts){allowItems=(data.gts.row||[]).concat(data.gts.col||[]);}$_CheckDataCards.addAttributeNameAndTargetVisForAddUnits(data,allowItems);$_CheckDataCards.checkAndWarnLargeItemsForAddUnits(allowItems,onOk,null,false,null,true,null,function(){mstr_profile.log("Cancel Visualization Filter Rendering!");});}});}());