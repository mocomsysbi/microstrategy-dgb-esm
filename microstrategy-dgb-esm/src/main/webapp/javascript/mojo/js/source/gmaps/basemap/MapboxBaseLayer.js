(function(){mstrmojo.requiresCls("mstrmojo.gmaps.MapUtils","mstrmojo.gmaps.basemap.MapboxGLBaseLayer");var $GMAPS=mstrmojo.gmaps,$MUTIL=$GMAPS.MapUtils;var $API_VERSION="//api.mapbox.com/mapbox.js/v3.1.1",POS_NAVIGATOR="bottomright",EVENTS={"extent-change":"moveend","zoom-start":"zoomstart","zoom-end":"zoomend",load:"load"};mstrmojo.gmaps.basemap.MapboxBaseLayer=mstrmojo.declare(mstrmojo.gmaps.basemap.MapboxGLBaseLayer,null,{scriptClass:"mstrmojo.gmaps.basemap.MapboxBaseLayer",init:function init(props){this._super(props);this.jsURLs=[this.getURL($API_VERSION+"/mapbox.js")];this.cssUrl=this.getURL($API_VERSION+"/mapbox.css");},isLibLoaded:function isLibLoaded(){return !!(window.L&&typeof (L.Map)!=="undefined");},createMapObj:function createMapObj(){if(!window.L||!L.mapbox){console.log("Fail to load mapbox resources.");this.updateMapExtent();return ;}var config=this.getConfig(),defaultCenter=this.getDefaultCenter(),mapOptions={center:L.latLng(defaultCenter.lat,defaultCenter.lng),minZoom:this.minZoom,maxZoom:this.maxZoom,zoom:this.defaultZoom},map;L.mapbox.accessToken=config.token;map=this._baseMap=new L.mapbox.map(this.domId,undefined,mapOptions);this.navigationCtrl=map.zoomControl;this.navigationCtrl.setPosition(POS_NAVIGATOR);this.addEventListeners(EVENTS);this.updateMapExtent();this.setMapStyle(this.mapStyle);$MUTIL.hideWait();},handleMouseWheel:function handleMouseWheel(params){if(!params||!params.zoomDelta){return ;}var _baseMap=this._baseMap,geoPoint=this.pixelXYtoLatLng(params.position);if(!!_baseMap){_baseMap.setZoomAround(L.latLng(geoPoint.lat,geoPoint.lng),this.validateZoomLevel(_baseMap.getZoom()+params.zoomDelta));}},setExtent:function setExtent(geoExtent){var _baseMap=this._baseMap;if(_baseMap&&geoExtent){this._super(geoExtent);_baseMap.fitBounds(L.latLngBounds(L.latLng(geoExtent.latSouth,geoExtent.lngWest),L.latLng(geoExtent.latNorth,geoExtent.lngEast)));}},setCenter:function setCenter(geoPoint){var map=this._baseMap;if(map&&geoPoint&&$MUTIL.checkVal(geoPoint.lat)&&$MUTIL.checkVal(geoPoint.lng)){map.setView(new L.latLng(geoPoint.lat,geoPoint.lng));}},centerAndZoom:function centerAndZoom(geoPoint,zoomLevel){var map=this._baseMap;if(map&&geoPoint&&$MUTIL.checkVal(geoPoint.lat)&&$MUTIL.checkVal(geoPoint.lng)&&$MUTIL.checkVal(zoomLevel)){map.setView(new L.latLng(geoPoint.lat,geoPoint.lng),parseInt(zoomLevel));}},panBy:function panBy(offset){var map=this._baseMap;if(map&&offset&&$MUTIL.checkVal(offset.x)&&$MUTIL.checkVal(offset.y)){map.panBy([-offset.x,-offset.y],{animate:false});}},setMapStyle:function setMapStyle(dv){var _baseMap=this._baseMap;if(!_baseMap){return ;}dv=dv||this.getDefaultMapStyle();L.mapbox.styleLayer(dv).addTo(_baseMap);this.mapStyle=dv;},resize:function resize(width,height){this._super(width,height);var map=this._baseMap;if(map){map.invalidateSize();}},latLngToPixelXY:function latLngToPixelXY(point,needRaw){var _baseMap=this._baseMap,screenPoint;if(!_baseMap||!point||!$MUTIL.checkVal(point.lat)||!$MUTIL.checkVal(point.lng)){$MUTIL.log("Catch invalid point");return ;}screenPoint=_baseMap.latLngToContainerPoint(L.latLng(point.lat,point.lng));if(needRaw!==true){screenPoint=this.adjustPointInsideViewer(screenPoint,this._xCoordsMin);}if(screenPoint&&$MUTIL.checkVal(screenPoint.x)&&$MUTIL.checkVal(screenPoint.y)){return{x:parseInt(screenPoint.x),y:parseInt(screenPoint.y)};}},pixelXYtoLatLng:function pixelXYtoLatLng(pixel){var _baseMap=this._baseMap,latLng;if(!_baseMap||!pixel||!$MUTIL.checkVal(pixel.x)||!$MUTIL.checkVal(pixel.y)){$MUTIL.log("Catch invalid map/point/projection");return ;}latLng=_baseMap.containerPointToLatLng(L.point(pixel.x,pixel.y));if(latLng){return{lat:latLng.lat,lng:latLng.lng};}},showMapTools:function showMapTools(){var navigationCtrl=this.navigationCtrl=this.navigationCtrl||new L.control.zoom({position:POS_NAVIGATOR}),_baseMap=this._baseMap;if(_baseMap){navigationCtrl.addTo(_baseMap);}},hideMapTools:function hideMapTools(){var _baseMap=this._baseMap,navigationCtrl=this.navigationCtrl;if(_baseMap&&navigationCtrl){_baseMap.removeControl(navigationCtrl);}}});})();