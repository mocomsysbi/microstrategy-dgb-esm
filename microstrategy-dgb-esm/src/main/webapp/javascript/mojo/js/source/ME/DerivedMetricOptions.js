(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.Editor","mstrmojo.Box","mstrmojo.CheckBox","mstrmojo.Label","mstrmojo.Button");mstrmojo.requiresDescs(4531,8262,12437,12438,12439,15645);var HASH=mstrmojo.hash;var FBFlag={Automatic:0,Manual:3};var AFB={Automatic:-1,False:0,True:1};var SFB={Automatic:-1,False:1,True:2};var DEFAULT_MPS={mps:{afb:AFB.False,sfb:SFB.False,fbf:FBFlag.Automatic}};var MetricOptions=["mps"],setMetricProperty=function(p,v){var editor=this.parent.parent,cm=editor.cloneModel,mps=cm.mps||{};if(mps[p]!==v){mps[p]=v;if(p==="fbf"&&v===FBFlag.Manual){mps.afb=(mps.afb===AFB.Automatic)?AFB.False:mps.afb;mps.sfb=(mps.sfb===SFB.Automatic)?SFB.False:mps.sfb;}editor.set("dirty",true);}};var isNonAFB=function(mps){return mps&&mps.afb===AFB.False&&mps.sfb===SFB.False&&mps.fbf===FBFlag.Manual;};mstrmojo.ME.DerivedMetricOptions=mstrmojo.declare(mstrmojo.Editor,null,{scriptClass:"mstrmojo.ME.DerivedMetricOptions",cssClass:"mstrmojo-DerivedMetricOptions",dirty:false,init:function init(props){this._super(props);mstrmojo.css.addWidgetCssClass(this,"dme");},updateModel:function updateModel(){var m=this.model,cm=this.cloneModel,mps=cm.mps;if(mps.fbf===FBFlag.Automatic){mps.afb=AFB.Automatic;mps.sfb=SFB.Automatic;}else{if(mps.fbf===FBFlag.Manual){mps.afb=mps.afb===AFB.Automatic?AFB.False:mps.afb;mps.sfb=mps.sfb===SFB.Automatic?SFB.False:mps.sfb;}}mps.dirty=true;m.mps=cm.mps;},onOpen:function onOpen(){var cm=this.cloneModel||{};HASH.make(cm,mstrmojo.Obj);var m=mstrmojo.hash.copy(this.model,mstrmojo.hash.copy(DEFAULT_MPS)),i,len;for(i=0,len=MetricOptions.length;i<len;i++){cm.set(MetricOptions[i],HASH.clone(m[MetricOptions[i]]));}this.cloneModel=null;this.set("cloneModel",cm);},onClose:function onClose(){this.set("dirty",false);delete this.cloneModel;},children:[{scriptClass:"mstrmojo.HBox",alias:"fbFlagBox",cssClass:"mstrmojo-DerivedMetricOptions-aggBox",children:[{scriptClass:"mstrmojo.Label",cssText:"white-space: nowrap; margin-right: 8px; vertical-align: top;",text:mstrmojo.desc(12437,"Aggregation And Subtotal Behavior:")},{scriptClass:"mstrmojo.Pulldown",alias:"fbFlag",cssText:"min-width: 100px;",cssClass:"mstrmojo-ME-Pulldown",popupCssClass:"mstrmojo-ME-Pulldown-Popup",itemIdField:"v",items:[{n:mstrmojo.desc(4531,"Automatic"),v:FBFlag.Automatic},{n:mstrmojo.desc(8262,"Manual"),v:FBFlag.Manual}],bindings:{value:function(){return this.parent.parent.cloneModel.mps.fbf||FBFlag.Automatic;}},onvalueChange:function(evt){if(evt.value!==undefined&&evt.valueWas!==undefined){setMetricProperty.call(this,"fbf",evt.value);}}}]},{scriptClass:"mstrmojo.Box",cssText:"height: 30px",cssClass:"mstrmojo-DerivedMetricOptions-afbBox",children:[{scriptClass:"mstrmojo.CheckBox",alias:"afb",cssDisplay:"inline-block",label:mstrmojo.desc(12438,"Aggregate From Base"),bindings:{visible:function(){return this.parent.parent.fbFlagBox.fbFlag.value===FBFlag.Manual;},checked:function(){return this.parent.parent.cloneModel.mps.afb===AFB.True;}},onclick:function(evt){var fbFlag=this.parent.parent.fbFlagBox.fbFlag.value;setMetricProperty.call(this,"afb",fbFlag===FBFlag.Automatic?AFB.Automatic:(this.checked?AFB.True:AFB.False));}},{scriptClass:"mstrmojo.CheckBox",alias:"sfb",cssDisplay:"inline-block",label:mstrmojo.desc(12439,"Subtotals From Base"),oncheckedChange:function(evt){var afb=this.parent.afb;if(evt.value){if(!afb.checked){afb.checked=AFB.True;afb.onclick();}if(afb.inputNode){afb.inputNode.checked=true;afb.inputNode.disabled=true;}}else{if(afb.inputNode){afb.inputNode.disabled=false;}}},bindings:{visible:function(){return this.parent.parent.fbFlagBox.fbFlag.value===FBFlag.Manual;},checked:function(){return this.parent.parent.cloneModel.mps.sfb===SFB.True;}},onclick:function(){var fbFlag=this.parent.parent.fbFlagBox.fbFlag.value;setMetricProperty.call(this,"sfb",fbFlag===FBFlag.Automatic?SFB.Automatic:(this.checked?SFB.True:SFB.False));}}]},{scriptClass:"mstrmojo.HBox",alias:"buttonBar",slot:"buttonNode",cssClass:"mstrmojo-Editor-buttonBar",cellCssClass:"subBox",children:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-Editor-button mstrmojo-WebButton hot",alias:"saveokButton",text:mstrmojo.desc(2397,"OK"),bindings:{enabled:function(){return this.parent.parent.dirty;}},onclick:function(){var editor=this.parent.parent,derivedMetricEditor=editor&&editor.opener;var updateModel=function(){editor.updateModel();if(editor.onOK){editor.onOK();}editor.close();};var cm=editor.cloneModel,mps=cm&&cm.mps;if(isNonAFB(mps)&&derivedMetricEditor&&derivedMetricEditor.hasConditionFilter&&derivedMetricEditor.hasConditionFilter()){mstrmojo.warn(mstrmojo.desc(15645,"There is a filter defined for this metric, if you proceed this filter will be removed."),{confirmBtn:{t:mstrmojo.desc(212,"Continue"),fn:function confirm(){updateModel();derivedMetricEditor.clearConditionFilter();},hot:false},cancelBtn:{t:mstrmojo.desc(221,"Cancel"),fn:mstrmojo.emptyFn,hot:true}});}else{updateModel();if(derivedMetricEditor&&derivedMetricEditor.onMpsChange){derivedMetricEditor.onMpsChange();}}}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-Editor-button mstrmojo-WebButton",text:mstrmojo.desc(2399,"Cancel"),onclick:function(){var editor=this.parent.parent;editor.close();}}]}]});mstrmojo.ME.DerivedMetricOptions.isNonAFB=isNonAFB;}());