(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.gmaps.MapEnums","mstrmojo.gmaps.MapUtils","mstrmojo.gmaps.layer.MarkerLayer","mstrmojo.gmaps.graphic.PieBubbleGraphic");var $MOJO=mstrmojo,$ARR=$MOJO.array,$GMAPS=$MOJO.gmaps,$MUTIL=$GMAPS.MapUtils,$EnumPropertyType=$GMAPS.EnumPropertyType,$EnumMaxSizeType=$GMAPS.EnumMaxSizeType,$EnumMinSizeType=$GMAPS.EnumMinSizeType;var MAX_SIZE_DEFAULT_RATIO={"size-by":0.9,"no-size-by":0.2},MAX_SIZE_DEFAULT_RATIO_FOR_PIE_BUBBLE={"size-by":0.9,"no-size-by":0.5},MIN_SIZE_DEFAULT_RATIO=0.2,ITEM_MAX_SIZE_BASE=50,FULL_RANGE_ITEM_MIN_SIZE=4,ENABLE_MAX_MIN_SIZE_CONTROL=$GMAPS.ENABLE_MAX_MIN_SIZE_CONTROL,DEFAULT_RADIUS=10,DEFAULT_RADIUS_FOR_PIE_BUBBLE=25,FIXED_SIZE_FOR_NEGATIVE_VALUE=3.5;mstrmojo.gmaps.layer.BubbleLayer=mstrmojo.declare(mstrmojo.gmaps.layer.MarkerLayer,null,{scriptClass:"mstrmojo.gmaps.layer.BubbleLayer",isPieBubble:null,initParams:function initParams(){this.maxRadius=ITEM_MAX_SIZE_BASE;this.minRadius=FULL_RANGE_ITEM_MIN_SIZE;this.maxSizeInRWD=undefined;this.sizedAtFixedVal=false;this.useAbsolute=!ENABLE_MAX_MIN_SIZE_CONTROL;this.minMaxMap=null;this.maxMinDataRange=null;this.maxMinSizeRange=null;this.supportImgThreshold=null;this._super();this.isPieBubble=$ARR.isArray(this.sliceAttrIdxs)&&this.sliceAttrIdxs.length>0;},loadLayerProps:function loadLayerProps(layerProps){this._super(layerProps);if(!this.primaryModel){return ;}if(layerProps[$EnumPropertyType.maxBubbleSize]!=undefined){this.maxSizeInRWD=parseInt(layerProps[$EnumPropertyType.maxBubbleSize],10)/2;}if(layerProps[$EnumPropertyType.useAbsolute]!=undefined){this.useAbsolute=(layerProps[$EnumPropertyType.useAbsolute]==="0");this.sizedAtFixedVal=(layerProps[$EnumPropertyType.useAbsolute]==="1");}},switchMaxMinOption:function switchMaxMinOption(){this.maxMinDataRange=null;this.maxMinSizeRange=null;this.initMaxMinSizeRange();this.destroyAllGraphics();if(this.map&&this.map.excludeData){return ;}this.buildGraphics(this.shapeInfoArr);this.updateGraphics();},getMaxMinSizeType:function getMaxMinSizeType(propName){var layerProps=this.layerProps;if(layerProps[propName]===undefined){layerProps[propName]=propName===$EnumPropertyType.MAX_SIZE_TYPE?$EnumMaxSizeType.AUTOMATIC:$EnumMinSizeType.PROPORTIONAL;}return parseFloat(layerProps[propName]);},getMaxMinSizeValue:function getMaxMinSizeValue(propName,sizeType){var layerProps=this.layerProps;if(propName===$EnumPropertyType.MAX_SIZE_VALUE){if(sizeType===$EnumMaxSizeType.MANUAL&&layerProps[propName]){return parseFloat(layerProps[propName]);}if(this.isPieBubble){return MAX_SIZE_DEFAULT_RATIO_FOR_PIE_BUBBLE[this.hasSizeByMetric()?"size-by":"no-size-by"];}return MAX_SIZE_DEFAULT_RATIO[this.hasSizeByMetric()?"size-by":"no-size-by"];}else{if(sizeType===$EnumMinSizeType.ADJUSTED_RANGE&&layerProps[propName]){return parseFloat(layerProps[propName]);}return MIN_SIZE_DEFAULT_RATIO;}},initMaxMinDataRange:function initMaxMinDataRange(isProportional){var realDataRange=this.minMaxMap[this.sizeMetricIdx],min=realDataRange.min,max=realDataRange.max,absMax=realDataRange.absMax,absMin=realDataRange.absMin;if(this.useAbsolute||isProportional){this.maxMinDataRange={min:absMin,max:absMax};}else{this.maxMinDataRange={min:min,max:max};}},initMaxMinSizeRange:function initMaxMinSizeRange(){var maxSizeType=this.getMaxMinSizeType($EnumPropertyType.MAX_SIZE_TYPE),maxSizeVal=this.getMaxMinSizeValue($EnumPropertyType.MAX_SIZE_VALUE,maxSizeType),minSizeType=this.getMaxMinSizeType($EnumPropertyType.MIN_SIZE_TYPE),minSizeVal=this.getMaxMinSizeValue($EnumPropertyType.MIN_SIZE_VALUE,minSizeType),areaProportional=false,minRadius=FULL_RANGE_ITEM_MIN_SIZE,maxSize=this.maxSizeInRWD!==undefined?this.maxSizeInRWD:maxSizeVal*this.maxRadius,minSize,vMax,vMin;if(this.hasSizeByMetric()){this.initMaxMinDataRange(minSizeType===$EnumMinSizeType.PROPORTIONAL);vMax=this.maxMinDataRange.max;vMin=this.maxMinDataRange.min;switch(minSizeType){case $EnumMinSizeType.PROPORTIONAL:if(vMax===0){minSize=minRadius;}else{minSize=maxSize*Math.sqrt(vMin/vMax);}areaProportional=true;break;case $EnumMinSizeType.FULL_RANGE:minSize=minRadius;break;case $EnumMinSizeType.ADJUSTED_RANGE:minSize=maxSize*minSizeVal;break;default:minSize=minRadius;break;}}else{minSize=maxSize;}if(maxSize<minRadius){maxSize=minRadius;}if(minSize<minRadius){minSize=minRadius;}this.maxMinSizeRange={min:minSize,max:maxSize,area:areaProportional};},buildGraphics:function buildGraphics(shapeInfoArr){if(this.map&&this.map.excludeData){return ;}this.initMaxMinSizeRange();this._super(shapeInfoArr);},buildGraphic:function buildGraphic(shapeInfo){var attributes=shapeInfo&&shapeInfo.attributes,radius=this.getBubbleRadius(shapeInfo),slices=attributes&&attributes.slices;if(attributes&&radius){attributes.radius=radius;}if(this.isPieBubble){attributes.clusterCount=slices.length;return new $GMAPS.graphic.PieBubbleGraphic({parent:this,attributes:attributes,points:slices,geoData:shapeInfo.geoData});}else{return this._super(shapeInfo);}},sliceEnabled:function(){return this.sliceAttrIdxs.length>0;},getBubbleRadius:function getBubbleRadius(graphic){if(!graphic){return ;}var attributes=graphic.attributes,cellNumber=attributes&&attributes.sizeByMetricVal;return ENABLE_MAX_MIN_SIZE_CONTROL?this._calculateBubbleRadius(cellNumber):this._calculateBubbleRadiusWithoutMaxMinCtrl(cellNumber);},_calculateBubbleRadius:function _calculateBubbleRadius(value){if(!this.maxMinSizeRange){return ;}var radius,ratio,vMax,vMin,maxMinSizeRange=this.maxMinSizeRange,maxMinDataRange=this.maxMinDataRange,sMax=maxMinSizeRange.max,sMin=maxMinSizeRange.min,useAreaProportional=maxMinSizeRange.area;if(!maxMinDataRange){return sMin;}value=$MUTIL.checkVal(value)?value:0;if(value<0){if(this.sizedAtFixedVal){return FIXED_SIZE_FOR_NEGATIVE_VALUE;}if(this.useAbsolute||useAreaProportional){value=Math.abs(value);}}vMax=maxMinDataRange.max;vMin=maxMinDataRange.min;if(vMin===vMax){radius=sMax;}else{ratio=(value-vMin)/(vMax-vMin);if(useAreaProportional){ratio=Math.sqrt(ratio);}radius=sMin+(sMax-sMin)*ratio;}return radius;},_calculateBubbleRadiusWithoutMaxMinCtrl:function _calculateBubbleRadiusWithoutMaxMinCtrl(value){if(!this.hasSizeByMetric()){return this.isPieBubble?DEFAULT_RADIUS_FOR_PIE_BUBBLE:DEFAULT_RADIUS;}if(isNaN(value)){return FULL_RANGE_ITEM_MIN_SIZE;}if(value<0){if(this.useAbsolute!==true){return FULL_RANGE_ITEM_MIN_SIZE;}else{value=Math.abs(value);}}return Math.max(this.maxRadius*Math.sqrt(value/this.maxMinDataRange.max),FULL_RANGE_ITEM_MIN_SIZE);}});}());