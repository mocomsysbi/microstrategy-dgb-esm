(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.VisEnum","mstrmojo.gmaps.MapEnums","mstrmojo.gm.GMEnums");var $ARR=mstrmojo.array,$VIS_ENUM=mstrmojo.VisEnum,$EnumPropertyType=mstrmojo.gmaps.EnumPropertyType,PRP_LEGEND_SLOT=mstrmojo.gm.EnumLegendSlot,ENUM_LEGEND_MODE=$VIS_ENUM.EnumLegendMode,LEGEND_PROPERTY=$VIS_ENUM.LegendPropertyTag,LEGEND_SPACING=10,dockedPositions=[{pos:PRP_LEGEND_SLOT.LEFT_TOP},{pos:PRP_LEGEND_SLOT.LEFT_MIDDLE},{pos:PRP_LEGEND_SLOT.LEFT_BOTTOM},{pos:PRP_LEGEND_SLOT.RIGHT_TOP},{pos:PRP_LEGEND_SLOT.RIGHT_MIDDLE},{pos:PRP_LEGEND_SLOT.RIGHT_BOTTOM}];mstrmojo.gmaps._MapLegendConHelper=mstrmojo.provide("mstrmojo.gmaps._MapLegendConHelper",{_mixinName:"mstrmojo.gmaps._MapLegendConHelper",updateLegendConWidth:function(){this.legendCon.width=this.legendCon.domNode.clientWidth;this.legendCon.height=this.legendCon.domNode.clientHeight;},updateLegendConSize:function(legendSize){var me=this,graphicLayerKeys=me.layerIdxMappingArr,graphicLayer,editingLayerKey=me.key,lgdWidth=legendSize.width,conWidth=me.legendCon.width||0;if(conWidth>lgdWidth){graphicLayer=me.getGraphicLayer(editingLayerKey);if(graphicLayer){graphicLayer.legendW=legendSize.width=conWidth-LEGEND_SPACING;}}else{$ARR.forEach(graphicLayerKeys,function(key){if(key!==editingLayerKey){graphicLayer=me.getGraphicLayer(key);if(graphicLayer&&graphicLayer.legend&&graphicLayer.legend.domNode.style.display==="block"){graphicLayer.legend.domNode.style.width=lgdWidth+"px";graphicLayer.legendW=lgdWidth;}}});conWidth=lgdWidth+LEGEND_SPACING;}this.legendCon.width=conWidth;this.legendCon.height=this.legendCon.domNode.clientHeight+legendSize.height;},insertAfter:function insertAfter(newEl,targetEl){var parentEl=targetEl.parentNode,v;(v=targetEl.nextSibling)?parentEl.insertBefore(newEl,v):parentEl.appendChild(newEl);},reorderLegendItems:function reorderLegendItems(){var me=this,layerIdxMappingArr=me.layerIdxMappingArr,layer,node,lgdConNode=me.legendCon&&me.legendCon.legendContainer,lgdItems=lgdConNode&&lgdConNode.childNodes,nodeToInsertAfter,layerWithoutLegendCnt=0;if(lgdItems&&lgdItems.length>1){$ARR.forEach(layerIdxMappingArr,function(layerKey,idx){layer=me.getGraphicLayer(layerKey);if(layer&&layer.legend){node=document.getElementById(layerKey+"-legend");lgdConNode.removeChild(node);if(idx-layerWithoutLegendCnt===0){lgdConNode.insertBefore(node,lgdConNode.firstChild);}else{me.insertAfter(node,nodeToInsertAfter);}nodeToInsertAfter=node;}else{layerWithoutLegendCnt++;}});}},appendNewLegendNode:function(parentNode,node,layerKey){var layerKeyArr=this.layerIdxMappingArr,layerKeyIdx,keyToInsertAfter,layerIdx,nodeIDToInsert,nodeToInsert;$ARR.forEach(layerKeyArr,function(key,idx){if(key===layerKey){layerIdx=idx;return false;}});if(layerIdx>=1){for(layerKeyIdx=layerIdx-1;layerKeyIdx>=0;layerKeyIdx--){var layer=this.getGraphicLayer(layerKeyArr[layerKeyIdx]);if(layer&&layer.legend){keyToInsertAfter=layerKeyArr[layerKeyIdx];break;}}}if(keyToInsertAfter){nodeIDToInsert=keyToInsertAfter+"-legend";nodeToInsert=document.getElementById(nodeIDToInsert);this.insertAfter(node,nodeToInsert);}else{nodeToInsert=parentNode.firstChild;parentNode.insertBefore(node,nodeToInsert);}},getLegendConDockedPosition:function(){var legendCon=this.legendCon,docPos=legendCon&&legendCon.dockedPositions;return docPos&&docPos[legendCon.currDockedPositionIdx];},updateLegendConSpitter:function updateLegendConSpitter(){var lgdCon=this.legendCon;lgdCon.height=lgdCon.domNode.clientHeight;lgdCon.updateSplitter();},onLegendDropped:function(legendDockPos){this.writeProperties(LEGEND_PROPERTY.LEGEND_POSITION,legendDockPos,this.getGridKey());},getLegendConDisplayStyle:function(){var lgdCon=this.legendCon;return lgdCon&&lgdCon.domNode.style.display;},setLegendConDisplayStyle:function(displayStyle){var lgdCon=this.legendCon;if(lgdCon){lgdCon.domNode.style.display=displayStyle;}},getLegendDockPosIdx:function(pos){var i,posLength=dockedPositions.length;for(i=0;i<posLength;i++){if(pos===dockedPositions[i].pos){return i;}}return 4;},attachLegendConListeners:function(){var me=this,id=me.id,legendCon=me.legendCon;if(legendCon){me.legendClickListener=legendCon.attachEventListener("gm-legend-clicked",id,function(evt){switch(evt.action){case"close":me.handleLegendConCloseChange($EnumPropertyType.legendSwitch,false);me.legendCon.domNode.style.display="none";break;case"minimize":me.handleLegendConStatusChange(LEGEND_PROPERTY.LEGEND_MODE,ENUM_LEGEND_MODE.MINIMIZED);break;case"restore":me.handleLegendConStatusChange(LEGEND_PROPERTY.LEGEND_MODE,ENUM_LEGEND_MODE.RESTORED);break;}});me.legendResizeListener=legendCon.attachEventListener("gm-legend-resized",id,function(evt){me.handleLegendConStatusChange(LEGEND_PROPERTY.SCALE_LEGEND_WIDTH,evt.position);});}}});}());