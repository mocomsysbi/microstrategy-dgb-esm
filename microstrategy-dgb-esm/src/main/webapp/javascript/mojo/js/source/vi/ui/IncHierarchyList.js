(function(){mstrmojo.requiresClsP("mstrmojo","css","array","desc","dom","string");mstrmojo.requiresCls("mstrmojo.ui.List","mstrmojo.ui._HasScroller","mstrmojo.ui._IsHierarchyList","mstrmojo.ui._IsIncFetchHierarchyList","mstrmojo.vi.ui._HasUnitListAvatar","mstrmojo.vi.ui._IsDropTarget","mstrmojo.vi.ui._IsDraggableList","mstrmojo.elementHelper");mstrmojo.requiresDescs(15595);var $CSS=mstrmojo.css,$ARR=mstrmojo.array,$DESC=mstrmojo.desc,$DOM=mstrmojo.dom,$STR=mstrmojo.string,$EH=mstrmojo.elementHelper;var DROP_AREA="dragIn";var CSS_HIDDEN="hidden",CSS_SELECTED="selected",CSS_EXPANDED="iconRA-expanded",CSS_COLLAPSED="iconRA-collapsed",CSS_HIERARCHY="hierarchy",CSS_HAS_CHILDREN="hasChildren",CSS_DISABLED="d",CSS_EXCLUDED="x";var ELEM_ALL_ID="u;",LEVEL_INDENT=10;function getShortIDForPE(v){var v=$EH.terseLong2OldShort(v)||"",chunks=v.split(":");return chunks.slice(chunks.length-2).join(":");}mstrmojo.vi.ui.IncHierarchyList=mstrmojo.declare(mstrmojo.ui.ScrollableList,[mstrmojo._HasOwnAvatar,mstrmojo.vi.ui._HasUnitListAvatar2,mstrmojo.vi.ui._IsDropTarget,mstrmojo.ui._IsHierarchyList,mstrmojo.ui._IsIncFetchHierarchyList,mstrmojo.vi.ui._IsDraggableList],{scriptClass:"mstrmojo.vi.ui.IncHierarchyList",cssClass:"mstrmojo-IncHierarchyList",getItemMarkup:function getItemMarkup(item,idx){var mu;if(item.fetcher){mu=this._super(item,idx);}else{mu='<{@tag} class="item {@cls}" idx="{@idx}" style="{@style}" title="{@tt}"><div class="content"><span class="indent" style="padding-left: {@indent}px;"></span><span class="raBtn {@epdsts}"></span><span class="text">{@en@n}</span></div><div class="btn {@disabled}">'+$STR.encodeHtmlString($DESC(15595,"Set Parent"))+"</div></{@tag}>";}return mu;},isParentElement:function isParentElement(item){var v=item&&item.v,pe=this.getCurrentPE();return pe&&getShortIDForPE(pe.v)===v;},getItemProps:function getItemProps(item,idx){var props=this._super(item,idx);if(this.isHiearachyDisplay()){props.epdsts=item.hcd?(item.epd?CSS_EXPANDED:CSS_COLLAPSED):"";}props.disabled=!this.canSetAsParent(item)?CSS_DISABLED:"";var excluded=this.getExcludeList();if(excluded&&excluded[item.v]){props.addCls(CSS_EXCLUDED);item.x=true;}return props;},canSetAsParent:function canSetAsParent(item){return !this.isParentElement(item)&&!item.ln;},onclick:function onclick(evt){var target=evt.getTarget(),itemNode=this.getItemNodeFromTarget(target),item=this.getItemFromTarget(target);if(!item){return ;}if($CSS.hasClass(target,"raBtn")){if(item.hcd){this.doExpandCollapse(itemNode,item);}}else{if($CSS.hasClass(target,"btn")&&this.canSetAsParent(item)){var oldPE=this.getCurrentPE(),oldPEValue=getShortIDForPE(oldPE&&oldPE.v),oldPEInItems=this.itemMap[oldPEValue],oldPENode=oldPEInItems&&this._getItemNode(oldPEInItems.idx);this.handleSetParent(item);$CSS.toggleClass(oldPENode&&oldPENode.getElementsByClassName("btn")[0],CSS_DISABLED,oldPEInItems&&!this.canSetAsParent(oldPEInItems));$CSS.toggleClass(itemNode.getElementsByClassName("btn")[0],CSS_DISABLED,true);}else{this._super(evt);}}evt.cancel();},oncontextmenu:function oncontextmenu(evt){$DOM.preventDefault(window,evt.e);},toggleCollapseExpandCss:function toggleCollapseExpandCss(itemNode,isExpanding){var raBtnNode=itemNode.getElementsByClassName("raBtn")[0];$CSS.toggleClass(raBtnNode,CSS_COLLAPSED,!isExpanding);$CSS.toggleClass(raBtnNode,CSS_EXPANDED,isExpanding);},getSelectedItems:function getSelectedItems(){var items=this._super();return $ARR.filter(items,function(item){return !item.x;});},processContinuousSelection:function processContinuousSelection(adding,removing,idx){var foundStartNode,foundEndNode,rangeStartIndex=this._shiftStartIndex,selectedIndices=this.selectedIndices;$ARR.forEach(this.itemsContainerNode.children,function(itemNode){var i=parseInt(itemNode.getAttribute("idx"));if(i===idx||i===rangeStartIndex){if(!foundStartNode){foundStartNode=true;}else{foundEndNode=true;}}if(foundStartNode&&!itemNode.classList.contains("x")&&!itemNode.classList.contains("hidden")&&!this.items[i].fetcher&&!selectedIndices[i]){adding.push(i);}return !(foundStartNode&&foundEndNode);},this);},handleSetParent:mstrmojo.emptyFn,getExcludeList:mstrmojo.emptyFn,getCurrentPE:mstrmojo.emptyFn,isDragValid:function isDragValid(context){var ret=this._super(context);if(ret&&this.isDraggingItem(context)){if(this.isItemDraggable(context.src.node)){var item=this.getItemFromTarget(context.src.node);if(!this.selectedIndices[item.idx]){this.doItemSelect(item,{});context.src.data.items=[item];context.src.data.item=item;}return true;}else{return false;}}return ret;},adjustPosition:mstrmojo.emptyFn,isDraggingItem:function isDraggingItem(context){var node=$DOM.findAncestorByAttr(context.src.node,"idx",true,this.itemsContainerNode);return node&&node.node.className.indexOf("item")>=0;},isItemDraggable:function isItemDraggable(node){if(node){return !this.isFetcher(node)&&!this.isExcluded(node);}},isExcluded:function isExcluded(target){if(target instanceof HTMLElement){target=this.getItemFromTarget(target);}return target&&target.x;},ondrop:function ondrop(context){$CSS.removeClass(this.domNode,DROP_AREA);this.processDrop(context);context.src.data.isDropSuccess=true;},processDragStart:mstrmojo.emptyFn,processDrop:mstrmojo.emptyFn,processDragEnd:mstrmojo.emptyFn,});}());