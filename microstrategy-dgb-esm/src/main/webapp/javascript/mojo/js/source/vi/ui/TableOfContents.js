(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo._HasLayout","mstrmojo.dom","mstrmojo.css","mstrmojo.Box","mstrmojo.Label","mstrmojo.VBox","mstrmojo.func","mstrmojo.array","mstrmojo.vi._MonitorsAppState","mstrmojo.vi.controllers.EnumLayoutManipulationType","mstrmojo.vi.controllers.EnumPanelManipulationType","mstrmojo.vi.controllers.EnumEvents","mstrmojo.vi.models.VIComponentMap.TYPES","mstrmojo.vi.models.EnumDragSources","mstrmojo.vi.ui.toolbars._HasToolbar","mstrmojo.util.ui._HostsSplitter","mstrmojo._CanWSItemDragandDrop");mstrmojo.requiresClsP("mstrmojo.ui","_HasScroller","ScrollableList","Pulldown");mstrmojo.requiresClsP("mstrmojo.ui.menus","_HasMenuPopup","MenuConfig","ToolbarConfig");mstrmojo.requiresClsP("mstrmojo.vi.ui","_IsDropTarget","_IsViPanel","_HasMask","PanelContents","PanelPortlet","DatasetPortlet","DatasetTableView","DatasetMDXView","DatasetUnitList","TableOfContentsChapterPortlet","TableOfContentsUnitList","CollapsibleTitleBar","CoverPageWidget");mstrmojo.requiresDescs(14917,14918,14919);var $ARR=mstrmojo.array,$CSS=mstrmojo.css,$DOM=mstrmojo.dom;var CHAPTER_PREFIX="TOC_Chapter_",LAYOUT_MANIPULATION_TYPE=mstrmojo.vi.controllers.EnumLayoutManipulationType,PANEL_MANIPULATION_TYPE=mstrmojo.vi.controllers.EnumPanelManipulationType,EVENTS=mstrmojo.vi.controllers.EnumEvents,VI_TYPES=mstrmojo.vi.models.VIComponentMap.TYPES,LAYOUT_SELECTOR_POSITION=mstrmojo.vi.controllers.EnumLayoutSelectorPosition,ENUM_SOURCE=mstrmojo.vi.models.EnumDragSources;var TOC_MAX_WIDTH=300,TOC_MIN_WIDTH=162;function generateChapterPortlets(){var data=this.data,children=[],portlet,panelId=this.id,panel=this,chapterCount=data&&data.length,pageCount=0;this.chapterCount=chapterCount;$ARR.forEach(data,function(chapter,index){portlet=this.getChapterPorlet(chapter,panel,panelId,index,chapterCount);children.push(portlet);pageCount+=(chapter.panels||[]).length;},this);this.pageCount=pageCount;var datasetsContainer=this.contents;var oldChildren=[].concat(datasetsContainer.children||[]);datasetsContainer.removeChildren();oldChildren.forEach(function(oldChild){oldChild.destroy();});datasetsContainer.addChildren(children);this.doLayout();this.previousDisplayPageInfo=null;this.ondisplayPageInfoChange();}function delayUpdateScrollbars(){var me=this;window.setTimeout(function(){me.updateScrollbars();},0);}function addIcon(cls){var displayPageInfo=this.displayPageInfo,currentPageKey=displayPageInfo&&displayPageInfo.panelKey,currentChapterKey=displayPageInfo&&displayPageInfo.layoutKey,chapterPanel=this.getChapterPanel(currentChapterKey),items,idx;if(chapterPanel){items=chapterPanel.ulist.items;idx=$ARR.find(items,"k",currentPageKey);if(idx!==-1){$CSS.addClass(chapterPanel.ulist._getItemNode(idx),cls);}}}function removeIcon(cls){var ulist;$ARR.forEach(this.contents.children,function(chapter){ulist=chapter.ulist;$ARR.forEach(ulist.items,function(item,idx){$CSS.removeClass(ulist._getItemNode(idx),cls);});});}function getDragSourceFrom(context){var dragData=context&&context.src&&context.src.data;return dragData&&dragData.src;}mstrmojo.vi.ui.TableOfContents=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasLayout,mstrmojo.ui.menus._HasMenuPopup,mstrmojo.vi.ui._IsDropTarget,mstrmojo.vi.ui._IsViPanel,mstrmojo.util.ui._HostsSplitter,mstrmojo.ui._HasScroller,mstrmojo.vi.ui._HasMask,mstrmojo.vi.ui.toolbars._HasToolbar,mstrmojo.vi._MonitorsAppState,mstrmojo._CanWSItemDragandDrop],{scriptClass:"mstrmojo.vi.ui.TableOfContents",markupString:'<div id="{@id}" class="mstrmojo-VIPanel mstrmojo-TableOfContents {@cssClass}" style="{@cssText}"><div class="mstrmojo-VIPanel-titlebar content"></div><div class="mstrmojo-TOC-coverpage"></div><div class="mstrmojo-VIPanel-content-wrapper" style="overflow:hidden;" mstrAttach:contextmenu><div class="mstrmojo-VIPanel-content"><div class="chapter-dnd-indicator"><div class="line"></div></div></div></div><div class="mstrmojo-NavigationBox-WSDND-overlay"></div><div class="mstrmojo-VIDND-mask"></div><div class="mstrmojo-VIPanel-handle splitter v"></div></div>',markupSlots:{titlebarNode:function titlebarNode(){return this.domNode.firstChild;},coverPageNode:function coverPageNode(){return this.domNode.childNodes[1];},containerNode:function containerNode(){return this.domNode.childNodes[2].firstChild;},wsItemdndNode:function wsItemdndNode(){return this.domNode.childNodes[3];},maskNode:function maskNode(){return this.domNode.childNodes[4];},handleNode:function handleNode(){return this.domNode.lastChild;},chapterDnDIndicatorNode:function chapterDnDIndicatorNode(){return this.domNode.childNodes[2].firstChild.firstChild;}},markupMethods:{ondataChange:function ondataChange(){generateChapterPortlets.call(this);this.updateChapterAndPageCount();},onvisibleChange:function onvisibleChange(){this.domNode.style.display=(this.visible)?this.cssDisplay:"none";if(this.visible){this.ondisplayPagePositionChange(this.displayPageInfo);this.generateToolbar();this.raiseEvent({name:"showPanel"});}}},model:null,width:"auto",titleBar:null,titlebarNode:null,containerNode:null,maskNode:null,contents:null,coverPage:null,data:null,chapterCount:0,pageCount:0,title:mstrmojo.desc(14917,"CONTENTS"),displayPageInfo:null,previousDisplayPageInfo:null,layoutConfig:{h:{titlebarNode:"26px",coverPageNode:"49px",containerNode:"100%"},w:{titlebarNode:"100%",coverPageNode:"100%",containerNode:"100%"},xt:true},children:[{scriptClass:"mstrmojo.vi.ui.CollapsibleTitleBar",slot:"titlebarNode",alias:"titleBar",editTitleOnDoubleClick:false,close:function close(){},onclick:function(){},bindings:{title:"this.parent.title"}},{scriptClass:"mstrmojo.vi.ui.CoverPageWidget",alias:"coverPage",slot:"coverPageNode"},{scriptClass:"mstrmojo.vi.ui.PanelContents",alias:"contents",slot:"containerNode"}],lastDragOverInfo:null,allowManipulation:true,onContentPanelVisibilityChange:function onContentPanelVisibilityChange(evt){var model=this.model,rootCtrl=mstrApp.rootCtrl,selectorPosition=model.tsp;if(selectorPosition===LAYOUT_SELECTOR_POSITION.LEFT){rootCtrl.setPanelDisplay("tocPanel",evt.visible);}},postBuildRendering:function postBuildRendering(){var handleNode=this.handleNode;handleNode.style.display="block";this.registerSplitter(handleNode);return this._super();},setDimensions:function setDimensions(h,w){this._super(h,w);var handleNode=this.handleNode,handleStyle=handleNode&&handleNode.style;if(handleStyle){handleStyle.display=mstrApp.isAppStatePresentation()?"none":"block";handleStyle.top=0;handleStyle.left=w;handleStyle.height=h;handleStyle.width="6px";}this.ondisplayPagePositionChange(this.displayPageInfo);},getSplitterInfo:function getSplitterInfo(){return{min:TOC_MIN_WIDTH,max:TOC_MAX_WIDTH};},splitterMoved:function splitterMoved(position){var prop="width",value=parseInt(this[prop],10)+position+"px";this.set(prop,value);this.parent.doLayout();var panelSaver=this.getPanelSaver();if(panelSaver){panelSaver.saveProperty("size",value);}},init:function init(props){this._super(props);var model=this.model,objInfo=model&&model.objInfo,iconPath=objInfo&&objInfo.icp;this.coverPage.set("modelId",model.id);if(iconPath){this.coverPage.set("imageUrl",iconPath);}this.allowManipulation=mstrApp.allowWebDashboardDesign();},refresh:function refresh(){this._super();this.previousDisplayPageInfo=null;this.ondisplayPageInfoChange();this.generateToolbar();},onAppStateChange:function(evt){if(this._super){this._super(evt);}this.allowManipulation=mstrApp.isAppStateDefault()&&mstrApp.allowWebDashboardDesign();this.set("isMasked",mstrApp.isAppStateSelection());this.generateToolbar();},oncontextmenu:function oncontextmenu(evt){if(this.shouldShowCustomizeContextMenu()){var menuConfig=this.addContextMenuItems(new mstrmojo.ui.menus.MenuConfig({position:$DOM.getMousePosition(evt.e,evt.hWin),isHostedWithin:false}),evt);if(menuConfig.hasMenuItems()){$DOM.preventDefault(window,evt.e);this.openPopup(menuConfig.newInstance());}}},shouldShowCustomizeContextMenu:function shouldShowCustomizeContextMenu(){return this.allowManipulation;},addContextMenuItems:function addContextMenuItems(menuCfg){var model=this.model,layoutKey=model.getCurrentLayoutKey(),stack=model.getVIComponent(VI_TYPES.VIZ_CONTENT,layoutKey),panelStackKey=stack.k;menuCfg.addMenuItem(mstrmojo.desc(14918,"Insert Chapter"),"",function(){model.raiseEvent({name:EVENTS.MANIPULATE_LAYOUT,type:LAYOUT_MANIPULATION_TYPE.NEW});});menuCfg.addMenuItem(mstrmojo.desc(14919,"Insert Page"),"",function(){model.raiseEvent({name:EVENTS.MANIPULATE_PANEL,type:PANEL_MANIPULATION_TYPE.NEW,layoutKey:layoutKey,panelStackKey:panelStackKey});});return menuCfg;},setupScrollNodes:function setupScrollNodes(){this.scrollNode=this.containerNode;},addPopupHandlers:function addPopupHandlers(config,fnOpen,fnClose){config.addPopupHandlers(this.id,fnOpen,fnClose);},getPanelSelectedItems:function getPanelSelectedItems(){var contents=this.contents;var items=[];$ARR.forEach(this.data,function(chapter){var porlet=contents[CHAPTER_PREFIX+chapter.k];items=items.concat(porlet.getSelectedItems());});return items;},getChapterPorlet:function getChapterPorlet(chapter,panel,panelId,index,count){var me=this,oldChapterPanel=this.getChapterPanel(chapter.k);return new mstrmojo.vi.ui.TableOfContentsChapterPortlet({title:chapter.title,panelId:panelId,alias:CHAPTER_PREFIX+chapter.k,chapterKey:chapter.k,panelStackKey:chapter.panelStackKey,chapter:chapter,index:index,chapterCnt:count,isCollapsed:oldChapterPanel?!!oldChapterPanel.isCollapsed:false,children:[{scriptClass:"mstrmojo.vi.ui.TableOfContentsUnitList",alias:"ulist",chapter:chapter,panelId:panelId}],onisCollapsedChange:function onisCollapsedChange(){delayUpdateScrollbars.call(me);}});},getChapterPanel:function(chapterKey){return this.contents[CHAPTER_PREFIX+chapterKey];},ondisplayPageInfoChange:function ondisplayPageInfoChange(){var displayPageInfo=this.displayPageInfo,pageKey=displayPageInfo&&displayPageInfo.panelKey,chapterKey=displayPageInfo&&displayPageInfo.layoutKey,previousDisplayPageInfo=this.previousDisplayPageInfo,previousDisplayChapterKey=previousDisplayPageInfo&&previousDisplayPageInfo.layoutKey,previousChapterPanel=this.getChapterPanel(previousDisplayChapterKey);if(pageKey===(previousDisplayPageInfo&&previousDisplayPageInfo.panelKey)){return ;}var elements=this.domNode.getElementsByClassName("item unit current-display");$ARR.forEach(elements,function(element){$CSS.removeClass(element,"current-display");var index=element.getAttribute("idx");if(element.className.indexOf("selected")!==-1&&index>=0&&previousChapterPanel){previousChapterPanel.removeSelect([index]);}});this.ondisplayPagePositionChange(displayPageInfo);if(this.getChapterPanel(chapterKey)){this.previousDisplayPageInfo={panelKey:pageKey,layoutKey:chapterKey};}},ondisplayPagePositionChange:function ondisplayPagePositionChange(displayPageInfo){if(!displayPageInfo){return ;}var pageKey=displayPageInfo.panelKey,chapterKey=displayPageInfo.layoutKey,chapterPanel=this.getChapterPanel(chapterKey),items=(chapterPanel&&chapterPanel.ulist.items)||[],idx=$ARR.find(items,"k",pageKey);if(idx!==-1){var pageNode=chapterPanel.ulist._getItemNode(idx);$CSS.addClass(pageNode,"current-display");if(pageNode.scrollIntoViewIfNeeded){pageNode.scrollIntoViewIfNeeded();}else{this.scrollIntoViewIfNeeded(pageNode);}}},setTOCIcon:function setTargetIcon(shouldShow,isSource){if(shouldShow){addIcon.call(this,isSource?"src":"tgt");}else{removeIcon.call(this,isSource?["src","tgt"]:"tgt");}},clearPageSelect:function clearPageSelect(){var me=this;$ARR.forEach(this.data,function(chapter){var porlet=me.getChapterPanel(chapter.k);porlet.clearSelect();});},clearChapterSelect:function clearChapterSelect(){var me=this;$ARR.forEach(this.data,function(chapter){var porlet=me.getChapterPanel(chapter.k);porlet.clearTitleSelect();});},allowDrop:function allowDrop(context){var srcZones=[ENUM_SOURCE.VIZ_EDITOR,ENUM_SOURCE.TOC_CHAPTER,ENUM_SOURCE.TOC_PAGES_LIST];return srcZones.indexOf(getDragSourceFrom(context))>-1;},ondrop:function ondrop(context){var dragData=context&&context.getCtxtDragData&&context.getCtxtDragData(),dragSource=dragData&&dragData.src;if((dragSource===ENUM_SOURCE.TOC_CHAPTER||dragSource===ENUM_SOURCE.TOC_PAGES_LIST)&&this.lastDragOverInfo){var targetWidget=this.getChapterPanel(this.lastDragOverInfo.chapterKey);targetWidget.ondrop(context);}else{if(getDragSourceFrom(context)===ENUM_SOURCE.VIZ_EDITOR){dragData.onRemove(dragData.items&&dragData.items.length>1?dragData.items:dragData.item);}}},ondragleave:function ondragleave(context){var dragData=context&&context.getCtxtDragData&&context.getCtxtDragData(),dragSource=dragData&&dragData.src;if(dragSource===ENUM_SOURCE.TOC_CHAPTER){this.chapterDnDIndicatorNode.style.display="none";}this._super(context);},getDropAvatarIcon:function getDropAvatarIcon(context){return getDragSourceFrom(context)===ENUM_SOURCE.VIZ_EDITOR?"remove":"move";},updateLastModifiedTime:function updateLastModifiedTime(timeStamp){this.coverPage.set("lastModifiedTime",timeStamp);},updateChapterAndPageCount:function updateChapterAndPageCount(){this.coverPage.set("chapterAndPageCnt",{chapter:this.chapterCount,page:this.pageCount});},passToolbarCfg:function passToolbarCfg(cfg){var existingToolbarCfg=this.titleBar.toolbarCfg;if(existingToolbarCfg){existingToolbarCfg.destroy();}this.titleBar.set("toolbarCfg",cfg);},updateToolbar:function updateToolbar(cfg){cfg.hostId=this.id;cfg.isHostedWithin=false;this.toolbar=this.titlebar;var rootCtrl=this.parent.controller;rootCtrl.getSelectorTabMenu(this.model,cfg);return cfg;},expandOrCollapseAll:function expandOrCollapseAll(expand){this.contents&&this.contents.children.forEach(function(chapter){var tBar=chapter.titleBar;if(tBar.canCollapse){tBar.set("isCollapsed",!expand);}});}});mstrmojo.vi.ui.TableOfContents.MAX_WIDTH=TOC_MAX_WIDTH;mstrmojo.vi.ui.TableOfContents.MIN_WIDTH=TOC_MIN_WIDTH;}());