(function(){mstrmojo.requiresCls("mstrmojo.dom","mstrmojo.hash","mstrmojo.ServerProxy","mstrmojo.XHRServerTransport","mstrmojo._IsWebApp");mstrmojo.requiresDescs(5720,12963);var MAX_FILE_SIZE=4*1024*1024,serverProxy=new mstrmojo.ServerProxy({transport:mstrmojo.XHRServerTransport}),$H=mstrmojo.hash,webAppRequestUtil=mstrmojo._IsWebApp,constants=mstrmojo.DI.DIConstants;webAppRequestUtil.serverProxy=serverProxy;webAppRequestUtil.enableWaitBox=true;mstrmojo.AS.DIAppSchemaService=mstrmojo.provide("mstrmojo.AS.DIAppSchemaService",{_mixinName:"mstrmojo.AS.DIAppSchemaService",_uploadChunks:function(files,start,res,taskCfg,progressCfg,callback){var func=arguments.callee,file=files[0];if(!file){callback.complete();return ;}if(start===undefined&&res===null){serverProxy.upload({success:function(obj){func(files,0,obj,taskCfg,progressCfg,callback);},failure:function(res){webAppRequestUtil.hideWait(true);}},$H.copy(taskCfg,{index:-1}),null,progressCfg);}else{var end=Math.min(file.size,start+MAX_FILE_SIZE),blob=file.slice(start,end),progressCfg=$H.copy({async:true},progressCfg);serverProxy.upload({success:function(res){if(start+MAX_FILE_SIZE<file.size){start+=MAX_FILE_SIZE;func(files,start,res,taskCfg,progressCfg,callback);}else{var shiftedFile=files.shift();callback.success(shiftedFile.name,res.uploadingId);func(files,undefined,null,taskCfg,progressCfg,callback);}},failure:function(res){webAppRequestUtil.hideWait(true);}},$H.copy({index:res.index+1,uploadingId:res.uploadingId,fileName:file.name,fileFieldName:"file"},taskCfg),blob,progressCfg);}},archSpark:function(callback,params,waitCfg){webAppRequestUtil.serverRequest($H.copy(params,{taskId:"arch.spark"}),callback,waitCfg);},uploadFile:function(fileNode,meta,callback){var taskCfg={taskId:"arch.sparkFileUpload",taskContentType:"json",taskEnv:"xhr",fileType:"application/octet-stream",workspaceId:meta.workspaceId,uploadingId:meta.uploadingId},progressCfg={showProgress:meta.showProgress,message:mstrmojo.desc(12963,"Uploading File...")},me=this,tableId=meta.tableId,pipelineId=meta.pipelineId,sheetIndex=meta.sheetIndex,workspaceId=meta.workspaceId,requestId=meta.requestId,mode=meta.mode;if(progressCfg.showProgress){webAppRequestUtil.showWait(progressCfg);}this._uploadChunks([fileNode.files[0]],undefined,null,taskCfg,progressCfg,{complete:function(){},success:function(tableName,uploadingId){if(mode===constants.operationMode.republish){typeof callback==="function"&&callback({tableName:tableName,uploadingId:uploadingId,sheetIndex:sheetIndex,tableId:tableId});}else{if(mode===constants.operationMode.edit){var _callback=typeof callback==="function"?function(){callback({tableName:tableName,uploadingId:uploadingId,sheetIndex:sheetIndex});}:mstrmojo.emptyFn;if(!meta.uploadingId){me.editSourceTableId({workspaceId:workspaceId,pipelineId:pipelineId,tableId:tableId,uploadingId:uploadingId,sheetIndex:sheetIndex},_callback);}else{_callback();}}}}});},editSourceTableId:function(tableInfoObj,callback){var me=this;me.archSpark({complete:function(){webAppRequestUtil.hideWait(true);},success:function(res){if(res.body.status==="ERROR"){mstrmojo.error({longDesc:res.body.message,shortDesc:"ERROR"},function(){});}else{if(res.body.status==="immediateResponse"&&res.httpStatus===200){callback();}}},failure:function(res){webAppRequestUtil.hideWait(true);}},{path:"/sourcetables/"+tableInfoObj.tableId,method:"PUT",form:JSON.stringify({workspaceId:tableInfoObj.workspaceId,pipelineId:tableInfoObj.pipelineId,datasource:{type:constants.dataSourceType.FILE_LOCAL,url:tableInfoObj.uploadingId,sheetIndex:tableInfoObj.sheetIndex}})});},deleteWorkspace:function(params,callback){var me=this;me.archSpark({complete:function(){typeof callback.complete=="function"&&callback.complete();},success:function(res){if(res.body.status==="ERROR"){mstrmojo.error({longDesc:res.body.message,shortDesc:"ERROR"});}else{if(res.body.status==="immediateResponse"&&res.httpStatus===200){}}},failure:function(res){console.error(res);}},{path:"/workspaces/"+params.workspaceId,method:"DELETE"});},checkConnection:function(formData,callback){var requestParam={path:"/cubes/checkConnection",headers:JSON.stringify(formData),method:"GET"};var waitCfg={hideFailureErr:true,silent:false,waitBoxCfg:{message:mstrmojo.desc(5720,"Waiting..."),showCancel:false,position:{}}};this.archSpark(callback,requestParam,waitCfg);}});})();