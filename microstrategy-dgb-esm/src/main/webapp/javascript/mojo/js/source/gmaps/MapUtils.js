(function(){mstrmojo.requiresCls("mstrmojo.dom","mstrmojo.css","mstrmojo.array","mstrmojo.color","mstrmojo.string","mstrmojo.vi.enums.EnumFeatures","mstrmojo.VisUtility");var $MOJO=mstrmojo,$DOM=$MOJO.dom,$CSS=$MOJO.css,$ARR=$MOJO.array,$COLOR=$MOJO.color,$STR=$MOJO.string,$VIS_UTILITY=mstrmojo.VisUtility,LATITUDE_MAX=90,LATITUDE_MIN=-90,LONGITUDE_MAX=180,LONGITUDE_MIN=-180,ENABLE_ZOOM_LEVEL_AND_POSITION_SAVING_FOR_WORKSTATION=true,FEATURES=$MOJO.vi.enums.EnumFeatures,mXMLNS="http://www.w3.org/2000/svg";var fontFamilyMapboxItems;function isIE(){var ua=navigator.userAgent.toLowerCase();return $DOM.isIE||(ua&&ua.match(/rv:([\d.]+)\) like gecko/));}mstrmojo.gmaps.MapUtils=mstrmojo.provide("mstrmojo.gmaps.MapUtils",{_mixinName:"mstrmojo.gmaps.MapUtils",checkVal:function checkVal(val){return this.checkDefined(val)&&!(isNaN(parseInt(val)));},checkVals:function checkVals(vals){var result=true;$ARR.forEach(vals,function(val){if(!this.checkVal(val)){result=false;return false;}});return result;},checkHasFunction:function checkHasFunction(obj,funcName){return obj&&obj[funcName]&&obj[funcName] instanceof Function;},checkDefined:function checkDefined(val){return(val!==undefined)&&(val!==null);},parseBoolean:function parseBoolean(val){return val===true||val==="true";},isAsp:function isAsp(){return(window.location.pathname.indexOf("/asp/")>0);},trimString:function trimString(s){return mstrmojo.string.trim(s);},log:function log(str){if(console&&console.log){console.log(str);}},replaceSpace:function replaceSpace(str,replaceStr){if(!this.checkDefined(str)){return ;}var replace=(this.checkDefined(replaceStr))?replaceStr:"_";return str.replace(/ /g,replace);},getProtocol:function getProtocol(){return this.isSingleTier()?"http:":window.location.protocol;},createMouseEvt:function createMouseEvt(evtName){var evt;if(isIE()||$DOM.isFF){evt=document.createEvent("MouseEvents");evt.initEvent(evtName,true,false);}else{if(window.MouseEvent){evt=new MouseEvent(evtName);}}return evt;},isRMClick:function isRMClick(evt){var isRightClick=false;if(evt){if(evt.which){isRightClick=evt.which===3;}else{if(evt.button){isRightClick=evt.button===2;}}}return isRightClick;},createNormalNode:function createNormalNode(nodeTag){if(!!nodeTag){return document.createElement(nodeTag);}},createSvgNode:function createSvgNode(nodeTag){if(!!nodeTag){return document.createElementNS(mXMLNS,nodeTag);}},appendNode:function appendNode(parent,child){if(this.checkHasFunction(parent,"appendChild")&&child){parent.appendChild(child);}},appendSvgNode:function appendSvgNode(parent){if(!parent){return ;}var svgNode=this.createSvgNode("svg");this.setCssStyles(svgNode,{position:"absolute",width:parent.style.width,height:parent.style.height,top:"0px",left:"0px"});parent.appendChild(svgNode);return svgNode;},appendGNode:function appendGNode(parent){if(!this.checkHasFunction(parent,"appendChild")){return ;}var gNode=this.createSvgNode("g");parent.appendChild(gNode);return gNode;},setNodeAttributes:function setNodeAttributes(node,styles){if(!this.checkHasFunction(node,"setAttribute")||!styles){return ;}for(var propName in styles){if(this.checkDefined(styles[propName])){node.setAttribute(propName,styles[propName]);}}},setCssStyles:function setCssStyles(node,styles){var style=node&&node.style,propName;if(!style||!styles){return ;}for(propName in styles){if(this.checkDefined(styles[propName])){style[propName]=styles[propName];}}},setCssTransform:function setCssTransform(nodes,translate){if(!translate||!this.checkVal(translate.x)||!this.checkVal(translate.y)){return ;}$ARR.forEach($ARR.ensureArray(nodes),function(node_){this.setNodeAttributes(node_,{transform:"translate("+translate.x+" "+translate.y+")"});},this);},emptyDomElement:function emptyDomElement(el){if(!this.checkHasFunction(el,"removeChild")){return ;}while(el.firstChild){el.removeChild(el.firstChild);}},insertAfter:function insertAfter(newNode,refNode){var parentNode=refNode&&refNode.parentNode;if(newNode&&this.checkHasFunction(parentNode,"insertBefore")){if(refNode.nextSibling){parentNode.insertBefore(newNode,refNode.nextSibling);}else{parentNode.appendChild(newNode);}}},insertAsFirstChild:function insertAsFirstChild(parentNode,newFirstNode){if(parentNode&&newFirstNode){if(parentNode.firstChild){parentNode.insertBefore(newFirstNode,parentNode.firstChild);}else{parentNode.appendChild(newFirstNode);}}},getEvtCoordInsideNode:function getEvtCoordInsideNode(evt,node_){var clientRect=this.getBoundingRect(node_);if(!evt||!this.checkVal(evt.clientX)||!this.checkVal(evt.clientY)||!clientRect||!this.checkVal(clientRect.left)||!this.checkVal(clientRect.top)){this.log("getEvtCoordInsideNode(): Invalid clientRect.");return ;}return{x:evt.clientX-clientRect.left,y:evt.clientY-clientRect.top};},getBoundingRect:function getBoundingRect(node_){if(this.checkHasFunction(node_,"getBoundingClientRect")){return node_.getBoundingClientRect();}},showWait:function showWait(){if(this.checkHasFunction(mstrApp,"showWait")){mstrApp.showWait();}else{if(this.checkHasFunction(microstrategy,"showWait")){microstrategy.showWait(true);}}},hideWait:function hideWait(force){if(this.checkHasFunction(mstrApp,"hideWait")){mstrApp.hideWait(force);}else{if(this.checkHasFunction(microstrategy,"showWait")){microstrategy.showWait(false);}}},isValidLatLng:function isValidLatLng(lat,lng){if(!this.checkVal(lat)||!this.checkVal(lng)){return false;}return parseInt(lat)>=LATITUDE_MIN&&parseInt(lat)<=LATITUDE_MAX&&parseInt(lng)>=LONGITUDE_MIN&&parseInt(lng)<=LONGITUDE_MAX;},isExpress:function isExpress(){return !!(mstrApp&&mstrApp.isExpress);},isVI:function isVI(){return mstrApp&&mstrApp.isVI;},isOIVM:function isOIVM(){return mstrApp&&(mstrApp.isExpress||mstrApp.isVI);},isSingleTier:function isSingleTier(){return !!(mstrApp&&mstrApp.isSingleTier);},isWorkstation:function isWorkstation(){return mstrApp&&mstrApp.isWorkstation;},isWSLiveMode:function isWorkstationLiveMode(){return mstrApp&&mstrApp.supportFeature(FEATURES.SUPPORT_LIVEMODE)&&(typeof mstrApp.getWSLiveMode==="function")&&mstrApp.getWSLiveMode();},getEvent:function getEvent(evt){if(!$DOM.supportsTouches){return evt;}else{return $DOM.firstChangedTouch(window,evt);}},enableZoomLevelAndPosSaving:function enableZoomLevelAndPosSaving(){return !this.isWorkstation()||ENABLE_ZOOM_LEVEL_AND_POSITION_SAVING_FOR_WORKSTATION;},isCanvasSupported:function isCanvasSupported(){var elem=document.createElement("canvas");return !!(elem.getContext&&elem.getContext("2d"));},convertImageUrl:function convertImageUrl(imageUrl){if(mstrApp.isDossier&&imageUrl&&imageUrl.indexOf("../")===0){return $MOJO.getStyleRoot()+"/../"+imageUrl.substr(3);}return imageUrl;},encode:function encode(oldStr,toServer){var sb=oldStr;if(!this.checkDefined(toServer)){toServer=false;}if(oldStr&&oldStr.length>0){sb="";for(var i=0,len=oldStr.length;i<len;i++){switch(oldStr.charAt(i)){case"&":if((oldStr.length!==(i+1))&&(oldStr.charAt(i+1)==="#")){sb+="&";}else{sb+="&amp;";}break;case"<":sb+="&lt;";break;case">":sb+="&gt;";break;case"'":sb+="&#039;";break;case"\n":if(!toServer){sb+="<br />";}else{sb+=oldStr.charAt(i);}break;case'"':sb+="&quot;";break;case" ":if(i===0||(i<oldStr.length-1&&oldStr.charAt(i+1)===" ")){sb+="&nbsp;";}else{sb+=oldStr.charAt(i);}break;default:sb+=oldStr.charAt(i);break;}}}return sb;},loadCss:function loadCss(ElementId,hrefLink){var currentStyles=document.styleSheets;if(currentStyles){var i,style;for(i=0;i<currentStyles.length;i++){style=currentStyles[i];if(style.id===ElementId){return ;}}}var css=document.createElement("link");css.setAttribute("rel","stylesheet");css.setAttribute("type","text/css");css.setAttribute("href",hrefLink);css.setAttribute("id",ElementId);document.getElementsByTagName("head")[0].appendChild(css);},getGraphicLayerById:function getGraphicLayerById(layerId){var layer=mstrmojo.all[layerId];if(!layer){this.hideWait();}return layer;},isEmbedded:function isEmbedded(){return mstrApp&&mstrApp.isEmbedded;},_verifyProtocol:function _verifyProtocol(m){if("https:"===window.location.protocol&&(-1!==m.search(/^http\:\/\/server\.arcgisonline\.com/i)||-1!==m.search(/^http\:\/\/services\.arcgisonline\.com/i)||-1!==m.search(/^http\:\/\/.+\.arcgis\.com/i))){m=m.replace(/http:/i,"https:");}return m;},loadExternalScript:function loadExternalScript(url,onSuccess,onError){if(!url){return ;}var script=document.createElement("script");script.type="text/javascript";script.src=url;if(onError){script.onerror=onError;}if(script.addEventListener){script.addEventListener("load",function load(){script.removeEventListener("load",load);script.onerror=null;if(onSuccess){onSuccess();}},false);}else{if(script.readyState){script.onreadystatechange=function(){if(script.readyState==="loaded"||script.readyState==="complete"){script.onreadystatechange=null;script.onerror=null;if(onSuccess){onSuccess();}}};}}document.getElementsByTagName("head")[0].appendChild(script);},getNoInternetMessage:function getNoInternetMessage(){var errorMsg,replaceStr;if(mstrApp.isSingleTier){errorMsg="Unable to create the map. Please check you connection. You can configure an Internet proxy through your computer's #";replaceStr='<a href="" style="color:#7CC5EC" onclick="window.FormWrapper.showProxyEditor(); return false;">'+mstrmojo.desc(7831,"Settings")+"</a>.";errorMsg=errorMsg.replace("#",replaceStr);}else{errorMsg="Unable to download the requested map. Please contact your administrator to resolve this issue.";}return errorMsg;},getThemeClass:function getThemeClass(){if(mstrApp&&mstrApp.getThemeClassName){return" "+mstrApp.getThemeClassName();}},adjustHSV:function adjustHSV(colorStr,hFactor,sFactor,vFactor){if(!colorStr||!this.checkVal(hFactor)||!this.checkVal(sFactor)||!this.checkVal(vFactor)){return colorStr;}var R,G,B,HSV,RGB,RStr,GStr,BStr;if(!colorStr){return colorStr;}if(colorStr.length===7){R=parseInt(colorStr.substring(1,3),16);G=parseInt(colorStr.substring(3,5),16);B=parseInt(colorStr.substring(5,7),16);}else{if(colorStr.length===4){R=parseInt(colorStr.substring(1,2)+colorStr.substring(1,2),16);G=parseInt(colorStr.substring(2,3)+colorStr.substring(2,3),16);B=parseInt(colorStr.substring(3,4)+colorStr.substring(3,4),16);}else{return colorStr;}}HSV=$COLOR.rgb2hsv(R,G,B);HSV[0]=HSV[0]*hFactor;HSV[1]=HSV[1]*sFactor;HSV[2]=parseInt(HSV[2]*vFactor>100?100:HSV[2]*vFactor,10);RGB=$COLOR.hsv2rgb(HSV[0],HSV[1],HSV[2]);R=parseInt(RGB[0],10);G=parseInt(RGB[1],10);B=parseInt(RGB[2],10);RStr=R<16?"0"+R.toString(16):R.toString(16);GStr=G<16?"0"+G.toString(16):G.toString(16);BStr=B<16?"0"+B.toString(16):B.toString(16);colorStr="#"+RStr+GStr+BStr;return colorStr;},fillColorAjustForCMSelection:function fillColorAjustForCMSelection(colorStr){return this.adjustHSV(colorStr,1,0.5,1.2);},fillColorAjustForHover:function fillColorAjustForHover(colorStr){return this.adjustHSV(colorStr,1,0.6,1.15);},setLayerNodeProps:function setLayerNodeProps(layerNode,id,className,width,height){this.setNodeAttributes(layerNode,{id:id,"class":className});this.setCssStyles(layerNode,{position:"absolute",top:"0px",left:"0px"});if(this.checkVal(width)&&this.checkVal(height)){width=parseInt(width);height=parseInt(height);this.setCssStyles(layerNode,{width:width+"px",height:height+"px"});}},destroyNode:function destroyNode(dn){if(!dn){return ;}try{if(dn.parentNode){dn.parentNode.removeChild(dn);}if($DOM.isIE&&dn.outerHTML!==undefined){dn.outerHTML="";}}catch(ex){}},destroyObj:function destroyObj(obj){if(obj&&obj.destroy instanceof Function){obj.destroy();}},removeHTMLTagsAndProps:function removeHTMLTagsAndProps(input,allowedTags,allowedProps){try{(input.match(/<[^>]+>/g)||[]).forEach(function(match){var idx,m,tagName,propName,attrs,preTag,prefix,suffix,str=match.toLowerCase();m=str.match(/<\/?([a-z]+\b)/);if(m&&m.length===2){tagName=m[1];if(allowedTags.indexOf(tagName)<0){input=input.replace(match,"");return ;}if(str.charAt(1)==="/"){str=str.substring(2);prefix="</";}else{str=str.substring(1);prefix="<";}idx=str.length-2;if(str.charAt(idx)==="/"){str=str.substring(0,idx);suffix="/>";}else{str=str.substring(0,str.length-1);suffix=">";}str=str.replace(tagName,"");preTag="";attrs="";while(str!=preTag){preTag=str;str=$STR.trim(str);m=str.match(/([^=]+)=\s*('[^']*'|"[^"]*")/);if(m&&m.length===3){propName=$STR.trim(m[1]).split(/\s+/);if(propName&&propName.length>0){propName=propName[propName.length-1];if(allowedProps.indexOf(propName)>=0){attrs+=" "+propName+"="+m[2];}}str=str.substring(m[0].length);}}input=input.replace(match,prefix+tagName+attrs+suffix);}});}catch(e){console.log("HTML Parse Error: "+e);}finally{return input;}},addArrowNode:function addArrowNode(container){if(container){var arrowEl=this.createNormalNode("div");$CSS.addClass(arrowEl,"mstrmojo-Tooltip-arrow");this.appendNode(container,arrowEl);}},getFontFamilyItems:function getFontFamilyItems(blackList){if(fontFamilyMapboxItems){return fontFamilyMapboxItems;}else{fontFamilyMapboxItems=$ARR.filter($VIS_UTILITY.getFontFamilyItems(),function(font){return $ARR.indexOf(blackList,font.n)===-1;});return fontFamilyMapboxItems;}},});}());