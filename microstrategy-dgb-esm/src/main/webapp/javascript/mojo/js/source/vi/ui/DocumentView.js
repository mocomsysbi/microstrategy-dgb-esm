(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo._HasLayout","mstrmojo._HasBuilder","mstrmojo._IsRwDocument","mstrmojo.express.ui._IsDocumentView","mstrmojo.vi._MonitorsAppState","mstrmojo.vi.models.VIComponentMap.TYPES","mstrmojo.vi.controllers.EnumLayoutSelectorPosition","mstrmojo.vi.ui.DocBuilder","mstrmojo.vi.ui.VisualizationEditor","mstrmojo.array","mstrmojo.func","mstrmojo.hash","mstrmojo.css","mstrmojo.vi.ui.rw.xtab.XtabMenuConfig","mstrmojo.vi.ui.tabs.LayoutTabHelper","mstrmojo.vi.controllers.EnumEvents");var $ARR=mstrmojo.array,$FUNC=mstrmojo.func,$HASH=mstrmojo.hash,DDS=mstrmojo.DocDataService,EVENTS=mstrmojo.vi.controllers.EnumEvents,LAYOUT_SELECTOR_POSITION=mstrmojo.vi.controllers.EnumLayoutSelectorPosition,$LAYOUT_TAB_HELPER=mstrmojo.vi.ui.tabs.LayoutTabHelper;function getDuplicatedLayoutName(layouts,key){var dupName=mstrmojo.desc(11450,"## copy ###"),duplicateIdx=$ARR.find(layouts,"k",key),layout=layouts[duplicateIdx],newName=layout.numDupl===0?dupName.replace("###","").replace("##",layout.n):dupName.replace("###",layout.numDupl).replace("##",layout.n),h={};(layouts||[]).forEach(function(u){h[u.n]=true;});while(h[newName]){layout.numDupl++;newName=dupName.replace("###",layout.numDupl).replace("##",layout.n);}return newName;}function getSaveLayoutCallback(model){return{success:function(){var boxes=model.replaceKeyBoxes,cmd=model.cmdMgr().getInterimCmd(),boxUpdate=model.getDataService().newUpdate(cmd,{extras:mstrmojo.DocDataService.SUPPRESS_DATA});if(boxes&&boxes.length>0){$ARR.forEach(boxes,function(unit){unit.addSaveBoxLayoutActions(boxUpdate,true);});}model.clearMapLayout();model.raiseEvent({name:EVENTS.UPDATE_TOC});cmd.submitUpdate(boxUpdate,model.cmdMgr().CMD_PHASE.LAST);}};}mstrmojo.vi.ui.DocumentView=mstrmojo.declare(mstrmojo.Container,[mstrmojo._HasLayout,mstrmojo._HasBuilder,mstrmojo._IsRwDocument,mstrmojo.express.ui._IsDocumentView,mstrmojo.vi._MonitorsAppState],{scriptClass:"mstrmojo.vi.ui.DocumentView",markupString:'<div id="{@id}" class="mstrmojo-VIDocument {@cssClass}" style="{@cssText}" ><div class="mstrmojo-VIDocument-doc"></div></div>',markupSlots:{containerNode:function(){return this.domNode.firstChild;}},layoutConfig:{h:{containerNode:"100%"},w:{containerNode:"100%"},xt:true},hasDataSource:false,selector:null,layoutViewer:null,model:null,builder:null,renderedLayoutsQueue:[],LAYOUTS_CACHE_SIZE:10,init:function init(props){this._super(props);var model=this.model;this.addDisposable(this.builder=new mstrmojo.vi.ui.DocBuilder({parent:this,model:model}));},buildChildren:function buildChildren(){var editor=this.editor,cachedChildren=editor?[editor]:[];this._layouts=this._super(true);this.addChildren(cachedChildren);},onRender:function onRender(){var selectedLayout=this.getSelectedLayoutWidget();this.addChildren([selectedLayout]);},pushToRenderedQueue:function pushToRenderedQueue(layout,newLayout){var queue=this.renderedLayoutsQueue||[];if(queue.indexOf(layout.k)===-1){queue.push(layout.k);if(queue.length>this.LAYOUTS_CACHE_SIZE){var key2Release=queue.shift(),layouts=this._layouts,layout2Release=layouts[$ARR.find(layouts,"k",key2Release)]||{};if(layout2Release.hasRendered&&key2Release!==newLayout.k){layout2Release.unrender();}}}},setDimensions:function setDimensions(h,w){this._super(h,w);this.forceLayout=false;},showPanel:function showPanel(panelKey,layoutKey,update){var compMap=this.builder.getLayoutVIMap(layoutKey),panelStack=compMap&&compMap.getComponent(mstrmojo.vi.models.VIComponentMap.TYPES.VIZ_CONTENT);if(panelStack){panelStack.selectPanel(panelKey,null,null,update);}},showLayout:function showLayout(layout,callback,update,panelKey){var newKey=layout.k,oldLayout=this.getSelectedLayoutWidget(),isCallbackFunction=typeof callback==="function",cb={success:function(newLayout){newLayout.getSelector().setTabs(this._layouts,newLayout.k);this.reDisplayLayout(oldLayout,newLayout,isCallbackFunction?callback:mstrmojo.emptyFn);var isPreviewMode=mstrApp.isLayoutModePreview();if(isPreviewMode||newLayout.isPreview){this.controller.rootCtrl.adjustLayoutSectionWidth(isPreviewMode,false);}newLayout.raiseEvent({name:"generateVizBoxToolbar"});}.bind(this)};if(!isCallbackFunction){cb=$FUNC.wrapMethods(cb,callback);}if(newKey!==oldLayout.k){this.getNewLayout({layoutKey:newKey,panelKey:panelKey},this._layouts,true,cb,update);return true;}return false;},reDisplayLayout:function reDisplayLayout(oldLayout,newLayout,callback){var selector=newLayout.getSelector(),model=this.model,selectedComponent=model.getSelectedViUnit(),selectedComponentKey=selectedComponent&&selectedComponent.k,layoutKey=newLayout.k,layouts=this._layouts,rootCtrl=mstrApp.rootCtrl,view=rootCtrl.view;selector.setStatic(true);$LAYOUT_TAB_HELPER.saveTabBarPosition(oldLayout.getSelector());var existingLayout=(this.children||[]).filter(function(child){return child.k===layoutKey;})[0];if(existingLayout){newLayout=this.rebuildChild(existingLayout);}else{this.removeChildren(oldLayout);this.pushToRenderedQueue(oldLayout,newLayout);model.resetSelectedViUnitId();this.addChildren([newLayout]);if(newLayout.isBoxLayoutDirty){newLayout.updateRootBoxLayout();newLayout.buildBoxLayout();delete newLayout.isBoxLayoutDirty;}}var idx=$ARR.find(layouts,"k",layoutKey);layouts[idx]=newLayout;(existingLayout||newLayout).raiseEvent({name:"layoutRedisplay"});this.updateXtabStyles(layoutKey);var vizPanel=model.getVizContentPanel(),selectedUnit=selectedComponentKey&&vizPanel.getUnitByKey(selectedComponentKey);if(selectedUnit){vizPanel.selectVIUnit(selectedUnit,true);}else{vizPanel.selectFirstBox();}newLayout.docLayout.toggleSelectorVisibility(model.tsp===LAYOUT_SELECTOR_POSITION.LEFT||!view.isCPVisible);$LAYOUT_TAB_HELPER.applyTabBarPosition(selector);selector.setSelectedTab(layoutKey);selector.setStatic(false,true);rootCtrl=this.controller.rootCtrl;rootCtrl.generateToolbar();if(callback){callback();}if(mstrApp.isAppStatePresentation()){this.layoutViewer.syncFilterPanelStack();}this.doLayout();},replaceLayout:function replaceLayout(oldLayout,newLayoutNode,newIdx){var layouts=this._layouts||[],idx=$ARR.find(layouts,"k",oldLayout&&oldLayout.k);if(idx>=0){oldLayout.unrender();oldLayout.destroy();this.model.getDocBuilder().removeVIMapRef(oldLayout.k);}var c=this.builder.build([newLayoutNode],this.model)[0];if(idx>=0){layouts[idx]=c;}else{$ARR.insert(layouts,newIdx,[c]);}this._layouts=layouts;return c;},destroy:function destroy(ignoreDom){(this._layouts||[]).forEach(function(layout){layout.destroy(ignoreDom);});this.builder.destroy();this._super(ignoreDom);},getLayoutByKey:function getLayoutByKey(layoutKey){return $ARR.filterOne(this.getLayouts(),function(layout){return layout.k===layoutKey;});},getLayouts:function(){return this._layouts;},updateLayouts:function(node){var layouts=this.getLayouts(),tmpLayouts=[],newLayouts=this.model.getChildren(node,false),oldLayout=this.getSelectedLayoutWidget(),i,key,idx;for(i=0;i<newLayouts.length;i++){key=newLayouts[i].k;idx=$ARR.find(layouts,"k",key);if(idx<0){this.replaceLayout(null,newLayouts[i]);}else{if(newLayouts[i].data.loaded&&this.model.currlaykey!==node.currlaykey){this.replaceLayout(layouts[idx],newLayouts[i]);}}}for(i=0;i<layouts.length;i++){idx=$ARR.find(newLayouts,"k",layouts[i].k);if(idx<0){var removed=layouts.splice(i,1)[0];removed.unrender();removed.destroy();i--;}}for(i=0;i<newLayouts.length;i++){key=newLayouts[i].k;idx=$ARR.find(layouts,"k",key);if(idx>=0){tmpLayouts.push(layouts[idx]);}}this._layouts=tmpLayouts;this.model.currlaykey=node.currlaykey;var newLayout=this.getLayoutByKey(node.currlaykey);newLayout.getSelector().setTabs(this._layouts,node.currlaykey);this.reDisplayLayout(oldLayout,newLayout);},moveLayout:function moveLayout(fromIdx,toIdx){var me=this,model=this.model,layouts=this._layouts,selector=this.layoutViewer.getSelector(),currentLayout=this.getSelectedLayoutWidget(),currentLayoutKey=currentLayout.k,movedLayout=layouts[fromIdx],movedLayoutKey=movedLayout.k,selectMovedTab=selector.selectMovedTab&&currentLayoutKey!==movedLayoutKey,fnMove=function(fromIdx,toIdx){model.moveLayout(fromIdx,toIdx);layouts.splice(toIdx,0,layouts.splice(fromIdx,1)[0]);model.raiseEvent({name:EVENTS.UPDATE_TOC});};model.execute({execute:function execute(){var urInfo=this.urInfo,fnPreUndoRedoMoveLayout=function(){urInfo.extras=$HASH.copy({style:{params:{treesToRender:DDS.EnumTreesToRender.BOTH}}},urInfo.extras);}.bind(this);urInfo=$HASH.copy({silent:selector.selectMovedTab?false:true,undo:function(){fnPreUndoRedoMoveLayout();fnMove(toIdx,fromIdx);me.layoutViewer.getSelector().moveTab(toIdx,fromIdx,toIdx,true);return !selectMovedTab;},redo:function(){fnPreUndoRedoMoveLayout();fnMove(fromIdx,toIdx);me.layoutViewer.getSelector().moveTab(fromIdx,toIdx,fromIdx,true);return !selectMovedTab;}},urInfo);var act=model.getMoveLayoutAction(fromIdx,toIdx);if(!selectMovedTab){fnMove(fromIdx,toIdx);this.submitSilent(act);}else{var update=model.getDataService().newUpdate(),needsLoad=me.needLoadLayout(movedLayout);update.addExtras(needsLoad?DDS.REQUEST_DEFN_DATA:DDS.REQUEST_ONLY_DEFINITION);fnMove(fromIdx,toIdx);update.actions.push(act);me.showLayout(movedLayout,null,update);if(needsLoad){this.submitUpdate(update);}}}});},deleteLayout:function deleteLayout(key,update){var layouts=this._layouts,deleteIdx=$ARR.find(layouts,"k",key),targetIdx=deleteIdx+1,targetLayout,id=this.id,bLoad=true,fnDelete=function(res){var me=mstrmojo.all[id],oldLayout=layouts.splice(deleteIdx,1)[0],children=bLoad?me.model.getChildren(res,false):layouts,currentLayoutKey=res.currlaykey,newIdx=$ARR.find(children,"k",currentLayoutKey),newLayout;me.model.currlaykey=currentLayoutKey;if(bLoad){me.model.replaceLayout(currentLayoutKey,res,false);newLayout=me.replaceLayout(layouts[newIdx],children[newIdx],newIdx);}else{newLayout=children[newIdx];}me.layoutViewer.getSelector().deleteTab(deleteIdx);newLayout.getSelector().setTabs(me.getLayouts(),currentLayoutKey);me.reDisplayLayout(oldLayout,newLayout);oldLayout.unrender();oldLayout.destroy();me.model.getDocBuilder().removeVIMapRef(key);me.model.raiseEvent({name:EVENTS.UPDATE_TOC});},fnHasTargets=function(layout){return !$HASH.isEmpty(layout.defn&&layout.defn.cgbMap);};this.model.removeLayout(key,{success:fnDelete},update);targetLayout=layouts[targetIdx];if(!targetLayout){targetIdx=deleteIdx-1;targetLayout=layouts[targetIdx];}this.model.getDataService().setCurrentDocLayout(targetLayout.k,null,update);bLoad=this.needLoadLayout(targetLayout)||fnHasTargets(layouts[deleteIdx])||fnHasTargets(targetLayout);update.setTreesToRender(bLoad?3:1);},duplicateLayout:function duplicateLayout(update,key){var layouts=this.getLayouts(),newIdx=$ARR.find(layouts,"k",key)+1,newKey=this.model.getNextKey();this.model.duplicateLayout(update,{srcKey:key,destKey:newKey,name:getDuplicatedLayoutName(layouts,key),index:newIdx+1},$FUNC.wrapMethods(this.getRedisplayLayoutCallback(newIdx,newKey,this.getSelectedLayoutWidget(),update),getSaveLayoutCallback(this.model)));},addNewLayout:function addNewLayout(update,idx,params){var newKey=(params&&params.nodeKey)||this.model.getNextKey(),len=this.getLayouts().length;idx=(0<=idx&&idx<len)?idx:len;this.model.addNewLayout(update,$HASH.copy(params,{nodeKey:newKey,index:idx+1}),$FUNC.wrapMethods(this.getRedisplayLayoutCallback(idx,newKey,this.getSelectedLayoutWidget()),getSaveLayoutCallback(this.model)));},importDashboard:function importDashboard(update,idx,params){var model=this.model,rootCtrl=this.controller.rootCtrl;idx=this.getLayouts().length;this.model.addExistingLayouts(update,$HASH.copy(params,{index:idx+1}),{success:function(){rootCtrl.displayLightTheme();model.raiseEvent({name:EVENTS.UPDATE_TOC});}});},getSelectedLayoutWidget:function getSelectedLayoutWidget(){return(this._layouts||[]).filter(function(layout){return(layout.k===this.model.getCurrentLayoutKey());},this)[0];},showSelectedLayout:function showSelectedLayout(){var currentLayout=this.getSelectedLayoutWidget();if(this.containerNode.children.length>0){return ;}if(this.model.clearDisposables){this.model.clearDisposables();}(this.children||[]).filter(function(child){return child.k===currentLayout.k;}).forEach(function(child){this.removeChildren(child);child.destroy();},this);this.addChildren([currentLayout]);},getViPanel:function getViPanel(type){return this.getSelectedLayoutWidget().getViPanel(type);},selectViPanel:function selectViPanel(type){var panel=this.getViPanel(type);if(panel){panel.parent.selectPanel(panel);}else{this.openViPanel(type);}},getPanelItems:function getPanelItems(){return this.getSelectedLayoutWidget().getPanelItems();},getPanelTypeFromKey:function getPanelTypeFromKey(key){return this.getSelectedLayoutWidget().getPanelTypeFromKey(key);},openViPanel:function openViPanel(type,callback,skipServerRequest){this.getSelectedLayoutWidget().openViPanel(type,callback,skipServerRequest);},onAppStateChange:function onAppStateChange(evt){var rootCtrl=mstrApp.rootCtrl,isCPVisible=rootCtrl.view.isCPVisible;this.layoutViewer.getSelector().set("visible",(!mstrApp.isAppStatePrintPreview())&&(!mstrApp.isAppStatePresentation()||this._layouts.length>1)&&isCPVisible);this.forceLayout=false;var presentationMode=mstrmojo.vi.VisualInsightApp.APP_STATES.PRESENTATION;if(evt.value&presentationMode||evt.valueWas&presentationMode){this.forceLayout=true;}},onLayoutSelected:function onLayoutSelected(update){var model=this.model,cmdMgr=model.controller.cmdMgr,cmd=cmdMgr.getInterimCmd();if(cmd){cmd.submitUpdate(update,cmdMgr.CMD_PHASE.LAST);}else{model.execute({execute:function(){this.submitUpdate(update,cmdMgr.CMD_PHASE.LAST);},urInfo:{treesToRender:3}});}},loadDocLayout:function loadDocLayout(params,callback,update){var autoSubmit=!update;update=update||this.model.getDataService().newUpdate();this._super(params,callback,update);if(autoSubmit){this.onLayoutSelected(update);}},setCurrentDocLayout:function setCurrentDocLayout(key,callback,update){update=update||this.model.getDataService().newUpdate(this);this._super(key,callback,update);update.setTreesToRender(1);this.onLayoutSelected(update);},changeCurrLytTabTtl:function changeCurrLytTabTtl(text,oldText){var tab=this.layoutViewer.getSelector().getSelectedTab();if(tab){tab.set("title",text);tab.titleEdited(text,oldText);}},getXtabCellMenuConfig:function(props){return new mstrmojo.vi.ui.rw.xtab.XtabMenuConfig(props);},layoutSelected:function layoutSelected(evt){this.layoutViewer.getSelector().layoutSelected(evt);},selectPage:function selectPage(evt){var layout=this.getLayout(),docLayout=layout&&layout.docLayout,docSection=docLayout&&docLayout.docSection,docSubSection=docSection&&docSection.docSubSection,selector=docSubSection&&docSubSection.children[0]&&docSubSection.children[0].children[1]&&docSubSection.children[0].children[1].children[0]&&docSubSection.children[0].children[1].children[0].selector;selector.selectPage(evt);},getRedisplayLayoutCallback:function getRedisplayLayoutCallback(index,key,oldLayout){var model=this.model;return{success:function(response){var newLayout=this.replaceLayout(null,model.getChildren(response,false,index,1)[0],index);model.currlaykey=response.currlaykey;newLayout.isPreview=mstrApp.isLayoutModePreview();this.reDisplayLayout(oldLayout,newLayout);}.bind(this),failure:function(err){mstrApp.onerror(err);}};}});mstrmojo._HasMarkup.addMarkupMethods(mstrmojo.vi.ui.DocumentView,{onhasDataSourceChange:function(){mstrmojo.css.toggleClass(this.domNode,"noDataSource",!this.hasDataSource);}});}());