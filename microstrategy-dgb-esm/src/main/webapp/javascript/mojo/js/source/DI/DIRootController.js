(function(){mstrmojo.requiresCls("mstrmojo.Obj","mstrmojo.warehouse.EnumDatabaseType","mstrmojo.Button","mstrmojo.DI.DIDataService","mstrmojo.DI.DIConstants","mstrmojo.Editor","mstrmojo.dom","mstrmojo.DI.DIObjectBrowser","mstrmojo.Refine.Refine","mstrmojo.Refine.RefinePopupPage","mstrmojo.DI.DIHelpers","mstrmojo.DI.DIRelationshipDefineEditor","mstrmojo.DI.DINavigationController","mstrmojo.DI.controller.DIScheduleController","mstrmojo.DI.controller.DIDialogController","mstrmojo.DI.controller.DIFormsController","mstrmojo.DI.controller.DIPartitionController","mstrmojo.DI.controller.DIOAuthController","mstrmojo.DI.controller.DIMappingMenuController","mstrmojo.DI.controller.DIMappingController","mstrmojo.DI.controller.DIDirectAccessController","mstrmojo.DI.controller.DIHadoopController","mstrmojo.DI.controller.DIPublishController","mstrmojo.DI.controller.ImportController","mstrmojo.DI.controller.DIDocController","mstrmojo.DI.controller.DIRemoteProjectsController","mstrmojo.DI.controller.DIAllObjectsViewController","mstrmojo.DI.controller.DIHadoopGatewayController","mstrmojo.QueueNative","mstrmojo.vi.models.OneTierServerTransport","mstrmojo.DI.WorkstationServerTransport");mstrmojo.requiresDescs(212,218,219,221,422,640,773,1302,1442,9117,9118,9119,12581,12609,12611,12612,12618,12619,12624,12626,12770,12771,12772,12773,12774,12775,12776,12777,12778,12779,12780,12781,12782,12783,12784,12785,12786,12787,12788,12789,12790,12791,12793,12794,12795,12796,12797,12798,12799,12800,12801,12802,12803,12900,13264,13265,13278,13279,13280,13282,13320,13321,13322,13323,13324,10065,13104,13100,11465,9229,9228,9220,9221,9222,9223,9224,9225,9226,9227,9230,13445,13446,13646,13883,13914,13991,14096,14097,14155,14205,14206,14207,14610,14657,14658,14707,14869,14870,14888,14889,14890,14891,14892,15207,15208,11812,16032);var constants=mstrmojo.DI.DIConstants,$H=mstrmojo.hash,$ARR=mstrmojo.array,$FUNC=mstrmojo.func,$DESC=mstrmojo.desc,$NWB=mstrmojo.Button.newWebButton,$DI_EXIT_OPTS=mstrmojo.DI.DIExitOptions,$HELPer=mstrmojo.DI.DIHelpers,$STR=mstrmojo.string,SAPHANA_DBTYPE=4000,TABLE_NAME_TAG="TABLENAME=",ONE_MB=1024*1024,$SEPARATOR_INTRODUCTION="#DESCRIPTION#INTRODUCTION#";var actions=constants.actions;var taskQueue;function isValidProtocol(urlText){urlText=urlText.toLowerCase();urlText=urlText.replace(/\s+/g," ");return(urlText.indexOf("file://")===0)||(urlText.indexOf("ftp://")===0)||(urlText.indexOf("http://")===0)||(urlText.indexOf("https://")===0)||(urlText.indexOf("hdfs://")===0);}function setAutoMappingStatus(tableID,index,importSources,successed){var i=mstrmojo.array.find(importSources[tableID].sheetsInfo,"index",index);if(importSources[tableID].sheetsInfo.length!==0){if(i>=0){importSources[tableID].sheetsInfo[i].isAutoMapped=true;importSources[tableID].sheetsInfo[i].isAutoMapppingSuccessed=successed;}}else{importSources[tableID].isAutoMapped=true;importSources[tableID].isAutoMapppingSuccessed=successed;}}function checkAutoMappingStatus(importSources){var k,i,sheets,sourceInfo,isPartition,partitionMappingStatus,subtype;for(k in importSources){sheets=importSources[k].sheetsInfo;sourceInfo=importSources[k].sourceInfo;isPartition=sourceInfo&&sourceInfo.partition.isPartition;if(this.model.operationMode===constants.operationMode.edit){if(sourceInfo){continue;}}subtype=importSources[k].subtype;if(subtype===constants.sourceSubtype.localFile||subtype===constants.sourceSubtype.url||subtype===constants.sourceSubtype.samplefile||subtype===constants.sourceSubtype.publicData||subtype===constants.sourceSubtype.cloudElement){if(importSources[k].isMergedCube){continue;}if(!sheets){return false;}if(sheets.length===0){if(!importSources[k].isAutoMapped){return false;}}partitionMappingStatus=false;for(i=0;i<sheets.length;i++){if(!sheets[i].isAutoMapped&&sheets[i].selected&&!isPartition){return false;}else{if(sheets[i].isAutoMapped&&sheets[i].selected&&isPartition){partitionMappingStatus=true;}}}if(isPartition&&!partitionMappingStatus){return false;}}}return true;}function checkAutoMappingSuccessStatus(importSources,action){var k,i,sheets,subtype;var hasFailed=false,allFailed=true;for(k in importSources){sheets=importSources[k].sheetsInfo;subtype=importSources[k].subtype;if(this.model.operationMode===constants.operationMode.edit||action===constants.actions.importSource){if(importSources[k].sourceInfo){continue;}}if(subtype===constants.sourceSubtype.localFile||subtype===constants.sourceSubtype.url||subtype===constants.sourceSubtype.samplefile||subtype===constants.sourceSubtype.hadoop||subtype===constants.sourceSubtype.publicData||subtype===constants.sourceSubtype.cloudElement){if(importSources[k].isMergedCube){continue;}if(sheets.length===0){if(importSources[k].isAutoMapped&&!importSources[k].isAutoMapppingSuccessed){hasFailed=true;}else{if(importSources[k].isAutoMapped&&importSources[k].isAutoMapppingSuccessed){allFailed=false;}}}else{for(i=0;i<sheets.length;i++){if(sheets[i].isAutoMapped&&!sheets[i].isAutoMapppingSuccessed){hasFailed=true;}else{if(sheets[i].isAutoMapped&&sheets[i].isAutoMapppingSuccessed){allFailed=false;}}}}}}if(allFailed){return 3;}if(hasFailed){return 2;}return 1;}var SHEETS_DIALOG_ID="sheetsDialog",sheetsDialogConfig={scriptClass:"mstrmojo.Editor",id:SHEETS_DIALOG_ID,cssClass:"mstrmojo-di-sheetsDialog",width:"300px",model:null,onOpen:function(){this.closeNode.style.display="none";this.helpNode.style.display="none";},buttons:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button primary-button",text:mstrmojo.desc(1442,"OK"),onclick:function(){var p=this.parent.parent;var flag=constants.requestFlag.preview|constants.requestFlag.mapping|constants.requestFlag.transformations|constants.requestFlag.sourceInfo|constants.requestFlag.sheets|constants.requestFlag.anyState;if(mstrApp.isEMMACube){mstrApp.getRootController().editImportedDataEMMA(flag,p.children[0].preShtsPD.selectedIndex,null,null);}else{mstrApp.getRootController().editImportedData(flag,p.children[0].preShtsPD.selectedIndex,null,null);}p.close();}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button secondary-button",text:mstrmojo.desc(221,"Cancel"),onclick:function(){this.parent.parent.close();this.parent.parent.destroy();}}],children:[{scriptClass:"mstrmojo.HBox",children:[{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(12581,"Select Sheet to Import:")},{scriptClass:"mstrmojo.Pulldown",alias:"preShtsPD",cssClass:"mstrmojo-di-sheetsDialog-pulldown",bindings:{items:function(){var model=mstrApp.getRootController().getModel();var shts=model.currentSource.sheets;var its=[];var i;if(shts){for(i=0;i<shts.length;i++){if(shts[i]!=="*"){its.push({dssid:i,n:shts[i].name});}}}return its;},defaultSelection:function(){var model=mstrApp.getRootController().getModel();var idx=0;if(model.currentSource.sourceInfo){idx=mstrmojo.array.find(model.currentSource.sheets,"index",model.currentSource.sourceInfo.sheetIndex);if(idx<0){idx=0;}}return idx;}}}]}]},REFRESH_OPTIONS_ID="refreshOptions",refreshOptionsConfig={scriptClass:"mstrmojo.Editor",cssClass:"mstrmojo-di-refresh-dialog",id:REFRESH_OPTIONS_ID,showTitle:true,zIndex:10000,title:mstrmojo.desc(12770,"Refresh Data Options"),onOpen:function(){var st=this.curtainNode.style;st.background="black";st.opacity=0.5;st.filter="alpha(opacity=50)";},children:[{scriptClass:"mstrmojo.RadioList",alias:"radiolist",itemCssClass:"mstrmojo-di-refresh-options",items:[{did:"1",n:mstrmojo.desc(9117,"Replace existing data")},{did:"4",n:mstrmojo.desc(9118,"Update existing data and add new data")},{did:"2",n:mstrmojo.desc(9119,"Keep existing data and add new data")}]},{scriptClass:"mstrmojo.HBox",cssClass:"mstrmojo-Editor-buttonBox",slot:"buttonNode",children:[{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton hot",cssText:"float:right;",text:mstrmojo.desc(1442,"OK"),onclick:function(){var e=this.parent.parent;e.model.refresh_opt=e.radiolist.selectedItem.did;if(e.onOK){e.onOK();}e.close();}},{scriptClass:"mstrmojo.Button",cssClass:"mstrmojo-di-button mstrmojo-WebButton",text:mstrmojo.desc(221,"Cancel"),onclick:function(){var e=this.parent.parent;if(e.onCancel){e.onCancel();}e.close();}}]}]};function closeDIPopup(cubeID){var controller=this,datasets=[];function continueClose(){window.setTimeout(function(){controller.dialogController.close(constants.dialogType.publishStatusDialog);controller.dialogController.destroyAll();var diContainer=mstrApp.container;if(diContainer){mstrApp.hideProgress(true);mstrApp.container.close();if(diContainer.dataImportCallback){diContainer.dataImportCallback(datasets);}}else{if(!$HELPer.isServerBasedWS()){mstrApp.redirectToPage($DI_EXIT_OPTS.getRedirectParams($DI_EXIT_OPTS.pageRedirect.flashVI,controller.model.cubeID,controller.model.isDirectDataAccess));}else{controller.shutDownServerBased(JSON.stringify({}));}}},0);}if(cubeID!==undefined){datasets=[{acg:255,did:cubeID,st:779,t:3,mngd:controller.getModel().isManagedCube,isDDA:controller.getModel().isDirectDataAccess}];}if((controller.getModel().isManagedCube||mstrApp.isSingleTier)&&cubeID!==undefined){controller.getDocController().getVIDocData({success:function(res){datasets[0]=res&&res.datasets&&res.datasets[cubeID];if(datasets[0]){datasets[0].did=cubeID;}continueClose();}});}else{continueClose();}}function getMappingXML(tableID,fg){var xml="";var mappings;if(tableID){mappings=this.model.getImportSource(tableID).getMappingChanges();}else{mappings=this.model.currentSource.getMappingChanges();}var i,mpc,key;if(mappings.length>0){xml+="<mpcs>";}for(i=0;i<mappings.length;i++){mpc=mappings[i];xml+="<mpc ";for(key in mpc){if(mpc[key]!==undefined){xml+=key+'="'+mpc[key]+'" ';}}if(fg){xml+='fg="'+fg+'" ';}xml+=" />";}if(mappings.length>0){xml+="</mpcs>";}return xml;}function loadData(){var operationMode=this.model.operationMode;var me=this,onGetProjectSettings={success:function(){if(mstrApp.diParams.ImportDatabase&&operationMode!==constants.operationMode.refresh&&operationMode!==constants.operationMode.subscribe&&operationMode!==constants.operationMode.enterCredentials){me.getDBMSObjects();}if(operationMode!==constants.operationMode.refresh&&operationMode!==constants.operationMode.subscribe&&operationMode!==constants.operationMode.enterCredentials){me.getAuthenticationDBRoles();}if(!mstrApp.diParams.disableCESource){me.getCloudElementDBRoles();}if(!mstrApp.diParams.disableCustomerConnector){me.getCustomConnector();}}};if(mstrApp.isSingleTier){this.dataService.getPreferences({success:function(res){var config=res&&(res.diConnectorConfig||res.diconnectorConfig);if(config){if(typeof config==="string"){try{config=JSON.parse(config);}catch(e){config=null;}}mstrApp.diParams.connectorConfig=config;if(config&&(config.resourceConfig||config.dbRoleConfig)){me.getModel().populateSourceListAdminConfig(config.resourceConfig,config.dbRoleConfig);}}me.oAuthController.getExternalSourcesInfo();if(operationMode!==constants.operationMode.refresh&&operationMode!==constants.operationMode.subscribe&&operationMode!==constants.operationMode.enterCredentials){me.getAuthenticationDBRoles();}if(operationMode!==constants.operationMode.refresh&&operationMode!==constants.operationMode.subscribe&&operationMode!==constants.operationMode.enterCredentials){me.getDBMSObjects();}if(!mstrApp.diParams.disableCESource){me.getCloudElementDBRoles();}if(!mstrApp.diParams.disableCustomerConnector){me.getCustomConnector();}}},{fordiConnectorConfig:true});}else{this.getDIProjectSettings(onGetProjectSettings);}if(operationMode!==constants.operationMode.refresh&&operationMode!==constants.operationMode.subscribe&&operationMode!==constants.operationMode.enterCredentials){this.fetchSampleFileList();}if(!mstrApp.isSingleTier&&!$HELPer.isServerBasedWS()&&!$HELPer.getEnvObj().isWSLiveMode()){mstrmojo.locales.load(mstrmojo.emptyFn);}if(!$HELPer.isOnetier()&&operationMode!==constants.operationMode.refresh&&operationMode!==constants.operationMode.subscribe&&operationMode!==constants.operationMode.edit){if(!this.model.analysisID){var params={op:constants.getCubeQuotaAndInfosOptions.GetCubeQuotaAndInfosQuotaOnly};this.getCubeQuota(null,params);}this.getShapekeys();}}function getBackendErrorMessage(errRes){var code=errRes.code;var msg=errRes.message;if(code===null||code===undefined){msg=errRes.getResponseHeader("X-MSTR-TaskFailureMsg");}var start=msg.indexOf("("),end=msg.lastIndexOf(")");if(start>=0&&end>start){msg=msg.substring(start+1,end);}return msg;}function handleFileImportError(status){var controller=this;var successFiles=[];var failedFiles=[];var fileUploadPage=controller.rootView.currentPage;var detailMsg="<ul>";mstrmojo.hash.forEach(status.files,function(value){if(value.failed===true){failedFiles.push(value.fileName);detailMsg+="<li>"+value.fileName+"<br>"+getBackendErrorMessage(value.errRes)||" </li>";}else{successFiles.push(value.fileName);}});detailMsg+="</ul>";fileUploadPage.set("forceEnable",successFiles.length>0?true:false);if(fileUploadPage.setFilesObject){fileUploadPage.setFilesObject(failedFiles);}controller.displayError(mstrmojo.desc(12900,"Error importing following files. Please check the files or delete them."),false,detailMsg);}function checkAndRemoveTables(tableIds,callback){var tableIdsToDelete=[],controller=mstrApp.getRootController(),model=controller.getModel();$ARR.forEach(tableIds,function(id){if(model.getImportSource(id)){tableIdsToDelete.push(id);}});if(tableIdsToDelete.length>0){controller.removeEMMASourceTable(callback,{did:tableIdsToDelete.join()});}else{if(callback.success){callback.success();}if(callback.complete){callback.complete();}}}function replaceWithEscapeSequences(value){value=value.split("&").join("&amp;");value=value.split("<").join("&lt;");value=value.split(">").join("&gt;");value=value.split("%").join("&#37;");return value;}function doNotImportHierarchyTable(callback){var sources=this.getModel().importSources,i,items,total=[],hasHierarchy=false;for(i in sources){if(sources.hasOwnProperty(i)&&sources[i].isHierarchyRelationTable()&&sources[i].shouldDoNotImportHierarchy()){items=sources[i].currentMapping;$ARR.forEach(items,function(item){var isRecursiveMFA=false;if(item.subColumns&&(item.subColumns.length>0)){for(var i=0;i<item.subColumns.length;i++){if(item.subColumns[i].recursive===true){isRecursiveMFA=true;}}}item.selected=!!item.recursive||isRecursiveMFA;});total=total.concat(items);hasHierarchy=true;}}if(total.length>0){this.mappingController.setMultipleImport(total,callback,true);}return hasHierarchy;}function splitDesc(str,label){var index=str.indexOf($SEPARATOR_INTRODUCTION);if(index<0){return label==="desc"?str:"";}else{return label==="desc"?str.substring(0,index):str.substring(index+$SEPARATOR_INTRODUCTION.length,str.length);}}mstrmojo.DI.DIRootController=mstrmojo.declare(mstrmojo.Obj,null,{scriptClass:"mstrmojo.DI.DIRootController",start:function start(){var rootView=this.rootView;this.dataService=new mstrmojo.DI.DIDataService();this.navigationController=new mstrmojo.DI.DINavigationController();this.dialogController=new mstrmojo.DI.controller.DIDialogController();this.formsController=new mstrmojo.DI.controller.DIFormsController();this.partitionController=new mstrmojo.DI.controller.DIPartitionController();this.mappingMenuController=new mstrmojo.DI.controller.DIMappingMenuController();this.mappingController=new mstrmojo.DI.controller.DIMappingController();this.hadoopController=new mstrmojo.DI.controller.DIHadoopController();this.oAuthController=new mstrmojo.DI.controller.DIOAuthController();this.projectController=new mstrmojo.DI.controller.DIRemoteProjectsController();this.allObjectsController=new mstrmojo.DI.controller.DIAllObjectsViewController();this.ddaController=new mstrmojo.DI.controller.DIDirectAccessController();if($HELPer.getEnvObj().isWSDossierLocalMode()){taskQueue=new mstrmojo.QueueNative({transport:mstrmojo.vi.models.OneTierServerTransport});}else{if($HELPer.getEnvObj().isWSDataSet()||$HELPer.getEnvObj().isWSLiveMode()){taskQueue=new mstrmojo.QueueNative({transport:mstrmojo.DI.WorkstationServerTransport});}else{taskQueue=new mstrmojo.QueuedXHR();}}mstrApp.taskQueue=taskQueue;this.model.initParams(mstrApp.diParams);rootView.render();this.addDisposable(rootView);this.addDisposable(this.model);this.addDisposable(this.dataService);this.addDisposable(this.dialogController);this.addDisposable(this.navigationController);loadData.call(this);},getModel:function getModel(){return this.model;},getDataService:function getDataService(){return this.dataService;},getMappingMenu:function getMappingMenu(tableId){return this.mappingMenuController.getMappingMenu(tableId);},forceImport:true,fetchPreview:true,refineApp:null,scheduleController:null,ddaController:null,tablesSrc:{},deleteObject:function deleteObject(callback,params){this.dataService.deleteObject(callback,params);},renameObject:function renameObject(callback,params){this.dataService.renameObject(callback,params);},getScheduleController:function getScheduleController(){if(this.scheduleController===null){this.scheduleController=new mstrmojo.DI.controller.DIScheduleController();}return this.scheduleController;},getDDAController:function getDDAController(){if(this.ddaController===null){this.ddaController=new mstrmojo.DI.controller.DIDirectAccessController();}return this.ddaController;},getDialogController:function getDialogController(){if(this.dialogController===null){this.dialogController=new mstrmojo.DI.controller.DIDialogController();}return this.dialogController;},getImportController:function(){if(!this.importController){this.importController=new mstrmojo.DI.controller.ImportController();}return this.importController;},getDocController:function(){if(!this.docController){this.docController=new mstrmojo.DI.controller.DIDocController();}return this.docController;},getHadoopGatewayController:function(){var me=this;if(!this.hadoopGatewayController){this.hadoopGatewayController=new mstrmojo.DI.controller.DIHadoopGatewayController({rootController:me});}return this.hadoopGatewayController;},showPage:function showPage(pageType,sourceInfo,slot,footerConfig){if(pageType===constants.pageType.emmaPreview&&this.dialogController.pageZIndex>0){this.rootView.parent.close();return null;}if(!this.rootView.parent){this.rootView.parent=mstrApp.container;}if(mstrApp.container&&!mstrApp.container.rootView){mstrApp.container.rootView=this.rootView;}if(!slot){if(this["getNewPageSlotForPage"+pageType]){slot=this["getNewPageSlotForPage"+pageType]();}else{slot=this.navigationController.getPageSlot();}}if(slot.getConfig()&&slot.getConfig().newPage){this.showDialog(constants.dialogType.diPageDialog,slot.getConfig().newPageConfig);}return this.rootView.showPage(pageType,sourceInfo,slot,footerConfig);},getNewPageSlotForPage6:function(){var rootController=this,slot=rootController.navigationController.getPageSlot(),model=rootController.model,hasDDAOnlySource=true,hasSAPHanaTable=false,hasNonSAPHanaTable,isFilterDDA=(model.operationMode===constants.operationMode.create);$H.forEach(model.importSources,function(source){hasDDAOnlySource=false;if(source.databaseType===SAPHANA_DBTYPE&&source.xdaType===constants.xdaType.qbSingleTable){hasSAPHanaTable=true;return false;}else{hasNonSAPHanaTable=true;}});slot.setConfig({properties:{hasDDAOnlySource:hasDDAOnlySource,isFilterDDA:isFilterDDA,isSAPHana:hasSAPHanaTable,hasNonSAPHana:hasNonSAPHanaTable}});return slot;},showSheetsSelectionDialog:function showSheetsSelectionDialog(tableIds,action,fileName,srcWidgetID,status,callback){var config;var i,k,table,sheets,sheetsItem,items=[],multiSelection,showDialog=false,defaultSheetsIndex=0;var tables=tableIds||this.model.getAllTableID();for(i=0;i<tables.length;i++){table=this.model.importSources[tables[i]];sheets=table.sheetsInfo;sheetsItem=[];var refreshFileName;if(sheets){if(sheets.length>1){showDialog=true;if(table.currentIndex&&table.currentIndex!==-1){defaultSheetsIndex=$ARR.find(sheets,"index",table.currentIndex);if(defaultSheetsIndex<0){defaultSheetsIndex=0;}}for(k=0;k<sheets.length;k++){if(k===defaultSheetsIndex){sheetsItem.push({idx:k,n:sheets[k].name,selected:true,title:sheets[k].name});}else{sheetsItem.push({idx:k,n:sheets[k].name,title:sheets[k].name});}}var sourceInfo=this.model.importSources[tables[i]].sourceInfo;var currentMapping=this.model.importSources[tables[i]].currentMapping;if(this.model.operationMode===constants.operationMode.create){if(currentMapping){multiSelection=sourceInfo&&sourceInfo.partition.isPartition?true:false;}else{multiSelection=true;}}else{if(sourceInfo&&sourceInfo.partition.type!==0){multiSelection=true;}else{if(!sourceInfo){multiSelection=true;}else{multiSelection=false;}}}if(status&&status.files){for(var key in status.files){if(status.files[key].tableID===tables[i]){if($HELPer.getEnvObj().isWSDossierLocalMode()){if(typeof status.files[key].fileName!=="undefined"){refreshFileName=$HELPer.getAbsoluteFileName(status.files[key].fileName);}}else{refreshFileName=status.files[key].fileName;}}}}items.push({n:refreshFileName||table.fileName||fileName||table.dbTableName,id:table.tableID,sheets:sheetsItem,multiSelection:multiSelection,defaultSheetsIndex:defaultSheetsIndex});}}}if(showDialog){config={items:items,onOK:function(){var sheetsSelectionDialog=this;var files=this.items;var controller=mstrApp.getRootController(),model=controller.model,importSources=model.importSources,tableID=this.items[0].id,sourceInfo=model.importSources[tableID].sourceInfo,j,params={},index,len,currentSheets,multiSheets,srcTableID;var filterFn=function(sheet){return sheet.selected;};mstrmojo.array.forEach(this.items,function(item){sheets=importSources[item.id].sheetsInfo;mstrmojo.array.forEach(sheets,function(sheet,k){if(item.sheets[k].selected){sheet.selected=true;}else{sheet.selected=false;}});});function getSheets(tableID){var selectedSheets=[];mstrmojo.hash.forEach(importSources[tableID].sheetsInfo,function(sheet){if(sheet.selected){selectedSheets.push({name:sheet.name,index:sheet.index});}});return selectedSheets;}if((model.operationMode===constants.operationMode.create&&(sourceInfo&&!sourceInfo.partition.isPartition))||!sourceInfo){for(j=0;j<files.length;j++){tableID=files[j].id;currentSheets=mstrmojo.array.filter(importSources[tableID].sheetsInfo,filterFn);len=currentSheets.length;multiSheets=len>1;for(i=0;i<len;i++){if(multiSheets){params.behaviorFlags=constants.behaviorChangeFlag.multiSheet;}index=currentSheets[i].index;if(i===0){params.shtIx=index;controller.autoMappingSourceTable(callback,tableID,params,tableID,action,status);}else{srcTableID=params.tbid=tableID;if(mstrmojo.all[srcWidgetID].scriptClass==="mstrmojo.DI.DIHadoop"){var fileUploader=controller.rootView.hadoopPage.getDropZone();params.url=importSources[tableID].fileName;var urlTag="?hdfsURL=";var fileTypeMap={};for(key in fileUploader.fileTypeMap){var tagIndex=key.indexOf(urlTag);var url=tagIndex>=0?key.substring(tagIndex+urlTag.length):key;fileTypeMap[url]=fileUploader.fileTypeMap[key];}if(fileTypeMap&&fileTypeMap[params.url]){params.fileType=fileTypeMap[params.url];}else{params.fileType=$HELPer.extractFileExtensionFromHadoopURL(params.url);}params.xt=(params.fileType.toUpperCase()===constants.fileTypes[0].v)?constants.xdaType.dataImportFileText:constants.xdaType.dataImportFileExcel;}controller.createEMMASourceTableMultiSheets(params,index,srcTableID,importSources[tableID].type,importSources[tableID].subtype,action,srcWidgetID);}}params={};}}else{var sheetsWidget=sheetsSelectionDialog.filesAndSheets.rightPanel.sheets;var selectedIndex;currentSheets=model.importSources[tableID].sheetsInfo;len=currentSheets.length;if(sourceInfo&&sourceInfo.partition&&sourceInfo.partition.isPartition){selectedIndex=sheetsWidget.selected.selectedIndices;for(i=0;i<len;i++){if(selectedIndex[i]){currentSheets[i].selected=true;}else{currentSheets[i].selected=false;}}controller.setPartition(tableID);}else{selectedIndex=sheetsWidget.selected.selectedIndex;if(selectedIndex===-1){var indices=sheetsWidget.selected.selectedIndices;for(i in indices){if(indices.hasOwnProperty(i)&&indices[i]){selectedIndex=parseInt(i);break;}}}for(i=0;i<len;i++){if(i!==selectedIndex){currentSheets[i].selected=false;}}currentSheets[selectedIndex].selected=true;index=currentSheets[selectedIndex].index;params.shtIx=index;controller.setDataImportInfo(tableID,params,tableID,action,status,callback);}}sheetsSelectionDialog.destroy();},onBack:function(){var me=this,controller=mstrApp.getRootController(),items=this.items,tableIDs=[],importSources=controller.model.importSources,callback={success:function(res){controller.dataService.set("messageID",res.msgid);$ARR.forEach(tableIDs,function(tableID){delete importSources[tableID];});me.unrender();},failure:function(res){controller.displayError(mstrmojo.desc(12797,"Cannot remove source table."),false,res.message||"");}};if(mstrmojo.all[srcWidgetID]&&!mstrmojo.all[srcWidgetID].tableID){$ARR.forEach(items,function(item){tableIDs.push(item.id);});controller.removeEMMASourceTable(callback,{did:tableIDs.join()});}else{delete importSources[items[0].id].sheetsInfo;importSources[items[0].id].sheetsInfo=importSources[items[0].id].originalSheetsInfo;me.unrender();}}};var importSources=this.model.importSources;if(importSources[tables[0]].tableIdx>=0){var j;var tableID,params={};var controller=mstrApp.getRootController();for(j=0;j<items.length;j++){tableID=items[j].id;params.shtIx=importSources[tables[j]].tableIdx;controller.autoMappingSourceTable(j===items.length-1?callback:null,tableID,params,tableID,action,status);params={};}}else{this.showDialog(constants.dialogType.sheetsSelectionDialog,config);}}},restoreForLaunchingApp:function restoreForLaunchingApp(){var controller=this;var model=controller.model;var launchingApp=mstrApp.launchingApp;var defRequestFlags=constants.requestFlag.mapping|constants.requestFlag.sourceInfo|constants.requestFlag.relationship;var tableID;switch(launchingApp){case"QB":tableID=mstrApp.tableID;if(mstrApp.messageID){controller.dataService.set("messageID",mstrApp.messageID);controller.getImportedDataEMMA(actions.importSource,defRequestFlags);}break;default:if(model.operationMode===constants.operationMode.create){controller.showPage(constants.pageType.dataSelection);}else{if(model.operationMode===constants.operationMode.enterCredentials){controller.showDialog(constants.dialogType.credentialsDialog,{model:model.documentModel});}else{if(mstrApp.isEMMACube&&(model.operationMode===constants.operationMode.refresh)){if(controller.model.datasets){controller.showDialog(constants.dialogType.cubesList,{left:"200px"});}else{this.republishEMMACube();}}else{if(mstrApp.isEMMACube&&(model.operationMode===constants.operationMode.subscribe)){this.republishEMMACube();}else{if(model.operationMode===constants.operationMode.pickTable){controller.showPage(constants.pageType.database,{sourceType:constants.sourceType.querybuilder,name:"Database",step2:mstrmojo.desc(12460,"Select one or more tables"),type:constants.xdaType.qbSingleTable,extParams:{defaultDbrId:mstrApp.diParams&&mstrApp.diParams.defaultDbrId}});}else{if(model.operationMode===constants.operationMode.hadoopPickTable){controller.showPage(constants.pageType.database,{sourceType:constants.sourceType.querybuilder,name:"hadoop",step2:mstrmojo.desc(12460,"Select one or more tables"),type:constants.xdaType.qbSingleTable,subtype:constants.sourceSubtype.hadoop,extParams:{defaultDbrId:mstrApp.diParams&&mstrApp.diParams.defaultDbrId,isHadoopQB:true}});}else{if(model.operationMode===constants.operationMode.ffsql){controller.showPage(constants.pageType.database,{sourceType:constants.sourceType.querybuilder,name:"Database",step2:mstrmojo.desc(12460,"Select one or more tables"),type:constants.xdaType.ffsql,extParams:{defaultDbrId:mstrApp.diParams&&mstrApp.diParams.defaultDbrId}});}else{if(model.operationMode===constants.operationMode.hadoopFFsql){controller.showPage(constants.pageType.database,{sourceType:constants.sourceType.querybuilder,name:"hadoop",step2:mstrmojo.desc(12460,"Select one or more tables"),type:constants.xdaType.ffsql,subtype:constants.sourceSubtype.hadoop,extParams:{defaultDbrId:mstrApp.diParams&&mstrApp.diParams.defaultDbrId,isHadoopQB:true}});}else{this.fetchCubeInfoEMMA();}}}}}}}}break;}},checkAndShowPrivilegeMsg:function checkAndShowPrivilegeMsg(){var controller=this,model=this.getModel(),privilege=model.hasPrivilegesForAllTables($H.valarray(model.importSources)),confirmMsg=mstrmojo.desc(13914,"You do not have the right privilege to make changes. Contact your administrator."),closeFn;closeFn=function(){controller.cancelApplication();};if(!privilege){mstrmojo.alert(confirmMsg,closeFn,"",controller.getDialogController().getNextZIndex());}return privilege;},setModalNodes:function(modalNodes,bIncludeFooter,modalZIndex){var nodes=[];nodes=nodes.concat(modalNodes);if(bIncludeFooter!==false){nodes.push(this.rootView.footerNode);}return this.rootView.setModalNodes(nodes,modalZIndex);},clearModalNodes:function(){return this.rootView.clearModalNodes();},getCubeInfo:function getCubeInfo(cubeID){var me=this,callback={success:function(res){var datasets=mstrmojo.hash.copy(me.model.cubesInfo);mstrmojo.hash.forEach(datasets.cubes.cube,function(cubeInfo){if(cubeInfo.cube_id===cubeID){cubeInfo.mdt=res[cubeID].mdt;}});me.model.set("cubesInfo",-1);me.model.set("cubesInfo",datasets);}};this.dataService.getUserDICubeInfo(callback,{cubeIds:cubeID});},getCubeQuota:function getCubeQuota(extraCallback,params){if($HELPer.isWS()){this.getCubeQuotaForRest(extraCallback);}else{this.getCubeQuotaForWeb(extraCallback,params);}},getCubeQuotaForWeb:function(extraCallback,params){var me=this;var callback={success:function(res){if(!mstrApp.diParams){return ;}if(res.cubes&&res.cubes.cube){res.cubes.cube=[].concat(res.cubes.cube);}if(res.cubes&&res.cubes.doc){res.cubes.doc=[].concat(res.cubes.doc);}me.model.set("cubesInfo",res);},failure:function(){me.model.set("cubesInfo",-1);}};if(extraCallback){callback=mstrmojo.func.wrapMethods(callback,extraCallback,{});}mstrApp.serverRequestParallel(mstrmojo.hash.copy(params,{taskId:"qBuilder.GetQuota"}),callback);},getCubeQuotaForRest:function(extraCallback){var me=this;var callback={success:function(res){if(res&&res.usage!==undefined&&res.size!==undefined){var size=(res.size<=0)?res.size:res.size/ONE_MB;var cubesInfo={cubes:{cusage:res.usage/ONE_MB,cquota:size}};me.model.set("cubesInfo",cubesInfo);}else{me.model.set("cubesInfo",-1);}},failure:function(){me.model.set("cubesInfo",-1);}};if(extraCallback){callback=mstrmojo.func.wrapMethods(callback,extraCallback,{});}this.dataService.getCubeQuotaByRestAPI(callback);},openMailClient:function openMailClient(url){this.getDataService().openMailClient(url);},displayCubesInfo:function displayCubesInfo(){var controller=this,cubeListType=constants.dialogType.cubesList;if(this.model.cubesInfo===0){var warningMessage=mstrmojo.desc(14657,"We are still fetching your cubes information. Please try again later."),warningTitle=mstrmojo.desc(14658,"Cube Quota Unavailable");this.displayWarning(warningMessage,warningTitle);return ;}if(this.model.cubesInfo===-1){return ;}if(controller.getDialogController().hasDialog(cubeListType)){controller.showDialog(cubeListType,{left:"200px"});}else{controller.getScheduleController().updateScheduleAndStatus({complete:function(){controller.showDialog(cubeListType,{left:"200px"});}});}},openOAuthParaDialog:function openOAuthParaDialog(event,config){this.showDialog(constants.dialogType.setOAuthParaDialog,config);},openWhiteListDialog:function openWhiteListDialog(event,config){this.showDialog(constants.dialogType.setWhiteListDialog,config);},openEditConnectorDialog:function openEditConnectorDialog(event,config){this.showDialog(constants.dialogType.addConnectorDialog,config);},getAnalyticsWebProperties:function getAnalyticsWebProperties(accountID){this.oAuthController.getAnalyticsWebProperties(accountID);},getAnalyticsProfiles:function getAnalyticsProfiles(accountID,webPropertyID){this.oAuthController.getAnalyticsProfiles(accountID,webPropertyID);},getOAuthSourceReports:function getOAuthSourceReports(type,sendOAuthDetails,slot,query,cb){this.oAuthController.getOAuthSourceReports(type,sendOAuthDetails,slot,query,cb);},oAuthSourceBrowserFunction:function(type,node,path,address){this.oAuthController.oAuthSourceBrowserFunction(type,node,path,address);},oAuthSourceFetchFunction:function(type,params){this.oAuthController.oAuthSourceFetchFunction(type,params);},projectSourceBrowserFunction:function(browser,folderId,selectedDBRoleId){var me=this;var callback={success:function(res){var list=me.parseProjectSourceFolder(res);browser.set("fileList",list);},failure:function(){browser.set("fileList",[]);}};this.getProjectSourceFolderContents(callback,folderId,selectedDBRoleId);},getProjectSourceFolderContents:function getProjectSourceFolderContents(callback,fid,dbrid){var params={objectType:"8,768,769,774,776",dbrid:dbrid};if(fid){params.objectId=fid;}this.dataService.fetchRemoteFolderContents(callback,params);},parseProjectSourceFolder:function parseProjectSourceFolder(res){if(!res.items){return[];}var resultItems=res.items,items=[],resultItem,item,i;if(!resultItems.length){return[];}for(i=0;i<resultItems.length;i++){resultItem=resultItems[i];item={isFolder:false};switch(resultItem.t){case 8:item.isFolder=true;if(resultItem.isc===true){item.type="shortcut";item.iconFolderClosed="mstrmojo-di-tree-node-icon shortcut-closed";item.iconFolderOpen="mstrmojo-di-tree-node-icon shortcut-open";}else{item.type="folder";}break;case 3:switch(resultItem.st){case 768:item.type="grid";break;case 769:item.type="graph";break;case 774:item.type="gridGraph";break;case 776:item.type="cube";break;case 779:item.type="emmaCube";break;}break;}item.n=resultItem.n;item.address=resultItem.did;item.desc=resultItem.desc;items.push(item);}return items;},getOAuthSourceFolderContents:function getOAuthSourceFolderContents(type,params,callback){this.oAuthController.getOAuthSourceFolderContents(type,params,callback);},oneTierImportFile:function oneTierImportFile(callback,params){this.dataService.oneTierImportFile(callback,params);},launchOneTierBrowser:function launchOneTierBrowser(callback){this.dataService.launchOneTierBrowser(callback);},scrapeWiki:function scrapeWiki(searchString,shouldSuggest){var controller=this,callback={success:function(res){mstrApp.hideProgress();if(shouldSuggest){controller.model.populateWikiSuggestions(res);}else{controller.model.populateWikiSearchResults(res);}},failure:function(err){mstrApp.hideProgress();if(shouldSuggest){controller.model.populateWikiSuggestions([undefined,[]]);}else{controller.displayError(mstrmojo.desc(640,"Your request could not be processed due to a server error."),false,err.message);}},canceled:function(){mstrApp.hideProgress();if(shouldSuggest){controller.model.populateWikiSuggestions([undefined,[]]);}else{controller.model.populateWikiSearchResults([]);}}},params={searchString:searchString};if(shouldSuggest){params.shouldSuggest=true;}this.getDataService().scrapeWiki(callback,params);},parseOAuthSourceFolder:function parseOAuthSourceFolder(type,res){return this.oAuthController.parseOAuthSourceFolder(type,res);},readyForSubscription:function readyForSubscription(){mstrmojo.all.mstrOAuthFW.set("oAuthReady",true);},sourceSelected:function sourceSelected(selected){if(selected){this.rootView.showFooter({next:{enabled:true}});this.rootView.showFooter({finish:{enabled:true}});this.forceImport=true;}else{this.rootView.showFooter({next:{enabled:false}});this.rootView.showFooter({finish:{enabled:false}});}},enableFinishButton:function enableFinishButton(enable){if(enable){this.rootView.showFooter({finish:{enabled:true}});}else{this.rootView.showFooter({finish:{enabled:false}});}this.sourceSelected(enable);},showPreview:function showPreview(show){var enabled=false;if(this.model.operationMode===constants.operationMode.create){enabled=true;}if(show){this.rootView.showFooter({next:{text:mstrmojo.desc(212,"Continue"),enabled:enabled}});}else{this.rootView.showFooter({next:{text:mstrmojo.desc(1302,"Finish"),enabled:enabled}});}},onBackButtonClick:function onBackButtonClick(){this.rootView.currentPage.onBackButtonClick();},onNextButtonClick:function onNextButtonClick(){this.rootView.currentPage.onNextButtonClick();},onSaveButtonClick:function onSaveButtonClick(){if(this.rootView.currentPage.onSaveButtonClick){this.rootView.currentPage.onSaveButtonClick();}},onFinishButtonClick:function onFinishButtonClick(){this.rootView.currentPage.onFinishButtonClick();},onCancelButtonClick:function onCancelButtonClick(isConnector){if(!isConnector){this.model.refreshToWrangle=null;}if(typeof this.rootView.currentPage.onCancelButtonClick==="function"){if(this.rootView.currentPage.onCancelButtonClick()){return ;}}if(this.dialogController.pageZIndex>0){this.rootView.parent.close();}else{this.cancelApplication();}},onHelpButtonClick:function onHelpButtonClick(){mstrApp.showHelpTopic(this.rootView.currentPage.onHelpButtonClick());},gotoOAuthLogin:function navigate(type,forceRefreshTokenFetch,slot,cb){if(mstrApp.isSingleTier||$HELPer.isServerBasedWS()){if(window.FormWrapper.testInternetConnection()!==0){var errorMessage=mstrmojo.desc(13961,"No Internet connection. You can configure an Internet proxy through your computer's #."),replaceStr='<a href="" onclick="mstrApp.getRootController().dialogController.close(mstrmojo.DI.DIConstants.dialogType.errorDialog);window.setTimeout(function(){window.FormWrapper.showProxyEditor();},100);return false;">'+mstrmojo.desc(14125,"settings")+"</a>";errorMessage=errorMessage.replace("#",replaceStr)+".";this.displayError(errorMessage,false,"",null,mstrmojo.desc(11812,"Notification"));return ;}this.oAuthController.oneTierOAuth(type,forceRefreshTokenFetch,slot,cb);}else{mstrApp.originUrl=window.location.href;this.oAuthController.getWebServiceURL(type,forceRefreshTokenFetch,slot,cb);}},setTableIDsForOAuth:function setTableIDsForOAuth(tableIDs){this.oAuthController.tableIDs=tableIDs;},oAuthSignOut:function oAuthSignOut(type){this.oAuthController.oAuthSignOut(type);},launchWranglerDialog:function launchWranglerDialog(source){var controller=this;var startRefine=function startRefine(){if(!source.projectID){var xml="<rss><rpo></rpo></rss>";controller.startRefineStage(source.tableID,2,xml,source.sourceInfo.isRefined);}else{controller.refine(source.projectID,source.tableID);}};if(!(source.sourceInfo&&source.sourceInfo.hasAggFilter)){startRefine();}else{mstrmojo.confirm(mstrmojo.desc(12720,"Previous changes made in aggregation will be discarded. Would you like to continue?"),{confirmBtn:{fn:function(){controller.dataService.cancelAggFilter({success:function success(res){controller.dataService.set("messageID",res.msgid);var flags=constants.requestFlag.mapping|constants.requestFlag.sourceInfo|constants.requestFlag.relationship|constants.requestFlag.preview|constants.requestFlag.transformations;var cb={success:function(){startRefine();}};mstrApp.getRootController().editImportedDataEMMA(flags,null,null,null,source.tableID,null,null,null,null,true,cb);}},{tbid:source.tableID});}}});}},refine:function refine(rpid,tableID){if(!this.refineApp){this.refineApp=new mstrmojo.Refine.Refine();}this.refineApp.start(this.getModel().refineServerURL,rpid,tableID);this.showDialog(constants.dialogType.refinePage,{tableID:tableID});},importFile:function importFile(fileUploader,fileName,fetchPreview,multiFile){if(!this.forceImport){this.showPage(constants.pageType.preview);return ;}this.fetchPreview=fetchPreview;var model=this.model;var cubeID=this.model.cubeID;var controller=this;var params={fileName:fileName};if(cubeID){params.reportid=cubeID;}params.behaviorFlags=constants.importBehaviorFlag.reserved;if(this.model.operationMode===constants.operationMode.refresh||this.model.operationMode===constants.operationMode.edit){if(mstrApp.isCloudPro){params.behaviorFlags=constants.importBehaviorFlag.newColumnsSilent|constants.importBehaviorFlag.dataTypeSilent;}}var callback={success:function(res){var flags=constants.requestFlag.anyState|constants.requestFlag.mapping|constants.requestFlag.sourceInfo|constants.requestFlag.sheets|constants.requestFlag.preview|constants.requestFlag.transformations,sheet=fetchPreview?0:-1;var msg_id=res.msg_id||res.content.mst_id;if(multiFile){model.importSources.tableID=msg_id;return ;}controller.dataService.set("messageID",msg_id);mstrApp.hideProgress();controller.getImportedData(actions.refine,flags,sheet,undefined,0);},failure:function(res){mstrApp.hideProgress();controller.displayError(mstrmojo.desc(12771,"Error in importing the file. Please check the file being imported"),false,res&&res.message);},progress:function(evt,config){if(evt.lengthComputable){var complete=(evt.loaded/evt.total);mstrApp.setProgressParams(complete,config);}}};controller.dataService.importFile(fileUploader,callback,params);},importFileEMMA:function importFileEMMA(fileUploader,fileName,fetchPreview,bCreateReportInstance,srcWidgetID,hasExcelFile,action){this.getImportController().importFile(fileUploader,fileName,fetchPreview,bCreateReportInstance,srcWidgetID,hasExcelFile,action);},resetAppforRepublish:function resetAppforRepublish(cube){this.model.initParams({ReportId:cube.cubeID,CubeName:cube.cubeName,StatusCode:constants.statusCode.republish,AnalysisId:undefined,datasets:null});this.republishEMMACube();},resetAppforImport:function resetAppforImport(){this.model.resetImportSource();this.model.initParams({ReportId:undefined,CubeName:undefined,StatusCode:undefined,AnalysisId:undefined,datasets:null});this.dataService.messageID=undefined;},browseURLPath:function browseURLPath(urlPath,urlListComponent,dbrid,cbs){var controller=this,params={};urlPath=urlPath.trim();if(urlPath===""){controller.displayError(mstrmojo.desc(12773,"Please enter a valid network path."),false);return ;}if(!isValidProtocol.call(this,urlPath)){controller.displayError(mstrmojo.desc(12512,"We do not support the URL protocol you provided."),false);return ;}try{if(decodeURI(urlPath)===urlPath&&!mstrmojo.string.startsWith(urlPath.toLowerCase(),"file://")){urlPath=encodeURI(urlPath);}}catch(err){}if(urlPath.substring(0,1)==="\\"){urlPath=urlPath.replace(/\\\\/g,"file://");urlPath=urlPath.replace(/\\/g,"/");}if(typeof String.prototype.trim!=="function"){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"");};}urlPath=urlPath.trim();if(urlPath.charAt(urlPath.length-1)!=="/"){urlPath=urlPath+"/";}params.urlPath=urlPath;if(dbrid){params.dbRoleID=dbrid;}var callback={success:function(res){var items=controller.parseURLFolders(res);if(res.mi.ftree===""||items.length<=0){controller.displayError(mstrmojo.desc(12774,"We could not find anything. Please verify that you have entered a valid network path."),false);}if(urlListComponent.getObjectBrowser){urlListComponent.getObjectBrowser().set("fileList",items);if(cbs){cbs(urlListComponent.getObjectBrowser(),items);}}else{urlListComponent.set("fileList",items);}},failure:function(res){controller.displayError(mstrmojo.desc(12775,"Uh-Oh, Error fetching the list of files for the given network path: "),false,res&&res.message);}};this.dataService.getOAuthSourceReports(callback,params);},urlBrowserFunction:function(node,dbrid){this.browseURLPath(node.data.address,node.data.browser,dbrid);},executeCommand:function executeCommand(cmdId,cmdValue){switch(cmdId){case"loginToProxy":this.loginToProxy(cmdValue);break;case"loginToWebserver":this.loginToWebserver(cmdValue);break;case"loginToProject":this.loginToProject(cmdValue);break;case"shutDownDesktop":this.shutDownDesktop(cmdValue);break;default:break;}},loginToWebserver:function loginToWebserver(params){mstrmojo.onetier.controllers.RootController.prototype.loginToWebserver.call(this,params);},loginToProxy:function loginToProxy(params){mstrmojo.onetier.controllers.RootController.prototype.loginToProxy.call(this,params);},loginToProject:function loginToProject(params){mstrmojo.onetier.controllers.RootController.prototype.loginToProject.call(this,params);},shutDownDesktop:function shutDownDesktop(params){mstrmojo.onetier.controllers.RootController.prototype.shutDownDesktop.call(this,params);},shutDownServerBased:function(params){window.FormWrapper.closeWindow(params);},parseURLFolders:function parseURLFolders(res){var items=[];var fds=res.mi.ftree.fd?[].concat(res.mi.ftree.fd):[];var fls=res.mi.ftree.fl?[].concat(res.mi.ftree.fl):[];var fd,fl,i,item;for(i=0;i<fds.length;i++){fd=fds[i];item={isFolder:true};item.n=(fd.n===null?"null":fd.n.toString());item.desc=fd.des;item.address=fd.address;items.push(item);}for(i=0;i<fls.length;i++){fl=fls[i];item={isFolder:false};item.n=(fl.n===null?"null":fl.n.toString());item.address=fl.address;item.type=fl.mimetype;item.desc=fl.des;item.size=fl.sz;items.push(item);}return items;},importURL:function importURL(url,fetchPreview){if(!this.forceImport){this.showPage(constants.pageType.preview);return ;}this.fetchPreview=fetchPreview;var params={url:replaceWithEscapeSequences(url.trim())};var cubeID=this.model.cubeID;if(cubeID){params.reportid=cubeID;}params.behaviorFlags=constants.importBehaviorFlag.reserved;if(this.model.operationMode===constants.operationMode.refresh||this.model.operationMode===constants.operationMode.edit){if(mstrApp.isCloudPro){params.behaviorFlags=constants.importBehaviorFlag.newColumnsSilent|constants.importBehaviorFlag.dataTypeSilent;}}var controller=this;var callback={success:function(res){var requestFlags=constants.requestFlag.sourceInfo|constants.requestFlag.sheets|constants.requestFlag.preview|constants.requestFlag.mapping|constants.requestFlag.transformations,sheet=controller.fetchPreview?0:-1;controller.dataService.set("messageID",res.msg_id);controller.getImportedData(actions.importSource,requestFlags,sheet);},failure:function(res){controller.displayError(mstrmojo.desc(12776,"Error importing the URL. Please check the URL being imported"),false,res&&res.message);}};this.dataService.importURL(callback,params);},importURLEMMA:function importURLEMMA(urlUploader,url,fetchPreview,bCreateReportInstance,srcWidgetID,hasExcelFile,action){this.getImportController().importURL(urlUploader,url,fetchPreview,bCreateReportInstance,srcWidgetID,hasExcelFile,action);},createEMMASourceTableMultiSheets:function createEMMASourceTableMultiSheets(params,sheetIndex,srcTableID,sourceType,subType,action,srcWidgetID){var controller=this,source,dbrole;if(!params){params={};}if(mstrmojo.all[srcWidgetID].scriptClass==="mstrmojo.DI.DIHadoop"){params.xt=params.xt||constants.xdaType.dataImport;}else{params.xt=constants.xdaType.dataImport;}params.dict=$HELPer.getBackendSourceType(subType);var currentUrl=controller.model.importSources[srcTableID].fileName;if($STR.startsWith(currentUrl,TABLE_NAME_TAG)&&subType!==constants.sourceSubtype.cloudElement){params.dict=constants.backendSourceSubtype.newConnector;}var callback={success:function(res){var tableID=res.tbid,cb,src=controller.model.importSources[srcTableID],localParams;params.shtIx=sheetIndex;localParams=mstrmojo.hash.clone(params);localParams.url=src.fileName;controller.model.createImportSource(sourceType,subType,tableID);var currSource=controller.model.importSources[tableID];mstrmojo.DI.DIHelpers.setTablesrc(controller,srcWidgetID,tableID);currSource.srcTableID=srcTableID;currSource.sheetsInfo=src.sheetsInfo;function setImportUrl(){controller.setDataImportInfoURL(cb,localParams,tableID);}cb={success:function(res){controller.autoMappingSourceTable({failure:function(res){controller.removeEMMASourceTable(null,{did:tableID});controller.displayError(mstrmojo.desc(12900,"Error importing following files. Please check the files or delete them."),false,res&&res.message);}},tableID,localParams,srcTableID,action);},failure:function(){controller.removeEMMASourceTable(null,{did:tableID});controller.displayError(mstrmojo.desc(12900,"Error importing following files. Please check the files or delete them."),false,res&&res.message);}};if(mstrApp.getRootController().rootView.currentPage.pageType===constants.pageType.hadoop){setImportUrl();}else{cb.success();}},failure:function(res){controller.displayError(mstrmojo.desc(12777,"Error creating EMMA Source Table"),false,res&&res.message);}};source=controller.getModel().getImportSource(srcTableID);dbrole=source&&source.dbRoleId;if(dbrole){this.dataService.createEMMASourceTable({success:function(res){controller.getDataService().setDBRole({success:function(){callback.success(res);},failure:function(res){if(callback.failure){callback.failure(res);}}},{tbid:res.tbid,dbrid:dbrole});},failure:function(res){callback.failure(res);}},params);}else{this.dataService.createEMMASourceTable(callback,params);}},autoMappingSourceTable:function autoMappingSourceTable(callback,tableID,params,srcTableID,action,status){var controller=this;var sheetIndex=params.shtIx;var model=controller.model;var importSources=model.importSources;var currentSource=importSources[tableID];var sourceInfo=importSources[tableID].sourceInfo;var successStatus;var tableIDs=[];if(tableID){if(!params){params={};}params.tbid=tableID;delete params.xt;}if(currentSource.fileName&&$HELPer.strStartsWith(currentSource.fileName.toLowerCase(),"hdfs://")){params.dbRoleID=controller.hadoopController.dbRoleID;params.isUrl=true;}if(currentSource&&(currentSource.subtype===constants.sourceSubtype.url||currentSource.subtype===constants.sourceSubtype.samplefile||currentSource.subtype===constants.sourceSubtype.publicData||currentSource.subtype===constants.sourceSubtype.cloudElement)){params.isUrl=true;if(currentSource.xdaType===constants.xdaType.excel){params.url=currentSource.fileName||currentSource.sourceInfo.url;}}if(sourceInfo){params.behaviorFlags=constants.behaviorChangeFlag.refreshData;}var excelAMCallback={success:function(){setAutoMappingStatus(srcTableID,sheetIndex,importSources,true);if(action!==constants.actions.refreshData&&(model.operationMode===constants.operationMode.create||(model.operationMode!==constants.operationMode.create&&!sourceInfo))){var status=checkAutoMappingStatus.call(controller,importSources);if(status){successStatus=checkAutoMappingSuccessStatus.call(controller,importSources,action);if(model.operationMode===constants.operationMode.create){if(successStatus===1){for(var k in importSources){tableIDs.push(k);}controller.detectRelationshipSourceTable(null,tableIDs,action);}}else{if(successStatus===1){for(var k in importSources){if(!importSources[k].sourceInfo){tableIDs.push(k);}}controller.detectRelationshipSourceTable(null,tableIDs,action);}}}}else{controller.detectRelationshipSourceTable(null,[tableID],action);}if(callback&&callback.success&&successStatus!==1){callback.success();}},failure:function(res){var idx;setAutoMappingStatus(srcTableID,sheetIndex,importSources,false);if(tableID&&status){mstrmojo.hash.forEach(status.files,function(value,key){if(value.tableID===tableID){idx=key;return false;}return true;});}if(idx!==undefined){status.files[idx].failed=true;status.files[idx].errRes=res;status.idx=idx;}if(mstrApp.isNewConnectorEdit&&parseInt(res.code,10)===constants.backendError.switchingFileType&&controller.rootView.currentPage.pageType===constants.pageType.emmaPreview){controller.rootView.footer.next.set("enabled",false);controller.rootView.footer.save.set("enabled",false);status.files[idx].errRes=getBackendErrorMessage(res)+" "+mstrmojo.desc(16032,"You need to cancel and check file type.");}if(callback&&callback.failure){callback.failure(res);}}};controller.dataService.autoMappingSourceTable(excelAMCallback,params);},setDataImportInfo:function setDataImportInfo(tableID,params,srcTableID,action,status,cb){var controller=this;params.tbid=tableID;var callback={success:function(){controller.autoMappingSourceTable(cb,tableID,params,tableID,action,status);},failure:function(res){controller.displayError(mstrmojo.desc(12779,"Encounter error when set data import info!"),false,res&&res.message);}};controller.dataService.setDataImportInfo(callback,params);},setPartition:function setPartition(tableID,urls){var me=this,source=me.model.importSources[tableID],cnt=0,msg=mstrmojo.desc(14707,"Do you want to group these sheets into a single partition table?");if(source.xdaType===constants.xdaType.excel){var currentSheets=source.sheetsInfo;var i,len=currentSheets.length;var sheetsName=[],sheetsIndex=[];for(i=0;i<len;i++){if(currentSheets[i].selected){cnt++;sheetsName.push(currentSheets[i].name);sheetsIndex.push(currentSheets[i].index);}}if(cnt>1){mstrmojo.confirm(msg,{confirmBtn:{fn:function(){me.partitionController.setPartitionExcel(tableID,sheetsName,sheetsIndex);}},cancelBtn:{fn:function(){if(source&&source.originalSheetsInfo){source.sheetsInfo=source.originalSheetsInfo;}}}});}else{me.partitionController.setPartitionExcel(tableID,sheetsName,sheetsIndex);}}else{if(source.xdaType===constants.xdaType.text){this.partitionController.setPartitionURL(tableID,urls);}}},setDataImportInfoURL:function setDataImportInfoURL(cb,params,srcTableID){var controller=this;var model=controller.model;params.tbid=srcTableID;var currentSource=model.importSources[srcTableID];var uploader=controller.rootView.hadoopPage?controller.rootView.hadoopPage.getDropZone():null;if(currentSource.fileName&&$HELPer.strStartsWith(currentSource.fileName.toLowerCase(),"hdfs://")){params.dbRoleID=controller.hadoopController.dbRoleID;}var callback={success:function(res){var source=model.getImportSource(srcTableID);if(source){source.fileName=params.url;if(uploader&&uploader.isFolder){source.isFolder=uploader.isFolder(source.fileName);}}if(model.operationMode===constants.operationMode.edit){controller.dataService.editEMMASourceTable(cb,{did:srcTableID,tp:constants.cubeRefreshType.replaceTable,exef:constants.tableStatsExecutionAction.forceExecution,bin:1});}else{if(cb.success){cb.success(res);}}},failure:function(res){if(cb.failure){cb.failure(res);}controller.displayError(mstrmojo.desc(12779,"Encounter error when set data import info!"),false,res&&res.message);controller.sourceSelected(false);}};controller.dataService.setDataImportInfo(callback,params);},autoDetectPartitionGroups:function autoDetectPartitionGroups(dialogCallback,sheet,isMergedCube,changedTables){var controller=this,model=this.model,flags=constants.requestFlag.mapping|constants.requestFlag.sourceInfo|constants.requestFlag.relationship|constants.requestFlag.stateInfo,params,partitionCallback;params={previewflag:flags};if(sheet!==undefined){params.sheetIndex=sheet;}if(!controller.dataService.messageID&&model.cubeID){params.reportid=model.cubeID;}partitionCallback={success:function(res){if(isMergedCube){mstrmojo.array.forEach(res.datap,function(value){value.isMergedCube=isMergedCube;});}var isEditForWrangle=false;if(changedTables&&model.refreshToWrangle){isEditForWrangle=true;model.refreshToWrangle=null;}if(changedTables){model.populateEMMA(res,flags,undefined,true);}else{model.populateEMMA(res,flags);}var tables,partitionGroups,partitionController=controller.partitionController,newCallback={onOK:function(){if(changedTables){var autoMapCallback={success:function(){if(isEditForWrangle){model.refreshToWrangle=model.editingTableId;}mstrmojo.array.forEach(changedTables,function(tempTable){if(tempTable.tid){model.resetImportSource(tempTable.tid);}});dialogCallback.onOK();},failure:function(res){controller.displayError(mstrmojo.desc(12778,"Encountered an error when doing auto mapping!"),false,res.message||"",function(){dialogCallback.onCancel();});}},source=model.importSources[model.editingTableId],param={tables:JSON.stringify([{tid:source.tableID}]),flag:16};var prepareDataCallback={success:function(){controller.dataService.autoMap(autoMapCallback,param);},failure:function(res){dialogCallback.onCancel();}};controller.dataService.prepareData(prepareDataCallback,{tables:model.editingTableId},true);return ;}dialogCallback.onOK();},onCancel:function(){var data=changedTables?undefined:res;dialogCallback.onCancel(data);}};tables=changedTables?changedTables.map(function(value,index){return value.tid;}):model.getAllTableID();var isEditTable=changedTables&&changedTables.length>0;partitionGroups=model.detectPartitionGroups(tables,isEditTable);newCallback.success=newCallback.onOK;newCallback.failure=function(res){controller.displayError(mstrmojo.desc(12391,"Cannot group partitions."),false,res.message||"",function(){dialogCallback.onCancel();});};if(changedTables&&partitionGroups.length<=1){controller.partitionController.setPartition(model.editingTableId,changedTables.map(function(value,index){return value.tid;}),newCallback);return ;}if(partitionGroups.length>0&&!partitionController.isSamePartitionGroups(partitionGroups,model.partitionGroups)){model.partitionGroups=partitionGroups;partitionController.openPartitionGroupDialog(partitionGroups,newCallback,isEditTable);return ;}newCallback.onCancel();},failure:function(res){controller.displayError(mstrmojo.desc(12624,"Error fetching information about the imported data. Please check the data being imported."));}};controller.dataService.getImportedData(partitionCallback,params);},detectRelationshipSourceTable:function detectRelationshipSourceTable(callback,tableID,action){var controller=this,i=0,cnt;var onNewFilesImported={success:function(){i++;if(i>=cnt){var flags=constants.requestFlag.mapping|constants.requestFlag.sourceInfo|constants.requestFlag.relationship|constants.requestFlag.stateInfo,dialogCallback,allTables;if(action===actions.refreshData){action=action||constants.actions.importSource;controller.model.importSources[controller.model.currentSource.key].invalidPreview();}dialogCallback={onOK:function(){controller.getImportedDataEMMA(action,flags);},onCancel:function(data){controller.getImportedDataEMMA(action,flags,undefined,undefined,undefined,undefined,undefined,data);}};allTables=controller.getModel().getAllTableID();if(!controller.rootView.currentPage.tableID&&!controller.model.isDirectDataAccess&&allTables.length>=2){controller.autoDetectPartitionGroups(dialogCallback);}else{controller.getImportedDataEMMA(action,flags);}}},failure:function(status){handleFileImportError.call(controller,status);}};cnt=tableID.length;action=action||constants.actions.importSource;if(tableID.length>0){$ARR.forEach(tableID,function(id){controller.dataService.detectRelationshipSourceTable(onNewFilesImported,{did:id});});}},importOAuthReport:function importOAuthReport(type,name,desc,address,fetchPreview,mimetype){var oAuthSource=this.model.externalSources[type];var controller=this;var requestFlag=constants.requestFlag.sourceInfo|constants.requestFlag.preview|constants.requestFlag.mapping|constants.requestFlag.anyState;if(type===constants.sourceType.googleDrive||type===constants.sourceType.dropbox){requestFlag=requestFlag|constants.requestFlag.sheets|constants.requestFlag.transformations;}this.fetchPreview=fetchPreview;var params=oAuthSource.getSourceParams();params.reportAddress=address;params.reportDesc=desc;params.reportMimetype=mimetype;params.reportName=name;if(this.model.cubeID){params.cubeID=this.model.cubeID;}params.behaviorFlags=constants.importBehaviorFlag.reserved;if(this.model.operationMode===constants.operationMode.refresh||this.model.operationMode===constants.operationMode.edit){if(mstrApp.isCloudPro){params.behaviorFlags=constants.importBehaviorFlag.newColumnsSilent|constants.importBehaviorFlag.dataTypeSilent;}}var callback={success:function(res){controller.dataService.set("messageID",res.xmlAPIResponse.mid);controller.getImportedData(actions.importSource,requestFlag);},failure:function(){controller.displayError(mstrmojo.desc(12611,"Error importing the selected report."));}};this.dataService.importOAuthReport(callback,params);},importMultiOAuthReports:function(type,reports,fetchPreview,bCreateInstance,action,subType,srcWidgetId){var controller=this,currentPage=controller.rootView.currentPage,tablesBefore,flags=constants.requestFlag.mapping|constants.requestFlag.sourceInfo|constants.requestFlag.relationship;var cb={success:function(){var tables;if(srcWidgetId){tables=controller.model.getAllTableID();controller.tablesSrc[srcWidgetId]=$HELPer.findNewElements(tablesBefore,tables);}}};var importDone={success:function(){action=action||constants.actions.importSource;controller.getImportedDataEMMA(action,flags,undefined,undefined,undefined,0,cb);},failure:function(res){var ret=true,detailMsg="",errorString="",i,tablesToDelete=[],config,allFailed=true;if(type===constants.sourceType.twitter||type===constants.sourceType.facebook){if(res.status){for(i=0;i<res.status.length;i++){var tableID=res.status[i].tableID;if(tableID){tablesToDelete.push(tableID);}}if(tablesToDelete.length>0){controller.getImportController().removeMultipleSourceTables(tablesToDelete);}}}switch(type){case constants.sourceType.twitter:errorString=mstrmojo.desc(12780,"Error importing results from Twitter.");break;case constants.sourceType.facebook:errorString=mstrmojo.desc(12781,"Error importing results from Facebook.");break;default:errorString=mstrmojo.desc(12782,"Error importing following reports. Please check the files or delete them.");}if(ret){if(res.reports&&res.status&&res.reports.length===res.status.length&&res.reports.length>0){detailMsg="<ul>";$ARR.forEach(res.reports,function(report,idx){if(res.status[idx].success===false){detailMsg+="<li>"+$STR.htmlAngles(report.n)+"<br>"+$STR.htmlAngles(res.status[idx].errMsg)||" </li>";}else{allFailed=false;}});detailMsg+="</ul>";}else{if(res.status&&res.status.errMsg){detailMsg=$STR.htmlAngles(res.status.errMsg);}}if(currentPage.handleImportError){ret=currentPage.handleImportError(res.reports,res.status,allFailed);}if(type===constants.sourceType.twitter||type===constants.sourceType.facebook||allFailed){controller.displayError(errorString,false,detailMsg);}else{config={detailErrorMessage:detailMsg,okBtnText:mstrmojo.desc(219,"Yes"),cancelBtnText:mstrmojo.desc(218,"No"),onCancel:mstrmojo.emptyFn};controller.displayWarning(mstrmojo.desc(13324,"Error importing the following files. Click 'Yes' to ignore the erroneous files and proceed with the successful files. Otherwise, click 'No' to check the erroneous files or delete them."),null,function(){action=action||constants.actions.importSource;controller.getImportedDataEMMA(action,flags,undefined,undefined,undefined,0,cb);},config);}}}};var reportInstanceCreated={success:function(){if(type===constants.sourceType.googleDrive||type===constants.sourceType.dropbox){controller.getImportController().importMultiOAuthFileReports(type,subType,reports,importDone);}else{if(type===constants.sourceType.facebook){controller.getImportController().importMultiFBReports(type,subType,reports,importDone);}else{controller.getImportController().importMultiOAuthReports(type,subType,reports,importDone);}}},failure:function(res){controller.displayError(mstrmojo.desc(12783,"Create EMMA Report Instance error. Please check the metadata."),false,res.message||"");}};var onPrevTablesRemoved={success:function(){controller.tablesSrc[srcWidgetId]=[];tablesBefore=controller.model.getAllTableID();if(bCreateInstance){controller.createNewReportInstance(reportInstanceCreated);}else{reportInstanceCreated.success();}}};if(srcWidgetId){checkAndRemoveTables(controller.tablesSrc[srcWidgetId],onPrevTablesRemoved);}else{onPrevTablesRemoved.success();}},refreshDataOAuthReport:function(type,subType,tableID,report,action){var controller=this,source=controller.getModel().getImportSource(tableID);var importDone={success:function(){var flags=constants.requestFlag.mapping|constants.requestFlag.sourceInfo|constants.requestFlag.relationship;action=action||constants.actions.importSource;source.invalidPreview();controller.getImportedDataEMMA(action,flags);},failure:function(res){controller.displayError(mstrmojo.desc(12784,"Error importing the report."),false,res.message);}};if(type===constants.sourceType.googleDrive||type===constants.sourceType.dropbox){controller.getImportController().refreshDataOAuthFileReport(type,subType,tableID,report,controller.getModel().operationMode,importDone);}else{controller.getImportController().refreshDataOAuthReport(type,subType,tableID,report,controller.getModel().operationMode,importDone);}},refreshMultiOAuthReports:function(type,subType,reports,action){var controller=this,cnt=0;var refreshDone={success:function(){controller.getModel().getImportSource(reports[cnt].tableID).invalidPreview();cnt++;if(cnt>=reports.length){refreshDoneAll.success();}else{refreshReport(reports[cnt],refreshDone);}},failure:function(res){refreshDoneAll.failure(res);}};var refreshDoneAll={success:function(){var flags=constants.requestFlag.mapping|constants.requestFlag.sourceInfo|constants.requestFlag.relationship;action=action||constants.actions.importSource;controller.getImportedDataEMMA(action,flags);},failure:function(res){controller.displayError(mstrmojo.desc(12785,"Error refreshing the report(s)."),false,res&&res.message);}};function refreshReport(report,callback){if(type===constants.sourceType.googleDrive||type===constants.sourceType.dropbox){controller.getImportController().refreshDataOAuthFileReport(type,subType,report.tableID,report,controller.getModel().operationMode,callback);}else{controller.getImportController().refreshDataOAuthReport(type,subType,report.tableID,report,controller.getModel().operationMode,callback);}}if(reports.length<=0){refreshDoneAll.failure();}refreshReport(reports[0],refreshDone);},importClipboard:function(fileUploader,bCreateInstance,action,srcWidgetId){var controller=this,tablesBefore;var reportInstanceCreated={success:function(){controller.getImportController().importClipboard({uploader:fileUploader},{success:function(){var flags=constants.requestFlag.mapping|constants.requestFlag.sourceInfo|constants.requestFlag.relationship,tables;action=action||constants.actions.importSource;var cb={success:function(){if(srcWidgetId){tables=controller.model.getAllTableID();controller.tablesSrc[srcWidgetId]=$HELPer.findNewElements(tablesBefore,tables);}if(action===constants.actions.importSource){fileUploader.destroy();}}};controller.getImportedDataEMMA(action,flags,undefined,undefined,undefined,0,cb);},failure:function(res){controller.displayError(mstrmojo.desc(12609,"Error in importing the file. Please check the file being imported."),false,res.message);}});},failure:function(res){controller.displayError(mstrmojo.desc(12783,"Create EMMA Report Instance error. Please check the metadata."),false,res.message||"");}};var onPrevTablesRemoved={success:function(){controller.tablesSrc[srcWidgetId]=[];tablesBefore=controller.model.getAllTableID();if(bCreateInstance){controller.createNewReportInstance(reportInstanceCreated);}else{reportInstanceCreated.success();}}};if(srcWidgetId){checkAndRemoveTables(controller.tablesSrc[srcWidgetId],onPrevTablesRemoved);}else{onPrevTablesRemoved.success();}},refreshDataClipboard:function(tableID,fileUploader,action){var controller=this,source=controller.getModel().getImportSource(tableID);var importDone={success:function(){var flags=constants.requestFlag.mapping|constants.requestFlag.sourceInfo|constants.requestFlag.relationship;action=action||constants.actions.importSource;source.invalidPreview();controller.getImportedDataEMMA(action,flags);},failure:function(res){controller.displayError(mstrmojo.desc(12784,"Error importing the report."),false,res.message);}};controller.getImportController().refreshDataClipboard(tableID,{uploader:fileUploader},controller.getModel().operationMode,importDone);},getImportedData:function getImportedData(action,requestFlags,sheetIndex,shouldPoll){var params={previewflag:requestFlags};if(shouldPoll!==undefined){params.poll=shouldPoll;}if(sheetIndex>=0){params.sheetIndex=sheetIndex;}if(action===actions.refine){params.refine=32;}var controller=this;var m=this.model;var callback={success:function(res){if(action===actions.refine){controller.refine(res.rpid);return ;}var sheetsDialog;if(action===actions.importSource||action===actions.changeSheet){if(m.currentSource){m.currentSource.reset();}m.populate(res,requestFlags);if(m.operationMode!==constants.operationMode.create){if(m.currentSource.sheets&&m.currentSource.sheets.length>1){sheetsDialog=mstrmojo.all[SHEETS_DIALOG_ID];if(!sheetsDialog){sheetsDialog=mstrmojo.insert(sheetsDialogConfig);sheetsDialog.model=m;sheetsDialog.open();}else{if(!controller.fetchPreview){controller.saveAndPublish();return ;}}}else{if(!controller.fetchPreview){controller.saveAndPublish();return ;}}}}if(action===actions.importSource||action===actions.changeSheet){if(controller.fetchPreview){controller.forceImport=false;controller.showPage(constants.pageType.preview);}if(m.currentSource){m.currentSource.reset();}if(sheetsDialog){sheetsDialog.destroy();}}var serviced=m.populate(res,requestFlags);if(action===actions.importSource){if((serviced&constants.requestFlag.preview)!==constants.requestFlag.preview){return ;}}if((serviced&constants.requestFlag.mapping)!==constants.requestFlag.mapping){controller.getImportedData(action,requestFlags,sheetIndex,false);return ;}},failure:function(res){var error=parseInt(res.getResponseHeader("X-MSTR-TaskErrorCode"),10);var status=constants.statusCode;if(error===status.mappingError||error===status.xformsError||error===status.obtainSource){controller.getImportedData(action,requestFlags,sheetIndex,false);}else{if(error===constants.backendError.fileVersionError){controller.displayError(mstrmojo.desc(12612,"Excel 5.0/7.0 files are not supported. Save the file to Excel version 97/2000/XP/2003 or higher."));}else{if(error===constants.backendError.salesforceUnsavedReport){controller.displayError(mstrmojo.desc(12786,"Cannot upload data because the Salesforce report Active Accounts has not been saved. Please save the report and try again!"));}else{if(error===constants.backendError.maxSizeExceeded){controller.displayError(mstrmojo.desc(12787,"The maximum file size for files is #### MB.").replace("####",mstrApp.diParams.UploadSizeLimit));}else{controller.displayError(mstrmojo.desc(12624,"Error fetching information about the imported data. Please check the data being imported."));}}}}}};this.dataService.getImportedData(callback,params);},getAttributeGroupInfo:function getAttributeGroupInfo(tableID){var params={tableID:tableID,browsetype:32};var controller=this;var m=controller.model;var callback={success:function(res){m.populateAttributeGroup(res,tableID);},failure:function(res){controller.displayError(mstrmojo.desc(12624,"Error fetching information about the imported data. Please check the data being imported."));}};this.dataService.getImportedData(callback,params);},getShapekeys:function getShapekeys(){var mdl=this.getModel();var cb={success:function(res){if(res&&res.ShapeFileMaps&&res.ShapeFileMaps.ShapeFileMap){var keys=res.ShapeFileMaps.ShapeFileMap,items=[],desc,name,nameSorter=function nameSorter(a,b){var A=a.n.toLowerCase();var B=b.n.toLowerCase();var value;if(A<B){value=-1;}else{if(A>B){value=1;}else{value=0;}}return value;};mstrmojo.array.forEach(keys,function(item){desc=item.descWeb;name=desc?mstrmojo.desc(desc.slice(8)):mstrmojo.string.decodeHtmlString(item.name).replace(/&apos;/g,"'");items.push({did:item.shapeKey,n:name});});items.sort(nameSorter);mdl.shapeKeys=items;}}};this.dataService.getShapeKeys(cb,{fileNumber:2});},getCustomConnector:function getCustomConnector(){var model=this.getModel();var controller=this;var params={typeFilter:constants.dbType.newConnector,taskId:"arch.getCustomConnector",objecttypes:29,skipSchemaIDCheck:true,flags:1+2+256+512+8192+16384,domain:4,specialparse:"getDBRoles",xmlflags:1,typeFilter:constants.dbType.newConnector};var callback={success:function(res){var addedSourceItems=[];var addedStaticSourceItems=[];var resourceConfig=$H.walk("connectorConfig.resourceConfig",mstrApp.diParams);$ARR.forEach(res.els,function(item){if($ARR.find(model.sourceItems,"oid",item.oid)<0){var tempObj,type,selected;tempObj=$H.copy(model.customConnector,tempObj),selected=resourceConfig&&Array.prototype.indexOf.call(resourceConfig,item.oid)<0;var url=item.url,prefix=constants.authModePrefix,mode=constants.authMode;if($HELPer.strStartsWith(url,prefix.USERNAME)){url=url.substring(prefix.USERNAME.length);url=url.substring(0,url.length-1);type=mode.USERNAME;}else{if($HELPer.strStartsWith(url,prefix.OAUTH)){url=url.substring(prefix.OAUTH.length);url=url.substring(0,url.length-1);type=mode.OAUTH;}else{if($HELPer.strStartsWith(url,prefix.ANONYMOUS)){url=url.substring(prefix.ANONYMOUS.length);url=url.substring(0,url.length-1);type=mode.ANONYMOUS;}}}model.staticSourceList.push({n:item.n,url:url,oid:item.oid,user:item.user,pageType:constants.pageType.newConnector,initial:/[a-z]/i.test(item.n.charAt(0))?item.n.charAt(0).toUpperCase():"Others",checkConectivity:true,dbObjectsDisplayOptions:8,tags:["Customized"],oneTier:true,privilege:constants.privilegeType.accessDatabase,title:function(){var title="";if(!mstrApp.diParams.EnableURLImport){title=mstrmojo.desc(12491,"URL file uploads are currently disabled. Please contact your administrator.");}else{if(mstrApp.diParams.ImportDatabase===0){title=mstrmojo.desc(12751,"Disabled as the user does not have any &quot;Web Import Database&quot; privileges");}}return title;},isEnabled:function(){return mstrApp.diParams.EnableURLImport;},sourceInfo:{sourceType:constants.sourceType.bisource,name:"New connector",type:500,subtype:constants.sourceSubtype.bisource}});addedStaticSourceItems.push(model.staticSourceList[model.staticSourceList.length-1]);addedSourceItems.push($H.copy({n:item.n,url:url,connectorDesc:splitDesc(item.desc,"desc"),introductionUrl:splitDesc(item.desc,"introduction"),iconData:window.atob&&window.atob(item.iconData)||"",oid:item.oid,type:type,user:item.user,pwd:item.pwd,oneTier:true,selected:selected},tempObj));}});if(addedSourceItems.length){model.set("sourceItems",model.sourceItems.concat(addedSourceItems));model.set("customConnectorDBRoles",res.els);}model.addfromStaticSources(addedStaticSourceItems);model.sortSourceList();model.raiseEvent({name:constants.srcItemTypes.CUSTOM_CONNECTOR,src:model});}};mstrApp.serverRequestQueue(params,callback,taskQueue);},getSheetsInfo:function getSheetsInfo(cb,tableID,flag,action,status){var params={tableID:tableID,previewflag:flag};var controller=this;var m=controller.model;var callback={success:function(res){var fnFilter=function(sheet){if(sheet==="*"){return false;}return true;};var sheets=res.datap.shts,nonEmptySheets=mstrmojo.array.filter(sheets,fnFilter);var defaultIndex;var hasSheets=false;for(defaultIndex=0;defaultIndex<sheets.length;defaultIndex++){if(sheets[defaultIndex]!=="*"){hasSheets=true;break;}}if(!hasSheets){callback.failure(mstrmojo.desc(15810,"The file being imported is not supported or the file might be corrupted. Please check the URL and the file."));return ;}if(nonEmptySheets.length<2){if((flag&constants.requestFlag.sheets)===constants.requestFlag.sheets){m.importSources[tableID].populateSheets(res.datap.shts,defaultIndex);}var params={shtIx:defaultIndex};controller.autoMappingSourceTable(cb,tableID,params,tableID,action,status);}else{if((flag&constants.requestFlag.sheets)===constants.requestFlag.sheets){m.importSources[tableID].originalSheetsInfo=m.importSources[tableID].sheetsInfo;m.importSources[tableID].populateSheets(res.datap.shts,defaultIndex);}if(cb){cb.success();}}},failure:function(res){status.files[status.idx].failed=true;status.files[status.idx].errRes=res;if(cb){cb.failure();}}};this.dataService.getImportedData(callback,params);},getImportedDataEMMA:function getImportedDataEMMA(action,requestFlags,sheetIndex,shouldPoll,tableID,refineMode,cb,data){var controller=this,m=controller.getModel(),compCallback;var params={previewflag:requestFlags};if(shouldPoll!==undefined){params.poll=shouldPoll;}if(sheetIndex>=0){params.sheetIndex=sheetIndex;}if(tableID){params.tableID=tableID;}if(!this.dataService.messageID&&this.model.cubeID){params.reportid=this.model.cubeID;}var callback={success:function(res){var source,i,tables,flags,tableState,hasPreview,selected=null,currentSource,serviced;if(action===actions.refine){source=m.importSources[tableID];source.projectID=res.datap.srce.rimp.rpid;controller.refine(source.projectID,tableID);return ;}if(action===actions.getFlatPreview){m.populateEMMA(res,requestFlags,tableID,true);controller.raiseModelEvent({name:"FlatPreviewFetched"});return ;}serviced=m.populateEMMA(res,requestFlags,tableID,action===actions.quickPreview);if(action===actions.savePublish){if(controller.dialogController.pageZIndex>0){controller.rootView.parent.close();}window.setTimeout(function(){controller.saveAndPublish();},0);return ;}for(i=0;i<res.datap.length;i++){tableState=res.datap[i].state;if(tableState&&tableState.errc===constants.backendError.refineApplyError){controller.displayError(tableState.emsg);}}tables=m.getAllTableID();currentSource=controller.model.currentSource;if(action===actions.importSource){selected=tables[controller.dialogController.pageZIndex>0?tables.length-1:0];}else{if(action===actions.none||action===actions.refreshData){if(currentSource&&$ARR.indexOf(tables,currentSource.tableID)>=0){selected=currentSource.tableID;}else{if(tables.length>0){if(controller.dialogController.pageZIndex===0){selected=tables[0];}}}}}flags=requestFlags|constants.requestFlag.preview|constants.requestFlag.transformations;if(tableID===undefined&&tables.length>0&&action===actions.quickPreview&&selected!==tables[tables.length-1]){source=m.getImportSource(tables[tables.length-1]);hasPreview=false;if(source&&source.currentTransformations&&source.currentTransformations.xtab&&source.currentTransformations.xtab.isCrosstab){hasPreview=!!source.currentMapping&&!!source.transformedPreview;}else{if(source){hasPreview=!!source.currentMapping&&!!source.currentPreview&&!(action===actions.quickPreview);}}if(!hasPreview){if(source&&source.currentTransformations&&source.currentTransformations.xtab&&source.currentTransformations.xtab.isCrosstab){flags=flags&(~constants.requestFlag.preview);flags|=constants.requestFlag.transformedPreview;}else{flags=flags&(~constants.requestFlag.transformedPreview);flags|=constants.requestFlag.preview;}if(source.type===constants.sourceType.querybuilder){flags=flags&(~constants.requestFlag.sheets);flags=flags&(~constants.requestFlag.transformations);flags=flags&(~constants.requestFlag.sourceInfo);}if(source.type===constants.sourceType.twitter){flags=flags&(~constants.requestFlag.sheets);}if(source.subtype===constants.sourceSubtype.googleBigQuerySingleTable){flags=775;}if(source.databaseType===SAPHANA_DBTYPE&&source.xdaType===constants.xdaType.qbSingleTable){flags=flags&(~constants.requestFlag.preview);}controller.getImportedDataEMMA(action,flags,sheetIndex,shouldPoll,tables[tables.length-1]);return ;}}if(action===actions.importSource||action===actions.changeSheet||action===actions.refreshData){controller.forceImport=false;controller.showPage(constants.pageType.emmaPreview,null);}if(selected){window.setTimeout(function(){controller.selectSourceTable(selected);},0);}if(action===actions.quickPreview){controller.raiseModelEvent({name:constants.dataEvents.DATA_PREVIEW_EVENT,data:tableID});return ;}if(action===actions.transform){m.currentSource.currentTransformations.xtab.set("isCrosstab",true);controller.raiseModelEvent({name:"changeToXtab"});}if(action===actions.importSource||action===actions.refreshData){if((serviced&constants.requestFlag.preview)!==constants.requestFlag.preview){return ;}}if((serviced&constants.requestFlag.mapping)!==constants.requestFlag.mapping){controller.getImportedDataEMMA(action,requestFlags,sheetIndex,false);return ;}},failure:function(res){var error=parseInt(res.code||(res.getResponseHeader?res.getResponseHeader("X-MSTR-TaskErrorCode"):-1),10),status=constants.statusCode;if(error===status.mappingError||error===status.xformsError||error===status.obtainSource){controller.getImportedDataEMMA(action,requestFlags,sheetIndex,false);}else{var detailedError;if(tableID){detailedError=controller.getImportController().handleImportError(res,m.importSources[tableID].dbTableName);}controller.displayError(mstrmojo.desc(12624,"Error fetching information about the imported data. Please check the data being imported."),false,detailedError);}}};compCallback=mstrmojo.func.wrapMethods(callback,cb,{});if(data===undefined){this.dataService.getImportedData(compCallback,params);}else{compCallback.success(data);}},fetchCubeInfo:function fetchCubeInfo(){var request=constants.requestFlag.sourceInfo|constants.requestFlag.mapping|constants.requestFlag.anyState,model=this.model,controller=this,view=this.rootView,status=mstrApp.diParams.StatusCode;if(status===constants.statusCode.xformsError||status===constants.statusCode.mappingError){request=constants.requestFlag.sourceInfo|constants.requestFlag.mapping|constants.requestFlag.preview|constants.requestFlag.sheets|constants.requestFlag.transformations|constants.requestFlag.anyState;}var callback={success:function(res){if(mstrApp.isEMMACube){model.populateEMMA(res,request);}else{model.populate(res,request);}switch(mstrApp.diParams.StatusCode){case constants.statusCode.xformsError:view.showPage(constants.pageType.preview);break;case constants.statusCode.mappingError:view.showPage(constants.pageType.preview);break;default:if(model.currentSource.type===constants.sourceType.file&&model.currentSource.subtype!==constants.sourceSubtype.samplefile&&model.currentSource.subtype!==constants.sourceSubtype.publicData){view.showPage(constants.pageType.file,model.currentSource.subtype-1);}else{if(model.currentSource.subtype===constants.sourceSubtype.samplefile){view.showPage(constants.pageType.sampleFiles);}else{if(model.currentSource.subtype===constants.sourceSubtype.publicData){view.showPage(constants.pageType.publicData);}else{if(model.currentSource.type===constants.sourceType.salesforce||model.currentSource.type===constants.sourceType.googleDrive||model.currentSource.type===constants.sourceType.dropbox||model.currentSource.type===constants.sourceType.googleAnalytics){if(mstrApp.diParams.StatusCode){controller.getOAuthSourceReports(model.currentSource.type,false);}}}}}break;}},failure:function(res){controller.displayError(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};var params={reportid:this.model.cubeID,previewflag:request};if(mstrApp.isEMMACube){this.dataService.getImportedDataEMMA(callback,params);}else{this.dataService.getImportedData(callback,params);}},handleSecurityFilterAccess:function(cubeName){var controller=this,errorMessage=mstrmojo.desc(16017,"You need write access to cube # to the operation, because the cube have security filter or shared attribute associated.").replace("#",cubeName),closeFn=function(){controller.exitApplication();};controller.displayError(errorMessage,false,undefined,closeFn);},fetchCubeInfoEMMA:function(){var controller=this,model=controller.model,request=constants.requestFlag.sourceInfo|constants.requestFlag.mapping|constants.requestFlag.relationship,tables=null,mdxSource=null,diParam;var callback={success:function(res){model.writable=res.writable;model.copyable=res.copyable;if(res.copyable===0){controller.handleSecurityFilterAccess(model.cubeName);return ;}model.populateEMMA(res,request);if(!controller.checkAndShowPrivilegeMsg()){return ;}mstrmojo.hash.forEach(model.importSources,function(source){if(source.xdaType===constants.xdaType.mdx){mdxSource=source;return false;}});if(mdxSource){diParam=mstrApp.diParams;controller.showPage(constants.pageType.database,{sourceType:mdxSource.type,type:mdxSource.xdaType,extParams:{tableID:mdxSource.tableID,cubeName:diParam.CubeName,cubeDesc:diParam.CubeDesc,folderID:diParam.FolderId,reportID:diParam.ReportId}});return ;}tables=model.getAllTableID();if(tables.length<=0){controller.showPage(constants.pageType.dataSelection);return ;}else{controller.showPage(constants.pageType.emmaPreview,null,null);}if(model.isDirectDataAccess===false){var isNotPublished=controller.getDDAController().checkIfDDA(model.cubesInfo.cubes);var canSupportDDA=controller.getDDAController().canSupportDDA();if(isNotPublished&&canSupportDDA){model.set("isDirectDataAccess",true);model.weakDDA=true;}}controller.selectSourceTable(tables[0]);},failure:function(res){controller.displayError(mstrmojo.desc(12793,"Fetch cube info failed."),false,res.message||"",function(){controller.cancelApplication();});}};var afterCreateRI={success:function(res){if(res&&res.msgid){controller.dataService.set("messageID",res.msgid);}controller.dataService.getImportedData(callback,{previewflag:request,browsetype:constants.browseFlag.dataPreview|constants.browseFlag.publish|constants.browseFlag.reportBindingTable|constants.browseFlag.reportLevelProperty});},failure:function(res){controller.displayError(mstrmojo.desc(12783,"Create EMMA Report Instance error. Please check the metadata."),false,res.message||"",function(){controller.cancelApplication();});}};if(mstrApp.isSingleTier){controller.dataService.duplicateReportInstance(afterCreateRI,{datasetID:model.cubeID});}else{if(model.analysisID){controller.dataService.duplicateReportInstance(afterCreateRI,{datasetID:model.cubeID,messageID:model.analysisID});}else{controller.dataService.createEMMAReportInstance(afterCreateRI,{reportID:model.cubeID});}}},duplicateSelectedDataset:function(callback){var controller=this,model=controller.getModel(),dataService=controller.dataService,request=constants.requestFlag.sourceInfo|constants.requestFlag.mapping|constants.requestFlag.relationship,dataset=model.currentDataset,bHaveDuplicated=false,afterGetImportedData={success:function(res){var tableIDs=null,hasMdx=false,hasSolr=false,hasRemoteProject=false,DDAOnlyCnt=0,errmsg="",backFn=function(){dataService.set("messageID",null);model.resetImportSource();if(model.datasets&&model.datasets.length){model.selectDataset(model.datasets[0]);}controller.showPage(constants.pageType.dataSelection);};model.populateEMMA(res,request);tableIDs=model.getAllTableID();$ARR.forEach(tableIDs,function(id){var source=model.getImportSource(id);if(source&&source.xdaType===constants.xdaType.mdx){hasMdx=true;errmsg=mstrmojo.desc(13320,"We do not allow add to operation on cubes that have sources based on MDX.");}if(source&&source.databaseType===mstrmojo.warehouse.EnumDatabaseType.SearchEngineSOLR){hasSolr=true;errmsg=mstrmojo.desc(13321,"We do not allow add to operation on cubes that have sources based on Solr.");}if(source&&source.type===constants.sourceType.remoteProject){hasRemoteProject=true;errmsg=mstrmojo.desc(13322,"We do not allow add to operation on cubes that have sources based on MicroStrategy Project.");}if(source&&model.isDDAOnlySource(source.subtype)){DDAOnlyCnt++;}});if(hasMdx||hasSolr||hasRemoteProject){controller.displayError(errmsg,false,null,backFn);}else{model.set("isDirectDataAccess",model.isDirectDataAccess&controller.getDDAController().canSupportDDA());model.set("cubeID",dataset.did);model.set("cubeName",dataset.name);model.set("cubeDesc",dataset.dsc);model.set("operationMode",constants.operationMode.edit);if(callback&&callback.success){callback.success(res);}}}},afterDuplicateRI={success:function(res){bHaveDuplicated=true;if(res&&res.msgid){dataService.set("messageID",res.msgid);}dataService.getImportedData(afterGetImportedData,{previewflag:request});},failure:function(res){if(callback.failure){callback.failure(res);}},complete:function(){if(!bHaveDuplicated&&callback.complete){callback.complete();}}};if(!dataset||!dataset.did){if(callback.success){callback.success();}if(callback.complete){callback.complete();}}dataService.duplicateReportInstance(afterDuplicateRI,{datasetID:dataset.did,messageID:model.analysisID});},getRepublishInfoEMMA:function(){var controller=this,model=controller.model,request=constants.requestFlag.sourceInfo|constants.requestFlag.mapping,browsetype=constants.browseFlag.dataPreview|constants.browseFlag.publish|constants.browseFlag.reportBindingTable|constants.browseFlag.reportLevelProperty;var callback={success:function(res){var tableIDs,hasMdx=false,hasSolr=false,hasRemoteProject=false,hasHanaSingleTable=false,needUploadCnt=0,DDAOnlyCnt=0,cnt,errmsg;model.writable=res.writable;model.copyable=res.copyable;model.populateEMMA(res,request);var isFromPushApi=model.isFromPushApi();if(!controller.checkAndShowPrivilegeMsg()){return ;}if(model.isDirectDataAccess===false){var shouldSupportDDA=controller.getDDAController().shouldSupportDDA();if(shouldSupportDDA){model.set("isDirectDataAccess",true);}}tableIDs=model.getAllTableID();cnt=tableIDs.length;$ARR.forEach(tableIDs,function(id){var source=model.getImportSource(id);if(source&&source.xdaType===constants.xdaType.mdx){hasMdx=true;errmsg=mstrmojo.desc(13278,'A schedule cannot be created on this dataset as all its tables are from the "OLAP Sources" connector which is only supported in the Connect Live? Mode.');}if(source&&source.databaseType===mstrmojo.warehouse.EnumDatabaseType.SearchEngineSOLR){hasSolr=true;errmsg=mstrmojo.desc(13279,'A schedule cannot be created on this dataset as all its tables are from the "Search as a Source" connector which is only supported in the Connect Live? Mode.');}if(source&&source.type===constants.sourceType.remoteProject){hasRemoteProject=true;errmsg=mstrmojo.desc(13323,'A schedule cannot be created on this dataset as all its tables are from the "MicroStrategy Project" connector which is only supported in the Connect Live? Mode.');}if(source&&source.xdaType===constants.xdaType.qbSingleTable&&source.databaseType===4000){hasHanaSingleTable=true;errmsg=mstrmojo.desc(14206,"A schedule cannot be created on this dataset as all its tables are from HANA which is only supported in the Connect Live? Mode.");}if(source&&source.type===constants.sourceType.file){if(source.subtype===constants.sourceSubtype.clipboard||source.subtype===constants.sourceSubtype.localFile){needUploadCnt++;}}if(source&&model.isDDAOnlySource(source.subtype)){DDAOnlyCnt++;}});if(model.operationMode===constants.operationMode.refresh){if($HELPer.isRefreshable(model)){if(hasMdx){controller.displayError(mstrmojo.desc(13264,'We do not allow the "Publish" operation on cubes that access OLAP sources.'),false,null,function(){controller.cancelApplication();});}else{if(hasSolr){controller.displayError(mstrmojo.desc(13265,"We do not allow publish operation on cubes that have sources based on Solr."),false,null,function(){controller.cancelApplication();});}else{if(hasHanaSingleTable){controller.displayError(mstrmojo.desc(14207,"We do not allow publish operation on cubes that have sources based on HANA."),false,null,function(){controller.cancelApplication();});}else{if(isFromPushApi){errmsg=mstrmojo.desc(14869,"The in-memory dataset cannot be republished as it contains a table that was created via the MicroStrategy Data Push api.");if($HELPer.isWS()){controller.displayError(errmsg,false,null,function(){if($HELPer.getEnvObj().isDIinVI()){closeDIPopup.call(controller);}},"",mstrmojo.desc(15207,"This dataset cannot be refreshed."),false);}else{controller.displayError(errmsg,false,null,function(){controller.cancelApplication();});}}else{controller.showDialog(constants.dialogType.publishStatusDialog,{model:model});}}}}}else{controller.displayError(mstrmojo.desc(13280,"Administrator has disabled importing a file from a URL."),false,null,function(){controller.cancelApplication();});}}if(model.operationMode===constants.operationMode.subscribe){if(needUploadCnt===cnt||isFromPushApi){errmsg=mstrmojo.desc(14870,'A schedule cannot be created on this dataset as all its tables either require manual input, as they were built from the "File From Disk" or "Clipboard" connectors, or are created via the MicroStrategy Data Push api.');if($HELPer.isWS()){controller.displayError(errmsg,false,null,null,"",mstrmojo.desc(15208,"Schedule cannot be created on this dataset."),false);}else{controller.displayError(errmsg,false,null,function(){controller.cancelApplication();},mstrmojo.desc(13282,"Cannot Create Schedule"));}}else{if(DDAOnlyCnt===cnt){controller.displayError(errmsg,false,null,function(){controller.cancelApplication();},mstrmojo.desc(13282,"Cannot Create Schedule"));}else{var shouldGetCEDBRole=false,dbRoleCallback;$ARR.forEach(tableIDs,function(tableId){shouldGetCEDBRole=model.importSources[tableId]&&model.importSources[tableId].subtype===constants.sourceSubtype.cloudElement&&!(model.cloudElementDBRoles&&model.cloudElementDBRoles.length>0);if(shouldGetCEDBRole){dbRoleCallback={success:function(){controller.getScheduleController().launchScheduleEditor();}};controller.getCloudElementDBRoles(dbRoleCallback);return false;}});if(!shouldGetCEDBRole){controller.getScheduleController().launchScheduleEditor();}}}}},failure:function(res){controller.displayError(mstrmojo.desc(12624,"Error fetching information about the imported data. Please check the data being imported."),false,res.message,function(){mstrApp.getRootController().cancelApplication();});}};if(model.operationMode===constants.operationMode.subscribe){browsetype=constants.browseFlag.dataPreview;}controller.dataService.getImportedData(callback,{previewflag:request,browsetype:browsetype});},republishEMMACube:function(){var controller=this;var model=controller.model;var onRunningReport={success:function(res){if(res&&res.msgid){controller.dataService.set("messageID",res.msgid);}if(res.publishInfo){var publishInfoObj=JSON.parse(res.publishInfo);controller.model.requestId=publishInfoObj.requestId;controller.model.appSchemaTables=publishInfoObj.data;controller.model.workspaceId=publishInfoObj.workspaceId;}controller.getRepublishInfoEMMA();},failure:function(res){if($HELPer.isWS()){controller.displayError(null,false,res.message||"",null,"",mstrmojo.desc(12794,"Run EMMA cube error."),false);}else{controller.displayError(mstrmojo.desc(12794,"Run EMMA cube error."),false,res.message||"",function(){mstrApp.getRootController().cancelApplication();});}}};if(mstrApp.isSingleTier){controller.dataService.duplicateReportInstance(onRunningReport,{datasetID:model.cubeID});}else{if(model.analysisID){controller.dataService.duplicateReportInstance(onRunningReport,{datasetID:model.cubeID,messageID:model.analysisID});}else{controller.dataService.createEMMAReportInstance(onRunningReport,{reportID:model.cubeID});}}},fetchSampleFileList:function fetchSampleFileList(){var model=this.model;var callback={success:function(res){model.sampleFiles=res.samplefiles.file;}};},getDIProjectSettings:function getDIProjectSettings(cb){var controller=this;var callback={success:function(res){if(!mstrApp.sessionManager){mstrApp.projectName=mstrConfig.projectName;mstrApp.serverName=mstrConfig.serverName;mstrApp.serverPort=mstrConfig.serverPort;mstrApp.authMode=mstrConfig.authMode;mstrApp.enableAutomaticSessionRecovery=res.enableAutomaticSessionRecovery;mstrApp.maxSessionIdleTime=res.maxSessionIdleTime;mstrApp.timeBeforeSessionTimeoutWarning=res.timeBeforeSessionTimeoutWarning;mstrApp.enableWarningSessionTimeout=res.enableWarningSessionTimeout;if(!$HELPer.getEnvObj().isWS()){mstrApp.startSessionManager();}}mstrmojo.hash.copy(res,mstrApp.diParams);},failure:function(){controller.oAuthController.getExternalSourcesInfo();}};this.dataService.getDIProjectSettings(mstrmojo.func.wrapMethods(callback,cb,{success:function(res){var msg=mstrmojo.desc(13991,'The Project is locked because it is being used by "###". The EMMA Cube cannot be opened until the Project is no longer in use.'),config=null;if(res&&res.projectLocked){controller.displayError(msg.replace("###",res.projectLockedOwner),false,null,function(){controller.cancelApplication();});return ;}if(res&&res.connectorConfig){try{config=JSON.parse(res.connectorConfig);}catch(e){console.log("Invalid DI connector configuration");}mstrApp.diParams.connectorConfig=config;if(config&&(config.resourceConfig||config.dbRoleConfig)){controller.getModel().populateSourceListAdminConfig(config.resourceConfig,config.dbRoleConfig);}}controller.oAuthController.getExternalSourcesInfo();}}));},getDBMSObjects:function getDBMSObjects(){var controller=this;var callback={success:function(res){if(res.DBInfo){controller.model.populateDBRoles(res.DBInfo);}},failure:function(res){controller.displayError(mstrmojo.desc(12626,"Error when making modifications to the imported data."),false,res.message);}};var params={taskId:"arch.getDBObjects",flags:8};mstrApp.serverRequestQueue(params,callback,taskQueue);},editImportedData:function editImportedData(flags,sheetIndex,columnHeaders,transformations,refine,refineMode,tableID){if(mstrApp.isEMMACube){this.editImportedDataEMMA(flags,sheetIndex,columnHeaders,transformations,tableID);return ;}var params={shtIx:sheetIndex};var type=this.model.currentSource.type;if(type===constants.sourceType.dropbox||type===constants.sourceType.googleDrive){var oAuthSource=this.model.externalSources[type];params=oAuthSource.getSourceParams();params.shtIx=sheetIndex;}if(columnHeaders){params.chs=columnHeaders;}if(transformations){params.trans=transformations;}if(this.model.currentSource.subtype===constants.sourceSubtype.url||this.model.currentSource.subtype===constants.sourceSubtype.samplefile||this.model.currentSource.subtype===constants.sourceSubtype.publicData||this.model.currentSource.subtype===constants.sourceSubtype.cloudElement){params.isUrl=true;}params.behaviorFlags=constants.importBehaviorFlag.reserved;if(this.model.operationMode===constants.operationMode.refresh||this.model.operationMode===constants.operationMode.edit){if(mstrApp.isCloudPro){params.behaviorFlags=constants.importBehaviorFlag.newColumnsSilent|constants.importBehaviorFlag.dataTypeSilent;}}if(refine){params.refine=refine;if(refineMode===0){params.flags=536870920;}else{params.flags=0;}}var controller=this;var callback={success:function(res){controller.dataService.set("messageID",res.msg_id||res.msgid);if(refineMode===0){controller.getImportedData(actions.refine,flags,sheetIndex,undefined,1);}else{if(controller.model.operationMode!==constants.operationMode.create&&!columnHeaders&&!transformations){controller.getImportedData(actions.changeSheet,flags,sheetIndex,undefined,controller.model.currentSource.tableID);}else{controller.getImportedData(actions.editImport,flags,sheetIndex,undefined,controller.model.currentSource.tableID);}}},failure:function(){controller.displayError(mstrmojo.desc(12626,"Error when making modifications to the imported data."));}};this.dataService.editImportedData(callback,params);},editImportedDataEMMA:function editImportedDataEMMA(flags,sheetIndex,columnHeaders,transformations,tableID,skipRows,delimiter,quotes,customCB,isDeleteRefine,cb){var source,params={};if(tableID){source=this.model.importSources[tableID];sheetIndex=source.currentIndex;}else{source=this.model.currentSource;tableID=source.tableID;}if(sheetIndex>=0){params.shtIx=sheetIndex;}var type=source.type;if(source.type===constants.sourceType.googleDrive||source.type===constants.sourceType.dropbox||source.type===constants.sourceType.salesforce||source.type===constants.sourceType.twitter||source.type===constants.sourceType.facebook||source.type===constants.sourceType.googleAnalytics){var oAuthSource=this.model.externalSources[type];params=oAuthSource.getSourceParams();}if(columnHeaders){params.chs=columnHeaders;}if(transformations){params.trans=transformations;}if(source.subtype===constants.sourceSubtype.url||source.type===constants.sourceType.hadoop||source.subtype===constants.sourceSubtype.samplefile||source.subtype===constants.sourceSubtype.publicData||source.subtype===constants.sourceSubtype.cloudElement){params.isUrl=true;}if(source.subtype===constants.sourceSubtype.querybuilder||(source.type===constants.sourceType.querybuilder&&source.subtype===constants.sourceSubtype.hadoop)){params.isDB=true;params.dbTableName=source.sourceInfo.dbTableName;params.dbRoleID=source.sourceInfo.dbRoleId;if(source.sourceInfo.dbNamespace){params.dbNamespace=source.sourceInfo.dbNamespace;}}if(skipRows||skipRows===0){params.sr=skipRows;}if(delimiter){params.dlmt=delimiter;}if(quotes){params.qt=quotes;}params.behaviorFlags=constants.importBehaviorFlag.reserved;if(this.model.operationMode===constants.operationMode.refresh||this.model.operationMode===constants.operationMode.edit){if(mstrApp.isCloudPro){params.behaviorFlags=constants.importBehaviorFlag.newColumnsSilent|constants.importBehaviorFlag.dataTypeSilent;}}if(isDeleteRefine){params.behaviorFlags|=constants.behaviorChangeFlag.refreshData;}else{params.behaviorFlags|=constants.behaviorChangeFlag.remapping;}var controller=this;var onRSDetected={success:function(){controller.getImportedDataEMMA(actions.none,flags,sheetIndex,undefined,tableID,null,cb);},failure:function(res){controller.displayError(mstrmojo.desc(12795,"RS detection failure!"),false,res.message||"");}};var callback={success:function(res){if(res&&res.msgid){controller.dataService.set("messageID",res.msgid);}controller.dataService.detectRelationshipSourceTable(customCB||onRSDetected,{did:tableID||controller.model.currentSource.tableID});},failure:function(res){controller.displayError(mstrmojo.desc(12626,"Error when making modifications to the imported data."),false,res.message||"");controller.handleImportEMMAerror(res.code);}};params.tbid=tableID;this.dataService.autoMappingSourceTable(callback,params);},handleImportEMMAerror:function(errCode){var rCtrl=mstrApp.getRootController();errCode=parseInt(errCode,10);if(errCode===undefined||errCode===null){return ;}if(errCode===constants.backendError.emptySheet){rCtrl.rootView.footer.next.set("enabled",false);}},openRefreshOptions:function openRefreshOptions(){var opt=this.model.refresh_opt,idx;if(opt==="2"){idx=2;}else{if(opt==="4"){idx=1;}else{idx=0;}}var dialog=mstrmojo.all[REFRESH_OPTIONS_ID];if(!dialog){dialog=mstrmojo.insert(refreshOptionsConfig);dialog.model=this.model;dialog.render();}dialog.radiolist.set("selectedIndex",idx);dialog.open();},loadProject:function loadProject(projects,pullDown){var lpParams,lpCallback,k=0,i=0,j=0,tempServer,tempProject,currentProjectIndex;lpParams={};lpCallback={success:function(res){if(!res||!res.servers){return ;}for(i=0;i<res.servers.length;i++){tempServer=res.servers[i];if(tempServer&&tempServer.projects){for(j=0;j<tempServer.projects.length;j++){tempProject=tempServer.projects[j];if(tempProject){projects[k]={nt:"\\\\"+tempServer.name+"\\"+tempProject.name,n:tempProject.name,id:tempProject.id,sn:tempServer.name,port:tempServer.port};if((tempProject.name===mstrApp.projectName)&&(tempServer.name===mstrApp.serverName)){projects[k].ls=true;projects[k].ss=mstrApp.sessionState;currentProjectIndex=k;}else{projects[k].ls=false;projects[k].ss=null;}k++;}}}}pullDown.set("items",projects);pullDown.set("selectedIndex",currentProjectIndex);pullDown.set("text",projects[currentProjectIndex].nt);},failure:function(res){mstrmojo.alert(res.getResponseHeader("X-MSTR-TaskFailureMsg"));}};this.dataService.loadProject(lpCallback,lpParams);},loginProjects:function loginProjects(domNode,projects){var auth=1,loginEditor=domNode.parent,uid=domNode.mstrUserAlias.value,password=domNode.mstrPasswordAlias.value,loginErrorBox=domNode.loginErrorBoxAlias,selectedIndex=loginEditor.selectedIndex,port=loginEditor.port,DIparams={userid:uid,server:loginEditor.serverName,password:password,project:loginEditor.projectName,authMode:auth,port:port},DIcallback={success:function(res){projects[selectedIndex].ls=true;projects[selectedIndex].ss=res.sessionState;loginErrorBox.set("visible",false);loginEditor.close();loginEditor.projectListNode.set("selectedIndex",selectedIndex);},failure:function(res){loginErrorBox.set("visible",true);loginErrorBox.errorMsgAlias.set("text",mstrmojo.desc(422));}};this.dataService.loginProject(DIcallback,DIparams);},getPublishController:function getPublishController(){if(this.publishController===undefined){this.publishController=new mstrmojo.DI.controller.DIPublishController();}return this.publishController;},saveAndPublish:function saveAndPublish(){var callback={success:this.getPublishController().saveAndPublish.bind(this.getPublishController())};if(!doNotImportHierarchyTable.call(this,callback)){callback.success();}},publishNonEmmaCube:function publishNonEmmaCube(reportID){var controller=this;var callback={success:function success(){controller.displayError(mstrmojo.desc(14096,"The cube was published successfully!"),false,null,function(){var model,cubesInfo,cubes,idx,dataset={did:reportID};if(mstrApp.refreshMultipleCubes){model=controller.getModel();model.publishedDatasets.push(dataset);cubesInfo=model.cubesInfo;cubes=cubesInfo&&cubesInfo.cubes&&cubesInfo.cubes.cube;idx=$ARR.find(cubes,"cube_id",reportID);if(idx>=0){cubes.splice(idx,1);model.raiseEvent({name:"cubesInfoChange"});}}});},failure:function failure(res){controller.displayError(mstrmojo.desc(14097,"There was an error publishing the cube."),false,res.message||"");}};var pollCallback={success:function(res){switch(parseInt(res.status)){case constants.cubePollStatus.msgID:case constants.cubePollStatus.result:case constants.cubePollStatus.xmlResult:callback.success();break;case constants.cubePollStatus.prompt:callback.failure();break;case constants.cubePollStatus.error:callback.failure();break;default:controller.dataService.pollStatus(pollCallback,{msgID:res.id,stateID:parseInt(res.st)});break;}},failure:function(res){callback.failure(res);}};this.dataService.publishNonEmmaCube(pollCallback,{reportID:reportID});},save:function save(){var callback={success:this.getPublishController().save.bind(this.getPublishController())};if(!doNotImportHierarchyTable.call(this,callback)){callback.success();}},handleMissingColumns:function handleMissingColumns(skipTables){this.getPublishController().handleMissingColumns(skipTables);},handleRepublishError:function hanldeRepublishError(validateResults){this.getPublishController().handleRepublishError(validateResults);},cancelRepublishError:function cancelRepublishError(validateResults){this.getPublishController().cancelRepublishError(validateResults);},exitApplication:function exitApplication(){if(mstrApp.serverProxy){mstrApp.serverProxy.cancelRequests();}mstrmojo.xhr.cancel();if(this.dialogController.pageZIndex>0){this.rootView.parent.close();}else{closeDIPopup.call(this,this.model.cubeID);}},exitApplicationRefreshMultipleCubes:function(){var controller=this;if(mstrApp.serverProxy){mstrApp.serverProxy.cancelRequests();}if(this.dialogController.pageZIndex>0){this.rootView.parent.close();}else{window.setTimeout(function(){var datasets=controller.model.publishedDatasets;controller.dialogController.close(constants.dialogType.publishStatusDialog);controller.dialogController.destroyAll();var diContainer=mstrApp.container;if(diContainer){mstrApp.container.close();if(diContainer.dataImportCallback){diContainer.dataImportCallback(datasets);}}},0);}},cancelApplication:function cancelApplication(){var controller=this,model=this.getModel();if(mstrApp.serverProxy){mstrApp.serverProxy.cancelRequests();}mstrmojo.xhr.cancel();if(this.dialogController.pageZIndex>0){this.rootView.parent.close();}else{window.setTimeout(function(){controller.dialogController.close(constants.dialogType.publishStatusDialog);controller.dialogController.destroyAll();var diContainer=mstrApp.container;if(diContainer){if(!model.hasMergedReportInstance){mstrApp.container.close();if(diContainer.dataImportCallback){diContainer.dataImportCallback();}}else{mstrApp.container.close();}}else{if(mstrApp.isSingleTier){controller.shutDownDesktop();}else{if($HELPer.isServerBasedWS()){controller.shutDownServerBased("{}");}else{mstrApp.redirectToPage($DI_EXIT_OPTS.getRedirectParams($DI_EXIT_OPTS.pageRedirect.flashVI,controller.model.cubeID,controller.model.isDirectDataAccess));}}}},100);}},wrapUpDataImport:function wrapUpDataImport(bShowExitPage){var controller=this,model=this.model,defRequestFlags=constants.requestFlag.mapping|constants.requestFlag.sourceInfo|constants.requestFlag.relationship,callbackStr,callbackParam,objectInfo;if(bShowExitPage===undefined){bShowExitPage=true;}var postMergeDupIDCallback={success:function(){model.hasMergedReportInstance=true;if(model.operationMode===constants.operationMode.create&&(model.isManagedCube||mstrApp.isSingleTier)){controller.docController.renameDataset((model.curDataset&&model.curDataset.id)?model.curDataset.id:model.cubeID,model.cubeName,{success:function(){closeDIPopup.call(controller,model.cubeID);}});}else{closeDIPopup.call(controller,model.cubeID);}},failure:function(res){mstrApp.hideProgress();controller.displayError(mstrmojo.desc(12796,"Unable to update the dataset after editing."),false,res&&res.message);}};this.dialogController.close(constants.dialogType.publishStatusDialog);function mergeRI(){controller.dataService.duplicateReportInstance(postMergeDupIDCallback,{messageID:model.analysisID,datasetID:(model.curDataset&&model.curDataset.id)?model.curDataset.id:model.cubeID,duplicateRIMsgID:controller.dataService.messageID});}function createDataset(){var docController=controller.getDocController(),viDatasets=controller.getDocController().getVIModelDatasets();docController.createNewManagedDataset({success:function(res){var dsids=[],id;$H.forEach(res.datasets,function(ds,dsid){if($ARR.find(viDatasets,"did",dsid)<0){dsids.push(dsid);}});if(dsids.length>0){id=dsids[0];model.curDataset=res.datasets[id];model.hasCreateDataset=true;model.curDataset.id=id;model.cubeID=id;mergeRI();}},failure:function(res){controller.displayError(mstrmojo.desc(12796,"Unable to update the dataset after editing."),false,res&&res.message);}},{newObjectIds:[model.reportDefinitionId]});}if(!model.analysisID&&!mstrApp.isSingleTier){if(controller.rootView.currentPage&&controller.rootView.currentPage.scriptClass!=="mstrmojo.DI.DIExitOptions"){if(model.path!==undefined&&bShowExitPage){if($HELPer.isServerBasedWS()||model.path==="serverBased"){objectInfo={objectId:model.cubeID,folderId:model.folderID};this.shutDownServerBased(JSON.stringify(objectInfo));}else{controller.showPage(constants.pageType.redirect);}}else{controller.exitApplication();}}}else{if(model.operationMode===constants.operationMode.create&&(model.isManagedCube||(model.curDataset&&model.curDataset.id)||!mstrApp.isPopup)){controller.dataService.getImportedData({success:function(data){model.populateEMMA(data,defRequestFlags,true);if(mstrApp.isSingleTier&&!mstrApp.isPopup){callbackParam={objectId:model.cubeID,objectType:3,objectSubtype:779,name:model.cubeName,duplicateRIMsgId:controller.dataService.messageID};callbackStr='window.setTimeout(function () { mstrApp.executeCommand("addNamedDataset",'+JSON.stringify(callbackParam)+"); }, 1000)";window.FormWrapper.closeDataImportWindow();return ;}createDataset();},failure:function(res){controller.displayError(mstrmojo.desc(12624,"Error fetching information about the imported data. Please check the data being imported."),false,res.message);}},{previewflag:defRequestFlags});}else{if(model.operationMode===constants.operationMode.edit){mergeRI();}else{closeDIPopup.call(controller,model.cubeID);}}}},getQBParamsDDA:function getQBParamsDDA(params){var canSupportDDA,ddaController=this.getDDAController(),ddaObj={};canSupportDDA=ddaController.canSupportDDA(ddaObj);params.canSupportDDA=canSupportDDA;params.shouldSupportDDA=ddaController.shouldSupportDDA();params.isManagedCube=this.model.isManagedCube;params.dbridForDDA=ddaObj.dbrid;params.isDDA=this.model.isDirectDataAccess;params.origIsDDA=this.model.origIsDirectDataAccess;params.ddaCheckboxID=ddaController.getDDACheckboxID();},getQueryBuilderParams:function getQueryBuilderParams(xdaType,extParams){var params={isEMMACube:mstrApp.isEMMACube,type:xdaType};switch(xdaType){case constants.xdaType.ffsql:case constants.xdaType.googleBigQuery:case constants.xdaType.googleBigQueryFFSQL:case constants.xdaType.querybuilder:params.size={h:"95%",w:"95%"};break;case constants.xdaType.qbSingleTable:case constants.xdaType.googleBigQuerySingleTable:params.size={h:"552px",w:"1110px"};break;case constants.xdaType.dataImportBISource:case constants.xdaType.mdx:params.size={h:"552px",w:"1010px"};break;default:params.size={h:"549px",w:"1010px"};}params.isFFSQL=(xdaType===constants.xdaType.ffsql||xdaType===constants.xdaType.googleBigQueryFFSQL||xdaType===constants.xdaType.dataImportBISource)?true:false;if(xdaType===constants.xdaType.googleBigQuery||xdaType===constants.xdaType.googleBigQueryFFSQL||xdaType===constants.xdaType.googleBigQuerySingleTable){var oAuthSource=this.model.externalSources[constants.sourceType.googleBigQuery];if(oAuthSource){params.dbrid=oAuthSource.dbRoleID;if(oAuthSource.sourceAccountID){params.said=oAuthSource.sourceAccountID;}if(oAuthSource.userDisplayName){params.userName=oAuthSource.userDisplayName;}if(oAuthSource.userEmail){params.userEmail=oAuthSource.userEmail;}}}if(mstrApp.isCloudPro){params.isCloud=true;if(this.model.cubeID){params.reportID=this.model.cubeID;}if(this.model.analysisID){params.analysisID=this.model.analysisID;}if(this.model.folderID){params.folderID=this.model.folderID;}if(mstrApp.diParams.isMDD){params.isCube=2;}else{params.isCube=1;}}else{if(this.model.analysisID){params.messageID=mstrApp.messageID||this.dataService.messageID||"";}else{params.messageID=this.dataService.messageID||"";}params.analysisID=this.model.analysisID||"";params.isNewAnalysis=mstrApp.isNewAnalysis;}params.origin="di";params.emmaTablesNum=this.model.getAllTableID().length;this.getQBParamsDDA(params);params.diFooterID=this.rootView.footer.id;params.diRootViewID=this.rootView.id;params.tableID=(extParams&&extParams.tableID)||"";params.subtype=(extParams&&extParams.subtype)||undefined;params.isRefined=(extParams&&extParams.isRefined);params.diCurrentZIndex=this.getDialogController().getCurrentZIndex();params.operationMode=this.model.operationMode;params=mstrmojo.hash.copy(params,extParams);return params;},afterQBProcess:function afterQBProcess(props,changedTables){var controller=this;var defRequestFlags=constants.requestFlag.mapping|constants.requestFlag.sourceInfo|constants.requestFlag.relationship,tableID=mstrApp.tableID,dialogCallback,isDDA,isRefreshData=!!(controller.rootView.currentPage&&controller.rootView.currentPage.tableID),action=isRefreshData?constants.actions.refreshData:constants.actions.importSource;if(mstrApp.hasOwnProperty("isDDA")){isDDA=mstrApp.isDDA;controller.getDDAController().setDirectDataAccess(isDDA);}if(mstrApp.hasOwnProperty("isManagedCube")){controller.model.isManagedCube=mstrApp.isManagedCube;}if(props){controller.dataService.set("messageID",mstrApp.messageID);controller.getDDAController().confirmDDA=false;if(props.mdx){controller.saveAndPublish();return ;}controller.getImportedDataEMMA(actions.savePublish,defRequestFlags);return ;}if(mstrApp.messageID){controller.dataService.set("messageID",mstrApp.messageID);if((!tableID&&!controller.model.isDirectDataAccess)||(changedTables!==undefined)){var handleDialogCallback=function(data,shouldRevert){if(!changedTables){controller.getImportedDataEMMA(action,defRequestFlags);}else{controller.getModel().cleanDuplicateRI(shouldRevert,{success:function(){if(shouldRevert){mstrmojo.array.forEach(changedTables,function(tempTable){if(tempTable.tid){controller.model&&controller.model.resetImportSource(tempTable.tid);}});}controller.getImportedDataEMMA(action,defRequestFlags,undefined,undefined,undefined,undefined,undefined,data);}});}};dialogCallback={onOK:function(){handleDialogCallback();},onCancel:function(data){var shouldRevert=true;handleDialogCallback(data,shouldRevert);}};controller.autoDetectPartitionGroups(dialogCallback,undefined,undefined,changedTables);}else{controller.getImportedDataEMMA(action,defRequestFlags);}}},afterBigQueryProcess:function afterBigQueryProcess(isRefreshData){var PAGE_TYPE=constants.pageType,oAuthSource=this.model.externalSources[constants.sourceType.googleBigQuery];oAuthSource.reset();this.showPage(isRefreshData?PAGE_TYPE.emmaPreview:PAGE_TYPE.dataSelection);},displayError:function displayError(errorMessage,isFatal,detailErrorMessage,onOK,title,summary,showTitle){var cfg;if(mstrApp.isPopup){isFatal=false;}cfg={title:title||mstrApp.applicationName&&mstrApp.applicationName()||mstrmojo.desc(3610),showTitle:showTitle===false?false:true,summary:summary||"",errorMessage:errorMessage,detailErrorMessage:detailErrorMessage||"",onOK:onOK||null};if(mstrApp.hideProgress){mstrApp.hideProgress(true);}else{if(mstrApp.hideWait){mstrApp.hideWait();}}mstrmojo.error({shortDesc:errorMessage,longDesc:detailErrorMessage},onOK,{title:mstrmojo.desc(11812,"Notification"),allowHTML:true});if(isFatal){mstrApp.onSessionExpired();}},displayWarning:function displayWarning(warningMessage,warningTitle,onOKHandler,config){var cfg={title:warningTitle||mstrApp.applicationName&&mstrApp.applicationName()||mstrmojo.desc(3610),errorMessage:warningMessage,showCancel:true,onOK:onOKHandler};mstrmojo.hash.forEach(config,function(value,key){cfg[key]=value;});mstrApp.hideProgress(true);this.showDialog(constants.dialogType.warningDialog,cfg);},filterSourcesByPrivileges:function(sources){var ret=[];mstrmojo.hash.forEach(sources,function(source){if(source.privilege===constants.privilegeType.accessCloud&&mstrApp.diParams.AccessDataFromCloudApp){ret.push(source);}if(source.privilege===constants.privilegeType.accessDatabase&&mstrApp.diParams.ImportDatabase){ret.push(source);}if(source.privilege===constants.privilegeType.accessFile&&mstrApp.diParams.AccessDataFromFiles){ret.push(source);}});return ret;},filterSourcesForOneTier:function(sources){var oneTierSources=[],row=0,column=0,ddaSource;mstrmojo.hash.forEach(sources,function(source){ddaSource=null;if(source.oneTier){ddaSource=mstrmojo.hash.copy(source,ddaSource);if(column>3){row++;column=0;}column++;oneTierSources.push(ddaSource);}});return oneTierSources;},filterSourcesByDDA:function(sources){var ddasources=[],row=0,column=0,ddaSource;mstrmojo.hash.forEach(sources,function(source){ddaSource=null;var subtype,dbType;if(source.sourceInfo&&source.sourceInfo.subtype){subtype=source.sourceInfo.subtype;}else{subtype=source.subtype;}if(source.sourceInfo&&source.sourceInfo.dbType){dbType=source.sourceInfo.dbType;}else{dbType=source.dbType;}if(mstrApp.getRootController().model.canAddToDDACube(subtype,dbType)){ddaSource=mstrmojo.hash.copy(source,ddaSource);if(column>3){row++;column=0;}column++;ddasources.push(ddaSource);}});return ddasources;},filterSourcesByDDAOnly:function(sources,hasDDAOnlySource){var model=this.getModel(),ret=[],subtype;if(!hasDDAOnlySource){$ARR.forEach(sources,function(source){if(source.sourceInfo&&source.sourceInfo.subtype){subtype=source.sourceInfo.subtype;}else{subtype=source.subtype;}if(!model.isDDAOnlySource(subtype)){ret.push(source);}});}else{ret=sources;}return ret;},filterSourcesByText:function filterSourcesByText(items,input,numOfcols){var k,index,result=[],row=0,col=0;for(k=0;k<items.length;k++){index=items[k].n.toLowerCase().indexOf(input.toLowerCase());if(index>-1){result.push(items[k]);col++;if(col===numOfcols){col=0;row=row+1;}}}return result;},filterSourcesbyTag:function filterSourcesbyTag(items,tags,numberOfcols){var j,k,result=[],row=0,col=0,tag;for(k=0;k<items.length;k++){if(items[k].tags){for(j=0;j<items[k].tags.length;j++){tag=items[k].tags[j];if(tags[tag]){result.push(items[k]);col++;if(col===numberOfcols){col=0;row=row+1;}break;}}}}return result;},selectSourceTable:function selectSourceTable(tableID,autoScroll){var controller=this,model=controller.model,source=null,flags=constants.requestFlag.mapping|constants.requestFlag.sourceInfo|constants.requestFlag.relationship|constants.requestFlag.preview|constants.requestFlag.transformations,bNeedCallTask=false,currentTableID=model.currentSource?model.currentSource.tableID:-1;if(tableID!==-1){source=controller.model.getImportSource(tableID);}if(tableID===currentTableID&&source&&source.cannotFetchPreview){if(autoScroll){model.raiseEvent({name:"scrollToTable",value:tableID});}return ;}var callback={success:function(res){controller.model.selectSourceTable(tableID);model.populateEMMA(res,flags,tableID);source.selectPending=false;if(autoScroll){model.raiseEvent({name:"scrollToTable",value:tableID});}},failure:function(res){source.selectPending=false;if(model.operationMode===constants.operationMode.create&&parseInt(res.code,10)!==constants.backendError.shouldBeIgnored){controller.displayError(mstrmojo.desc(12624,"Error fetching information about the imported data. Please check the data being imported."),false,res.message||"");}else{if(source){source.cannotFetchPreview=true;model.raiseEvent({name:"PreviewNotFetched"});}}if(autoScroll){model.raiseEvent({name:"scrollToTable",value:tableID});}}};if(source){var hasPreview=(!!source.currentMapping&&!!source.currentPreview)||(!!source.transformedMapping&&!!source.transformedPreview);if(!hasPreview){if(source&&source.currentTransformations&&source.currentTransformations.xtab&&source.currentTransformations.xtab.isCrosstab){flags=flags&(~constants.requestFlag.preview);flags=flags&(~constants.requestFlag.transformations);flags|=constants.requestFlag.transformedPreview;}else{flags=flags&(~constants.requestFlag.transformedPreview);flags|=constants.requestFlag.preview;}if(source.type===constants.sourceType.querybuilder){flags=flags&(~constants.requestFlag.sheets);flags=flags&(~constants.requestFlag.transformations);flags=flags&(~constants.requestFlag.sourceInfo);}if(model.operationMode===constants.operationMode.edit||model.operationMode===constants.operationMode.refresh){flags=flags&(~constants.requestFlag.sheets);}if(source.subtype===constants.sourceSubtype.googleBigQuerySingleTable){flags=775;}if(source.databaseType===SAPHANA_DBTYPE&&source.xdaType===constants.xdaType.qbSingleTable){flags=flags&(~constants.requestFlag.preview);}bNeedCallTask=true;}}if(bNeedCallTask&&!source.cannotFetchPreview){if(source.selectPending&&flags===source.selectPendingFlags){return ;}source.selectPending=true;source.selectPendingFlags=flags;controller.model.selectSourceTable(tableID);controller.dataService.getImportedData(callback,{previewflag:flags,sheetIndex:0,tableID:tableID},{showProgress:false});}else{controller.model.selectSourceTable(tableID);if(autoScroll){model.raiseEvent({name:"scrollToTable",value:tableID});}}},removeSourceTable:function removeSourceTable(tableID){var controller=this,source=controller.getModel().getImportSource(tableID);var params={did:tableID};var confirmTitle=mstrmojo.desc(13646,"Oops ... Empty Dataset"),confirmMsg=mstrmojo.desc(13883,"The dataset cannot be empty. Please add more tables before deleting this one."),tableIds=controller.getModel().getAllTableID();function updateMappingReset(attr){var sources=mstrApp.getRootController().getModel().importSources,recursiveCols=[],isHRA=false,lftra;if(attr.isLinked){for(var k in sources){if(sources.hasOwnProperty(k)&&k!==attr.tableId){lftra=sources[k].findMappingItem(attr);if(lftra){recursiveCols.push(lftra);isHRA=true;}}}}for(var i=0;i<recursiveCols.length;i++){recursiveCols[i].recursive=0;}controller.changeEMMAMappings({success:function(){controller.dataService.removeEMMASourceTable(callback,params);}},undefined,true);}if(tableID===-1){return ;}var callback={success:function(res){controller.dataService.set("messageID",res.msgid);controller.model.resetImportSource(tableID);controller.model.raiseEvent({name:"removeSourceTable",tableID:tableID});controller.navigationController.deleteRoute(tableID);var flags=constants.requestFlag.mapping|constants.requestFlag.sourceInfo|constants.requestFlag.relationship;if(controller.model.getAllTableID().length>0){controller.getImportedDataEMMA(actions.none,flags);}else{controller.showPage(constants.pageType.dataSelection);}},failure:function(res){controller.displayError(mstrmojo.desc(12797,"Cannot remove source table."),false,res.message||"");}};if(tableIds.length===1){mstrmojo.alert(confirmMsg,mstrmojo.emptyFn,confirmTitle,controller.getDialogController().getNextZIndex());}else{if(source.isHierarchyRelationTable()){mstrmojo.confirm($DESC(null,"If you remove this hierarchy relation table, we will reset all the recursive attribute linking to it. Are you sure about doing this?"),{},{buttons:[$NWB($DESC(1442,"OK"),function(){var attr=source.getRecursiveAttrAndMFA()||{};updateMappingReset(attr);controller.dataService.removeEMMASourceTable(callback,params);},true),$NWB($DESC(221,"Cancel"))]});}else{controller.dataService.removeEMMASourceTable(callback,params);}}},autoMappingAfterRefine:function autoMappingAfterRefine(flags,tableID,isDelete){var params={};if(isDelete){params.behaviorFlags=constants.behaviorChangeFlag.refreshData;}else{params.behaviorFlags=constants.behaviorChangeFlag.remapping;}var controller=this;var onRSDetected={success:function(){controller.getImportedDataEMMA(actions.none,flags,undefined,undefined,tableID);},failure:function(res){controller.displayError(mstrmojo.desc(12795,"RS detection failure!"),false,res.message||"");}};var callback={success:function(res){if(res&&res.msgid){controller.dataService.set("messageID",res.msgid);}controller.dataService.detectRelationshipSourceTable(onRSDetected,{did:tableID});},failure:function(res){controller.displayError(mstrmojo.desc(12798,"Error when auto mapping after wrangle."),false,res.message||"");}};params.tbid=tableID;this.dataService.autoMappingSourceTable(callback,params);},startRefineStage:function startRefineStage(tableID,flag,xml,isRefined){var controller=this;var model=controller.model;var params={did:tableID,flag:flag,xml:xml};var callback={success:function(res){if(res){controller.dataService.set("messageID",res.msgid);}if(flag!==3){var previewflag=8;controller.getImportedDataEMMA(actions.refine,previewflag,undefined,undefined,tableID,flag-1);}else{var source=controller.model.getImportSource(tableID);var flags=constants.requestFlag.preview|constants.requestFlag.mapping|constants.requestFlag.transformations|constants.requestFlag.sourceInfo|constants.requestFlag.relationship;if(source&&source.currentTransformations&&source.currentTransformations.xtab&&source.currentTransformations.xtab.isCrosstab){flags=flags&(~constants.requestFlag.preview);flags=flags&(~constants.requestFlag.transformations);flags|=constants.requestFlag.transformedPreview;}else{flags=flags&(~constants.requestFlag.transformedPreview);flags|=constants.requestFlag.preview;}controller.editImportedDataEMMA(flags,null,null,null,tableID);}},failure:function(res){controller.displayError(mstrmojo.desc(12799,"Encounter error when wrangling your data."),false,res.message||"");}};if(flag===3){controller.model.cleanDuplicateRI(false,{success:function(res){controller.dataService.startRefineStage(callback,params);}});}else{model.originalMsgID=controller.dataService.messageID;controller.dataService.removeOrDuplicateRI({success:function(res){mstrApp.msgid=res.msgid;if(isRefined){if(callback&&callback.success){callback.success(res);}}else{controller.dataService.set("messageID",res.msgid);controller.dataService.startRefineStage(callback,params);}}},{messageID:model.originalMsgID});}},cancelRefineStage:function cancelRefineStage(tableID,needReAutoMap){var controller=this;var params={did:tableID};var callback={success:function(res){if(mstrApp.msgid){controller.dataService.set("messageID",mstrApp.msgid);}var source=controller.model.importSources[tableID];delete source.projectID;var flags=constants.requestFlag.preview|constants.requestFlag.mapping|constants.requestFlag.transformations|constants.requestFlag.sourceInfo|constants.requestFlag.relationship;if(source&&source.currentTransformations&&source.currentTransformations.xtab&&source.currentTransformations.xtab.isCrosstab){flags=flags&(~constants.requestFlag.preview);flags=flags&(~constants.requestFlag.transformations);flags|=constants.requestFlag.transformedPreview;}else{flags=flags&(~constants.requestFlag.transformedPreview);flags|=constants.requestFlag.preview;}if(needReAutoMap){controller.dataService.cancelRefineStage({success:function(res){controller.editImportedDataEMMA(flags,null,null,null,tableID,null,null,null,null,true);}},params);}else{var sheetIndex=source&&source.currentIndex;controller.getImportedDataEMMA(actions.none,flags,sheetIndex,undefined,tableID,null,null);}},failure:function(res){controller.displayError(mstrmojo.desc(12799,"Encounter error when wrangling your data."),false,res.message||"");}};controller.getModel().cleanDuplicateRI(!needReAutoMap,callback);},refreshSourceTable:function refreshSourceTable(tableID){var controller=this;var source=controller.model.getImportSource(tableID);var name=source.sourceInfo.dbTableName.replace(/^file:\/\/\//,"");var slot;var footerConfig={next:{visible:true,text:mstrmojo.desc(773,"Refresh")},back:{visible:false},cancel:{visible:true},finish:{visible:false},cubeQuota:{visible:false},dda:{visible:false},save:{visible:false},managedCheckbox:{visible:false}};var msg=mstrmojo.desc(14155,"Please input your original data into clipboard because you have parsed or wrangled the data.");var clipboardCallback={success:function(res){slot.getConfig().properties.content=res;controller.showPage(constants.pageType.clipboard,0,slot,footerConfig);},failure:function(res){controller.showPage(constants.pageType.clipboard,0,slot,footerConfig);controller.displayError(mstrmojo.desc(12795,"Could not load clipboard data!"),false,res.message);}};if(!source){return ;}delete source.projectID;slot=controller.navigationController.getPageSlot();slot.setConfig({name:name,properties:{tableID:tableID,currentSource:source,isMultiSelect:false,operationMode:constants.operationMode.edit},footerConfig:footerConfig,newPage:true,newPageConfig:{cssClass:"mstrmojo-di-refresh-data-editor"}});if(source.type===constants.sourceType.file&&source.subtype===constants.sourceSubtype.localFile){if(controller.model.refreshToWrangle&&mstrApp.isSingleTier&&window.FormWrapper.isFilePathExist(source.sourceInfo.url)){controller.refreshOnetierLocalFile(tableID);}else{controller.showPage(constants.pageType.file,source.subtype-1,slot,footerConfig);}}else{if(source.type===constants.sourceType.file&&source.subtype===constants.sourceSubtype.url){footerConfig.next.enabled=true;controller.showPage(constants.pageType.file,source.subtype-1,slot,footerConfig);}else{if(source.type===constants.sourceType.file&&source.subtype===constants.sourceSubtype.cloudElement){footerConfig.next.enabled=true;controller.showPage(constants.pageType.cloudElement,source.subtype-1,slot,footerConfig);}else{if(source.type===constants.sourceType.hadoop&&source.subtype===constants.sourceSubtype.hadoop){if(footerConfig&&footerConfig.next){footerConfig.next.isRefresh=true;}controller.showPage(constants.pageType.hadoop,source.subtype-1,slot,footerConfig);}else{if(source.type===constants.sourceType.file&&source.subtype===constants.sourceSubtype.clipboard){var params={previewflag:constants.requestFlag.fullData,browsetype:4,sheetIndex:0,bindingflag:0,tableID:tableID};if(!source.isParsed()&&!source.isRefined()){this.dataService.getImportedData(clipboardCallback,params,0);}else{controller.showPage(constants.pageType.clipboard,0,slot,footerConfig);mstrApp.getRootController().displayWarning(msg,null,mstrmojo.emptyFn,{showCancel:false});}}else{if(source.type===constants.sourceType.file&&source.subtype===constants.sourceSubtype.samplefile){controller.showPage(constants.pageType.sampleFiles,null,slot,footerConfig);}else{if(source.type===constants.sourceType.file&&source.subtype===constants.sourceSubtype.publicData){controller.showPage(constants.pageType.publicData,null,slot,footerConfig);this.scrapeWiki(source.sourceInfo.url,false);}else{if(source.type===constants.sourceType.querybuilder){mstrApp.getRootController().showPage(constants.pageType.database,{sourceType:source.type,type:source.xdaType,extParams:{tableID:tableID,isRefined:source.sourceInfo.isRefined,subtype:source.subtype,databaseType:source.databaseType}},slot,footerConfig);}else{if(source.type===constants.sourceType.salesforce||source.type===constants.sourceType.googleDrive||source.type===constants.sourceType.dropbox||source.type===constants.sourceType.googleAnalytics||source.type===constants.sourceType.googleBigQuery){controller.getOAuthSourceReports(source.type,false,slot);}else{if(source.type===constants.sourceType.bisource){mstrApp.getRootController().showPage(constants.pageType.database,{sourceType:constants.sourceType.bisource,type:constants.xdaType.dataImportBISource,extParams:{tableID:tableID}},slot,footerConfig);}else{if(source.type===constants.sourceType.twitter||source.type===constants.sourceType.facebook){var paramString,searchParam,props;if(source.type===constants.sourceType.twitter){paramString=$HELPer.spliceUrlBySeparator(source.sourceInfo.url);searchParam=JSON.parse(paramString);props=slot.getConfig().properties;if(searchParam!==undefined){props.searchParam=searchParam.query;}if(source.fetchNum){props.fetchNum=source.fetchNum;}}else{paramString=decodeURIComponent(source.sourceInfo.url.split("###")[1]);searchParam=JSON.parse(paramString);if(searchParam!==undefined){slot.getConfig().properties.searchParam=searchParam.query;slot.getConfig().properties.groupID=searchParam.groupID;if(searchParam.advProps){slot.getConfig().properties.advProps=searchParam.advProps;}}}controller.getOAuthSourceReports(source.type,true,slot,"");}}}}}}}}}}}source.invalidPreview();},refreshOnetierLocalFile:function(tableID){var controller=this,model=this.getModel(),dataService=this.getDataService(),source=model.getImportSource(tableID),url=source.sourceInfo.url;function failureHandler(res){controller.displayError(mstrmojo.desc(12900,"Error importing following files. Please check the files or delete them."),false,res&&res.message);}if(url.indexOf("file:///")===0){url=url.substr(8);}controller.oneTierImportFile({success:function(res){if(res&&res.msgid){dataService.set("messageID",res.msgid);}dataService.autoMappingSourceTable({success:function(){controller.detectRelationshipSourceTable(null,[tableID],constants.actions.refreshData);},failure:failureHandler},{tbid:tableID,shtIx:source.sourceInfo.sheetIndex,behaviorFlags:constants.behaviorChangeFlag.refreshData});},failure:failureHandler},{msgID:dataService.messageID,tableID:tableID,datasource:url,dict:constants.backendSourceSubtype.localFile,fileName:url,__index:0,behaviorFlags:0});},openRenameTextBox:function openRenameTextBox(menuType,slot,item){this.mappingController.openRenameTextBox(menuType,slot,item);},changeEMMAMappings:function changeEMMAMappings(cmCallback,flag,tail){var controller=this;var model=controller.model;var changedTables=[];var ids=model.getAllTableID();var i,mappings;var params;var onRSDetected={success:function(){var flags=constants.requestFlag.mapping|constants.requestFlag.sourceInfo|constants.requestFlag.relationship;if(!tail){controller.getImportedDataEMMA(actions.none,flags);}else{controller.getImportedDataEMMA(constants.actions.none,flags,null,null,null,null,cmCallback);}},failure:function(res){controller.displayError(mstrmojo.desc(12795,"RS detection failure!"),false,res.message);}};for(i=0;i<ids.length;i++){mappings=model.getImportSource(ids[i]).getMappingChanges();if(mappings&&mappings.length>0){changedTables.push(ids[i]);}}i=0;var callback={success:function(res){controller.dataService.set("messageID",res.msgid);var count=0;i++;if(i<changedTables.length){params={tbid:changedTables[i],mapping:getMappingXML.call(controller,changedTables[i])};model.getImportSource(changedTables[i]).invalidPreview();controller.dataService.changeMappingSourceTable(callback,params);}else{var dids=[];mstrmojo.array.forEach(changedTables,function(id){var source=model.getImportSource(id);if(source.canAutoMappingAndDetectRelation()){dids.push(id);}});if(dids.length>0){$ARR.forEach(dids,function(did){controller.dataService.detectRelationshipSourceTable({success:function(){count++;if(count>=dids.length){onRSDetected.success();}},failure:function(res){controller.displayError(mstrmojo.desc(12795,"RS detection failure!"),false,res.message);}},{did:did});});}else{onRSDetected.success();}}},failure:function(res){var errCode=parseInt(res.code,10);var errMsg=mstrmojo.desc(12800,"Cannot change mapping.");switch(errCode){case constants.backendError.invalidObjectName:errMsg=mstrmojo.desc(12801,"Cannot change mapping with invalid characters");break;case constants.backendError.stringTooLong:errMsg=mstrmojo.desc(12802,"Cannot change mapping with a too long string");break;}controller.displayError(errMsg,false,res.message);var flags=constants.requestFlag.mapping|constants.requestFlag.sourceInfo|constants.requestFlag.relationship;controller.getImportedDataEMMA(actions.none,flags);}};if(i<changedTables.length){params={tbid:changedTables[i],mapping:getMappingXML.call(controller,changedTables[i],flag)};model.getImportSource(changedTables[i]).invalidPreview();controller.dataService.changeMappingSourceTable((cmCallback&&!tail)?cmCallback:callback,params);}},editRelationship:function editRelationship(tableIDs,params,callback){var controller=this;if(!tableIDs||!params||!tableIDs.length){return ;}var i=0;var defaultCb={success:function(){var flags=constants.requestFlag.mapping|constants.requestFlag.sourceInfo|constants.requestFlag.relationship;controller.getImportedDataEMMA(actions.none,flags);},failure:function(res){controller.displayError(mstrmojo.desc(12803,"Cannot edit relationship."),false,res.message||"");}};var cb=mstrmojo.func.wrapMethods(defaultCb,callback,{});var afterOneTable={success:function(){i++;if(i<tableIDs.length){params.did=tableIDs[i];controller.dataService.editRelationshipSourceTable(afterOneTable,params);}else{cb.success();if(cb.complete){cb.complete();}}},failure:function(res){cb.failure(res);if(cb.complete){cb.complete();}}};params.did=tableIDs[0];controller.dataService.editRelationshipSourceTable(afterOneTable,params);},openRelationsDefineEditor:function(tableID){var cfg;if(!tableID){return ;}cfg={tableID:tableID};this.showDialog(constants.dialogType.relationDefineDialog,cfg);},removeEMMASourceTable:function removeEMMASourceTable(callback,params){this.dataService.removeEMMASourceTable(callback,params||{});},showDialog:function showDialog(dialogType,config){return this.dialogController.show(dialogType,config);},hasDialog:function hasDialog(dialogType){this.dialogController.hasDialog(dialogType);},closeDialog:function closeDialog(dialogType){this.dialogController.close(dialogType);},closePageDialog:function closePageDialog(){if(this.dialogController.pageZIndex>0){this.rootView.parent.close();}},toAttribute:function toAttribute(datas){this.mappingController.toAttribute(datas);},toMetric:function toMetric(datas){this.mappingController.toMetric(datas);},setMultipleImport:function setMultipleImport(datas){this.mappingController.setMultipleImport(datas);},setGeoRoles:function setGeoRoles(data){this.mappingController.setGeoRoles(data);},setTimeDimension:function setTimeDimension(data){this.mappingController.setTimeDimension(data);},setTimeRole:function setTimeRole(data){this.mappingController.setTimeRole(data);},toUnused:function toUnused(item){this.mappingController.toUnused(item);},openUnLinkDialog:function openUnLinkDialog(item){this.mappingController.openUnLinkDialog(item);},unlinkAll:function unlinkAll(item,tableID){this.mappingController.unlinkAll(item,tableID);},unlinkAllCubeLevel:function unlinkAllCubeLevel(item){this.mappingController.unlinkAllCubeLevel(item);},linkAttributes:function linkAttributes(targetItem,sourceItem){this.mappingController.linkAttributes(targetItem,sourceItem);},toProjectAttribute:function toProjectAttribute(item,tableId){this.mappingController.toProjectAttribute2(item,tableId);},unmap:function unmap(item){this.mappingController.unmap(item);},importItem:function importItem(item){this.mappingController.importItem(item);},changeDataType:function changeDataType(item,dtp,ctp){this.mappingController.changeDataType(item,dtp,ctp);},attachDataChangeListeners:function attachDataChangeListeners(eventsConfig){var model=this.model,evtSubs=[];$H.forEach(eventsConfig,function(config,id){$H.forEach(config,function(callback,eventName){evtSubs.push(model.attachEventListener(eventName,id,callback));});});return evtSubs;},detachDataChangeListeners:function detachDataChangeListeners(eventSubs){var model=this.model;$ARR.forEach(eventSubs,function(eventSub){model.detachEventListener(eventSub);});},raiseModelEvent:function raiseModelEvent(evt){this.model.raiseEvent(evt);},getTableNames:function getTableNames(){var model=this.model,importSources=model.importSources,source,items=[],id;for(id in importSources){if(importSources.hasOwnProperty(id)){source=importSources[id];if(source&&source.tableID){items.push({n:source.sourceInfo.name,id:source.tableID});}}}return items;},getCurrentSource:function getCurrentSource(){return this.model.currentSource;},createNewReportInstance:function(callback){var controller=this,model=this.getModel(),curDataset=model.currentDataset,isManagedCube=model.isManagedCube,params=null;if(!curDataset){if(isManagedCube){params={extParams:"<mgo>1</mgo>"};}controller.dataService.createEMMAReportInstance(callback,params);}else{controller.duplicateSelectedDataset(callback);}},removeCurrentReportInstance:function(callback){var controller=this,docController=controller.getDocController(),model=this.getModel(),dataService=controller.dataService,curDataset=model.curDataset;var cb={success:function(){model.curDataset=null;model.currentDataset=null;dataService.messageID=null;if(callback.success){callback.success();}},failure:function(res){controller.displayError(res&&res.message,false);},complete:function(){if(callback.complete){callback.complete();}}};if(curDataset&&curDataset.id){docController.removeDataset(cb,curDataset);}else{cb.success();cb.complete();}},backFromQB:function(){var controller=this;if(controller.dialogController.pageZIndex===0){controller.removeCurrentReportInstance({success:function(){controller.showPage(mstrmojo.DI.DIConstants.pageType.dataSelection);}});}else{controller.showPage(mstrmojo.DI.DIConstants.pageType.dataSelection);}},saveSourceListAdminConfig:function(resourceConfig,dbRoleConfig){var controller=this,model=this.getModel(),config={};var callback={success:function(){controller.showPage(constants.pageType.dataSelection);}};model.populateSourceListAdminConfig(resourceConfig,dbRoleConfig);if(resourceConfig||dbRoleConfig){if(mstrApp.diParams.connectorConfig){config=mstrApp.diParams.connectorConfig;}else{config={};}if(resourceConfig){config.resourceConfig=resourceConfig;}if(dbRoleConfig){config.dbRoleConfig=dbRoleConfig;}if(mstrApp.isSingleTier){this.dataService.updatePreferences(callback,"diConnectorConfig",JSON.stringify(config));}else{this.dataService.setPreference(callback,{prefs:"diConnectorConfig\u001E"+JSON.stringify(config)});}}else{callback.success();}},saveUserDefined:function(type,isUserDefined){var model=mstrApp.getRootController().getModel(),source=model.externalSources[type],ctrl=mstrApp.getRootController(),_arr=[],config,callback={success:function(){source.userDefined=!!isUserDefined;},failure:function(){ctrl.displayError(mstrmojo.desc(null,"Saving user preconfig error! Please connect to the Administrator"));}};if(isUserDefined){_arr.push(type);}for(var k in model.externalSources){if(model.externalSources.hasOwnProperty(k)){if(model.externalSources[k].userDefined&&model.externalSources[k].type!==type){_arr.push(model.externalSources[k].type);}}}config={diOauthConfig:_arr};this.dataService.setPreference(callback,{prefs:"diOauthConfig\u001E"+JSON.stringify(config)});},showSaveVisual:function(){this.rootView.showSaveVisual();},closeDIPopup:closeDIPopup,getAttributesAndMetrics:function getAttributesAndMetrics(tableID,searchText){var source,mappings,attributes=[],metrics=[],ATTRIBUTE_TYPE=12,METRIC_TYPE=4,upperSearchText=searchText?searchText.toUpperCase():"";source=this.getModel().getImportSource(tableID);if(!source){return[attributes,metrics];}mappings=source.getCurrentMappings(function(mapping){return mapping.selected&&(!upperSearchText||mapping.alias.toUpperCase().indexOf(upperSearchText)!==-1);});attributes=mstrmojo.array.filter(mappings,function(mapping){return mapping.tp===ATTRIBUTE_TYPE;});metrics=mstrmojo.array.filter(mappings,function(mapping){return mapping.tp===METRIC_TYPE;});return[attributes,metrics];},getDBRoles:function getDBRoles(typeFilter,dbRolesAdminConfig){var params={taskId:"arch.search",objecttypes:29,skipSchemaIDCheck:true,flags:1+2+256+512+8192+16384,domain:4,specialparse:"getDBRoles",xmlflags:1+2048,typeFilter:(typeFilter||[]).join(","),versionFilter:"",typeExcludeFilter:"",versionExcludeFilter:"",isDataImport:true};var callback={success:function success(res){if(mstrApp.placeholder==="DIApp"||mstrApp.placeholder==="mainDIApp"){mstrApp.dbRoles=res;mstrApp.dbRolesAdminConfig=$ARR.map(dbRolesAdminConfig,function(v){return v;});}},failure:function(res){}};mstrApp.serverRequestQueue(params,callback,taskQueue);},getCloudElementDBRoles:function getCloudElementDBRoles(dbRoleCallback){var model=this.model;var params={taskId:"arch.search",objecttypes:29,skipSchemaIDCheck:true,flags:1+2+256+512+8192+16384,domain:4,specialparse:"getDBRoles",xmlflags:1,typeFilter:"18200",versionFilter:"",typeExcludeFilter:"",versionExcludeFilter:"",};var callback={success:function(res){var addedSourceItems=$ARR.map(res.dbRoles,function(dbr){return(function(_dbr){var tempObj=$H.copy(model.cloudElement,{}),resourceConfig=$H.walk("connectorConfig.resourceConfig",mstrApp.diParams),selected=resourceConfig&&Array.prototype.indexOf.call(resourceConfig,_dbr.did)<0;return $H.copy({n:_dbr.n,desc:mstrmojo.desc(12876,"Connect to ####").replace("####",_dbr.n),onclick:function(evt){var curPageType=$H.walk("rootView.currentPage.pageType",mstrApp.getRootController()),proto=Object.getPrototypeOf(this);if(curPageType===constants.pageType.sourceAdmin){proto.onclick.call(this,evt);}else{this.handleSourceSelect(this,_dbr);}},selected:selected,oid:_dbr.did,},tempObj);})(dbr);});if(addedSourceItems.length){model.set("sourceItems",model.sourceItems.concat(addedSourceItems));model.set("cloudElementSrcItems",addedSourceItems);}model.populateCloudElementDBRole(res);model.raiseEvent({name:constants.srcItemTypes.CLOUDELEMENT_CONNECTOR,src:model});if(dbRoleCallback&&dbRoleCallback.success){dbRoleCallback.success();}}};mstrApp.serverRequestQueue(params,callback,taskQueue);},getAuthenticationDBRoles:function getAuthenticationDBRoles(next){var model=this.model;var params={taskId:"arch.search",objecttypes:29,skipSchemaIDCheck:true,flags:1+2+256+512+8192+16384,domain:4,specialparse:"getDBRoles",xmlflags:1,typeFilter:"7700",versionFilter:"",typeExcludeFilter:"",versionExcludeFilter:"",isDataImport:false};var retry=3;function sendRequest(){mstrApp.serverRequestQueue(params,callback,taskQueue);}var callback={success:function success(res){model.populateAuthenticationDBRole(res);next&&next();},failure:function(){if(retry-->0){console.log("fail");window.setTimeout(function(){sendRequest();},1);}}};sendRequest();},getManagedAuthDBR:function(tableID){if(!tableID){return ;}var model=this.getModel(),editingSource=model.getImportSource(tableID),managedDBRId=$H.walk("sourceInfo.dbRoleId",editingSource);if(managedDBRId&&managedDBRId!==""&&[constants.urlAuthDBRoles.anonymous,constants.urlAuthDBRoles.windows,constants.urlAuthDBRoles.kerberos,constants.urlAuthDBRoles.integrated].indexOf(managedDBRId)<0&&(model.authDBRoles&&Array.prototype.indexOf.call(model.authDBRoles,managedDBRId)<0)){this.dataService.getSingleDBRole({success:function(result){var dbr=typeof (result.dbr)==="object"?result.dbr:JSON.parse(result.dbr),mdbr=dbr.dbRoles[0];mdbr.isManagedDBR=true;var authDBRoles=model.authDBRoles.concat(mdbr);model.set("authDBRoles",authDBRoles);}},{dbrId:managedDBRId});}},archSearch:function archSearch(callback,params){if(mstrApp.isSingleTier){mstrApp.serverRequestQueue(params,callback,taskQueue);}else{mstrApp.serverRequestQueue($H.copy(params,{taskId:"arch.search",objecttypes:29,skipSchemaIDCheck:true,flags:1+2+256+512+8192+16384,domain:4,specialparse:"getDBRoles",xmlflags:1,}),callback,taskQueue);}},beforeDIUnload:function(evt){var confirmMsg=mstrmojo.desc(14610,"Are you sure you want to navigate away from this page? Any unsaved work will be lost."),mode=this.getModel().operationMode,rootView=this.rootView,dialogCtrl=this.dialogController,bConfirm=false;if(mode===constants.operationMode.create||mode===constants.operationMode.edit){if(dialogCtrl.pageZIndex>0){bConfirm=true;}else{if(rootView&&rootView.currentPage&&rootView.currentPage.pageType===constants.pageType.emmaPreview){bConfirm=true;}if(this.model.getHistoryList().hasSentToHistoryList){bConfirm=false;}}}if(bConfirm){evt.returnValue=confirmMsg;return confirmMsg;}},launchWrangleForTable:function launchWrangleForTable(tableId){var controller=this;var model=this.getModel();var source;source=model.getImportSource(tableId);if(!source){source=model.currentSource;}if(!source){return ;}if(source.canLaunchWrangler()){controller.launchWranglerDialog(source);}else{if(mstrmojo.DI.DIHelpers.isRefreshable(controller.model)){controller.model.isAddingNewTable=false;controller.model.refreshToWrangle=source.tableID;controller.refreshSourceTable(source.tableID);}else{controller.displayError(mstrmojo.desc(14200,"Administrator has disabled importing a file from a URL. Hence we cannot proceed to wrangle the table."));}}},importFromCube:function(cubeId,bCreateInstance,action){var controller=this,model=controller.getModel(),flags=constants.requestFlag.mapping|constants.requestFlag.sourceInfo|constants.requestFlag.relationship,origTableIDs;function showMergedDuptsTables(dupts){var name=model.cubeName;var msg=mstrmojo.desc(14888,"We detected that the datasets contain identical tables. The definition from ### will be used. The following tables are affected:").replace("###",name);var msg2=mstrmojo.desc(14889,"We detected that the datasets contain identical tables. The definition from the current dataset will be used. The following tables are affected:");var detailMsg;var tables;function fn(){detectMergedPartition();}try{dupts=JSON.parse(dupts);}catch(e){fn();return ;}if(!dupts||!dupts.table){fn();return ;}tables=dupts.table;tables=[].concat(tables);if(tables.length<0){fn();return ;}detailMsg="<ul>";$ARR.forEach(tables,function(item){detailMsg+="<li>"+item.n+"</li>";});detailMsg+="</ul>";mstrApp.getRootController().displayError(name?msg:msg2,false,detailMsg,fn);}function detectMergedPartition(){var controller=mstrApp.getRootController();var getDataCallback={success:function(){var tableIDs=model.getAllTableID(),ids;ids=$ARR.difference(tableIDs,origTableIDs);ids=$ARR.filter(ids,function(id){var source=model.getImportSource(id);var xda=source&&source.xdaType;if(xda===constants.xdaType.excel||xda===constants.xdaType.text){return true;}return false;});$ARR.forEach(ids,function(id){var flags=constants.requestFlag.mapping|constants.requestFlag.sourceInfo|constants.requestFlag.transformations;controller.getImportedDataEMMA(constants.actions.none,flags,undefined,undefined,id);});}};var dialogCallback={onOK:function(){controller.getImportedDataEMMA(action,flags,undefined,undefined,undefined,0,getDataCallback);},onCancel:function(data){controller.getImportedDataEMMA(action,flags,undefined,undefined,undefined,0,getDataCallback,data);}};var isMergedCube=true;controller.autoDetectPartitionGroups(dialogCallback,undefined,isMergedCube);}var reportInstanceCreated={success:function(){origTableIDs=model.getAllTableID();controller.getImportController().importFromCube(cubeId,{success:function(res){if(res&&res.dupts){showMergedDuptsTables(res.dupts);}else{detectMergedPartition();}},failure:function(res){if(parseInt(res.code,10)===constants.backendError.ddasupportIncompatible){mstrApp.getRootController().displayError(mstrmojo.desc(14890,"Cannot perform the action since one of the cube support Direct Data Access only while the other is In-Memory only."),false,res.message);}else{if(parseInt(res.code,10)===constants.backendError.mergeInvalidXdatype){mstrApp.getRootController().displayError(mstrmojo.desc(14891,"Import from a cube of some XDAType is not supported, such as MDX, Search Engine Indices."),false,res.message);}else{if(parseInt(res.code,10)===constants.backendError.notFullyControl){mstrApp.getRootController().displayError(mstrmojo.desc(14892,"User dont have full control for the merge cube."),false,res.message);}else{mstrApp.getRootController().displayError(mstrmojo.desc(641,"Please try again. If the problem persists, contact the server Administrator."),false,res.message);}}}}});},failure:function(res){controller.displayError(mstrmojo.desc(12783,"Create EMMA Report Instance error. Please check the metadata."),false,res.message||"");}};if(bCreateInstance){controller.createNewReportInstance(reportInstanceCreated);}else{reportInstanceCreated.success();}},searchObjectName:function(callback,params){var searchObjectNameCallback={success:function(res){if(res&&res==="existed"){callback.rename();}else{callback.saveDirectly();}},failure:function(res){}};this.getDataService().searchObjectName(searchObjectNameCallback,params);}});}());