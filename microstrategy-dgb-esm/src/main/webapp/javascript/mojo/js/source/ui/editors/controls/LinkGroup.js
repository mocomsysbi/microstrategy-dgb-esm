(function(){mstrmojo.requiresCls("mstrmojo.ui.editors.controls.ControlGroup","mstrmojo.Label","mstrmojo.StackContainer","mstrmojo.TabContainer","mstrmojo.TabStrip","mstrmojo.mstr.EnumDSSXMLObjectTypes","mstrmojo.ui.Pulldown","mstrmojo.ui.editors.controls.TwoColumnContainer","mstrmojo.TextBox","mstrmojo.Button","mstrmojo.array","mstrmojo.css","mstrmojo.hash","mstrmojo.string","mstrmojo.vi.ui._IsValidURL","mstrmojo.ui.Checkbox");var $ARR=mstrmojo.array,$BTN=mstrmojo.Button,$CSS=mstrmojo.css,$HASH=mstrmojo.hash,$STR=mstrmojo.string,$NWB=$BTN.newWebButton,$OBJ_TYPE=mstrmojo.mstr.EnumDSSXMLObjectTypes,$URL_PLACEHOLDER="http://",linkTypes={DISABLED:-1,URL:0,LINK_MSTR:1,LINK_PAGE:3},getXMLLink=function(linkType,link,objectLink,newWin,tooltip){var tag=function(tag,atts,inner){if(inner){return"<"+tag+atts+">"+inner+"</"+tag+">";}return"<"+tag+atts+"/>";},att=function(value,name){return(value!==undefined?" "+name+'="'+value+'"':"");},openInNewWindow=newWin?1:undefined,defaultAnswerMode=2,hyperlinkURL=(linkType===linkTypes.URL?$STR.encodeXMLAttribute(link||""):undefined),selectorOptions=0,targetID=(linkType===linkTypes.LINK_MSTR?objectLink.did:undefined),targetType=(linkType===linkTypes.LINK_MSTR?objectLink.t:undefined),targetSubType=(linkType===linkTypes.LINK_MSTR?objectLink.st:undefined),navigationPage=(linkType===linkTypes.LINK_PAGE?objectLink.navPage:undefined),displayText=$STR.encodeXMLAttribute(tooltip||""),isDefault=1;return tag("hls",att(openInNewWindow,"onw"),tag("hl",att(isDefault,"idf")+att(defaultAnswerMode,"aopam")+att(displayText,"dtxt")+att(hyperlinkURL,"url")+att(linkType,"lt")+att(targetType,"ttp")+att(targetID,"tid")+att(targetSubType,"tstp")+att(navigationPage,"np")+att(selectorOptions,"so")));},currentLinkType=linkTypes.DISABLED,linkObjInfo={},getCurrentLinkType=function getCurrentLinkType(host){if(host.linkType!==undefined){return host.linkType;}if(host.node.data.tid){return linkTypes.LINK_MSTR;}if(host.node.data.navpage){return linkTypes.LINK_PAGE;}if(host.url){return linkTypes.URL;}return linkTypes.DISABLED;},getTooltip=function getTooltip(w){return $STR.decodeHtmlString((w.defn.dl&&w.defn.dl.items&&w.defn.dl.items[0]&&w.defn.dl.items[0].n)||w.tooltip||"");},typeChanging=false,restoring=false,fieldChange=function fieldChange(){var host=mstrmojo.all[this.hostId],hostNodeData=host.node&&host.node.data,group=this.tabgroup.tabstack,type=group.selectedLinkType,hasTypeChanged=(currentLinkType!==type),hasTooltipChanged=(getTooltip(host)!==this.tooltip.text.value),link,openInNewWindow,isDirty=false;if(this.hasRendered&&!typeChanging){switch(type){case linkTypes.DISABLED:isDirty=hasTypeChanged;break;case linkTypes.URL:link=group.linkText.text.value;if(!mstrmojo.string.isEmpty(link)&&link!==$URL_PLACEHOLDER&&this.isValidURL(link)){isDirty=hasTypeChanged||(link!==host.url)||hasTooltipChanged;}break;case linkTypes.LINK_MSTR:openInNewWindow=(host.target==="_blank");if(linkObjInfo.did){isDirty=hasTypeChanged||(!hostNodeData||hostNodeData.tid!==linkObjInfo.did)||(openInNewWindow!==this.openNewWin.check.checked)||hasTooltipChanged;}break;case linkTypes.LINK_PAGE:if(linkObjInfo.navPage){isDirty=hasTypeChanged||(!hostNodeData||hostNodeData.navpage!==linkObjInfo.navPage)||hasTooltipChanged;}break;}this.set("dirty",isDirty);}},handleSelectionSubmit=function(shouldSave){if(shouldSave){var that=this,docModel=that.docModel,host=mstrmojo.all[this.hostId],group=this.tabgroup.tabstack,rwSelector=group.rwSelector,pageSelector=group.pageSelector&&group.pageSelector.text,type=group.selectedLinkType,newWin=type===linkTypes.URL?true:type===linkTypes.LINK_PAGE?false:this.openNewWin&&this.openNewWin.check.checked,tooltip=this.tooltip.text.value,encodedTooltip=$STR.encodeHtmlString(tooltip),link=type!==linkTypes.URL?undefined:group.linkText.text.value,xml,undoState,redoState,clearTooltip,fnSelectVIUnit=function(){if(host&&host.model.getSelectedViUnit().k===host.parent.k&&host.parent.id){host.model.selectVIUnit(host.parent.id,true);}host.parent.generateToolbar();},restoreState=function(state){restoring=true;host.defn.dl=state.dl;host.target=state.target;host.url=state.url;host.tooltip=state.tooltip;host.linkType=state.linkType;host.node.data.tnm=state.linkObjInfo.n;host.node.data.tid=state.linkObjInfo.did;host.node.data.ttp=state.linkObjInfo.t;host.node.data.tstp=state.linkObjInfo.st;host.node.data.navpage=state.linkObjInfo.navPage;host.node.data.navpagenm=state.linkObjInfo.n;group.set("selectedLinkType",state.linkType);group.linkText.text.set("value",state.url||"");that.tooltip.text.set("value",state.tooltip);if(rwSelector){rwSelector.search.text.set("value",state.linkObjInfo.n||"");that.openNewWin.check.set("checked",state.target==="_blank");}if(pageSelector){pageSelector.set("selectedIndex",state.linkObjInfo.idx||0);}restoring=false;fnSelectVIUnit();};if(!restoring){if(type===linkTypes.DISABLED){xml="";clearTooltip=true;}else{if(link||linkObjInfo||newWin!==undefined){xml=getXMLLink(type,link,linkObjInfo,newWin,encodedTooltip);}}undoState={dl:$HASH.clone(host.defn.dl),target:host.target,url:host.url,tooltip:host.tooltip,linkType:host.linkType,linkObjInfo:{n:host.node.data.tnm||host.node.data.navpagenm,did:host.node.data.tid,navPage:host.node.data.navpage,t:host.node.data.ttp,st:host.node.data.tstp}};if(tooltip!==undefined||clearTooltip!==undefined){host.tooltip=clearTooltip?"":encodedTooltip;if(host.defn.dl){host.parent.defn.dl.items[0].n=clearTooltip?"":encodedTooltip;}}docModel.editLink(host.parent,that.hostType,xml,{success:function(res){host.linkType=type;docModel.partialUpdate(res.data,docModel.getTargetDefn(host.k),res.defn);if(type===linkTypes.LINK_MSTR){group.linkText.text.set("value","");if(rwSelector){rwSelector.search.text.set("value",linkObjInfo.n);}if(pageSelector){pageSelector.set("selectedIndex",0);}}if(type===linkTypes.LINK_PAGE){group.linkText.text.set("value","");if(rwSelector){rwSelector.search.text.set("value","");}if(pageSelector){pageSelector.set("selectedIndex",linkObjInfo.idx);}}if(type===linkTypes.URL){group.linkText.text.set("value",link);if(rwSelector){rwSelector.search.text.set("value","");}if(pageSelector){pageSelector.set("selectedIndex",0);}}if(type===linkTypes.DISABLED){delete host.defn.dl;delete host.node.data.dl;delete host.target;delete host.url;group.linkText.text.set("value","");if(rwSelector){rwSelector.search.text.set("value","");}if(pageSelector){pageSelector.set("selectedIndex",0);}}else{host.target=newWin?"_blank":"";that.tooltip.text.set("value",tooltip);if(rwSelector&&rwSelector.visible){that.openNewWin.check.set("checked",newWin);}}redoState={dl:$HASH.clone(host.defn.dl),target:host.target,url:host.url,tooltip:host.tooltip,linkType:group.selectedLinkType,linkObjInfo:{n:host.node.data.tnm||host.node.data.navpagenm,did:host.node.data.tid,navPage:host.node.data.navpage,t:host.node.data.ttp,st:host.node.data.tstp}};fnSelectVIUnit();},undo:function(){restoreState(undoState);},redo:function(){restoreState(redoState);}});}}this.close();},getPageSelectorItems=function(model){var index=0,items=[{n:mstrmojo.desc(15776,"Select a page in this dossier"),idx:index++}],layouts=model.defn.layouts,units,panelKeys,page;$ARR.forEach(layouts,function(chapter){units=chapter.units;items.push({n:chapter.title,idx:index++});panelKeys=model.getVisPanelKeys(chapter.k,true);$ARR.forEach(panelKeys,function(key){page=units[key];items.push({n:page.ttl,navPage:key,idx:index++});});});return items;},getObjectName=function getObjectName(host){return host.node.data.tnm;},addPageTab=function addPageTab(ctrl,psItems){var ctrlArray=ctrl.children,idx=$ARR.find(ctrlArray,"alias",this._pageTab.alias),hasPageTab=(idx>-1),needsPageTab=$ARR.filter(psItems,function(item){return item.navPage;}).length>1;if(!hasPageTab&&needsPageTab){$ARR.insert(ctrlArray,1,this._pageTab);}else{if(hasPageTab&&!needsPageTab){$ARR.removeIndices(ctrlArray,idx,1);if(ctrl.selectedLinkType===linkTypes.LINK_PAGE){ctrl.set("selectedLinkType",linkTypes.URL);}}}},reset=function reset(){var host=mstrmojo.all[this.hostId],navPage=host.node.data.navpage,pageSelectorItems=getPageSelectorItems(this.docModel),tg=this.tabgroup,strip=tg.tabstrip,group=tg.tabstack;addPageTab.call(this,group,pageSelectorItems);strip.clearButtons();strip.ontargetChange();var urlSelector=group.linkText,rwSelector=group&&group.rwSelector,ps=group.pageSelector,pageSelector=ps&&ps.text,openNewWin=this.openNewWin,tooltip=getTooltip(host);currentLinkType=getCurrentLinkType(host);if(currentLinkType===linkTypes.LINK_MSTR){if(mstrApp.isSingleTier){linkObjInfo={};tooltip="";host.set("tooltip",tooltip);currentLinkType=linkTypes.DISABLED;}else{linkObjInfo={n:host.node.data.tnm,did:host.node.data.tid,t:host.node.data.ttp,st:host.node.data.tstp};}}else{if(currentLinkType===linkTypes.LINK_PAGE){var navPageSelector=$ARR.filterOne(pageSelectorItems,function(item){return item.navPage===navPage;});linkObjInfo=navPageSelector?{navPage:navPage,n:host.node.data.navpagenm,idx:navPageSelector.idx}:{};}else{linkObjInfo={};if(currentLinkType===linkTypes.DISABLED){tooltip="";host.set("tooltip",tooltip);}}}group.set("selectedLinkType",currentLinkType===linkTypes.DISABLED?group.selected.linkType:currentLinkType);urlSelector.tooltip="";urlSelector.text.set("value",host.url||"");if(rwSelector){rwSelector.tooltip="";rwSelector.search.text.set("value",getObjectName(host));}if(pageSelector){ps.tooltip="";pageSelector.set("items",pageSelectorItems);pageSelector.set("selectedIndex",linkObjInfo.idx||0);}if(openNewWin){openNewWin.check.set("checked",currentLinkType===linkTypes.LINK_MSTR?host.target==="_blank":true);}this.tooltip.text.set("value",tooltip);group.selected.tooltip=tooltip;this.set("dirty",false);};mstrmojo.ui.editors.controls.LinkGroup=mstrmojo.declare(mstrmojo.ui.PopupWidget,[mstrmojo.vi.ui._IsValidURL],{scriptClass:"mstrmojo.ui.editors.controls.LinkGroup",dirty:false,onOpenCallback:mstrmojo.emptyFn,onCloseCallback:mstrmojo.emptyFn,init:function init(props){this._super(props);var tabControls=[],that=this,host=mstrmojo.all[this.hostId],url=host.url||"",objName=getObjectName(host),pageSelectorItems=getPageSelectorItems(this.docModel),children=[],urlTab=new mstrmojo.ui.editors.controls.TwoColumnContainer({alias:"linkText",linkType:linkTypes.URL,n:mstrmojo.desc(9922,"URL"),tooltip:"",children:[{scriptClass:"mstrmojo.Label",slot:"col1Node",text:mstrmojo.desc(9922,"URL")},{scriptClass:"mstrmojo.TextBox",slot:"col2Node",alias:"text",hint:$URL_PLACEHOLDER,value:url||$URL_PLACEHOLDER,onfocus:function(){if(!this.value){this.set("value",$URL_PLACEHOLDER);}},onblur:function(){if(this.value===$URL_PLACEHOLDER){this.set("value","");}},onkeydown:function(eventWrapper){if(eventWrapper.e.keyCode===13){this.blur();}},onvalueChange:function onvalueChange(){var me=this,undoInvalidState=function(){me.set("textValid",false);me.domNode.setAttribute("title","");};if(this.hasRendered){if(that.isValidURL(this.value)){undoInvalidState();}else{if(this.value){this.setInvalidState(mstrmojo.desc(12068,"Invalid URL"));}else{undoInvalidState();}}fieldChange.call(that);}}}]}),rwTab=new mstrmojo.ui.editors.controls.TwoColumnContainer({alias:"rwSelector",linkType:linkTypes.LINK_MSTR,n:mstrmojo.desc(2711,"File"),tooltip:"",children:[{scriptClass:"mstrmojo.Label",slot:"col1Node",text:mstrmojo.desc(2711,"File")},{scriptClass:"mstrmojo.Box",alias:"search",slot:"col2Node",cssClass:"linkDoss",children:[{scriptClass:"mstrmojo.TextBox",alias:"text",cssClass:"rwselector"+(objName?"":" mstrmojo-empty"),readOnly:true,hint:mstrmojo.desc(13864,"Choose a file"),tooltip:objName,value:objName,onvalueChange:function(evt){if(this._super){this._super(evt);}$CSS.toggleClass(this.domNode,"mstrmojo-empty",!this.value);}},$BTN.newIconButton("","icon",function(){var me=this,duMenu=mstrmojo.vi.ui.DatasetUnitMenuUtils,ed;that.set("closeOnClick",false);duMenu.showObjectPicker(function OKFn(item){me.parent.text.set("value",item.n);linkObjInfo=item;fieldChange.call(that);},[$OBJ_TYPE.DocumentDefinition,$OBJ_TYPE.ReportDefinition])();ed=duMenu.getObjectPicker();if(!this._editorCloseFunction){this._editorCloseFunction=ed.onClose;ed.onClose=mstrmojo.func.composite([ed.onClose,function(){that.set("closeOnClick",true);}]);}})]}]}),pageTab=new mstrmojo.ui.editors.controls.TwoColumnContainer({alias:"pageSelector",linkType:linkTypes.LINK_PAGE,n:mstrmojo.desc(3687,"Page"),tooltip:"",children:[{scriptClass:"mstrmojo.Label",slot:"col1Node",text:mstrmojo.desc(15697,"Page Name")},{scriptClass:"mstrmojo.ui.Pulldown",alias:"text",slot:"col2Node",cssClass:"linkPage"+(linkObjInfo.idx?"":" mstrmojo-empty"),items:pageSelectorItems,selectedIndex:linkObjInfo.idx||0,allowHTML:false,onSelectedItemChange:function(item){var isEmpty=(item.idx<=0);if(!isEmpty){linkObjInfo=item;fieldChange.call(that);}if(!this.value){this.set("value",item.n);}$CSS.toggleClass(this.domNode,"mstrmojo-empty",isEmpty);},getPopupListConfig:function getpopupListConfig(){var cfg=this.addDisposable(mstrmojo.ui.Pulldown.prototype.getPopupListConfig());cfg.listHooks={select:function(el,item,index){var np=item.navPage,currentPage=that.docModel.getVizContentPanel().k;if(!np||currentPage===np){return true;}this.parent.set("selectedIndex",index);if(this.visible&&this.closeAfterSelection){this.close();}},unselect:function(){var si=this.selectedItem,np=si&&si.navPage,currentPage=that.docModel.getVizContentPanel().k;if(!np||currentPage===np){return true;}}};cfg.getItemProps=function(item,idx){var itemProps=mstrmojo._IsList.getItemProps.call(this,item,idx),np=item.navPage,currentPage=that.docModel.getVizContentPanel().k;itemProps.style=this.parent.itemCssText||"";if(idx===0){itemProps.addCls("hidden");}else{if(!np){itemProps.addCls("chap");}else{if(np===currentPage){itemProps.addCls("curr_pg");}}}return itemProps;};cfg.getItemMarkup=function(item){var np=item.navPage,currentPage=that.docModel.getVizContentPanel().k,currText="<span>"+mstrmojo.desc(15777,"(current page)")+"</span>";if(!np){return'<{@tag} class="item {@cls}" idx="{@idx}" style="{@style}" title="{@title}">{@en@n}</{@tag}>';}return'<{@tag} class="item {@cls}" idx="{@idx}" style="{@style}" title="{@title}"><div></div>{@en@n}'+(np===currentPage?currText:"")+"</{@tag}>";};return cfg;}}]});this._pageTab=pageTab;tabControls.push(urlTab);tabControls.push(pageTab);if(!mstrApp.isSingleTier){tabControls.push(rwTab);}children.push({scriptClass:"mstrmojo.TabContainer",alias:"tabgroup",children:[{scriptClass:"mstrmojo.TabStrip",autoHide:true,alias:"tabstrip",target:this.parent.tabstack},{scriptClass:"mstrmojo.StackContainer",slot:"stack",alias:"tabstack",cssClass:"linkGroup",selectedLinkType:linkTypes.URL,onselectedChange:function(){this.set("selectedLinkType",this.selected.linkType);if(that.tooltip){that.tooltip.text.set("value",this.selected.tooltip);}if(that.tabgroup){fieldChange.call(that);}},onselectedLinkTypeChange:function(){var showOpenNewWin=false;switch(this.selectedLinkType){case linkTypes.DISABLED:return ;case linkTypes.URL:this.set("selected",urlTab);break;case linkTypes.LINK_MSTR:this.set("selected",rwTab);showOpenNewWin=true;break;case linkTypes.LINK_PAGE:if(this.hasRendered&&!pageTab.hasRendered){pageTab.render();}this.set("selected",pageTab);break;}if(that.openNewWin){that.openNewWin.set("visible",showOpenNewWin);}},postCreate:function(){this.set("selected",urlTab);},children:tabControls}]},{scriptClass:"mstrmojo.ui.editors.controls.TwoColumnContainer",alias:"tooltip",cssClass:"linkGroup",children:[{scriptClass:"mstrmojo.Label",alias:"label",slot:"col1Node",text:mstrmojo.desc(15698,"Tooltip")},{scriptClass:"mstrmojo.TextBox",alias:"text",slot:"col2Node",valueChangeDelay:3000,value:getTooltip(host),hint:mstrmojo.desc(12070,"Hyperlink#").replace("#",""),onkeydown:function(eventWrapper){if(eventWrapper.e.keyCode===13){this.blur();}},onvalueChange:function onvalueChange(){that.tabgroup.tabstack.selected.set("tooltip",this.value);fieldChange.call(that);}}]});if(!mstrApp.isSingleTier){children.push({scriptClass:"mstrmojo.HBox",alias:"openNewWin",cssClass:"linkNewWindow",visible:false,children:[new mstrmojo.ui.Checkbox({alias:"check",cssDisplay:"inline-block",checked:host.target==="_blank",oncheckedChange:function(){fieldChange.call(that);}}),new mstrmojo.Label({cssDisplay:"inline-block",text:mstrmojo.desc(3593,"Open in new window")})]});}children.push({scriptClass:"mstrmojo.Box",alias:"buttons",cssClass:"buttonBox",children:[{scriptClass:"mstrmojo.Box",alias:"rmvBtn",cssDisplay:"inline-block",children:[$NWB(mstrmojo.desc(15701,"Remove Link"),function(){that.tabgroup.tabstack.set("selectedLinkType",linkTypes.DISABLED);handleSelectionSubmit.call(that,true);that.close();},false,{alias:"btn",onenabledChange:function(){$CSS.toggleClass(this.domNode,"disabled",!this.enabled);}})]},{scriptClass:"mstrmojo.Box",alias:"rtBtns",cssClass:"buttonBoxRt",cssDisplay:"inline-block",children:[$NWB(mstrmojo.desc(118,"Save"),function(){handleSelectionSubmit.call(that,true);},true,{alias:"saveBtn",cssDisplay:"inline-block",enabled:false,onenabledChange:function(){$CSS.toggleClass(this.domNode,"disabled",!this.enabled);}}),$NWB(mstrmojo.desc(221,"Cancel"),function(){handleSelectionSubmit.call(that,false);},false,{cssDisplay:"inline-block"})]}]});this.addChildren(children);reset.call(this);},onOpen:function(){reset.call(this);this.buttons.rmvBtn.btn.set("enabled",currentLinkType!==linkTypes.DISABLED);this.onOpenCallback();},onClose:function(){this.onCloseCallback();},oncloseOnClickChange:function(){if(this.closeOnClick&&this._zIndex!==undefined){this.domNode.parentNode.style.zIndex=this._zIndex;delete this._zIndex;this.hoverLock(false);this.lockHover();}else{if(!this.closeOnClick){this._zIndex=this.domNode.parentNode.style.zIndex;this.domNode.parentNode.style.zIndex="1";this.unlockHover();this.hoverLock(true);}}},ondirtyChange:function(){this.buttons.rtBtns.saveBtn.set("enabled",this.dirty);},destroy:function destroy(ignoreDom){this._pageTab.destroy();if(this._super){this._super(ignoreDom);}}});}());