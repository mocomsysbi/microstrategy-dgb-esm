(function(){mstrmojo.requiresCls("mstrmojo.ui.ScrollableList","mstrmojo._IsPopup","mstrmojo._CanAutoClose","mstrmojo.ui._HasListTooltip");mstrmojo.ui.PopupList=mstrmojo.declare(mstrmojo.ui.ScrollableList,[mstrmojo._IsPopup,mstrmojo._CanAutoClose,mstrmojo.ui._HasListTooltip],{scriptClass:"mstrmojo.ui.PopupList",autoCloses:true,locksHover:true,closeOnClick:true,scrollNodeMaxHeight:undefined,parentDomNode:undefined,keydownString:null,lastKeydownTime:null,keydownInterval:500,closeAfterSelection:true,markupString:'<div id="{@id}" class="mstrmojo-PopupList {@cssClass}" style="{@cssText}" tabIndex="-1" mstrAttach:click,dblclick,mouseover,mouseout,contextmenu,keydown><div class="mstrmojo-popupList-scrollBar"><div class="{@icnCss}" style="{@icnCssText}">{@itemsHtml}</div></div></div>',markupSlots:{itemsContainerNode:function itemsContainerNode(){return this.domNode.firstChild.firstChild;},scrollboxNode:function scrollboxNode(){return this.domNode.firstChild;}},setupScrollNodes:function setupScrollNodes(){this.scrollNode=this.scrollboxNode;},onOpen:function onOpen(){this._super();this.updateScrollbars();var me=this;setTimeout(function(){me.scrollToSelectedItem();},10);},onclick:function onclick(evt){this.closeAfterSelection=true;this._super(evt);},postBuildRendering:function postBuildRendering(){var rtn=this._super();if(!this.parent){var node=this.parentDomNode=this.parentDomNode||document.body;node.appendChild(this.domNode);}return rtn;},closePopup:function closePopup(){this.set("visible",false);},onkeydown:function onkeydown(evt){if(!this.opener||!this.opener.focusOnPopup){return ;}var hWin=evt.hWin,e=evt.e||hWin.event,currentKeydownStr=this.keydownString;this.locksHover=false;this.closeAfterSelection=false;if(e.keyCode===mstrmojo.Enum_Keys.DOWN_ARROW){if(this.selectedIndex<this.items.length-1){this.set("selectedIndex",this.selectedIndex+1);this.scrollToSelectedItem();}}else{if(e.keyCode===mstrmojo.Enum_Keys.UP_ARROW){if(this.selectedIndex>0){this.set("selectedIndex",this.selectedIndex-1);this.scrollToSelectedItem();}}else{if(e.keyCode===mstrmojo.Enum_Keys.ENTER||e.keyCode===mstrmojo.Enum_Keys.ESCAPE){this.closeAfterSelection=true;this.singleSelect(this.selectedIndex);}else{var d=new Date(),newTimestamp=d.getTime(),newKeyChar=String.fromCharCode(e.keyCode).toLowerCase(),me=this;if(this.lastKeydownTime===null){this.keydownString=newKeyChar;}else{if(newTimestamp-this.lastKeydownTime<this.keydownInterval){this.keydownString=this.keydownString+newKeyChar;}else{this.keydownString=newKeyChar;}}currentKeydownStr=this.keydownString;if(this._holdTimer){clearTimeout(this._holdTimer);}this._holdTimer=setTimeout(function(){me.changeSelectedItem(evt);me.adjustPosition();},me.keydownInterval);this.lastKeydownTime=newTimestamp;}}}},changeSelectedItem:function changeSelectedItem(evt){var newSelectedIndex=this.selectedIndex,count=this.items&&this.items.length;if(count>0){var i;for(i=this.selectedIndex+1;i<this.items.length;i++){if(this.items[i].n.toLowerCase().indexOf(this.keydownString)==0){newSelectedIndex=i;break;}}if(newSelectedIndex===this.selectedIndex){for(i=0;i<this.selectedIndex;i++){if(this.items[i].n.toLowerCase().indexOf(this.keydownString)==0){newSelectedIndex=i;break;}}}if(newSelectedIndex!==this.selectedIndex){this.set("selectedIndex",newSelectedIndex);}}},focus:function focus(){this.domNode.focus();},scrollToSelectedItem:function scrollToSelectedItem(){var selectedNode=this.itemsContainerNode.childNodes[this.selectedIndex];if(selectedNode){var vp=this.scrollNode,nodeHeight=vp.clientHeight,osTop=selectedNode.offsetTop;if(osTop-vp.scrollTop+selectedNode.offsetHeight>nodeHeight){vp.scrollTop=selectedNode.offsetTop+selectedNode.offsetHeight-nodeHeight;}else{if(osTop<vp.scrollTop){vp.scrollTop-=selectedNode.offsetHeight;}}}},adjustPosition:function adjustPosition(){this.adjustCornersForPopupOverflow();this.scrollToSelectedItem();this.focus();}});}());