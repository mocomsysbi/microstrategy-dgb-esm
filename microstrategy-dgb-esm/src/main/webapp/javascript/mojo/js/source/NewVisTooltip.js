(function(){mstrmojo.requiresCls("mstrmojo.Box","mstrmojo.dom","mstrmojo.css","mstrmojo.hash","mstrmojo.string","mstrmojo.ui._HasScroller","mstrmojo.VisUtility");var $CSS=mstrmojo.css,$DOM=mstrmojo.dom,$UTILS=mstrmojo.VisUtility,$ARR=mstrmojo.array,$STR=mstrmojo.string,$HASH=mstrmojo.hash,cssBaseClass="new-vis-tooltip",ColumnPadding=16,RIGHT_PADDING=12,BOTTOM_PADDING=20,EDGE_PADDING=5,CTN_PADDING=20,TTP_BORDER=2,MAX_STRING_WIDTH=220,MIN_WIDTH=120,PX="px",TimeDelay4Hide=200,DOM_EVENTS=["mouseover","mouseout"];function addTableNode(colNum){var table=this.tableNode;table.innerHTML="";for(var i=0;i<colNum;i++){table.appendChild(document.createElement("COL"));}return table;}function insertStrToTd(str,td){str=str||"";td.innerHTML=$STR.encodeHtmlString(str,true);var result,nameFs=$UTILS.getComputedFontStyle(td),nameLen=Math.ceil($UTILS.measureTextWidth(td.innerHTML,nameFs,nameFs.bonus));if(nameLen>MAX_STRING_WIDTH){result=$UTILS.truncateTextToLineWithWordWrap(str,nameFs,MAX_STRING_WIDTH,3,true);td.innerHTML=$STR.encodeHtmlString(result.text,true);td.setAttribute("title",str);}return Math.min(nameLen,MAX_STRING_WIDTH);}function adjustTableDimension(table,colWidth){var children=table.childNodes,colNums=(colWidth&&colWidth.length)||0,totalWidth=0,i,width;for(i=0;i<colNums;i++){width=colWidth[i]+((i<colNums-1)?ColumnPadding:1);children[i].style.width=width+PX;totalWidth+=width;}table.style.width=totalWidth+PX;}mstrmojo.NewVisTooltip=mstrmojo.declare(mstrmojo.Box,[mstrmojo.ui._HasScroller],{scriptClass:"mstrmojo.NewVisTooltip",prevInfoObj:null,hideTooltipHandler:null,domEventListeners:{},markupString:'<div id="{@id}" class="mstrmojo-Box {@cssClass}" style="{@cssText}"><div class="new-vis-tooltip-container-wrapper"><div class="new-vis-tooltip-container"><div  class="new-vis-tooltip-table"></div></div></div></div>',markupSlots:{containerNode:function(){return this.domNode.firstChild.firstChild;},tableNode:function(){return this.domNode.firstChild.firstChild.firstChild;}},init:function init(props){this._super(props);$CSS.addWidgetCssClass(this,(props&&props.widgetClass)?[props.widgetClass,cssBaseClass]:cssBaseClass);},postBuildRendering:function postBuildRendering(){this._super();this.attachListeners();},attachListeners:function attachListeners(){this.detachListeners();$ARR.forEach(DOM_EVENTS,function(event){this.domEventListeners[event]=$DOM.attachMarkupEvent(this.id,this.domNode,event);},this);},setupScrollNodes:function setupScrollNodes(){this.scrollNode=this.containerNode;this.scrollbarHostNode=this.domNode;},toggle:function toggle(show){var inPrintPreview=mstrApp.isAppStatePrintPreview&&mstrApp.isAppStatePrintPreview();if(this.domNode){this.domNode.style.display=show&&!inPrintPreview?"block":"none";}},isVisible:function isVisible(){return this.domNode&&(this.domNode.style.display!=="none");},hasTableContent:function hasTableContent(){return this.tableNode;},clearTooltipHandler:function clearTooltipHandler(){if(this.hideTooltipHandler){clearTimeout(this.hideTooltipHandler);this.hideTooltipHandler=null;}},renderTooltip:function renderTooltip(infoObj,pos){if(!infoObj||infoObj.length===0){return ;}this.toggle(true);if($ARR.isArray(infoObj)){this.showSimpleInfo(infoObj,pos);}else{this.showGridInfo(infoObj,pos);}this.prevInfoObj=infoObj;},showTooltipDelay:function showTooltipDelay(infoObj,pos){this.clearTooltipHandler();var me=this;this.showTooltipHandler=setTimeout(function(){me.renderTooltip(infoObj,pos);},200);},showDossierTtp:function showDossierTtp(infoObj,pos){this.clearTooltipHandler();if(this.isVisible()&&$HASH.equals(this.prevInfoObj,infoObj)){this.moveTo(pos,true);}else{this.renderTooltip(infoObj,pos);}},showSimpleInfo:function showSimpleInfo(infoArr,pos){if(!infoArr||infoArr.length<=0){return ;}var table=addTableNode.call(this,2),tbody=document.createElement("tbody"),maxNameLen=0,maxValueLen=0;table.appendChild(tbody);$ARR.forEach(infoArr,function(infoItem){var tr=tbody.insertRow(-1),tdn=tr.insertCell(-1),tdv=tr.insertCell(-1);$CSS.addClass(tdn,"name");maxNameLen=Math.max(maxNameLen,insertStrToTd(infoItem.n,tdn));maxValueLen=Math.max(maxValueLen,insertStrToTd(infoItem.v,tdv));});adjustTableDimension.call(this,table,[maxNameLen,maxValueLen]);this.moveTo(pos);},showGridInfo:function showGridInfo(infoObj,pos){var infoHeader=infoObj&&infoObj.header,infoBody=infoObj&&infoObj.body,attrCnt=infoObj&&infoObj.attrCount,row,td,i;if(!infoHeader||infoHeader.length<=0){return ;}var colNums=infoHeader.length,table=addTableNode.call(this,colNums),thead=document.createElement("thead"),tbody=document.createElement("tbody"),headerRow=thead.insertRow(-1),colWidth=[];table.appendChild(thead);table.appendChild(tbody);$ARR.forEach(infoHeader,function(header,idx){td=headerRow.insertCell(-1);$CSS.addClass(td,"header");if(idx>=attrCnt){$CSS.addClass(td,"metric");}colWidth[idx]=insertStrToTd(header,td);});$ARR.forEach(infoBody,function(bodyRow,rowIdx){row=tbody.insertRow(-1);for(i=0;i<colNums;i++){td=row.insertCell(-1);if(rowIdx===0){$CSS.addClass(td,"firstRow");}if(i>=attrCnt){$CSS.addClass(td,"metric");}colWidth[i]=Math.max(colWidth[i],insertStrToTd(bodyRow[i],td));}});adjustTableDimension.call(this,table,colWidth);this.moveTo(pos);},moveTo:function(pos,keepScroll){if(!pos||isNaN(pos.x)||isNaN(pos.y)||!this.tableNode){return ;}var loc=mstrmojo.dom.position(document.body),domNode=this.domNode,ctnNode=this.containerNode,tableNode=this.tableNode,domNodeStyle=domNode.style,ctnNodeStyle=ctnNode.style,w=tableNode.offsetWidth+CTN_PADDING+TTP_BORDER,h=tableNode.offsetHeight+CTN_PADDING+TTP_BORDER,ctnX2=loc.x+loc.w,ctnY2=loc.y+loc.h,x=pos.x,y=pos.y,ox=x+RIGHT_PADDING,oy=y+BOTTOM_PADDING,paddingLeft;if(w>loc.w*0.8){w=loc.w*0.8;}paddingLeft=w<MIN_WIDTH?(MIN_WIDTH-w)/2:0;ctnNodeStyle.paddingLeft=paddingLeft+PX;if(w<MIN_WIDTH){w=MIN_WIDTH;}ctnNodeStyle.width=w-CTN_PADDING-TTP_BORDER-paddingLeft+PX;if(h>loc.h*0.8){h=loc.h*0.8;}ctnNodeStyle.height=h-CTN_PADDING-TTP_BORDER+PX;w+=EDGE_PADDING;h+=EDGE_PADDING;if(ox+w<=ctnX2&&oy+h>ctnY2){oy=ctnY2-h;}else{if(ox+w>ctnX2&&oy+h<=ctnY2){ox=ctnX2-w;}else{if(ox+w>ctnX2&&oy+h>ctnY2){ox=ctnX2-w;if(y>=h+EDGE_PADDING){oy=y-h-EDGE_PADDING;}else{if(y>ctnY2-y){oy=EDGE_PADDING;ctnNodeStyle.height=y-2*EDGE_PADDING-CTN_PADDING-TTP_BORDER+PX;}else{ctnNodeStyle.height=ctnY2-y-BOTTOM_PADDING-EDGE_PADDING-CTN_PADDING-TTP_BORDER+PX;}}}}}domNodeStyle.left=ox+PX;domNodeStyle.top=oy+PX;this.updateScrollbars();if(ctnNodeStyle.overflowY==="scroll"||ctnNodeStyle.overflowX==="scroll"){if(!keepScroll){ctnNode.scrollLeft=0;ctnNode.scrollTop=0;}}},onmouseover:function onmouseover(){this.clearTooltipHandler();},onmouseout:function onmouseout(){this.hide(true);},hide:function hide(delay){var me=this;if(this.isVisible()){if(delay){if(!this.hideTooltipHandler){this.hideTooltipHandler=setTimeout(function(){me.toggle(false);},TimeDelay4Hide);}}else{this.clearTooltipHandler();this.toggle(false);}}},detachListeners:function detachListeners(){$ARR.forEach(DOM_EVENTS,function(event){var listener=this.domEventListeners[event];if(listener){$DOM.detachEvent(this.domNode,event,listener);}},this);this.domEventListeners={};},destroy:function dst(){this.detachListeners();this.clearTooltipHandler();this._super();}});}());