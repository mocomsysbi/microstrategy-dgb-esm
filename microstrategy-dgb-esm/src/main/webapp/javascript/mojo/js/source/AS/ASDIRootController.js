(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.string","mstrmojo.DI.DIRootController","mstrmojo.AS.ASQbEsController","mstrmojo.AS.ASQbFFSQLController","mstrmojo.AS.ASGBQController","mstrmojo.DI.DIConstants","mstrmojo.AS.DIAppSchemaRefreshFileEditor","mstrmojo.AS.ASGBQFFSQLController");mstrmojo.requiresDescs(12779);var $HASH=mstrmojo.hash,constants=mstrmojo.DI.DIConstants,$ARR=mstrmojo.array,$S=mstrmojo.string,MAX_FILE_SIZE=4*1024*1024,sourceType={url:"fileUrl",localFile:"fileLocal",googleDrive:"googleDrive",salesForce:"salesforce",dropBox:"dropbox"},sourceTitle={url:"Data from URL",localFile:"File from Disk"},URL_UPLOAD=0;function importWorkspace(params){window.mstrAppSchema&&window.mstrAppSchema.callbacks.fetchTablesCallback(params);}function parseName(url){var temp=url.trim().split("/");var name=temp[temp.length-1];return name;}function parseJsonFileWithMultiSheets(sheets,uploadingId,fileName){$ARR.forEach(sheets,function(sheet,index,self){var isEqual=(uploadingId===sheet.n);sheet.n=(sheet.n&&sheet.n.replace?sheet.n.replace(isEqual?uploadingId:uploadingId+"_",isEqual?fileName:""):sheet.n);sheet.title=(sheet.title&&sheet.title.replace?sheet.title.replace(isEqual?uploadingId:uploadingId+"_",isEqual?fileName:""):sheet.title);});}function deliverToWorkspace(datasourceArr,files,pageType,oAuthInfo){var result;switch(pageType){case constants.pageType.file:result=dataHandlerForWorkspaceImport(datasourceArr,files);break;case constants.pageType.sourceObjectsDnD:result=sourceObjectsDnDHandle(datasourceArr,files,oAuthInfo);break;}importWorkspace(result);mstrApp.getRootController().exitApplication();}function getSheetsInfo(datasourceArr,oAuthInfo){var workspaceId=window.mstrAppSchema.workspaceManager.initialWorkspaceId,clientId=window.mstrAppSchema.workspaceManager.currentClientId,controller=mstrApp.getRootController(),me=this,formData={clientId:clientId,requestId:"",workspaceId:workspaceId,datasource:{}},items=[],singleItems=[],singleItemIndex=[],counter=0,callback={success:function(res){var sheetsInfo,sheets=[];res=res.body;if(!res.sheetsInfo){controller.displayError(mstrmojo.desc(12779,"Encounter error when set data import info!"),false,res&&res.message);return ;}sheetsInfo=res.sheetsInfo;$ARR.forEach(sheetsInfo.sheetsNames,function(name,index,self){!sheetsInfo.isEmptySheets[index]&&sheets.push({idx:index,n:name,title:name,selected:index===0});});if(datasourceArr.length===1&&sheets.length===0){mstrmojo.alert("The file sheet is empty");return ;}if(datasourceArr.length===1&&sheets.length===1){var item=[];item.push({sheets:sheets,isSingleSheet:true});deliverToWorkspace(datasourceArr,item,me.pageType,oAuthInfo);return ;}if(sheets.length===1){singleItems.push({sheets:sheets,isSingleSheet:true});singleItemIndex.push(counter);}else{if(/\.json$/i.test(datasourceArr[counter].name)){parseJsonFileWithMultiSheets(sheets,datasourceArr[counter].url,datasourceArr[counter].name);}items.push({defaultSheetsIndex:0,multiSelection:true,n:datasourceArr[counter].name||datasourceArr[counter].url,sheets:sheets,id:datasourceArr[counter].url});}counter++;if(counter===datasourceArr.length){if(singleItems.length===datasourceArr.length){deliverToWorkspace(datasourceArr,singleItems,me.pageType,oAuthInfo);}else{var cfg={items:items,onOK:function(){var selectItem=this.items.slice(0);if(singleItems.length>0){$ARR.forEach(singleItems,function(obj,index,self){selectItem.splice(singleItemIndex[index],0,obj);});}deliverToWorkspace(datasourceArr,selectItem,me.pageType,oAuthInfo);},onBack:function(){this.unrender();}};controller.showDialog(constants.dialogType.sheetsSelectionDialog,cfg);}}}},requestParam;controller.dataService=new mstrmojo.DI.DIDataService();$ARR.forEach(datasourceArr,function(obj,index,self){$HASH.copy(obj,formData.datasource);requestParam={path:"/workspaces/"+workspaceId+"/file-sheets-info",form:JSON.stringify(formData),method:"POST"};controller.dataService.archSpark(callback,requestParam);});}function fileDataHandler(tableName,uploadingId){var result={},id=-1;result[id]={id:id,name:tableName,type:constants.dbType.URL,tables:[{name:tableName,dbr:id,url:uploadingId,type:"fileLocal"}]};return result;}function dataHandlerForWorkspaceImport(datasourceArr,files){var result={};table=[],params={};$ARR.forEach(datasourceArr,function(obj,i,self){var url=obj.url,dbr=obj.dbRoleId,name=parseName(url),selectInfo=files[i].sheets;$ARR.forEach(selectInfo,function(sel,j,arr){var isSingleSheet=!!files[i].isSingleSheet;if(sel.selected||isSingleSheet){table.push({dbr:dbr,fileName:obj.name,name:isSingleSheet?(obj.name||name):(sel.n+" - "+(obj.name||name)),ns:url,url:url,type:obj.type,sheetIndex:sel.idx});}});});params.tables=table;params.id=datasourceArr[0].type===sourceType.url?constants.dbType.URL:constants.dbType.LOACLFILE;params.name=datasourceArr[0].type===sourceType.url?sourceTitle.url:sourceTitle.localFile;params.type=params.id;var index=Math.random();result[index]=params;return result;}function googleDataHandle(importOAuthParams,item,dbRoleName){var result={},param={},table=[];param.id=importOAuthParams.dbRoleID;param.name=dbRoleName;param.type=constants.dbType.GOOGLE_ANALYTICS;for(var i=0;i<item.length;i++){table[i]={dbr:importOAuthParams.dbRoleID,dbtn:item[i].n,n:item[i].n,name:item[i].n,url:item[i].query,account_id:importOAuthParams.sourceAccountID,_renderIdx:0};}param.tables=table;result[importOAuthParams.dbRoleID]=param;return result;}function sourceObjectsDnDHandle(datasourceArr,files,oAuthInfo){var result={};table=new Array(),params={};$ARR.forEach(datasourceArr,function(obj,i,self){var url=obj.url,dbr=obj.dbRoleId,name=parseName(url),selectInfo=files[i].sheets;$ARR.forEach(selectInfo,function(sel,j,arr){var isSingleSheet=!!files[i].isSingleSheet;if(sel.selected){table.push({dbr:dbr,name:isSingleSheet?name:sel.n+" - "+name,type:obj.type,url:url,sheetIndex:sel.idx,account_id:oAuthInfo.said,});}});});params.id=oAuthInfo.dbRoleID;params.tables=table;params.name=oAuthInfo.name;if(oAuthInfo.type===constants.sourceType.googleDrive){params.type=constants.dbType.GOOGLE_DRIVE;}else{if(oAuthInfo.type===constants.sourceType.salesforce){params.type=constants.dbType.SALESFORCE;}else{if(oAuthInfo.type===constants.sourceType.dropbox){params.type=constants.dbType.DROPBOX;}else{mstrmojo.alert("The source type match failed.");return ;}}}var index=Math.random();result[index]=params;return result;}function _uploadFileChunk(dndBox,start,res,taskCfg,progressCfg,callback){var func=arguments.callee,files=dndBox.files,file=files[0];if(!file){mstrApp.hideProgress(true);dndBox.set("files",dndBox.shiftedFiles);delete dndBox.shiftedFiles;callback.complete();return ;}if(start===undefined&&res===null){mstrApp.upload({success:function(res){func(dndBox,0,res,taskCfg,progressCfg,callback);},failure:function(res){mstrApp.hideProgress(true);}},$HASH.copy(taskCfg,{index:-1}),null,progressCfg);}else{var end=Math.min(file.size,start+MAX_FILE_SIZE),blob=file.slice(start,end),progressCfg=$HASH.copy({async:true},progressCfg);mstrApp.upload({success:function(res){if(start+MAX_FILE_SIZE<file.size){start+=MAX_FILE_SIZE;func(dndBox,start,res,taskCfg,progressCfg,callback);}else{var shiftedFile=files.shift();dndBox.shiftedFiles instanceof Array?dndBox.shiftedFiles.push(shiftedFile):(dndBox.shiftedFiles=[shiftedFile]);callback.success(shiftedFile.name,res.uploadingId);func(dndBox,undefined,null,taskCfg,progressCfg,callback);}},failure:function(res){mstrApp.hideProgress(true);}},$HASH.copy(taskCfg,{index:res.index+1,uploadingId:res.uploadingId,fileName:file.name,fileFieldName:"file"}),blob,progressCfg);}}function _localFileUploadLimitCheck(dndBox,callback){var detailMsg="<ul>",allFileExceedSize=true,showDetailedError=false,controller=mstrApp.getRootController();$ARR.forEach(dndBox.files,function(file,index,arr){var fileName="C:\\fakepath\\"+file.name,failedFiles=[],fSize,extension=fileName.substring(fileName.lastIndexOf(".")+1);if(file!==undefined){fSize=file.size;}if(fSize>(mstrApp.diParams.UploadSizeLimit*1024*1024)){showDetailedError=true;failedFiles.push(file.name);var currErrorMsg=mstrmojo.desc(12738,"The maximum file size for #### files is @@@@ MB. ").replace("####",extension).replace("@@@@",mstrApp.diParams.UploadSizeLimit);detailMsg+="<li>"+encodeURIComponent(file.name)+"<br>"+currErrorMsg||" </li>";file.toDel=true;}else{allFileExceedSize=false;}if(extension==="mstr"){controller.displayError(mstrmojo.desc(14194,"Error: Only Excel Text, CSV can be uploaded. Please use the Upload MicroStrategy File to import .MSTR files."),false);return ;}});if(showDetailedError){detailMsg+="</ul>";if(allFileExceedSize){controller.displayError(mstrmojo.desc(12900,"Error importing following files. Please check the files or delete them."),false,detailMsg);}else{var okHandler=function(){for(i=0;i<dndBox.files.length;i++){var file=dndBox.files[i];if(file.toDel){$ARR.removeItem(dndBox.files,file);}}callback();};var config={detailErrorMessage:detailMsg,okBtnText:mstrmojo.desc(219,"Yes"),cancelBtnText:mstrmojo.desc(218,"No"),onCancel:function(){}};controller.displayWarning(mstrmojo.desc(13324,"Error importing the following files. Click 'Yes' to ignore the erroneous files and proceed with the successful files. Otherwise, click 'No' to check the erroneous files or delete them."),mstrmojo.desc(12537,"Data Import"),okHandler,config);}}else{callback();}}mstrmojo.AS.ASDIRootController=mstrmojo.declare(mstrmojo.DI.DIRootController,null,{scriptClass:"mstrmojo.AS.ASDIRootController",showPage:function showPage(pageType,sourceInfo,slot,footerConfig){return this._super(pageType,sourceInfo,slot,{finish:{visible:true},next:{visibile:false},cancel:{visible:true},save:{visible:false},back:{visible:true},cubeQuota:{visible:false}});},getQueryBuilderParams:function getQueryBuilderParams(xdaType,extParams){var controllerCls="";if(xdaType===constants.xdaType.googleBigQuerySingleTable){controllerCls="mstrmojo.AS.ASGBQController";}else{if(xdaType===constants.xdaType.ffsql){controllerCls="mstrmojo.AS.ASQbFFSQLController";}else{if(xdaType===constants.xdaType.googleBigQueryFFSQL){controllerCls="mstrmojo.AS.ASGBQFFSQLController";}else{controllerCls="mstrmojo.AS.ASQbEsController";}}}return this._super(xdaType,$HASH.copy({rootControllerCls:controllerCls,pageName:mstrConfig.pageName,servletState:mstrConfig.servletState},extParams||{}));},doLocalFileImport:function(fn){var dndBox=this.rootView.currentPage.dnDBox,taskCfg={taskId:"arch.sparkFileUpload",taskContentType:"json",taskEnv:"xhr",fileType:"application/octet-stream",workspaceId:window.mstrAppSchema.workspaceManager.initialWorkspaceId},progressCfg={showProgress:true,showProgressText:true,progressText:mstrmojo.desc(12963,"Uploading File...")};dndBox.fileMap=[];if(progressCfg.showProgress){mstrApp.showProgress(progressCfg);}_localFileUploadLimitCheck(dndBox,function(){_uploadFileChunk(dndBox,undefined,null,taskCfg,progressCfg,{complete:function(){typeof fn==="function"&&fn(dndBox.fileMap);},success:function(tableName,uploadingId){var result=fileDataHandler(tableName,uploadingId);dndBox.fileMap.push(result);}});});},onFinishButtonClick:function onFinishButtonClick(){var controller=mstrApp.getRootController();controller.dataService=new mstrmojo.DI.DIDataService();var me=this.rootView.currentPage;switch(me.pageType){case constants.pageType.file:var datasourceArr=[];if(me.sourceSubtype===constants.sourceSubtype.url){var urlList,dbrList,anonymousDBrole;if(me.mode===URL_UPLOAD){urlList=me.urlList.urls.slice(0);dbrList=me.urlList.dbrs.slice(0);if(me.urlInput.value&&me.urlInput.value.length>0){urlList.push(me.urlInput.value);dbrList.push(me.dbroles.getSelectedDBRole());}}else{urlList=me.urlBrowse.getDropZone().urls.slice(0);anonymousDBrole=me.dbroles.getSelectedDBRole();}$ARR.forEach(urlList,function(url,index,self){datasourceArr.push({dbRoleId:me.mode===URL_UPLOAD?dbrList[index].did:anonymousDBrole.did,url:url.trim(),type:sourceType.url});});getSheetsInfo.call(me,datasourceArr);}else{if(me.sourceSubtype===constants.sourceSubtype.localFile){this.doLocalFileImport(function(fileMap){$ARR.forEach(fileMap,function(obj,i,self){obj=obj["-1"];datasourceArr.push({dbRoleId:obj.id,url:obj.tables[0].url,name:$S.htmlAngles(obj.tables[0].name),type:sourceType.localFile});});getSheetsInfo.call(me,datasourceArr);});}}break;case constants.pageType.sourceObjects:var controller=mstrApp.getRootController();var model=controller.getModel();var oAuthSource=model.externalSources[constants.sourceType.googleAnalytics];var importOAuthParams=oAuthSource.getSourceInfoParam(true);var items=me.asDataPrepare();var dbRoleName=me.sourceObjectsInfo.name;var result=googleDataHandle(importOAuthParams,items,dbRoleName);importWorkspace(result);mstrApp.getRootController().exitApplication();break;case constants.pageType.sourceObjectsDnD:var controller=mstrApp.getRootController();var model=controller.getModel();var oAuthInfo=me.sourceObjectsInfo;var items=me.asDataPrepare();var datasourceArr=[];var soucetype="";switch(oAuthInfo.type){case constants.sourceType.googleDrive:type=sourceType.googleDrive;break;case constants.sourceType.salesforce:type=sourceType.salesForce;break;case constants.sourceType.dropbox:type=sourceType.dropBox;break;default:mstrmojo.alert("The source type match failed.");return ;}$ARR.forEach(items,function(items,index){datasourceArr.push({dbRoleId:oAuthInfo.dbRoleID,url:items.query,type:soucetype,accountId:oAuthInfo.said});});getSheetsInfo.call(me,datasourceArr,oAuthInfo);break;default:this.rootView.currentPage.onFinishButtonClick();break;}}});})();