(function(){mstrmojo.requiresCls("mstrmojo.Box","mstrmojo.num","mstrmojo.dom","mstrmojo.string","mstrmojo.expr","mstrmojo.ui.Pulldown","mstrmojo.MetricSelectorUtility","mstrmojo.hash");var $M=mstrmojo.MetricSelectorUtility,$P=mstrmojo.vi.ui.rw.selectors.EnumWarningPosition,$OP=$M.OP,$NC=$M.EnumNumberCategory,$NM=mstrmojo.num,$D=mstrmojo.dom,$S=mstrmojo.string,$E=mstrmojo.expr,$DTP=$E.DTP,$HASH=mstrmojo.hash,$ERRORCODE=$M.ErrorCode,$QUAL={FILTERBYVALUE:0,HIGHEST:1,LOWEST:2,HIGHESTPERCENT:3,LOWESTPERCENT:4},valueOperators=$M.OP_NAMES.slice(0),rankOperators=$M.RANK_OP_NAMES.slice(0),notNull=function(){var check=function(v){return v===undefined||v===null;},i;for(i=0;i<arguments.length;i++){if(check(arguments[i])){return false;}}return true;},isValue=function(qualifyOn){return qualifyOn===$M.Q._G;},isPercent=function(qualifyOn){return qualifyOn===$M.Q._PT||qualifyOn===$M.Q._PB;},hasLeftTextBox=function(qua,opId){return !(isValue(qua)&&(opId===$OP._IS_NULL||opId===$OP._IS_NOT_NULL));},hasRightTextBox=function(qua,opId){return isValue(qua)&&(opId===$OP._BETWEEN||opId===$OP._NOT_BETWEEN);},isTextBoxEmpty=function(textBox){return !textBox.visible||$S.isEmpty(textBox.value);},getDtp=function(category,qualifyOn){return((category===$NC.Date||category===$NC.Time)&&qualifyOn===$M.Q._G)?$DTP.DATE:$DTP.REAL;},toPercent=function(isPercent,value){return value+((isPercent&&!$S.isEmpty(value)&&!String(value).match(/^\d+%$/))?"%":"");},toParamObject=function(dtp,value,isPercentType){if($NM.isBigDecimal(value)){return{dtp:$DTP.BIGDECIMAL,v:value};}else{return{dtp:dtp,v:toPercent(isPercentType,value)};}},formatBigDecimalConstant=function(constant){if(!constant){return constant;}if(constant.dtp===$DTP.BIGDECIMAL){var v=String(constant.v);if(v&&v.indexOf("#")===-1){return"#"+v+"#";}else{return v;}}else{return constant.v;}},getDefaultOpId=function(qua){return isValue(qua)?$OP._GREATER_EQUAL:$OP._LESS_EQUAL;},getCurrentSelectionParam=function(category,qualifyOn,op,leftValue,rightValue){var cs=[],dtp=getDtp(category,qualifyOn),isPercentType=isPercent(qualifyOn);if(op===$OP._IN||op===$OP._NOT_IN){var _cs=String(leftValue).split(";"),i;for(i=0;i<_cs.length;i++){if(!mstrmojo.string.isEmpty(_cs[i])){cs.push(toParamObject(dtp,_cs[i],isPercentType));}}}else{if(leftValue!==null){cs.push(toParamObject(dtp,leftValue,isPercentType));}if(rightValue!==null){cs.push(toParamObject(dtp,rightValue,isPercentType));}}return cs;},hideWarningIfShown=function(evt){this.parent.submit(this,true);},submitText=function(evt){var widget=this.parent;if(widget.valueChanged||this.value===""){widget.submit(this);}},visibleChange=function(){this.set("value","");},valueChange=function(){var widget=this.parent;widget.docSelector.hideWarning();widget.valueChanged=true;};mstrmojo.vi.ui.rw.selectors.MetricQualification=mstrmojo.declare(mstrmojo.Box,[mstrmojo._HasLayout,mstrmojo._HasPopup],{scriptClass:"mstrmojo.vi.ui.rw.selectors.MetricQualification",markupString:'<div id="{@id}" class="mstrmojo-vi-metric-qual {@cssClass}" style="{@cssText}"><div class="pulldown"></div><div class="v1"></div><div class="v2"></div></div>',markupSlots:{containerNode:function(){return this.domNode.firstChild;},leftTextNode:function(){return this.domNode.childNodes[1];},rightTextNode:function(){return this.domNode.childNodes[2];}},children:[{scriptClass:"mstrmojo.ui.Pulldown",alias:"func",isHostedWithin:false,items:valueOperators,isSilentSelected:false,onitemSelected:function(){var widget=this.parent,qua=widget.qua,opId=widget.opId,leftText=widget.leftText,rightText=widget.rightText,value=widget.func.getSelectedItem().v,oldOpId=opId;if(this.isSilentSelected){return ;}opId=widget.opId=isValue(qua)?value:$OP._LESS_EQUAL;if(oldOpId!==opId){widget.opChanged=true;}leftText.set("visible",hasLeftTextBox(qua,opId));rightText.set("visible",hasRightTextBox(qua,opId));if(leftText.hasRendered&&leftText.visible){widget.valueChanged=false;}if(isValue(qua)){this.parent.submit();}else{widget.set("qua",value);}}},{scriptClass:"mstrmojo.TextBox",alias:"leftText",slot:"leftTextNode",onEnter:submitText,onblur:hideWarningIfShown,onfocus:submitText,onvisibleChange:visibleChange,onvalueChange:valueChange},{scriptClass:"mstrmojo.TextBox",alias:"rightText",slot:"rightTextNode",onEnter:submitText,onblur:hideWarningIfShown,onfocus:submitText,onvisibleChange:visibleChange,onvalueChange:valueChange}],init:function init(props){this._super(props);this.func.set("useDarkTheme",!this.docSelector.isInFilterPanel()&&mstrApp.getRootController().isDarkThemeSelected());},parseModel:function parseModel(){var qua=this.qua,cs=this.cs,da=this.da,f=this.f,ft=this.ft,isValueQua=isValue(qua),items=isValueQua?valueOperators:rankOperators,opId=notNull(f,ft)?$M.getOpIdxByfunc(f,ft):getDefaultOpId(qua),cs1,i;this.opId=opId;if(da){var lowValue,highValue;switch(qua){case $M.Q._G:lowValue=Number(da.low).toFixed(0);highValue=Number(da.high).toFixed(0);break;case $M.Q._RB:case $M.Q._RT:lowValue=1;highValue=da.cnt;break;case $M.Q._PB:case $M.Q._PT:lowValue=0;highValue=100;break;}this.set("low",lowValue);this.set("high",highValue);}cs1=(cs&&cs.length>0)?$NM.toLocaleString(formatBigDecimalConstant(cs[0])):"";if(opId===$OP._IN||opId===$OP._NOT_IN){for(i=1;i<cs.length;i++){cs1+=";"+$NM.toLocaleString(String(formatBigDecimalConstant(cs[i])));}}else{this.set("cs2",(cs&&cs.length>1)?$NM.toLocaleString(formatBigDecimalConstant(cs[1])):"");}if(cs&&cs.length>0&&isPercent(qua)&&!cs1.match("%")){cs1=$NM.toLocaleString(Math.round(cs[0].v*10000)/100);}this.set("cs1",cs1);var leftText=this.leftText,rightText=this.rightText,func=this.func;leftText.set("visible",hasLeftTextBox(qua,opId));leftText.set("value",this.cs1);rightText.set("visible",hasRightTextBox(qua,opId));rightText.set("value",this.cs2);func.set("items",items);func.isSilentSelected=true;func.selectItemByField("v",isValueQua?opId:qua);func.isSilentSelected=false;this.valueChanged=false;},onquaChange:function onquaChange(evt){var oldQua=evt.valueWas,newQua=evt.value,oldFt=$M.getFuncInfo(this.opId,oldQua).ft,newFt=$M.getFuncInfo(this.opId,newQua).ft,textVal,percentVal,count;this.opId=getDefaultOpId(newQua);this.changeQual=true;if(oldQua===$QUAL.FILTERBYVALUE||newQua===$QUAL.FILTERBYVALUE){var newFuncInfo=$M.getFuncInfo(this.opId,newQua);this.f=newFuncInfo.f;this.ft=newFuncInfo.ft;this.cs=[];this.qualifyOnChanged=true;this.parseModel();this.submit();return ;}if(newFt!==oldFt){var fInfo=$M.getFuncInfo(this.opId,newQua);if(this.cs&&this.cs.length!==0&&!this.da.nov){textVal=this.cs[0].v;count=this.da.cnt;if(newQua===$QUAL.HIGHEST||newQua===$QUAL.LOWEST){if(typeof textVal==="string"){textVal=$NM.toString(textVal,true).replace("%","")/100;}this.cs=[{v:Math.floor(textVal*count)}];}else{percentVal=Math.ceil((textVal/count)*10000)/10000;this.cs=[{v:percentVal>1?1:percentVal}];}}else{this.cs=[];}this.f=fInfo.f;this.ft=fInfo.ft;this.parseModel();}if(this.cs&&this.cs.length!==0){this.submit();}},validateValues:function validateValues(submitTextBox){var leftTextBox=this.leftText,rightTextBox=this.rightText,qua=this.qua,opId=this.opId,validation;if(opId===$OP._IS_NULL||opId===$OP._IS_NOT_NULL){this.docSelector.hideWarning();return null;}if(opId===$OP._IN||opId===$OP._NOT_IN){var _cs=String(leftTextBox.value).split(";"),i;for(i=0;i<_cs.length;i++){validation=$M.doValidation(_cs[i],this,{refNode:leftTextBox.inputNode,position:$P.TOP,closeOnClick:false},true);if(validation.invalid){if(validation.errorCode===$ERRORCODE.EmptyValue){validation.clearValue=true;}return validation;}}}else{submitTextBox=submitTextBox||leftTextBox;validation=$M.doValidation(submitTextBox.value,this,{refNode:submitTextBox.inputNode,position:$P.TOP,closeOnClick:false},true);var anotherValidation,clearValue;if(hasRightTextBox(qua,opId)){var anotherBox=(submitTextBox===leftTextBox)?rightTextBox:leftTextBox;anotherValidation=$M.doValidation(anotherBox.value,this,{refNode:anotherBox.inputNode,position:$P.TOP,closeOnClick:false},true);}if(validation.errorCode===$ERRORCODE.EmptyValue&&(!anotherValidation||anotherValidation.errorCode===$ERRORCODE.EmptyValue)){clearValue=true;}if(!validation.invalid&&!!anotherValidation){validation=anotherValidation;}if(clearValue){validation.clearValue=clearValue;}return validation.invalid?validation:null;}return null;},submit:function submit(textBox,hideWarningIfShown){var oldError=this.validation&&this.validation.errorCode,errValidation=this.validateValues(textBox),warningBox=textBox?textBox.parent.parent.warning:null,isWarningVisible=warningBox?warningBox.visible:null,hasValueChanged=this.valueChanged||this.value==="",isForceUnset=!!(hasValueChanged&&errValidation&&errValidation.clearValue),toggleWarning=function(){if(isWarningVisible&&hideWarningIfShown&&errValidation.errorCode===oldError){this.set("validation",null);}else{this.set("validation",errValidation);$D.setInputSelection(errValidation.refNode);}};if(!errValidation||!errValidation.invalid||isForceUnset){if(hasValueChanged||this.changeQual||!!this.opChanged){var qua=this.qua,opId=this.opId,cs1=this.cs1=hasLeftTextBox(qua,opId)?this.leftText.value:null,cs2=this.cs2=hasRightTextBox(qua,opId)?this.rightText.value:null;this.cs=getCurrentSelectionParam(this.numFmts.cat,qua,opId,cs1,cs2);this.parent.node.data.cs=this.cs;this.changeQual=true;this.forceUnset=isForceUnset;this.onchange();this.valueChanged=false;this.opChanged=false;this.changeQual=false;if(textBox){textBox.blur();}}}else{if(textBox){toggleWarning.call(this);}}if(isForceUnset||this.qualifyOnChanged){toggleWarning.call(this);this.qualifyOnChanged=false;}return !errValidation;},updateData:function updateData(da,props){this.da=da;this.updateExpr(props);},updateExpr:function updateExpr(props){if(props){this.cs=props.cs;this.f=props.f;this.ft=props.ft;this.qua=props.qua;}this.parseModel();},doLayout:function doLayout(){this.layoutConfig=this.layoutConfig?$HASH.copy({xt:true},this.layoutConfig):{xt:true};if(this.parent.isInFilterPanel()){this.layoutConfig.w={containerNode:"65%",leftTextNode:"30%",rightTextNode:"30%"};}this._super();}});}());