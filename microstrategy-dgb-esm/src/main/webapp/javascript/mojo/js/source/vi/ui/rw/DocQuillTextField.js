(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo._HasEditableText","mstrmojo._Formattable","mstrmojo.UUID","mstrmojo.Editor","mstrmojo.vi.ui.TextBoxURLEditor","mstrmojo.css","mstrmojo.models.FormatModel","mstrmojo.hash");var HASH=mstrmojo.hash,$CSS=mstrmojo.css,BASE64_SEP="\u01EF",SEPARATOR="\u00df",USER="user",MAX_IMAGE_SIZE="800000",MAX_IMAGE_MB="8",URL_PLACEHOLDER="https://www.microstrategy.com",$ARR=mstrmojo.array,ENTER="13",FORMAT_ENUMS=mstrmojo.models.FormatModel.ENUM_PROPERTY_NAMES,CSS_LOADED=false;mstrmojo.vi.ui.rw.DocQuillTextField=mstrmojo.declare(mstrmojo.Container,[mstrmojo._Formattable],{scriptClass:"mstrmojo.vi.ui.rw.DocQuillTextField",markupString:'<div id="{@id}" class="mstrmojo-DocQuillTextField {@cssClass}" style="{@domNodeCssText}" mstrAttach:click,blur ></div>',hasActiveLink:mstrmojo.emptyFn,stringToSend:"",currentRawDeltaopsArr:null,isQuillselected:false,cachedDelta:null,cacheGProps:null,dirCachDel:null,savedCurPos:null,isQuill:true,hlText:null,hasFocus:false,arrFonts:["arialblack","arialnarrow","arialunicodems","batang","bookantiqua","bookmanoldstyle","bookshelfsymbolone","bookshelfsymboltwo","bookshelfsymbolthree","comicsansms","couriernew","garamond","haettenschweiler","helvetica","impact","lucidaconsole","lucidasansunicode","mapsymbols","marlett","monotypecorsiva","monotypesorts","msgothic","msoutlook","mssansserif","mtextra","symbol","tahoma","timesnewroman","trebuchetms","verdana","webdings","windings","windings2","windings3"],stringsOfFonts:["Arial Black","Arial Narrow","Arial Unicode MS","Batang","Book Antiqua","Bookman Old Style","Bookshelf Symbol 1","Bookshelf Symbol 2","Bookshelf Symbol 3","Comic Sans MS","Courier New","Garamond","Haettenschweiler","Helvetica","Impact","Lucida Console","Lucida Sans Unicode","Map Symbols","Marlett","Monotype Corsiva","Monotype Sorts","MS Gothic","MS Outlook","Microsoft Sans Serif","MT Extra","Symbol","Tahoma","Times New Roman","Trebuchet MS","Verdana","Webdings","Windings","Windings 2","Windings 3"],arrFontSizes:["size8","size9","size10","size11","size12","size14","size16","size18","size20","size22","size24","size36","highlight","nohighlight"],arrFontSzNums:[8,9,10,11,12,14,16,18,20,22,24,36],getRawText:function getRawText(){return this.quillInstance.editor.delta;},init:function init(props){this._super(props);var jsRoot;if(!CSS_LOADED){jsRoot=mstrmojo.getJsRoot();mstrmojo.requiresDepLib(jsRoot+"libraries/quill/quill.js");mstrmojo.insertCSSLinks([jsRoot+"libraries/quill/quill.bubble.css"]);CSS_LOADED=true;}},setUpFontsSizes:function setupFontsSizes(){var Font=Quill["import"]("formats/font"),Sizes=Quill["import"]("formats/size");Font.whitelist=this.arrFonts;Quill.register(Font,true);Sizes.whitelist=this.arrFontSizes;Quill.register(Sizes,true);},postBuildRendering:function postBuildRendering(){if(this._super){this._super();}this.domNode.addEventListener("blur",function(event){},true);var isQuillUndefined=typeof this.quillInstance==="undefined",delta;if(!isQuillUndefined){delta=this.quillInstance.editor.delta;}else{delta=null;}this.setUpFontsSizes();this.quillInstance=new Quill("#"+$CSS.cssEscape(this.id),{modules:{toolbar:[],formula:false,syntax:false},placeholder:"Enter rich text here, and highlight and format to edit...",theme:"bubble"});if(!this.quillInstance.editor){return ;}var quill=this.quillInstance,editor=quill&&quill.editor,root=quill.root,textField=this,textbox=textField.parent,node=this.node,data=node&&node.data,ctrloverlay=textbox.ctrlOverlay;root.tabindex="1";root.onpaste=function(e){e.preventDefault();e.cancelBubble=true;};root.onfocus=function(e){if(mstrApp.isAppStatePresentation()){return ;}e.cancelBubble=true;};root.onblur=function(event){if(mstrApp.isAppStatePresentation()){return ;}event.preventDefault();event.stopPropagation();textField.hlText=quill.getSelection();var hlText=textField.hlText,stringToSend="",opsArr=editor.delta.ops;$ARR.forEach(opsArr,function(item){stringToSend+=item.insert;stringToSend+=SEPARATOR;});var encoded=textField.utf8_to_b64(JSON.stringify(opsArr));stringToSend+=BASE64_SEP+encoded;var encGloProps=textField.utf8_to_b64(textField.domNode.style.background);stringToSend+=BASE64_SEP+encGloProps;var isTextChanged=(textField.node.data.rv&&textField.node.data.rv!==stringToSend);if(textField.node.data.rv===undefined){isTextChanged=true;}if(isTextChanged){textField.dirCachDel=null;}textbox.textEdited(stringToSend,isTextChanged,"");textField.updatedirCachDel();textbox.showControlOverlay();textField.isEditing=false;};quill.on("selection-change",function(range,oldRange,source){var ctrl=textField.controller,viPanel=ctrl&&ctrl.getViPanel("prps");if(viPanel!==null){ctrl.getViPanel("prps").refresh();}});textbox.showControlOverlay();ctrloverlay.domNode.onclick=mstrmojo.emptyFn();var arrInsDelta,dirCachDel=this.dirCachDel,cachedGP=this.cacheGProps,arr,vDelta,rvDelta,delShow,vTextArr;ctrloverlay.domNode.ondblclick=function(){if(!mstrApp.isAppStatePresentation()){textbox.hideControlOverlay();textField.isEditing=true;if(data&&data.rv){if(dirCachDel&&!$ARR.isArray(dirCachDel.ops)){quill.setContents(dirCachDel);}else{arrInsDelta=(data.rv).split(BASE64_SEP);var rvDelOps=textField.b64_to_utf8(arrInsDelta[1]),del=JSON.parse(rvDelOps);if($ARR.isArray(del)){quill.setContents(del);textField.cachedDelta=del;textField.cacheGProps=textField.b64_to_utf8(arrInsDelta[2]);textField.domNode.style.background=cachedGP;}}}}};if(mstrApp.isAppStatePresentation()){if(data.v){arr=(data.v).split(BASE64_SEP);vDelta=this.b64_to_utf8(arr[1]);delShow=JSON.parse(vDelta);vTextArr=arr[0].split(SEPARATOR);delShow=this.resolveDelta(delShow,vTextArr);if(delShow){quill.setContents(delShow);}this.cacheGProps=this.b64_to_utf8(arr[2]);this.domNode.style.background=this.cacheGProps;root.style["user-select"]="none! important";}textbox.showControlOverlay();if(textbox.ctrlOverlay.domNode.style.visibility!=="visible"){textbox.ctrlOverlay.domNode.style.visibility="visible";}}else{if(delta!==null&&!data.rv){quill.setContents(quill.editor.delta);}else{if(data.v){arr=(data.v).split(BASE64_SEP);vDelta=this.b64_to_utf8(arr[1]);delShow=JSON.parse(vDelta);vTextArr=arr[0].split(SEPARATOR);delShow=this.resolveDelta(delShow,vTextArr);if(delShow){quill.setContents(delShow);}this.cacheGProps=this.b64_to_utf8(arr[2]);this.domNode.style.background=this.cacheGProps;}else{if(this.isQuillselected&&this.dirCachDel){textbox.hideControlOverlay();textField.isEditing=true;quill.setContents(this.dirCachDel);var cgp=this.cacheGProps,sCursorPos=this.savedCurPos;if(cgp){this.domNode.style.background=cgp;}if(sCursorPos&&sCursorPos>=0){this.isEditing=true;}}else{if(delta&&data&&data.rv&&this.isQuillselected){arrInsDelta=(data.rv).split(BASE64_SEP);rvDelta=this.b64_to_utf8(arrInsDelta[1]);quill.setContents(JSON.parse(rvDelta));this.cachedDelta=JSON.parse(rvDelta);this.cacheGProps=this.b64_to_utf8(arrInsDelta[2]);this.domNode.style.background=this.cacheGProps;}}}}}},onTextEditComplete:function onTextEditComplete(textChanged,oldText){var textBox=this.parent,text=this.text;if(textChanged){textBox.textEdited(text,textChanged,oldText);this.updateScrollbars();}if(!text){textBox.updateOverlay();}},setDelta:function setDelta(delta){var quill=this.quillInstance;if(quill!==null){quill.setContents(delta);}},unrender:function unrender(ignoreDom){if(this._super){this._super();}},onisEditingChange:function onisEditingChange(evt){if(this._super){this._super(evt);}this.parent.set("useRichTooltip",!evt.value);},updatedirCachDel:function updatedirCachDel(){var quill=this.quillInstance,editor=quill&&quill.editor;if(!editor||!editor.delta){return ;}this.dirCachDel=editor.delta;},clickOrUnclick:function clickOrUnclick(isSelected){var textBox=this.parent;textBox.showControlOverlay();this.isEditing=false;if(this.quillInstance&&isSelected){this.onSelected();}else{this.onUnselected();}},onSelected:function onSelected(){var quill=this.quillInstance,editor=quill&&quill.editor,node=this.node,textBox=this.parent,data=node&&node.data;this.isEditing=false;if(quill){this.isQuillselected=true;if(data){if(data.v){var arrInsDelta=(data.v).split(BASE64_SEP),vDelta=this.b64_to_utf8(arrInsDelta[1]),delShow=JSON.parse(vDelta),resTextArr=arrInsDelta[0].split(SEPARATOR);delShow=this.resolveDelta(delShow,resTextArr);if(delShow){quill.setContents(delShow);}this.cachedDelta=editor.delta;this.cachedDelta.ops=JSON.parse(vDelta);}else{if(data.rv){var bigArr=(data.rv).split(BASE64_SEP),decoded=this.b64_to_utf8(bigArr[1]),delta=editor.delta;delta.ops=JSON.parse(decoded);quill.setContents(delta);this.cachedDelta=editor.delta;this.cachedDelta.ops=JSON.parse(decoded);var decodedGlobalProperties=this.b64_to_utf8(bigArr[2]);this.domNode.style.background=decodedGlobalProperties;}}}}},onUnselected:function onUnselected(){var quill=this.quillInstance,editor=quill&&quill.editor,node=this.node,textBox=this.parent,data=node&&node.data;if(textBox.ctrlOverlay&&textBox.ctrlOverlay.visible){return ;}if(quill){this.isQuillselected=false;var stringToSend="",opsArr=this.dirCachDel&&this.dirCachDel.ops;$ARR.forEach(opsArr,function(item){if(!item.insert.image){stringToSend+=item.insert;stringToSend+=SEPARATOR;}else{stringToSend+=JSON.stringify(item.insert);stringToSend+=SEPARATOR;}});this.updatedirCachDel();var encoded=this.utf8_to_b64(JSON.stringify(opsArr));stringToSend+=BASE64_SEP+encoded;var encGloProps=this.utf8_to_b64(this.domNode.style.background);stringToSend+=BASE64_SEP+encGloProps;this.cachedDelta=HASH.clone(editor.delta);if(!data.v){return ;}var bigArr=(data.v).split(BASE64_SEP),decoded=this.b64_to_utf8(bigArr[1]);this.cachedDelta.ops=JSON.parse(decoded);var isTextChanged=(JSON.stringify(editor.delta.ops)!==JSON.stringify(this.cachedDelta.ops))||(encGloProps!==bigArr[2]);textBox.textEdited(stringToSend,isTextChanged,"");if(!isTextChanged){this.refresh();}}},saveWithoutUnselecting:function saveWithoutUnselecting(){var quill=this.quillInstance,editor=quill&&quill.editor,textBox=this.parent;if(quill){this.isQuillselected=true;var selected=quill.getSelection();if(selected){this.savedCurPos=selected.index+selected.length;}var stringToSend="",opsArr=editor.delta.ops;$ARR.forEach(opsArr,function(item){stringToSend+=item.insert;stringToSend+=SEPARATOR;});var encoded=this.utf8_to_b64(JSON.stringify(opsArr));stringToSend+=BASE64_SEP+encoded;var encGloProps=this.utf8_to_b64(this.domNode.style.background);stringToSend+=BASE64_SEP+encGloProps;textBox.textEdited(stringToSend,true,"");this.updatedirCachDel();}},processLocalFormat:function processLocalFormat(formats){var format=formats[0],indexOfFont,quill=this.quillInstance,oldValue=format.oldValue,newValue=format.newValue,hasChanged=oldValue===false&&newValue===true,pName=format.propertyName,position={2:"center",1:"right",6:"justify",0:""},i;if(pName===FORMAT_ENUMS.FONT_WEIGHT){quill.format("bold",hasChanged);}else{if(pName===FORMAT_ENUMS.FONT_STYLE){quill.format("italic",hasChanged);}else{if(pName===FORMAT_ENUMS.UNDERLINE){quill.format("underline",hasChanged);}else{if(pName===FORMAT_ENUMS.LINE_THROUGH){quill.format("strike",hasChanged);}else{if(pName===FORMAT_ENUMS.FONT_SIZE){var size=parseInt(newValue.replace(/[^\d.]/g,"")),arr=this.arrFontSzNums,sizeClasses=this.arrFontSizes;for(i=0;i<arr.length;i++){if(size===arr[i]){quill.format("size",sizeClasses[i]);break;}}}else{if(pName===FORMAT_ENUMS.COLOR){quill.format("color",newValue);}else{if(pName===FORMAT_ENUMS.TEXT_ALIGN){quill.format("align",position[newValue]);}else{if(pName===FORMAT_ENUMS.BACKGROUND_COLOR){this.domNode.style.background=newValue;this.cacheGProps=newValue;}else{if(pName===FORMAT_ENUMS.FONT_FAMILY){var strArr=this.stringsOfFonts;for(i=0;i<strArr.length;i++){if((newValue).indexOf(strArr[i])!==-1){indexOfFont=i;break;}}if(indexOfFont||indexOfFont===0){quill.format("font",this.arrFonts[indexOfFont]);}}}}}}}}}}},formatHlText:function formatHlText(formats){var format=formats[0],indexOfFont,quill=this.quillInstance,oldValue=format.oldValue,newValue=format.newValue,hasChanged=oldValue===false&&newValue===true,pName=format.propertyName,i,hlText=this.hlText,startIdx=hlText.index,len=hlText.length,position={2:"center",1:"right",6:"justify",0:""};this.renderRVText();if(pName===FORMAT_ENUMS.FONT_WEIGHT){quill.formatText(startIdx,len,"bold",hasChanged);}else{if(pName===FORMAT_ENUMS.FONT_STYLE){quill.formatText(startIdx,len,"italic",hasChanged);}else{if(pName===FORMAT_ENUMS.UNDERLINE){quill.formatText(startIdx,len,"underline",hasChanged);}else{if(pName===FORMAT_ENUMS.LINE_THROUGH){quill.formatText(startIdx,len,"strike",hasChanged);}else{if(pName===FORMAT_ENUMS.FONT_SIZE){var size=parseInt(newValue.replace(/[^\d.]/g,"")),arr=this.arrFontSzNums,sizeClasses=this.arrFontSizes;for(i=0;i<arr.length;i++){if(size===arr[i]){quill.formatText(startIdx,len,"size",sizeClasses[i]);break;}}}else{if(pName===FORMAT_ENUMS.COLOR){quill.formatText(startIdx,len,"color",newValue);}else{if(pName===FORMAT_ENUMS.TEXT_ALIGN){quill.formatLine(startIdx,len,"align",position[newValue]);}else{if(pName===FORMAT_ENUMS.BACKGROUND_COLOR){this.domNode.style.background=newValue;this.cacheGProps=newValue;}else{if(pName===FORMAT_ENUMS.FONT_FAMILY){var strArr=this.stringsOfFonts;for(i=0;i<strArr.length;i++){if((newValue).indexOf(strArr[i])!==-1){indexOfFont=i;break;}}if(indexOfFont||indexOfFont===0){quill.formatText(startIdx,len,"font",this.arrFonts[indexOfFont]);}}}}}}}}}}},getSelectionLength:function getSelectionLength(){var selected=this.quillInstance.getSelection();return(selected&&selected.length)||0;},utf8_to_b64:function utf8_to_b64(str){return window.btoa(encodeURIComponent(str));},b64_to_utf8:function b64_to_utf8(str){return decodeURIComponent(window.atob(str));},resolveDelta:function resolveDelta(delShow,resTextArr){var i=0;$ARR.forEach(delShow,function(item){if(!(item.insert&&item.insert.image)){var obj;try{obj=JSON.parse(resTextArr[i]);if(obj.image){item.insert=obj;}}catch(e){}if(!obj){delShow[i].insert=resTextArr[i];}}i++;});return delShow;},uploadImage:function uploadImage(){var me=this,e=document.createElement("input"),quill=this.quillInstance,editor=quill&&quill.editor,container=quill.container;e.setAttribute("type","file"),e.setAttribute("accept","image/png, image/gif, image/jpeg, image/bmp, image/x-icon"),e.classList.add("ql-image"),e.addEventListener("change",function(){var reader=new FileReader();reader.onload=function(n){if(e.files[0].size<MAX_IMAGE_SIZE){me.renderRVText();var ret=editor.delta.insert({image:n.target.result});quill.setContents(ret,USER);e.value="";container.removeChild(e);me.saveWithoutUnselecting();}else{mstrmojo.alert(mstrmojo.desc(14650,"Cannot embed an image larger than ##MB. Your image is too large to be compressed up to ###MB").replace("###",MAX_IMAGE_MB).replace("##",MAX_IMAGE_MB));}};reader.readAsDataURL(e.files[0]);});container.appendChild(e);e.click();},openURLBox:function openURLBox(cfgposition){var me=this;var editor=new mstrmojo.vi.ui.TextBoxURLEditor({top:cfgposition.y+"px",left:cfgposition.x+"px",quill:me});editor.open();this.setEditorFormatStyle(editor);},retSelLink:function retSelLink(selection){if(!selection){return false;}var selIdx=selection.index,quill=this.quillInstance,ops=quill.editor.delta.ops,opsIndex=0;while(opsIndex<ops.length){var op=ops[opsIndex];if(op&&op.insert.length<=selIdx){selIdx=selIdx-op.insert.length;opsIndex++;}else{var attrs=op&&op.attributes;if(attrs&&attrs.link){return attrs.link;}return null;}}return null;},editURLLink:function editURLLink(cfgposition,linkURL){var me=this,editor=new mstrmojo.vi.ui.TextBoxURLEditor({top:cfgposition.y+"px",left:cfgposition.x+"px",quill:me}),sBox=editor.text;editor.open();var iNode=sBox.inputNode;iNode.value=linkURL;this.setEditorFormatStyle(editor);},removeURLLink:function removeURLLink(){this.quillInstance.format("link","");},setEditorFormatStyle:function setEditorFormatStyle(editor){var iNode=editor.text.inputNode;iNode.onkeypress=function(e){var keyCode=e.keyCode||e.which;if(keyCode==ENTER){editor.close();}};iNode.placeholder=URL_PLACEHOLDER;},renderRVText:function renderRVText(){var quill=this.quillInstance,curDelta=quill.editor.delta,textField=this,data=textField.node.data,arrInsDelta=(data.rv).split(BASE64_SEP),rvDelOps=textField.b64_to_utf8(arrInsDelta[1]);if(!$ARR.isArray(rvDelOps)){rvDelOps=JSON.parse(rvDelOps);}if(rvDelOps.ops){curDelta=rvDelOps;}else{curDelta.ops=rvDelOps;}textField.cacheGProps=textField.b64_to_utf8(arrInsDelta[2]);textField.domNode.style.background=this.cacheGProps;quill.setContents(curDelta);}});}());