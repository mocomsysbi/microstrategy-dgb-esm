(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.color","mstrmojo.expr","mstrmojo.Label","mstrmojo.vi.models.editors.BaseEditorModel","mstrmojo.vi.viz.EnumDSSDropZones","mstrmojo.vi.viz.MapHelper","mstrmojo.vi.util.ThresholdUtils","mstrmojo.ui.CheckList","mstrmojo.ui.editors.controls.ContainerGroup","mstrmojo.models.FormatModel","mstrmojo.chart.enums.EnumFontStyle","mstrmojo.gmaps.MapUtils","mstrmojo.gmaps.MapEnums","mstrmojo.gmaps.MapUtils","mstrmojo.gmaps._AreaMapHelper","mstrmojo.ui.editors.controls.FillConfigGroup","mstrmojo.ui.editors.controls.LineConfigGroup","mstrmojo.gm.GMEnums","mstrmojo.hash","mstrmojo.VisUtility","mstrmojo.gm.GMUtility","mstrmojo.gmaps.MapColorUtils","mstrmojo.num");mstrmojo.requiresDescs(8068,6030,6031,13254,13256,13255,11849,11850,11851,11852,11853,11854,11855);mstrmojo.requiresDescs(7736,8068,8102,8069,9237,2797,8958,8764,8765,13254,13256,11845,11846,11847);mstrmojo.requiresDescs(7674,15745,15746,15747,15748,15749,15750);var $EDZ=mstrmojo.vi.viz.EnumDSSDropZones,$ARR=mstrmojo.array,$HASH=mstrmojo.hash,$Clr=mstrmojo.color,$DTP=mstrmojo.expr.DTP,$EF=mstrmojo.emptyFn,$MH=mstrmojo.vi.viz.MapHelper,$THRESHOLD_UTILS=mstrmojo.vi.util.ThresholdUtils,$GMAPS=mstrmojo.gmaps,$VIS_UTILITY=mstrmojo.VisUtility,$MUTIL=$GMAPS.MapUtils,$EnumBaseMapType=$GMAPS.EnumBaseMapType,$EnumGraphicType=$GMAPS.EnumGraphicType,$EnumMarkerType=$GMAPS.EnumMarkerType,$EnumClusterMode=$GMAPS.EnumClusterMode,$EnumPropertyType=$GMAPS.EnumPropertyType,$EnumMaxSizeType=$GMAPS.EnumMaxSizeType,$EnumMinSizeType=$GMAPS.EnumMinSizeType,$EnumGeographicRole=$GMAPS.EnumGeographicRole,$EnumZoomBehavior=$GMAPS.EnumZoomBehavior,$EnumDataLabel=$GMAPS.EnumDataLabel,$EnumShapeFormat=$GMAPS.EnumShapeFormatting,$EnumShapeFormatDefaultStyle=$GMAPS.EnumDefaultShapeFormatStyle,$ENUM_PROPERTY_NAMES=mstrmojo.models.FormatModel.ENUM_PROPERTY_NAMES,$ENUM_FONT_STYLE_VALUE=mstrmojo.chart.enums.EnumFontStyle,$EnumDataLabelShowOption=$GMAPS.EnumDataLabelShowOption,$EnumLayerZoneSource=mstrmojo.gmaps.EnumLayerZoneSource,$AMHelper=$GMAPS._AreaMapHelper,TARGET_MAPOPTIONS=$GMAPS.TARGET_MAPOPTIONS,$FILL_GROUP_FLAGS=mstrmojo.ui.editors.controls.FillConfigGroup.CTRL_FLAGS,$ACP=mstrmojo.ui.editors.controls.AdvancedColorPicker,CTRL_TYPE_CHARACTER_GROUP=0,CTRL_TYPE_CHECK_BOX=1,ENABLE_MAX_MIN_SIZE_CONTROL=$GMAPS.ENABLE_MAX_MIN_SIZE_CONTROL,$GMU=mstrmojo.gm.GMUtility,$MCU=$GMAPS.MapColorUtils,$NUM=mstrmojo.num;var SUFFIX_COLOR="Clr";var MIN_SIZE_DESCRIPTION=["not used",mstrmojo.desc(13743,"The smallest element's size is proportional to its data element"),mstrmojo.desc(13744,"The smallest element's size is fixed, independent of its data value"),mstrmojo.desc(13740,"The smallest element's size is ## of the largest element's size")];var CTRL_FONT_FAMILY=1,CTRL_FONT_STYLE=2,CTRL_FONT_SIZE_AND_COLOR=4;var BASEMAP_LIST=[$EnumBaseMapType.Google,$EnumBaseMapType.Esri];var COLORBY_COLOR_CHANGE_REGISTRY="colorByColorChangeHandlers";var COLOR_PROPERTIES=[$EnumShapeFormat.SHAPE_FORMAT_FILL_COLOR,$EnumShapeFormat.SHAPE_FORMAT_BORDER_COLOR];function addEventHandler(registryName,type,fn,context){var registry=this[registryName];if(registry===undefined){this[registryName]={};registry=this[registryName];}registry[type]={fn:fn,context:context};}function getTemplateAttribute(){var m=this.getEditingGridData()||{},rowsAttr=$VIS_UTILITY.getPropertyByPath(m,"gts.row",[]),colsAttr=$VIS_UTILITY.getPropertyByPath(m,"gts.col",[]),allowedItems=rowsAttr.concat(colsAttr);return allowedItems;}function getTextBoxPropsWithEmptyVal(broker,snVal){function isConflictState(validationTextBox){var val=validationTextBox.value;return(val===undefined||val==="")&&broker.getEditingPropertyVal(snVal)===undefined;}return{onInvalid:function onInvalid(){if(isConflictState(this)){if(this.hasRendered){this.clearValidation();}return ;}if(this.hasRendered){mstrmojo.ui.editors.controls.ValidationTextBox.prototype.onInvalid.call(this);}},onRender:function(){if(isConflictState(this)){this.clearValidation();}}};}function doControlPostCreating(control,labelText,controlType,columnSizes){if(!control){return ;}var me=this;function removeDuplicate(arr){return Object.keys($ARR.hash($ARR.ensureArray(arr)));}var listenFormatProps=control.listenFormatProps||[],listenSelector=control.listenSelector||[];(control.smartNames||[]).forEach(function(sn){$ARR.insert(listenFormatProps,null,sn);});control.listenFormatProps=removeDuplicate(listenFormatProps);control.listenSelector=removeDuplicate(listenSelector);var result=control;if(typeof labelText==="string"){var isCheckbox=(controlType===CTRL_TYPE_CHECK_BOX),labelWidth=isCheckbox?"14px":"30%",controlWidth=isCheckbox?"100%":"70%";if(columnSizes){labelWidth=columnSizes[0];controlWidth=columnSizes[1];}result=this.getLabelAndControl(labelText,control,labelWidth,controlWidth,isCheckbox);control.label=result.getLabel();if(isCheckbox){result.cssClass="checkLabel multiLine";control.label.onclick=function onclick(){control.onclick();};control.label.cssDisplay="inline-block";}else{if(controlType===CTRL_TYPE_CHARACTER_GROUP){result.cssClass="characterGroup";}}}control.getCtrlContainer=function(){return result;};return result;}getPartialUpdateCallback:function getPartialUpdateCallback(propertyName){var me=this;return function(newValue){var host=me.getHost(),layerKey=host.getEditingGridKey();host.writeProperties(propertyName,newValue,layerKey);};}function getEventDispatcher(registryName){var me=this;return function(evt){var registry=me[registryName]||{},typeList=evt.type==="*"?Object.keys(registry):[].concat(evt.type),handler;typeList.forEach(function(type){if(registry.hasOwnProperty(type)){handler=registry[type];handler.fn.call(me,evt,handler.context);}});};}mstrmojo.vi.models.editors.MapEditorModel=mstrmojo.declare(mstrmojo.vi.models.editors.BaseEditorModel,null,{scriptClass:"mstrmojo.vi.models.MapEditorModel",vizUnit:null,propertyEditor:null,help:"format_panel_map.htm",editingProperty:null,defaultShapeId:null,colorBySub:null,baseMapOptionsControls:null,mapStyleControl:null,graphicLayersControl:null,graphicLayerOptionsControls:null,onPropertiesChanged:function onPropertiesChanged(propertyName,newValue){var host=this.getHost(),templateAttributes,gridData,vp,preGraphicType,me=this;if(propertyName===$EnumPropertyType.graphicType){templateAttributes=getTemplateAttribute.call(host);gridData=host.getEditingGridData()||{};vp=gridData.vp;preGraphicType=vp&&vp.gtp;if(preGraphicType!==newValue){host.zonesModel.addAttributeNameAndTargetVisForAddUnits(gridData,templateAttributes,undefined,newValue,undefined);host.zonesModel.checkAndWarnLargeItemsForAddUnits(templateAttributes,function(){me.editingProperty=propertyName;host&&host.writeProperties(propertyName,newValue);});}}else{if(newValue===$ACP.VAL_AUTOMATIC&&COLOR_PROPERTIES.indexOf(propertyName)>=0){newValue=undefined;}if(host){host.writeProperties(propertyName,newValue);}}},getActionsWithUpdateProperty:function getActionsWithUpdateProperty(prevGtp){var host=this.getHost(),editingHost=host&&host.getEditingHost(),actions=[],zonesCfg=host&&host.zonesModel.getZonesCfg(),me=this,datasetId,graphicType,dzModel,data,props,geoItems;if((this.editingProperty!==$EnumPropertyType.graphicType)||!editingHost||!zonesCfg){return actions;}dzModel=editingHost.zonesModel;data=editingHost.model&&editingHost.model.data;if(!data||!dzModel){return actions;}props=data.vp;$ARR.forEach(zonesCfg,function(z){if(!z.show(props)){actions=actions.concat(me.getRemoveUnitAction(z.id,dzModel));}});if(prevGtp===$EnumGraphicType.Area){geoItems=host.getEditingDropZoneItems($EDZ.GeoAttribute);if(geoItems&&geoItems[1]){actions=actions.concat(dzModel.getRemoveDropZoneUnitActions({id:$EDZ.GeoAttribute},geoItems[1]));}}graphicType=props&&props[$EnumPropertyType.graphicType];datasetId=data.datasetId;actions=actions.concat(this.getAddFormUnitAction($EDZ.Latitude,datasetId,shouldAddLatLngDropZone,getLatitudeForm,graphicType,dzModel));actions=actions.concat(this.getAddFormUnitAction($EDZ.Longitude,datasetId,shouldAddLatLngDropZone,getLongitudeForm,graphicType,dzModel));if(shouldRemoveImageThreshold.call(this,graphicType)){var colorByZoneModel=dzModel.getZoneModelByZoneId($EDZ.ColorBy),colorByItem=!!colorByZoneModel?colorByZoneModel.items[0]:{},thresholds=data.gsi&&data.gsi.thresholds,existingThresholdsForMetric=thresholds&&colorByItem&&thresholds[colorByItem.did],needRemoveThreshold=false;if(existingThresholdsForMetric&&(existingThresholdsForMetric.length>0&&existingThresholdsForMetric[0].rtp===4)){needRemoveThreshold=true;}if(needRemoveThreshold){$THRESHOLD_UTILS.addThresholds(editingHost.model,editingHost,editingHost.node,colorByItem,actions,null,null,true);}}return actions.length>0?$ARR.ensureArray(dzModel.getUpdateTemplateAction(actions)):[];},getRemoveUnitAction:function getRemoveUnitAction(zoneId,dzModel){if(!dzModel){return[];}var host=this.getHost(),items=host&&host.getEditingDropZoneItems(zoneId),actions=[];if(items&&items.length>0){var delItem={did:items[0].id,t:items[0].t};actions=actions.concat(dzModel.getRemoveDropZoneUnitActions({id:zoneId},delItem));}return actions;},getAddFormUnitAction:function getAddFormUnitAction(zoneId,datasetId,isAddFn,getFormFn,graphicType,dzModel){var actions=[],host=this.getHost(),primaryDzModel=host&&host.zonesModel,zoneModel,firstItem,form;if(!(isAddFn.call(this,graphicType,zoneId))||!dzModel||!primaryDzModel){return actions;}primaryDzModel.getDropZones();zoneModel=primaryDzModel.getZoneModelByZoneId($EDZ.GeoAttribute);firstItem=!!zoneModel?zoneModel.items[0]:{};form=getFormFn.call(this,firstItem);if(dzModel&&form){actions.push({act:"addForm",unitId:firstItem.did,attFormId:form.fid,unitPos:1});actions=actions.concat(dzModel.getAddDropZoneUnitsActions({id:zoneId},[{did:form.fid,t:21}],0,{datasetId:datasetId}));}return actions;},getMapViewer:function getMapViewer(){var host=this.getHost();return host&&host.mapViewer;},getEditingPropertyVal:function getEditingPropertyVal(propName){var host=this.getHost();return host&&host.getPropertyValue(propName);},getDensityTheme:function getDensityTheme(){var value=this.getEditingPropertyVal($EnumPropertyType.themeType);value=parseInt(value,10);return isNaN(value)?1:value;},getAreaShape:function getAreaShape(){return this.getEditingPropertyVal($EnumPropertyType.shapeFile);},getBaseMapTypes:function getBaseMapTypes(){var host=this.getHost(),options=[];if(!host){return ;}if(host.hasGooglePlugin()){options.push({n:mstrmojo.desc(14744,"Google"),id:$EnumBaseMapType.Google});}else{$ARR.removeItem(BASEMAP_LIST,$EnumBaseMapType.Google);}if(host.isESRIKeyValid()){options.push({n:mstrmojo.desc(14745,"Esri"),id:$EnumBaseMapType.Esri});}else{$ARR.removeItem(BASEMAP_LIST,$EnumBaseMapType.Esri);}if(BASEMAP_LIST.indexOf($EnumBaseMapType.Mapbox)!==-1){options.splice(0,0,{n:mstrmojo.desc(15301,"Mapbox"),id:$EnumBaseMapType.Mapbox});}if(BASEMAP_LIST.indexOf($EnumBaseMapType.Image)!==-1){options.push({n:mstrmojo.desc(2922,"Image"),id:$EnumBaseMapType.Image});}return options;},getMapStyles:function getMapStyles(){var mapViewer=this.getMapViewer(),baseLayer=mapViewer&&mapViewer.baseLayer;return baseLayer&&baseLayer.getMapStyles();},getMapRedrawTypes:function getMapRedrawTypes(){return[{id:$EnumZoomBehavior.Keep,n:mstrmojo.desc(7982,"Static")},{id:$EnumZoomBehavior.Automatic,n:mstrmojo.desc(15251,"Dynamic")}];},shouldRemoveAreaOption:function(){return $MUTIL.isSingleTier()&&!$MUTIL.isWSLiveMode()&&this._getBaseMapType()===$EnumBaseMapType.Google;},getGraphicTypes:function getGraphicTypes(){var options=[{n:mstrmojo.desc(13254,"Marker"),id:$EnumGraphicType.Marker},{n:mstrmojo.desc(348,"Bubble"),id:$EnumGraphicType.Bubble},{n:mstrmojo.desc(13255,"Area"),id:$EnumGraphicType.Area},{n:mstrmojo.desc(13256,"Density"),id:$EnumGraphicType.Density}];if(this.shouldRemoveAreaOption()){options.splice(2,1);}return options;},getMarkerTypes:function getMarkerTypes(){return[{n:mstrmojo.desc(11837,"Pins"),id:$EnumMarkerType.Pin},{n:mstrmojo.desc(154,"Squares"),id:$EnumMarkerType.Square},{n:mstrmojo.desc(14746,"Diamonds"),id:$EnumMarkerType.Diamond},{n:mstrmojo.desc(14747,"Images"),id:$EnumMarkerType.Image}];},getMarkerClusteringTypes:function getMarkerClusteringTypes(){return[{n:mstrmojo.desc(6030,"On"),id:$EnumClusterMode.ON},{n:mstrmojo.desc(344,"Pie"),id:$EnumClusterMode.PIE},{n:mstrmojo.desc(6031,"Off"),id:$EnumClusterMode.OFF}];},getBubbleClusteringTypes:function getBubbleClusteringTypes(){return[{n:mstrmojo.desc(6030,"On"),id:$EnumClusterMode.ON},{n:mstrmojo.desc(6031,"Off"),id:$EnumClusterMode.OFF}];},getDensityThemes:function getDensityThemes(){return[{id:1,cls:"rainbow",title:mstrmojo.desc(9234,"Rainbow")},{id:2,cls:"fire",title:mstrmojo.desc(9235,"Fire")},{id:3,cls:"sunrise",title:mstrmojo.desc(9236,"Sunrise")},{id:4,cls:"desert",title:mstrmojo.desc(9237,"Desert")},{id:5,cls:"brick",title:mstrmojo.desc(9238,"Brick")}];},getAreaShapes:function getAreaShapes(){var host=this.getHost(),shapesOptions=[],grid,props,geoItems,baseMapType,geoRole,mapConfig,commonConfig,esriConfig,shapes,ga;if(!host){return shapesOptions;}grid=host.getEditingGridData();props=host.getEditingGridProps();geoItems=host.getEditingDropZoneItems($EDZ.GeoAttribute);$ARR.forEach(geoItems,function(item){ga=item.id;return false;});if(!ga||ga.length===1){props.lid="";this.defaultShapeId=null;return null;}geoRole=$AMHelper.getShapeAttributeGeoRole(grid,ga)||$EnumGeographicRole.EnumGeographicRoleNone;baseMapType=host.getBaseMapType();mapConfig=host.getMapConfig();commonConfig=mapConfig&&mapConfig.common;esriConfig=mapConfig&&mapConfig.esri;if(baseMapType===$EnumBaseMapType.Esri&&esriConfig&&parseInt(esriConfig.useESRICloud,10)!=1){return null;}if(commonConfig){shapes=$AMHelper.getAvailableShapes(commonConfig.shapes,commonConfig.layers,geoRole,baseMapType);shapesOptions=this.getShapeOptions(shapes,baseMapType);}this.loadDefaultShape(shapes,geoRole);return shapesOptions;},_getBaseMapType:function _getBaseMapType(){var host=this.getHost();return host&&host.getBaseMapType();},getShapeOptions:function getShapeOptions(shapes,baseMapType){var options=[{id:"-----",n:mstrmojo.desc(11290,"Please select")}],shape,i,il,shapeName,descId;if(!!shapes){for(i=0,il=shapes.length;i<il;i++){shape=shapes[i];if(shape){shapeName=shape.desc;if(baseMapType===$EnumBaseMapType.Mapbox&&shape.descWeb){try{descId=parseInt(shape.descWeb.substring(8));if(!isNaN(descId)){shapeName=mstrmojo.desc(descId,shapeName);}}catch(e){}}options.push({id:shape.id,n:shapeName});}}}return options;},loadDefaultShape:function loadDefaultShape(shapes,geoRole){this.defaultShapeId=null;var defaultShape=$AMHelper.getMatchingShape(shapes,null,geoRole);if(!!defaultShape){this.defaultShapeId=defaultShape.id;}},getBaseMapTypeSelectedIndex:function getBaseMapTypeSelectedIndex(){var bmt=this.getEditingPropertyVal($EnumPropertyType.baseMapType),selectedIndex=BASEMAP_LIST.indexOf(bmt);if(selectedIndex!==-1){return selectedIndex;}},getMapStyleSelectedIndex:function getMapStyleSelectedIndex(styles){var mapStyle=this.getEditingPropertyVal($EnumPropertyType.mapStyle),mapStyleList=styles||this.getMapStyles(),index=-1,mapViewer=this.getMapViewer(),baseLayer=mapViewer&&mapViewer.baseLayer,style,i,il;if(!baseLayer){return ;}if(mapStyle!=undefined&&!!mapStyleList&&mapStyleList.length>0){for(i=0,il=mapStyleList.length;i<il;i++){style=mapStyleList[i];if(style.id==mapStyle){index=i;break;}}}return(index!==-1)?index:baseLayer.getDefaultStyleIdx();},getMapRedrawSelectedIndex:function getMapRedrawSelectedIndex(){var value=this.getEditingPropertyVal($EnumPropertyType.zoomSetting),selectedIndex=0;switch(value){case $EnumZoomBehavior.Keep:selectedIndex=0;break;case $EnumZoomBehavior.Automatic:selectedIndex=1;break;default:break;}return selectedIndex;},getGraphicTypeSelectedIndex:function getGraphicTypeSelectedIndex(graphicType){var selectedIndex=0;switch(graphicType){case $EnumGraphicType.Marker:selectedIndex=0;break;case $EnumGraphicType.Bubble:selectedIndex=1;break;case $EnumGraphicType.Area:selectedIndex=2;break;case $EnumGraphicType.Density:selectedIndex=3;break;default:break;}if(this.shouldRemoveAreaOption()){if(selectedIndex===2){selectedIndex=-1;}else{if(selectedIndex>2){selectedIndex-=1;}}}return selectedIndex;},getMarkerTypeSelectedIndex:function getMarkerTypeSelectedIndex(){var value=this.getEditingPropertyVal($EnumPropertyType.markerType),selectedIndex=0;switch(value){case $EnumMarkerType.Pin:selectedIndex=0;break;case $EnumMarkerType.Square:selectedIndex=1;break;case $EnumMarkerType.Diamond:selectedIndex=2;break;case $EnumMarkerType.Image:selectedIndex=3;break;default:break;}return selectedIndex;},getMarkerClusteringTypeSelectedIndex:function getMarkerClusteringTypeSelectedIndex(){var type=this.getEditingPropertyVal($EnumPropertyType.clusterMode),selectedIndex=0;switch(type){case $EnumClusterMode.ON:selectedIndex=0;break;case $EnumClusterMode.PIE:selectedIndex=1;break;case $EnumClusterMode.OFF:default:selectedIndex=2;break;}return selectedIndex;},getBubbleClusteringTypeSelectedIndex:function getBubbleClusteringTypeSelectedIndex(){var type=this.getEditingPropertyVal($EnumPropertyType.clusterMode),selectedIndex=0;switch(type){case $EnumClusterMode.ON:selectedIndex=0;break;case $EnumClusterMode.OFF:default:selectedIndex=1;break;}return selectedIndex;},getDensityThemeSelectedIndex:function getDensityThemeSelectedIndex(){return this.getDensityTheme()-1;},getAreaShapeSelectedIndex:function getAreaShapeSelectedIndex(){var shapes=this.getAreaShapes(),value=this.getAreaShape(),shapeCount=shapes?shapes.length:0,i,shape,selectedIndex=0;for(i=1;i<shapeCount;i++){shape=shapes[i];if(shape.id==value){selectedIndex=i;break;}}return selectedIndex;},getEditorContents:function getEditorContents(postUpdateFn){var host=this.getHost();if(host.editorContentReady===true){return this._super(postUpdateFn);}else{return null;}},getDelayedEditorContents:function getDelayedEditorContents(propertyEditor,vizUnit){var host=this.getHost();this.propertyEditor=propertyEditor;this.vizUnit=vizUnit;host.propEditorListener={listener:this,callback:this.updateEditorContent};},updateEditorContent:function updateEditorContent(){if(this.vizUnit){var propertyEditor=this.propertyEditor;if(propertyEditor){propertyEditor.onVIUnitSelected(this.vizUnit);}}this.propertyEditor=null;this.vizUnit=null;},getContainerCtrlFlags:function getContainerCtrlFlags(){return mstrmojo.ui.editors.controls.ContainerGroup.CTRL_FLAGS.BORDER;},getInitialTarget:function getInitialTarget(){return TARGET_MAPOPTIONS;},getTargetPulldownItems:function getTargetPulldownItems(dynamicCtrlGroup){var pulldownItems=this._super(dynamicCtrlGroup),host=this.getHost(),me=this,fnHandler=function(){var fn=me.getMapOptionControls;me.replaceChildControls(dynamicCtrlGroup,fn.call(me));};if(host.isBaseMapValid()&&!(host.excludeData||host.isEmpty())){pulldownItems.unshift({n:mstrmojo.desc(13271,"Map Options"),v:TARGET_MAPOPTIONS,h:fnHandler});}return pulldownItems;},getTwoColumnContainer:function getTwoColumnContainer(controls,config){controls.forEach(function(ctrl,idx){ctrl.slot="col"+(idx+1)+"Node";});config=$HASH.copy(config,{col1Width:"50%",col2Width:"50%",children:controls});return new mstrmojo.ui.editors.controls.TwoColumnContainer(config);},getBaseMapControls:function getBaseMapControls(){var children=[],baseMapTypeControl=this.getBaseMapTypeControl();if(baseMapTypeControl){children.push(baseMapTypeControl);}this.baseMapOptionsControls=this.getEditorGroup(this.getBaseMapOptionsControls(),{isNested:true,showDivider:false,isContainer:true});children.push(this.baseMapOptionsControls);if($MUTIL.enableZoomLevelAndPosSaving()){children.push(this.getKeepZoomLevelandPosCtrl());}return this.getEditorGroup(children,{isNested:true,showDivider:false,isContainer:true});},getBaseMapTypeControl:function getBaseMapTypeControl(){return this.fnGetPulldown(this.getBaseMapTypes(),this.getBaseMapTypeSelectedIndex(),mstrmojo.desc(14748,"Base map")+":",$EnumPropertyType.baseMapType);},getKeepZoomLevelandPosCtrl:function getKeepZoomLevelandPosCtrl(){var me=this,host=this.getHost(),properties=host&&host.getProperties(),enabled=properties[$EnumPropertyType.zoomSetting]!==$EnumZoomBehavior.Automatic,propName=$EnumPropertyType.keepZoomAndPos,isChecked=properties[propName]===true||properties[propName]==="true",checkBox=new mstrmojo.ui.Checkbox({checked:isChecked,oncheckedChange:function oncheckedChange(evt){me.onPropertiesChanged(propName,evt.value);}}),control=this.getLabelAndControl(mstrmojo.desc(15743,"Remember zoom level"),checkBox,"14px","100%",true,{enabled:enabled}),label=control.getLabel();label.onclick=function(){checkBox.onclick();};return control;},getGraphicLayersControls:function getGraphicLayersControls(){var layersControls=[];if(!mstrApp.isInVFConfigMode){var labelControl=new mstrmojo.Label({text:"Layers",setDimensions:function(h,w){var domNode=this.domNode;if(domNode){domNode.style.width=w;}}}),graphicLayerListControl=this.getGraphicLayerListControl();layersControls=[labelControl,graphicLayerListControl];}this.graphicLayerOptionsControls=this.getGraphicLayerOptionsControls();return this.getEditorGroup(layersControls.concat([this.graphicLayerOptionsControls]),{isNested:true,showDivider:true,isContainer:true});},getZoomControls:function getZoomControls(){return this.fnGetPulldown(this.getMapRedrawTypes(),this.getMapRedrawSelectedIndex(),mstrmojo.desc(15744,"Zoom behavior"),$EnumPropertyType.zoomSetting,{isNested:true,showDivider:false,isContainer:true});},getBaseMapOptionsControls:function getBaseMapOptionsControls(){var zoomControl=this.getZoomControls();this.mapStyleControl=this.getMapStyleControls();return !this.mapStyleControl?[zoomControl]:[this.mapStyleControl,zoomControl];},getMapStyleControls:function getMapStyleControls(){var mapStyles=this.getMapStyles(),me=this;if(this._getBaseMapType()===$EnumBaseMapType.Image){return new mstrmojo.ui.editors.controls.ValidationTextBox({required:true,validationDelay:120000,value:mapStyles[0],hint:"image URL...",onValid:function(){var host=me.getHost();if(host){host.writeProperties($EnumPropertyType.mapStyle,this.value);}},updateText:function(val){this.inputNode.value=val;this.value=val;}});}if(!!mapStyles&&mapStyles.length>0){return this.fnGetPulldown(mapStyles,this.getMapStyleSelectedIndex(mapStyles),mstrmojo.desc(13583,"Map style"),$EnumPropertyType.mapStyle);}},getGraphicLayerListControl:function getGraphicLayerListControl(){var host=this.getHost();if(host&&host.getLayerZoneControl instanceof Function){return host.getLayerZoneControl($EnumLayerZoneSource.PROPERTY_PANEL);}},getClusteringControlForMarker:function getClusteringControlForMarker(){return this.fnGetPulldown(this.getMarkerClusteringTypes(),this.getMarkerClusteringTypeSelectedIndex(),mstrmojo.desc(11841,"Clustering"),$EnumPropertyType.clusterMode);},getClusteringControlForBubble:function getClusteringControlForBubble(){return this.fnGetPulldown(this.getBubbleClusteringTypes(),this.getBubbleClusteringTypeSelectedIndex(),mstrmojo.desc(11841,"Clustering"),$EnumPropertyType.clusterMode);},getGraphicLayerOptionsControls:function getGraphicLayerOptionsControls(){var controls=[],graphicType=this.getEditingPropertyVal($EnumPropertyType.graphicType),markerType=this.getEditingPropertyVal($EnumPropertyType.markerType);controls.push(this.fnGetPulldown(this.getGraphicTypes(),this.getGraphicTypeSelectedIndex(graphicType),mstrmojo.desc(2043,"Type"),$EnumPropertyType.graphicType));switch(graphicType){case $EnumGraphicType.Marker:controls.push(this.fnGetPulldown(this.getMarkerTypes(),this.getMarkerTypeSelectedIndex(),mstrmojo.desc(2923,"Shape"),$EnumPropertyType.markerType));controls.push(this.getClusteringControlForMarker());break;case $EnumGraphicType.Bubble:controls.push(this.getClusteringControlForBubble());break;case $EnumGraphicType.Area:controls.push(this.fnGetPulldown(this.getAreaShapes(),this.getAreaShapeSelectedIndex(),mstrmojo.desc(11842,"Boundaries"),$EnumPropertyType.shapeFile));break;case $EnumGraphicType.Density:this.addDensityControls(controls);break;default:break;}if(graphicType&&(graphicType!==$EnumGraphicType.Density&&!(graphicType===$EnumGraphicType.Marker&&markerType===$EnumMarkerType.Image))){var shapeFormatControls=this.getShapeFormatControls(graphicType);if(shapeFormatControls){controls.push(shapeFormatControls);}}if(ENABLE_MAX_MIN_SIZE_CONTROL&&graphicType===$EnumGraphicType.Bubble){controls.push(this.getMaxMinSizeControls());}if(graphicType&&graphicType!==$EnumGraphicType.Density){controls.push(this.getDataLabelControls());}this.addShowLegendControl(controls);return this.getEditorGroup(controls,{isNested:true,showDivider:false,isContainer:true});},getMoreOptionsControl:function getMoreOptionsControl(){var host=this.getHost(),gridData=host&&host.getEditingGridData();return this.getEditorGroup([this.getMoreOptionsEditorLink((gridData&&gridData.gsi&&gridData.gsi.prop)||{})],{isNested:true,showDivider:true,isContainer:true});},addShowLegendControl:function addShowLegendControl(controls){var host=this.getHost(),graphicLayerKey=host.getEditingGridKey(),graphicLayer=host.getGraphicLayer(graphicLayerKey),sl=this.getEditingPropertyVal($EnumPropertyType.legendSwitch),groupLabel=this.getGroupTitle(mstrmojo.desc(2403,"Legend")),control;if(host.hasColorByOrSizeBy(graphicLayerKey)&&graphicLayer&&graphicLayer.isVisible()){control=this.getCheckboxAndLabel(sl===true||sl==="true",mstrmojo.desc(12001,"Show Legend"),getPartialUpdateCallback.call(this,$EnumPropertyType.legendSwitch));controls.push(this.getEditorGroup([groupLabel,control],{isNested:true,showDivider:true,isContainer:true}));}},openMoreOptionsEditor:function openMoreOptionsEditor(data,showHeadersSection,lockHeadersCase){var host=this.getHost();host=host&&host.getEditingHost();var editor=this._super(data,showHeadersSection,lockHeadersCase);if(editor&&host){editor.set("host",host);}},getMaxMinSizeControls:function getMaxMinSizeControls(){var maxSizeControl,minSizeControl,minSizeDescControl,controls,host=this.getHost(),key=host.getEditingGridKey(),properties=host.getProperties(key),currentLayer=host.getGraphicLayer(),txtConstraints={trigger:mstrmojo.validation.TRIGGER.ALL,min:0.01,max:1,regExp:mstrmojo.locales.number.DECIMALSEPARATOR==="."?/^\d+(\.\d{1,2})?$/:/^\d+(\,\d{1,2})?$/},enableMinSizeCtrl;if(!currentLayer){return ;}enableMinSizeCtrl=currentLayer.enableMinSizeOption();function getSizeControlRow(sizeTypePn,sizeValPn,label,types,config){function onSizeTypeChanged(newVal){var ratio=currentLayer.getMaxMinSizeValue(sizeValPn,newVal);textbox.set("enabled",config.textboxEnabled(newVal));textbox.updateText($NUM.toLocaleString(ratio));var cb=config.onSizeChanged;if(cb instanceof Function){cb(newVal,ratio);}host.writeProperties(sizeTypePn,newVal);}var initialType=currentLayer.getMaxMinSizeType(sizeTypePn),initialRatio=currentLayer.getMaxMinSizeValue(sizeValPn,initialType),typeControl=this.getPulldown(types,onSizeTypeChanged,!isNaN(initialType)?(initialType-1):0),textbox=new mstrmojo.ui.editors.controls.ValidationTextBox({required:true,dtp:$DTP.FLOAT,constraints:txtConstraints,validationDelay:1500,value:$NUM.toLocaleString(initialRatio),enabled:config.textboxEnabled(initialType),onValid:function(){var type=typeControl.getSelectedItem().v,ratio=$NUM.parseNumeric(this.value);var cb=config.onSizeChanged;if(cb instanceof Function){cb(type,ratio);}host.writeProperties(sizeValPn,ratio);},updateText:function(val){this.inputNode.value=val;this.value=val;}});return[new mstrmojo.Label({text:label}),this.getTwoColumnContainer([typeControl,textbox],{col1Width:"70%",col2Width:"30%"})];}function getMinSizeDescText(type,ratio){var text;type=parseInt(type);text=MIN_SIZE_DESCRIPTION[type];if(type===$EnumMinSizeType.ADJUSTED_RANGE){if(ratio===undefined){ratio=0.2;}text=text.replace("##",(ratio*100).toFixed(0)+"%");}return text;}maxSizeControl=getSizeControlRow.call(this,$EnumPropertyType.MAX_SIZE_TYPE,$EnumPropertyType.MAX_SIZE_VALUE,mstrmojo.desc(13918,"Max size (0.01 - 1.0):"),[{n:mstrmojo.desc(6019,"Automatic"),v:$EnumMaxSizeType.AUTOMATIC},{n:mstrmojo.desc(8262,"Manual"),v:$EnumMaxSizeType.MANUAL}],{textboxEnabled:function(type){return type===$EnumMaxSizeType.MANUAL;}});minSizeControl=getSizeControlRow.call(this,$EnumPropertyType.MIN_SIZE_TYPE,$EnumPropertyType.MIN_SIZE_VALUE,mstrmojo.desc(13917,"Min size (0.01 - 1.0):"),[{n:mstrmojo.desc(11990,"Proportional"),v:$EnumMinSizeType.PROPORTIONAL},{n:mstrmojo.desc(13741,"Full Range"),v:$EnumMinSizeType.FULL_RANGE},{n:mstrmojo.desc(14118,"Adjusted Range"),v:$EnumMinSizeType.ADJUSTED_RANGE}],{textboxEnabled:function(type){return type===$EnumMinSizeType.ADJUSTED_RANGE;},onSizeChanged:function(type,ratio){minSizeDescControl.set("text",getMinSizeDescText(type,ratio));}});controls=[].concat(maxSizeControl,minSizeControl);if(!enableMinSizeCtrl){minSizeControl.forEach(function(ctrl){ctrl.set("enabled",false);});}else{minSizeDescControl=new mstrmojo.Label({text:getMinSizeDescText(properties[$EnumPropertyType.MIN_SIZE_TYPE],properties[$EnumPropertyType.MIN_SIZE_VALUE]),cssText:"line-height: 115%;"});controls.push(minSizeDescControl);}return this.getEditorGroup(controls,{isNested:true,showDivider:true,isContainer:true});},getColorByAttrControls:function getColorByAttrControls(rst){var me=this,host=this.getHost(),layer=host&&host.getGraphicLayer(),colorBySub=this.colorBySub;if(!layer){return ;}var selectedIdx=0,cbElements=layer.getFormatColorByElements(),SHAPE_FILL="ShapeClr",SHAPE_OPACITY="ShapeFillTrans",AUTOMATIC_COLOR_VALUE=$ACP.VAL_AUTOMATIC,shapeItems=cbElements.map(function(e,idx){return{n:e.text,title:e.text,v:idx};}),realIndexes=$VIS_UTILITY.range(1,shapeItems.length,1),color,itemPulldown,dispatch=getEventDispatcher.bind(this),initCbSel,hasInitialMultiSelection=false,multiElementText=mstrmojo.desc(12092,"Multiple Elements");if(colorBySub){host.detachEventListener(colorBySub);}this.colorBySub=host.attachEventListener("colorByColorChange",this.id,dispatch(COLORBY_COLOR_CHANGE_REGISTRY));initCbSel=$MCU.cbSelectionToIndices(layer.getContextMenuColorBySelections(),cbElements);if(initCbSel.length===0){selectedIdx=0;}else{if(initCbSel.length===1){selectedIdx=initCbSel[0];}else{selectedIdx=initCbSel;hasInitialMultiSelection=true;}}function getRealSelectionIndex(){return[].concat(selectedIdx===0?realIndexes:selectedIdx);}function setColorAndOpacity(sync,idx){function set(){var multiSelIndexes,multiSel,elemMulti,item;if(idx===undefined){multiSelIndexes=getRealSelectionIndex();multiSel=[];$ARR.forEach(multiSelIndexes,function(index){multiSel.push(cbElements[index]);});elemMulti=$MCU.getColorInfoForItemAll(multiSel);this.setChildValue(SHAPE_FILL,elemMulti.color);this.setChildValue(SHAPE_OPACITY,elemMulti.opacity);}else{selectedIdx=idx;item=cbElements[idx];this.setChildValue(SHAPE_FILL,item.color);this.setChildValue(SHAPE_OPACITY,item.opacity);}var showAutomatic=getRealSelectionIndex().some(function(i){return $VIS_UTILITY.isColorManuallySet(host,cbElements[i].comb);});$VIS_UTILITY.setColorPickerShowAutomatic(this,showAutomatic);}if(sync){this.syncControls(set);}else{set.call(this);}}color=new mstrmojo.ui.editors.controls.FillConfigGroup({showGradient:false,onGroupValueChange:function(name,newVal){var host=me.getHost(),layer,newValues=[],combList=[],isShapeFill=name===SHAPE_FILL,isShapeOpacity=name===SHAPE_OPACITY,indexArray=getRealSelectionIndex(),refreshColor=false,sub,elementAll;indexArray.forEach(function(idx){var elem=cbElements[idx],comb=elem.comb;combList.push(comb);if(isShapeFill){if(newVal===AUTOMATIC_COLOR_VALUE){newValues.push("default");refreshColor=true;}else{newValues.push($GMU.encodeColor(newVal));elem.color=newVal;}}else{if(isShapeOpacity){newValues.push(newVal);elem.opacity=newVal;}}});if(refreshColor){sub=host.listenToUpdateColorMap(function(){var combCount=combList.length,newColor;indexArray.forEach(function(index){var element=cbElements[index];newColor=$GMU.decodeColor($VIS_UTILITY.getCombColor(host,element.comb));element.color=newColor;});elementAll=$MCU.getColorInfoForItemAll(cbElements.slice(1));cbElements[0].color=elementAll.color;if(combCount>1){newColor=cbElements[0].color;}color.syncControls(function(){this.setChildValue(SHAPE_FILL,newColor);$VIS_UTILITY.setColorPickerShowAutomatic(color,false);});host.detachUpdateColorMapListener(sub);});}if(isShapeFill){host.updateColorMap(combList,newValues);elementAll=$MCU.getColorInfoForItemAll(cbElements.slice(1));cbElements[0].color=elementAll.color;$VIS_UTILITY.setColorPickerShowAutomatic(this,true);}if(isShapeOpacity){layer=host&&host.getGraphicLayer();if(!layer){return ;}layer.updateLayerColorByOpacity(combList,newValues);cbElements=layer.getFormatColorByElements();}}});if(color){color.iniChildrenComp([SHAPE_FILL,SHAPE_OPACITY]);setColorAndOpacity.call(color,true,hasInitialMultiSelection?undefined:selectedIdx);}addEventHandler.call(this,COLORBY_COLOR_CHANGE_REGISTRY,"fill",function(evt){color.syncControls(function(){color.setChildValue(SHAPE_FILL,evt.fill);$VIS_UTILITY.setColorPickerShowAutomatic(color,evt.showAutomatic);});});addEventHandler.call(this,COLORBY_COLOR_CHANGE_REGISTRY,"opacity",function(evt){var host=me.getHost(),layer=host&&host.getGraphicLayer();if(!layer){return ;}cbElements=layer.getFormatColorByElements();color.syncControls(function(){color.setChildValue(SHAPE_OPACITY,evt.opacity);});});addEventHandler.call(this,COLORBY_COLOR_CHANGE_REGISTRY,"invalidateCache",function(){cbElements.forEach(function(element,idx){if(idx===0){return ;}element.color=$GMU.decodeColor($VIS_UTILITY.getCombColor(host,element.comb));});var elementAll=$MCU.getColorInfoForItemAll(cbElements.slice(1));cbElements[0].color=elementAll.color;});addEventHandler.call(this,COLORBY_COLOR_CHANGE_REGISTRY,"opacityFullUpdate",function(){var opacity,host=me.getHost(),layer=host&&host.getGraphicLayer();if(!layer){return ;}cbElements=layer.getFormatColorByElements();if(selectedIdx>=0){opacity=cbElements[selectedIdx].opacity;color.syncControls(function(){color.setChildValue(SHAPE_OPACITY,opacity);});}});addEventHandler.call(this,COLORBY_COLOR_CHANGE_REGISTRY,"colorFullUpdate",function(){var colorValue,showAutomatic,host=me.getHost(),layer=host&&host.getGraphicLayer();if(!layer){return ;}cbElements=layer.getFormatColorByElements();if(selectedIdx>=0){colorValue=cbElements[selectedIdx].color;showAutomatic=getRealSelectionIndex().some(function(i){return $VIS_UTILITY.isColorManuallySet(host,cbElements[i].comb);});color.syncControls(function(){color.setChildValue(SHAPE_FILL,colorValue);$VIS_UTILITY.setColorPickerShowAutomatic(color,showAutomatic);});}});itemPulldown=this.getPulldown(shapeItems,setColorAndOpacity.bind(color,true),hasInitialMultiSelection?undefined:selectedIdx,{setDisplayText:function(txt){var selectedNode=this.selectedNode;if(selectedNode){selectedNode.innerHTML=txt;selectedNode.title=txt;}}});if(hasInitialMultiSelection){itemPulldown.attachEventListener("renderComplete",itemPulldown.id,function(){itemPulldown.setDisplayText(multiElementText);});}rst.push(itemPulldown);rst.push(color);},getShapeFormatControls:function getShapeFormatControls(graphicType){var host=this.getHost(),broker=this,isColorByAttr=host.isEditingDropZoneColorByAttr(),itemsInColorByDropZone=host.getEditingDropZoneItems($EDZ.ColorBy),hasMetricInColorByDropZone=isColorByAttr===false&&itemsInColorByDropZone&&itemsInColorByDropZone.length>0,hasAttrInColorByDropZone=isColorByAttr===true&&itemsInColorByDropZone&&itemsInColorByDropZone.length>0,layer=host.getGraphicLayer(),validData=layer&&layer.dataValidate(),groupTitle=this.getGroupTitle(mstrmojo.desc(13751,"Shape Formatting")),ctrlShapeFillOpacity,ctrlShapeBorderGroup,shapeControls=[],nestedGroupProps={isNested:true,showDivider:true,isContainer:true},hideDashCtrl;function getSharedControlProps(hideColorControl,resettableClrSN,hasSingleCtrl,lineStyleSN){var loadDefaultSNValue=function(propName){switch(propName){case $EnumShapeFormat.SHAPE_FORMAT_FILL_OPACITY:return $EnumShapeFormatDefaultStyle.FILL_OPACITY;case $EnumShapeFormat.SHAPE_FORMAT_FILL_COLOR:return $EnumShapeFormatDefaultStyle.FILL_COLOR;case $EnumShapeFormat.SHAPE_FORMAT_BORDER_STYLE:return $EnumShapeFormatDefaultStyle.BORDER_STYLE;case $EnumShapeFormat.SHAPE_FORMAT_BORDER_COLOR:return $EnumShapeFormatDefaultStyle.BORDER_COLOR;}};var rst={groupTitle:groupTitle,preBuildRendering:$EF,onRender:function(){this.reInit();},broker:broker,reInitDefault:function(){(this.listenFormatProps).forEach(function(smartName){this.onFmtPropsChanged(smartName,this.broker.getEditingPropertyVal(smartName));},this);},reInit:function(){this.reInitDefault();},preBuildRendering:function(){this.reInit();},onFmtPropsChanged:function(smartName,value,opt){if(!value){value=loadDefaultSNValue(smartName);}this.onFmtPropsChangedDefault(smartName,value,opt);},syncControl:function(fnSync){var currentSync=this._sync;this._sync=true;var rst=fnSync.call(this);this._sync=currentSync;return rst;},onFmtPropsChangedDefault:$EF,onSelectorsValueChangedDefault:function(){this.reInit();},onSelectorsValueChanged:function(selName,value){this.onSelectorsValueChangedDefault(selName,value);}},snColorNotSet=broker.getEditingPropertyVal(resettableClrSN);if(!hideColorControl){$HASH.copy({reInit:function(){if(hasSingleCtrl){this.getCtrlContainer().set("enabled",true);}else{this.setChildEnable(SUFFIX_COLOR,true);}this.reInitDefault();},onGroupValueChange:$EF,onFmtPropsChanged:function onFmtPropsChangedDefault(smartName,value){var defaultVal=loadDefaultSNValue(smartName);if(!value){value=defaultVal;}if(resettableClrSN&&smartName===resettableClrSN){var isDefaultColor=!snColorNotSet;this.syncControl(function(){this.getChildComp(smartName).set("autoPreviewColor",defaultVal);this.setChildValue(smartName,isDefaultColor?$ACP.VAL_AUTOMATIC:value);});}else{this.onFmtPropsChangedDefault(smartName,value);if(lineStyleSN&&smartName===lineStyleSN){this.setChildEnable(SUFFIX_COLOR,value!==mstrmojo.gmaps.EnumCombinedLineStyle.NONE);}}}},rst);}return rst;}var adjustCtrlLayout=function adjustCtrlLayout(shapeCtrlContainer,hasOnlyOneCtrl){if(hasOnlyOneCtrl){$HASH.copy({col1Node:"58%",col2Node:"42%"},shapeCtrlContainer.layoutConfig.w);var offsetWidth=3;$HASH.copy({cssText:"margin-left: "+offsetWidth+"px;",getLayoutOffsets:function getLayoutOffsets(){return{h:0,w:offsetWidth};}},shapeCtrlContainer.getCtrl());}return shapeCtrlContainer;};var fnGetShapeFillGroup=function(hideColorControl){var me=this,snMap={fillColor:$EnumShapeFormat.SHAPE_FORMAT_FILL_COLOR,fillAlpha:$EnumShapeFormat.SHAPE_FORMAT_FILL_OPACITY},smartNames=$HASH.valarray(snMap),props=$HASH.copy({controlName:"shapeFillGroup",showGradient:false,smartNamesMap:snMap,showAutomaticInColor:true,listenFormatProps:smartNames},getSharedControlProps(hideColorControl,snMap.fillColor,hideColorControl));if(hideColorControl){delete snMap.fillColor;props.visibleControls=$FILL_GROUP_FLAGS.FILL_TRANSPARENCY;}props.onGroupValueChange=function(smartName,value){me.onPropertiesChanged(smartName,value);};props.onFmtPropsChangedDefault=function(smartName,value){this.syncControl(function(){if($ARR.filterOne(this.propNames,function(name){return(name===smartName);})){this.setChildValue(smartName,value);}else{this.propNames.forEach(function(name){this.setChildValue(name,broker.getEditingPropertyVal(name));});}});};var control=this.addDisposable(new mstrmojo.ui.editors.controls.FillConfigGroup(props));control.iniChildrenComp(smartNames);var ctrlContainer=null,snFillAlpha=snMap.fillAlpha,opacityCtrl=snFillAlpha&&control.getChildComp(snFillAlpha);if(opacityCtrl){$HASH.copy(getTextBoxPropsWithEmptyVal(broker,snFillAlpha),opacityCtrl);}if(hideColorControl){var thresholdPaletteControl=getShapeColorThresholdEditorLink.call(this);ctrlContainer=this.getTwoColumnContainer([thresholdPaletteControl,control],{col1Width:"60%",col2Width:"40%"});}else{ctrlContainer=control;}return this.getEditorGroup([new mstrmojo.Label({text:mstrmojo.desc(2885,"Fill")}),ctrlContainer],{showDivider:false,isNested:true,isContainer:true});}.bind(this);var fnGetShapeBorderGroup=function(hideColorControl,hideDashCtrl){var label=null,me=this,snMap={lineColor:$EnumShapeFormat.SHAPE_FORMAT_BORDER_COLOR,lineStyle:$EnumShapeFormat.SHAPE_FORMAT_BORDER_STYLE},smartNames=$HASH.valarray(snMap),hasSingleCtrl=hideColorControl,props=$HASH.copy({lineTitle:mstrmojo.desc(9736,"Border"),controlName:"shapeBorderGroup",hideColorControl:hideColorControl,showNoFillInColor:false,showAutomaticInColor:true,listenFormatProps:smartNames},getSharedControlProps(hideColorControl,snMap.lineColor,hideColorControl,snMap.lineStyle));if(hideColorControl){delete snMap.lineColor;label=mstrmojo.desc(3538,"Border Style");props.lineTitle=null;}props.onGroupValueChange=function(smartName,value){me.onPropertiesChanged(smartName,value);};props.onFmtPropsChangedDefault=function(smartName,value){this.syncControl(function(){this.setChildValue(smartName,value);});};props.hideDashOptions=!!hideDashCtrl;var control=this.addDisposable(new mstrmojo.ui.editors.controls.LineConfigGroup(props));control.iniChildrenComp(smartNames);return adjustCtrlLayout(doControlPostCreating.call(this,control,label),hasSingleCtrl);}.bind(this);function getShapeColorThresholdEditorLink(){var edtMdlId=this.id,host=this.getHost(),editingDropZones=host.zonesModel.getDropZones(true),metricsInColorByDropZone=$VIS_UTILITY.getMetricsInDropZone({dropZones:editingDropZones.zones},$EDZ.ColorBy),firstItem=metricsInColorByDropZone[0]||{},editingHost=host.getEditingHost(),gridData=editingHost.model.data,gridStructureInfo=gridData.gsi,gridMetrics=gridStructureInfo.mx,metric=gridMetrics[$ARR.find(gridMetrics,"did",firstItem.id)],thresholdData=gridStructureInfo.thresholds[firstItem.id];return new mstrmojo.vi.ui.ColorRangeSelector({thresholds:thresholdData,metric:metric,onclick:function(){var editorModel=mstrmojo.all[edtMdlId],host=editorModel&&editorModel.getHost(),vis=host&&host.getEditingHost(),zoneModel,canSupportImage;if(vis&&vis.model){zoneModel=host.zonesModel;canSupportImage=zoneModel&&zoneModel.canSupportImageThreshold();vis.model.openThresholdEditor(firstItem,true,canSupportImage);}}});}switch(graphicType){case $EnumGraphicType.Bubble:hideDashCtrl=true;case $EnumGraphicType.Area:ctrlShapeBorderGroup=fnGetShapeBorderGroup(hasMetricInColorByDropZone,hideDashCtrl);if(!(hasAttrInColorByDropZone&&validData)){ctrlShapeFillOpacity=fnGetShapeFillGroup(hasMetricInColorByDropZone);shapeControls.push(ctrlShapeFillOpacity,ctrlShapeBorderGroup);}else{shapeControls.push(ctrlShapeBorderGroup);}break;case $EnumGraphicType.Marker:if(!(hasAttrInColorByDropZone&&validData)){ctrlShapeFillOpacity=fnGetShapeFillGroup(hasMetricInColorByDropZone);shapeControls.push(ctrlShapeFillOpacity);}break;case $EnumGraphicType.Density:default:return null;}var rst=[groupTitle];if(hasAttrInColorByDropZone&&validData){this.getColorByAttrControls(rst);}return this.getEditorGroup(rst.concat(shapeControls),nestedGroupProps);},getDataLabelControls:function getDataLabelControls(){var labelControl=this.getGroupTitle(mstrmojo.desc(11993,"Data Labels")),showOptionControl=this.getDataLabelShowOptionControl(),disableCtrls=showOptionControl.disableCtrls;return this.getEditorGroup([labelControl,showOptionControl.control,this.getDataLabelShowAllCheckBoxControl(disableCtrls),this.getDataLabelCharacterControl(disableCtrls)],{isNested:true,showDivider:true,isContainer:true});},getMapOptionControls:function getMapOptionControls(){var controls=[];if(mstrApp&&mstrApp.enableImageMap&&BASEMAP_LIST.indexOf($EnumBaseMapType.Image)===-1){BASEMAP_LIST.push($EnumBaseMapType.Image);}controls.push(this.getBaseMapControls());this.graphicLayersControl=this.getGraphicLayersControls();controls.push(this.graphicLayersControl);controls.push(this.getMoreOptionsControl());return[this.getEditorGroup([this.getEditorGroup(controls)],{showDivider:true,isNested:true,isContainer:true})];},addDensityControls:function addDensityControls(controls){var densityThemeItems=this.getDensityThemes(),densityCallback,densityList;if(densityThemeItems&&densityThemeItems.length>0){densityCallback=getCallback.call(this,$EnumPropertyType.themeType);densityList=new mstrmojo.ui.CheckList({cssClass:"mem-density-list",orientation:"h",items:densityThemeItems,multiSelect:false});densityList.set("selectedIndex",this.getDensityThemeSelectedIndex());densityList.postselectionChange=function(evt){densityCallback(densityThemeItems[evt.added[0]]);};controls.push(getPropertyTitle.call(this,mstrmojo.desc(11839,"Density map color gradient:")));controls.push(densityList);}},getDataLabelExtraControlProps:mstrmojo.emptyFn,getDataLabelControlConfig:function getDataLabelControlConfig(){return CTRL_FONT_FAMILY+CTRL_FONT_STYLE+CTRL_FONT_SIZE_AND_COLOR;},getDataLabelCharacterControl:function getDataLabelCharacterControl(disabled){var control,me=this,host=this.getHost(),key=host.getEditingGridKey(),properties=host.getProperties(key),props={enabled:!disabled,visibleControls:this.getDataLabelControlConfig()},fontStyleValueMap={};fontStyleValueMap[$ENUM_PROPERTY_NAMES.FONT_WEIGHT]=$ENUM_FONT_STYLE_VALUE.FS_BOLD;fontStyleValueMap[$ENUM_PROPERTY_NAMES.FONT_STYLE]=$ENUM_FONT_STYLE_VALUE.FS_ITALIC;fontStyleValueMap[$ENUM_PROPERTY_NAMES.UNDERLINE]=$ENUM_FONT_STYLE_VALUE.FS_UNDERLINE;fontStyleValueMap[$ENUM_PROPERTY_NAMES.LINE_THROUGH]=$ENUM_FONT_STYLE_VALUE.FS_STRIKETHROUGH;props.onGroupValueChange=function(propName,newValue){var realProp,realVal=newValue;switch(propName){case $ENUM_PROPERTY_NAMES.COLOR:realProp=$EnumDataLabel.DATA_LABEL_FONT_COLOR;realVal=newValue==="transparent"?newValue:$Clr.encodeColor(newValue);break;case $ENUM_PROPERTY_NAMES.FONT_SIZE:realProp=$EnumDataLabel.DATA_LABEL_FONT_SIZE;break;case $ENUM_PROPERTY_NAMES.FONT_FAMILY:realProp=$EnumDataLabel.DATA_LABEL_FONT_FAMILY;break;case $ENUM_PROPERTY_NAMES.FONT_WEIGHT:case $ENUM_PROPERTY_NAMES.FONT_STYLE:case $ENUM_PROPERTY_NAMES.UNDERLINE:case $ENUM_PROPERTY_NAMES.LINE_THROUGH:realProp=$EnumDataLabel.DATA_LABEL_FONT_STYLE;realVal=newValue?(properties[realProp]|fontStyleValueMap[propName]):(properties[realProp]&(~fontStyleValueMap[propName]));break;}me.onPropertiesChanged(realProp,realVal);};control=new mstrmojo.ui.editors.controls.CharacterGroup($HASH.copy(this.getDataLabelExtraControlProps(),props));control.setFormatSource(getFontFormats(properties));return control;},getFontFormats:getFontFormats,getDataLabelShowOptionControl:function getDataLabelShowOptionControl(){var control,dlItemLen,finalValIsNone=false,alwaysDisabled=false,me=this,host=this.getHost(),currentLayer=host.getGraphicLayer(),props={multiSelect:true,showIcon:false},properties=host.getEditingGridProps(),dataLabelTypeItems=[{n:mstrmojo.desc(2057,"None"),v:$EnumDataLabelShowOption.NONE}],availableItems={txt:{n:mstrmojo.desc(1013,"Text"),v:$EnumDataLabelShowOption.SHOW_TEXT},val:{n:mstrmojo.desc(2175,"Values"),v:$EnumDataLabelShowOption.SHOW_VALUE}};if(currentLayer){if(currentLayer.showDataLabelValues()){dataLabelTypeItems.unshift(availableItems.val);}if(currentLayer.showDataLabelText()){dataLabelTypeItems.unshift(availableItems.txt);}}dlItemLen=dataLabelTypeItems.length;if(dlItemLen===1){dataLabelTypeItems.splice(0,0,availableItems.txt,availableItems.val);alwaysDisabled=true;}props.items=dataLabelTypeItems;if(alwaysDisabled){props.enabled=false;}props.postselectionChange=function(evt){if(this._sync){return ;}this._sync=true;var i,finalVal,nothingSelected;if(evt.added){if(this.items[evt.added[0]].v===$EnumDataLabelShowOption.NONE){for(i=0;i<dlItemLen-1;i++){if(this.selectedIndices[i]){this.removeSelect(i);}}}else{if(this.selectedIndices[dlItemLen-1]){this.removeSelect(dlItemLen-1);}}}else{if(evt.removed){nothingSelected=true;for(i=0;i<dlItemLen;i++){if(this.selectedIndices[i]){nothingSelected=false;break;}}if(nothingSelected){this.addSelect(dlItemLen-1);}}else{mstr_profile.log("Should never happen");}}finalVal=dataLabelTypeItems.reduce(function(val,item,idx){return this.selectedIndices[idx]?(val|item.v):val;}.bind(this),0);me.onPropertiesChanged($EnumDataLabel.DATA_LABEL_SHOW,finalVal);this._sync=false;};control=new mstrmojo.ui.ButtonBar(props);var initShowOptionControl=function(value){var idxs;this._sync=true;if(value===$EnumDataLabelShowOption.NONE){this.singleSelectByField(value,"v");finalValIsNone=true;}else{idxs=(this.items||[]).map(function(item,idx){return(value&item.v)>0?idx:null;}).filter(function(elem){return elem!==null;});if(idxs.length<=0){this.singleSelectByField($EnumDataLabelShowOption.NONE,"v");finalValIsNone=true;}else{this.select(idxs);}}this._sync=false;}.bind(control);initShowOptionControl(properties[$EnumDataLabel.DATA_LABEL_SHOW]);return{control:control,disableCtrls:alwaysDisabled||finalValIsNone};},getDataLabelShowAllCheckBoxControl:function getDataLabelShowAllCheckBoxControl(disabled){var me=this,host=this.getHost(),properties=host&&host.getEditingGridProps(),propName=$EnumDataLabel.DATA_LABEL_SHOW_ALL,checkBox=new mstrmojo.ui.Checkbox({checked:!properties[propName],oncheckedChange:function oncheckedChange(evt){me.onPropertiesChanged(propName,!evt.value);}}),control=this.getLabelAndControl(mstrmojo.desc(14606,"Hide overlapping labels"),checkBox,"14px","100%",true,{enabled:!disabled}),label=control.getLabel();label.onclick=function(){checkBox.onclick();};return control;},fnGetPulldown:function fnGetPulldown(items,selectedIndex,descriptor,propName,options){var control,pulldown;if(items&&items.length){pulldown=mstrmojo.ui.Pulldown.newPulldown(items,getCallback.call(this,propName),selectedIndex,{isHostedWithin:false});if(options){control=this.getEditorGroup([getPropertyTitle.call(this,descriptor),pulldown],{showDivider:options.showDivider,isNested:options.isNested,isContainer:options.isContainer});}else{if(descriptor!=undefined){control=this.getLabelAndControl(descriptor,pulldown);}else{control=pulldown;}}}return control;},onBaseMapTypeChange:function onBaseMapTypeChange(){this.replaceChildControls(this.baseMapOptionsControls,this.getBaseMapOptionsControls());},destroy:function destroy(){delete this.baseMapOptionsControls;delete this.mapStyleControl;delete this.graphicLayersControl;delete this.graphicLayerOptionsControls;this._super();}});function getPropertyTitle(text){return new mstrmojo.Label({text:text,cssClass:"prop-title"});}function shouldAddLatLngDropZone(graphicType,zoneId){var host=this.getHost(),geoAttribute,formItems;if(graphicType===$EnumGraphicType.Marker||graphicType===$EnumGraphicType.Bubble||graphicType===$EnumGraphicType.Density){geoAttribute=host.getEditingDropZoneItems($EDZ.GeoAttribute);if(geoAttribute&&geoAttribute.length>0){formItems=host.getEditingDropZoneItems(zoneId);if(!formItems||formItems.length<=0){return true;}}}return false;}function shouldRemoveImageThreshold(graphicType){return(graphicType===$EnumGraphicType.Bubble||graphicType===$EnumGraphicType.Area);}function getGeoForm(attribute,fn){return $ARR.filterOne(attribute.fs,function(form){return fn(form.fnm,form.fgr)&&form.obf;});}function getLatitudeForm(attr){return getGeoForm(attr,$MH.isLatitude);}function getLongitudeForm(attr){return getGeoForm(attr,$MH.isLongitude);}function getCallback(propertyName){var id=this.id;return function(newValue){mstrmojo.all[id].onPropertiesChanged(propertyName,newValue.id);};}function getFontFormats(properties){var color,formats={},fontStyleVal=properties[$EnumDataLabel.DATA_LABEL_FONT_STYLE];formats[$ENUM_PROPERTY_NAMES.FONT_WEIGHT]=(fontStyleVal&$ENUM_FONT_STYLE_VALUE.FS_BOLD)>0;formats[$ENUM_PROPERTY_NAMES.FONT_STYLE]=(fontStyleVal&$ENUM_FONT_STYLE_VALUE.FS_ITALIC)>0;formats[$ENUM_PROPERTY_NAMES.UNDERLINE]=(fontStyleVal&$ENUM_FONT_STYLE_VALUE.FS_UNDERLINE)>0;formats[$ENUM_PROPERTY_NAMES.LINE_THROUGH]=(fontStyleVal&$ENUM_FONT_STYLE_VALUE.FS_STRIKETHROUGH)>0;color=properties[$EnumDataLabel.DATA_LABEL_FONT_COLOR];formats[$ENUM_PROPERTY_NAMES.COLOR]=color==="transparent"?color:$Clr.decodeColor(color);formats[$ENUM_PROPERTY_NAMES.FONT_SIZE]=properties[$EnumDataLabel.DATA_LABEL_FONT_SIZE];formats[$ENUM_PROPERTY_NAMES.FONT_FAMILY]=properties[$EnumDataLabel.DATA_LABEL_FONT_FAMILY];return formats;}}());