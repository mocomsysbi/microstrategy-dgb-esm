(function(){mstrmojo.requiresCls("mstrmojo.array","mstrmojo.hash","mstrmojo.func","mstrmojo.VisUtility","mstrmojo.chart.model.enums.EnumDSSObjectType","mstrmojo.vi.viz.EnumDSSDropZones","mstrmojo.vi.models.DropZonesModel","mstrmojo.vi.models._DropZoneCommon","mstrmojo.vi.ui.DatasetUnitMenuUtils","mstrmojo.vi.util.ThresholdUtils");var $HASH=mstrmojo.hash,$ARR=mstrmojo.array,$FUNC=mstrmojo.func,$VISUTIL=mstrmojo.VisUtility,$OBJ_TYPES=mstrmojo.chart.model.enums.EnumDSSObjectType,$EDZ=mstrmojo.vi.viz.EnumDSSDropZones,$THRESHOLD_UTILS=mstrmojo.vi.util.ThresholdUtils,$TARGET_POS=mstrmojo.vi.models.DropZonesModel.ENUM_TARGET_POSITION,$DU=mstrmojo.vi.ui.DatasetUnitMenuUtils,$FEATURES=mstrmojo.vi.enums.EnumFeatures,FROM=$EDZ.FromItem,TO=$EDZ.ToItem,EDGE_COLOR=$EDZ.ColorBy,EDGE_SIZE=$EDZ.SizeBy,ITEM_SIZE=$EDZ.ItemSize,NETWORK_THRESHOLD_COLORS=["#d2e0e8","#a4cbe6","#80add9","#558dcc","#2e78bb"];NETWORK_THRESHOLD_BANDS=[0.2,0.4,0.6,0.8];mstrmojo.vi.models.NetworkDropZones=mstrmojo.declare(mstrmojo.vi.models.DropZonesModel,[mstrmojo.vi.models._DropZoneCommon],{scriptClass:"mstrmojo.vi.models.NetworkDropZones",help:"editor_panel_network.htm",getHostModel:function getHostModel(){return this.getHost().model.data;},getDropZones:function getDropZones(){var dzf=this.getDZFlatStruct(),singleUnit=function(title){return{allowSingle:true,title:title};},zones=[this.getZone(mstrmojo.desc(11910,"From Item"),FROM,dzf.from,false,singleUnit(mstrmojo.desc(13833))),this.getZone(mstrmojo.desc(11911,"To Item"),TO,dzf.to,false,singleUnit(mstrmojo.desc(13833))),this.getZone(mstrmojo.desc(11912,"Edge Color"),EDGE_COLOR,dzf.ColorBy,false,singleUnit(mstrmojo.desc(13829))),this.getZone(mstrmojo.desc(11913,"Edge Size"),EDGE_SIZE,dzf.SizeBy,false,singleUnit(mstrmojo.desc(13829))),this.getZone(mstrmojo.desc(4781,"Item Size"),ITEM_SIZE,dzf.itemsz,false,singleUnit(mstrmojo.desc(13829)))];this.dropZones=zones;return{n:this.getHost().defn.ttl,zones:zones};},getUnitMenuItems:function getUnitMenuItems(cfg,zone,item,el){var me=this,dzid=this.id,isMetric=this.isMetric(item),isAttr=this.isAttribute(item),items=zone.items,cnt=items.length,itemContext={zone:zone,idx:$ARR.find(items,"id",item.id),cnt:cnt,item:item,useDropzone:true},isInVFConfigMode=mstrApp.isInVFConfigMode,dModel=this.docModel,did=item.did,createDADMPriv=mstrmojo.resolveFeature($FEATURES.INSERT_NEW_METRIC),isElemGroup=(item.t===47&&item.st===12033),dataset=$DU.getDatasetFromAttributeId(dModel.datasets,did);if(isElemGroup&&!isInVFConfigMode){cfg.addMenuItem(mstrmojo.desc(13296,"Edit Groups..."),"eg",this.getCreateOrEditElementGroupFunc(itemContext));}if(isMetric&&!isInVFConfigMode){if(item.um){cfg.addMenuItem(mstrmojo.desc(3224,"Edit..."),"",function(){me.editDerivedMetric(itemContext,"edit");},itemContext);cfg.addSeparator();}if(createDADMPriv){if(dModel.findDatasetIdFromUnit(did)&&!dModel.isFromSolrCube(did)&&!dModel.isFromMDXCube(did)){cfg.addSubMenuItem(mstrmojo.desc(11806,"Aggregate By"),"",dzid,me.getAggregateByMetricSubMenu,itemContext);cfg.addSeparator();}cfg.addEditorMenuItem(mstrmojo.desc(5188,"Calculation"),dzid,me.getCalculationEditorCfg,itemContext);cfg.addMenuItem(mstrmojo.desc(13624,"Create Metric..."),"",function(){me.newDerivedMetric(itemContext);},itemContext);}}else{if(isAttr&&!isInVFConfigMode){if(!dataset||!dModel.isMDXDataset(dataset)){if(item.da){cfg.addMenuItem(mstrmojo.desc(3224,"Edit..."),"",function(){me.editDerivedAttribute(itemContext);},itemContext);cfg.addSeparator();}if(!$VISUTIL.isCGorCon(this.getHost(),item)&&!this.isDynamicLink(item)&&createDADMPriv){cfg.addMenuItem(mstrmojo.desc(13625,"Create Attribute..."),"",function(){me.newDerivedAttribute(itemContext,!me.allowInsertNewAttribute(zone));},itemContext);}}if(!$DU.hasOldDEOverDatasets(did,this.docModel.datasets)&&!this.isRecursiveAttribute(item)){cfg.addMenuItem(mstrmojo.desc(13295,"Create Groups..."),"eg",this.getCreateOrEditElementGroupFunc(itemContext));}}}cfg.addSeparator();if(this.showNumberFormat(item)){cfg.addEditorMenuItem(mstrmojo.desc(13237,"Number Format"),dzid,this.getNumberFormatEditorCfg,itemContext);}if(isMetric){if(zone.id===EDGE_COLOR){this.buildThresholdMenuOptions(cfg,itemContext,true);}}if(this.shouldShowDisplayFormsMenu(item)){cfg.addEditorMenuItem(mstrmojo.desc(11908,"Display Attribute Forms"),this.id,function(){return me.getDisplayFormsMenu(item);});}cfg.addSeparator();if(me.hasReplaceCandidates(itemContext)&&(!(mstrApp.isAppStatePresentation&&mstrApp.isAppStatePresentation())||!!mstrmojo.resolveFeature($FEATURES.WEB_DRILL_AND_LINK))){cfg.addSubMenuItem(mstrmojo.desc(14003,"Replace With"),"",dzid,me.getReplaceSubMenu,itemContext);}cfg.addMenuItem(mstrmojo.desc(1388,"Rename"),"",function(){me.renameItem(el,item);});cfg.addMenuItem(mstrmojo.desc(190,"Remove"),"xt",function(){me.deleteItem(zone,me.getUnitIndexInZone(zone,item));});},getAvatarIconClass:function getAvatarIconClass(){return"viNetwork";},getAllowDropInfo:function getAllowDropInfo(zone,dragItems,idx,edge,context){var me=this,baseInfo=this._super(zone,dragItems,idx,edge,context),invalidPos=zone.items.length!==0&&edge!==$TARGET_POS.ON,wantMetric=[EDGE_COLOR,EDGE_SIZE,ITEM_SIZE].indexOf(zone.id)!==-1,allowItem=invalidPos?null:$ARR.filterOne(baseInfo.allowedItems,function(item){var isMetric=me.isMetric(item);return wantMetric?isMetric:(!isMetric&&item.t!==$OBJ_TYPES.DssTypeDimension);});return $HASH.copy({allowedItems:allowItem?[allowItem]:[]},baseInfo);},getAddItemActions:function(zone,items,idx,datasetId){var templateActions=this.getAddDropZoneUnitsActions(zone,items,idx,{datasetId:datasetId});this.checkAndAddThresholdAction(zone.id,items[0],templateActions);return templateActions;},checkAndAddThresholdAction:function checkAndAddThresholdAction(zoneID,item,actions){var host=this.getHost();if(this.isMetric(item)&&zoneID===EDGE_COLOR){$THRESHOLD_UTILS.addThresholds(host.model,host,host.node,item,actions,NETWORK_THRESHOLD_COLORS,NETWORK_THRESHOLD_BANDS,false);return true;}return false;},unitsDropped:function unitsDropped(zone,context,dropInfo,isPrimary,splitMetric){var actions=context.actions||[],templateActions=[],submittedActions,dragData=context.src.data,idx=dropInfo.idx,edge=dropInfo.edge,allowedItems=dropInfo.allowedItems,callbacksGenerator,me=this;if(edge===$TARGET_POS.ON&&dropInfo.removeReplaced){templateActions=templateActions.concat(this.getRemoveDropZoneUnitActions(zone,zone.items[idx]));}templateActions=templateActions.concat(this.getAddItemActions(zone,allowedItems,this.getDropTargetIndex(zone,dropInfo),dragData.dsid));submittedActions=actions.concat(me.getUpdateTemplateAction(templateActions));callbacksGenerator=function(hookVFUnset){return function(){var _submittedActions=hookVFUnset?me.docModel.wrapUnsetVisualizationFilterAction(submittedActions):submittedActions;me.submitDropZoneUpdates(_submittedActions,$FUNC.wrapMethods(context.callback,me.getHost().model.docModel.controller._getXtabCallback(me.getHost())));};};this.checkAndWarnLargeItemsForAddUnits(allowedItems,function(){me.docModel.checkAndNotifyVFChangeOnDZUnitsUpdate({actions:submittedActions,zm:me},callbacksGenerator(true),callbacksGenerator(false));});},deleteItem:function deleteItem(zone,idx){var me=this,model=me.docModel,actions=this.getRemoveDropZoneUnitActions(zone,zone.items[idx]);model&&model.checkAndNotifyVFChangeOnDZUnitsUpdate({ca:[zone.id],zm:me},function(){me.submitDropZoneTemplateUpdates(actions,{actions:model.wrapUnsetVisualizationFilterAction()});},function(){me.submitDropZoneTemplateUpdates(actions);});}});}());