(function(){mstrmojo.requiresCls("mstrmojo.Container","mstrmojo.qb.DBTableRows","mstrmojo._IsMovable","mstrmojo.array","mstrmojo.dom","mstrmojo.hash","mstrmojo.css","mstrmojo.string","mstrmojo.DI.DIHelpers","mstrmojo.DI.DIMappingTableRows","mstrmojo.DI.DIMappingMenu");mstrmojo.requiresDescs(962,3581);var $DOM=mstrmojo.dom,$H=mstrmojo.hash,$HELPER=mstrmojo.DI.DIHelpers,$A=mstrmojo.array,$CSS=mstrmojo.css,$S=mstrmojo.string,$WIDGET=mstrmojo.Widget,$MAX=Math.max,$MIN=Math.min,$PX="px",ATTRIBUTE_TYPE=12,METRIC_TYPE=4,constants=mstrmojo.DI.DIConstants,CSS_CLASS_DRAGGING="dragging",MIN_HEIGHT=264,MIN_LIST_HEIGHT=98,MIN_WIDTH=175,MAX_WIDTH=350,$MAPPINGTABLE;function initItemTooltip(items){var _this=this;$A.forEach(items,function(item){if(_this.isHierarchyRelation&&!item.recursive){item.ttp=mstrmojo.desc(null,"This attribute or metric will not be imported after 'Finish' or 'Save', you can find it in 'Show All Columns'");}else{item.ttp=item.alias;}if(item.subColumns){initItemTooltip(item.subColumns);}});}function sortElementsByType(items,type){var tempArray=[];$A.forEach(items,function(itm){if(itm.tp===type){tempArray.push(itm);}});return tempArray;}function nameSorter(a,b){var A=a.alias,B=b.alias;if(A<B){return -1;}if(A>B){return 1;}return 0;}function updatePosition(){if(this.domNode){var domNodeStyle=this.domNode.style,tableData=this.tableData;domNodeStyle.left=this.left||tableData.x;domNodeStyle.top=this.top||tableData.y;}}function updateTableDimensions(height,width){var curHeight,MAX_HEIGHT,pos,h,w;MAX_HEIGHT=this.parent.domNode.clientHeight-40;if(height===undefined||width===undefined){pos=$DOM.position(this.domNode);curHeight=pos.h;h=$MIN($MAX(curHeight,MIN_HEIGHT),MAX_HEIGHT);w=width===undefined?MIN_WIDTH:width;}else{h=$MAX(height,MIN_HEIGHT);w=$MAX(width,MIN_WIDTH);}this.set("height",h+$PX);this.set("width",w+$PX);}function updateTablePosition(left,top){this.domNode.style.top=Math.max(top,0)+"px";this.domNode.style.left=Math.max(left,0)+"px";}function isResizeHandleDrag(node){return $CSS.hasClass(node,"mstrmojo-qb-tv-rs");}function getResizeDir(context){return $A.filterOne(["e","w","n","s","es"],function(dir){return $CSS.hasClass(context.src.node,dir);});}mstrmojo.DI.DIMappingTable=mstrmojo.declare(mstrmojo.Container,[mstrmojo._IsMovable,mstrmojo._HasPopup,mstrmojo.ui.menus._HasMenuPopup,mstrmojo.warehouse._CanToggleAvatarClass],{scriptClass:"mstrmojo.DI.DIMappingTable",markupString:'<div id="{@id}" class="mstrmojo-di-TableView {@cssClass} {@group}" mstrAttach:contextmenu,click><div class="mstrmojo-di-tv-header item" ><span class="mstrmojo-di-tv-ttl" mstrAttach:dblclick>{@title}</span><span class="di-item-mn" mstrAttach:click></span></div><div class="mstrmojo-qb-tv-rs n"></div><div class="mstrmojo-qb-tv-rs s"></div><div class="mstrmojo-qb-tv-rs w"></div><div class="mstrmojo-qb-tv-rs e"></div><div class="mstrmojo-qb-tv-rs es"></div></div>',markupSlots:{headerNode:function headerNode(){return this.domNode.firstChild;},titleNode:function titleNode(){return this.domNode.firstChild.firstChild;},containerNode:function containerNode(){return this.domNode;},menuNode:function menuNode(){return this.domNode.firstChild.lastChild;}},markupMethods:{onvisibleChange:$WIDGET.visibleMarkupMethod,onheightChange:$WIDGET.heightMarkupMethod,onwidthChange:$WIDGET.widthMarkupMethod},onheightChange:function(evt){var attrRows=this.attrRows,metricRows=this.metricRows,h=parseInt(this.height,10),_ttlHeight=this._ttlHeight,attrRowHeight,metricRowHeight,ah,mh,allH;if(this._super){this._super(evt);}attrRowHeight=(attrRows.containerNode||attrRows.domNode).clientHeight;metricRowHeight=(metricRows.containerNode||metricRows.domNode).clientHeight;allH=h-_ttlHeight*3-2;ah=Math.floor(allH/2);mh=ah;if(ah>attrRowHeight){ah=Math.max(attrRowHeight,MIN_LIST_HEIGHT);mh=allH-ah;}else{if(mh>metricRowHeight){mh=Math.max(metricRowHeight,MIN_LIST_HEIGHT);ah=allH-mh;}}if(ah>=0){attrRows.set("height",ah+$PX);}if(mh>=0){metricRows.set("height",mh+$PX);}},initSelectNode:null,draggable:true,dropZone:true,ownAvatar:true,tableMapping:null,model:null,isExpanded:false,group:"",init:function(prop){if(this._super){this._super(prop);}var id=this.id,MENU_SELECT_EVENT="tableViewMenuSelect",CLEAR_SELECTION_EVENT="tableSelectionClear";$A.forEach([this.attrRows,this.metricRows],function handler(widget){widget.attachEventListener(MENU_SELECT_EVENT,id,function tableMenuEventHandler(evt){$MAPPINGTABLE.showPopupMenu(this,evt);});widget.attachEventListener(CLEAR_SELECTION_EVENT,id,function tableSelectionClearHandler(evt){this.clearRowSelections(evt);});},this);this.attrRows.convertEnabled=this.metricRows.convertEnabled=this.convertEnabled;this.attrRows.attachEventListener("selectLinkedItems",id,function showLinks(evt){this.parent.selectLinkedAttribute(evt);});this.metricRows.attachEventListener("selectLinkedItems",id,function showLinks(evt){this.parent.selectLinkedAttribute(evt);});},preBuildRendering:function preBuildRendering(){this._super();var tableData=this.tableData,items=tableData.items,attrRows=this.attrRows,metricRows=this.metricRows;initItemTooltip.call(this,items);this.title=$S.escape4HTMLText(tableData.n);attrRows.items=Array.prototype.sort.call(sortElementsByType(items,ATTRIBUTE_TYPE),nameSorter);attrRows.tableData=tableData;attrRows.tp=ATTRIBUTE_TYPE;metricRows.items=Array.prototype.sort.call(sortElementsByType(items,METRIC_TYPE),nameSorter);metricRows.tableData=tableData;metricRows.tp=METRIC_TYPE;},onselectedChange:function(){if(!this.domNode){return ;}if(this.selected){this.domNode.style.zIndex=mstrApp.getRootController().getDialogController().getCurrentZIndex()+2;}else{this.domNode.style.zIndex=mstrApp.getRootController().getDialogController().getCurrentZIndex()+1;}},postBuildRendering:function postBuildRendering(){this._super();updatePosition.call(this);this._ttlHeight=this.headerNode.clientHeight;updateTableDimensions.call(this,this.height,this.width);if(this.attrRows.domNode&&this.tableData.attrRowsScroll!==undefined){this.attrRows.domNode.scrollTop=this.tableData.attrRowsScroll;}if(this.metricRows.domNode&&this.tableData.metricRowsScroll!==undefined){this.metricRows.domNode.scrollTop=this.tableData.metricRowsScroll;}if(this.selected){this.domNode.style.zIndex=mstrApp.getRootController().getDialogController().getCurrentZIndex()+2;}else{this.domNode.style.zIndex=mstrApp.getRootController().getDialogController().getCurrentZIndex()+1;}this.set("richTooltip",{cssClass:"vi-regular vi-tooltip-V",refNode:this.domNode,posType:mstrmojo.tooltip.POS_BOTTOMLEFT,content:this.title});if(!this._ontooltipover){var id=this.id;this._ontooltipover=function(e){var me=mstrmojo.all[id];var node=me.titleNode;var nodePos=mstrmojo.dom.position(node);if(nodePos.w<node.scrollWidth){me.showTooltip(e,self);}};this._ontooltipout=function(e){var me=mstrmojo.all[id];me.hideTooltip(e,self);};}$DOM.attachEvent(this.domNode,"mouseover",this._ontooltipover);$DOM.attachEvent(this.domNode,"mouseout",this._ontooltipout);$DOM.attachEvent(this.domNode,"mousedown",this._ontooltipout);if(this.shouldExpand){this.expandAttrForms();}},expandAttrForms:function expandAttrForms(){var attrRows=this.attrRows,items=attrRows.items,changed=false;if(this.isExpanded){attrRows.expandedIndices={};changed=true;this.isExpanded=false;}else{$A.forEach(items,function(item,idx){if(item.subColumns&&!item.items){item.items=item.subColumns;attrRows.expandedIndices[idx]=true;changed=true;}else{if(item.items&&!this.isExpanded){attrRows.expandedIndices[idx]=true;changed=true;}}});this.isExpanded=true;}if(changed){this.attrRows.render();mstrmojo.css.toggleClass(this.attrRows.domNode,"expand",this.isExpanded);}},getTableID:function getTableID(){return this.tableData.id;},getMovingHandle:function getMovingHandle(){return(this.isEditing?null:this.headerNode);},toggleAvatarClass:function toggleAvatarClass(cls,isAdd){$CSS.toggleClass(this.avatar,cls,isAdd);},isDragValid:function isDragValid(context){return isResizeHandleDrag.call(this,context.src.node)||this._super(context)||false;},ondragstart:function ondragstart(context){this.dragging=true;this._super(context);if(!this.selected){this.domNode.style.zIndex=mstrApp.getRootController().getDialogController().getCurrentZIndex()+3;}$CSS.toggleClass(this.domNode,[CSS_CLASS_DRAGGING],true);if(isResizeHandleDrag.call(this,context.src.node)){this._rszCfg={h:parseInt(this.height,10),w:parseInt(this.width,10),x:Math.max(parseInt(this.domNode.style.left,10),0),y:Math.max(parseInt(this.domNode.style.top,10),0),dir:getResizeDir(context)};}this.parent.parent.linker.clearLinks();},ondragmove:function ondragmove(context){var sourcePos=context.src.pos,targetPos=context.tgt.pos;if(this._rszCfg){var resizeConfig=this._rszCfg,dir=resizeConfig.dir,deltaX=targetPos.x-sourcePos.x,deltaY=targetPos.y-sourcePos.y,x=0,y=0,h=0,w=0;switch(dir){case"w":x=deltaX;w=(resizeConfig.x+x<0)?resizeConfig.x:-deltaX;if(resizeConfig.w+w<MIN_WIDTH||resizeConfig.w+w>MAX_WIDTH){return ;}break;case"e":w=deltaX;break;case"n":y=deltaY;h=(resizeConfig.y+y<0)?resizeConfig.y:-deltaY;var MAX_HEIGHT=this.parent.domNode.clientHeight-40;if(resizeConfig.h+h<MIN_HEIGHT||resizeConfig.h+h>MAX_HEIGHT){return ;}break;case"s":h=deltaY;break;case"es":h=deltaY;w=deltaX;}updateTablePosition.call(this,resizeConfig.x+x,resizeConfig.y+y);updateTableDimensions.call(this,resizeConfig.h+h,resizeConfig.w+w);}else{var target=this.getMovingTarget();var targetStyle=target.style;if(parseInt(targetStyle.left,10)<0){targetStyle.left=this.left="0px";}else{targetStyle.left=this.left=Math.max(this._leftPos+targetPos.x-sourcePos.x,-this._hWidth+40)+"px";}targetStyle.top=this.top=Math.max(this._topPos+targetPos.y-sourcePos.y,-this._hHeight+20)+"px";var srcWidget=context.src.widget.attrRows;var selectedData=srcWidget.getUserSelectedData();if(selectedData.length===1&&selectedData[0].isLinked){this.attrRows.raiseEvent({name:"drawLinks",source:this,oid:selectedData[0].oid});}}},ondragend:function ondragend(context){var pos,source;this._super(context);var domNode=this.domNode,zIndex=domNode.style.zIndex,controller=mstrApp.getRootController().getDialogController();$CSS.toggleClass(domNode,[CSS_CLASS_DRAGGING],false);if(parseInt(zIndex,10)<(controller.getCurrentZIndex()-1)){domNode.style.zIndex=controller.getNextZIndex();}if(this.selected){domNode.style.zIndex=controller.getCurrentZIndex()+2;}else{domNode.style.zIndex=controller.getCurrentZIndex()+1;}delete this._rszCfg;source=mstrApp.getRootController().getModel().getImportSource(this.getTableID());pos={x:Math.max(parseInt(domNode.style.left,10),0),y:Math.max(parseInt(domNode.style.top,10),0),w:domNode.clientWidth,h:domNode.clientHeight};if(!source){return ;}source.updateTablePosition(pos);},selectItemById:function selectItemById(id){return this.attrRows.selectItem("id",id);},selectItemByName:function selectItemByName(alias){return this.metricRows.selectItem("alias",alias);},onclick:function onclick(evt){var targetNode=evt.getTarget();mstrmojo.dom.stopPropogation(evt.hWin,evt.e);if(targetNode===this.menuNode){$MAPPINGTABLE.showPopupMenu(this,{position:$DOM.position(this.menuNode,true),data:[this.tableData],menuType:constants.contextMenuType.TABLE_MENU});}else{if(targetNode===this.titleNode&&this.dragging){this.dragging=false;return ;}else{if(mstrApp.getRootController().selectSourceTable){var model=mstrApp.getRootController().getModel();if(!model.currentSource||model.currentSource.tableID!==this.tableData.id){mstrApp.getRootController().selectSourceTable(this.tableData.id);}}}}},clearRowSelections:function clearRowSelections(sourceInfo){var source=sourceInfo&&sourceInfo.source&&sourceInfo.source.id;$A.forEach([this.attrRows,this.metricRows],function delegateHandler(widget){if(widget.id!==source){widget.clearSelections($H.copy(widget.userSelections));}});},oncontextmenu:function oncontextmenu(evt){$DOM.preventDefault(window,evt.e);var target=evt.target||$DOM.eventTarget(evt.hWin,evt.e);var position;if(target.nodeName==="SPAN"){if(target.className.indexOf("di-item-n")===-1&&target.nextSibling&&target.nextSibling.className.indexOf("di-item-n")!==-1){target=target.nextSibling;}if(target.className.indexOf("di-item-n")===-1){return false;}}else{if(target.childNodes[1]&&target.childNodes[1].className.indexOf("di-item-n")!==-1){target=target.childNodes[1];}else{if(target.className==="linked"){target=target.parentNode.childNodes[1];}else{return false;}}}position=$DOM.getMousePosition(evt.e,evt.hWin);$A.forEach([this.attrRows,this.metricRows],function delegateHandler(widget){if($H.keyarray(widget.userSelections).length){var data=widget.getUserSelectedData();$MAPPINGTABLE.showPopupMenu(this,{menuNode:target,data:widget.getUserSelectedData(),menuType:constants.contextMenuType.ITEM_MENU,position:position});}},this);return false;},ondblclick:function ondblclick(evt){var target=evt.getTarget();if(target.nodeName!=="SPAN"){target=target.childNodes[1];}var src={data:[this.tableData],target:evt.src,position:$DOM.position(target,true)};mstrApp.getRootController().openRenameTextBox(constants.contextMenuType.TABLE_MENU,target,src);},ontableDataChange:function ontableDataChange(){this.refresh();},clearSelectionRowsOrSelectTable:function(){var model=mstrApp.getRootController().getModel();if(!model.currentSource||model.currentSource.tableID!==this.tableData.id){mstrApp.getRootController().selectSourceTable(this.tableData.id);}else{this.clearRowSelections();}},children:[{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(3581,"Attributes"),cssClass:"mstrmojo-di-subTitle",onclick:function onclick(){this.parent.clearSelectionRowsOrSelectTable();}},{scriptClass:"mstrmojo.DI.DIMappingTableRows",alias:"attrRows",allowEdit:true,cssClass:"attrRows",onscroll:function(){var tableContainer=this.parent.parent,linker=tableContainer.parent.linker,selectedTables=mstrmojo.array.filter(tableContainer.children,function(table){return table.selected;}),selectedItems,selectedLinkedItems;if(selectedTables.length>0){selectedItems=selectedTables[0].attrRows.getUserSelectedData();selectedLinkedItems=mstrmojo.array.filter(selectedItems,function(item){return item.isLinked;});linker.clearLinks();mstrmojo.array.forEach(selectedLinkedItems,function(item){this.selectLinkedAttribute({source:selectedTables[0].attrRows,oid:item.oid,alias:item.alias});},tableContainer);}}},{scriptClass:"mstrmojo.Label",text:mstrmojo.desc(962,"Metrics"),cssClass:"mstrmojo-di-subTitle",onclick:function onclick(){this.parent.clearSelectionRowsOrSelectTable();}},{scriptClass:"mstrmojo.DI.DIMappingTableRows",alias:"metricRows",allowEdit:true,cssClass:"metricRows"}]});$MAPPINGTABLE=mstrmojo.DI.DIMappingTable;$MAPPINGTABLE.showPopupMenu=function showPopMenu(tableView,itemInfo){tableView.menuHelper=mstrApp.getRootController().getMappingMenu(tableView.tableData.id);tableView.menuHelper.target=tableView;tableView.menuHelper.data=itemInfo.data;tableView.menuHelper.type=itemInfo.menuType;tableView.menuHelper.position=itemInfo.position;tableView.menuHelper.menuNode=itemInfo.menuNode;var cfg=tableView.menuHelper.getMenuConfig();cfg.hostId=tableView.id;cfg.hostElement=itemInfo.menuNode;cfg.isHostedWithin=false;cfg.position=itemInfo.position;cfg.popupHandlers[tableView.id]={close:function(){this.menuHelper.destroy();}};if(cfg.menus&&cfg.menus.length>0){tableView.openPopup(new mstrmojo.ui.menus.Menu({popupConfig:cfg,themeClassName:$HELPER.getEnvObj().isServerBasedWS()?"mojo-theme-light":undefined}));}};}());