(function(){mstrmojo.requiresCls("mstrmojo.hash","mstrmojo.func","mstrmojo.array","mstrmojo.css");var $HASH=mstrmojo.hash,$ARR=mstrmojo.array,$FUNC=mstrmojo.func,$CSS=mstrmojo.css;var SELECTED_ITEMS="selected",ALL_ITEMS="all",ELEM_ALL_ID="u;",ELEM_LEVEL_ALL_ID="levelAll",ELEM_LEVEL_ALL_INDEX=-100;var SORTBY_UNSORTED=0,SORTBY_ALPHABET=1,SORTBY_HIERARCHY=2;var selectorProps=["docSelector","multiSelect","allIdx","noneIdx","include"];function isLevelNumber(level){return parseInt(level,10)>=0;}function createItemTree(items){var rootItems=[];items.forEach(function(item){delete item.children;});items.forEach(function(item,idx,items){var pItem=items.p_index;if(pItem){if(pItem.children){pItem.children.push(item);}else{pItem.children=[item];}}else{rootItems.push(item);}});return rootItems;}function getItemsByAlphabet(items){var sortedItems=items.slice(0);sortedItems.sort(function(a,b){if(a.n<=b.n||a.v===ELEM_ALL_ID){return -1;}return 1;});return sortedItems;}function getItemsByHierarchy(items){var sortedItems=[],rootItems=createItemTree(items);rootItems.forEach(function treeTraversal(rootItem){sortedItems.push(rootItem);(rootItem.children||[]).forEach(function(ch){treeTraversal(ch);});});return sortedItems;}function getSortedItems(sortBy){var sortedItemsCache=this.sortedItemsCache;if(sortedItemsCache){if(sortedItemsCache[sortBy]){return sortedItemsCache[sortBy];}}else{sortedItemsCache=this.sortedItemsCache={};}switch(sortBy){case SORTBY_ALPHABET:return sortedItemsCache[sortBy]=getItemsByAlphabet(this.items);case SORTBY_HIERARCHY:return sortedItemsCache[sortBy]=getItemsByHierarchy(this.items);default:return sortedItemsCache[sortBy]=this.items;}}function itemsChange(){var items=this.items,sortedItemsCache=this.sortedItemsCache,cacheItems=sortedItemsCache&&this.sortedItemsCache[SORTBY_UNSORTED];return !items||!cacheItems||items.length!==cacheItems.length||items.some(function(item,idx){return item!==cacheItems[idx];});}function initItemsAndIndices(){var docSelector=this.docSelector,itemsRelation=docSelector.node.data.p_relation||[],items=this.items,resetSelection=!docSelector.lockSelection,levels=[];if(itemsChange.call(this)){items.forEach(function(item,idx){item.p_index=itemsRelation[idx]&&itemsRelation[idx].p_index;if(item.v!==ELEM_ALL_ID){levels[item.lv]=true;}});this.set("levels",levels);this.sortedItemsCache={};this.sortedItemsCache[SORTBY_UNSORTED]=items;if(resetSelection){this.set("applyEnabled",false);}updateChecklist.call(this,resetSelection);}}function getMappedIndices(indices,itemsFrom,itemsTo){var selectedItemsMap={},mappedIndices={};itemsFrom.forEach(function(item,idx){if(indices[idx]){selectedItemsMap[item.v]=true;}});itemsTo.forEach(function(item,idx){if(selectedItemsMap[item.v]){mappedIndices[idx]=true;}});return mappedIndices;}function getIndicesFromChecklist(indices){var checklist=this.getCheckList();return getMappedIndices(indices||checklist.selectedIndices,checklist.items,this.items);}function getChecklistIndices(indices){var checklist=this.getCheckList();return getMappedIndices(indices||this.selectedIndices,this.items,checklist.items);}function updateChecklist(isReset){var checklist=this.getCheckList(),checklistItems=checklist.items,checklistIndices=$HASH.copy(checklist.selectedIndices)||{},sortedItems=getSortedItems.call(this,isLevelNumber(this.level)?SORTBY_ALPHABET:SORTBY_HIERARCHY);if(sortedItems.length>0){checklist.set("items",sortedItems);checklist.set("selectedIndices",isReset?getChecklistIndices.call(this):getMappedIndices(checklistIndices,checklistItems,sortedItems));}}function clearSearchBox(){var searchInput=this.searchInput;if(searchInput&&searchInput.hasRendered){searchInput.clearSearch(true);}}function updateSearchBoxVisibility(){var searchInput=this.searchInput,items=this.renderableItems||[];if(searchInput&&searchInput.isClear()){searchInput.set("visible",items.length>15);}}function isShowLevelAll(){var searchInput=this.searchInput,isSearchClear=!searchInput||searchInput.isClear();return isLevelNumber(this.level)&&this.allIdx>=0&&isSearchClear;}function updateLevelAll(){if(isShowLevelAll.call(this)){var selectedIndices=this.selectedIndices,level=this.level,isLevelSelected=selectedIndices[this.allIdx]||!(this.items||[]).some(function(item,idx){return item.lv===level&&!selectedIndices[idx];});this.isLevelSelected=isLevelSelected;$CSS.toggleClass(this._getItemNode(ELEM_LEVEL_ALL_INDEX),"selected",isLevelSelected);}}function updateItems(){this.filterItems();updateSearchBoxVisibility.call(this);}mstrmojo.vi.ui.rw.selectors._IsLevelList=mstrmojo.provide("mstrmojo.vi.ui.rw.selectors._IsLevelList",{scriptClass:"mstrmojo.vi.ui.rw.selectors._IsLevelList",level:ALL_ITEMS,levels:[],applyEnabled:false,getCheckList:mstrmojo.emptyFn,postCreateChildren:function(){var me=this,checklist=this.getCheckList();$FUNC.override({getItemMarkup:function getItemMarkUp(item,idx){return this._super(item,idx).replace('<span class="icon"></span>','<span class="iconRA-checkbox"></span>');},filterItems:function filterItems(){this._super();updateLevelAll.call(this);},updateRenderableItems:function updateRenderableItems(){this._super();if(isShowLevelAll.call(this)&&this.renderIndex===0){this.renderableItems.unshift({n:"("+mstrmojo.desc(2461,"All")+")",v:ELEM_LEVEL_ALL_ID,_renderIdx:ELEM_LEVEL_ALL_INDEX,cls:"noOnly"});}},getFilteredItem:function getFilteredItem(idx){var item=this._super(idx),level=this.level;if(item){if(level!==ALL_ITEMS&&item.v===ELEM_ALL_ID){return null;}if(level===SELECTED_ITEMS&&!this.selectedIndices[idx]){return null;}if(isLevelNumber(level)&&level!==item.lv){return null;}return item;}return null;},postBuildRendering:function postBuildRendering(){this._super();updateSearchBoxVisibility.call(this);},onchange:function onchange(evt){this._super(evt);if(this.hasRendered){if(this.level===SELECTED_ITEMS){updateItems.call(this);}else{updateLevelAll.call(this);}}},onclick:function onclick(evt){var target=evt.getTarget(),node=this.getItemNodeFromTarget(target),idx=node&&parseInt(node.getAttribute("idx"),10),item=this.getItemFromTarget(target);if(item){this._super(evt);me.set("applyEnabled",true);}else{if(idx===ELEM_LEVEL_ALL_INDEX){var level=this.level,selectedIndices=$HASH.copy(this.selectedIndices),isLevelSelected=this.isLevelSelected=!this.isLevelSelected;this.items.forEach(function(item,idx){if(item.lv===level){if(isLevelSelected){selectedIndices[idx]=true;}else{delete selectedIndices[idx];}}});delete selectedIndices[this.allIdx];this.set("selectedIndices",selectedIndices);me.set("applyEnabled",true);}}},shouldShowTooltip:function shouldShowTooltip(evt,win){var target=evt.target||$DOM.eventTarget(evt.hWin,evt.e);if(target.classList.contains("text")){var itemNode=target.parentNode,iconNode=itemNode.getElementsByClassName("iconRA-checkbox")[0],onlyNode=itemNode.getElementsByClassName("only")[0];return target.offsetWidth+(onlyNode?onlyNode.offsetWidth:0)+iconNode.offsetWidth>itemNode.offsetWidth;}return this._super(evt,win);},updateTooltipConfig:function updateTooltipConfig(evt){var $DOM=mstrmojo.dom,$TOOLTIP=mstrmojo.tooltip;var target=evt.target||$DOM.eventTarget(evt.hWin,evt.e),position=$DOM.position(target.parentNode),leftPadding=6;arrowType="vi-tooltip-C",posType=$TOOLTIP.POS_TOPLEFT;var leftOffset=position.w+leftPadding,windowWidth=$DOM.windowDim().w;if(windowWidth<(position.x+leftOffset+300)){arrowType="vi-tooltip-D";leftOffset=-25;posType=$TOOLTIP.POS_TOPRIGHT;}this.richTooltip={content:this.getTooltipContent(evt),top:-10,cssClass:"vi-regular "+arrowType,left:leftOffset,refNode:target,posType:posType};}},checklist);checklist.markupMethods=$HASH.copy({onlevelChange:function(){var method=this.level===SELECTED_ITEMS?"add":"remove";$CSS[method+"Class"](this.domNode,"showSelected");clearSearchBox.call(this);updateItems.call(this);}},$HASH.copy(mstrmojo.ui.CheckList.prototype.markupMethods));},onlevelChange:function onlevelChange(evt){updateChecklist.call(this);},preBuildRendering:function preBuildRendering(){$HASH.copyProps(selectorProps,this,this.getCheckList());initItemsAndIndices.call(this);this._super();},select:function select(indices){var selectedIndices=$ARR.hash(indices);this.getCheckList().select($HASH.keyarray(getChecklistIndices.call(this,selectedIndices),true));this.selectedIndices=getIndicesFromChecklist.call(this);this.set("applyEnabled",false);},getLevels:function getLevels(levels){var levelNames=this.getlevelNames(),levelItems=[{n:mstrmojo.desc(14672,"Selected Items"),v:SELECTED_ITEMS},{n:mstrmojo.desc(2461,"All"),v:ALL_ITEMS}];$ARR.forEach(levels,function(hasLevel,level){if(hasLevel){var levelName=levelNames[level]||mstrmojo.desc(493,"Level")+" "+(level+1);levelItems.push({n:levelName,v:level});}});return levelItems;},handleSelectionSubmit:function handleSelectionSubmit(isApply){var checklist=this.getCheckList();if(isApply){this.selectedIndices=getIndicesFromChecklist.call(this);this.onchange();}else{checklist.set("selectedIndices",getChecklistIndices.call(this));}this.set("applyEnabled",false);}});}());